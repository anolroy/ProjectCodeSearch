VERSION 5.00
Object = "{00025600-0000-0000-C000-000000000046}#5.2#0"; "crystl32.ocx"
Object = "{0D452EE1-E08F-101A-852E-02608C4D0BB4}#2.0#0"; "FM20.DLL"
Object = "{0ECD9B60-23AA-11D0-B351-00A0C9055D8E}#6.0#0"; "MSHFLXGD.OCX"
Object = "{BDC217C8-ED16-11CD-956C-0000C04E4C0A}#1.1#0"; "TABCTL32.OCX"
Object = "{BB5807FE-DBD2-11D3-87C1-4C980CC10374}#1.0#0"; "MyHover.ocx"
Begin VB.Form frmDemands3 
   BackColor       =   &H00E0E0E0&
   BorderStyle     =   1  'Fixed Single
   Caption         =   "Demand & Receipt"
   ClientHeight    =   12870
   ClientLeft      =   45
   ClientTop       =   435
   ClientWidth     =   21570
   BeginProperty Font 
      Name            =   "Myriad Web"
      Size            =   8.25
      Charset         =   0
      Weight          =   400
      Underline       =   0   'False
      Italic          =   0   'False
      Strikethrough   =   0   'False
   EndProperty
   Icon            =   "frmDemand.frx":0000
   LinkTopic       =   "Form1"
   MaxButton       =   0   'False
   MDIChild        =   -1  'True
   MinButton       =   0   'False
   NegotiateMenus  =   0   'False
   ScaleHeight     =   12870
   ScaleWidth      =   21570
   Begin VB.PictureBox picRecieptType 
      Appearance      =   0  'Flat
      BackColor       =   &H80000005&
      ForeColor       =   &H80000008&
      Height          =   2475
      Left            =   16920
      ScaleHeight     =   2445
      ScaleWidth      =   2385
      TabIndex        =   274
      Top             =   6030
      Visible         =   0   'False
      Width           =   2415
      Begin VB.CommandButton cmdReceiptTypeClose 
         Caption         =   "X"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   285
         Left            =   2115
         Style           =   1  'Graphical
         TabIndex        =   275
         Top             =   45
         Width           =   255
      End
      Begin MSHierarchicalFlexGridLib.MSHFlexGrid flxReceiptType 
         Height          =   2040
         Left            =   45
         TabIndex        =   276
         Top             =   360
         Width           =   2295
         _ExtentX        =   4048
         _ExtentY        =   3598
         _Version        =   393216
         FixedRows       =   0
         FixedCols       =   0
         BackColorFixed  =   13553358
         ForeColorFixed  =   -2147483634
         BackColorSel    =   12648447
         ForeColorSel    =   -2147483630
         BackColorBkg    =   16777215
         GridColor       =   14737632
         WordWrap        =   -1  'True
         GridLinesFixed  =   1
         ScrollBars      =   2
         SelectionMode   =   1
         Appearance      =   0
         BandDisplay     =   1
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Myriad Web"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         _NumberOfBands  =   1
         _Band(0).Cols   =   2
      End
      Begin VB.Label Label20 
         AutoSize        =   -1  'True
         BackStyle       =   0  'Transparent
         Caption         =   "Receipt Type"
         Height          =   195
         Index           =   17
         Left            =   270
         TabIndex        =   277
         Top             =   90
         Width           =   915
      End
      Begin VB.Shape Shape4 
         BackStyle       =   1  'Opaque
         BorderColor     =   &H00C0C0C0&
         BorderStyle     =   6  'Inside Solid
         FillColor       =   &H00E0FFFF&
         FillStyle       =   0  'Solid
         Height          =   240
         Index           =   0
         Left            =   45
         Top             =   75
         Width           =   2070
      End
   End
   Begin VB.Frame Frame17 
      BackColor       =   &H00C0C0C0&
      Caption         =   "Attachment"
      ForeColor       =   &H00000000&
      Height          =   2085
      Index           =   0
      Left            =   7605
      MousePointer    =   1  'Arrow
      TabIndex        =   264
      Top             =   9990
      Visible         =   0   'False
      Width           =   7440
      Begin VB.CommandButton cmdCloseAttcah 
         Caption         =   "X"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   285
         Left            =   7155
         Style           =   1  'Graphical
         TabIndex        =   270
         Top             =   45
         Width           =   255
      End
      Begin VB.CommandButton cmdAttachOK 
         BackColor       =   &H00FFC0C0&
         Caption         =   "Send EMail"
         Height          =   360
         Left            =   5760
         Style           =   1  'Graphical
         TabIndex        =   268
         Top             =   315
         Width           =   1155
      End
      Begin VB.CommandButton cmdOpenFile 
         Caption         =   "&Open Attachment"
         Height          =   360
         Left            =   2115
         Style           =   1  'Graphical
         TabIndex        =   266
         Top             =   315
         Width           =   1695
      End
      Begin VB.CommandButton cmdClinetAddAtch 
         Caption         =   "&Add Attachment"
         Height          =   360
         Left            =   405
         Style           =   1  'Graphical
         TabIndex        =   265
         Top             =   315
         Width           =   1605
      End
      Begin VB.CommandButton cmdDeleteFile 
         Caption         =   "&Remove Attachment"
         Height          =   360
         Left            =   3870
         Style           =   1  'Graphical
         TabIndex        =   267
         Top             =   315
         Width           =   1830
      End
      Begin MSHierarchicalFlexGridLib.MSHFlexGrid flxAttachment 
         Height          =   1230
         Left            =   90
         TabIndex        =   271
         Top             =   765
         Width           =   6840
         _ExtentX        =   12065
         _ExtentY        =   2170
         _Version        =   393216
         FixedRows       =   0
         FixedCols       =   0
         BackColorFixed  =   13553358
         ForeColorFixed  =   -2147483634
         BackColorSel    =   12648447
         ForeColorSel    =   -2147483630
         BackColorBkg    =   16777215
         GridColor       =   14737632
         WordWrap        =   -1  'True
         GridLinesFixed  =   1
         ScrollBars      =   2
         SelectionMode   =   1
         Appearance      =   0
         BandDisplay     =   1
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Myriad Web"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         _NumberOfBands  =   1
         _Band(0).Cols   =   2
      End
   End
   Begin VB.PictureBox fmeLoading 
      Appearance      =   0  'Flat
      BackColor       =   &H00FF0000&
      BorderStyle     =   0  'None
      ForeColor       =   &H00FF0000&
      Height          =   450
      Left            =   6525
      ScaleHeight     =   450
      ScaleWidth      =   2655
      TabIndex        =   262
      Top             =   5940
      Visible         =   0   'False
      Width           =   2655
      Begin VB.Label lblLoading 
         BackStyle       =   0  'Transparent
         Caption         =   "Please wait while loading ...."
         BeginProperty Font 
            Name            =   "Myriad Web"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H00FFFFFF&
         Height          =   330
         Left            =   270
         TabIndex        =   263
         Top             =   135
         Width           =   2745
      End
   End
   Begin VB.Frame fraSearch 
      BackColor       =   &H00C0C0C0&
      BorderStyle     =   0  'None
      Caption         =   "Automatic Demand Generate:"
      ForeColor       =   &H00FF00FF&
      Height          =   2220
      Left            =   16695
      TabIndex        =   243
      Top             =   2520
      Visible         =   0   'False
      Width           =   4530
      Begin VB.PictureBox Picture1 
         BackColor       =   &H00E5E5E5&
         Height          =   2100
         Index           =   0
         Left            =   45
         ScaleHeight     =   2040
         ScaleWidth      =   4365
         TabIndex        =   244
         Top             =   50
         Width           =   4425
         Begin VB.CommandButton Command2 
            Caption         =   "&Search"
            Height          =   375
            Left            =   1215
            TabIndex        =   426
            Top             =   1620
            Width           =   930
         End
         Begin VB.CommandButton cmdClearSearch 
            Caption         =   "Clear"
            Height          =   375
            Left            =   2115
            TabIndex        =   425
            Top             =   1620
            Width           =   1110
         End
         Begin VB.CommandButton cmdSearchOK 
            Caption         =   "&OK"
            Height          =   375
            Left            =   120
            TabIndex        =   250
            Top             =   1620
            Width           =   1020
         End
         Begin VB.CommandButton cmdSearchCancel 
            Caption         =   "&Cancel"
            Height          =   375
            Left            =   3135
            TabIndex        =   251
            Top             =   1635
            Width           =   1200
         End
         Begin VB.TextBox txtSearchNo 
            Appearance      =   0  'Flat
            Height          =   285
            Left            =   720
            MaxLength       =   10
            TabIndex        =   246
            Top             =   450
            Width           =   3495
         End
         Begin VB.TextBox txtSearchRef 
            Appearance      =   0  'Flat
            Height          =   285
            Left            =   720
            MaxLength       =   20
            TabIndex        =   247
            Top             =   790
            Width           =   3495
         End
         Begin VB.TextBox txtSearchFromD 
            Appearance      =   0  'Flat
            Height          =   285
            Left            =   720
            MaxLength       =   80
            TabIndex        =   248
            Top             =   1125
            Width           =   1740
         End
         Begin VB.TextBox txtSearchToD 
            Appearance      =   0  'Flat
            Height          =   285
            Left            =   2520
            MaxLength       =   80
            TabIndex        =   249
            Top             =   1125
            Width           =   1695
         End
         Begin VB.CommandButton cmdCloseSearch 
            Caption         =   "X"
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   285
            Left            =   4140
            Style           =   1  'Graphical
            TabIndex        =   245
            Top             =   0
            Width           =   255
         End
         Begin VB.Shape Shape1 
            BorderColor     =   &H00C0C0C0&
            FillColor       =   &H00FFC0C0&
            FillStyle       =   0  'Solid
            Height          =   60
            Index           =   2
            Left            =   0
            Top             =   240
            Width           =   4125
         End
         Begin VB.Shape Shape3 
            BorderColor     =   &H00C0FFFF&
            FillColor       =   &H00FFC0C0&
            FillStyle       =   0  'Solid
            Height          =   30
            Left            =   0
            Top             =   260
            Width           =   3855
         End
         Begin VB.Label Label6 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackColor       =   &H00FFDFC0&
            BackStyle       =   0  'Transparent
            Caption         =   "Search Options"
            BeginProperty Font 
               Name            =   "Myriad Web"
               Size            =   9
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H80000007&
            Height          =   210
            Index           =   1
            Left            =   300
            TabIndex        =   255
            Top             =   0
            Width           =   1200
         End
         Begin VB.Shape Shape4 
            BorderColor     =   &H00FFFFFF&
            BorderWidth     =   2
            Height          =   1200
            Index           =   2
            Left            =   75
            Top             =   360
            Width           =   4260
         End
         Begin VB.Shape Shape4 
            BorderColor     =   &H00FFC0C0&
            BorderWidth     =   3
            Height          =   1155
            Index           =   1
            Left            =   75
            Top             =   360
            Width           =   4215
         End
         Begin VB.Label Label6 
            AutoSize        =   -1  'True
            BackColor       =   &H00FFDFC0&
            BackStyle       =   0  'Transparent
            Caption         =   "No"
            BeginProperty Font 
               Name            =   "Myriad Web"
               Size            =   9
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H80000007&
            Height          =   210
            Index           =   2
            Left            =   180
            TabIndex        =   254
            Top             =   450
            Width           =   225
         End
         Begin VB.Label Label6 
            AutoSize        =   -1  'True
            BackColor       =   &H00FFDFC0&
            BackStyle       =   0  'Transparent
            Caption         =   "Lessee Name"
            BeginProperty Font 
               Name            =   "Myriad Web"
               Size            =   9
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H80000007&
            Height          =   210
            Index           =   3
            Left            =   180
            TabIndex        =   253
            Top             =   810
            Width           =   1020
         End
         Begin VB.Label Label6 
            AutoSize        =   -1  'True
            BackColor       =   &H00FFDFC0&
            BackStyle       =   0  'Transparent
            Caption         =   "Date"
            BeginProperty Font 
               Name            =   "Myriad Web"
               Size            =   9
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H80000007&
            Height          =   210
            Index           =   4
            Left            =   180
            TabIndex        =   252
            Top             =   1170
            Width           =   360
         End
      End
   End
   Begin VB.PictureBox picDmdLeaseList 
      Appearance      =   0  'Flat
      BackColor       =   &H80000005&
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   8.25
         Charset         =   0
         Weight          =   400
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      ForeColor       =   &H80000008&
      Height          =   4260
      Left            =   135
      ScaleHeight     =   4230
      ScaleWidth      =   8820
      TabIndex        =   226
      Top             =   11835
      Visible         =   0   'False
      Width           =   8850
      Begin VB.TextBox Text1 
         Appearance      =   0  'Flat
         BeginProperty Font 
            Name            =   "Myriad Web"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H00FF0000&
         Height          =   285
         Left            =   7245
         Locked          =   -1  'True
         TabIndex        =   236
         Top             =   300
         Width           =   1215
      End
      Begin VB.CommandButton cmdDmdGridUnitLookup 
         Caption         =   "X"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   285
         Left            =   8550
         Style           =   1  'Graphical
         TabIndex        =   230
         Top             =   20
         Width           =   270
      End
      Begin VB.TextBox txtDmdTenantSearchID 
         Appearance      =   0  'Flat
         BackColor       =   &H80000014&
         BeginProperty Font 
            Name            =   "Myriad Web"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H00FF0000&
         Height          =   285
         Left            =   210
         TabIndex        =   229
         Top             =   300
         Width           =   1335
      End
      Begin VB.TextBox txtDmdTenantSearchName 
         Appearance      =   0  'Flat
         BackColor       =   &H80000014&
         BeginProperty Font 
            Name            =   "Myriad Web"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H00FF0000&
         Height          =   285
         Left            =   1560
         TabIndex        =   228
         Top             =   300
         Width           =   4035
      End
      Begin VB.TextBox txtDmdTenantSearchUnitName 
         Appearance      =   0  'Flat
         BeginProperty Font 
            Name            =   "Myriad Web"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H00FF0000&
         Height          =   285
         Left            =   5655
         TabIndex        =   227
         Top             =   300
         Width           =   1530
      End
      Begin MSHierarchicalFlexGridLib.MSHFlexGrid flxDmdLeaseList 
         Height          =   3615
         Left            =   30
         TabIndex        =   231
         Top             =   600
         Width           =   8760
         _ExtentX        =   15452
         _ExtentY        =   6376
         _Version        =   393216
         Cols            =   5
         FixedCols       =   0
         BackColorFixed  =   13553358
         ForeColorFixed  =   12632256
         BackColorSel    =   12648447
         ForeColorSel    =   -2147483640
         BackColorBkg    =   16777215
         GridColor       =   -2147483638
         WordWrap        =   -1  'True
         GridLinesFixed  =   1
         SelectionMode   =   1
         Appearance      =   0
         BandDisplay     =   1
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Myriad Web"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         _NumberOfBands  =   1
         _Band(0).Cols   =   5
         _Band(0).GridLinesBand=   1
         _Band(0).TextStyleBand=   0
         _Band(0).TextStyleHeader=   0
      End
      Begin VB.Label Label20 
         AutoSize        =   -1  'True
         BackStyle       =   0  'Transparent
         Caption         =   "Balance"
         Height          =   195
         Index           =   11
         Left            =   7290
         TabIndex        =   235
         Top             =   45
         Width           =   540
      End
      Begin VB.Label Label20 
         AutoSize        =   -1  'True
         BackStyle       =   0  'Transparent
         Caption         =   "Unit Name"
         Height          =   195
         Index           =   7
         Left            =   5655
         TabIndex        =   234
         Top             =   75
         Width           =   735
      End
      Begin VB.Label Label20 
         AutoSize        =   -1  'True
         BackStyle       =   0  'Transparent
         Caption         =   "Name"
         Height          =   195
         Index           =   8
         Left            =   1560
         TabIndex        =   233
         Top             =   75
         Width           =   405
      End
      Begin VB.Label Label20 
         AutoSize        =   -1  'True
         BackStyle       =   0  'Transparent
         Caption         =   "ID"
         Height          =   195
         Index           =   9
         Left            =   210
         TabIndex        =   232
         Top             =   75
         Width           =   165
      End
      Begin VB.Shape Shape4 
         BackStyle       =   1  'Opaque
         BorderColor     =   &H00C0C0C0&
         BorderStyle     =   6  'Inside Solid
         FillColor       =   &H00C0FFFF&
         FillStyle       =   0  'Solid
         Height          =   240
         Index           =   17
         Left            =   45
         Top             =   30
         Width           =   8445
      End
   End
   Begin VB.PictureBox picClient 
      Appearance      =   0  'Flat
      BackColor       =   &H80000005&
      ForeColor       =   &H80000008&
      Height          =   4095
      Left            =   16335
      ScaleHeight     =   4065
      ScaleWidth      =   5265
      TabIndex        =   217
      Top             =   8865
      Visible         =   0   'False
      Width           =   5295
      Begin VB.CommandButton cmdPicCLose 
         Caption         =   "X"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   285
         Left            =   5010
         Style           =   1  'Graphical
         TabIndex        =   218
         Top             =   0
         Width           =   255
      End
      Begin MSHierarchicalFlexGridLib.MSHFlexGrid flxClient 
         Height          =   3345
         Left            =   45
         TabIndex        =   221
         Top             =   675
         Width           =   5175
         _ExtentX        =   9128
         _ExtentY        =   5900
         _Version        =   393216
         FixedRows       =   0
         FixedCols       =   0
         BackColorFixed  =   13553358
         ForeColorFixed  =   -2147483634
         BackColorSel    =   12648447
         ForeColorSel    =   -2147483630
         BackColorBkg    =   16777215
         GridColor       =   14737632
         WordWrap        =   -1  'True
         GridLinesFixed  =   1
         ScrollBars      =   2
         SelectionMode   =   1
         Appearance      =   0
         BandDisplay     =   1
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Myriad Web"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         _NumberOfBands  =   1
         _Band(0).Cols   =   2
      End
      Begin VB.Label Label20 
         AutoSize        =   -1  'True
         BackStyle       =   0  'Transparent
         Caption         =   "Job Name"
         Height          =   195
         Index           =   14
         Left            =   1665
         TabIndex        =   273
         Top             =   90
         Width           =   675
      End
      Begin VB.Label Label20 
         AutoSize        =   -1  'True
         BackStyle       =   0  'Transparent
         Caption         =   "Client Name"
         Height          =   195
         Index           =   13
         Left            =   1665
         TabIndex        =   272
         Top             =   90
         Width           =   870
      End
      Begin VB.Label Label20 
         AutoSize        =   -1  'True
         BackStyle       =   0  'Transparent
         Caption         =   "Client ID"
         Height          =   195
         Index           =   12
         Left            =   270
         TabIndex        =   269
         Top             =   90
         Width           =   630
      End
      Begin MSForms.TextBox txtSearchClientID 
         Height          =   255
         Left            =   45
         TabIndex        =   219
         Top             =   375
         Width           =   1530
         VariousPropertyBits=   679495707
         BorderStyle     =   1
         Size            =   "2699;450"
         SpecialEffect   =   0
         FontName        =   "Myriad Web"
         FontHeight      =   165
         FontCharSet     =   0
         FontPitchAndFamily=   2
      End
      Begin MSForms.TextBox txtSearchClientName 
         Height          =   255
         Left            =   1620
         TabIndex        =   220
         Top             =   375
         Width           =   3420
         VariousPropertyBits=   679495707
         BorderStyle     =   1
         Size            =   "6032;450"
         SpecialEffect   =   0
         FontName        =   "Myriad Web"
         FontHeight      =   165
         FontCharSet     =   0
         FontPitchAndFamily=   2
      End
      Begin VB.Shape Shape4 
         BackStyle       =   1  'Opaque
         BorderColor     =   &H00C0C0C0&
         BorderStyle     =   6  'Inside Solid
         FillColor       =   &H00E0FFFF&
         FillStyle       =   0  'Solid
         Height          =   240
         Index           =   15
         Left            =   45
         Top             =   75
         Width           =   4950
      End
   End
   Begin VB.PictureBox picPrnMrk 
      Appearance      =   0  'Flat
      BackColor       =   &H80000005&
      BorderStyle     =   0  'None
      ForeColor       =   &H80000008&
      Height          =   1095
      Left            =   16965
      ScaleHeight     =   1095
      ScaleWidth      =   2175
      TabIndex        =   205
      Top             =   4770
      Width           =   2180
      Begin VB.CommandButton cmdPrnMrk 
         Caption         =   "Toggle the printer mark"
         Height          =   375
         Left            =   0
         TabIndex        =   206
         Top             =   0
         Width           =   2175
      End
   End
   Begin VB.Frame fraDemandListCriteria 
      BackColor       =   &H00E0E0E0&
      BorderStyle     =   0  'None
      Caption         =   "Frame9"
      BeginProperty Font 
         Name            =   "Arial"
         Size            =   8.25
         Charset         =   0
         Weight          =   400
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   2415
      Left            =   17145
      TabIndex        =   66
      Top             =   90
      Visible         =   0   'False
      Width           =   2895
      Begin VB.OptionButton optDmdListSng 
         BackColor       =   &H00E0E0E0&
         Caption         =   "Details"
         BeginProperty Font 
            Name            =   "Myriad Web"
            Size            =   9
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H8000000D&
         Height          =   255
         Left            =   120
         TabIndex        =   177
         Top             =   1440
         Value           =   -1  'True
         Width           =   2655
      End
      Begin VB.OptionButton optDmdListCons 
         BackColor       =   &H00E0E0E0&
         Caption         =   "Summary"
         BeginProperty Font 
            Name            =   "Myriad Web"
            Size            =   9
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H8000000D&
         Height          =   255
         Left            =   120
         TabIndex        =   176
         Top             =   1740
         Width           =   2415
      End
      Begin VB.TextBox txtDLTo 
         Alignment       =   2  'Center
         Appearance      =   0  'Flat
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   300
         Left            =   1080
         MaxLength       =   10
         TabIndex        =   68
         Top             =   960
         Width           =   1455
      End
      Begin VB.TextBox txtDLFrom 
         Alignment       =   2  'Center
         Appearance      =   0  'Flat
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   300
         Left            =   1080
         MaxLength       =   10
         TabIndex        =   67
         Text            =   "01/01/2000"
         Top             =   600
         Width           =   1455
      End
      Begin VB.CommandButton cmdDLCancel 
         Caption         =   "&Cancel"
         Height          =   322
         Left            =   1725
         TabIndex        =   70
         Top             =   2040
         Width           =   1095
      End
      Begin VB.CommandButton cmdDLOk 
         Caption         =   "&OK"
         Height          =   322
         Left            =   80
         Style           =   1  'Graphical
         TabIndex        =   69
         Top             =   2040
         Width           =   1095
      End
      Begin VB.Label Label7 
         AutoSize        =   -1  'True
         BackColor       =   &H00FFDFC0&
         BackStyle       =   0  'Transparent
         Caption         =   "To:"
         BeginProperty Font 
            Name            =   "Arial"
            Size            =   9
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H8000000D&
         Height          =   225
         Index           =   7
         Left            =   120
         TabIndex        =   73
         Top             =   960
         Width           =   255
      End
      Begin VB.Label Label7 
         AutoSize        =   -1  'True
         BackColor       =   &H00FFDFC0&
         BackStyle       =   0  'Transparent
         Caption         =   "From:"
         BeginProperty Font 
            Name            =   "Arial"
            Size            =   9
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H8000000D&
         Height          =   225
         Index           =   6
         Left            =   120
         TabIndex        =   72
         Top             =   600
         Width           =   480
      End
      Begin VB.Shape Shape6 
         BorderColor     =   &H00FFFFFF&
         FillColor       =   &H000000C0&
         FillStyle       =   0  'Solid
         Height          =   25
         Index           =   3
         Left            =   0
         Top             =   360
         Width           =   3855
      End
      Begin VB.Label Label7 
         AutoSize        =   -1  'True
         BackColor       =   &H00FFDFC0&
         BackStyle       =   0  'Transparent
         Caption         =   "Date Range"
         BeginProperty Font 
            Name            =   "Myriad Web"
            Size            =   9
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H00000000&
         Height          =   210
         Index           =   5
         Left            =   120
         TabIndex        =   71
         Top             =   75
         Width           =   915
      End
      Begin VB.Shape Shape4 
         BorderColor     =   &H00FFC0C0&
         BorderWidth     =   2
         Height          =   900
         Index           =   11
         Left            =   45
         Top             =   480
         Width           =   2775
      End
      Begin VB.Shape Shape6 
         BorderColor     =   &H00FFC0FF&
         FillColor       =   &H00FFC0C0&
         FillStyle       =   0  'Solid
         Height          =   60
         Index           =   6
         Left            =   0
         Top             =   340
         Width           =   3855
      End
      Begin VB.Shape Shape4 
         BorderColor     =   &H00FF8080&
         BorderWidth     =   3
         Height          =   900
         Index           =   12
         Left            =   45
         Top             =   495
         Width           =   2775
      End
   End
   Begin VB.PictureBox picLeaseList 
      Appearance      =   0  'Flat
      BackColor       =   &H80000005&
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   8.25
         Charset         =   0
         Weight          =   400
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      ForeColor       =   &H80000008&
      Height          =   2535
      Left            =   9000
      ScaleHeight     =   2505
      ScaleWidth      =   6825
      TabIndex        =   52
      Top             =   12105
      Visible         =   0   'False
      Width           =   6855
      Begin VB.TextBox Text2 
         Appearance      =   0  'Flat
         BeginProperty Font 
            Name            =   "Myriad Web"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H00FF0000&
         Height          =   285
         Left            =   5570
         Locked          =   -1  'True
         TabIndex        =   237
         Top             =   300
         Width           =   1080
      End
      Begin VB.CommandButton cmdGridUnitLookup 
         Caption         =   "X"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   285
         Left            =   6555
         Style           =   1  'Graphical
         TabIndex        =   62
         Top             =   20
         Width           =   255
      End
      Begin VB.TextBox txtTenantSearchID 
         Appearance      =   0  'Flat
         BackColor       =   &H80000014&
         ForeColor       =   &H00FF0000&
         Height          =   285
         Left            =   90
         TabIndex        =   59
         Top             =   300
         Width           =   1485
      End
      Begin VB.TextBox txtTenantSearchName 
         Appearance      =   0  'Flat
         BackColor       =   &H80000014&
         ForeColor       =   &H00FF0000&
         Height          =   285
         Left            =   1590
         TabIndex        =   60
         Top             =   300
         Width           =   2235
      End
      Begin VB.TextBox txtTenantSearchUnitName 
         Appearance      =   0  'Flat
         ForeColor       =   &H00FF0000&
         Height          =   285
         Left            =   3840
         TabIndex        =   61
         Top             =   300
         Width           =   1695
      End
      Begin VB.Frame Frame4 
         Appearance      =   0  'Flat
         BackColor       =   &H80000005&
         BorderStyle     =   0  'None
         BeginProperty Font 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H80000008&
         Height          =   375
         Index           =   3
         Left            =   0
         TabIndex        =   53
         Top             =   3240
         Visible         =   0   'False
         Width           =   6015
         Begin MSForms.ComboBox cboSrcClient 
            Height          =   315
            Index           =   0
            Left            =   480
            TabIndex        =   57
            Top             =   0
            Width           =   2415
            VariousPropertyBits=   1753237531
            DisplayStyle    =   3
            Size            =   "4260;556"
            BoundColumn     =   0
            TextColumn      =   2
            ColumnCount     =   8
            ListRows        =   20
            cColumnInfo     =   1
            MatchEntry      =   1
            ShowDropButtonWhen=   2
            SpecialEffect   =   6
            FontName        =   "Myriad Web"
            FontHeight      =   165
            FontCharSet     =   0
            FontPitchAndFamily=   2
            Object.Width           =   "1411"
         End
         Begin MSForms.ComboBox cboSrcProp 
            Height          =   315
            Index           =   0
            Left            =   3675
            TabIndex        =   56
            Top             =   0
            Width           =   2295
            VariousPropertyBits=   1753237531
            DisplayStyle    =   3
            Size            =   "4048;556"
            BoundColumn     =   0
            TextColumn      =   2
            ColumnCount     =   3
            ListRows        =   20
            cColumnInfo     =   1
            MatchEntry      =   1
            ShowDropButtonWhen=   2
            SpecialEffect   =   6
            FontName        =   "Myriad Web"
            FontHeight      =   165
            FontCharSet     =   0
            FontPitchAndFamily=   2
            Object.Width           =   "1411"
         End
         Begin VB.Label Label20 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Client:"
            BeginProperty Font 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   195
            Index           =   3
            Left            =   0
            TabIndex        =   55
            Top             =   0
            Width           =   465
         End
         Begin VB.Label Label20 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Property:"
            BeginProperty Font 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   195
            Index           =   4
            Left            =   3000
            TabIndex        =   54
            Top             =   0
            Width           =   645
         End
      End
      Begin MSHierarchicalFlexGridLib.MSHFlexGrid flxLeaseList 
         Height          =   1860
         Left            =   45
         TabIndex        =   58
         Top             =   600
         Width           =   6735
         _ExtentX        =   11880
         _ExtentY        =   3281
         _Version        =   393216
         Cols            =   5
         FixedCols       =   0
         BackColorFixed  =   13553358
         ForeColorFixed  =   12632256
         BackColorSel    =   12648447
         ForeColorSel    =   -2147483640
         BackColorBkg    =   16777215
         GridColor       =   -2147483638
         WordWrap        =   -1  'True
         GridLinesFixed  =   1
         SelectionMode   =   1
         Appearance      =   0
         BandDisplay     =   1
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Myriad Web"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         _NumberOfBands  =   1
         _Band(0).Cols   =   5
         _Band(0).GridLinesBand=   1
         _Band(0).TextStyleBand=   0
         _Band(0).TextStyleHeader=   0
      End
      Begin VB.Label Label20 
         AutoSize        =   -1  'True
         BackStyle       =   0  'Transparent
         Caption         =   "A/C Balance"
         Height          =   195
         Index           =   10
         Left            =   5520
         TabIndex        =   179
         Top             =   75
         Width           =   840
      End
      Begin VB.Label Label20 
         AutoSize        =   -1  'True
         BackStyle       =   0  'Transparent
         Caption         =   "Unit Name"
         Height          =   195
         Index           =   2
         Left            =   3840
         TabIndex        =   65
         Top             =   75
         Width           =   735
      End
      Begin VB.Label Label20 
         AutoSize        =   -1  'True
         BackStyle       =   0  'Transparent
         Caption         =   "Lessee"
         Height          =   195
         Index           =   1
         Left            =   1590
         TabIndex        =   64
         Top             =   75
         Width           =   495
      End
      Begin VB.Label Label20 
         AutoSize        =   -1  'True
         BackStyle       =   0  'Transparent
         Caption         =   "ID"
         Height          =   195
         Index           =   0
         Left            =   120
         TabIndex        =   63
         Top             =   75
         Width           =   165
      End
      Begin VB.Shape Shape4 
         BackStyle       =   1  'Opaque
         BorderColor     =   &H00C0C0C0&
         BorderStyle     =   6  'Inside Solid
         FillColor       =   &H00C0FFFF&
         FillStyle       =   0  'Solid
         Height          =   195
         Index           =   6
         Left            =   45
         Top             =   75
         Width           =   6480
      End
   End
   Begin VB.Frame fraInvCrChoice 
      BackColor       =   &H00C0C0C0&
      BorderStyle     =   0  'None
      Caption         =   "Automatic Demand Generate:"
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   8.25
         Charset         =   0
         Weight          =   400
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      ForeColor       =   &H00FF00FF&
      Height          =   1860
      Left            =   135
      TabIndex        =   37
      Top             =   9990
      Visible         =   0   'False
      Width           =   3765
      Begin VB.PictureBox Picture1 
         BackColor       =   &H80000000&
         BeginProperty Font 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   1740
         Index           =   2
         Left            =   0
         ScaleHeight     =   1680
         ScaleWidth      =   3645
         TabIndex        =   38
         Top             =   45
         Width           =   3705
         Begin VB.OptionButton optManualAdjInv 
            BackColor       =   &H00E5E5E5&
            Caption         =   "Adjustment Invoice"
            ForeColor       =   &H00400000&
            Height          =   255
            Left            =   1335
            TabIndex        =   44
            Top             =   510
            Width           =   1695
         End
         Begin VB.OptionButton optManualAdjCrNote 
            BackColor       =   &H00E5E5E5&
            Caption         =   "Adjustment Credit Note"
            ForeColor       =   &H00400000&
            Height          =   255
            Left            =   1335
            TabIndex        =   43
            Top             =   855
            Width           =   2055
         End
         Begin VB.OptionButton optManualCrNote 
            BackColor       =   &H00E5E5E5&
            Caption         =   "Credit Note"
            ForeColor       =   &H00400000&
            Height          =   255
            Left            =   135
            TabIndex        =   42
            Top             =   855
            Width           =   1200
         End
         Begin VB.OptionButton optManualInv 
            BackColor       =   &H00E5E5E5&
            Caption         =   "Invoice"
            ForeColor       =   &H00400000&
            Height          =   255
            Left            =   120
            TabIndex        =   41
            Top             =   525
            Value           =   -1  'True
            Width           =   1095
         End
         Begin VB.CommandButton cmdManualDmdOk 
            Caption         =   "&OK"
            Height          =   375
            Left            =   80
            TabIndex        =   40
            Top             =   1200
            Width           =   1335
         End
         Begin VB.CommandButton cmdManualDmdCancel 
            Caption         =   "&Cancel"
            Height          =   375
            Left            =   2100
            TabIndex        =   39
            Top             =   1200
            Width           =   1335
         End
         Begin VB.Shape Shape4 
            BorderColor     =   &H0000C0C0&
            FillColor       =   &H00FF8080&
            FillStyle       =   0  'Solid
            Height          =   45
            Index           =   26
            Left            =   45
            Top             =   375
            Width           =   3495
         End
         Begin VB.Label Label6 
            AutoSize        =   -1  'True
            BackColor       =   &H00FFDFC0&
            BackStyle       =   0  'Transparent
            Caption         =   "Create Demand for:"
            BeginProperty Font 
               Name            =   "Myriad Web"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H00000000&
            Height          =   195
            Index           =   0
            Left            =   120
            TabIndex        =   45
            Top             =   135
            Width           =   1470
         End
         Begin VB.Shape Shape4 
            BorderColor     =   &H00FFC0C0&
            BorderWidth     =   2
            Height          =   1560
            Index           =   4
            Left            =   75
            Top             =   75
            Width           =   3495
         End
         Begin VB.Shape Shape4 
            BackColor       =   &H00808080&
            BorderColor     =   &H00C00000&
            BorderWidth     =   3
            Height          =   1695
            Index           =   5
            Left            =   -15
            Top             =   -15
            Width           =   3630
         End
      End
   End
   Begin VB.Frame Frame4 
      BackColor       =   &H00E5E5E5&
      BorderStyle     =   0  'None
      Caption         =   "Frame4"
      BeginProperty Font 
         Name            =   "Arial"
         Size            =   8.25
         Charset         =   0
         Weight          =   400
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   1875
      Index           =   1
      Left            =   4770
      TabIndex        =   46
      Top             =   9900
      Visible         =   0   'False
      Width           =   2775
      Begin VB.CheckBox chkSettleAll 
         BackColor       =   &H00E5E5E5&
         Caption         =   "Settle All"
         ForeColor       =   &H8000000D&
         Height          =   255
         Left            =   240
         MaskColor       =   &H00808080&
         TabIndex        =   173
         Top             =   1120
         Width           =   1095
      End
      Begin VB.OptionButton optOIF 
         BackColor       =   &H00E5E5E5&
         Caption         =   "The Oldest invoice first"
         ForeColor       =   &H8000000D&
         Height          =   255
         Left            =   200
         MaskColor       =   &H00808080&
         TabIndex        =   48
         Top             =   360
         Value           =   -1  'True
         Width           =   2350
      End
      Begin VB.OptionButton optRIF 
         BackColor       =   &H00E5E5E5&
         Caption         =   "The Recent invoices first"
         ForeColor       =   &H8000000D&
         Height          =   255
         Left            =   200
         MaskColor       =   &H00808080&
         TabIndex        =   49
         Top             =   720
         Width           =   2350
      End
      Begin VB.CommandButton cmdAutoAllocSel 
         Caption         =   "&OK"
         Height          =   365
         Left            =   120
         Style           =   1  'Graphical
         TabIndex        =   47
         Top             =   1440
         Width           =   1095
      End
      Begin VB.CommandButton cmdAutoAllocSelCancel 
         Caption         =   "&Cancel"
         Height          =   365
         Left            =   1560
         Style           =   1  'Graphical
         TabIndex        =   50
         Top             =   1440
         Width           =   1095
      End
      Begin VB.Shape Shape4 
         BackColor       =   &H00000000&
         BorderColor     =   &H00C0C0C0&
         BorderWidth     =   2
         Height          =   1500
         Index           =   29
         Left            =   2760
         Top             =   1920
         Width           =   1080
      End
      Begin VB.Shape Shape4 
         BackColor       =   &H00000000&
         BorderColor     =   &H00000000&
         BorderWidth     =   2
         Height          =   660
         Index           =   25
         Left            =   2760
         Top             =   1920
         Width           =   240
      End
      Begin VB.Label Label7 
         Alignment       =   1  'Right Justify
         AutoSize        =   -1  'True
         BackColor       =   &H00FFDFC0&
         BackStyle       =   0  'Transparent
         Caption         =   "Select Option:"
         BeginProperty Font 
            Name            =   "Myriad Web"
            Size            =   9
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H00000000&
         Height          =   210
         Index           =   2
         Left            =   120
         TabIndex        =   51
         Top             =   30
         Width           =   1110
      End
      Begin VB.Shape Shape4 
         BackColor       =   &H00C00000&
         BorderColor     =   &H00FFC0C0&
         BorderWidth     =   2
         Height          =   855
         Index           =   8
         Left            =   120
         Top             =   240
         Width           =   2535
      End
      Begin VB.Shape Shape4 
         BorderColor     =   &H00FF0000&
         BorderWidth     =   3
         Height          =   855
         Index           =   7
         Left            =   120
         Top             =   240
         Width           =   2535
      End
   End
   Begin TabDlg.SSTab tabDmdRcpt 
      Height          =   9840
      Left            =   75
      TabIndex        =   0
      Top             =   75
      Width           =   16335
      _ExtentX        =   28813
      _ExtentY        =   17357
      _Version        =   393216
      Style           =   1
      TabHeight       =   520
      BackColor       =   14737632
      BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
         Name            =   "Myriad Web"
         Size            =   9
         Charset         =   0
         Weight          =   400
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      TabCaption(0)   =   "Demands"
      TabPicture(0)   =   "frmDemand.frx":08CA
      Tab(0).ControlEnabled=   -1  'True
      Tab(0).Control(0)=   "Label44(3)"
      Tab(0).Control(0).Enabled=   0   'False
      Tab(0).Control(1)=   "Label1(7)"
      Tab(0).Control(1).Enabled=   0   'False
      Tab(0).Control(2)=   "Label50(10)"
      Tab(0).Control(2).Enabled=   0   'False
      Tab(0).Control(3)=   "fraDemandMainlist"
      Tab(0).Control(3).Enabled=   0   'False
      Tab(0).Control(4)=   "fraDetails"
      Tab(0).Control(4).Enabled=   0   'False
      Tab(0).Control(5)=   "fraCreateManualDemand"
      Tab(0).Control(5).Enabled=   0   'False
      Tab(0).Control(6)=   "fraGenerateDemands"
      Tab(0).Control(6).Enabled=   0   'False
      Tab(0).Control(7)=   "fraEditDemand"
      Tab(0).Control(7).Enabled=   0   'False
      Tab(0).Control(8)=   "fraPrint"
      Tab(0).Control(8).Enabled=   0   'False
      Tab(0).Control(9)=   "FraEmailSection"
      Tab(0).Control(9).Enabled=   0   'False
      Tab(0).ControlCount=   10
      TabCaption(1)   =   "Demand History"
      TabPicture(1)   =   "frmDemand.frx":08E6
      Tab(1).ControlEnabled=   0   'False
      Tab(1).Control(0)=   "Label44(38)"
      Tab(1).Control(1)=   "Label44(39)"
      Tab(1).Control(2)=   "txtClientHistory"
      Tab(1).Control(3)=   "txtPropertyHistory"
      Tab(1).Control(4)=   "Label44(42)"
      Tab(1).Control(5)=   "Label44(43)"
      Tab(1).Control(6)=   "txtLesseeListHist"
      Tab(1).Control(7)=   "txtUnitListHist"
      Tab(1).Control(8)=   "Frame7"
      Tab(1).Control(9)=   "Frame1(1)"
      Tab(1).Control(10)=   "Frame1(0)"
      Tab(1).Control(11)=   "Frame1(2)"
      Tab(1).Control(12)=   "cmdClientHistory"
      Tab(1).Control(13)=   "cmdPropertyHistory"
      Tab(1).Control(14)=   "cmdLesseeListHist"
      Tab(1).Control(15)=   "cmdUnitHist"
      Tab(1).Control(16)=   "chkCheckAllHisDemand"
      Tab(1).Control(17)=   "cmdDReceiptHistSearch"
      Tab(1).ControlCount=   18
      TabCaption(2)   =   "Receipts"
      TabPicture(2)   =   "frmDemand.frx":0902
      Tab(2).ControlEnabled=   0   'False
      Tab(2).Control(0)=   "tabPayment"
      Tab(2).Control(0).Enabled=   0   'False
      Tab(2).ControlCount=   1
      Begin VB.CommandButton cmdDReceiptHistSearch 
         Caption         =   "Sea&rch"
         Height          =   375
         Left            =   -70365
         Style           =   1  'Graphical
         TabIndex        =   256
         Top             =   9225
         Width           =   1215
      End
      Begin VB.CheckBox chkCheckAllHisDemand 
         Appearance      =   0  'Flat
         Caption         =   "&Select All"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H80000008&
         Height          =   255
         Left            =   -74775
         TabIndex        =   242
         Top             =   855
         Width           =   255
      End
      Begin VB.CommandButton cmdUnitHist 
         Caption         =   ".."
         BeginProperty Font 
            Name            =   "Myriad Web"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   300
         Left            =   -63705
         TabIndex        =   215
         Top             =   450
         Width           =   300
      End
      Begin VB.CommandButton cmdLesseeListHist 
         Caption         =   ".."
         BeginProperty Font 
            Name            =   "Myriad Web"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   300
         Left            =   -60960
         TabIndex        =   216
         Top             =   450
         Width           =   300
      End
      Begin VB.CommandButton cmdPropertyHistory 
         Caption         =   ".."
         BeginProperty Font 
            Name            =   "Myriad Web"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   300
         Left            =   -67350
         TabIndex        =   214
         Top             =   450
         Width           =   300
      End
      Begin VB.CommandButton cmdClientHistory 
         Caption         =   ".."
         BeginProperty Font 
            Name            =   "Myriad Web"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   300
         Left            =   -70950
         TabIndex        =   212
         Top             =   450
         Width           =   300
      End
      Begin VB.Frame FraEmailSection 
         Height          =   2205
         Left            =   80
         TabIndex        =   201
         Top             =   7440
         Width           =   1215
         Begin VB.CommandButton cmdSearch 
            Caption         =   "Sea&rch"
            Height          =   375
            Left            =   90
            Style           =   1  'Graphical
            TabIndex        =   31
            Top             =   1575
            Width           =   1080
         End
         Begin VB.CommandButton cmdArchive 
            Caption         =   "Archive"
            Height          =   315
            Left            =   80
            Style           =   1  'Graphical
            TabIndex        =   30
            Top             =   1080
            Width           =   1080
         End
         Begin VB.CommandButton cmdEmailSt 
            Caption         =   "Statement"
            Height          =   315
            Left            =   80
            Style           =   1  'Graphical
            TabIndex        =   29
            Top             =   720
            Width           =   1080
         End
         Begin VB.CommandButton cmdEmailDmds 
            Caption         =   "Demands"
            Height          =   315
            Left            =   80
            Style           =   1  'Graphical
            TabIndex        =   28
            Top             =   360
            Width           =   1080
         End
         Begin VB.Label Label19 
            Alignment       =   2  'Center
            BackColor       =   &H00E5E5E5&
            BackStyle       =   0  'Transparent
            Caption         =   "Email"
            BeginProperty Font 
               Name            =   "Myriad Web"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H00404000&
            Height          =   255
            Index           =   5
            Left            =   0
            MousePointer    =   99  'Custom
            TabIndex        =   202
            Top             =   135
            Width           =   1155
         End
      End
      Begin VB.Frame Frame1 
         BackColor       =   &H00E5E5E5&
         BorderStyle     =   0  'None
         Caption         =   "Frame11"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   615
         Index           =   2
         Left            =   -74880
         TabIndex        =   174
         Top             =   9105
         Width           =   3375
         Begin VB.CommandButton cmdCopySalesTranHistory 
            Caption         =   "Copy"
            Height          =   375
            Left            =   2040
            Style           =   1  'Graphical
            TabIndex        =   200
            Top             =   120
            Visible         =   0   'False
            Width           =   1200
         End
         Begin VB.CommandButton cmdRevHistory 
            Caption         =   "Reverse History"
            BeginProperty Font 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   375
            Left            =   120
            Style           =   1  'Graphical
            TabIndex        =   175
            Top             =   120
            Width           =   1455
         End
      End
      Begin VB.Frame fraPrint 
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   3225
         Left            =   80
         TabIndex        =   35
         Top             =   4245
         Width           =   1215
         Begin VB.CommandButton cmdDemandList 
            Caption         =   "Demand List"
            Height          =   315
            Index           =   0
            Left            =   80
            Style           =   1  'Graphical
            TabIndex        =   27
            Top             =   1680
            Width           =   1080
         End
         Begin VB.CommandButton cmdPrintStatement 
            Caption         =   "Selected Statements"
            Height          =   450
            Left            =   80
            Style           =   1  'Graphical
            TabIndex        =   26
            Top             =   1195
            Visible         =   0   'False
            Width           =   1080
         End
         Begin VB.CommandButton cmdPrintAll 
            Caption         =   "All Demands"
            Height          =   315
            Left            =   80
            Style           =   1  'Graphical
            TabIndex        =   25
            Top             =   845
            Width           =   1080
         End
         Begin VB.CommandButton cmdPrintThis 
            Caption         =   "Selected Demands"
            Height          =   450
            Left            =   80
            Style           =   1  'Graphical
            TabIndex        =   24
            Top             =   360
            Width           =   1080
         End
         Begin VB.Label Label19 
            Alignment       =   2  'Center
            BackColor       =   &H00E5E5E5&
            BackStyle       =   0  'Transparent
            Caption         =   "Print"
            BeginProperty Font 
               Name            =   "Myriad Web"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H00404000&
            Height          =   255
            Index           =   35
            Left            =   45
            MousePointer    =   99  'Custom
            TabIndex        =   36
            Top             =   120
            Width           =   1155
         End
      End
      Begin VB.Frame fraEditDemand 
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   1665
         Left            =   80
         TabIndex        =   33
         Top             =   2580
         Width           =   1215
         Begin VB.CommandButton cmdCopy 
            Caption         =   "Copy"
            Height          =   315
            Left            =   80
            Style           =   1  'Graphical
            TabIndex        =   23
            Top             =   1080
            Visible         =   0   'False
            Width           =   1080
         End
         Begin VB.CommandButton cmdPostDemands 
            Caption         =   "Post to Hist."
            Height          =   315
            Left            =   80
            Style           =   1  'Graphical
            TabIndex        =   22
            Top             =   720
            Width           =   1080
         End
         Begin VB.CommandButton cmdEdit 
            Caption         =   "&Edit"
            Height          =   315
            Left            =   80
            Style           =   1  'Graphical
            TabIndex        =   21
            Top             =   360
            Width           =   1080
         End
         Begin VB.Label lblEditDemand 
            Alignment       =   2  'Center
            BackColor       =   &H00E5E5E5&
            BackStyle       =   0  'Transparent
            Caption         =   "Edit Demands"
            BeginProperty Font 
               Name            =   "Myriad Web"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H00404000&
            Height          =   255
            Left            =   45
            MousePointer    =   99  'Custom
            TabIndex        =   34
            Top             =   120
            Width           =   1155
         End
      End
      Begin VB.Frame fraGenerateDemands 
         BeginProperty Font 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   2220
         Left            =   75
         TabIndex        =   16
         Top             =   360
         Width           =   1215
         Begin VB.CommandButton cmdBatchDemands 
            Caption         =   "&Batch"
            Height          =   315
            Left            =   80
            Style           =   1  'Graphical
            TabIndex        =   20
            Top             =   1560
            Width           =   1080
         End
         Begin VB.CommandButton cmdPreViewGenDmds 
            Caption         =   "Preview"
            Height          =   315
            Left            =   80
            Style           =   1  'Graphical
            TabIndex        =   17
            Top             =   520
            Width           =   1080
         End
         Begin VB.CommandButton cmdGenAll 
            Caption         =   "&Automatic..."
            Height          =   315
            Left            =   80
            Style           =   1  'Graphical
            TabIndex        =   18
            Top             =   866
            Width           =   1080
         End
         Begin MyHoverButton.Button cmdGenerateManual 
            Height          =   315
            Left            =   80
            TabIndex        =   19
            Top             =   1212
            Width           =   1080
            _ExtentX        =   1905
            _ExtentY        =   556
            BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
               Name            =   "Myriad Web"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Picture         =   "frmDemand.frx":091E
            HoverPicture    =   "frmDemand.frx":093A
            DisabledPicture =   "frmDemand.frx":0956
            DownPicture     =   "frmDemand.frx":0972
            MouseIcon       =   "frmDemand.frx":098E
            Caption         =   "&Manual..."
            HoverCaption    =   "&Manual..."
            DownCaption     =   "&Manual..."
         End
         Begin VB.Label lblGenerate 
            Alignment       =   2  'Center
            BackColor       =   &H00E5E5E5&
            BackStyle       =   0  'Transparent
            Caption         =   "Generate Demands"
            BeginProperty Font 
               Name            =   "Myriad Web"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H00404000&
            Height          =   375
            Left            =   120
            MousePointer    =   99  'Custom
            TabIndex        =   32
            Top             =   120
            Width           =   915
         End
      End
      Begin VB.Frame fraCreateManualDemand 
         BackColor       =   &H00E0E0E0&
         Caption         =   "Generate Manual Demands"
         BeginProperty Font 
            Name            =   "Myriad Web"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H00000000&
         Height          =   9330
         Left            =   2925
         TabIndex        =   1
         Top             =   1665
         Visible         =   0   'False
         Width           =   13815
         Begin VB.CommandButton cmdAddNewLine 
            BackColor       =   &H00FFC0C0&
            Caption         =   "Add a New Line"
            BeginProperty Font 
               Name            =   "Myriad Web"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   375
            Left            =   11745
            TabIndex        =   329
            Top             =   1710
            Width           =   1815
         End
         Begin VB.CommandButton cmdCancel 
            Caption         =   "&Cancel"
            Enabled         =   0   'False
            Height          =   325
            Left            =   10710
            TabIndex        =   346
            Top             =   4230
            Width           =   1455
         End
         Begin VB.CommandButton cmdUpdate 
            Caption         =   "&OK"
            Enabled         =   0   'False
            Height          =   325
            Left            =   12195
            TabIndex        =   347
            Top             =   4230
            Width           =   1455
         End
         Begin VB.Frame fraAddNew 
            BackColor       =   &H00C0C0C0&
            BorderStyle     =   0  'None
            Caption         =   "New Demand"
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   615
            Left            =   45
            TabIndex        =   378
            Top             =   8640
            Width           =   13665
            Begin VB.CommandButton cmdCancelNew 
               Caption         =   "&Cancel"
               Height          =   375
               Left            =   11265
               TabIndex        =   353
               Top             =   120
               Width           =   1335
            End
            Begin VB.CommandButton cmdSaveNew 
               Caption         =   "&Save"
               Enabled         =   0   'False
               Height          =   375
               Left            =   9705
               TabIndex        =   352
               Top             =   120
               Width           =   1335
            End
         End
         Begin VB.Frame FraTopAddNewLine 
            Height          =   1500
            Left            =   45
            TabIndex        =   314
            Top             =   180
            Width           =   13695
            Begin VB.TextBox txtUnit 
               Appearance      =   0  'Flat
               ForeColor       =   &H00FF0000&
               Height          =   285
               Left            =   6930
               Locked          =   -1  'True
               TabIndex        =   320
               Top             =   240
               Width           =   1455
            End
            Begin VB.TextBox txtDemandID 
               Appearance      =   0  'Flat
               ForeColor       =   &H00FF0000&
               Height          =   285
               Left            =   8730
               Locked          =   -1  'True
               TabIndex        =   322
               Top             =   135
               Visible         =   0   'False
               Width           =   855
            End
            Begin VB.TextBox txtIssueDate 
               Appearance      =   0  'Flat
               ForeColor       =   &H00FF0000&
               Height          =   285
               Left            =   11805
               MaxLength       =   10
               TabIndex        =   328
               Top             =   225
               Width           =   1455
            End
            Begin VB.TextBox txtLeaseEndDate 
               Appearance      =   0  'Flat
               ForeColor       =   &H00FF0000&
               Height          =   285
               Left            =   6930
               Locked          =   -1  'True
               TabIndex        =   321
               Top             =   600
               Width           =   1455
            End
            Begin VB.CommandButton cmdDmdClientList 
               Caption         =   ".."
               BeginProperty Font 
                  Name            =   "Myriad Web"
                  Size            =   8.25
                  Charset         =   0
                  Weight          =   700
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               Height          =   300
               Left            =   4515
               TabIndex        =   315
               Top             =   225
               Width           =   300
            End
            Begin VB.CommandButton cmdDmdPropertyList 
               Caption         =   ".."
               BeginProperty Font 
                  Name            =   "Myriad Web"
                  Size            =   8.25
                  Charset         =   0
                  Weight          =   700
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               Height          =   300
               Left            =   4515
               TabIndex        =   317
               Top             =   585
               Width           =   300
            End
            Begin VB.CommandButton cmdFreq 
               Caption         =   ".."
               Enabled         =   0   'False
               BeginProperty Font 
                  Name            =   "Myriad Web"
                  Size            =   8.25
                  Charset         =   0
                  Weight          =   700
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               Height          =   300
               Left            =   11175
               TabIndex        =   327
               Top             =   1035
               Width           =   300
            End
            Begin VB.CommandButton cmdDmdTenantLookup 
               Caption         =   ".."
               BeginProperty Font 
                  Name            =   "Myriad Web"
                  Size            =   8.25
                  Charset         =   0
                  Weight          =   700
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               Height          =   300
               Left            =   4515
               TabIndex        =   319
               Top             =   945
               Width           =   300
            End
            Begin MSForms.CheckBox chkExcludeInCS 
               Height          =   255
               Left            =   11610
               TabIndex        =   407
               Top             =   1035
               Width           =   1695
               VariousPropertyBits=   746588179
               BackColor       =   15781855
               ForeColor       =   -2147483630
               DisplayStyle    =   4
               Size            =   "2990;450"
               Value           =   "0"
               Caption         =   "Excl. from CS"
               FontName        =   "Myriad Web"
               FontHeight      =   165
               FontCharSet     =   0
               FontPitchAndFamily=   2
            End
            Begin VB.Label Label1 
               Alignment       =   1  'Right Justify
               AutoSize        =   -1  'True
               BackColor       =   &H00FFDFC0&
               BackStyle       =   0  'Transparent
               Caption         =   "Transaction ID:"
               Height          =   195
               Index           =   4
               Left            =   9225
               TabIndex        =   365
               Top             =   450
               Visible         =   0   'False
               Width           =   1050
            End
            Begin VB.Label Label1 
               AutoSize        =   -1  'True
               BackColor       =   &H00FFDFC0&
               BackStyle       =   0  'Transparent
               Caption         =   "Unit No.:"
               Height          =   195
               Index           =   2
               Left            =   5730
               TabIndex        =   364
               Top             =   240
               Width           =   600
            End
            Begin VB.Label Label1 
               Alignment       =   1  'Right Justify
               AutoSize        =   -1  'True
               BackColor       =   &H00FFDFC0&
               BackStyle       =   0  'Transparent
               Caption         =   "Lessee:"
               Height          =   195
               Index           =   18
               Left            =   90
               TabIndex        =   363
               Top             =   960
               Width           =   525
            End
            Begin VB.Label Label1 
               AutoSize        =   -1  'True
               BackColor       =   &H00FFDFC0&
               BackStyle       =   0  'Transparent
               Caption         =   "Issue Date:"
               Height          =   195
               Index           =   9
               Left            =   10815
               TabIndex        =   362
               Top             =   240
               Width           =   780
            End
            Begin MSForms.CheckBox chkOldTenats 
               Height          =   255
               Left            =   5025
               TabIndex        =   323
               Top             =   990
               Width           =   1695
               VariousPropertyBits=   746588179
               BackColor       =   15781855
               ForeColor       =   -2147483630
               DisplayStyle    =   4
               Size            =   "2990;450"
               Value           =   "0"
               Caption         =   "Include Ex-Lessees"
               FontName        =   "Myriad Web"
               FontHeight      =   165
               FontCharSet     =   0
               FontPitchAndFamily=   2
            End
            Begin VB.Label Label1 
               AutoSize        =   -1  'True
               BackColor       =   &H00FFDFC0&
               BackStyle       =   0  'Transparent
               Caption         =   "Lease Expires:"
               Height          =   195
               Index           =   10
               Left            =   5730
               TabIndex        =   361
               Top             =   600
               Width           =   1005
            End
            Begin VB.Label Label19 
               AutoSize        =   -1  'True
               BackStyle       =   0  'Transparent
               Caption         =   "Client"
               Height          =   195
               Index           =   2
               Left            =   90
               TabIndex        =   360
               Top             =   240
               Width           =   435
            End
            Begin VB.Label Label19 
               Alignment       =   1  'Right Justify
               AutoSize        =   -1  'True
               BackStyle       =   0  'Transparent
               Caption         =   "Property"
               Height          =   195
               Index           =   3
               Left            =   90
               TabIndex        =   359
               Top             =   615
               Width           =   615
            End
            Begin MSForms.TextBox txtTenantName 
               Height          =   285
               Left            =   885
               TabIndex        =   318
               Top             =   960
               Width           =   3600
               VariousPropertyBits=   679495711
               BackColor       =   16777215
               BorderStyle     =   1
               Size            =   "6350;503"
               SpecialEffect   =   0
               FontName        =   "Myriad Web"
               FontHeight      =   165
               FontCharSet     =   0
               FontPitchAndFamily=   2
            End
            Begin VB.Label Label1 
               AutoSize        =   -1  'True
               BackColor       =   &H00FFDFC0&
               BackStyle       =   0  'Transparent
               Caption         =   "Saving Due Date"
               Height          =   195
               Index           =   17
               Left            =   9135
               TabIndex        =   358
               Top             =   630
               Visible         =   0   'False
               Width           =   1185
            End
            Begin VB.Label Label1 
               AutoSize        =   -1  'True
               BackColor       =   &H00FFDFC0&
               BackStyle       =   0  'Transparent
               Caption         =   "Lease Expired"
               BeginProperty Font 
                  Name            =   "Courier"
                  Size            =   12
                  Charset         =   0
                  Weight          =   700
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H000000FF&
               Height          =   240
               Index           =   0
               Left            =   4830
               TabIndex        =   357
               Top             =   1260
               Visible         =   0   'False
               Width           =   2085
            End
            Begin MSForms.CheckBox chkCL 
               Height          =   255
               Left            =   6885
               TabIndex        =   324
               Top             =   990
               Width           =   1695
               VariousPropertyBits=   746588179
               BackColor       =   15781855
               ForeColor       =   -2147483630
               DisplayStyle    =   4
               Size            =   "2990;450"
               Value           =   "0"
               Caption         =   "Landlord/MA only"
               FontName        =   "Myriad Web"
               FontHeight      =   165
               FontCharSet     =   0
               FontPitchAndFamily=   2
            End
            Begin VB.Label Label1 
               AutoSize        =   -1  'True
               BackColor       =   &H00FFDFC0&
               BackStyle       =   0  'Transparent
               Caption         =   "LeaseID"
               Height          =   195
               Index           =   41
               Left            =   9675
               TabIndex        =   356
               Top             =   135
               Visible         =   0   'False
               Width           =   570
            End
            Begin MSForms.Label lblPostingDate 
               Height          =   285
               Left            =   13305
               TabIndex        =   355
               Top             =   240
               Width           =   225
               ForeColor       =   8421504
               BackColor       =   16761024
               Caption         =   " P"
               Size            =   "397;503"
               FontName        =   "Myriad Web"
               FontEffects     =   1073741825
               FontHeight      =   195
               FontCharSet     =   0
               FontPitchAndFamily=   2
               FontWeight      =   700
            End
            Begin MSForms.TextBox txtDmdClientList 
               Height          =   285
               Left            =   885
               TabIndex        =   354
               Top             =   240
               Width           =   3600
               VariousPropertyBits=   679495711
               BorderStyle     =   1
               Size            =   "6350;503"
               SpecialEffect   =   0
               FontName        =   "Myriad Web"
               FontHeight      =   165
               FontCharSet     =   0
               FontPitchAndFamily=   2
            End
            Begin MSForms.TextBox txtDmdPropertyList 
               Height          =   285
               Left            =   885
               TabIndex        =   316
               Top             =   600
               Width           =   3600
               VariousPropertyBits=   679495707
               BorderStyle     =   1
               Size            =   "6350;503"
               SpecialEffect   =   0
               FontName        =   "Myriad Web"
               FontHeight      =   165
               FontCharSet     =   0
               FontPitchAndFamily=   2
            End
            Begin MSForms.CheckBox chkSO 
               Height          =   300
               Left            =   8775
               TabIndex        =   325
               Top             =   990
               Width           =   1155
               VariousPropertyBits=   746588179
               BackColor       =   15781855
               ForeColor       =   -2147483630
               DisplayStyle    =   4
               Size            =   "2037;529"
               Value           =   "0"
               Caption         =   "Std. Order"
               FontName        =   "Myriad Web"
               FontHeight      =   165
               FontCharSet     =   0
               FontPitchAndFamily=   2
            End
            Begin VB.Label Label1 
               AutoSize        =   -1  'True
               BackColor       =   &H00FFDFC0&
               BackStyle       =   0  'Transparent
               Caption         =   "Freq."
               Height          =   195
               Index           =   26
               Left            =   9915
               TabIndex        =   350
               Top             =   1035
               Width           =   360
            End
            Begin MSForms.TextBox txtFreq 
               Height          =   285
               Left            =   10350
               TabIndex        =   326
               Top             =   1035
               Width           =   855
               VariousPropertyBits=   679495711
               BorderStyle     =   1
               Size            =   "1508;503"
               SpecialEffect   =   0
               FontName        =   "Myriad Web"
               FontHeight      =   165
               FontCharSet     =   0
               FontPitchAndFamily=   2
            End
         End
         Begin VB.Frame FraMiddleAddNewLine 
            Height          =   2130
            Left            =   45
            TabIndex        =   313
            Top             =   2070
            Width           =   13695
            Begin VB.TextBox txtVAT 
               Alignment       =   1  'Right Justify
               Appearance      =   0  'Flat
               Height          =   285
               Left            =   12120
               MaxLength       =   8
               TabIndex        =   344
               Top             =   945
               Width           =   1380
            End
            Begin VB.TextBox txtAddNewDescription 
               Appearance      =   0  'Flat
               Height          =   645
               Left            =   1185
               MaxLength       =   255
               MultiLine       =   -1  'True
               TabIndex        =   334
               Top             =   945
               Width           =   3555
            End
            Begin VB.TextBox txtDateFrom 
               Appearance      =   0  'Flat
               Height          =   285
               Left            =   7020
               TabIndex        =   335
               Top             =   225
               Width           =   1815
            End
            Begin VB.TextBox txtDateTo 
               Appearance      =   0  'Flat
               Height          =   285
               Left            =   7020
               TabIndex        =   336
               Top             =   585
               Width           =   1815
            End
            Begin VB.TextBox txtAmount 
               Alignment       =   1  'Right Justify
               Appearance      =   0  'Flat
               Height          =   285
               Left            =   11805
               MaxLength       =   10
               TabIndex        =   342
               Top             =   585
               Width           =   1695
            End
            Begin VB.TextBox txtChargingAmt 
               Appearance      =   0  'Flat
               Height          =   285
               Left            =   7020
               TabIndex        =   339
               Top             =   1665
               Width           =   1815
            End
            Begin VB.TextBox txtAdiComment 
               Appearance      =   0  'Flat
               ForeColor       =   &H00FF0000&
               Height          =   285
               Left            =   7020
               TabIndex        =   338
               ToolTipText     =   "Double click to type in"
               Top             =   1305
               Width           =   1815
            End
            Begin VB.TextBox txtTotal 
               Alignment       =   1  'Right Justify
               Appearance      =   0  'Flat
               Height          =   285
               Left            =   11805
               Locked          =   -1  'True
               MaxLength       =   10
               TabIndex        =   345
               Top             =   1305
               Width           =   1695
            End
            Begin VB.CommandButton cmdType 
               Caption         =   ".."
               Enabled         =   0   'False
               BeginProperty Font 
                  Name            =   "Myriad Web"
                  Size            =   8.25
                  Charset         =   0
                  Weight          =   700
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               Height          =   300
               Left            =   4455
               TabIndex        =   331
               Top             =   225
               Width           =   300
            End
            Begin VB.CommandButton cmdFund 
               Caption         =   ".."
               Enabled         =   0   'False
               BeginProperty Font 
                  Name            =   "Myriad Web"
                  Size            =   8.25
                  Charset         =   0
                  Weight          =   700
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               Height          =   300
               Left            =   4455
               TabIndex        =   333
               Top             =   585
               Width           =   300
            End
            Begin VB.CommandButton cmdJob 
               Caption         =   ".."
               Enabled         =   0   'False
               BeginProperty Font 
                  Name            =   "Myriad Web"
                  Size            =   8.25
                  Charset         =   0
                  Weight          =   700
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               Height          =   300
               Left            =   13230
               TabIndex        =   341
               Top             =   225
               Width           =   300
            End
            Begin VB.TextBox txtDateDue 
               Appearance      =   0  'Flat
               Height          =   285
               Left            =   7020
               MaxLength       =   10
               TabIndex        =   337
               Top             =   945
               Width           =   1815
            End
            Begin VB.CommandButton cmdVATCode 
               Caption         =   ".."
               Enabled         =   0   'False
               BeginProperty Font 
                  Name            =   "Myriad Web"
                  Size            =   8.25
                  Charset         =   0
                  Weight          =   700
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               Height          =   300
               Left            =   11805
               TabIndex        =   343
               Top             =   945
               Width           =   300
            End
            Begin VB.Label Label1 
               AutoSize        =   -1  'True
               BackColor       =   &H00FFDFC0&
               BackStyle       =   0  'Transparent
               ForeColor       =   &H00000040&
               Height          =   195
               Index           =   24
               Left            =   11520
               TabIndex        =   381
               Top             =   990
               Width           =   210
            End
            Begin VB.Label Label19 
               AutoSize        =   -1  'True
               BackColor       =   &H00FFDFC0&
               BackStyle       =   0  'Transparent
               Caption         =   "Demand Type:"
               Height          =   195
               Index           =   33
               Left            =   90
               TabIndex        =   377
               Top             =   225
               Width           =   990
            End
            Begin VB.Label Label1 
               AutoSize        =   -1  'True
               BackColor       =   &H00FFDFC0&
               BackStyle       =   0  'Transparent
               Caption         =   "Description:"
               Height          =   195
               Index           =   1
               Left            =   90
               TabIndex        =   376
               Top             =   945
               Width           =   870
            End
            Begin VB.Label Label1 
               AutoSize        =   -1  'True
               BackColor       =   &H00FFDFC0&
               BackStyle       =   0  'Transparent
               Caption         =   "To Date:"
               Height          =   195
               Index           =   8
               Left            =   5895
               TabIndex        =   375
               Top             =   585
               Width           =   585
            End
            Begin VB.Label Label1 
               AutoSize        =   -1  'True
               BackColor       =   &H00FFDFC0&
               BackStyle       =   0  'Transparent
               Caption         =   "From Date:"
               Height          =   195
               Index           =   19
               Left            =   5895
               TabIndex        =   374
               Top             =   225
               Width           =   765
            End
            Begin VB.Label Label1 
               AutoSize        =   -1  'True
               BackColor       =   &H00FFDFC0&
               BackStyle       =   0  'Transparent
               Caption         =   "VAT:"
               Height          =   195
               Index           =   21
               Left            =   10965
               TabIndex        =   373
               Top             =   990
               Width           =   330
            End
            Begin VB.Label Label1 
               AutoSize        =   -1  'True
               BackColor       =   &H00FFDFC0&
               BackStyle       =   0  'Transparent
               Caption         =   "Amount:"
               Height          =   195
               Index           =   22
               Left            =   10965
               TabIndex        =   372
               Top             =   600
               Width           =   585
            End
            Begin VB.Label Label1 
               AutoSize        =   -1  'True
               BackColor       =   &H00FFDFC0&
               BackStyle       =   0  'Transparent
               Caption         =   "Total:"
               Height          =   195
               Index           =   23
               Left            =   10965
               TabIndex        =   371
               Top             =   1305
               Width           =   390
            End
            Begin VB.Label Label19 
               AutoSize        =   -1  'True
               BackColor       =   &H00FFDFC0&
               BackStyle       =   0  'Transparent
               Caption         =   "Fund:"
               Height          =   195
               Index           =   34
               Left            =   90
               TabIndex        =   370
               Top             =   585
               Width           =   390
            End
            Begin VB.Label Label1 
               AutoSize        =   -1  'True
               BackColor       =   &H00FFDFC0&
               BackStyle       =   0  'Transparent
               Caption         =   "Apportionment:"
               Height          =   195
               Index           =   38
               Left            =   5895
               TabIndex        =   369
               Top             =   1665
               Width           =   1110
            End
            Begin VB.Label Label1 
               AutoSize        =   -1  'True
               BackColor       =   &H00FFDFC0&
               BackStyle       =   0  'Transparent
               Caption         =   "Comment:"
               Height          =   195
               Index           =   39
               Left            =   5895
               TabIndex        =   368
               Top             =   1305
               Width           =   705
            End
            Begin VB.Label Label12 
               AutoSize        =   -1  'True
               BackStyle       =   0  'Transparent
               Caption         =   "Job No:"
               Height          =   195
               Index           =   1
               Left            =   10965
               TabIndex        =   367
               Top             =   240
               Width           =   510
            End
            Begin MSForms.TextBox txtType 
               Height          =   285
               Left            =   1170
               TabIndex        =   330
               Top             =   225
               Width           =   3285
               VariousPropertyBits=   679495711
               BorderStyle     =   1
               Size            =   "5794;503"
               SpecialEffect   =   0
               FontName        =   "Myriad Web"
               FontHeight      =   165
               FontCharSet     =   0
               FontPitchAndFamily=   2
            End
            Begin MSForms.TextBox txtFund 
               Height          =   285
               Left            =   1170
               TabIndex        =   332
               Top             =   585
               Width           =   3285
               VariousPropertyBits=   679495711
               BorderStyle     =   1
               Size            =   "5794;503"
               SpecialEffect   =   0
               FontName        =   "Myriad Web"
               FontHeight      =   165
               FontCharSet     =   0
               FontPitchAndFamily=   2
            End
            Begin MSForms.TextBox txtJob 
               Height          =   285
               Left            =   11805
               TabIndex        =   340
               Top             =   225
               Width           =   1440
               VariousPropertyBits=   679495711
               BorderStyle     =   1
               Size            =   "2540;503"
               SpecialEffect   =   0
               FontName        =   "Myriad Web"
               FontHeight      =   165
               FontCharSet     =   0
               FontPitchAndFamily=   2
            End
            Begin VB.Label Label1 
               AutoSize        =   -1  'True
               BackColor       =   &H00FFDFC0&
               BackStyle       =   0  'Transparent
               Caption         =   "Due Date:"
               Height          =   195
               Index           =   20
               Left            =   5895
               TabIndex        =   366
               Top             =   945
               Width           =   705
            End
         End
         Begin VB.Frame FraDemandDetails 
            BackColor       =   &H80000016&
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   3960
            Left            =   45
            TabIndex        =   4
            Top             =   4635
            Width           =   13725
            Begin VB.CommandButton cmdDeleteLine 
               Caption         =   "&Delete the Line"
               Height          =   375
               Left            =   645
               TabIndex        =   349
               Top             =   3390
               Width           =   1335
            End
            Begin VB.CommandButton cmdEditLine 
               Caption         =   "&Edit the Line"
               Height          =   375
               Left            =   4860
               TabIndex        =   351
               Top             =   3375
               Width           =   1335
            End
            Begin VB.TextBox txtArray 
               Alignment       =   1  'Right Justify
               Appearance      =   0  'Flat
               BackColor       =   &H00FCF4F5&
               Height          =   285
               Index           =   6
               Left            =   12495
               Locked          =   -1  'True
               TabIndex        =   7
               Top             =   3405
               Width           =   980
            End
            Begin VB.TextBox txtArray 
               Alignment       =   1  'Right Justify
               Appearance      =   0  'Flat
               BackColor       =   &H00FCF4F5&
               Height          =   285
               Index           =   7
               Left            =   11550
               Locked          =   -1  'True
               TabIndex        =   6
               Top             =   3405
               Width           =   960
            End
            Begin VB.TextBox txtArray 
               Alignment       =   1  'Right Justify
               Appearance      =   0  'Flat
               BackColor       =   &H00FCF4F5&
               Height          =   285
               Index           =   8
               Left            =   10500
               Locked          =   -1  'True
               TabIndex        =   5
               Top             =   3405
               Width           =   1020
            End
            Begin MSHierarchicalFlexGridLib.MSHFlexGrid flxAddNewDemands 
               Height          =   2745
               Left            =   90
               TabIndex        =   348
               Top             =   585
               Width           =   13545
               _ExtentX        =   23892
               _ExtentY        =   4842
               _Version        =   393216
               Cols            =   6
               FixedCols       =   0
               BackColorFixed  =   12632256
               BackColorSel    =   12648447
               ForeColorSel    =   -2147483640
               BackColorBkg    =   16777215
               GridColor       =   -2147483638
               GridColorFixed  =   -2147483630
               WordWrap        =   -1  'True
               GridLinesFixed  =   1
               SelectionMode   =   1
               Appearance      =   0
               BandDisplay     =   1
               BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                  Name            =   "Myriad Web"
                  Size            =   8.25
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               _NumberOfBands  =   1
               _Band(0).Cols   =   6
               _Band(0).TextStyleBand=   0
               _Band(0).TextStyleHeader=   0
            End
            Begin VB.Label lblGridCaption 
               BackStyle       =   0  'Transparent
               Caption         =   "Fund Code"
               Height          =   255
               Index           =   4
               Left            =   3015
               TabIndex        =   379
               Top             =   225
               Width           =   1095
            End
            Begin VB.Label lblGridCaption 
               BackStyle       =   0  'Transparent
               Caption         =   "Description"
               Height          =   255
               Index           =   5
               Left            =   4500
               TabIndex        =   311
               Top             =   225
               Width           =   975
            End
            Begin VB.Label lblGridCaption 
               BackStyle       =   0  'Transparent
               Caption         =   "Demand Type"
               Height          =   255
               Index           =   3
               Left            =   1170
               TabIndex        =   310
               Top             =   225
               Width           =   1095
            End
            Begin VB.Label lblGridCaption 
               BackStyle       =   0  'Transparent
               Caption         =   "A/M"
               Height          =   255
               Index           =   2
               Left            =   585
               TabIndex        =   309
               Top             =   225
               Width           =   375
            End
            Begin VB.Label lblGridCaption 
               BackStyle       =   0  'Transparent
               Caption         =   "From Date"
               Height          =   255
               Index           =   6
               Left            =   6645
               TabIndex        =   308
               Top             =   225
               Width           =   975
            End
            Begin VB.Label lblGridCaption 
               BackStyle       =   0  'Transparent
               Caption         =   "To Date"
               Height          =   255
               Index           =   7
               Left            =   7605
               TabIndex        =   307
               Top             =   225
               Width           =   615
            End
            Begin VB.Label lblGridCaption 
               BackStyle       =   0  'Transparent
               Caption         =   "Due Date"
               Height          =   255
               Index           =   8
               Left            =   8475
               TabIndex        =   306
               Top             =   225
               Width           =   735
            End
            Begin VB.Label lblGridCaption 
               BackStyle       =   0  'Transparent
               Caption         =   "Amount"
               Height          =   255
               Index           =   10
               Left            =   10800
               TabIndex        =   305
               Top             =   225
               Width           =   735
            End
            Begin VB.Label lblGridCaption 
               BackStyle       =   0  'Transparent
               Caption         =   "VAT"
               Height          =   255
               Index           =   11
               Left            =   11970
               TabIndex        =   304
               Top             =   225
               Width           =   495
            End
            Begin VB.Label lblGridCaption 
               BackStyle       =   0  'Transparent
               Caption         =   "Total"
               Height          =   255
               Index           =   12
               Left            =   12945
               TabIndex        =   303
               Top             =   225
               Width           =   495
            End
            Begin VB.Label lblGridCaption 
               BackStyle       =   0  'Transparent
               Caption         =   "No"
               Height          =   255
               Index           =   1
               Left            =   225
               TabIndex        =   302
               Top             =   225
               Width           =   375
            End
            Begin VB.Label lblGridCaption 
               BackStyle       =   0  'Transparent
               Caption         =   "Job"
               Height          =   255
               Index           =   9
               Left            =   9630
               TabIndex        =   301
               Top             =   225
               Width           =   615
            End
            Begin VB.Label Label1 
               Alignment       =   1  'Right Justify
               AutoSize        =   -1  'True
               BackColor       =   &H00FFDFC0&
               BackStyle       =   0  'Transparent
               Caption         =   "Sub Total:"
               Height          =   195
               Index           =   3
               Left            =   9735
               TabIndex        =   8
               Top             =   3405
               Width           =   690
            End
            Begin VB.Label lblGridCaption 
               BeginProperty Font 
                  Name            =   "Arial"
                  Size            =   8.25
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               Height          =   285
               Index           =   0
               Left            =   45
               TabIndex        =   312
               Top             =   180
               Width           =   13560
            End
         End
      End
      Begin VB.Frame fraDetails 
         BackColor       =   &H00E0E0E0&
         Caption         =   "Demand Details: "
         BeginProperty Font 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   2250
         Left            =   1320
         TabIndex        =   2
         Top             =   7395
         Width           =   14445
         Begin VB.CommandButton cmdAmendInfo 
            Caption         =   "Amend info"
            Height          =   315
            Left            =   11655
            Style           =   1  'Graphical
            TabIndex        =   416
            Top             =   1890
            Width           =   1080
         End
         Begin VB.TextBox txtRef 
            Appearance      =   0  'Flat
            BackColor       =   &H00DAEADA&
            BorderStyle     =   0  'None
            Height          =   240
            Left            =   11520
            TabIndex        =   415
            Top             =   315
            Visible         =   0   'False
            Width           =   1050
         End
         Begin VB.TextBox txtPostingDate 
            Appearance      =   0  'Flat
            BackColor       =   &H00DAEADA&
            BorderStyle     =   0  'None
            Height          =   240
            Left            =   10260
            TabIndex        =   414
            Top             =   315
            Visible         =   0   'False
            Width           =   1095
         End
         Begin VB.TextBox txtPayDt 
            Appearance      =   0  'Flat
            BackColor       =   &H00DAEADA&
            BorderStyle     =   0  'None
            Height          =   240
            Left            =   9105
            TabIndex        =   413
            Top             =   315
            Visible         =   0   'False
            Width           =   1095
         End
         Begin VB.TextBox txtSDescription 
            Appearance      =   0  'Flat
            BackColor       =   &H00DAEADA&
            BorderStyle     =   0  'None
            Height          =   240
            Left            =   7785
            TabIndex        =   412
            Top             =   315
            Visible         =   0   'False
            Width           =   1095
         End
         Begin VB.TextBox txtArrayEditDemand 
            Alignment       =   1  'Right Justify
            Appearance      =   0  'Flat
            BackColor       =   &H00DAEADA&
            BorderStyle     =   0  'None
            Height          =   240
            Index           =   3
            Left            =   9180
            TabIndex        =   411
            Top             =   630
            Visible         =   0   'False
            Width           =   1050
         End
         Begin VB.TextBox txtArrayEditDemand 
            Alignment       =   1  'Right Justify
            Appearance      =   0  'Flat
            BackColor       =   &H00DAEADA&
            BorderStyle     =   0  'None
            Height          =   240
            Index           =   2
            Left            =   8010
            TabIndex        =   410
            Top             =   630
            Visible         =   0   'False
            Width           =   1095
         End
         Begin VB.TextBox txtArrayEditDemand 
            Alignment       =   1  'Right Justify
            Appearance      =   0  'Flat
            BackColor       =   &H00DAEADA&
            BorderStyle     =   0  'None
            Height          =   240
            Index           =   1
            Left            =   6855
            TabIndex        =   409
            Top             =   630
            Visible         =   0   'False
            Width           =   1095
         End
         Begin VB.TextBox txtArrayEditDemand 
            Appearance      =   0  'Flat
            BackColor       =   &H00DAEADA&
            BorderStyle     =   0  'None
            Height          =   240
            Index           =   0
            Left            =   5715
            TabIndex        =   408
            Top             =   630
            Visible         =   0   'False
            Width           =   1095
         End
         Begin MSHierarchicalFlexGridLib.MSHFlexGrid flxChildDemands 
            Height          =   1650
            Left            =   75
            TabIndex        =   3
            Top             =   210
            Width           =   14295
            _ExtentX        =   25215
            _ExtentY        =   2910
            _Version        =   393216
            BackColorFixed  =   12632256
            BackColorSel    =   15329508
            ForeColorSel    =   -2147483640
            BackColorBkg    =   16777215
            GridColor       =   -2147483638
            GridColorFixed  =   -2147483630
            WordWrap        =   -1  'True
            GridLinesFixed  =   1
            Appearance      =   0
            BandDisplay     =   1
            BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
               Name            =   "Myriad Web"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            _NumberOfBands  =   1
            _Band(0).Cols   =   2
         End
      End
      Begin VB.Frame Frame1 
         BackColor       =   &H00E0E0E0&
         Caption         =   "Details"
         BeginProperty Font 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   1890
         Index           =   0
         Left            =   -74880
         TabIndex        =   13
         Top             =   7155
         Width           =   15000
         Begin MSHierarchicalFlexGridLib.MSHFlexGrid flxChildDemandHistory 
            Height          =   1215
            Left            =   120
            TabIndex        =   14
            Top             =   600
            Width           =   14805
            _ExtentX        =   26114
            _ExtentY        =   2143
            _Version        =   393216
            BackColorFixed  =   12632256
            BackColorSel    =   12648447
            ForeColorSel    =   -2147483640
            BackColorBkg    =   16777215
            GridColor       =   -2147483638
            GridColorFixed  =   -2147483630
            WordWrap        =   -1  'True
            Appearance      =   0
            BandDisplay     =   1
            BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            _NumberOfBands  =   1
            _Band(0).Cols   =   2
         End
         Begin VB.Label Label44 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Total"
            BeginProperty Font 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   195
            Index           =   33
            Left            =   13440
            TabIndex        =   90
            Top             =   360
            Width           =   1080
         End
         Begin VB.Label Label44 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "VAT"
            BeginProperty Font 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   195
            Index           =   32
            Left            =   12360
            TabIndex        =   89
            Top             =   360
            Width           =   1080
         End
         Begin VB.Label Label44 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Amount"
            BeginProperty Font 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   195
            Index           =   31
            Left            =   11280
            TabIndex        =   88
            Top             =   360
            Width           =   1080
         End
         Begin VB.Label Label44 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Due Date"
            BeginProperty Font 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   195
            Index           =   30
            Left            =   10200
            TabIndex        =   87
            Top             =   360
            Width           =   675
         End
         Begin VB.Label Label44 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "To Date"
            BeginProperty Font 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   195
            Index           =   29
            Left            =   9000
            TabIndex        =   86
            Top             =   360
            Width           =   555
         End
         Begin VB.Label Label44 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "From Date"
            BeginProperty Font 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   195
            Index           =   28
            Left            =   7800
            TabIndex        =   85
            Top             =   360
            Width           =   735
         End
         Begin VB.Label Label44 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Description"
            BeginProperty Font 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   195
            Index           =   27
            Left            =   2400
            TabIndex        =   84
            Top             =   360
            Width           =   840
         End
         Begin VB.Label Label44 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "No."
            BeginProperty Font 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   195
            Index           =   25
            Left            =   240
            TabIndex        =   83
            Top             =   360
            Width           =   240
         End
         Begin VB.Label Label44 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "A/M"
            BeginProperty Font 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   195
            Index           =   26
            Left            =   800
            TabIndex        =   82
            Top             =   360
            Width           =   300
         End
      End
      Begin VB.Frame Frame1 
         BackColor       =   &H00E5E5E5&
         BorderStyle     =   0  'None
         Caption         =   "Frame11"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   615
         Index           =   1
         Left            =   -71445
         TabIndex        =   10
         Top             =   9105
         Width           =   11520
         Begin VB.TextBox txtArray 
            Alignment       =   1  'Right Justify
            Appearance      =   0  'Flat
            Height          =   285
            Index           =   9
            Left            =   8145
            MaxLength       =   80
            TabIndex        =   258
            Top             =   180
            Width           =   885
         End
         Begin VB.CommandButton cmdDemandList 
            Caption         =   "Print Demand History"
            Height          =   375
            Index           =   1
            Left            =   4020
            Style           =   1  'Graphical
            TabIndex        =   178
            Top             =   120
            Width           =   1680
         End
         Begin VB.CommandButton cmdDmdHist_PrtSt 
            Caption         =   "Print Statements"
            BeginProperty Font 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   375
            Left            =   5775
            Style           =   1  'Graphical
            TabIndex        =   170
            Top             =   120
            Visible         =   0   'False
            Width           =   1620
         End
         Begin VB.CommandButton cmdDmdHist_PrtSel 
            Caption         =   "Print Selected"
            BeginProperty Font 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   375
            Left            =   2505
            Style           =   1  'Graphical
            TabIndex        =   11
            Top             =   120
            Width           =   1455
         End
         Begin VB.Label Label4 
            BackColor       =   &H00E5E5E5&
            Caption         =   "Display : "
            Height          =   195
            Left            =   7470
            TabIndex        =   259
            Top             =   225
            Width           =   690
         End
      End
      Begin VB.Frame Frame7 
         BackColor       =   &H80000013&
         BorderStyle     =   0  'None
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   6165
         Left            =   -74880
         TabIndex        =   9
         Top             =   885
         Width           =   14985
         Begin MSHierarchicalFlexGridLib.MSHFlexGrid flxDemandHistory 
            Bindings        =   "frmDemand.frx":09AA
            Height          =   5850
            Left            =   90
            TabIndex        =   12
            Top             =   240
            Width           =   14835
            _ExtentX        =   26167
            _ExtentY        =   10319
            _Version        =   393216
            BackColorFixed  =   14476516
            BackColorSel    =   12648447
            ForeColorSel    =   -2147483640
            BackColorBkg    =   16777215
            GridColor       =   -2147483638
            GridColorFixed  =   -2147483630
            WordWrap        =   -1  'True
            Appearance      =   0
            BandDisplay     =   1
            BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            _NumberOfBands  =   1
            _Band(0).Cols   =   2
         End
         Begin VB.Label Label44 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Outstanding"
            ForeColor       =   &H00FF0000&
            Height          =   195
            Index           =   37
            Left            =   11520
            TabIndex        =   208
            Top             =   0
            Width           =   885
         End
         Begin VB.Label Label44 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Email"
            BeginProperty Font 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   210
            Index           =   35
            Left            =   13725
            TabIndex        =   207
            Top             =   0
            Width           =   360
         End
         Begin VB.Label Label44 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "I/C"
            BeginProperty Font 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   195
            Index           =   19
            Left            =   120
            TabIndex        =   81
            Top             =   0
            Visible         =   0   'False
            Width           =   210
         End
         Begin VB.Label Label44 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Lessee Name"
            BeginProperty Font 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   210
            Index           =   20
            Left            =   1320
            TabIndex        =   80
            Top             =   0
            Width           =   990
         End
         Begin VB.Label Label44 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Unit No"
            BeginProperty Font 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   195
            Index           =   21
            Left            =   6945
            TabIndex        =   79
            Top             =   0
            Width           =   540
         End
         Begin VB.Label Label44 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Issue Date"
            BeginProperty Font 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   195
            Index           =   22
            Left            =   8520
            TabIndex        =   78
            Top             =   0
            Width           =   750
         End
         Begin VB.Label Label44 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Total"
            BeginProperty Font 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   195
            Index           =   23
            Left            =   10080
            TabIndex        =   77
            Top             =   0
            Width           =   360
         End
         Begin VB.Label Label44 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Printed"
            BeginProperty Font 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   195
            Index           =   24
            Left            =   12720
            TabIndex        =   76
            Top             =   0
            Width           =   525
         End
         Begin VB.Label Label44 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Demand No."
            BeginProperty Font 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   210
            Index           =   18
            Left            =   360
            TabIndex        =   75
            Top             =   0
            Width           =   870
         End
         Begin VB.Label Label1 
            AutoSize        =   -1  'True
            BackColor       =   &H80000003&
            BackStyle       =   0  'Transparent
            BeginProperty Font 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H00FF00FF&
            Height          =   195
            Index           =   40
            Left            =   12600
            TabIndex        =   15
            Top             =   0
            Visible         =   0   'False
            Width           =   390
         End
      End
      Begin TabDlg.SSTab tabPayment 
         Height          =   9405
         Left            =   -75000
         TabIndex        =   91
         Top             =   405
         Width           =   16125
         _ExtentX        =   28443
         _ExtentY        =   16589
         _Version        =   393216
         Style           =   1
         Tabs            =   2
         TabsPerRow      =   2
         TabHeight       =   520
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Myriad Web"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         TabCaption(0)   =   "Lessee Receipt"
         TabPicture(0)   =   "frmDemand.frx":09C0
         Tab(0).ControlEnabled=   -1  'True
         Tab(0).Control(0)=   "Line1(0)"
         Tab(0).Control(0).Enabled=   0   'False
         Tab(0).Control(1)=   "Line1(3)"
         Tab(0).Control(1).Enabled=   0   'False
         Tab(0).Control(2)=   "Label19(20)"
         Tab(0).Control(2).Enabled=   0   'False
         Tab(0).Control(3)=   "Label19(21)"
         Tab(0).Control(3).Enabled=   0   'False
         Tab(0).Control(4)=   "Label19(22)"
         Tab(0).Control(4).Enabled=   0   'False
         Tab(0).Control(5)=   "Label19(23)"
         Tab(0).Control(5).Enabled=   0   'False
         Tab(0).Control(6)=   "Label19(24)"
         Tab(0).Control(6).Enabled=   0   'False
         Tab(0).Control(7)=   "Label19(25)"
         Tab(0).Control(7).Enabled=   0   'False
         Tab(0).Control(8)=   "Label19(26)"
         Tab(0).Control(8).Enabled=   0   'False
         Tab(0).Control(9)=   "Label19(27)"
         Tab(0).Control(9).Enabled=   0   'False
         Tab(0).Control(10)=   "Label19(28)"
         Tab(0).Control(10).Enabled=   0   'False
         Tab(0).Control(11)=   "Label19(29)"
         Tab(0).Control(11).Enabled=   0   'False
         Tab(0).Control(12)=   "Label19(19)"
         Tab(0).Control(12).Enabled=   0   'False
         Tab(0).Control(13)=   "Label19(18)"
         Tab(0).Control(13).Enabled=   0   'False
         Tab(0).Control(14)=   "Label19(17)"
         Tab(0).Control(14).Enabled=   0   'False
         Tab(0).Control(15)=   "Label19(16)"
         Tab(0).Control(15).Enabled=   0   'False
         Tab(0).Control(16)=   "Label19(15)"
         Tab(0).Control(16).Enabled=   0   'False
         Tab(0).Control(17)=   "Label19(14)"
         Tab(0).Control(17).Enabled=   0   'False
         Tab(0).Control(18)=   "Label19(13)"
         Tab(0).Control(18).Enabled=   0   'False
         Tab(0).Control(19)=   "Label19(11)"
         Tab(0).Control(19).Enabled=   0   'False
         Tab(0).Control(20)=   "Label19(10)"
         Tab(0).Control(20).Enabled=   0   'False
         Tab(0).Control(21)=   "Label10(4)"
         Tab(0).Control(21).Enabled=   0   'False
         Tab(0).Control(22)=   "Label10(3)"
         Tab(0).Control(22).Enabled=   0   'False
         Tab(0).Control(23)=   "lblAllocating"
         Tab(0).Control(23).Enabled=   0   'False
         Tab(0).Control(24)=   "Label3(1)"
         Tab(0).Control(24).Enabled=   0   'False
         Tab(0).Control(25)=   "Label10(1)"
         Tab(0).Control(25).Enabled=   0   'False
         Tab(0).Control(26)=   "Line1(2)"
         Tab(0).Control(26).Enabled=   0   'False
         Tab(0).Control(27)=   "Label10(0)"
         Tab(0).Control(27).Enabled=   0   'False
         Tab(0).Control(28)=   "Label3(2)"
         Tab(0).Control(28).Enabled=   0   'False
         Tab(0).Control(29)=   "Label3(4)"
         Tab(0).Control(29).Enabled=   0   'False
         Tab(0).Control(30)=   "Label3(5)"
         Tab(0).Control(30).Enabled=   0   'False
         Tab(0).Control(31)=   "Line2"
         Tab(0).Control(31).Enabled=   0   'False
         Tab(0).Control(32)=   "flxCrPoA"
         Tab(0).Control(32).Enabled=   0   'False
         Tab(0).Control(33)=   "flxSPayment"
         Tab(0).Control(33).Enabled=   0   'False
         Tab(0).Control(34)=   "txtArray(4)"
         Tab(0).Control(34).Enabled=   0   'False
         Tab(0).Control(35)=   "Frame5(4)"
         Tab(0).Control(35).Enabled=   0   'False
         Tab(0).Control(36)=   "txtCrPayment"
         Tab(0).Control(36).Enabled=   0   'False
         Tab(0).Control(37)=   "txtSPayment"
         Tab(0).Control(37).Enabled=   0   'False
         Tab(0).Control(38)=   "Frame5(5)"
         Tab(0).Control(38).Enabled=   0   'False
         Tab(0).Control(39)=   "cmdAllocate"
         Tab(0).Control(39).Enabled=   0   'False
         Tab(0).Control(40)=   "cmdSPClose"
         Tab(0).Control(40).Enabled=   0   'False
         Tab(0).Control(41)=   "Frame5(0)"
         Tab(0).Control(41).Enabled=   0   'False
         Tab(0).Control(42)=   "cmeRevereseAllocation"
         Tab(0).Control(42).Enabled=   0   'False
         Tab(0).Control(43)=   "cmdAdvanceProgr"
         Tab(0).Control(43).Enabled=   0   'False
         Tab(0).Control(44)=   "txtArray(3)"
         Tab(0).Control(44).Enabled=   0   'False
         Tab(0).Control(45)=   "txtArray(5)"
         Tab(0).Control(45).Enabled=   0   'False
         Tab(0).ControlCount=   46
         TabCaption(1)   =   "Lessee Receipt &History"
         TabPicture(1)   =   "frmDemand.frx":09DC
         Tab(1).ControlEnabled=   0   'False
         Tab(1).Control(0)=   "Shape1(0)"
         Tab(1).Control(1)=   "Shape4(20)"
         Tab(1).Control(2)=   "cmbRptHistory"
         Tab(1).Control(3)=   "Label1(35)"
         Tab(1).Control(4)=   "Label1(14)"
         Tab(1).Control(5)=   "Label1(25)"
         Tab(1).Control(6)=   "Label1(28)"
         Tab(1).Control(7)=   "Label1(29)"
         Tab(1).Control(8)=   "Label1(30)"
         Tab(1).Control(9)=   "Label1(31)"
         Tab(1).Control(10)=   "Label1(32)"
         Tab(1).Control(11)=   "Label1(33)"
         Tab(1).Control(12)=   "Label1(34)"
         Tab(1).Control(13)=   "Label1(37)"
         Tab(1).Control(14)=   "cboRptBankList1"
         Tab(1).Control(15)=   "Label1(15)"
         Tab(1).Control(16)=   "Label1(27)"
         Tab(1).Control(17)=   "txtTenantID1"
         Tab(1).Control(18)=   "txtRptClientList1"
         Tab(1).Control(19)=   "txtRptPropertyList1"
         Tab(1).Control(20)=   "Label1(12)"
         Tab(1).Control(21)=   "Label1(13)"
         Tab(1).Control(22)=   "Label1(16)"
         Tab(1).Control(23)=   "Label1(36)"
         Tab(1).Control(24)=   "Label1(42)"
         Tab(1).Control(25)=   "Label1(43)"
         Tab(1).Control(26)=   "Label1(44)"
         Tab(1).Control(27)=   "Label1(45)"
         Tab(1).Control(28)=   "Label1(46)"
         Tab(1).Control(29)=   "Label1(47)"
         Tab(1).Control(30)=   "Label1(48)"
         Tab(1).Control(31)=   "Label1(49)"
         Tab(1).Control(32)=   "Label1(50)"
         Tab(1).Control(33)=   "Label1(51)"
         Tab(1).Control(34)=   "Label3(3)"
         Tab(1).Control(35)=   "Label1(52)"
         Tab(1).Control(36)=   "flxAllocation"
         Tab(1).Control(37)=   "flxReceiptHistory"
         Tab(1).Control(38)=   "cmdPrintReceipt"
         Tab(1).Control(39)=   "cmdRptClientList1"
         Tab(1).Control(40)=   "cmdRptPropertyList1"
         Tab(1).Control(41)=   "cmdSearchLesseReceipthistory"
         Tab(1).Control(42)=   "txtArray(2)"
         Tab(1).Control(43)=   "cmdReceiptTenantLookup"
         Tab(1).Control(44)=   "Command1"
         Tab(1).Control(45)=   "txtArray(1)"
         Tab(1).Control(46)=   "txtArray(0)"
         Tab(1).ControlCount=   47
         Begin VB.TextBox txtArray 
            Alignment       =   1  'Right Justify
            Appearance      =   0  'Flat
            BeginProperty Font 
               Name            =   "Myriad Web"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H00000000&
            Height          =   285
            Index           =   5
            Left            =   11565
            Locked          =   -1  'True
            TabIndex        =   405
            Text            =   "0.00"
            Top             =   4770
            Width           =   1200
         End
         Begin VB.TextBox txtArray 
            Alignment       =   1  'Right Justify
            Appearance      =   0  'Flat
            BeginProperty Font 
               Name            =   "Myriad Web"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H00000000&
            Height          =   285
            Index           =   3
            Left            =   11610
            Locked          =   -1  'True
            TabIndex        =   402
            Text            =   "0.00"
            Top             =   8055
            Width           =   1200
         End
         Begin VB.TextBox txtArray 
            Alignment       =   1  'Right Justify
            Appearance      =   0  'Flat
            Height          =   285
            Index           =   0
            Left            =   -61815
            MaxLength       =   80
            TabIndex        =   400
            Top             =   8955
            Width           =   1200
         End
         Begin VB.CommandButton cmdAdvanceProgr 
            Caption         =   "Advance"
            BeginProperty Font 
               Name            =   "Myriad Web"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   355
            Left            =   11700
            Style           =   1  'Graphical
            TabIndex        =   386
            Top             =   8775
            Visible         =   0   'False
            Width           =   1700
         End
         Begin VB.TextBox txtArray 
            Alignment       =   1  'Right Justify
            Appearance      =   0  'Flat
            Height          =   285
            Index           =   1
            Left            =   -63165
            MaxLength       =   80
            TabIndex        =   385
            Top             =   8955
            Width           =   1200
         End
         Begin VB.CommandButton Command1 
            Caption         =   "Receipt Allocation"
            Height          =   465
            Left            =   -68340
            TabIndex        =   382
            Top             =   8820
            Width           =   2535
         End
         Begin VB.CommandButton cmdReceiptTenantLookup 
            Caption         =   ".."
            BeginProperty Font 
               Name            =   "Myriad Web"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   300
            Left            =   -64920
            TabIndex        =   261
            Top             =   495
            Width           =   300
         End
         Begin VB.TextBox txtArray 
            Alignment       =   1  'Right Justify
            Appearance      =   0  'Flat
            Height          =   285
            Index           =   2
            Left            =   -64875
            MaxLength       =   80
            TabIndex        =   260
            Top             =   8820
            Width           =   885
         End
         Begin VB.CommandButton cmdSearchLesseReceipthistory 
            Caption         =   "Sea&rch"
            Height          =   375
            Left            =   -70275
            Style           =   1  'Graphical
            TabIndex        =   257
            Top             =   8820
            Width           =   1215
         End
         Begin VB.CommandButton cmdRptPropertyList1 
            Caption         =   ".."
            BeginProperty Font 
               Name            =   "Myriad Web"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   300
            Left            =   -69195
            TabIndex        =   184
            Top             =   495
            Width           =   300
         End
         Begin VB.CommandButton cmdRptClientList1 
            Caption         =   ".."
            BeginProperty Font 
               Name            =   "Myriad Web"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   300
            Left            =   -72255
            TabIndex        =   183
            Top             =   495
            Width           =   300
         End
         Begin VB.CommandButton cmdPrintReceipt 
            Caption         =   "Print Receipt"
            Height          =   385
            Left            =   -74775
            Style           =   1  'Graphical
            TabIndex        =   187
            Top             =   8820
            Width           =   1515
         End
         Begin VB.CommandButton cmeRevereseAllocation 
            Caption         =   "&Reverse Allocation"
            BeginProperty Font 
               Name            =   "Myriad Web"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   400
            Left            =   7905
            Style           =   1  'Graphical
            TabIndex        =   167
            Top             =   8745
            Width           =   1700
         End
         Begin VB.Frame Frame5 
            BackColor       =   &H00D5D5D5&
            Caption         =   "Receipts:"
            Enabled         =   0   'False
            ForeColor       =   &H00C00000&
            Height          =   705
            Index           =   0
            Left            =   120
            TabIndex        =   139
            Top             =   8475
            Width           =   5415
            Begin VB.CommandButton cmdEditReceipt 
               Caption         =   "Edit"
               Enabled         =   0   'False
               Height          =   400
               Left            =   3270
               Style           =   1  'Graphical
               TabIndex        =   122
               Top             =   210
               Width           =   960
            End
            Begin VB.CommandButton cmdSPFull 
               Caption         =   "Pay in &Full"
               Height          =   400
               Left            =   1170
               Style           =   1  'Graphical
               TabIndex        =   120
               Top             =   210
               Width           =   960
            End
            Begin VB.CommandButton cmdSPayAll 
               Caption         =   "Pay &All"
               Height          =   400
               Left            =   2220
               Style           =   1  'Graphical
               TabIndex        =   121
               Top             =   210
               Width           =   960
            End
            Begin VB.CommandButton cmdSPSave 
               Caption         =   "&Save"
               Enabled         =   0   'False
               Height          =   400
               Left            =   120
               Style           =   1  'Graphical
               TabIndex        =   119
               Top             =   210
               Width           =   960
            End
            Begin VB.CommandButton cmdReceiptDiscard 
               Caption         =   "Clear"
               Height          =   400
               Left            =   4320
               Style           =   1  'Graphical
               TabIndex        =   123
               Top             =   210
               Width           =   960
            End
         End
         Begin VB.CommandButton cmdSPClose 
            Caption         =   "C&lose"
            BeginProperty Font 
               Name            =   "Myriad Web"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   400
            Left            =   13485
            Style           =   1  'Graphical
            TabIndex        =   124
            Top             =   8745
            Width           =   1400
         End
         Begin VB.CommandButton cmdAllocate 
            Caption         =   "All&ocation Only"
            BeginProperty Font 
               Name            =   "Myriad Web"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   400
            Left            =   9900
            Style           =   1  'Graphical
            TabIndex        =   138
            Top             =   8745
            Width           =   1575
         End
         Begin VB.Frame Frame5 
            Appearance      =   0  'Flat
            BackColor       =   &H00E0E0E0&
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H80000008&
            Height          =   1725
            Index           =   5
            Left            =   120
            TabIndex        =   99
            Top             =   330
            Width           =   15900
            Begin VB.Frame Frame8 
               BackColor       =   &H00DEDEDE&
               Caption         =   "Bank Balance:"
               BeginProperty Font 
                  Name            =   "Myriad Web"
                  Size            =   8.25
                  Charset         =   0
                  Weight          =   700
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00004040&
               Height          =   1545
               Index           =   0
               Left            =   13275
               TabIndex        =   418
               Top             =   135
               Width           =   2580
               Begin VB.TextBox txtArray 
                  Alignment       =   1  'Right Justify
                  Appearance      =   0  'Flat
                  BackColor       =   &H80000014&
                  ForeColor       =   &H00808080&
                  Height          =   285
                  Index           =   10
                  Left            =   1320
                  Locked          =   -1  'True
                  TabIndex        =   421
                  Text            =   "0.00"
                  Top             =   195
                  Width           =   1125
               End
               Begin VB.TextBox txtArray 
                  Alignment       =   1  'Right Justify
                  Appearance      =   0  'Flat
                  BackColor       =   &H80000014&
                  ForeColor       =   &H00808080&
                  Height          =   285
                  Index           =   11
                  Left            =   1320
                  Locked          =   -1  'True
                  TabIndex        =   420
                  Text            =   "0.00"
                  Top             =   525
                  Width           =   1125
               End
               Begin VB.TextBox txtArray 
                  Alignment       =   1  'Right Justify
                  Appearance      =   0  'Flat
                  BackColor       =   &H80000014&
                  ForeColor       =   &H00808080&
                  Height          =   285
                  Index           =   12
                  Left            =   1320
                  Locked          =   -1  'True
                  TabIndex        =   419
                  Text            =   "0.00"
                  Top             =   855
                  Width           =   1125
               End
               Begin VB.Label Label21 
                  AutoSize        =   -1  'True
                  BackStyle       =   0  'Transparent
                  Caption         =   "Bank Balance  "
                  Height          =   195
                  Index           =   0
                  Left            =   120
                  TabIndex        =   424
                  Top             =   195
                  Width           =   1050
               End
               Begin VB.Label Label21 
                  AutoSize        =   -1  'True
                  BackStyle       =   0  'Transparent
                  Caption         =   "Retentions  "
                  Height          =   195
                  Index           =   1
                  Left            =   120
                  TabIndex        =   423
                  Top             =   525
                  Width           =   930
               End
               Begin VB.Label Label21 
                  AutoSize        =   -1  'True
                  BackStyle       =   0  'Transparent
                  Caption         =   "Avail.Bank Bal"
                  Height          =   195
                  Index           =   2
                  Left            =   120
                  TabIndex        =   422
                  Top             =   855
                  Width           =   1050
               End
            End
            Begin VB.TextBox txtAllocationDAte 
               Appearance      =   0  'Flat
               BackColor       =   &H80000014&
               ForeColor       =   &H00FF0000&
               Height          =   285
               Left            =   9360
               MaxLength       =   10
               TabIndex        =   115
               Top             =   1215
               Width           =   985
            End
            Begin VB.CommandButton cmdRptClientList 
               Caption         =   ". ."
               BeginProperty Font 
                  Name            =   "Myriad Web"
                  Size            =   8.25
                  Charset         =   0
                  Weight          =   700
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               Height          =   300
               Left            =   4110
               TabIndex        =   101
               Top             =   225
               Width           =   345
            End
            Begin VB.CommandButton cmdRptPropertyList 
               Caption         =   ". ."
               BeginProperty Font 
                  Name            =   "Myriad Web"
                  Size            =   8.25
                  Charset         =   0
                  Weight          =   700
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               Height          =   300
               Left            =   4110
               TabIndex        =   103
               Top             =   555
               Width           =   345
            End
            Begin VB.TextBox txtTntAcBal 
               Alignment       =   1  'Right Justify
               Appearance      =   0  'Flat
               BackColor       =   &H80000014&
               Height          =   315
               Left            =   9360
               Locked          =   -1  'True
               TabIndex        =   171
               Text            =   "0.00"
               Top             =   180
               Width           =   1125
            End
            Begin VB.Frame Frame9 
               BackColor       =   &H00DEDEDE&
               Caption         =   "Analysis:"
               BeginProperty Font 
                  Name            =   "Myriad Web"
                  Size            =   8.25
                  Charset         =   0
                  Weight          =   700
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00000000&
               Height          =   1545
               Left            =   10635
               TabIndex        =   116
               Top             =   135
               Width           =   2625
               Begin VB.TextBox txtDifference 
                  Alignment       =   1  'Right Justify
                  Appearance      =   0  'Flat
                  BackColor       =   &H80000014&
                  BeginProperty Font 
                     Name            =   "Myriad Web"
                     Size            =   8.25
                     Charset         =   0
                     Weight          =   700
                     Underline       =   0   'False
                     Italic          =   0   'False
                     Strikethrough   =   0   'False
                  EndProperty
                  ForeColor       =   &H00808080&
                  Height          =   285
                  Left            =   1540
                  Locked          =   -1  'True
                  TabIndex        =   127
                  Text            =   "0.00"
                  Top             =   975
                  Width           =   900
               End
               Begin VB.TextBox txtReceiptEntered 
                  Alignment       =   1  'Right Justify
                  Appearance      =   0  'Flat
                  BackColor       =   &H80000014&
                  BeginProperty Font 
                     Name            =   "Myriad Web"
                     Size            =   8.25
                     Charset         =   0
                     Weight          =   700
                     Underline       =   0   'False
                     Italic          =   0   'False
                     Strikethrough   =   0   'False
                  EndProperty
                  ForeColor       =   &H00808080&
                  Height          =   285
                  Left            =   1540
                  Locked          =   -1  'True
                  TabIndex        =   126
                  Text            =   "0.00"
                  Top             =   587
                  Width           =   900
               End
               Begin VB.TextBox txtReceiptTotal 
                  Alignment       =   1  'Right Justify
                  Appearance      =   0  'Flat
                  BackColor       =   &H80000014&
                  BeginProperty Font 
                     Name            =   "Myriad Web"
                     Size            =   8.25
                     Charset         =   0
                     Weight          =   700
                     Underline       =   0   'False
                     Italic          =   0   'False
                     Strikethrough   =   0   'False
                  EndProperty
                  ForeColor       =   &H00808080&
                  Height          =   285
                  Left            =   1545
                  Locked          =   -1  'True
                  TabIndex        =   125
                  Text            =   "0.00"
                  Top             =   200
                  Width           =   900
               End
               Begin VB.Label Label19 
                  AutoSize        =   -1  'True
                  BackStyle       =   0  'Transparent
                  Caption         =   "Difference                  "
                  Height          =   195
                  Index           =   36
                  Left            =   120
                  TabIndex        =   130
                  Top             =   975
                  Width           =   1380
               End
               Begin VB.Label Label19 
                  AutoSize        =   -1  'True
                  BackStyle       =   0  'Transparent
                  Caption         =   "Receipt Entered    "
                  Height          =   195
                  Index           =   37
                  Left            =   120
                  TabIndex        =   129
                  Top             =   585
                  Width           =   1350
               End
               Begin VB.Label Label19 
                  AutoSize        =   -1  'True
                  BackStyle       =   0  'Transparent
                  Caption         =   "Receipt total            "
                  Height          =   195
                  Index           =   38
                  Left            =   120
                  TabIndex        =   128
                  Top             =   195
                  Width           =   1350
               End
            End
            Begin VB.TextBox txtReceiptReference 
               Appearance      =   0  'Flat
               BackColor       =   &H80000014&
               ForeColor       =   &H00FF0000&
               Height          =   315
               Left            =   5760
               MaxLength       =   20
               TabIndex        =   109
               Top             =   225
               Width           =   1860
            End
            Begin VB.TextBox txtSPaymentTotal 
               Alignment       =   1  'Right Justify
               Appearance      =   0  'Flat
               BackColor       =   &H80000014&
               Height          =   315
               Left            =   9360
               TabIndex        =   113
               Text            =   "0.00"
               Top             =   540
               Width           =   1125
            End
            Begin VB.TextBox txtSPDate 
               Appearance      =   0  'Flat
               BackColor       =   &H80000014&
               ForeColor       =   &H00FF0000&
               Height          =   285
               Left            =   9360
               MaxLength       =   10
               TabIndex        =   114
               Top             =   885
               Width           =   985
            End
            Begin VB.Label Label19 
               AutoSize        =   -1  'True
               BackStyle       =   0  'Transparent
               Caption         =   "Allocation Date"
               Height          =   195
               Index           =   8
               Left            =   8010
               TabIndex        =   417
               Top             =   1215
               Width           =   1095
            End
            Begin MSForms.CheckBox chkApplyFund 
               Height          =   300
               Left            =   4680
               TabIndex        =   168
               Top             =   945
               Width           =   1815
               VariousPropertyBits=   746588179
               BackColor       =   14013909
               ForeColor       =   -2147483630
               DisplayStyle    =   4
               Size            =   "3201;529"
               Value           =   "0"
               Caption         =   "Apply Fund Bank A/C"
               FontName        =   "Myriad Web"
               FontHeight      =   165
               FontCharSet     =   0
               FontPitchAndFamily=   2
            End
            Begin MSForms.CommandButton cmdAmountType 
               Height          =   285
               Left            =   6930
               TabIndex        =   111
               Top             =   585
               Width           =   345
               Caption         =   "; ;"
               Size            =   "609;512"
               FontName        =   "Myriad Web"
               FontEffects     =   1073741825
               FontHeight      =   165
               FontCharSet     =   0
               FontPitchAndFamily=   2
               ParagraphAlign  =   3
               FontWeight      =   700
            End
            Begin MSForms.TextBox txtBankCode 
               Height          =   285
               Left            =   765
               TabIndex        =   106
               Top             =   1260
               Width           =   990
               VariousPropertyBits=   679495711
               BorderStyle     =   1
               Size            =   "1746;503"
               SpecialEffect   =   0
               FontName        =   "Myriad Web"
               FontHeight      =   165
               FontCharSet     =   0
               FontPitchAndFamily=   2
            End
            Begin MSForms.CommandButton cmdBankAc 
               Height          =   285
               Left            =   4110
               TabIndex        =   108
               Top             =   1260
               Width           =   345
               Caption         =   "; ;"
               Size            =   "609;503"
               FontName        =   "Myriad Web"
               FontEffects     =   1073741825
               FontHeight      =   165
               FontCharSet     =   0
               FontPitchAndFamily=   2
               ParagraphAlign  =   3
               FontWeight      =   700
            End
            Begin MSForms.CommandButton cmdSetAmtType 
               Height          =   285
               Left            =   7290
               TabIndex        =   112
               Top             =   585
               Width           =   345
               Caption         =   "; ;"
               Size            =   "609;503"
               FontName        =   "Myriad Web"
               FontEffects     =   1073741825
               FontHeight      =   165
               FontCharSet     =   0
               FontPitchAndFamily=   2
               ParagraphAlign  =   3
               FontWeight      =   700
            End
            Begin MSForms.CommandButton cmdTenantLookup 
               Height          =   285
               Left            =   4110
               TabIndex        =   105
               Top             =   915
               Width           =   345
               Caption         =   "; ;"
               Size            =   "609;503"
               FontName        =   "Myriad Web"
               FontEffects     =   1073741825
               FontHeight      =   165
               FontCharSet     =   0
               FontPitchAndFamily=   2
               ParagraphAlign  =   3
               FontWeight      =   700
            End
            Begin MSForms.TextBox txtRptPropertyList 
               Height          =   285
               Left            =   780
               TabIndex        =   102
               Top             =   570
               Width           =   3645
               VariousPropertyBits=   679495711
               BorderStyle     =   1
               Size            =   "6429;503"
               SpecialEffect   =   0
               FontName        =   "Myriad Web"
               FontHeight      =   165
               FontCharSet     =   0
               FontPitchAndFamily=   2
            End
            Begin MSForms.TextBox txtRptClientList 
               Height          =   285
               Left            =   780
               TabIndex        =   100
               Top             =   225
               Width           =   3645
               VariousPropertyBits=   679495711
               BorderStyle     =   1
               Size            =   "6429;503"
               SpecialEffect   =   0
               FontName        =   "Myriad Web"
               FontHeight      =   165
               FontCharSet     =   0
               FontPitchAndFamily=   2
            End
            Begin MSForms.Label lblRptPostingDate 
               Height          =   285
               Left            =   10350
               TabIndex        =   209
               Top             =   885
               Width           =   225
               ForeColor       =   8421504
               BackColor       =   16761024
               Caption         =   " P"
               Size            =   "397;503"
               FontName        =   "Myriad Web"
               FontEffects     =   1073741825
               FontHeight      =   195
               FontCharSet     =   0
               FontPitchAndFamily=   2
               FontWeight      =   700
            End
            Begin VB.Label Label19 
               Alignment       =   1  'Right Justify
               AutoSize        =   -1  'True
               BackStyle       =   0  'Transparent
               Caption         =   "Property"
               Height          =   195
               Index           =   1
               Left            =   30
               TabIndex        =   204
               Top             =   540
               Width           =   615
            End
            Begin MSForms.CheckBox chkLl 
               Height          =   300
               Left            =   4680
               TabIndex        =   203
               Top             =   1305
               Width           =   1455
               VariousPropertyBits=   746588179
               BackColor       =   14013909
               ForeColor       =   -2147483630
               DisplayStyle    =   4
               Size            =   "2566;529"
               Value           =   "0"
               Caption         =   "Landlord/Agent"
               FontName        =   "Myriad Web"
               FontHeight      =   165
               FontCharSet     =   0
               FontPitchAndFamily=   2
            End
            Begin VB.Label Label19 
               AutoSize        =   -1  'True
               BackStyle       =   0  'Transparent
               Caption         =   "Balance:"
               Height          =   195
               Index           =   4
               Left            =   8040
               TabIndex        =   172
               Top             =   225
               Width           =   570
            End
            Begin MSForms.CheckBox chkExlessee 
               Height          =   300
               Left            =   6555
               TabIndex        =   169
               Top             =   960
               Width           =   1455
               VariousPropertyBits=   746588179
               BackColor       =   14013909
               ForeColor       =   -2147483630
               DisplayStyle    =   4
               Size            =   "2566;529"
               Value           =   "0"
               Caption         =   "Inc. Ex-lessee"
               FontName        =   "Myriad Web"
               FontHeight      =   165
               FontCharSet     =   0
               FontPitchAndFamily=   2
            End
            Begin VB.Label Label1 
               AutoSize        =   -1  'True
               BackStyle       =   0  'Transparent
               Caption         =   "Receipt Type"
               Height          =   195
               Index           =   11
               Left            =   4755
               TabIndex        =   137
               Top             =   585
               Width           =   915
            End
            Begin VB.Label Label19 
               AutoSize        =   -1  'True
               BackStyle       =   0  'Transparent
               Caption         =   "Client"
               Height          =   195
               Index           =   0
               Left            =   30
               TabIndex        =   136
               Top             =   180
               Width           =   435
            End
            Begin VB.Label Label19 
               AutoSize        =   -1  'True
               BackStyle       =   0  'Transparent
               Caption         =   "Reference"
               Height          =   195
               Index           =   9
               Left            =   4755
               TabIndex        =   135
               Top             =   225
               Width           =   720
            End
            Begin VB.Label Label19 
               AutoSize        =   -1  'True
               BackStyle       =   0  'Transparent
               Caption         =   "Receipt Date"
               Height          =   195
               Index           =   7
               Left            =   8040
               TabIndex        =   134
               Top             =   885
               Width           =   915
            End
            Begin VB.Label Label19 
               AutoSize        =   -1  'True
               BackStyle       =   0  'Transparent
               Caption         =   "Total Receipt Amt:"
               Height          =   195
               Index           =   6
               Left            =   8040
               TabIndex        =   133
               Top             =   540
               Width           =   1275
            End
            Begin VB.Label Label3 
               AutoSize        =   -1  'True
               BackStyle       =   0  'Transparent
               Caption         =   "Lessee"
               Height          =   195
               Index           =   0
               Left            =   30
               TabIndex        =   132
               Top             =   900
               Width           =   495
            End
            Begin VB.Label Label1 
               AutoSize        =   -1  'True
               BackStyle       =   0  'Transparent
               Caption         =   "Bank A/C"
               Height          =   195
               Index           =   6
               Left            =   30
               TabIndex        =   131
               Top             =   1260
               Width           =   630
            End
            Begin MSForms.TextBox txtTenantID 
               Height          =   285
               Left            =   765
               TabIndex        =   104
               Top             =   915
               Width           =   3645
               VariousPropertyBits=   679495711
               BorderStyle     =   1
               Size            =   "6429;503"
               SpecialEffect   =   0
               FontName        =   "Myriad Web"
               FontHeight      =   165
               FontCharSet     =   0
               FontPitchAndFamily=   2
            End
            Begin MSForms.TextBox txtBankAc 
               Height          =   285
               Left            =   1800
               TabIndex        =   107
               Top             =   1260
               Width           =   2430
               VariousPropertyBits=   679495711
               BorderStyle     =   1
               Size            =   "4286;503"
               SpecialEffect   =   0
               FontName        =   "Myriad Web"
               FontHeight      =   165
               FontCharSet     =   0
               FontPitchAndFamily=   2
            End
            Begin MSForms.TextBox txtRcptAmtType 
               Height          =   285
               Left            =   5760
               TabIndex        =   110
               Top             =   585
               Width           =   1395
               VariousPropertyBits=   679495711
               BorderStyle     =   1
               Size            =   "2461;503"
               SpecialEffect   =   0
               FontName        =   "Myriad Web"
               FontHeight      =   165
               FontCharSet     =   0
               FontPitchAndFamily=   2
            End
         End
         Begin VB.TextBox txtSPayment 
            Alignment       =   1  'Right Justify
            Appearance      =   0  'Flat
            BackColor       =   &H00C0FFC0&
            BorderStyle     =   0  'None
            Height          =   240
            Left            =   12870
            TabIndex        =   117
            Top             =   2925
            Visible         =   0   'False
            Width           =   1095
         End
         Begin VB.TextBox txtCrPayment 
            Alignment       =   1  'Right Justify
            Appearance      =   0  'Flat
            BackColor       =   &H00FFC0C0&
            BorderStyle     =   0  'None
            Height          =   240
            Left            =   12870
            MaxLength       =   13
            TabIndex        =   98
            Top             =   3285
            Visible         =   0   'False
            Width           =   1110
         End
         Begin VB.Frame Frame5 
            BackColor       =   &H00D5D5D5&
            Caption         =   "Allocation:"
            Enabled         =   0   'False
            ForeColor       =   &H00C00000&
            Height          =   705
            Index           =   4
            Left            =   5625
            TabIndex        =   93
            Top             =   8460
            Visible         =   0   'False
            Width           =   3705
            Begin VB.CommandButton cmdAutomatic 
               Caption         =   "Automatic"
               Height          =   400
               Left            =   2520
               Style           =   1  'Graphical
               TabIndex        =   96
               Top             =   225
               Width           =   1080
            End
            Begin VB.CommandButton cmdAllocationDiscard 
               Caption         =   "Clear"
               Height          =   400
               Left            =   1320
               Style           =   1  'Graphical
               TabIndex        =   95
               Top             =   225
               Width           =   1080
            End
            Begin VB.CommandButton cmdAllocateSave 
               Caption         =   "Save"
               Enabled         =   0   'False
               Height          =   400
               Left            =   90
               Style           =   1  'Graphical
               TabIndex        =   94
               Top             =   225
               Width           =   1080
            End
            Begin VB.Label lblSelectedTranID 
               AutoSize        =   -1  'True
               BackStyle       =   0  'Transparent
               Caption         =   "allocation ref."
               BeginProperty Font 
                  Name            =   "Arial"
                  Size            =   8.25
                  Charset         =   0
                  Weight          =   700
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00400040&
               Height          =   195
               Left            =   1530
               TabIndex        =   97
               Top             =   -45
               Visible         =   0   'False
               Width           =   1050
            End
         End
         Begin VB.TextBox txtArray 
            Alignment       =   1  'Right Justify
            Appearance      =   0  'Flat
            BeginProperty Font 
               Name            =   "Myriad Web"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H00000000&
            Height          =   285
            Index           =   4
            Left            =   11625
            Locked          =   -1  'True
            TabIndex        =   92
            Text            =   "0.00"
            Top             =   8400
            Visible         =   0   'False
            Width           =   1200
         End
         Begin MSHierarchicalFlexGridLib.MSHFlexGrid flxSPayment 
            Height          =   2115
            Left            =   120
            TabIndex        =   118
            Top             =   2610
            Width           =   14820
            _ExtentX        =   26141
            _ExtentY        =   3731
            _Version        =   393216
            FixedCols       =   0
            BackColorFixed  =   12632256
            ForeColorFixed  =   -2147483640
            BackColorSel    =   12648447
            ForeColorSel    =   -2147483640
            BackColorBkg    =   16777215
            GridColor       =   -2147483638
            GridColorFixed  =   -2147483630
            WordWrap        =   -1  'True
            GridLinesFixed  =   1
            Appearance      =   0
            BandDisplay     =   1
            BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
               Name            =   "Myriad Web"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            _NumberOfBands  =   1
            _Band(0).Cols   =   2
         End
         Begin MSHierarchicalFlexGridLib.MSHFlexGrid flxCrPoA 
            Height          =   2400
            Left            =   120
            TabIndex        =   140
            Top             =   5610
            Width           =   14730
            _ExtentX        =   25982
            _ExtentY        =   4233
            _Version        =   393216
            FixedCols       =   0
            BackColorFixed  =   12632256
            ForeColorFixed  =   -2147483640
            BackColorSel    =   12648447
            ForeColorSel    =   -2147483640
            BackColorBkg    =   16777215
            GridColor       =   -2147483638
            GridColorFixed  =   -2147483630
            WordWrap        =   -1  'True
            GridLinesFixed  =   1
            SelectionMode   =   1
            Appearance      =   0
            BandDisplay     =   1
            BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
               Name            =   "Myriad Web"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            _NumberOfBands  =   1
            _Band(0).Cols   =   2
         End
         Begin MSHierarchicalFlexGridLib.MSHFlexGrid flxReceiptHistory 
            Height          =   5820
            Left            =   -74925
            TabIndex        =   180
            Top             =   1245
            Width           =   14865
            _ExtentX        =   26220
            _ExtentY        =   10266
            _Version        =   393216
            Cols            =   13
            FixedCols       =   0
            BackColorFixed  =   12632256
            ForeColorFixed  =   -2147483640
            BackColorSel    =   12648447
            ForeColorSel    =   -2147483640
            BackColorBkg    =   16777215
            GridColor       =   -2147483638
            GridColorFixed  =   -2147483630
            WordWrap        =   -1  'True
            GridLinesFixed  =   1
            SelectionMode   =   1
            Appearance      =   0
            BandDisplay     =   1
            BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            _NumberOfBands  =   1
            _Band(0).Cols   =   13
         End
         Begin MSHierarchicalFlexGridLib.MSHFlexGrid flxAllocation 
            Height          =   1200
            Left            =   -74910
            TabIndex        =   388
            Top             =   7515
            Width           =   14775
            _ExtentX        =   26061
            _ExtentY        =   2117
            _Version        =   393216
            FixedCols       =   0
            BackColorFixed  =   12632256
            ForeColorFixed  =   -2147483640
            BackColorSel    =   12648447
            ForeColorSel    =   -2147483640
            BackColorBkg    =   16777215
            GridColor       =   -2147483638
            GridColorFixed  =   -2147483630
            WordWrap        =   -1  'True
            GridLinesFixed  =   1
            Appearance      =   0
            BandDisplay     =   1
            BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
               Name            =   "Myriad Web"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            _NumberOfBands  =   1
            _Band(0).Cols   =   2
         End
         Begin VB.Line Line2 
            X1              =   720
            X2              =   15930
            Y1              =   2250
            Y2              =   2250
         End
         Begin VB.Label Label1 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Allocation Date"
            BeginProperty Font 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   210
            Index           =   52
            Left            =   -66945
            TabIndex        =   406
            Top             =   7290
            Width           =   1080
         End
         Begin VB.Label Label3 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Total O/S:"
            BeginProperty Font 
               Name            =   "Myriad Web"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   195
            Index           =   5
            Left            =   10665
            TabIndex        =   404
            Top             =   4815
            Width           =   735
         End
         Begin VB.Label Label3 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Total O/S:"
            BeginProperty Font 
               Name            =   "Myriad Web"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   195
            Index           =   4
            Left            =   10665
            TabIndex        =   403
            Top             =   8055
            Width           =   735
         End
         Begin VB.Label Label3 
            AutoSize        =   -1  'True
            BackColor       =   &H00008000&
            Caption         =   "Allocation View  "
            BeginProperty Font 
               Name            =   "Times New Roman"
               Size            =   11.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H0000FFFF&
            Height          =   255
            Index           =   3
            Left            =   -68160
            TabIndex        =   401
            Top             =   7020
            Width           =   1650
         End
         Begin VB.Label Label1 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Total OSAmount:"
            BeginProperty Font 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   210
            Index           =   51
            Left            =   -61815
            TabIndex        =   399
            Top             =   8730
            Width           =   1215
         End
         Begin VB.Label Label1 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Client ID"
            BeginProperty Font 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   210
            Index           =   50
            Left            =   -72390
            TabIndex        =   398
            Top             =   7290
            Width           =   570
         End
         Begin VB.Label Label1 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Receipt Amt "
            BeginProperty Font 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   210
            Index           =   49
            Left            =   -61725
            TabIndex        =   397
            Top             =   7290
            Width           =   1005
         End
         Begin VB.Label Label1 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "O/S Amt. "
            BeginProperty Font 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   210
            Index           =   48
            Left            =   -63120
            TabIndex        =   396
            Top             =   7290
            Width           =   780
         End
         Begin VB.Label Label1 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Amount "
            BeginProperty Font 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   210
            Index           =   47
            Left            =   -64650
            TabIndex        =   395
            Top             =   7290
            Width           =   690
         End
         Begin VB.Label Label1 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Details"
            BeginProperty Font 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   210
            Index           =   46
            Left            =   -65730
            TabIndex        =   394
            Top             =   7290
            Width           =   480
         End
         Begin VB.Label Label1 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Issue Date"
            BeginProperty Font 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   210
            Index           =   45
            Left            =   -68070
            TabIndex        =   393
            Top             =   7290
            Width           =   765
         End
         Begin VB.Label Label1 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Due Date"
            BeginProperty Font 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   210
            Index           =   44
            Left            =   -69870
            TabIndex        =   392
            Top             =   7290
            Width           =   660
         End
         Begin VB.Label Label1 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Unit ID"
            BeginProperty Font 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   210
            Index           =   43
            Left            =   -71040
            TabIndex        =   391
            Top             =   7290
            Width           =   450
         End
         Begin VB.Label Label1 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Type"
            BeginProperty Font 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   210
            Index           =   42
            Left            =   -73605
            TabIndex        =   390
            Top             =   7290
            Width           =   360
         End
         Begin VB.Label Label1 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "No."
            BeginProperty Font 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   210
            Index           =   36
            Left            =   -74550
            TabIndex        =   389
            Top             =   7290
            Width           =   240
         End
         Begin VB.Label Label1 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "OS Amount"
            BeginProperty Font 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   210
            Index           =   16
            Left            =   -61635
            TabIndex        =   387
            Top             =   945
            Width           =   825
         End
         Begin VB.Label Label1 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Display : "
            BeginProperty Font 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   210
            Index           =   13
            Left            =   -65595
            TabIndex        =   384
            Top             =   8820
            Width           =   660
         End
         Begin VB.Label Label1 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Total Amount:"
            BeginProperty Font 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   210
            Index           =   12
            Left            =   -63120
            TabIndex        =   383
            Top             =   8730
            Width           =   990
         End
         Begin MSForms.TextBox txtRptPropertyList1 
            Height          =   285
            Left            =   -71085
            TabIndex        =   225
            Top             =   495
            Width           =   1845
            VariousPropertyBits=   679495711
            BorderStyle     =   1
            Size            =   "3254;503"
            SpecialEffect   =   0
            FontName        =   "Myriad Web"
            FontHeight      =   165
            FontCharSet     =   0
            FontPitchAndFamily=   2
         End
         Begin MSForms.TextBox txtRptClientList1 
            Height          =   285
            Left            =   -74145
            TabIndex        =   224
            Top             =   495
            Width           =   1890
            VariousPropertyBits=   679495711
            BorderStyle     =   1
            Size            =   "3334;503"
            SpecialEffect   =   0
            FontName        =   "Myriad Web"
            FontHeight      =   165
            FontCharSet     =   0
            FontPitchAndFamily=   2
         End
         Begin MSForms.TextBox txtTenantID1 
            Height          =   315
            Left            =   -67410
            TabIndex        =   182
            Top             =   495
            Width           =   2490
            VariousPropertyBits=   679495711
            BackColor       =   15858158
            Size            =   "4392;556"
            Value           =   "All Lessees"
            SpecialEffect   =   6
            FontName        =   "Myriad Web"
            FontHeight      =   165
            FontCharSet     =   0
            FontPitchAndFamily=   2
         End
         Begin VB.Label Label1 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Receipt No"
            BeginProperty Font 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   210
            Index           =   27
            Left            =   -74580
            TabIndex        =   190
            Top             =   945
            Width           =   780
         End
         Begin VB.Label Label1 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Client"
            BeginProperty Font 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   195
            Index           =   15
            Left            =   -74820
            TabIndex        =   199
            Top             =   495
            Width           =   435
         End
         Begin MSForms.ComboBox cboRptBankList1 
            Height          =   315
            Left            =   -60915
            TabIndex        =   185
            Top             =   360
            Visible         =   0   'False
            Width           =   3435
            VariousPropertyBits=   1753237531
            DisplayStyle    =   3
            Size            =   "6059;556"
            BoundColumn     =   0
            TextColumn      =   2
            ColumnCount     =   2
            ListRows        =   20
            cColumnInfo     =   1
            MatchEntry      =   1
            ShowDropButtonWhen=   2
            SpecialEffect   =   6
            FontName        =   "Myriad Web"
            FontHeight      =   165
            FontCharSet     =   0
            FontPitchAndFamily=   2
            Object.Width           =   "1411"
         End
         Begin VB.Label Label1 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Bank"
            BeginProperty Font 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   240
            Index           =   37
            Left            =   -61635
            TabIndex        =   198
            Top             =   405
            Visible         =   0   'False
            Width           =   555
         End
         Begin VB.Label Label1 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Amount"
            BeginProperty Font 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   195
            Index           =   34
            Left            =   -62940
            TabIndex        =   197
            Top             =   945
            Width           =   555
         End
         Begin VB.Label Label1 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Reference"
            BeginProperty Font 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   195
            Index           =   33
            Left            =   -66000
            TabIndex        =   196
            Top             =   945
            Width           =   945
         End
         Begin VB.Label Label1 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Fund"
            BeginProperty Font 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   210
            Index           =   32
            Left            =   -67485
            TabIndex        =   195
            Top             =   945
            Width           =   360
         End
         Begin VB.Label Label1 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Property"
            BeginProperty Font 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   195
            Index           =   31
            Left            =   -68790
            TabIndex        =   194
            Top             =   945
            Width           =   615
         End
         Begin VB.Label Label1 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Lessee"
            BeginProperty Font 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   210
            Index           =   30
            Left            =   -70380
            TabIndex        =   193
            Top             =   945
            Width           =   540
         End
         Begin VB.Label Label1 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Bank Code"
            BeginProperty Font 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   195
            Index           =   29
            Left            =   -71820
            TabIndex        =   192
            Top             =   945
            Width           =   735
         End
         Begin VB.Label Label1 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Date"
            BeginProperty Font 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   195
            Index           =   28
            Left            =   -73020
            TabIndex        =   191
            Top             =   945
            Width           =   345
         End
         Begin VB.Label Label1 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Lessee"
            BeginProperty Font 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   210
            Index           =   25
            Left            =   -68070
            TabIndex        =   189
            Top             =   495
            Width           =   540
         End
         Begin VB.Label Label1 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Property"
            BeginProperty Font 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   195
            Index           =   14
            Left            =   -71760
            TabIndex        =   188
            Top             =   495
            Width           =   615
         End
         Begin VB.Label Label1 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Type"
            BeginProperty Font 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   195
            Index           =   35
            Left            =   -63675
            TabIndex        =   181
            Top             =   495
            Width           =   345
         End
         Begin MSForms.ComboBox cmbRptHistory 
            Height          =   315
            Left            =   -63210
            TabIndex        =   186
            Top             =   495
            Width           =   2235
            VariousPropertyBits=   1753237531
            DisplayStyle    =   3
            Size            =   "3942;556"
            BoundColumn     =   0
            TextColumn      =   2
            ColumnCount     =   2
            ListRows        =   20
            cColumnInfo     =   1
            MatchEntry      =   1
            ShowDropButtonWhen=   2
            SpecialEffect   =   6
            FontName        =   "Myriad Web"
            FontHeight      =   165
            FontCharSet     =   0
            FontPitchAndFamily=   2
            Object.Width           =   "881"
         End
         Begin VB.Label Label3 
            AutoSize        =   -1  'True
            BackColor       =   &H00008000&
            Caption         =   "  Allocation View  "
            BeginProperty Font 
               Name            =   "Times New Roman"
               Size            =   14.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H0000FFFF&
            Height          =   330
            Index           =   2
            Left            =   6135
            TabIndex        =   160
            Top             =   4785
            Visible         =   0   'False
            Width           =   2235
         End
         Begin VB.Label Label10 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Debit:"
            BeginProperty Font 
               Name            =   "Myriad Web"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H00400040&
            Height          =   195
            Index           =   0
            Left            =   165
            TabIndex        =   166
            Top             =   2070
            Width           =   465
         End
         Begin VB.Line Line1 
            BorderColor     =   &H00808080&
            BorderStyle     =   6  'Inside Solid
            Index           =   2
            X1              =   675
            X2              =   15975
            Y1              =   5175
            Y2              =   5175
         End
         Begin VB.Label Label10 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Credit:"
            BeginProperty Font 
               Name            =   "Myriad Web"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H00400040&
            Height          =   195
            Index           =   1
            Left            =   120
            TabIndex        =   165
            Top             =   5055
            Width           =   510
         End
         Begin VB.Label Label3 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Total allocation difference:"
            BeginProperty Font 
               Name            =   "Myriad Web"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   195
            Index           =   1
            Left            =   9345
            TabIndex        =   164
            Top             =   8400
            Visible         =   0   'False
            Width           =   2040
         End
         Begin VB.Label lblAllocating 
            BackStyle       =   0  'Transparent
            Caption         =   "Allocating..."
            BeginProperty Font 
               Name            =   "Myriad Web"
               Size            =   9
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H00C000C0&
            Height          =   210
            Left            =   13245
            TabIndex        =   163
            Top             =   8445
            Visible         =   0   'False
            Width           =   945
         End
         Begin VB.Label Label10 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "allocating row no"
            BeginProperty Font 
               Name            =   "Myriad Web"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H00400040&
            Height          =   195
            Index           =   3
            Left            =   13335
            TabIndex        =   162
            Top             =   2040
            Visible         =   0   'False
            Width           =   1320
         End
         Begin VB.Label Label10 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "credit row no"
            BeginProperty Font 
               Name            =   "Myriad Web"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H00400040&
            Height          =   195
            Index           =   4
            Left            =   14850
            TabIndex        =   161
            Top             =   5310
            Visible         =   0   'False
            Width           =   990
         End
         Begin VB.Label Label19 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "No."
            Height          =   195
            Index           =   10
            Left            =   345
            TabIndex        =   159
            Top             =   2325
            Width           =   240
         End
         Begin VB.Label Label19 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Type"
            Height          =   195
            Index           =   11
            Left            =   1245
            TabIndex        =   158
            Top             =   2325
            Width           =   345
         End
         Begin VB.Label Label19 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Unit ID"
            Height          =   195
            Index           =   13
            Left            =   3525
            TabIndex        =   157
            Top             =   2325
            Width           =   495
         End
         Begin VB.Label Label19 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Due Date"
            Height          =   195
            Index           =   14
            Left            =   5730
            TabIndex        =   156
            Top             =   2325
            Width           =   675
         End
         Begin VB.Label Label19 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Ref"
            Height          =   195
            Index           =   15
            Left            =   6855
            TabIndex        =   155
            Top             =   2325
            Width           =   225
         End
         Begin VB.Label Label19 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Details"
            Height          =   195
            Index           =   16
            Left            =   8130
            TabIndex        =   154
            Top             =   2325
            Width           =   510
         End
         Begin VB.Label Label19 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Amount "
            Height          =   195
            Index           =   17
            Left            =   10290
            TabIndex        =   153
            Top             =   2325
            Width           =   675
         End
         Begin VB.Label Label19 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "O/S Amt. "
            Height          =   195
            Index           =   18
            Left            =   11490
            TabIndex        =   152
            Top             =   2325
            Width           =   735
         End
         Begin VB.Label Label19 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Receipt "
            Height          =   195
            Index           =   19
            Left            =   12690
            TabIndex        =   151
            Top             =   2325
            Width           =   660
         End
         Begin VB.Label Label19 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Receipt "
            Height          =   195
            Index           =   29
            Left            =   12675
            TabIndex        =   150
            Top             =   5265
            Width           =   660
         End
         Begin VB.Label Label19 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "O/S Amt. "
            Height          =   195
            Index           =   28
            Left            =   11460
            TabIndex        =   149
            Top             =   5265
            Width           =   735
         End
         Begin VB.Label Label19 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Amount "
            Height          =   195
            Index           =   27
            Left            =   10260
            TabIndex        =   148
            Top             =   5265
            Width           =   675
         End
         Begin VB.Label Label19 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Details"
            Height          =   195
            Index           =   26
            Left            =   8100
            TabIndex        =   147
            Top             =   5265
            Width           =   510
         End
         Begin VB.Label Label19 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Ref"
            Height          =   195
            Index           =   25
            Left            =   6795
            TabIndex        =   146
            Top             =   5265
            Width           =   225
         End
         Begin VB.Label Label19 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Date"
            Height          =   195
            Index           =   24
            Left            =   5715
            TabIndex        =   145
            Top             =   5310
            Width           =   345
         End
         Begin VB.Label Label19 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Unit ID"
            Height          =   195
            Index           =   23
            Left            =   4635
            TabIndex        =   144
            Top             =   5310
            Width           =   495
         End
         Begin VB.Label Label19 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Lessee"
            Height          =   195
            Index           =   22
            Left            =   3420
            TabIndex        =   143
            Top             =   5310
            Visible         =   0   'False
            Width           =   495
         End
         Begin VB.Label Label19 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Type"
            Height          =   195
            Index           =   21
            Left            =   900
            TabIndex        =   142
            Top             =   5310
            Width           =   345
         End
         Begin VB.Label Label19 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "No."
            Height          =   195
            Index           =   20
            Left            =   240
            TabIndex        =   141
            Top             =   5310
            Width           =   240
         End
         Begin VB.Line Line1 
            BorderColor     =   &H00C0FFC0&
            BorderWidth     =   2
            Index           =   3
            X1              =   675
            X2              =   13060
            Y1              =   4740
            Y2              =   4740
         End
         Begin VB.Line Line1 
            BorderColor     =   &H00C0FFFF&
            BorderWidth     =   2
            Index           =   0
            X1              =   600
            X2              =   13065
            Y1              =   1980
            Y2              =   1995
         End
         Begin VB.Shape Shape4 
            BackColor       =   &H00E0E0E0&
            BorderColor     =   &H00C0C0C0&
            BorderStyle     =   6  'Inside Solid
            FillColor       =   &H00E0E0E0&
            FillStyle       =   0  'Solid
            Height          =   285
            Index           =   20
            Left            =   -74925
            Top             =   900
            Width           =   14820
         End
         Begin VB.Shape Shape1 
            BackColor       =   &H00E4E4E4&
            BackStyle       =   1  'Opaque
            BorderColor     =   &H8000000F&
            Height          =   555
            Index           =   0
            Left            =   -74880
            Top             =   330
            Width           =   14730
         End
      End
      Begin VB.Frame fraDemandMainlist 
         Height          =   7035
         Left            =   1350
         TabIndex        =   278
         Top             =   360
         Width           =   14415
         Begin VB.CommandButton cmdClientFilterMainList 
            Caption         =   ".."
            BeginProperty Font 
               Name            =   "Myriad Web"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   300
            Index           =   2
            Left            =   8235
            TabIndex        =   429
            Top             =   180
            Width           =   300
         End
         Begin VB.CommandButton cmdClientFilterMainList 
            Caption         =   ".."
            BeginProperty Font 
               Name            =   "Myriad Web"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   300
            Index           =   1
            Left            =   5565
            TabIndex        =   284
            Top             =   180
            Width           =   300
         End
         Begin VB.CommandButton cmdClientFilterMainList 
            Caption         =   ".."
            BeginProperty Font 
               Name            =   "Myriad Web"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   300
            Index           =   0
            Left            =   2685
            TabIndex        =   283
            Top             =   180
            Width           =   300
         End
         Begin VB.CheckBox chkSelectAllDemands 
            Appearance      =   0  'Flat
            Caption         =   "&Select All"
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H80000008&
            Height          =   255
            Left            =   45
            TabIndex        =   282
            Top             =   600
            Width           =   255
         End
         Begin VB.CommandButton cmdClientFilterMainList 
            Caption         =   ".."
            BeginProperty Font 
               Name            =   "Myriad Web"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   300
            Index           =   3
            Left            =   11055
            TabIndex        =   280
            Top             =   180
            Width           =   300
         End
         Begin VB.CommandButton cmdClientFilterMainList 
            Caption         =   ".."
            BeginProperty Font 
               Name            =   "Myriad Web"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   300
            Index           =   4
            Left            =   13665
            TabIndex        =   279
            Top             =   180
            Width           =   300
         End
         Begin MSHierarchicalFlexGridLib.MSHFlexGrid flxDemands 
            Height          =   6075
            Left            =   45
            TabIndex        =   281
            Top             =   855
            Width           =   13860
            _ExtentX        =   24448
            _ExtentY        =   10716
            _Version        =   393216
            BackColorFixed  =   14936810
            BackColorSel    =   15329508
            ForeColorSel    =   -2147483640
            BackColorBkg    =   16777215
            GridColor       =   -2147483638
            GridColorFixed  =   -2147483630
            WordWrap        =   -1  'True
            GridLinesFixed  =   1
            Appearance      =   0
            BandDisplay     =   1
            BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            _NumberOfBands  =   1
            _Band(0).Cols   =   2
         End
         Begin MSForms.TextBox txtInvoiceType 
            Height          =   285
            Left            =   6480
            TabIndex        =   428
            Top             =   180
            Width           =   1710
            VariousPropertyBits=   679495711
            BorderStyle     =   1
            Size            =   "3016;503"
            SpecialEffect   =   0
            FontName        =   "Myriad Web"
            FontHeight      =   165
            FontCharSet     =   0
            FontPitchAndFamily=   2
         End
         Begin VB.Label Label44 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Type:"
            Height          =   195
            Index           =   9
            Left            =   6030
            TabIndex        =   427
            Top             =   225
            Width           =   375
         End
         Begin VB.Label Label44 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Client:"
            Height          =   195
            Index           =   0
            Left            =   270
            TabIndex        =   300
            Top             =   180
            Width           =   465
         End
         Begin VB.Label Label44 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Property:"
            Height          =   195
            Index           =   1
            Left            =   3075
            TabIndex        =   299
            Top             =   180
            Width           =   645
         End
         Begin VB.Label Label44 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Demand No."
            ForeColor       =   &H00FF0000&
            Height          =   195
            Index           =   2
            Left            =   285
            TabIndex        =   298
            Top             =   615
            Width           =   855
         End
         Begin VB.Label Label44 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Lessee Name"
            ForeColor       =   &H00FF0000&
            Height          =   195
            Index           =   4
            Left            =   1365
            TabIndex        =   297
            Top             =   615
            Width           =   930
         End
         Begin VB.Label Label44 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Unit No"
            ForeColor       =   &H00FF0000&
            Height          =   195
            Index           =   5
            Left            =   4950
            TabIndex        =   296
            Top             =   615
            Width           =   540
         End
         Begin VB.Label Label44 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Issue Dt."
            ForeColor       =   &H00FF0000&
            Height          =   195
            Index           =   6
            Left            =   6180
            TabIndex        =   295
            Top             =   615
            Width           =   615
         End
         Begin VB.Label Label44 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Total"
            ForeColor       =   &H00FF0000&
            Height          =   195
            Index           =   7
            Left            =   7260
            TabIndex        =   294
            Top             =   615
            Width           =   360
         End
         Begin VB.Label Label44 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Printed"
            ForeColor       =   &H00FF0000&
            Height          =   195
            Index           =   8
            Left            =   9390
            TabIndex        =   293
            Top             =   615
            Width           =   525
         End
         Begin VB.Label Label44 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Emailed"
            ForeColor       =   &H00FF0000&
            Height          =   195
            Index           =   34
            Left            =   10290
            TabIndex        =   292
            Top             =   615
            Width           =   555
         End
         Begin VB.Label Label44 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Outstanding"
            ForeColor       =   &H00FF0000&
            Height          =   195
            Index           =   36
            Left            =   8175
            TabIndex        =   291
            Top             =   615
            Width           =   885
         End
         Begin MSForms.TextBox txtClientList 
            Height          =   285
            Left            =   885
            TabIndex        =   290
            Top             =   180
            Width           =   1845
            VariousPropertyBits=   679495711
            BorderStyle     =   1
            Size            =   "3254;503"
            SpecialEffect   =   0
            FontName        =   "Myriad Web"
            FontHeight      =   165
            FontCharSet     =   0
            FontPitchAndFamily=   2
         End
         Begin MSForms.TextBox txtPropertyList 
            Height          =   285
            Left            =   3765
            TabIndex        =   289
            Top             =   180
            Width           =   1800
            VariousPropertyBits=   679495711
            BorderStyle     =   1
            Size            =   "3175;503"
            SpecialEffect   =   0
            FontName        =   "Myriad Web"
            FontHeight      =   165
            FontCharSet     =   0
            FontPitchAndFamily=   2
         End
         Begin MSForms.TextBox txtUnitlist 
            Height          =   285
            Left            =   9300
            TabIndex        =   288
            Top             =   180
            Width           =   1755
            VariousPropertyBits=   679495711
            BorderStyle     =   1
            Size            =   "3096;503"
            SpecialEffect   =   0
            FontName        =   "Myriad Web"
            FontHeight      =   165
            FontCharSet     =   0
            FontPitchAndFamily=   2
         End
         Begin MSForms.TextBox txtlesselist 
            Height          =   285
            Left            =   12090
            TabIndex        =   287
            Top             =   180
            Width           =   1530
            VariousPropertyBits=   679495711
            BorderStyle     =   1
            Size            =   "2699;503"
            SpecialEffect   =   0
            FontName        =   "Myriad Web"
            FontHeight      =   165
            FontCharSet     =   0
            FontPitchAndFamily=   2
         End
         Begin VB.Label Label44 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Unit:"
            Height          =   195
            Index           =   40
            Left            =   8850
            TabIndex        =   286
            Top             =   225
            Width           =   330
         End
         Begin VB.Label Label44 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "Lessee:"
            Height          =   195
            Index           =   41
            Left            =   11505
            TabIndex        =   285
            Top             =   225
            Width           =   525
         End
      End
      Begin VB.Label Label50 
         Alignment       =   1  'Right Justify
         AutoSize        =   -1  'True
         BackStyle       =   0  'Transparent
         Caption         =   "Controls count"
         Height          =   195
         Index           =   10
         Left            =   13275
         TabIndex        =   380
         Top             =   90
         Visible         =   0   'False
         Width           =   1050
      End
      Begin MSForms.TextBox txtUnitListHist 
         Height          =   285
         Left            =   -65460
         TabIndex        =   241
         Top             =   450
         Width           =   1755
         VariousPropertyBits=   679495711
         BorderStyle     =   1
         Size            =   "3096;503"
         SpecialEffect   =   0
         FontName        =   "Myriad Web"
         FontHeight      =   165
         FontCharSet     =   0
         FontPitchAndFamily=   2
      End
      Begin MSForms.TextBox txtLesseeListHist 
         Height          =   285
         Left            =   -62535
         TabIndex        =   240
         Top             =   450
         Width           =   1530
         VariousPropertyBits=   679495711
         BorderStyle     =   1
         Size            =   "2699;503"
         SpecialEffect   =   0
         FontName        =   "Myriad Web"
         FontHeight      =   165
         FontCharSet     =   0
         FontPitchAndFamily=   2
      End
      Begin VB.Label Label44 
         Alignment       =   1  'Right Justify
         AutoSize        =   -1  'True
         BackStyle       =   0  'Transparent
         Caption         =   "Unit:"
         Height          =   195
         Index           =   43
         Left            =   -65910
         TabIndex        =   239
         Top             =   450
         Width           =   330
      End
      Begin VB.Label Label44 
         Alignment       =   1  'Right Justify
         AutoSize        =   -1  'True
         BackStyle       =   0  'Transparent
         Caption         =   "Lessee:"
         Height          =   195
         Index           =   42
         Left            =   -63120
         TabIndex        =   238
         Top             =   450
         Width           =   525
      End
      Begin MSForms.TextBox txtPropertyHistory 
         Height          =   285
         Left            =   -69555
         TabIndex        =   223
         Top             =   450
         Width           =   2205
         VariousPropertyBits=   679495711
         BorderStyle     =   1
         Size            =   "3889;503"
         SpecialEffect   =   0
         FontName        =   "Myriad Web"
         FontHeight      =   165
         FontCharSet     =   0
         FontPitchAndFamily=   2
      End
      Begin MSForms.TextBox txtClientHistory 
         Height          =   285
         Left            =   -73695
         TabIndex        =   222
         Top             =   450
         Width           =   2700
         VariousPropertyBits=   679495711
         BorderStyle     =   1
         Size            =   "4762;503"
         SpecialEffect   =   0
         FontName        =   "Myriad Web"
         FontHeight      =   165
         FontCharSet     =   0
         FontPitchAndFamily=   2
      End
      Begin VB.Label Label44 
         Alignment       =   1  'Right Justify
         AutoSize        =   -1  'True
         BackStyle       =   0  'Transparent
         Caption         =   "Property:"
         Height          =   195
         Index           =   39
         Left            =   -70320
         TabIndex        =   213
         Top             =   450
         Width           =   645
      End
      Begin VB.Label Label44 
         AutoSize        =   -1  'True
         BackStyle       =   0  'Transparent
         Caption         =   "Client:"
         Height          =   195
         Index           =   38
         Left            =   -74235
         TabIndex        =   211
         Top             =   465
         Width           =   465
      End
      Begin VB.Label Label1 
         AutoSize        =   -1  'True
         BackColor       =   &H00FFDFC0&
         BackStyle       =   0  'Transparent
         Caption         =   "View Only"
         BeginProperty Font 
            Name            =   "Courier"
            Size            =   12
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H000000FF&
         Height          =   240
         Index           =   7
         Left            =   6480
         TabIndex        =   210
         Top             =   0
         Visible         =   0   'False
         Width           =   1365
      End
      Begin VB.Label Label44 
         Alignment       =   1  'Right Justify
         AutoSize        =   -1  'True
         BackStyle       =   0  'Transparent
         Caption         =   "I/C"
         Height          =   195
         Index           =   3
         Left            =   13455
         TabIndex        =   74
         Top             =   630
         Visible         =   0   'False
         Width           =   210
      End
   End
   Begin Crystal.CrystalReport CrystalReport1 
      Left            =   18315
      Top             =   8100
      _ExtentX        =   741
      _ExtentY        =   741
      _Version        =   348160
      PrintFileLinesPerPage=   60
   End
End
Attribute VB_Name = "frmDemands3"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Option Explicit
'History
'I could not  create more controls in the form so I Had to create control arrays of text boxes which is txtArray(0)
' on Date 2023-02-01 I have replaced 9 textbox to control arrays
Private vatOptionEnabled As Boolean
Public nTaxCode            As Double
Public lFund               As Long
Public szSelProperties     As String
Public sEditSRR            As Single
Public FormLoad            As Boolean

Private Type SendDemandByEmail
        szLesseeID    As String
        szLesseeEmail As String
        szUnitName      As String
        szClient      As String
        colAtt        As Collection
        lURN          As Collection
        szLesseeName  As String
End Type

Private uLessee()          As SendDemandByEmail
Private bAddNew            As Boolean, szDemandBankID    As String
Private strCommandSource           As String, sCurrTenantRptHis  As String
Private iSelected          As Integer, szEmailDmdIdList  As String
Private szaNominalCode(5)  As String
Private dDrOS              As Double
Private dCrOS              As Double
Private iCrPoARowSel       As Integer
Private dtSC_StFrom        As Date
Private dtSC_StTo          As Date
Private cTotalSI           As Currency
Private cTotalAdjI         As Currency
Private bSortingCol()      As Boolean
Private szAdiComment()     As String
Private bSortingCol1       As Boolean
Private bSortingCol2       As Boolean
Private bSortingCol3       As Boolean
Private iLes               As Integer
Private btSelDerivedFrom   As Byte
Private BANK_TYPE          As String
Private iDemandRow         As Integer

Dim iSelectedDemandsRow    As Integer
Dim iIncDec                As Integer
Dim szaFreq()              As String
Dim szPrefix               As String
Dim baBankRecon()          As Boolean
Dim szLastIDClicked        As String            'the latest selected demand
Dim iSelSplitCol           As Integer
Dim szCurCompSageAccNum    As String
Dim objDemandType          As clsArray
Dim fVAT_Rate              As Single, cTempReceiptAmt   As Currency
Dim szAllBankBalance       As String, bFormLoading      As Boolean
Dim iCurRow                As Integer, dSortIndex()     As Integer
Dim bChangesMade           As Boolean, baChangesMade()  As Boolean
Dim szUndoText             As String, iFlxSPayCol       As Integer
Dim bTotalRptTyped         As Boolean, bEditDmd As Boolean
Dim iTotalTran             As Integer, cGridRptTotal    As Currency
Dim dDrOS_Adj              As Double, dCrOS_Adj         As Double
Dim szaTenantBalance()     As String
Dim szaProperty()          As String
'Dim sTextmode As String
Private Declare Sub Sleep Lib "kernel32" (ByVal dwMilliseconds As Long)
Dim szaDemandData() As String
Dim szIntitalOSAmount() As Currency
Public editexception As Boolean
Dim isFormActive As Boolean
Dim szTenantsSQL As String
Dim szTenantsSQL2 As String
Dim attachmentframePlayed As Boolean
'Dim DataAttach() As String
Dim iEmailedCounter As Integer
Dim iEmailedCounterFailed As Integer
Dim colTransactionIDOtherPayGrid As String
Dim colTransactionIDOtherSIGrid As String 'this is actual demandlisting grid here
Dim UserSessionID As String
Dim IsDemandIDLocked As Boolean
Dim bToggleAllocationView As Boolean
Dim iTop As Integer
Dim iLeft As Integer
Private Declare Function GetOpenFileName Lib "comdlg32.dll" Alias "GetOpenFileNameA" (pOpenfilename As OPENFILENAME) As Long

Private Type OPENFILENAME
    lStructSize As Long
    hwndOwner As Long
    hInstance As Long
    lpstrFilter As String
    lpstrCustomFilter As String
    nMaxCustFilter As Long
    nFilterIndex As Long
    lpstrFile As String
    nMaxFile As Long
    lpstrFileTitle As String
    nMaxFileTitle As Long
    lpstrInitialDir As String
    lpstrTitle As String
    Flags As Long
    nFileOffset As Integer
    nFileExtension As Integer
    lpstrDefExt As String
    lCustData As Long
    lpfnHook As Long
    lpTemplateName As String
End Type
Dim strSelectedFundCode As String
Dim strAddNewAmountMode As String
Private Declare Function ShellExecute Lib "shell32.dll" Alias "ShellExecuteA" _
   (ByVal hWnd As Long, ByVal lpOperation As String, ByVal lpFile As String, _
       ByVal lpParameters As String, ByVal lpDirectory As String, ByVal nShowCmd _
           As Long) As Long
Const SW_SHOW = 5
Dim GridRowNo As Long
Dim iIndex As Integer
Dim strSelectedPrintRef As String
Private Function ReceiverEmailList(szLessee As String, szEmail As String, lURN As Long, szLesName As String, szUniName As String, Optional szClient As String) As String
   Dim i As Integer

   ReceiverEmailList = 0
   If iLes = 0 Then
      iLes = 1
      ReDim uLessee(0) As SendDemandByEmail
      Set uLessee(0).lURN = New Collection
      uLessee(0).szLesseeID = szLessee
      uLessee(0).szLesseeEmail = szEmail
      uLessee(0).szUnitName = szUniName
      uLessee(0).szClient = szClient
      uLessee(0).lURN.Add lURN   'Demand ID
      uLessee(0).szLesseeName = szLesName
      Exit Function
   End If

   For i = 0 To UBound(uLessee)
      If uLessee(i).szLesseeID = szLessee Then
            uLessee(i).lURN.Add lURN
            Exit For
      End If
   Next i

   If i > UBound(uLessee) Then
      ReDim Preserve uLessee(iLes) As SendDemandByEmail
      Set uLessee(iLes).lURN = New Collection
      uLessee(iLes).szLesseeID = szLessee
      uLessee(iLes).szLesseeEmail = szEmail
      uLessee(0).szUnitName = szUniName
      uLessee(iLes).szClient = szClient
      uLessee(iLes).lURN.Add lURN  'adding demand ID
      uLessee(iLes).szLesseeName = szLesName
      ReceiverEmailList = iLes
      iLes = iLes + 1
   End If
End Function

Public Sub SetComment(szComment As String)
   If strAddNewAmountMode <> "Edit" Then
      szAdiComment(flxAddNewDemands.Rows - 1) = szComment
   Else
      szAdiComment(CInt(GridRowNo)) = szComment
   End If
End Sub





Private Sub cboFreq_KeyPress(KeyAscii As MSForms.ReturnInteger)
    If KeyAscii = 13 Then
        If cmdaddnewline.Enabled = True Then cmdaddnewline.SetFocus
    End If
End Sub



Private Sub chkAppyFund_Click()
    
End Sub

Private Sub chkApplyFund_Click()
    Dim adoConn As New ADODB.Connection
    If chkApplyFund.Value = True Then
            txtBankCode.text = ""
            txtBankAc.text = ""
            cmdBankAc.Enabled = False
    Else
            cmdBankAc.Enabled = True
            adoConn.Open getConnectionString
            Call LoadDefaultBankAC(adoConn) 'when you select a client it is loading a deafult Bank AC
            adoConn.Close
    End If
End Sub

Private Sub chkCheckAllHisDemand_Click()
     
   Dim iRow As Integer, i As Integer
   Dim j As Integer
   If chkCheckAllHisDemand.Value Then
      For i = 1 To flxDemandHistory.Rows - 1
         flxDemandHistory.TextMatrix(i, 0) = "X"
         j = j + 1
      Next i
'      For i = 1 To flxDemandHistory.Rows - 1
'         iIncDec = iIncDec + SelectFlxGridRow(0, flxDemandHistory, i)
'      Next i
'      ConfigFlxGrid flxChildDemands
'
'      szLastIDClicked = flxDemandHistory.TextMatrix(flxDemandHistory.Rows - 1, 1)
'      Call FillChildinGrid(szLastIDClicked, flxChildDemands)
'      fraDetails.Caption = "Demand Details: " & szLastIDClicked
'      iSelectedDemandsRow = flxDemandHistory.Rows - 1
    ShowMsgInTaskBar "System has selected:  " & j & " invoices.", "Y", "P"
   Else
   

        For i = 1 To flxDemandHistory.Rows - 1
            flxDemandHistory.TextMatrix(i, 0) = ""
        Next i
'      ClearGridSelection
'      Exit Sub
'
'      For i = 1 To flxDemandHistory.Rows - 1
'         Call SelectFlxGridRow(0, flxDemandHistory, i)
'      Next i
'      iIncDec = 0
'      ConfigFlxGrid flxChildDemands
'      szLastIDClicked = ""
'      fraDetails.Caption = "Demand Details: " & szLastIDClicked
'      iSelectedDemandsRow = 0
   End If
End Sub

Private Sub chkSelectAllDemands_Click()
    Dim iRow As Integer, i As Integer

   If chkSelectAllDemands.Value Then
      For i = 1 To flxDemands.Rows - 1
         flxDemands.TextMatrix(i, 0) = "X"
      Next i
'      For i = 1 To flxDemands.Rows - 1
'         iIncDec = iIncDec + SelectFlxGridRow(0, flxDemands, i)
'      Next i
'      ConfigFlxGrid flxChildDemands
'
'      szLastIDClicked = flxDemands.TextMatrix(flxDemands.Rows - 1, 1)
'      Call FillChildinGrid(szLastIDClicked, flxChildDemands)
'      fraDetails.Caption = "Demand Details: " & szLastIDClicked
'      iSelectedDemandsRow = flxDemands.Rows - 1
   Else
      For i = 1 To flxDemands.Rows - 1
         flxDemands.TextMatrix(i, 0) = ""
      Next i
'      ClearGridSelection
'      Exit Sub
'
'      For i = 1 To flxDemands.Rows - 1
'         Call SelectFlxGridRow(0, flxDemands, i)
'      Next i
'      iIncDec = 0
'      ConfigFlxGrid flxChildDemands
'      szLastIDClicked = ""
'      fraDetails.Caption = "Demand Details: " & szLastIDClicked
'      iSelectedDemandsRow = 0
   End If
End Sub

Private Sub chkSO_Click()
'    If chkSO.Value = True Then
'        cboFreq.ListIndex = 0
'    Else
'        cboFreq.ListIndex = -1
'    End If
     If chkSO.Value = True Then
        cmdFreq.Enabled = True
        
     Else
        cmdFreq.Enabled = False
        txtFreq.text = ""
        txtFreq.Tag = ""
     End If

End Sub

Private Sub chkSO_KeyPress(KeyAscii As MSForms.ReturnInteger)
    If KeyAscii = 13 Then
        FocusControl cmdFreq
        'cmdFreq.SetFocus
    End If
    
End Sub



Private Sub cmbRptAmtType_GotFocus()
    If Trim(txtTenantID.text) = "" Then
       MsgBox "Please select a lessee.", vbExclamation + vbOKOnly, "Please select a lessee"
       FocusControl cmdTenantLookup
       Exit Sub
    End If
     If txtBankAc.text = "" Then
        MsgBox "Please select a bank account.", vbCritical + vbOKOnly, "Please select a bank account."
        cmdBankAc.Enabled = True
        FocusControl cmdBankAc
      Exit Sub
   End If
End Sub

Private Sub cmbRptHistory_Change()
        Dim adoConn As New ADODB.Connection
        adoConn.Open getConnectionString
        If tabDmdRcpt.Tab = 2 And tabPayment.Tab = 1 Then
            loadflxReceiptHistory adoConn, ""
        End If
        adoConn.Close
        Set adoConn = Nothing
End Sub

Private Sub cmdAddNewLine_KeyDown(KeyCode As Integer, Shift As Integer)
    If KeyCode = vbKeyDown Then
        cmdSaveNew.SetFocus
    End If
End Sub

Private Sub cmdAdvanceProgr_Click()
     Dim adoConn As New ADODB.Connection
     adoConn.Open getConnectionString
     adoConn.Execute "Update DemandSplitRecords DS,tlbReceipt R,Units U set DS.ReportClientID=R.ClientID,DS.ReportPropertyID=U.PropertyID,DS.ReportSAGEAC=R.SageAccountNumber," & _
                    "DS.ReportTransactionID=R.TransactionID,DS.ReportTransactionNo=switch (Type= 1 , 'SI'&slnumber  , Type= 2, 'SC'&slnumber  )  where " & _
                    "U.UnitNumber=R.UnitID and DS.DemandID=R.DemandRef"

    adoConn.Close
    MsgBox "ClientID updated in DemandSplitRecords table"
End Sub

Private Sub cmdAmendInfo_Click()
        Dim iCount As Integer
        Dim adoConn As New ADODB.Connection
        Dim szID As String
        If flxChildDemands.TextMatrix(iCount, 8) = "" Or flxChildDemands.TextMatrix(iCount, 9) = "" Or flxChildDemands.TextMatrix(iCount, 10) = "" Or flxChildDemands.TextMatrix(iCount, 7) = "" Then Exit Sub
        adoConn.Open getConnectionString
        For iCount = 1 To flxChildDemands.Rows - 1
                 szID = flxChildDemands.TextMatrix(iCount, 0)
                 adoConn.Execute "Update DemandSplitRecords T set Description='" & flxChildDemands.TextMatrix(iCount, 7) & " '" & _
                 " ,DateFrom=#" & Format(flxChildDemands.TextMatrix(iCount, 8), "dd MMM yyyy") & " #" & _
                 " ,DateTo=#" & Format(flxChildDemands.TextMatrix(iCount, 9), "dd MMM yyyy") & " #" & _
                 " ,DueDate=#" & Format(flxChildDemands.TextMatrix(iCount, 10), "dd MMM yyyy") & " #" & _
                 " where T.DSR='" & szID & "' "
               
        Next
    adoConn.Close
    Set adoConn = Nothing
    MsgBox "Record has been updated"
     flxChildDemands.ScrollBars = flexScrollBarHorizontal
    ' flxChildDemands.ScrollBars = flexScrollBarVertical
     flxChildDemands.Refresh
End Sub

Private Sub cmdAmountType_Click()
    On Error GoTo Err
    strCommandSource = "21"
    Label20(17).Caption = "Receipt Type"
    Dim adoConn As New ADODB.Connection
    adoConn.Open getConnectionString
    loadReceiptType "RECEIPT AMOUNT TYPE", adoConn
    adoConn.Close
    Set adoConn = Nothing
   
    picRecieptType.Left = 4770
    picRecieptType.Top = 1305
    picRecieptType.Visible = True
    picRecieptType.ZOrder 0
    FocusControl flxReceiptType
    If flxReceiptType.Rows > 1 And flxReceiptType.row = 0 Then
        flxReceiptType.row = 1
    End If
    tabPayment.Enabled = False
    tabDmdRcpt.Enabled = False
    Exit Sub
Err:
End Sub

Private Sub cmdAttachOK_Click()
     attachmentframePlayed = True
     Frame17(0).Visible = False
     cmdEmailDmds_Click
End Sub

Private Sub cmdAutoAllocSel_MouseMove(Button As Integer, Shift As Integer, X As Single, Y As Single)
     Me.MousePointer = vbArrow
End Sub

Private Sub cmdAutomatic_MouseMove(Button As Integer, Shift As Integer, X As Single, Y As Single)
    MousePointer = vbArrow
End Sub

Private Sub cmdBankAc_Click()
    strCommandSource = "20"
    txtTenantSearchID.text = ""
    picClient.Left = 915
    picClient.Top = 1350
    Call LoadflxBankAC
    tabDmdRcpt.Enabled = False
    picClient.Visible = True
    txtSearchClientID.SetFocus
     
End Sub

Private Sub cmdClientFilterMainList_Click(Index As Integer)
    If Index = 0 Then 'filtering main list by client by anol 2023-08-25
        strCommandSource = "3"
        picClient.Left = 1530
        picClient.Top = 585
        Call LoadflxClient
        tabDmdRcpt.Enabled = False
        picClient.Visible = True
        txtSearchClientID.SetFocus
      End If
      If Index = 1 Then 'filtering main list by Property by anol 2023-08-25
            picClient.Left = 5945 - 2685 + 1530
            picClient.Top = 585
            strCommandSource = "4"
            LoadPropertyList
            tabDmdRcpt.Enabled = False
            picClient.Visible = True
            txtSearchClientID.SetFocus
      End If
      If Index = 2 Then 'filtering main list by Invoice type by anol 2023-08-25
            strCommandSource = "22"
            Label20(17).Caption = "Invoice Type"
            Call loadInvoiceType
            picRecieptType.Left = 7200
            picRecieptType.Top = 585
            picRecieptType.Visible = True
            picRecieptType.ZOrder 0
            FocusControl flxReceiptType
      End If
      If Index = 3 Then 'filtering main list by Unit by anol 2023-08-25
            picClient.Left = 8400 - 2685 + 1530
            picClient.Top = 585
            strCommandSource = "15"
            LoadUnitList
            tabDmdRcpt.Enabled = False
            picClient.Visible = True
            txtSearchClientID.SetFocus
      End If
      If Index = 4 Then 'filtering main list by Lessee by anol 2023-08-25
            picClient.Left = 10965 - 2685
            picClient.Top = 585
            strCommandSource = "16"
            LoadLesseeList
            tabDmdRcpt.Enabled = False
            picClient.Visible = True
            txtSearchClientID.SetFocus
      End If
     
End Sub

Private Sub cmdClinetAddAtch_Click()
   Dim ofn As OPENFILENAME
   Dim lHwnd As Long
   Const HKEY_LOCAL_MACHINE As Long = &H80000002
   Dim szOldFile_PathName As String
   Dim szNewFile_Path As String, szNewFile_Name As String, szNewFile_PathName As String
   Dim fso As Object, adoConn As New ADODB.Connection

   ofn.lStructSize = Len(ofn)
   ofn.hwndOwner = lHwnd
   ofn.hInstance = App.hInstance
   ofn.lpstrFilter = "All Files (*.*)" + Chr$(0) + "*.*" + Chr$(0)
   ofn.lpstrFile = Space$(254)
   ofn.nMaxFile = 255
   ofn.lpstrFileTitle = Space$(254)
   ofn.nMaxFileTitle = 255
   ofn.lpstrInitialDir = CurDir
   ofn.lpstrTitle = "Select File to attach"
   ofn.Flags = 0
   Dim j As Integer
   Dim iRow As Integer
   If GetOpenFileName(ofn) = 0 Then Exit Sub

'   If cmbFiles.ListCount > 0 Then
'        ReDim Preserve DataAttach(2, cmbFiles.ListCount) As String
'   End If
'
'
'    For j = 0 To 2
'        If j = 0 Then
'            DataAttach(0, cmbFiles.ListCount) = ofn.lpstrFileTitle
'        ElseIf j = 1 Then
'            DataAttach(1, cmbFiles.ListCount) = ofn.lpstrFile
'        ElseIf j = 2 Then
'            DataAttach(2, cmbFiles.ListCount) = "c"
'        End If
'    Next j
'
'   cmbFiles.Column = DataAttach()
'   If UBound(DataAttach, 2) >= 0 Then
'          cmbFiles.ListIndex = UBound(DataAttach, 2)
'   End If
   iRow = flxAttachment.Rows - 1
   flxAttachment.Cols = 3
   flxAttachment.ColWidth(0) = 250
   flxAttachment.ColWidth(1) = 2000
   flxAttachment.ColWidth(2) = 4500
   If iRow > 1 Or flxAttachment.TextMatrix(iRow, 1) <> "" Then
     flxAttachment.AddItem ""
     iRow = iRow + 1
   End If
   
   flxAttachment.TextMatrix(iRow, 1) = ofn.lpstrFileTitle
   flxAttachment.TextMatrix(iRow, 2) = ofn.lpstrFile
    
   If flxAttachment.Rows > 1 Then
        attachmentframePlayed = True
   End If
End Sub

Private Sub cmdCloseAttcah_Click()
     attachmentframePlayed = False
     Frame17(0).Visible = False
End Sub

Private Sub cmdCloseSearch_Click()
    fraSearch.Visible = False
End Sub

Private Sub cmdDeleteFile_Click()
    Dim rCount As Integer
    Dim iSelectedattachRow As Integer
   iSelectedattachRow = 0
   For rCount = 1 To flxAttachment.Rows - 1
        If flxAttachment.TextMatrix(rCount, 0) = "X" Then
            iSelectedattachRow = iSelectedattachRow + 1
        End If
   Next
   If iSelectedattachRow = 0 Then
        MsgBox "Please select a file to remove", vbInformation, "Warning"
        Exit Sub
   End If
   
       Dim i As Integer
'       If cmbFiles.text = "" Then Exit Sub
'
'        For i = cmbFiles.ListIndex + 1 To UBound(DataAttach, 2)
'            DataAttach(0, i - 1) = DataAttach(0, i)
'            DataAttach(1, i - 1) = DataAttach(1, i)
'            DataAttach(2, i - 1) = DataAttach(2, i)
'        Next
'        If UBound(DataAttach, 2) > 0 Then
'            ReDim Preserve DataAttach(2, UBound(DataAttach, 2) - 1)
'        End If
'        cmbFiles.Column() = DataAttach()
'        cmbFiles.text = ""
'        If UBound(DataAttach, 2) > 0 Then
'            cmbFiles.ListIndex = 0
'        End If
       For i = 1 To flxAttachment.Rows - 1
               If flxAttachment.TextMatrix(flxAttachment.row, 0) = "X" Then
                        flxAttachment.RemoveItem flxAttachment.row
              End If
       Next i
       If flxAttachment.Rows = 1 Then
            flxAttachment.Rows = 2
       End If

End Sub

Private Sub cmdDReceiptHistSearch_Click()
    fraSearch.Top = 5310
    fraSearch.Left = 4905
    Dim adoConn As New ADODB.Connection
    adoConn.Open getConnectionString
    txtSearchNo.text = ""
    txtSearchRef.text = ""
    txtSearchFromD.text = ""
    txtSearchToD.text = ""
    If cmdDReceiptHistSearch.Caption = "Clear Sea&rch" Then
        LoadFlxGrid flxDemandHistory, True, adoConn, ""  'True - uploading history records
        ConfigFlxGrid flxChildDemandHistory
        cmdDReceiptHistSearch.Caption = "Sea&rch"
        fraSearch.Visible = False
    Else
        If fraSearch.Visible = False Then
            fraSearch.Visible = True
            txtSearchNo.SetFocus
        Else
            fraSearch.Visible = False
        End If
    End If
    
    adoConn.Close
End Sub

Private Sub cmdFreq_Click()
    picClient.Left = 7265
    picClient.Top = 1475
    strCommandSource = 19
    If chkSO.Value = 0 Then Exit Sub
    LoadFrequency
    picClient.Visible = True
    tabDmdRcpt.Enabled = False
    txtSearchClientID.SetFocus
    
End Sub

Private Sub cmdFund_Click()
    picClient.Left = 2715
    picClient.Top = 1740
    
    If txtTenantName.text = "" Then Exit Sub
    strCommandSource = "12"
'    Dim temp()  As String
    Dim adoConn As New ADODB.Connection
    adoConn.Open getConnectionString
    Call LoadFunds(adoConn)
    adoConn.Close
    picClient.Visible = True
    tabDmdRcpt.Enabled = False
    txtSearchClientID.SetFocus
End Sub

Private Sub cmdJob_Click()
    picClient.Left = 6715
    picClient.Top = 1740
    
    If txtTenantName.text = "" Then Exit Sub
    strCommandSource = "13"
    Dim adoConn As New ADODB.Connection
    adoConn.Open getConnectionString
    Call LoadJobs(adoConn)
    adoConn.Close
    tabDmdRcpt.Enabled = False
    picClient.Visible = True
    txtSearchClientID.SetFocus
End Sub

Private Sub cmdLesseeListHist_Click()
    picClient.Left = 7100
    picClient.Top = 270

    strCommandSource = "18"
    LoadLesseeListHist
    tabDmdRcpt.Enabled = False
    picClient.Visible = True
    txtSearchClientID.SetFocus
End Sub

Private Sub cmdLesselist_Click()
    picClient.Left = 10965 - 2685
    picClient.Top = 585
    strCommandSource = "16"
    LoadLesseeList
    tabDmdRcpt.Enabled = False
    picClient.Visible = True
    txtSearchClientID.SetFocus
End Sub



Private Sub cmdOpenFile_Click()
    On Error GoTo Err
    Dim rCount As Integer
    Dim iSelectedattachRow As Integer
   iSelectedattachRow = 0
   For rCount = 1 To flxAttachment.Rows - 1
        If flxAttachment.TextMatrix(rCount, 0) = "X" Then
            iSelectedattachRow = iSelectedattachRow + 1
        End If
   Next
   If iSelectedattachRow = 0 Then
        MsgBox "Please select a file to open", vbInformation, "Warning"
        Exit Sub
   End If
    Dim i As Integer
'    Call OpenFile(FileName_FilePath(cmbFiles.Column(1)), FileName_FilePath(cmbFiles.Column(1)))
        For i = 1 To flxAttachment.Rows - 1
               If flxAttachment.TextMatrix(i, 0) = "X" Then
                        Call OpenFile(FileName_FilePath(flxAttachment.TextMatrix(i, 2)), FileName_FilePath(flxAttachment.TextMatrix(i, 2)))
              End If
       Next i
     Exit Sub
Err:
    MsgBox Err.description
End Sub

Private Sub cmdPicCLose_MouseMove(Button As Integer, Shift As Integer, X As Single, Y As Single)
    MousePointer = vbArrow
End Sub

Private Sub cmdReceiptTypeClose_Click()
    picRecieptType.Visible = False
    tabPayment.Enabled = True
    tabDmdRcpt.Enabled = True
End Sub

Private Sub cmdSearch_Click()
    fraSearch.Top = 5760
    fraSearch.Left = 1535
    Dim adoConn As New ADODB.Connection
    adoConn.Open getConnectionString
'    txtSearchNo.text = ""
'    txtSearchRef.text = ""
    txtSearchFromD.text = ""
    txtSearchToD.text = ""
    If cmdSearch.Caption = "Clear Sea&rch" Then
'         LoadFlxGrid flxDemands, False, adoconn, ""       'False - uploading history, which are already posted and printed and exported to sage
         Call cmdSearchCancel_Click
         txtSearchNo.text = ""
         txtSearchRef.text = ""
         ConfigFlxGrid flxChildDemands
'         fmeLoading.Visible = False
         cmdSearch.Caption = "Sea&rch"
         fraSearch.Visible = False
    Else
        If fraSearch.Visible = False Then
            'cmdSearch.Caption = "Clear &Search"
            fraSearch.Visible = True
            txtSearchNo.SetFocus
        Else
           ' cmdSearch.Caption = "Sea&rch"
            fraSearch.Visible = False
        End If
    End If
    
    adoConn.Close
End Sub

Private Sub cmdSearchCancel_Click()
    txtSearchFromD.text = ""
    txtSearchToD.text = ""
    txtSearchRef.text = ""
    
    Dim adoConn As New ADODB.Connection
    If tabDmdRcpt.Tab = 0 Then
        fraSearch.Visible = False
        adoConn.Open getConnectionString
        If cmdSearch.Caption = "Clear Sea&rch" Then
             cmdSearch.Caption = "Sea&rch"
        End If
        If Trim(txtSearchNo.text) = "" And Trim(txtSearchRef.text) = "" And Trim(txtSearchFromD.text) = "" And Trim(txtSearchToD.text) = "" Then
        Else
             'LoadFlxGrid flxDemands, False, adoConn, ""
              LoadFlxDemands adoConn, ""
        End If
        adoConn.Close
    ElseIf tabDmdRcpt.Tab = 1 Then
        fraSearch.Visible = False
        adoConn.Open getConnectionString
        If cmdSearch.Caption = "Clear Sea&rch" Then
             cmdDReceiptHistSearch.Caption = "Sea&rch"
        End If
        If Trim(txtSearchNo.text) = "" And Trim(txtSearchRef.text) = "" And Trim(txtSearchFromD.text) = "" And Trim(txtSearchToD.text) = "" Then
        Else
             LoadFlxGrid flxDemandHistory, True, adoConn, ""
        End If
        adoConn.Close
    ElseIf tabDmdRcpt.Tab = 2 Then
         fraSearch.Visible = False
        adoConn.Open getConnectionString
        If cmdSearch.Caption = "Clear Sea&rch" Then
             cmdDReceiptHistSearch.Caption = "Sea&rch"
        End If
        If Trim(txtSearchNo.text) = "" And Trim(txtSearchRef.text) = "" And Trim(txtSearchFromD.text) = "" And Trim(txtSearchToD.text) = "" Then
        Else
            'load  demand receipt history
            loadflxReceiptHistory adoConn, ""
        End If
        adoConn.Close
    End If
End Sub

Private Sub cmdSearchLesseReceipthistory_Click()
    fraSearch.Top = 5310
    fraSearch.Left = 4905
    Dim adoConn As New ADODB.Connection
    adoConn.Open getConnectionString
    txtSearchNo.text = ""
    txtSearchRef.text = ""
    txtSearchFromD.text = ""
    txtSearchToD.text = ""
    If cmdSearchLesseReceipthistory.Caption = "Clear Sea&rch" Then
        loadflxReceiptHistory adoConn, ""  'True - uploading history records
        cmdSearchLesseReceipthistory.Caption = "Sea&rch"
        fraSearch.Visible = False
    Else
        If fraSearch.Visible = False Then
            fraSearch.Visible = True
            txtSearchNo.SetFocus
        Else
            fraSearch.Visible = False
        End If
    End If
    adoConn.Close
End Sub

Private Sub cmdSearchOK_Click()
    fraSearch.Visible = False
    Dim adoConn As New ADODB.Connection
    If tabDmdRcpt.Tab = 0 Then
        adoConn.Open getConnectionString
        If Trim(txtSearchNo.text) = "" And Trim(txtSearchRef.text) = "" And Trim(txtSearchFromD.text) = "" And Trim(txtSearchToD.text) = "" Then
            'LoadFlxGrid flxDemands, False, adoConn, ""
            LoadFlxDemands adoConn, ""
            'fmeLoading.Visible = False      cmdSearch.Caption = "Sea&rch"
        ElseIf Trim(txtSearchNo.text) <> "" Then
            'do nothing
        ElseIf Trim(txtSearchRef.text) <> "" Then
            'do nothing
        ElseIf Trim(txtSearchFromD.text) <> "" And Trim(txtSearchToD.text) = "" Then
            LoadFlxGrid flxDemands, False, adoConn, "3"
            cmdSearch.Caption = "Clear Sea&rch"
        ElseIf Trim(txtSearchFromD.text) <> "" And Trim(txtSearchToD.text) <> "" Then
            cmdSearch.Caption = "Clear Sea&rch"
            LoadFlxGrid flxDemands, False, adoConn, "4"
        End If
        adoConn.Close
        Set adoConn = Nothing
    ElseIf tabDmdRcpt.Tab = 1 Then
         adoConn.Open getConnectionString
        If Trim(txtSearchNo.text) = "" And Trim(txtSearchRef.text) = "" And Trim(txtSearchFromD.text) = "" And Trim(txtSearchToD.text) = "" Then
            LoadFlxGrid flxDemandHistory, True, adoConn, ""
            cmdSearch.Caption = "Sea&rch"
        ElseIf Trim(txtSearchNo.text) <> "" Then
            'do nothing
        ElseIf Trim(txtSearchRef.text) <> "" Then
            'do nothing
        ElseIf Trim(txtSearchFromD.text) <> "" And Trim(txtSearchToD.text) = "" Then
            LoadFlxGrid flxDemandHistory, True, adoConn, "3"
            cmdDReceiptHistSearch.Caption = "Clear Sea&rch"
        ElseIf Trim(txtSearchFromD.text) <> "" And Trim(txtSearchToD.text) <> "" Then
            cmdDReceiptHistSearch.Caption = "Clear Sea&rch"
            LoadFlxGrid flxDemandHistory, True, adoConn, "4"
        End If
        adoConn.Close
        Set adoConn = Nothing
     ElseIf tabDmdRcpt.Tab = 2 Then
         adoConn.Open getConnectionString
        If Trim(txtSearchNo.text) = "" And Trim(txtSearchRef.text) = "" And Trim(txtSearchFromD.text) = "" And Trim(txtSearchToD.text) = "" Then
            loadflxReceiptHistory adoConn, ""
            cmdSearchLesseReceipthistory.Caption = "Sea&rch"
        ElseIf Trim(txtSearchNo.text) <> "" Then
            'do nothing
        ElseIf Trim(txtSearchRef.text) <> "" Then
            'do nothing
        ElseIf Trim(txtSearchFromD.text) <> "" And Trim(txtSearchToD.text) = "" Then
            loadflxReceiptHistory adoConn, "3"
            cmdSearchLesseReceipthistory.Caption = "Clear Sea&rch"
        ElseIf Trim(txtSearchFromD.text) <> "" And Trim(txtSearchToD.text) <> "" Then
            cmdSearchLesseReceipthistory.Caption = "Clear Sea&rch"
            loadflxReceiptHistory adoConn, "4"
        End If
        adoConn.Close
        Set adoConn = Nothing
    End If
    
End Sub





Private Sub Command1_Click()
   Dim adoConn As New ADODB.Connection
   Dim i As Integer, szMY_ID As String
   Dim rep As frmReport
   Dim reportApp As New CRAXDRT.Application
   Dim Report As CRAXDRT.Report

   
   
   
   Set Report = reportApp.OpenReport(App.Path & szReportPath & "\ReceiptAllocation.rpt")
   Report.Database.Tables(1).ConnectionProperties.Item("Database Password") = accessDBPws

   Report.EnableParameterPrompting = False
   Report.DiscardSavedData
 

   Set rep = New frmReport
   Load rep
   rep.LoadReportViewer Report
End Sub

Private Sub Command3_Click()

End Sub

Private Sub flxAttachment_Click()
     If flxAttachment.TextMatrix(flxAttachment.row, 0) = "X" Then
           flxAttachment.TextMatrix(flxAttachment.row, 0) = ""
     ElseIf flxAttachment.TextMatrix(flxAttachment.row, 1) <> "" Then
           flxAttachment.TextMatrix(flxAttachment.row, 0) = "X"
     End If
End Sub



Private Sub flxReceiptHistory_Click()
'    If flxReceiptHistory.col > 1 Then
'        flxReceiptHistory.SelectionMode = 1
'     Else
'         flxReceiptHistory.SelectionMode = 0
'     End If
  If flxReceiptHistory.TextMatrix(flxReceiptHistory.row, 16) = "" Then Exit Sub
    Call SquezeExpand
    Dim szSQL As String, iRow As Integer
        Dim adoConn As New ADODB.Connection
        Dim adoRST As New ADODB.Recordset
        'Call SquezeExpand
'        If flxReceiptHistory.TextMatrix(flxReceiptHistory.row, 1) = "" And flxReceiptHistory.TextMatrix(flxReceiptHistory.row, 0) <> "" Then
'           flxReceiptHistory.TextMatrix(flxReceiptHistory.row, 1) = "X"
                
               If flxReceiptHistory.TextMatrix(flxReceiptHistory.row, 2) = "" Then Exit Sub
               adoConn.Open getConnectionString
            
            'FromTran  is receipt
            ' flxReceiptHistory.TextMatrix(flxReceiptHistory.row, 0) is the receipt header transaction ID
               szSQL = "SELECT DISTINCT T.DESCRIPTION, R.DemandRef, R.UnitID,R.ClientID, R.DDate, R.Details, " & _
                                       "R.Amount, R.OSAmount, RT.ReceiptAmount, R.RDate,RT.AllocDate, R.TransactionID, " & _
                                       "MID(T.CONSTANT, 4, LEN(T.CONSTANT)-3) AS PF, R.SlNumber " & _
                       "FROM RptTransactions AS RT, tlbTransactionTypes AS T, tlbReceipt AS R " & _
                       "Where RT.DeleteFlag=false and RT.FromTran = " & flxReceiptHistory.TextMatrix(flxReceiptHistory.row, 16) & " And " & _
                                       "RT.ToTran = R.TransactionID And R.Type = t.TYPE_ID " & _
                       "ORDER BY R.TransactionID;"
            '   Here we are loading child grid
            
               adoRST.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
               Call ConfigflxAllocation
              ' flxAllocation.Cols = 12
              ' flxAllocation.ColWidth(11) = 0
            
               iRow = 1
               While Not adoRST.EOF
                  flxAllocation.TextMatrix(iRow, 0) = adoRST.Fields.Item("TransactionID").Value
                  flxAllocation.TextMatrix(iRow, 2) = adoRST.Fields.Item("PF").Value & adoRST.Fields.Item("SlNumber").Value
                  flxAllocation.TextMatrix(iRow, 3) = adoRST.Fields.Item("DESCRIPTION").Value
                  flxAllocation.TextMatrix(iRow, 4) = adoRST.Fields.Item("ClientID").Value
                  flxAllocation.TextMatrix(iRow, 5) = adoRST.Fields.Item("UnitID").Value
                  flxAllocation.TextMatrix(iRow, 6) = adoRST.Fields.Item("DDate").Value
                  flxAllocation.TextMatrix(iRow, 7) = adoRST.Fields.Item("RDate").Value '20171107
                  flxAllocation.TextMatrix(iRow, 8) = adoRST.Fields.Item("AllocDate").Value
                  flxAllocation.TextMatrix(iRow, 9) = adoRST.Fields.Item("Details").Value
                  flxAllocation.TextMatrix(iRow, 10) = Format(adoRST.Fields.Item("Amount").Value, "0.00")
                  flxAllocation.TextMatrix(iRow, 11) = Format(adoRST.Fields.Item("OSAmount").Value, "0.00")
                  flxAllocation.TextMatrix(iRow, 12) = Format(adoRST.Fields.Item("ReceiptAmount").Value, "0.00")
            '      flxAllocation.TextMatrix(iRow, 11) = Format(adoRst.Fields.Item("Fund").Value, "0.00")
            
                  adoRST.MoveNext
                  If Not adoRST.EOF Then
                     iRow = iRow + 1
                     flxAllocation.AddItem ""
                  End If
               Wend
            
               adoRST.Close
               Set adoRST = Nothing
               adoConn.Close
'        Else
'           flxReceiptHistory.TextMatrix(flxReceiptHistory.row, 1) = ""
'           Call ConfigflxAllocation
'           'ConfigflxAllocation flxAllocation, 11, 9, 10
'        End If
End Sub
Private Sub ConfigflxAllocation()
    Dim iCol As Integer
    
    flxAllocation.Clear
    flxAllocation.Cols = 14
    flxAllocation.Rows = 2
    flxAllocation.RowHeight(0) = 0
    flxAllocation.FormatString = "|<No|<Type|<UnitID||<Date|<Ref|Details|>Amt"
    flxAllocation.ColWidth(0) = 0                                           'ID of the transactions
    flxAllocation.ColWidth(1) = 250 'Sign -> X
    'flxAllocation.ColWidth(2) = 250   'Sign ->, +, -
    flxAllocation.ColWidth(2) = 1200 'Label1(44).Left - Label19(43).Left
    flxAllocation.ColWidth(3) = 1200 'Label1(44).Left - Label19(43).Left
    flxAllocation.ColWidth(4) = 1200 'Label1(45).Left - Label19(44).Left
    flxAllocation.ColWidth(5) = 1200 'Label1(46).Left - Label19(45).Left
    flxAllocation.ColWidth(6) = 1400 'Label1(47).Left - Label19(46).Left
    flxAllocation.ColAlignment(6) = vbLeftJustify
    flxAllocation.ColWidth(7) = 1400 ''Label19(16).Left - Label19(15).Left
    flxAllocation.ColAlignment(7) = vbLeftJustify
    flxAllocation.ColWidth(8) = 1400 'Label1(48).Left - Label19(47).Left
    flxAllocation.ColAlignment(8) = vbLeftJustify
     flxAllocation.ColWidth(9) = 1400 'Label1(49).Left - Label19(48).Left
    flxAllocation.ColWidth(10) = 1400 ' Label1(50).Left - Label19(49).Left
    flxAllocation.ColWidth(11) = 1400
    flxAllocation.ColWidth(12) = 1400
    flxAllocation.ColWidth(12) = 0

End Sub
Private Sub flxReceiptHistory_DblClick()
        'issue 520
        'written by anol 20180212
        'this function shall edit SR and SA and SSR AND only zero values
        Dim adocon As New ADODB.Connection
        adocon.Open getConnectionString
        If Val(flxReceiptHistory.TextMatrix(flxReceiptHistory.row, 9)) > 0 Then Exit Sub
        If Val(flxReceiptHistory.TextMatrix(frmDemands3.flxReceiptHistory.row, 16)) = 0 Then Exit Sub
        'Code for Loading PPR,PP AND PA
        'If Left(flxReceiptHistory.TextMatrix(flxReceiptHistory.row, 2), 3) = "PPR" Then
        Load frmReceiptEdit
        With frmReceiptEdit
             'Debug.Print flxReceiptHistory.TextMatrix(flxReceiptHistory.row, 5)
             .Caption = .Caption & " Refund - " & flxReceiptHistory.TextMatrix(flxReceiptHistory.row, 2) 'Invoice ID
             .txtLessee.text = flxReceiptHistory.TextMatrix(flxReceiptHistory.row, 5)
             .txtLesseeName.text = flxReceiptHistory.TextMatrix(flxReceiptHistory.row, 10)
             .txtDate.text = flxReceiptHistory.TextMatrix(flxReceiptHistory.row, 3) 'RDate
             .lblRptPostingDate.ToolTipText = flxReceiptHistory.TextMatrix(flxReceiptHistory.row, 11)
             .txtAmount.text = Format(flxReceiptHistory.TextMatrix(flxReceiptHistory.row, 9), "0.00")
             .txtRef.text = flxReceiptHistory.TextMatrix(flxReceiptHistory.row, 8) 'ref
            
             .cmbFund.ListIndex = FindComboIndex(.cmbFund, flxReceiptHistory.TextMatrix(flxReceiptHistory.row, 13), 0)
             .txtDetails.text = flxReceiptHistory.TextMatrix(flxReceiptHistory.row, 10)
             .TransactionID = flxReceiptHistory.TextMatrix(frmDemands3.flxReceiptHistory.row, 16)
             .InvoiceNO = flxReceiptHistory.TextMatrix(flxReceiptHistory.row, 2)
             If flxReceiptHistory.TextMatrix(flxReceiptHistory.row, 17) <> "" Then
                 .BoolReconciled = True
             End If
             
             If flxReceiptHistory.TextMatrix(flxReceiptHistory.row, 15) <> "" Then
                .txtClient.text = flxReceiptHistory.TextMatrix(flxReceiptHistory.row, 15)
               ' .txtClient.Tag = txtRptClientList.Tag
             End If
             .LoadBank_Fund_amtType adocon
             .LoadFlxReceiptSplit adocon
             .cmbBankAc.ListIndex = FindComboIndex(.cmbBankAc, flxReceiptHistory.TextMatrix(flxReceiptHistory.row, 4), 0)
             .cmbRptAmtType.ListIndex = FindComboIndex(.cmbRptAmtType, flxReceiptHistory.TextMatrix(flxReceiptHistory.row, 14), 0)  'receiptAmtType
             adocon.Close
        End With
        frmReceiptEdit.Left = 100
        frmReceiptEdit.Top = 100
        frmReceiptEdit.Show
        
End Sub

Private Sub flxReceiptType_Click()
    If strCommandSource = "21" Then
        txtRcptAmtType.Tag = flxReceiptType.TextMatrix(flxReceiptType.row, 1)
        txtRcptAmtType.text = flxReceiptType.TextMatrix(flxReceiptType.row, 2)
        picRecieptType.Visible = False
        tabPayment.Enabled = True
        tabDmdRcpt.Enabled = True
        FocusControl txtSPaymentTotal
    End If
    
    If strCommandSource = "22" Then
        txtInvoiceType.text = flxReceiptType.TextMatrix(flxReceiptType.row, 1)
        txtInvoiceType.Tag = flxReceiptType.TextMatrix(flxReceiptType.row, 2)
        picRecieptType.Visible = False
        Dim adoConn As New ADODB.Connection
        adoConn.Open getConnectionString
        LoadFlxGrid flxDemands, False, adoConn, ""
        adoConn.Close
        tabPayment.Enabled = True
        tabDmdRcpt.Enabled = True
        FocusControl flxDemands
   End If
End Sub

Private Sub flxReceiptType_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
        flxReceiptType_Click
    End If
End Sub

Private Sub flxSPayment_RowColChange()
    Dim adoConn As New ADODB.Connection
    Dim rsLockDialog As New ADODB.Recordset
    Dim selcol As Integer
    Dim selRow As Integer
    Dim strSQL As String
    Dim colTransactionIDHere As String
    Dim i As Integer
    selcol = flxSPayment.col
    selRow = flxSPayment.row
    If Len(colTransactionIDOtherPayGrid) > 0 Then ' This procedure is only for unlock the record on each cell browsing written by anol 20190412
      'colTransactionIDOtherPayGrid varibale contains the transaction ID that is locked by other screen
        adoConn.Open getConnectionString
        strSQL = "Select DateTimeStamp ,UserSessionID,TransactionID " & _
               "from tlbReceipt as Pt  where  (UserSessionID='' or isnull(UserSessionID)) AND TransactionID in (" & colTransactionIDOtherPayGrid & ")" 'UserSessionID='' or isnull(UserSessionID)
        rsLockDialog.Open strSQL, adoConn, adOpenStatic, adLockReadOnly 'Selecting those transaction which has been unlocked in the background with out knowing this form
        
        While Not rsLockDialog.EOF
                flxSPayment.col = 0
                For i = 1 To flxSPayment.Rows - 1
                    If flxSPayment.TextMatrix(i, 19) = rsLockDialog("TransactionID").Value Then
                          flxSPayment.row = i
                          flxSPayment.CellBackColor = vbWhite
                          'now you need to lock it for this screen
                           colTransactionIDHere = colTransactionIDHere & flxSPayment.TextMatrix(i, 19) & ","
                          
                    End If
                 Next i
              rsLockDialog.MoveNext
        Wend
        flxSPayment.col = selcol
        flxSPayment.row = selRow
       
        If Len(colTransactionIDHere) > 0 Then 'UserSessionID<>'" & UserSessionID & "' and
            colTransactionIDHere = Left(colTransactionIDHere, Len(colTransactionIDHere) - 1)
        End If
        If Len(colTransactionIDHere) > 0 Then
            'again locking those records for current screen
            adoConn.Execute "Update tlbReceipt Set  DateTimeStamp='" & Now & "',Module='Demand Receipt',UserSessionID='" & UserSessionID & "',WindowsUserName='" & _
                           SystemUser & "',MachineName='" & WS_Name & "'," & _
                           "PrestigeUserName='" & User & "',ServerIPaddress='" & GetIPaddress & "' where TransactionID in  (" & colTransactionIDHere & ")"
        End If
        rsLockDialog.Close
        Set rsLockDialog = Nothing
        adoConn.Close
        Set adoConn = Nothing
    End If
End Sub



Private Sub picLeaseList_MouseMove(Button As Integer, Shift As Integer, X As Single, Y As Single)
     MousePointer = vbArrow
End Sub







Private Sub txtAllocationDAte_LostFocus()
    If txtAllocationDAte.text <> "" Then
      If TextBoxFormatDate(txtAllocationDAte) Then
      End If
    End If
End Sub

Private Sub txtArray_Change(Index As Integer)
    If Index = 2 Then
        Dim adoConn As New ADODB.Connection
        adoConn.Open getConnectionString
        adoConn.Execute "Update ShoppingCentre set MaxReceiptHist=" & Val(txtArray(2).text) & ""
        adoConn.Close
        Set adoConn = Nothing
    End If
End Sub

Private Sub txtArray_KeyPress(Index As Integer, KeyAscii As Integer)
    If Index = 2 Then
        Dim adoConn As New ADODB.Connection
        If KeyAscii = 13 Then
            adoConn.Open getConnectionString
            'adoConn.Execute "Update ShoppingCentre set MaxReceiptHist=" & Val(txtMaxReceiptHist.text) & ""
            loadflxReceiptHistory adoConn, ""
            adoConn.Close
            Set adoConn = Nothing
        End If
        DigitTextKeyPress txtArray(2), KeyAscii
    End If
End Sub

Private Sub txtBankAc_KeyPress(KeyAscii As MSForms.ReturnInteger)
    If KeyAscii = 13 Then
        FocusControl cmdBankAc
    End If
End Sub

Private Sub txtBankCode_KeyPress(KeyAscii As MSForms.ReturnInteger)
    If KeyAscii = 13 Then
        FocusControl txtBankAc
    End If
End Sub

Private Sub txtDisplayMaxDemandHist_Change()
        Dim adoConn As New ADODB.Connection
        adoConn.Open getConnectionString
        adoConn.Execute "Update ShoppingCentre set MaxDemandHist=" & Val(txtArray(9).text) & ""
        adoConn.Close
        Set adoConn = Nothing
End Sub

Private Sub txtDisplayMaxDemandHist_KeyPress(KeyAscii As Integer)
        Dim adoConn As New ADODB.Connection
        If KeyAscii = 13 Then
            adoConn.Open getConnectionString
            'load demand hist
            LoadFlxGrid flxDemandHistory, True, adoConn, ""  'True - uploading history records
            ConfigFlxGrid flxChildDemandHistory
            adoConn.Close
            Set adoConn = Nothing
         End If
         DigitTextKeyPress txtArray(9), KeyAscii
End Sub

Private Sub txtMaxReceiptHist_Change()
        
End Sub

Private Sub txtMaxReceiptHist_KeyPress(KeyAscii As Integer)
'        Dim adoconn As New ADODB.Connection
'        If KeyAscii = 13 Then
'            adoconn.Open getConnectionString
'            'adoConn.Execute "Update ShoppingCentre set MaxReceiptHist=" & Val(txtMaxReceiptHist.text) & ""
'            loadflxReceiptHistory adoconn, ""
'            adoconn.Close
'            Set adoconn = Nothing
'        End If
'        DigitTextKeyPress txtArray(2), KeyAscii
End Sub

Private Sub txtReceiptReference_GotFocus()
    'issue 571 Validation
   'Added by anol 20 May 2015
   Dim adoRST As New ADODB.Recordset
   Dim szSQL As String
   Dim tempstr As String
   Dim adoConn As New ADODB.Connection
   If Trim(txtTenantID.text) = "" Then
      MsgBox "Please select a lessee.", vbExclamation + vbOKOnly, "Please select a lessee"
      FocusControl cmdTenantLookup
      Exit Sub
   End If
   If txtBankAc.text = "" And chkApplyFund.Value = False Then
      MsgBox "Please select a bank account.", vbCritical + vbOKOnly, "Please select a bank account."
      cmdBankAc.Enabled = True
      'cmbBankAc.SetFocus
      Exit Sub
   End If
   'we don't need this validation when we are implemeting grid
'   If Trim(cmbBankAc.text) <> "" Then
'        tempstr = Replace(cmbBankAc.text, "'", "''")
'        adoConn.Open getConnectionString
'        szSQL = "SELECT Name " & _
'                "FROM NominalLedger " & _
'                "where Name='" & tempstr & "';"
'        adoRst.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
'        If adoRst.EOF Then
'            tabDmdRcpt.Tab = 2
'            MsgBox "Please select a valid bank account", vbInformation, "Please select a bank account."
'            cmbBankAc.Enabled = True
'            cmbBankAc.text = ""
'            FocusControl cmbBankAc
'        End If
'        adoConn.Close
'        Set adoConn = Nothing
'    End If
End Sub

Private Sub txtSearchFromD_Change()
    TextBoxChangeDate txtSearchFromD
    txtSearchNo.text = ""
    txtSearchRef.text = ""
End Sub

Private Sub txtSearchFromD_GotFocus()
'    If Len(txtSearchFromD.text) < 10 Then txtSearchFromD.text = Format(Date, "dd/mm/yyyy")
    SelTxtInCtrl txtSearchFromD
End Sub

Private Sub txtSearchFromD_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
        cmdSearchOK.SetFocus
    End If
    TextBoxKeyPrsDate txtSearchFromD, KeyAscii
End Sub

Private Sub txtSearchFromD_LostFocus()
    If txtSearchFromD.text <> "" Then
        TextBoxFormatDate txtSearchFromD
        txtSearchToD.text = txtSearchFromD.text
        SelTxtInCtrl txtSearchToD
     End If
End Sub

Private Sub txtSearchNo_Change()
'    txtSearchFromD.text = ""
'    txtSearchToD.text = ""
'    txtSearchRef.text = ""
'    Dim adoConn As New ADODB.Connection
'    If tabDmdRcpt.Tab = 0 Then
'        adoConn.Open getConnectionString
'        If Len(txtSearchNo.text) > 0 Then
'            LoadFlxGrid flxDemands, False, adoConn, "1"
'        Else
'            LoadFlxGrid flxDemands, False, adoConn, ""       'False - uploading history, which are already posted and printed and exported to sage
'        End If
'    '    fmeLoading.Visible = False
'        adoConn.Close
'        Set adoConn = Nothing
'        If Len(txtSearchNo.text) > 0 Then
'            cmdSearch.Caption = "Clear Sea&rch"
'        Else
'            cmdSearch.Caption = "Sea&rch"
'        End If
'    ElseIf tabDmdRcpt.Tab = 1 Then
'        adoConn.Open getConnectionString
'        If Len(txtSearchNo.text) > 0 Then
'            LoadFlxGrid flxDemandHistory, True, adoConn, "1"
'        Else
'            LoadFlxGrid flxDemandHistory, True, adoConn, ""       'False - uploading history, which are already posted and printed and exported to sage
'        End If
'        adoConn.Close
'        Set adoConn = Nothing
'        If Len(txtSearchNo.text) > 0 Then
'            cmdDReceiptHistSearch.Caption = "Clear Sea&rch"
'        Else
'            cmdDReceiptHistSearch.Caption = "Sea&rch"
'        End If
'      ElseIf tabDmdRcpt.Tab = 2 Then
'        adoConn.Open getConnectionString
'        If Len(txtSearchNo.text) > 0 Then
'            loadflxReceiptHistory adoConn, "1"
'        Else
'            loadflxReceiptHistory adoConn, ""       'False - uploading history, which are already posted and printed and exported to sage
'        End If
'        adoConn.Close
'        Set adoConn = Nothing
'        If Len(txtSearchNo.text) > 0 Then
'            cmdSearchLesseReceipthistory.Caption = "Clear Sea&rch"
'        Else
'            cmdSearchLesseReceipthistory.Caption = "Sea&rch"
'        End If
'
'    End If
    
End Sub

Private Sub txtSearchNo_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
        txtSearchRef.SetFocus
        txtSearchFromD.text = ""
        txtSearchToD.text = ""
        txtSearchRef.text = ""
        Dim adoConn As New ADODB.Connection
        If tabDmdRcpt.Tab = 0 Then
            adoConn.Open getConnectionString
            If Len(txtSearchNo.text) > 0 Then
                LoadFlxGrid flxDemands, False, adoConn, "1"
            Else
               ' LoadFlxGrid flxDemands, False, adoConn, ""       'False - uploading history, which are already posted and printed and exported to sage
                LoadFlxDemands adoConn, ""
            End If
        '    fmeLoading.Visible = False
            adoConn.Close
            Set adoConn = Nothing
            If Len(txtSearchNo.text) > 0 Then
                cmdSearch.Caption = "Clear Sea&rch"
            Else
                cmdSearch.Caption = "Sea&rch"
            End If
        ElseIf tabDmdRcpt.Tab = 1 Then
            adoConn.Open getConnectionString
            If Len(txtSearchNo.text) > 0 Then
                LoadFlxGrid flxDemandHistory, True, adoConn, "1"
            Else
                LoadFlxGrid flxDemandHistory, True, adoConn, ""       'False - uploading history, which are already posted and printed and exported to sage
            End If
            adoConn.Close
            Set adoConn = Nothing
            If Len(txtSearchNo.text) > 0 Then
                cmdDReceiptHistSearch.Caption = "Clear Sea&rch"
            Else
                cmdDReceiptHistSearch.Caption = "Sea&rch"
            End If
          ElseIf tabDmdRcpt.Tab = 2 Then
            adoConn.Open getConnectionString
            If Len(txtSearchNo.text) > 0 Then
                loadflxReceiptHistory adoConn, "1"
            Else
                loadflxReceiptHistory adoConn, ""       'False - uploading history, which are already posted and printed and exported to sage
            End If
            adoConn.Close
            Set adoConn = Nothing
            If Len(txtSearchNo.text) > 0 Then
                cmdSearchLesseReceipthistory.Caption = "Clear Sea&rch"
            Else
                cmdSearchLesseReceipthistory.Caption = "Sea&rch"
            End If
            
        End If
    End If
End Sub

Private Sub txtSearchRef_Change()
'    txtSearchFromD.text = ""
'    txtSearchToD.text = ""
'    txtSearchNo.text = ""
'    Dim adoConn As New ADODB.Connection
'    If tabDmdRcpt.Tab = 0 Then
'        adoConn.Open getConnectionString
'        If Len(txtSearchRef.text) > 0 Then
'            LoadFlxGrid flxDemands, False, adoConn, "2"
'        Else
'            LoadFlxGrid flxDemands, False, adoConn, ""       'False - uploading history, which are already posted and printed and exported to sage
'        End If
'        'fmeLoading.Visible = False
'        adoConn.Close
'        Set adoConn = Nothing
'        If Len(txtSearchRef.text) > 0 Then
'             cmdSearch.Caption = "Clear Sea&rch"
'        Else
'             cmdSearch.Caption = "Sea&rch"
'        End If
'    ElseIf tabDmdRcpt.Tab = 1 Then
'        adoConn.Open getConnectionString
'        If Len(txtSearchRef.text) > 0 Then
'            LoadFlxGrid flxDemandHistory, True, adoConn, "2"
'        Else
'            LoadFlxGrid flxDemandHistory, True, adoConn, ""       'False - uploading history, which are already posted and printed and exported to sage
'        End If
'        adoConn.Close
'        Set adoConn = Nothing
'        If Len(txtSearchRef.text) > 0 Then
'            cmdDReceiptHistSearch.Caption = "Clear Sea&rch"
'        Else
'            cmdDReceiptHistSearch.Caption = "Sea&rch"
'        End If
'    ElseIf tabDmdRcpt.Tab = 2 Then
'        adoConn.Open getConnectionString
'        If Len(txtSearchRef.text) > 0 Then
'            loadflxReceiptHistory adoConn, "2"
'        Else
'            loadflxReceiptHistory adoConn, ""      'False - uploading history, which are already posted and printed and exported to sage
'        End If
'        adoConn.Close
'        Set adoConn = Nothing
'        If Len(txtSearchRef.text) > 0 Then
'            cmdSearchLesseReceipthistory.Caption = "Clear Sea&rch"
'        Else
'            cmdSearchLesseReceipthistory.Caption = "Sea&rch"
'        End If
'   End If
End Sub

Private Sub txtSearchRef_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
        txtSearchFromD.SetFocus
            txtSearchFromD.text = ""
         txtSearchToD.text = ""
         txtSearchNo.text = ""
         Dim adoConn As New ADODB.Connection
         If tabDmdRcpt.Tab = 0 Then
             adoConn.Open getConnectionString
             If Len(txtSearchRef.text) > 0 Then
                 LoadFlxGrid flxDemands, False, adoConn, "2"
             Else
                 'LoadFlxGrid flxDemands, False, adoConn, ""       'False - uploading history, which are already posted and printed and exported to sage
                  LoadFlxDemands adoConn, ""
             End If
             'fmeLoading.Visible = False
             adoConn.Close
             Set adoConn = Nothing
             If Len(txtSearchRef.text) > 0 Then
                  cmdSearch.Caption = "Clear Sea&rch"
             Else
                  cmdSearch.Caption = "Sea&rch"
             End If
         ElseIf tabDmdRcpt.Tab = 1 Then
             adoConn.Open getConnectionString
             If Len(txtSearchRef.text) > 0 Then
                 LoadFlxGrid flxDemandHistory, True, adoConn, "2"
             Else
                 LoadFlxGrid flxDemandHistory, True, adoConn, ""       'False - uploading history, which are already posted and printed and exported to sage
             End If
             adoConn.Close
             Set adoConn = Nothing
             If Len(txtSearchRef.text) > 0 Then
                 cmdDReceiptHistSearch.Caption = "Clear Sea&rch"
             Else
                 cmdDReceiptHistSearch.Caption = "Sea&rch"
             End If
         ElseIf tabDmdRcpt.Tab = 2 Then
             adoConn.Open getConnectionString
             If Len(txtSearchRef.text) > 0 Then
                 loadflxReceiptHistory adoConn, "2"
             Else
                 loadflxReceiptHistory adoConn, ""      'False - uploading history, which are already posted and printed and exported to sage
             End If
             adoConn.Close
             Set adoConn = Nothing
             If Len(txtSearchRef.text) > 0 Then
                 cmdSearchLesseReceipthistory.Caption = "Clear Sea&rch"
             Else
                 cmdSearchLesseReceipthistory.Caption = "Sea&rch"
             End If
        End If
    End If
End Sub

Private Sub txtSearchToD_Change()
     TextBoxChangeDate txtSearchToD
     txtSearchNo.text = ""
     txtSearchRef.text = ""
End Sub

Private Sub txtSearchToD_GotFocus()
'    If Len(txtSearchToD.text) < 10 Then txtSearchToD.text = Format(Date, "dd/mm/yyyy")
    SelTxtInCtrl txtSearchToD
End Sub

Private Sub txtSearchToD_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
        cmdSearchOK.SetFocus
    End If
    TextBoxKeyPrsDate txtSearchToD, KeyAscii
End Sub

Private Sub txtSearchToD_LostFocus()
    If txtSearchToD.text <> "" Then TextBoxFormatDate txtSearchToD
End Sub
Private Sub cmdUnitHist_Click()
    picClient.Left = 7100
    picClient.Top = 270

    strCommandSource = "17"
    LoadUnitListHist
    tabDmdRcpt.Enabled = False
    picClient.Visible = True
    txtSearchClientID.SetFocus
End Sub

'Private Sub cmdUnitList_Click()
'    picClient.Left = 8400 - 2685 + 1530
'    picClient.Top = 585
'
'    strCommandSource = "15"
'    LoadUnitList
'    tabDmdRcpt.Enabled = False
'    picClient.Visible = True
'    txtSearchClientID.SetFocus
'End Sub







Private Sub flxClient_KeyDown(KeyCode As Integer, Shift As Integer)
     If KeyCode = vbKeyUp And flxClient.row = 1 Then
        txtSearchClientID.SetFocus
     End If
End Sub

Private Sub flxCrPoA_MouseDown(Button As Integer, Shift As Integer, X As Single, Y As Single)
    If Button = 2 And Shift = 1 And cmdEditReceipt.Enabled Then
        sEditSRR = 2
        editexception = True
        MsgBox "Please ensure the total amount is unchanged after editing to ensure the Bank Reconciliation is unaffected and remains the same after editing", vbInformation, "Warning!!"
        cmdEditReceipt_Click
    End If
End Sub

Private Sub flxCrPoA_MouseMove(Button As Integer, Shift As Integer, X As Single, Y As Single)
'    MousePointer = vbArrow
    MousePointer = vbArrow
End Sub

Private Sub flxSPayment_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
        FocusControl cmdSPSave
    End If
End Sub

Private Sub flxSPayment_MouseDown(Button As Integer, Shift As Integer, X As Single, Y As Single)
    If Button = 2 And Shift = 1 And cmdEditReceipt.Enabled Then
'        MsgBox flxSPayment.TextMatrix(flxSPayment.row, 19)
        'if not allocated then only this set is possible else cannot edit this
        sEditSRR = 1
        If flxSPayment.row = 0 Then Exit Sub
        If Val(flxSPayment.TextMatrix(flxSPayment.row, 8)) - Val(flxSPayment.TextMatrix(flxSPayment.row, 9)) <> 0 And Val(flxSPayment.TextMatrix(flxSPayment.row, 8)) <> 0 Then
             MsgBox "You cannot edit a part allocated refund. Please unallocate fully before edit", vbInformation, "Warning!!"
             Exit Sub
        End If
        editexception = True
        MsgBox "Please ensure the total amount is unchanged after editing to ensure the Bank Reconciliation is unaffected and remains the same after editing", vbInformation, "Warning!!"
        cmdEditReceipt_Click
    End If
End Sub

Private Sub flxSPayment_MouseMove(Button As Integer, Shift As Integer, X As Single, Y As Single)
'    MousePointer = vbArrow
     Screen.MousePointer = vbNormal
End Sub



Private Sub Frame4_MouseMove(Index As Integer, Button As Integer, Shift As Integer, X As Single, Y As Single)
'     Me.MousePointer = vbArrow
End Sub

Private Sub Frame5_MouseMove(Index As Integer, Button As Integer, Shift As Integer, X As Single, Y As Single)
    MousePointer = vbArrow
End Sub

Private Sub optOIF_MouseMove(Button As Integer, Shift As Integer, X As Single, Y As Single)
        Me.MousePointer = vbArrow
End Sub



Private Sub txtDmdPropertyList_Change()
    txtTenantName.text = ""
End Sub

Private Sub txtFund_KeyDown(KeyCode As MSForms.ReturnInteger, Shift As Integer)
    If KeyCode = 13 Then
         cmdFund.SetFocus
    End If
End Sub

Private Sub txtJob_KeyPress(KeyAscii As MSForms.ReturnInteger)
    If KeyAscii = 13 Then
        cmdJob.SetFocus
    End If
End Sub



Private Sub txtRptClientList_Change()
    txtTenantID.text = ""
End Sub

Private Sub txtSearchClientID_MouseMove(Button As Integer, Shift As Integer, X As Single, Y As Single)
         Me.MousePointer = vbArrow
End Sub

Private Sub txtSearchClientName_MouseMove(Button As Integer, Shift As Integer, X As Single, Y As Single)
     MousePointer = vbArrow
End Sub



Private Sub txtTenantID_KeyPress(KeyAscii As MSForms.ReturnInteger)
    If KeyAscii = 13 Then
        FocusControl cmdTenantLookup
    End If
End Sub

Private Sub txtTenantSearchID_MouseMove(Button As Integer, Shift As Integer, X As Single, Y As Single)
    Me.MousePointer = vbArrow
End Sub

Private Sub txtTenantSearchUnitName_KeyDown(KeyCode As Integer, Shift As Integer)
    If KeyCode = 13 Then
        flxLeaseList.SetFocus
    End If
End Sub

Private Sub txtType_KeyDown(KeyCode As MSForms.ReturnInteger, Shift As Integer)
     If KeyCode = 13 Then
         cmdType.SetFocus
    End If
End Sub

Private Sub cmdRptClientList_Click()
    txtTenantSearchID.text = ""
   'Added by anol 05 July 2015
    cmdBankAc.Enabled = True
   
    strCommandSource = "7"
    
    picClient.Left = 915
    picClient.Top = 650
    LoadflxClient
    tabDmdRcpt.Enabled = False
    picClient.Visible = True
    txtSearchClientID.SetFocus
End Sub

Private Sub cmdRptClientList1_Click()
    strCommandSource = "9"
    picClient.Left = 915
    picClient.Top = 850
    LoadflxClient
    tabDmdRcpt.Enabled = False
    picClient.Visible = True
    txtSearchClientID.SetFocus
End Sub

Private Sub cmdRptPropertyList_Click()
    txtTenantSearchID.text = ""
    strCommandSource = "8"
    
    picClient.Left = 915
    picClient.Top = 360
    LoadPropertyList
    tabDmdRcpt.Enabled = False
    picClient.Visible = True
    txtSearchClientID.SetFocus
End Sub

Private Sub cmdRptPropertyList1_Click()
    picClient.Left = 915
    picClient.Top = 1150
    
    strCommandSource = "10"
    LoadPropertyList
    tabDmdRcpt.Enabled = False
    picClient.Visible = True
    txtSearchClientID.SetFocus
End Sub

Private Sub cmdType_Click()
    If txtTenantName.text = "" Then Exit Sub
    picClient.Left = 2715
    picClient.Top = 1740
    
    If txtTenantName.text = "" Then Exit Sub
    strCommandSource = "11"
    Dim temp()  As String
    Dim adoConn As New ADODB.Connection
    adoConn.Open getConnectionString
    temp = Split(txtTenantName.text, "/")
    Call loadflxDemandType(temp(0), adoConn) 'loading demand Type when creating manual demand
    adoConn.Close
    picClient.Visible = True
    tabDmdRcpt.Enabled = False
    txtSearchClientID.SetFocus
    
'    Picture2.Left = 2715
'    Picture2.Top = 1740
'    Picture2.Visible = True
'    If txtTenantName.text = "" Then Exit Sub
'    strCommandSource = "11"
'    Dim temp()  As String
'    Dim adoConn As New ADODB.Connection
'    adoConn.Open getConnectionString
'    temp = Split(txtTenantName.text, "/")
'    Call FillDemandType(temp(0), adoConn)
'    adoConn.Close
'    tabDmdRcpt.Enabled = False
'    txtSearchDemandtype.SetFocus
'
End Sub

Private Sub txtClientHistory_Change()
   'If bFormLoading Then Exit Sub

'   Dim adoConn As New ADODB.Connection
'   Dim adoRst As New ADODB.Recordset
'   Dim szSQL As String
'   Dim TotalRow As Integer, TotalCol As Integer, i As Integer, j As Integer
'
'    adoConn.Open getConnectionString
'    LoadFlxGrid flxDemandHistory, True, adoConn
'    flxDemandHistory.row = 0
'    flxDemandHistory.col = 0
'    ConfigFlxGrid flxChildDemandHistory
'    adoConn.Close
'    Set adoConn = Nothing
'   If txtClientHistory.text <> "ALL" Then
'      szSQL = "SELECT PropertyID, PropertyName, " & _
'                  "ProAddressLine1, ProPostCode " & _
'              "FROM Property " & _
'              "WHERE ClientID = '" & txtClientHistory.text & "' " & _
'              "ORDER BY PropertyID;"
'   Else
'      szSQL = "SELECT PropertyID, PropertyName, " & _
'                  "ProAddressLine1, ProPostCode " & _
'              "FROM Property " & _
'              "ORDER BY PropertyID;"
'   End If
'
'   adoRst.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
'
'   TotalRow = adoRst.RecordCount
'   TotalCol = adoRst.Fields.count
'
'   ReDim Data(TotalCol, TotalRow) As String
'
'   Data(0, 0) = "ALL"
'   Data(1, 0) = "All Properties"
'   For i = 1 To TotalRow
'      For j = 0 To TotalCol - 1
'         Data(j, i) = IIf(IsNull(adoRst.Fields(j).Value), "", adoRst.Fields(j).Value)
'      Next j
'      adoRst.MoveNext
'      If adoRst.EOF Then Exit For
'   Next i
'   cboPropertyHistory.Column() = Data()
'   cboPropertyHistory.ListIndex = 0
'
'   adoRst.Close
'   Set adoRst = Nothing
  
  ' If chkSelectAllDemands.Value Then chkSelectAllDemands.Value = 0

   

End Sub



'Private Sub cboDmdClientList_KeyPress(KeyAscii As MSForms.ReturnInteger)
'    If KeyAscii = 13 Then
'        cmdDmdPropertyList.SetFocus
'    End If
'End Sub

Private Sub cmdClientHistory_Click()
    strCommandSource = "5"
    picClient.Left = 915
    picClient.Top = 350
   
    LoadflxClient
    tabDmdRcpt.Enabled = False
     picClient.Visible = True
    txtSearchClientID.SetFocus
End Sub

'Private Sub cmdClientList_Click()
'    strCommandSource = "3"
'    picClient.Left = 1530
'    picClient.Top = 585
'
'    LoadflxClient
'    tabDmdRcpt.Enabled = False
'    picClient.Visible = True
'    txtSearchClientID.SetFocus
'End Sub

Private Sub cmdDmdClientList_Click()
    strCommandSource = "1"
    
    picClient.Left = 1285
    picClient.Top = 650
    LoadflxClient
    tabDmdRcpt.Enabled = False
    picClient.Visible = True
    txtSearchClientID.SetFocus
    
End Sub

Private Sub cmdDmdPropertyList_Click()
    picClient.Left = 1285
    picClient.Top = 700
    strCommandSource = "2"
    LoadPropertyList
    tabDmdRcpt.Enabled = False
    picClient.Visible = True
    txtSearchClientID.SetFocus
End Sub

Private Sub cmdPropertyHistory_Click()
    picClient.Left = 4100
    picClient.Top = 350
    
    strCommandSource = "6"
    LoadPropertyList
    tabDmdRcpt.Enabled = False
    picClient.Visible = True
    txtSearchClientID.SetFocus
End Sub

'Private Sub cmdPropertyList_Click()
'    picClient.Left = 5945 - 2685 + 1530
'    picClient.Top = 585
'
'    strCommandSource = "4"
'    LoadPropertyList
'    tabDmdRcpt.Enabled = False
'    picClient.Visible = True
'    txtSearchClientID.SetFocus
'End Sub

'Private Sub txtDmdClientList_LostFocus()
'   'issue 571 Validation
'   'Added by anol 20 May 2015
'   Dim adoRst As New ADODB.Recordset
'   Dim szSQL As String
'   Dim adoConn    As New ADODB.Connection
'   If Trim(txtDmdClientList.text) <> "" Or Trim(txtDmdClientList.text) = "ALL" Then
'        adoConn.Open getConnectionString
'        szSQL = "SELECT CLIENTID, CLIENTNAME " & _
'                "FROM CLIENT " & _
'                "where CLIENTID='" & txtDmdClientList.text & "';"
'        adoRst.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
'        If adoRst.EOF Then
'            'It shall give message if client is wrong
'            'and cleared down the property
'            'txtClientID.text = ""
'            'cmbClient.ListIndex = -1
'
'            'txtPropID.text = ""
'            tabDmdRcpt.Tab = 0
'            MsgBox "Please select a valid client", vbInformation, "Select a client"
'            cmdDmdClientList.SetFocus
'            txtDmdPropertyList.text = ""
'        Else
'             'if client is not wrong it shall load proper property
'            txtDmdClientList_Change
'        End If
'        adoConn.Close
'        Set adoConn = Nothing
'    Else
'       ' txtClientID.text = ""
'        ' cmbClient.ListIndex = -1
'       ' txtDmdPropertyList.text = ""
'       ' txtPropID.text = ""
'    End If
'End Sub



'Private Sub cboDmdPropertyList_KeyPress(KeyAscii As MSForms.ReturnInteger)
'    If KeyAscii = 13 Then
'           cmdDmdTenantLookup.SetFocus
'    End If
'End Sub

'Private Sub cboDmdPropertyList_LostFocus()
'    'issue 571 Validation
'   'Added by anol 20 May 2015
'   Dim adoRst As New ADODB.Recordset
'   Dim szSQL As String
'   Dim adoConn    As New ADODB.Connection
'   If Trim(txtDmdPropertyList.text) <> "" Then
'        adoConn.Open getConnectionString
'        szSQL = "SELECT PropertyID, PropertyNAME " & _
'                "FROM Property " & _
'                "where PropertyID='" & txtDmdPropertyList.text & "';"
'        adoRst.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
'        If adoRst.EOF Then
'            'It shall give message if client is wrong
'            'and cleared down the property
'            'txtClientID.text = ""
'            'cmbClient.ListIndex = -1
'
'            'txtPropID.text = ""
'            tabDmdRcpt.Tab = 0
'            MsgBox "Please select a valid property", vbInformation, "Select a property"
'            txtDmdPropertyList.SetFocus
'            'cboDmdPropertyList.Clear
'        Else
'             'if client is not wrong it shall load proper property
'            'cboDmdClientList_Change
'        End If
'        adoConn.Close
'        Set adoConn = Nothing
'    Else
'       ' txtClientID.text = ""
'        ' cmbClient.ListIndex = -1
'        'cboDmdPropertyList.Clear
'       ' txtPropID.text = ""
'    End If
'End Sub

'Private Sub cboFund_KeyPress(KeyAscii As MSForms.ReturnInteger)
'    If KeyAscii = 13 Then
'        txtAddNewDescription.SetFocus
'    End If
'End Sub

'Private Sub cboFund_LostFocus()
'    'issue 571 validation
''Fixed by anol 21 May 2015
'    If Trim(cboFund.text) <> "" Then
'        Dim adoConn As New ADODB.Connection
'        adoConn.Open getConnectionString
'        Dim adoRst As New ADODB.Recordset
'        Dim szSQL As String
'        szSQL = "SELECT fundCode " & _
'           "FROM fund " & _
'           "WHERE fundCode = '" & cboFund.text & "' "
'        adoRst.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
'        If adoRst.EOF Then
'            tabDmdRcpt.Tab = 0
'            MsgBox "Please select a valid fund to proceed.", vbCritical + vbOKOnly, "Select a fund"
'            cboFund.SetFocus
'            Exit Sub
'        End If
'        adoRst.Close
'        adoConn.Close
'   End If
'End Sub

'Private Sub cboJob_KeyPress(KeyAscii As MSForms.ReturnInteger)
'    If KeyAscii = 13 Then
'           txtAmount.SetFocus
'    End If
'End Sub

'Private Sub cboJob_LostFocus()
''issue 571 validation
''Fixed by anol 21 May 2015
'    If Trim(cboJob.text) <> "" Then
'        Dim adoConn As New ADODB.Connection
'        adoConn.Open getConnectionString
'        Dim adoRst As New ADODB.Recordset
'        Dim szSQL As String
'        szSQL = "SELECT ID, Job_DiaryName " & _
'           "FROM PropertyMaintHistory " & _
'           "WHERE Job_DiaryName = '" & cboJob.text & "' " & _
'           "ORDER BY ID;"
'        adoRst.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
'        If adoRst.EOF Then
'            tabDmdRcpt.Tab = 0
'            MsgBox "Please select a valid Job Number to proceed.", vbCritical + vbOKOnly, "Select a job"
'            cboJob.SetFocus
'            Exit Sub
'        End If
'        adoRst.Close
'        adoConn.Close
'   End If
'End Sub

Private Sub txtDmdClientList_KeyDown(KeyCode As MSForms.ReturnInteger, Shift As Integer)
    If KeyCode = 13 Then
        cmdDmdClientList.SetFocus
    End If
End Sub



Private Sub txtDmdPropertyList_KeyDown(KeyCode As MSForms.ReturnInteger, Shift As Integer)
    If KeyCode = 13 Then
        cmdDmdPropertyList.SetFocus
    End If
End Sub

Private Sub txtPropertyHistory_Change()
'    'If bFormLoading Then Exit Sub
'
'   Dim adoConn As New ADODB.Connection
''   connect to database
'   adoConn.Open getConnectionString
'
'   LoadFlxGrid flxDemandHistory, True, adoConn
'   'If chkSelectAllDemands.Value Then chkSelectAllDemands.Value = 0
'
'   flxDemandHistory.row = 0
'   flxDemandHistory.col = 0
'
'   adoConn.Close
'   Set adoConn = Nothing
'   ConfigFlxGrid flxChildDemandHistory
End Sub

'Private Sub cboRptClientList_Change()
'    'added by anol 20 July 2015
'    txtReceiptReference.text = ""
'    cmbRptAmtType.ListIndex = -1
'    txtSPaymentTotal.text = "0.00"
'End Sub

'Private Sub txtRptClientList_LostFocus()
'Rem by anol 06 Jan 2016
'    'issue 571 Validation
'   'Added by anol 21 May 2015
'   Dim adoRst As New ADODB.Recordset
'   Dim szSQL As String
'   Dim adoConn    As New ADODB.Connection
'   If Trim(txtRptClientList.text) <> "" Then
'        adoConn.Open getConnectionString
'        szAllBankBalance = BankAndBalance(adoConn)
'        szSQL = "SELECT CLIENTID, CLIENTNAME " & _
'                "FROM CLIENT " & _
'                "where CLIENTNAME='" & txtRptClientList.text & "';"
'        adoRst.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
'        If adoRst.EOF Then
'            'It shall give message if client is wrong
'            'and cleared down the property
'            'txtClientID.text = ""
'            'cmbClient.ListIndex = -1
'
'            'txtPropID.text = ""
'            tabDmdRcpt.Tab = 2
'            MsgBox "Please select a valid client", vbInformation, "Select a client"
'            cboRptClientList.SetFocus
'            cboRptPropertyList.Clear
'        Else
'             'if client is not wrong it shall load proper property
'            cboRptClientList_Click
'        End If
'        adoConn.Close
'        Set adoConn = Nothing
'    Else
'       ' txtClientID.text = ""
'        ' cmbClient.ListIndex = -1
'        cboRptPropertyList.Clear
'       ' txtPropID.text = ""
'    End If
'End Sub

'Private Sub cboRptPropertyList_LostFocus()
'   'issue 571 Validation
'   'Added by anol 20 May 2015
'   'Rem by anol 06 Jan 2016
'   Dim adoRst As New ADODB.Recordset
'   Dim szSQL As String
'   Dim adoConn    As New ADODB.Connection
'   If Trim(cboRptPropertyList.text) = "All Properties" Then Exit Sub
'   If Trim(cboRptPropertyList.text) <> "" Then
'        adoConn.Open getConnectionString
'        szSQL = "SELECT PropertyID, PropertyNAME " & _
'                "FROM Property " & _
'                "where PropertyNAME='" & cboRptPropertyList.text & "';"
'        adoRst.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
'        If adoRst.EOF Then
'            tabDmdRcpt.Tab = 2
'            MsgBox "Please select a valid property", vbInformation, "Select a property"
'            cboRptPropertyList.SetFocus
'        End If
'        adoConn.Close
'        Set adoConn = Nothing
'    End If
'End Sub

'Private Sub cboType_KeyPress(KeyAscii As Integer)
'    If KeyAscii = 13 Then
'         cboFund.SetFocus
'    End If
'End Sub

'Private Sub cboType_KeyUp(KeyCode As Integer, Shift As Integer)
'    Call FindComboString(cboType, KeyCode)
'End Sub

''Private Sub cmbBankAc_Change()
'''this procedure added by anol
'''issue 525 bank overdraft
''    If cmbBankAc.ListIndex <> -1 Then
''      isOverDratAllowed.Caption = cmbBankAc.Column(2)
''      lblOverDraftAmount.Caption = cmbBankAc.Column(3)
''    Else
''      lblOverDraftAmount.Caption = ""
''      isOverDratAllowed.Caption = ""
''   End If
''End Sub

Private Sub cmbBankAc_LostFocus()
'   'issue 571 Validation
'   'Added by anol 20 May 2015
'   Dim adoRst As New ADODB.Recordset
'   Dim szSQL As String
'   Dim adoConn As New ADODB.Connection
'  If cmbBankAc.text = "" Then
'      MsgBox "Please select the client's bank account", vbCritical + vbOKOnly, "Receipt - Bank Account missing"
'      cmbBankAc.Enabled = True
'      'cmbBankAc.SetFocus
'      Exit Sub
'   End If
'   If Trim(cmbBankAc.text) <> "" Then
'        adoConn.Open getConnectionString
'        szSQL = "SELECT Name " & _
'                "FROM NominalLedger " & _
'                "where Name='" & cmbBankAc.text & "';"
'        adoRst.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
'        If adoRst.EOF Then
'            tabDmdRcpt.Tab = 2
'            MsgBox "Please select a valid bank account", vbInformation, "Select a bank account"
'            cmbBankAc.SetFocus
'        End If
'        adoConn.Close
'        Set adoConn = Nothing
'    End If
End Sub

'Private Sub cmbRptAmtType_KeyDown(KeyCode As MSForms.ReturnInteger, Shift As Integer)
'    If KeyCode = 13 Then
'        If txtSPaymentTotal.Enabled = True Then
'            txtSPaymentTotal.SetFocus
'        End If
'    End If
'End Sub
'
'Private Sub cmbRptAmtType_KeyPress(KeyAscii As MSForms.ReturnInteger)
'    If KeyAscii = 13 Then
'        If txtSPaymentTotal.Enabled = True Then
'            txtSPaymentTotal.SetFocus
'        End If
'    End If
'End Sub

Private Sub cmbRptAmtType_LostFocus()
    'issue 571 Validation
   'Added by anol 20 May 2015
   Dim adoRST As New ADODB.Recordset
   Dim szSQL As String
   Dim adoConn    As New ADODB.Connection
   If txtRcptAmtType.text = -1 Then
'        ShowMsgInTaskBar "Please select correct type of amount"
        MsgBox "Please select an amount type.", vbCritical + vbOKOnly, "Receipt amount type missing"
        Exit Sub
   End If
'   If Trim(cmbRptAmtType.text) <> "" Then
'        adoConn.Open getConnectionString
'        szSQL = "SELECT PRIMARYCODE.VALUE, SECONDARYCODE.CODE, SECONDARYCODE.VALUE, SECONDARYCODE.DESCRIPTION FROM PRIMARYCODE, SECONDARYCODE WHERE Flexible = TRUE AND PRIMARYCODE.CODE = 'RAT' AND PRIMARYCODE.CODE = SECONDARYCODE.PRIMARYCODE AND SECONDARYCODE.VALUE='" & cmbRptAmtType.text & "'"
'        adoRst.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
'        If adoRst.EOF Then
'            tabDmdRcpt.Tab = 2
'            MsgBox "Please select a valid Amount Type to proceed", vbInformation, "Amount Type"
'            cmbRptAmtType.SetFocus
'        End If
'        adoConn.Close
'        Set adoConn = Nothing
'    End If
    'SELECT PRIMARYCODE.VALUE, SECONDARYCODE.CODE, SECONDARYCODE.VALUE, SECONDARYCODE.DESCRIPTION FROM PRIMARYCODE, SECONDARYCODE WHERE Flexible = TRUE AND PRIMARYCODE.CODE = 'RAT' AND PRIMARYCODE.CODE = SECONDARYCODE.PRIMARYCODE
End Sub

Private Sub flxDmdLeaseList_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
            flxDmdLeaseList_Click
            txtIssueDate.SetFocus
    End If
End Sub

Private Sub txtAddNewDescription_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
        txtDateFrom.SetFocus
     End If
End Sub

Private Sub txtChargingAmt_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
        cmdJob.SetFocus
    End If
End Sub

Private Sub txtDmdTenantSearchID_KeyDown(KeyCode As Integer, Shift As Integer)
    If KeyCode = vbKeyDown Then
            flxDmdLeaseList.SetFocus
    End If
    If KeyCode = 13 Then
        txtDmdTenantSearchName.SetFocus
    End If
    If KeyCode = 27 Then
           picDmdLeaseList.Visible = False
           txtDmdTenantSearchID.text = ""
           tabDmdRcpt.Enabled = True
           cmdDmdTenantLookup.SetFocus
    End If
End Sub

Private Sub txtDmdTenantSearchID_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
        If Len(txtDmdTenantSearchID.text) > 0 Then
            flxDmdLeaseList.SetFocus
        Else
            txtDmdTenantSearchName.SetFocus
         End If
    End If
End Sub

Private Sub txtDmdTenantSearchName_KeyDown(KeyCode As Integer, Shift As Integer)
    If KeyCode = vbKeyDown Then
            flxDmdLeaseList.SetFocus
    End If
End Sub

Private Sub txtDmdTenantSearchName_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
            txtDmdTenantSearchUnitName.SetFocus
    End If
End Sub

Private Sub txtDmdTenantSearchUnitName_KeyDown(KeyCode As Integer, Shift As Integer)
    If KeyCode = vbKeyDown Then
            flxDmdLeaseList.SetFocus
    End If
End Sub

Private Sub txtDmdTenantSearchUnitName_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
        flxDmdLeaseList.SetFocus
    End If
End Sub

Private Sub txtIssueDate_Change()
   If txtIssueDate.text <> "" Then
        TextBoxChangeDate txtIssueDate
   End If
   'Modified by BOSL
   'Issue 468
   'Modified by Anol 01 Sep 2014
   lblPostingDate.ToolTipText = txtIssueDate.text
End Sub
Private Sub txtClientList_Change()
   'If bFormLoading Then Exit Sub

'   Dim adoConn As New ADODB.Connection
'   Dim adoRst As New ADODB.Recordset
'   Dim szSQL As String
'   Dim TotalRow As Integer, TotalCol As Integer, i As Integer, j As Integer
'
''   connect to database
'   adoConn.Open getConnectionString
'   LoadFlxGrid flxDemands, False, adoConn
'   If chkSelectAllDemands.Value Then chkSelectAllDemands.Value = 0
'
'   flxDemands.row = 0
'   flxDemands.col = 0
'
'   adoConn.Close
'   Set adoConn = Nothing



'   If txtClientList.text <> "ALL" Then
'      szSQL = "SELECT PropertyID, PropertyName, " & _
'                  "ProAddressLine1, ProPostCode " & _
'              "FROM Property " & _
'              "WHERE ClientID = '" & txtClientList.text & "' " & _
'              "ORDER BY PropertyID;"
'   Else
'      szSQL = "SELECT PropertyID, PropertyName, " & _
'                  "ProAddressLine1, ProPostCode " & _
'              "FROM Property " & _
'              "ORDER BY PropertyID;"
'   End If
'
'   adoRst.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
'
'   TotalRow = adoRst.RecordCount
'   TotalCol = adoRst.Fields.count
'
'   ReDim Data(TotalCol, TotalRow) As String
'
'   Data(0, 0) = "ALL"
'   Data(1, 0) = "All Properties"
'   For i = 1 To TotalRow
'      For j = 0 To TotalCol - 1
'         Data(j, i) = IIf(IsNull(adoRst.Fields(j).Value), "", adoRst.Fields(j).Value)
'      Next j
'      adoRst.MoveNext
'      If adoRst.EOF Then Exit For
'   Next i
'   cboPropertyList.Column() = Data()
'   cboPropertyList.ListIndex = 0
'
'   adoRst.Close
'   Set adoRst = Nothing

  
End Sub

Private Sub txtDmdClientList_Change()
'   If cboDmdClientList.ListCount = 0 Then Exit Sub
'   If IsNull(cboDmdClientList.Value) Then Exit Sub
'   Dim adoConn As New ADODB.Connection
'   Dim adoRst As New ADODB.Recordset
'   Dim szSQL As String, Data() As String
'   Dim TotalRow As Integer, TotalCol As Integer
'   Dim i As Integer, j As Integer
'
'   On Error GoTo ErrorHandler
'
'   adoConn.Open getConnectionString
'
'   szSQL = "SELECT PropertyID, PropertyName, " & _
'               "ProAddressLine1, ProPostCode " & _
'           "FROM Property " & _
'           "WHERE ClientID = '" & txtDmdClientList.text & "' " & _
'           "ORDER BY PropertyID;"
'
'   adoRst.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
'
'   If adoRst.EOF Then GoTo NoRes
'
'   TotalRow = adoRst.RecordCount
'   TotalCol = adoRst.Fields.count
'
'   ReDim Data(TotalCol, TotalRow) As String
'
'   For i = 0 To TotalRow - 1
'       For j = 0 To TotalCol - 1
'           Data(j, i) = IIf(IsNull(adoRst.Fields(j).Value), "", adoRst.Fields(j).Value)
'       Next j
'       adoRst.MoveNext
'       If adoRst.EOF Then Exit For
'   Next i
'   cboDmdPropertyList.Column() = Data()
'
'NoRes:
'   adoRst.Close
'   adoConn.Close
'   Set adoRst = Nothing
'   Set adoConn = Nothing
'   Exit Sub
'
'ErrorHandler:
'   MsgBox ERR.description & "::" & ERR.Number
'
'   adoRst.Close
'   adoConn.Close
'   Set adoRst = Nothing
'   Set adoConn = Nothing
  ' txtDmdPropertyList.text = ""
  txtTenantName.text = ""
End Sub

Public Sub cboPropertyList_Click()
   If bFormLoading Then Exit Sub

   Dim adoConn As New ADODB.Connection
'   connect to database
   adoConn.Open getConnectionString

   'LoadFlxGrid flxDemands, False, adoConn, ""
    LoadFlxDemands adoConn, ""
   If chkSelectAllDemands.Value Then chkSelectAllDemands.Value = 0

   flxDemands.row = 0
   flxDemands.col = 0

   adoConn.Close
   Set adoConn = Nothing
End Sub

'Private Sub txtRptClientList_Change_Made()
'   Rem by anol 07 Jan 2016
'   Dim adoConn As New ADODB.Connection
'   Dim adoRst As New ADODB.Recordset
'   Dim szSQL As String, Data() As String
'   Dim TotalRow As Integer, TotalCol As Integer
'   Dim i As Integer, j As Integer
'   On Error GoTo ErrorHandler
'   If txtRptClientList.text = "ALL" Then Exit Sub
'   adoConn.Open getConnectionString
''   szAllBankBalance = BankAndBalance(adoConn)
'
''   If txtRptClientList.text <> "ALL" Then
''      szSQL = "SELECT PropertyID, PropertyName, " & _
''                  "ProAddressLine1, ProPostCode " & _
''              "FROM Property " & _
''              "WHERE ClientID = '" & txtRptClientList.text & "' " & _
''              "ORDER BY PropertyID;"
''   Else
''      szSQL = "SELECT PropertyID, PropertyName, " & _
''                  "ProAddressLine1, ProPostCode " & _
''              "FROM Property " & _
''              "ORDER BY PropertyID;"
''   End If
''
''   adoRst.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
''
''   If adoRst.EOF Then GoTo NoRes
''
''   TotalRow = adoRst.RecordCount
''   TotalCol = adoRst.Fields.count
''
''   ReDim Data(TotalCol, TotalRow) As String
''
''   Data(0, 0) = "ALL"
''   Data(1, 0) = "All Properties"
''   For i = 1 To TotalRow
''       For j = 0 To TotalCol - 1
''           Data(j, i) = IIf(IsNull(adoRst.Fields(j).Value), "", adoRst.Fields(j).Value)
''       Next j
''       adoRst.MoveNext
''       If adoRst.EOF Then Exit For
''   Next i
''   cboRptPropertyList.Column() = Data()
''*************************************************************************************************
''  Current tenants Only
''rem By NOL 20170721 I DO NOT SEE ANY REASON TO LOAD LESSEE WHEN YOU ARE CHANGING A CLIENT
''''   szSQL = "SELECT Tenants.SageAccountNumber, Name, LeaseDetails.UnitNumber " & _
''''          "From Tenants, LeaseDetails, Units, Property " & _
''''          "WHERE ((Tenants.Comments) IS NULL OR Tenants.Comments='') AND " & _
''''            "Tenants.SageAccountNumber = LeaseDetails.SageAccountNumber AND " & _
''''            "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
''''            "Units.PropertyID = Property.PropertyID AND " & _
''''            "Property.ClientID = '" & txtRptClientList.text & "' " & _
''''         "ORDER BY Tenants.SageAccountNumber;"
'''''Debug.Print szSQL
''''   ConfigureFlxLeaseList
''''   PopulateTenantLookup adoConn, szSQL
''**************************************************************************************************
'    txtReceiptReference.text = ""
'    cmbRptAmtType.ListIndex = -1
'    txtSPaymentTotal.text = "0.00"
'NoRes:
'   adoConn.Close
'   Set adoConn = Nothing
'   Exit Sub
'
'ErrorHandler:
'   MsgBox Err.description & "::" & Err.Number
'
'   adoRst.Close
'   adoConn.Close
'   Set adoRst = Nothing
'   Set adoConn = Nothing
'End Sub
Private Function LoadflxBankAC()
   On Error GoTo Error_Handler
   Dim adoConn As New ADODB.Connection
   Dim iRec As Integer
   Dim adoRST As New ADODB.Recordset
   Dim szSQL As String
   
   'Configure grid start
   txtSearchClientID.text = ""
   txtSearchClientID.Left = 250
   txtSearchClientID.Width = 900
   
   txtSearchClientName.Visible = True
   txtSearchClientName.text = ""
   txtSearchClientName.Left = 1200
   txtSearchClientName.Width = 2200
   flxClient.Clear
   flxClient.RowHeight(0) = 0
   flxClient.Cols = 3
   flxClient.ColWidth(0) = 200
   flxClient.ColWidth(1) = 900
   flxClient.ColWidth(2) = 2800
   picClient.Width = 3500
   cmdPicCLose.Left = 3200
  
   Label20(14).Visible = False
   flxClient.Rows = 2
   flxClient.Height = 2845
   flxClient.Width = 3400
   picClient.Height = 3595
   flxClient.ColAlignment(0) = vbLeftJustify
   flxClient.ColAlignment(1) = vbLeftJustify
   flxClient.ColAlignment(2) = vbLeftJustify

   Label20(12).Caption = "Bank Code"
   Label20(13).Caption = "Bank AC"
   Label20(12).Width = 1400
   Label20(12).Left = 250
   Label20(13).Width = 3600
   Label20(13).Left = 1300 'Label20(12).Left + flxClient.ColWidth(0)
   'Configure grid End
   If txtRptClientList.text = "ALL" Then
        txtBankCode.text = ""
        txtBankAc.text = ""
        Exit Function
   End If
   adoConn.Open getConnectionString
   If txtRptClientList.text = "ALL" Then
      szSQL = "SELECT tlbClientBanks.NominalCode AS BNC, " & _
                  "NominalLedger.Name AS BNN, tlbClientBanks.CurrentBalance AS BAL, AllowOverDraft, OverDraftLimit,DEFAULT_AC  " & _
              "FROM tlbClientBanks, NominalLedger " & _
              "WHERE tlbClientBanks.NominalCode = NominalLedger.Code " & _
              "GROUP BY tlbClientBanks.NominalCode, NominalLedger.Name, tlbClientBanks.CurrentBalance, AllowOverDraft, OverDraftLimit,DEFAULT_AC;"
   Else
      szSQL = "SELECT tlbClientBanks.NominalCode AS BNC, " & _
                  "NominalLedger.Name AS BNN, tlbClientBanks.CurrentBalance AS BAL, AllowOverDraft, OverDraftLimit,DEFAULT_AC  " & _
              "FROM tlbClientBanks, NominalLedger " & _
              "WHERE tlbClientBanks.NominalCode = NominalLedger.Code AND " & _
                  "tlbClientBanks.CLIENT_ID = '" & txtRptClientList.text & "' AND " & _
                  "NominalLedger.ClientID = '" & txtRptClientList.text & "' " & _
              "GROUP BY tlbClientBanks.NominalCode, NominalLedger.Name, tlbClientBanks.CurrentBalance, AllowOverDraft, OverDraftLimit,DEFAULT_AC;"
   End If
   adoRST.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
   If adoRST.EOF Then
      MsgBox "Please setup bank account for the client.", vbInformation, "Warning"
   Else
      flxClient.Rows = adoRST.RecordCount + 1
       iRec = 1
      While Not adoRST.EOF
        flxClient.TextMatrix(iRec, 0) = "" 'For Selection Row
        flxClient.TextMatrix(iRec, 1) = adoRST.Fields.Item("BNC").Value
        flxClient.TextMatrix(iRec, 2) = adoRST.Fields.Item("BNN").Value
        Debug.Print flxClient.RowHeight(iRec)
        'Debug.Print adoRst.Fields.Item("BNN").Value
        flxClient.RowHeight(iRec) = 280
        iRec = iRec + 1
        adoRST.MoveNext
      Wend
   End If
   adoConn.Close
   Set adoConn = Nothing
   Exit Function

   
Error_Handler:
   Set adoRST = Nothing
   MsgBox Err.description
   
   
End Function
Private Sub UpdateBankOverDraft(adoConn As ADODB.Connection, ByRef isOverDraftAllowed As Boolean, ByRef dblOverdraftAmount As Double)
    Dim szSQL As String
    Dim adoRST As New ADODB.Recordset
    szSQL = "SELECT tlbClientBanks.NominalCode AS BNC, " & _
                  "NominalLedger.Name AS BNN, tlbClientBanks.CurrentBalance AS BAL, AllowOverDraft, OverDraftLimit,DEFAULT_AC  " & _
              "FROM tlbClientBanks, NominalLedger " & _
              "WHERE tlbClientBanks.NominalCode = NominalLedger.Code AND tlbClientBanks.NominalCode = '" & txtBankCode.text & "' AND " & _
                  "tlbClientBanks.CLIENT_ID = '" & txtRptClientList.text & "' AND " & _
                  "NominalLedger.ClientID = '" & txtRptClientList.text & "' " & _
              "GROUP BY tlbClientBanks.NominalCode, NominalLedger.Name, tlbClientBanks.CurrentBalance, AllowOverDraft, OverDraftLimit,DEFAULT_AC;"
    adoRST.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
   If Not adoRST.EOF Then
        isOverDraftAllowed = adoRST.Fields.Item("AllowOverDraft").Value
        dblOverdraftAmount = IIf(IsNull(adoRST.Fields.Item("OverDraftLimit").Value), "0", adoRST.Fields.Item("OverDraftLimit").Value)
   End If
End Sub
Private Function LoadDefaultBankAC(adoConn As ADODB.Connection)
   On Error GoTo Error_Handler
    
    Dim iRec As Integer
    Dim adoRST As New ADODB.Recordset
    Dim szSQL As String
    Dim iDefaultBankAC As Integer
    iDefaultBankAC = -1
    Dim defaultBankCode As String
    Dim defaultBankAC As String
    Dim bKeepOldValues As Boolean
    If txtRptClientList.text = "ALL" Or txtRptClientList.text = "" Then
         txtBankCode.text = ""
         txtBankAc.text = ""
         Exit Function
    End If
    If txtRptClientList.text = "ALL" Then
        szSQL = "SELECT tlbClientBanks.NominalCode AS BNC, " & _
                   "NominalLedger.Name AS BNN, tlbClientBanks.CurrentBalance AS BAL, AllowOverDraft, OverDraftLimit,DEFAULT_AC  " & _
               "FROM tlbClientBanks, NominalLedger " & _
               "WHERE tlbClientBanks.NominalCode = NominalLedger.Code " & _
               "GROUP BY tlbClientBanks.NominalCode, NominalLedger.Name, tlbClientBanks.CurrentBalance, AllowOverDraft, OverDraftLimit,DEFAULT_AC;"
    Else
        szSQL = "SELECT tlbClientBanks.NominalCode AS BNC, " & _
                   "NominalLedger.Name AS BNN, tlbClientBanks.CurrentBalance AS BAL, AllowOverDraft, OverDraftLimit,DEFAULT_AC  " & _
               "FROM tlbClientBanks, NominalLedger " & _
               "WHERE tlbClientBanks.NominalCode = NominalLedger.Code AND " & _
                   "tlbClientBanks.CLIENT_ID = '" & txtRptClientList.text & "' AND " & _
                   "NominalLedger.ClientID = '" & txtRptClientList.text & "' " & _
               "GROUP BY tlbClientBanks.NominalCode, NominalLedger.Name, tlbClientBanks.CurrentBalance, AllowOverDraft, OverDraftLimit,DEFAULT_AC;"
    End If
    adoRST.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
    If adoRST.EOF Then
          MsgBox "Please setup bank account for the client."
    Else
'          ReDim szaData(3, adoRst.RecordCount - 1) As String
    
          While Not adoRST.EOF

                If CBool(adoRST.Fields.Item("DEFAULT_AC").Value) = True Then 'loading default Bank AC
                      iDefaultBankAC = iRec
                      defaultBankCode = adoRST.Fields.Item("BNC").Value
                      defaultBankAC = adoRST.Fields.Item("BNN").Value
                End If
                If txtBankCode.text = adoRST.Fields.Item("BNC").Value Then
                     'if previosly bankcode of for this client has already set to textbox which belongs to this client then do not set deafult bank account keep current bank code
                      bKeepOldValues = True
                End If
                iRec = iRec + 1
                adoRST.MoveNext
          Wend

   End If
      Set adoRST = Nothing
      If iDefaultBankAC < 0 Then
            MsgBox "Please set a default Client Bank Account for: " & txtRptClientList.text & "", vbInformation, "Warning"
      End If
        If txtBankCode.text = "" And defaultBankCode <> "" Then
             txtBankCode.text = defaultBankCode
             txtBankAc.text = defaultBankAC
             Exit Function
        End If
        If bKeepOldValues = True Then
             'do nothing ,it is keeping previously selected bank code
        Else
             'selected bank code is not a part of this client
             txtBankCode.text = ""
             txtBankAc.text = ""
        End If
      
   Exit Function

   ' Error Handling Code
Error_Handler:
   Set adoRST = Nothing
   ShowMsgInTaskBar Err.description, "Y", "P"
End Function

'Private Sub cboRptClientList_GotFocus()
''rem by anol 07 Jan 2016
'   SelTxtInCtrl cboRptClientList
'   picLeaseList.Visible = False
'   txtTenantSearchID.text = ""
'   'Added by anol 05 July 2015
'   cmbBankAc.Enabled = True
'End Sub

'Private Sub txtRptClientList1_Change_made()
'   If txtRptPropertyList1.text = "ALL" Then _
'   txtTenantID1.text = "All Lessees"
'   If cboRptBankList1.ListCount > 0 Then _
'      cboRptBankList1.ListIndex = 0
'End Sub

Private Sub txtRptPropertyList_Change()
   txtTenantID.text = ""
End Sub

'Private Sub cboRptPropertyList_GotFocus()
'    SelTxtInCtrl cboRptPropertyList
'   picLeaseList.Visible = False
'   txtTenantSearchID.text = ""
'End Sub

Private Function BankOfDemandType(szDt As String, adoConn As ADODB.Connection) As String
   Dim adoRST As New ADODB.Recordset
   Dim szBank As String

'   Get the details for the demand type selected
   szBank = "SELECT spare1 FROM DemandTypes WHERE ID = " & szDt & ""
   adoRST.Open szBank, adoConn, adOpenDynamic, adLockPessimistic

   BankOfDemandType = IIf(IsNull(adoRST!spare1), "", adoRST!spare1)

   adoRST.Close
   Set adoRST = Nothing
End Function

Private Function IsSameBankDemandTypes(szCurDT As String, szPrDT As String) As Boolean
   Dim adoConn As New ADODB.Connection
   Dim adoCur As New ADODB.Recordset, adoPr As New ADODB.Recordset
   Dim szBankCur As String, szBankPr As String

'   connect to database
   adoConn.Open getConnectionString

'   Get the details for the demand type selected
   szBankCur = "SELECT spare1 FROM DemandTypes WHERE ID = " & szCurDT & ""
   adoCur.Open szBankCur, adoConn, adOpenStatic, adLockReadOnly

   szBankPr = "SELECT spare1 FROM DemandTypes WHERE ID = " & szPrDT & ""
   adoPr.Open szBankPr, adoConn, adOpenStatic, adLockReadOnly

   If adoCur!spare1 = adoPr!spare1 Then
      IsSameBankDemandTypes = True
   Else
      IsSameBankDemandTypes = False
   End If

   adoCur.Close
   adoPr.Close
   Set adoCur = Nothing
   Set adoPr = Nothing

   adoConn.Close
   Set adoConn = Nothing
End Function

Private Function isdemandSameBank(intDmndID As String) As Boolean
   Dim szTemp() As String, DemandType As String
   'below line added by anol 20 Nov 2015
   If Val(intDmndID) = 0 Then Exit Function
   'szTemp = Split(cboType.text, " / ")
  
   Nominal CInt(intDmndID), flxAddNewDemands.Rows - 1, flxAddNewDemands

   If flxAddNewDemands.TextMatrix(1, 0) <> "" And flxAddNewDemands.TextMatrix(1, 0) <> "DELETED" Then 'this part And flxAddNewDemands.TextMatrix(1, 0) <> "DELETED"  added by anol 20171017
      If Not IsSameBankDemandTypes(intDmndID, flxAddNewDemands.TextMatrix(1, 20)) Then
'         MsgBox "The Bank a/c of the Demand Type you have selected is not the same as the bank a/c of previously entered demand types." & Chr(10) & _
'                "Please note date, where demands with different bank details system will use the bank a/c details of the first demand type.", vbCritical + vbOKOnly, "Warning"

            MsgBox "The Bank Account No. on this demand type does not match the " & Chr(10) & _
             "Bank Account No. of the demand types already entered. " & Chr(10) & _
             "Please select a demand type whose Bank Account No. matches."
      Else
            isdemandSameBank = True
      End If
   Else
         isdemandSameBank = True
   End If
End Function

Private Sub Nominal(DTId As Integer, iFlxRow As Integer, conFlxGrid As Control)
   Dim rdoConn As New ADODB.Connection
   Dim rdoRst1 As New ADODB.Recordset
   Dim SQLStr1 As String

'   connect to database
   rdoConn.Open getConnectionString

'   Get the details for the demand type selected
   SQLStr1 = "SELECT * FROM DemandTypes WHERE ID = " & DTId & ""
   rdoRst1.Open SQLStr1, rdoConn, adOpenStatic, adLockReadOnly

   szaNominalCode(0) = IIf(IsNull(rdoRst1!NominalCodeforAmount), "", rdoRst1!NominalCodeforAmount)
   'MsgBox szaNominalCode(0)
   szaNominalCode(1) = IIf(IsNull(rdoRst1!NominalNameforAmount), "", rdoRst1!NominalNameforAmount)
   szaNominalCode(2) = IIf(IsNull(rdoRst1!NominalCodeForVAT), "", rdoRst1!NominalCodeForVAT)
   szaNominalCode(3) = IIf(IsNull(rdoRst1!NominalNameforVAT), "", rdoRst1!NominalNameforVAT)
   szaNominalCode(4) = IIf(IsNull(rdoRst1!NominalCodeForTotal), "", rdoRst1!NominalCodeForTotal)
   szaNominalCode(5) = IIf(IsNull(rdoRst1!NominalNameforTotal), "", rdoRst1!NominalNameforTotal)

   szPrefix = rdoRst1!prefix
   rdoRst1.Close
   rdoConn.Close

   Set rdoRst1 = Nothing
   Set rdoConn = Nothing
End Sub

Private Function DemandBankID(adoConn As ADODB.Connection, szDemandType As String) As String
   Dim adoRST As New ADODB.Recordset
   Dim szSQL As String

   szSQL = "Select spare1 " & _
           "From DemandTypes " & _
           "Where ID = " & Val(szDemandType) & ";"
   adoRST.Open szSQL, adoConn, adOpenStatic, adLockReadOnly

   DemandBankID = IIf(IsNull(adoRST.Fields.Item("spare1").Value), "", adoRST.Fields.Item("spare1").Value)
   adoRST.Close
   Set adoRST = Nothing
End Function
Public Sub FindComboString(vComboName As ComboBox, KeyCode As Integer)
    'Author  : Anol roy
    'Date    : 21 May 2015
    'Purpose : This function is used to match the written text with the Combobox Data
    'issue 571 validation
    If vComboName.ListCount = 0 Then Exit Sub
    Dim X As Integer, Y As Integer
    
    'For auto complete
    'Key 8=Back Space, 37=righr arow, 39= Left arow, 39=Delete etc...
    If Len(vComboName.text) = 0 Or KeyCode = 8 Or KeyCode = 36 Or KeyCode = 37 Or KeyCode = 38 Or KeyCode = 39 Or KeyCode = 40 Or KeyCode = 46 Then Exit Sub
    Y = Len(vComboName.text)
    For X = 0 To vComboName.ListCount - 1
        If UCase(Left(vComboName.List(X), Y)) = UCase(vComboName.text) Then
            vComboName.text = vComboName.List(X)
            vComboName.SelStart = Y
            vComboName.SelLength = Len(vComboName.text) - Y
            Exit For
        End If
    Next X


End Sub
'Private Sub cboType_LostFocus()
''implemet this on addnew button
'   Dim szTemp() As String, DemandType As String
'   'below line added by anol 20 Nov 2015
'   If txtType.text = "" Then
'        Exit Sub
'    End If
''    If IsNull(cboType) Then
''         MsgBox "Please select a valid demand type", vbInformation, "Select demand type"
''         cboType.SetFocus
''        Exit Sub
''    End If
'  ' szTemp = Split(cboType.text, " / ")
'
'   Nominal CInt(txtType.Tag), flxAddNewDemands.Rows - 1, flxAddNewDemands
'
'   If flxAddNewDemands.TextMatrix(1, 0) <> "" Then
'      If Not IsSameBankDemandTypes(txtType.Tag, flxAddNewDemands.TextMatrix(1, 18)) Then
'      'rem by anol 11 Jan 2016
''         MsgBox "The Bank a/c of the Demand Type you have selected is not the same as the bank a/c of previously entered demand types." & Chr(10) & _
''                "Please note date, where demands with different bank details system will use the bank a/c details of the first demand type.", vbCritical + vbOKOnly, "Warning"
'           MsgBox "The Bank Account No. on this demand type does not match the " & Chr(10) & _
'             "Bank Account No. of the demand types already entered. " & Chr(10) & _
'             "Please select a demand type whose Bank Account No. matches."
'      End If
'   End If
'
'   'Dim szaDemandType() As String
'    Dim adoConn    As New ADODB.Connection
'    'comment out by anol 21 Jan 2016
'''   If Trim(cboType.text) <> "" Then
'''        Dim adoRst1 As New ADODB.Recordset
''''        If (InStr(1, cboType.text, "/", vbBinaryCompare) > 0) = 0 Then
''''                    MsgBox "Please select a valid demand type", vbInformation, "Select demand type"
''''                    cboType.SetFocus
''''                    Exit Sub
''''        Else
'''                adoConn.Open getConnectionString
'''                Dim strtxt As String
'''                'szaDemandType = (Split(cboType.text, "/"))
'''               ' X = Len(szaDemandType(0))
'''                'Mid(cboType.text,Len(szaDemandType(0))+1,len(cboType.text)-Len(szaDemandType(0))+1)
'''                adoRst1.Open "Select * from  DemandTypes where Type='" & cboType.text & "'", adoConn, adOpenStatic, adLockReadOnly
'''                If adoRst1.EOF Then
'''                    tabDmdRcpt.Tab = 0
'''                    MsgBox "Please select a valid demand type", vbInformation, "Select demand type"
'''                    cboType.SetFocus
'''                    Exit Sub
'''                End If
'''                adoRst1.Close
'''                adoConn.Close
'''        'End If
'''   End If
'   If szDemandBankID = "" Then Exit Sub
'
'
'
'
'
'   adoConn.Open getConnectionString
'
'   'szaDemandType = Split(cboType.text, " / ")
'
'   If szDemandBankID <> DemandBankID(adoConn, txtType.Tag) Then
''      MsgBox "The Bank Account No. on this demand type does not match the " & Chr(10) & _
''             "Bank Account No. of the demand types already entered. " & Chr(10) & _
''             "Please select a demand type whose Bank Account No. matches."
'      cboType.SetFocus
'   End If
'
'   adoConn.Close
'   Set adoConn = Nothing
'End Sub

'Private Sub cboVatCode_Click()
'   Dim szTemp() As String
'
'   szTemp = Split(cboVatCode.text, " / ")
'
'   Label1(24).Caption = szTemp(1)
'   txtVAT.text = Format(Val(txtAmount.text) * (Val(szTemp(2)) / 100), "0.00")
'   txtTotal.text = Format(Val(txtAmount.text) + Val(txtVAT.text), "0.00")
'
'   cboVatCode.Visible = False
'End Sub

'Private Sub cboVatCode_GotFocus()
'   Const CB_SHOWDROPDOWN = &H14F
'   Dim Tmp
'   Tmp = CboShowDown(cboVatCode.hWnd, CB_SHOWDROPDOWN, 1, ByVal 0&)
'End Sub

'Private Sub cboVatCode_KeyPress(KeyAscii As Integer)
'    If KeyAscii = 13 Then
'        If cmdUpdate.Enabled = True Then
'            cmdUpdate.SetFocus
'        End If
'    End If
'   If KeyAscii = 27 Then cboVatCode.Visible = False
'   'KeyAscii = 0
'End Sub

'Private Sub cboVatCode_LostFocus()
'   cboVatCode.Visible = False
'End Sub

'Private Sub chkSelectAllDemands_KeyPress(KeyAscii As Integer)
'   If KeyAscii <> 32 Then Exit Sub
'   Dim iRow As Integer, i As Integer
'
'   If chkSelectAllDemands.Value Then
'      For i = 1 To flxDemands.Rows - 1
'         flxDemands.TextMatrix(i, 0) = ""
'      Next i
'      For i = 1 To flxDemands.Rows - 1
'         iIncDec = iIncDec + SelectFlxGridRow(0, flxDemands, i)
'      Next i
'      ConfigFlxGrid flxChildDemands
'
'      szLastIDClicked = flxDemands.TextMatrix(flxDemands.Rows - 1, 1)
'      Call FillChildinGrid(szLastIDClicked, flxChildDemands)
'      fraDetails.Caption = "Demand Details: " & szLastIDClicked
'      iSelectedDemandsRow = flxDemands.Rows - 1
'   Else
'      ClearGridSelection
'      Exit Sub
'
'      For i = 1 To flxDemands.Rows - 1
'         Call SelectFlxGridRow(0, flxDemands, i)
'      Next i
'      iIncDec = 0
'      ConfigFlxGrid flxChildDemands
'      szLastIDClicked = ""
'      fraDetails.Caption = "Demand Details: " & szLastIDClicked
'      iSelectedDemandsRow = 0
'   End If
'End Sub

Private Sub ClearGridSelection()
   Dim i As Integer

   For i = 1 To flxDemands.Rows - 1
      If flxDemands.TextMatrix(i, 0) = "X" Then Call SelectFlxGridRow(0, flxDemands, i)
   Next i
   iIncDec = 0
   ConfigFlxGrid flxChildDemands
   szLastIDClicked = ""
   fraDetails.Caption = "Demand Details: " & szLastIDClicked
   iSelectedDemandsRow = 0
End Sub

'Private Sub chkSelectAllDemands_MouseUp(Button As Integer, Shift As Integer, X As Single, Y As Single)
'   Dim iRow As Integer, i As Integer
'
'   If chkSelectAllDemands.Value Then
'      For i = 1 To flxDemands.Rows - 1
'         flxDemands.TextMatrix(i, 0) = ""
'      Next i
'      For i = 1 To flxDemands.Rows - 1
'         iIncDec = iIncDec + SelectFlxGridRow(0, flxDemands, i)
'      Next i
'      ConfigFlxGrid flxChildDemands
'
'      szLastIDClicked = flxDemands.TextMatrix(flxDemands.Rows - 1, 1)
'
'      Call FillChildinGrid(szLastIDClicked, flxChildDemands)
'      fraDetails.Caption = "Demand Details: " & szLastIDClicked
'      iSelectedDemandsRow = flxDemands.Rows - 1
'   Else
'      For i = 1 To flxDemands.Rows - 1
'         Call SelectFlxGridRow(0, flxDemands, i)
'      Next i
'      iIncDec = 0
'      ConfigFlxGrid flxChildDemands
'      szLastIDClicked = ""
'      fraDetails.Caption = "Demand Details: " & szLastIDClicked
'      iSelectedDemandsRow = 0
'   End If
'End Sub

'Private Sub cmbBankAc_Click()
'   Dim szaBankBal() As String
'
'   szaBankBal = Split(szAllBankBalance, " # ")
'End Sub

'**   This procedue will be called when user will choose 'settle All'.
'**   All Cr transactions will be allocated against Dr.
'**   The mapping between Dr and Cr will not be shown here.
'**   It will be mapped in at the time of saving.
Private Sub AutoAllocSA()                          'Automatic allocation - Settle All
   Dim iRow As Integer, iInd As Integer, j As Integer, valx As Integer
   Dim dProcessAmount As Double, iGridRow As Integer
   Dim bTrue As Boolean, iCount As Integer, iActiveRow As Integer, cAllocTotal As Currency

   If (flxCrPoA.Rows = 0) Then Exit Sub

'  Sorting the grid index into an array
   ReDim dSortIndex(flxSPayment.Rows - 2)

   dSortIndex(0) = 1
   iCount = 1

   If (optOIF.Value) Then                                      'Old Invoice First - is selected
      For iGridRow = 2 To flxSPayment.Rows - 1
         If flxSPayment.TextMatrix(iGridRow, 0) <> "-" Then
            For iInd = 0 To iCount - 1
               If (CDate(flxSPayment.TextMatrix(iGridRow, 5))) < CDate(flxSPayment.TextMatrix(dSortIndex(iInd), 5)) Then
                  j = iCount
                  Do
                     dSortIndex(j) = dSortIndex(j - 1)
                     j = j - 1
                  Loop While j > iInd
                  dSortIndex(iInd) = iGridRow
                  Exit For

               End If
            Next iInd
            If iInd = iCount Then dSortIndex(iCount) = iGridRow
            iCount = iCount + 1
         End If
      Next iGridRow
   Else                                                  'Recent Invoice First - is selected
      For iGridRow = 2 To flxSPayment.Rows - 1
         If flxSPayment.TextMatrix(iGridRow, 0) <> "-" Then
            For iInd = 0 To iCount - 1
               If (CDate(flxSPayment.TextMatrix(iGridRow, 5))) > CDate(flxSPayment.TextMatrix(dSortIndex(iInd), 5)) Then
                  j = iCount
                  Do
                     dSortIndex(j) = dSortIndex(j - 1)
                     j = j - 1
                  Loop While j > iInd
                  dSortIndex(iInd) = iGridRow
                  Exit For

               End If
            Next iInd
            If iInd = iCount Then dSortIndex(iCount) = iGridRow
            iCount = iCount + 1
         End If
      Next iGridRow
   End If

   dProcessAmount = MinAmtAlloc(flxSPayment, flxCrPoA)

   If (flxCrPoA.TextMatrix(iActiveRow, 3) = "ADJC") Then
      For j = 0 To iCount - 1
         If (flxSPayment.TextMatrix(dSortIndex(j), 2) = "ADJI") Then
            If (dProcessAmount > flxSPayment.TextMatrix(dSortIndex(j), 9)) Then
               flxSPayment.TextMatrix(dSortIndex(j), 10) = flxSPayment.TextMatrix(dSortIndex(j), 9)
               baChangesMade(dSortIndex(j)) = IIf(Val(flxSPayment.TextMatrix(dSortIndex(j), 10)) > 0, True, False)
               dProcessAmount = dProcessAmount - flxSPayment.TextMatrix(dSortIndex(j), 9)
               flxSPayment.TextMatrix(dSortIndex(j), 15) = "A"
               cAllocTotal = cAllocTotal + CCur(flxSPayment.TextMatrix(dSortIndex(j), 10))
            Else
               flxSPayment.TextMatrix(dSortIndex(j), 10) = Format(dProcessAmount, "0.00")
               baChangesMade(dSortIndex(j)) = IIf(Val(flxSPayment.TextMatrix(dSortIndex(j), 10)) > 0, True, False)
               flxSPayment.TextMatrix(dSortIndex(j), 15) = "A"
               cAllocTotal = cAllocTotal + CCur(flxSPayment.TextMatrix(dSortIndex(j), 10))
               Exit For
            End If
         End If
      Next j

      flxCrPoA.TextMatrix(iActiveRow, 9) = Format(cAllocTotal, "0.00")
   Else
      cAllocTotal = 0
      j = 0
      While cAllocTotal < dProcessAmount
         If flxSPayment.TextMatrix(dSortIndex(j), 2) <> "AdjI" Then
            If (dProcessAmount - cAllocTotal > Val(flxSPayment.TextMatrix(dSortIndex(j), 8))) Then
               txtSPayment.text = Format(flxSPayment.TextMatrix(dSortIndex(j), 9), "0.00")
               flxSPayment.row = dSortIndex(j)
               iCurRow = dSortIndex(j)
               txtSPayment_LostFocus
            Else
               txtSPayment.text = Format(dProcessAmount - cAllocTotal, "0.00")
               flxSPayment.row = dSortIndex(j)
               iCurRow = dSortIndex(j)
               txtSPayment_LostFocus
            End If
            cAllocTotal = cAllocTotal + CCur(flxSPayment.TextMatrix(dSortIndex(j), 10))
            j = j + 1
         End If
      Wend

      cAllocTotal = 0
      j = 1

      While cAllocTotal < dProcessAmount
         If flxCrPoA.TextMatrix(j, 1) <> "AdjC" Then
            If (dProcessAmount - cAllocTotal > flxCrPoA.TextMatrix(j, 8)) Then
               flxCrPoA.TextMatrix(j, 9) = flxCrPoA.TextMatrix(j, 8)
            Else
               flxCrPoA.TextMatrix(j, 9) = Format(dProcessAmount - cAllocTotal, "0.00")
            End If
            cAllocTotal = cAllocTotal + CCur(flxCrPoA.TextMatrix(j, 9))
            j = j + 1
         End If
      Wend
   End If
End Sub

Private Function MinAmtAlloc(conFlxSPayment As MSHFlexGrid, conFlxSCrPoA As MSHFlexGrid) As Double
   Dim iRow As Integer, dDr As Double, dCr As Double

   MinAmtAlloc = 0

   For iRow = 1 To conFlxSPayment.Rows - 1
      If conFlxSPayment.TextMatrix(iRow, 0) <> "-" Then
         MinAmtAlloc = MinAmtAlloc + CDbl(conFlxSPayment.TextMatrix(iRow, 8))
      End If
   Next iRow
   For iRow = 1 To conFlxSCrPoA.Rows - 1
      If conFlxSCrPoA.TextMatrix(iRow, 0) <> "-" Then
         dCr = dCr + CDbl(conFlxSCrPoA.TextMatrix(iRow, 8))
      End If
   Next iRow

   If MinAmtAlloc > dCr Then MinAmtAlloc = dCr

   MinAmtAlloc = RoundingNumber(MinAmtAlloc, 2)
End Function
Private Function MinAmtAllocate() As String
   'Written by anol 20170216
   ' find the amount
  '1/ If credit amount outstanding is less than or equal to the debit amount it will populate the whole of the credit amount
  '2/ If credit amount is greater than the debit amount outstanding  it will populate the whole of the debit amount
' dDr means amount you are entering
'dCr total os remains in the invoice
   Dim iRow As Integer, dDr As Double, dCr As Double

   MinAmtAllocate = 0
   dDr = CDbl(flxSPayment.TextMatrix(flxSPayment.row, 9))
   If CDbl(flxSPayment.TextMatrix(flxSPayment.row, 10)) > 0 Then
        MinAmtAllocate = Format(RoundingNumber(CDbl(flxSPayment.TextMatrix(flxSPayment.row, 10)), 2), "0.00")
        Exit Function
   End If
   For iRow = 1 To flxSPayment.Rows - 1
      If flxSPayment.TextMatrix(iRow, 0) <> "-" Then
      'the receipt which has been already distributed needs to be minus from the credit
         dCr = dCr - CDbl(flxSPayment.TextMatrix(iRow, 10))
      End If
   Next iRow
   
   For iRow = 1 To flxCrPoA.Rows - 1
      If flxCrPoA.TextMatrix(iRow, 0) <> "-" Then
         dCr = dCr + CDbl(flxCrPoA.TextMatrix(iRow, 9))
      End If
   Next iRow
  
   If dCr <= dDr Then MinAmtAllocate = dCr
   If dCr > dDr Then MinAmtAllocate = dDr
   MinAmtAllocate = Format(RoundingNumber(MinAmtAllocate, 2), "0.00")
End Function
Private Sub AutomaticAllocationTR()
   Dim iRow As Integer, iInd As Integer, j As Integer, valx As Integer
   Dim iSortIndex() As Integer, ProcessAmount As Double, iGridRow As Integer
   Dim bTrue As Boolean, iCount As Integer, iActiveRow As Integer, cAllocTotal As Currency

   If (flxCrPoA.Rows = 0) Then Exit Sub

'  Sorting the grid index into an array
   ReDim iSortIndex(flxSPayment.Rows - 2)

   iSortIndex(0) = 1
   iCount = 1

   If (optOIF.Value) Then                                      'Old Invoice First - is selected
      For iGridRow = 2 To flxSPayment.Rows - 1
         If flxSPayment.TextMatrix(iGridRow, 0) <> "-" Then
            For iInd = 0 To iCount - 1
               If (CDate(flxSPayment.TextMatrix(iGridRow, 5))) < CDate(flxSPayment.TextMatrix(iSortIndex(iInd), 5)) Then
                  j = iCount
                  Do
                     iSortIndex(j) = iSortIndex(j - 1)
                     j = j - 1
                  Loop While j > iInd

                  iSortIndex(iInd) = iGridRow
                  Exit For

               End If
            Next iInd
            If iInd = iCount Then iSortIndex(iCount) = iGridRow
            iCount = iCount + 1
         End If
      Next iGridRow
   Else                                                  'Recent Invoice First - is selected
      For iGridRow = 2 To flxSPayment.Rows - 1
         If flxSPayment.TextMatrix(iGridRow, 0) <> "-" Then
            For iInd = 0 To iCount - 1
               If (CDate(flxSPayment.TextMatrix(iGridRow, 5))) > CDate(flxSPayment.TextMatrix(iSortIndex(iInd), 5)) Then
                  j = iCount
                  Do
                     iSortIndex(j) = iSortIndex(j - 1)
                     j = j - 1
                  Loop While j > iInd

                  iSortIndex(iInd) = iGridRow
                  Exit For

               End If
            Next iInd
            If iInd = iCount Then iSortIndex(iCount) = iGridRow
            iCount = iCount + 1
         End If
      Next iGridRow
   End If

   iActiveRow = IIf(flxCrPoA.row = 0, 1, flxCrPoA.row)

   Label10(4).Caption = iActiveRow
   lblSelectedTranID.Caption = flxCrPoA.TextMatrix(iActiveRow, 10)

   ProcessAmount = IIf(CCur(flxCrPoA.TextMatrix(iActiveRow, 9)) = 0, CDbl(flxCrPoA.TextMatrix(iActiveRow, 8)), CDbl(flxCrPoA.TextMatrix(iActiveRow, 9)))

   If (flxCrPoA.TextMatrix(iActiveRow, 3) = "ADJC") Then
      For j = 0 To iCount - 1
         If (flxSPayment.TextMatrix(iSortIndex(j), 2) = "ADJI") Then
            If (ProcessAmount > flxSPayment.TextMatrix(iSortIndex(j), 9)) Then
               flxSPayment.TextMatrix(iSortIndex(j), 10) = flxSPayment.TextMatrix(iSortIndex(j), 9)
               baChangesMade(iSortIndex(j)) = IIf(Val(flxSPayment.TextMatrix(iSortIndex(j), 10)) > 0, True, False)
               ProcessAmount = ProcessAmount - flxSPayment.TextMatrix(iSortIndex(j), 9)
               flxSPayment.TextMatrix(iSortIndex(j), 15) = "A"
               flxSPayment.TextMatrix(iSortIndex(j), 16) = lblSelectedTranID.Caption
               cAllocTotal = cAllocTotal + CCur(flxSPayment.TextMatrix(iSortIndex(j), 10))
            Else
               flxSPayment.TextMatrix(iSortIndex(j), 10) = Format(ProcessAmount, "0.00")
               baChangesMade(iSortIndex(j)) = IIf(Val(flxSPayment.TextMatrix(iSortIndex(j), 10)) > 0, True, False)
               flxSPayment.TextMatrix(iSortIndex(j), 15) = "A"
               flxSPayment.TextMatrix(iSortIndex(j), 16) = lblSelectedTranID.Caption
               cAllocTotal = cAllocTotal + CCur(flxSPayment.TextMatrix(iSortIndex(j), 10))
               Exit For
            End If
         End If
      Next j

      flxCrPoA.TextMatrix(iActiveRow, 9) = Format(cAllocTotal, "0.00")
   Else
      For j = 0 To iCount - 1
         If flxSPayment.TextMatrix(iSortIndex(j), 2) <> "AdjI" Then
            If (ProcessAmount > flxSPayment.TextMatrix(iSortIndex(j), 9)) Then               'if Cr amt more than Inv amt
               txtSPayment.text = Format(flxSPayment.TextMatrix(iSortIndex(j), 9), "0.00")
               flxSPayment.row = iSortIndex(j)
               iCurRow = iSortIndex(j)
               txtSPayment_LostFocus
'               flxSPayment.TextMatrix(iSortIndex(j), 10) = flxSPayment.TextMatrix(iSortIndex(j), 9)
               baChangesMade(iSortIndex(j)) = IIf(Val(flxSPayment.TextMatrix(iSortIndex(j), 10)) > 0, True, False)
               ProcessAmount = ProcessAmount - flxSPayment.TextMatrix(iSortIndex(j), 9)
               flxSPayment.TextMatrix(iSortIndex(j), 15) = "A"
               flxSPayment.TextMatrix(iSortIndex(j), 16) = lblSelectedTranID.Caption
               cAllocTotal = cAllocTotal + CCur(flxSPayment.TextMatrix(iSortIndex(j), 10))
            Else
               txtSPayment.text = Format(ProcessAmount, "0.00")
               flxSPayment.row = iSortIndex(j)
               iCurRow = iSortIndex(j)
               txtSPayment_LostFocus
'               flxSPayment.TextMatrix(iSortIndex(j), 10) = Format(ProcessAmount, "0.00")
               baChangesMade(iSortIndex(j)) = IIf(Val(flxSPayment.TextMatrix(iSortIndex(j), 10)) > 0, True, False)
               flxSPayment.TextMatrix(iSortIndex(j), 15) = "A"
               flxSPayment.TextMatrix(iSortIndex(j), 16) = lblSelectedTranID.Caption
               cAllocTotal = cAllocTotal + CCur(flxSPayment.TextMatrix(iSortIndex(j), 10))
               Exit For
            End If
         End If
      Next j

      flxCrPoA.TextMatrix(iActiveRow, 9) = Format(cAllocTotal, "0.00")
   End If
''  'Resolved by BOSL
''  'issue 456 Demand receipt allocations causing data inconsistency
''  'solution : I have put here a check point
''  'Modified by Anol 13 Aug 2014
''   If flxCrPoA.row = 1 Then
''       'check anything is there
''       If Val(flxCrPoA.TextMatrix(1, 8)) <> 0 And Val(flxCrPoA.TextMatrix(1, 9)) <> 0 Then
''            If Val(flxCrPoA.TextMatrix(1, 8)) > Val(flxCrPoA.TextMatrix(1, 9)) Then
''                 'waring and disable
''                 ShowMsgInTaskBar "The credit amount to be allocated cannot be greater than the available debits", "Y", "N"
''                    'Issue no 456
''                             'Modified by anol 31 Aug 2014
''                               Dim iRowSp As Integer
''                               'Dim iRow As Integer
''                                  For iRow = 1 To flxSPayment.Rows - 1
''                                     If flxSPayment.TextMatrix(iRow, 15) = "A" Then
''                                        flxSPayment.TextMatrix(iRow, 10) = "0.00"
''                                        flxSPayment.TextMatrix(iRow, 15) = ""
''                                        flxSPayment.TextMatrix(iRow, 16) = ""
''
''                                        If flxSPayment.TextMatrix(iRow, 0) = "+" Or _
''                                               flxSPayment.TextMatrix(iRow, 0) = ">" Then
''                                           iRowSp = iRow + 1
''                                           Do
''                                              flxSPayment.TextMatrix(iRowSp, 10) = "0.00"
''                                              iRowSp = iRowSp + 1
''                                              If flxSPayment.Rows = iRowSp Then Exit Do
''                                           Loop While flxSPayment.TextMatrix(iRowSp, 0) = "-"
''                                           iRow = iRowSp - 1
''                                        End If
''                                     End If
''                                  Next iRow
''
''                                  For iRow = 1 To flxCrPoA.Rows - 1
''                                     flxCrPoA.TextMatrix(iRow, 9) = "0.00"
''                                  Next iRow
''
''                                  flxSPayment.Enabled = True
''                                  flxCrPoA.Enabled = True
''                                  cmdAllocateSave.Enabled = False
''                                  lblAllocating.Visible = False
''                                  Frame5(4).Enabled = True                       'Allocation - Saving
''                                  txtAllocatedDiff.text = "0.00"
''                                  cmdAutomatic.Enabled = True
''                        'End of modification.
''                 Exit Sub
''            End If
''       End If
''   End If
   Frame4(1).Visible = False
   tabDmdRcpt.Enabled = True
   tabPayment.Enabled = True

   cmdAllocateSave.Enabled = True
   cmdAllocateSave.SetFocus

   cmdAutomatic.Enabled = False
End Sub

Private Sub cmbRptAmtType_Click()
   'txtSPDate.SetFocus
End Sub

Private Sub cmdArchive_Click()
   Dim szTemp     As String
   Dim szLine     As String

   szTemp = Dir$(App.Path & "\Logs\moved_SI.dat")
'MsgBox ">" & szTemp & "<"
'   If szTemp <> "moved_SI.dat" Then
'      If MsgBox("Email archiving process is being updated." & Chr(13) & _
'                "Please make sure there is no one is using Prestige." & Chr(13) & _
'                "Do you want to proceed now?", vbQuestion + vbYesNo, "Email Archive") = vbYes Then
''        Move Email_SI.dat to server
'         szTemp = Dir$(DB_PATH & "\AllStuff\Logs\Email_SI.dat")
'
'         If szTemp <> "Email_SI.dat" Then
''            CreateNonExistsFolder DB_PATH & "\AllStuff\Logs"
'            Open DB_PATH & "\AllStuff\Logs\Email_SI.dat" For Append As #1
'         End If
''        Read the old log file
'         Open App.Path & "\Logs\Email_SI.dat" For Input As #2
'
''        Transfer data to the new location
'         While Not EOF(2)
'            Line Input #2, szLine
'            Print #1, szLine
'         Wend
'
'         Close #1
'         Close #2
'
''        Mark the system that archive has been transfered to server
'         Open App.Path & "\Logs\moved_SI.dat" For Output As #1
'         Close #1
'
'         MoveTempFolder2Server
'      Else
'         Exit Sub
'      End If
'   End If

   Load frmEmailSalesInv
   frmEmailSalesInv.Show
End Sub

Private Sub cmdAutoAllocSel_Click()
    
   If tabPayment.Tab = 0 Then
        'Resolved by BOSL
        'issue 456 Demand receipt allocations causing data inconsistency
        'solution : I have put here a atomic check point
        'Modified by Anol 23 Sep 2014
        Dim invoiceAmt As Double
        Dim ReceiptAmt As Double
        Dim DiffAmt As Double
        Dim iRow As Integer
        For iRow = 1 To flxCrPoA.Rows - 1
           If flxCrPoA.RowHeight(iRow) > 0 Then
              ReceiptAmt = ReceiptAmt + Val(flxCrPoA.TextMatrix(iRow, 8))
           End If
             'added by anol 20170115 automatic allocation was not clearing manual entry and the difference
           DiffAmt = DiffAmt + Val(flxCrPoA.TextMatrix(iRow, 9))
           If chkSettleAll.Value = 1 Then
              flxCrPoA.TextMatrix(iRow, 9) = "0.00"
           End If
        Next iRow
        For iRow = 1 To flxSPayment.Rows - 1
           If flxSPayment.RowHeight(iRow) > 0 Then
              invoiceAmt = invoiceAmt + Val(flxSPayment.TextMatrix(iRow, 9))
           End If
           'added by anol 20170115 automatic allocation was not clearing manual entry and the difference
           flxSPayment.TextMatrix(iRow, 10) = "0.00"
           If chkSettleAll.Value = 1 Then
                txtArray(4).text = "0.00"
           End If
        Next iRow
        If (ReceiptAmt - invoiceAmt) > 0 Then
           ShowMsgInTaskBar "The credit amount to be allocated cannot be greater than the available debits", "Y", "N"
           Exit Sub
        End If
        If Not lblAllocating.Visible And flxSPayment.TextMatrix(flxSPayment.row, 2) <> "ADJI" And _
                 Val(txtSPaymentTotal.text) >= 0 And Val(txtArray(4).text) = 0 And cmdAllocate.Caption <> "All&ocation Only" And chkSettleAll.Value = 0 Then
                 MsgBox " You must first select a credit amount from the grid below before you can enter any amounts in this grid.", vbInformation + vbOKOnly, "Allocation"
                 Frame4(1).Visible = False
                 tabDmdRcpt.Enabled = True
                 tabPayment.Enabled = True
                 FocusControl flxCrPoA
                 Exit Sub
        End If
       txtArray(4).text = "0.00" 'Format(DiffAmt, "0.00")
      'End of addition
      If chkSettleAll.Value = 0 Then
         AutomaticAllocationTR
      Else
         AutoAllocSA                               'Automatic allocation - Settle All
'            'Resolved by BOSL
'            'issue 456 Demand receipt allocations causing data inconsistency
'            'solution : I have put here a check point
'            'Modified by Anol 13 Aug 2014
'             If flxCrPoA.row = 1 Then
'                 'check anything is there
'                 If Val(flxCrPoA.TextMatrix(1, 8)) <> 0 And Val(flxCrPoA.TextMatrix(1, 9)) <> 0 Then
'                      If Val(flxCrPoA.TextMatrix(1, 8)) > Val(flxCrPoA.TextMatrix(1, 9)) Then
'                           'waring and disable
'                           ShowMsgInTaskBar "The credit amount to be allocated cannot be greater than the available debits", "Y", "N"
'                           'Issue no 456
'                             'Modified by anol 31 Aug 2014
'                               Dim iRowSp As Integer
'                               Dim iRow As Integer
'                                  For iRow = 1 To flxSPayment.Rows - 1
'                                     If flxSPayment.TextMatrix(iRow, 15) = "A" Then
'                                        flxSPayment.TextMatrix(iRow, 10) = "0.00"
'                                        flxSPayment.TextMatrix(iRow, 15) = ""
'                                        flxSPayment.TextMatrix(iRow, 16) = ""
'
'                                        If flxSPayment.TextMatrix(iRow, 0) = "+" Or _
'                                               flxSPayment.TextMatrix(iRow, 0) = ">" Then
'                                           iRowSp = iRow + 1
'                                           Do
'                                              flxSPayment.TextMatrix(iRowSp, 10) = "0.00"
'                                              iRowSp = iRowSp + 1
'                                              If flxSPayment.Rows = iRowSp Then Exit Do
'                                           Loop While flxSPayment.TextMatrix(iRowSp, 0) = "-"
'                                           iRow = iRowSp - 1
'                                        End If
'                                     End If
'                                  Next iRow
'
'                                  For iRow = 1 To flxCrPoA.Rows - 1
'                                     flxCrPoA.TextMatrix(iRow, 9) = "0.00"
'                                  Next iRow
'
'                                  flxSPayment.Enabled = True
'                                  flxCrPoA.Enabled = True
'                                  cmdAllocateSave.Enabled = False
'                                  lblAllocating.Visible = False
'                                  Frame5(4).Enabled = True                       'Allocation - Saving
'                                  txtAllocatedDiff.text = "0.00"
'                                  cmdAutomatic.Enabled = True
'                        'End of modification.
'                           Exit Sub
'                      End If
'                 End If
'             End If
         Frame4(1).Visible = False
         tabDmdRcpt.Enabled = True
         tabPayment.Enabled = True

         cmdAllocateSave.Enabled = True
         cmdAllocateSave.SetFocus

         cmdAutomatic.Enabled = False
      End If
   End If
   cmdSPSave.Refresh
   MousePointer = vbArrow
End Sub

Private Sub cmdAutoAllocSelCancel_Click()
   Frame4(1).Visible = False
   tabDmdRcpt.Enabled = True
   tabPayment.Enabled = True
   cmdAutomatic.SetFocus
End Sub

Private Sub cmdAutomatic_Click()
   Frame4(1).Left = tabDmdRcpt.Left + tabPayment.Left + Frame5(4).Left + Frame5(4).Width - 60
   Frame4(1).Top = tabDmdRcpt.Top + tabPayment.Top + Frame5(4).Top - Frame4(1).Height + Frame5(4).Height - 20
'   CreateBorder4Frame Frame4(1), Shape4(29), Shape4(25)
   Frame4(1).Visible = True
   cmdAutoAllocSel.SetFocus

   tabDmdRcpt.Enabled = False
   tabPayment.Enabled = False

End Sub

'Private Sub cmdBankCancel_Click()
'   Frame5(6).Visible = False
'   tabDmdRcpt.Enabled = True
'   tabPayment.Enabled = True
''   cmdNewBk(0).SetFocus
'End Sub
'
'Private Sub cmdBankOK_Click()
'   If optReceipt Then
'      BANK_TYPE = "Bank Receipt"
'      Label3(3).Visible = True
'      Label3(4).Visible = False
'   Else
'      BANK_TYPE = "Bank Payment"
'      Label3(4).Visible = True
'      Label3(3).Visible = False
'   End If
'
'   Frame5(6).Visible = False
'   tabDmdRcpt.Enabled = True
'   tabPayment.Enabled = True
'   bChangesMade = True
'End Sub

Private Sub cmdBankReceiptHistory_Click()
   If Not BANK_PAYMENT_HISTORY_LOADED Then
      Load frmBankPaymentHistory
   End If

   frmBankPaymentHistory.Show
   frmBankPaymentHistory.ZOrder 0
End Sub

Private Sub cmdBatchDemands_Click()
   If Not BATCH_DEMAND_PROCESS Then
      Load frmBatchDemands
      frmBatchDemands.Show
   End If
End Sub

Private Sub cmdBatchDemands_MouseMove(Button As Integer, Shift As Integer, X As Single, Y As Single)
   'Me.MousePointer = vbArrow
End Sub

Private Sub cmdCopy_Click()
   Dim szType As String

   If iIncDec <> 1 Then
      MsgBox "Please select one demand only.", vbInformation + vbOKOnly, "Demand Selection"
      chkSelectAllDemands.Value = 0
      Exit Sub
   End If '   frmPopUpMenu.Top = x

'   frmPopUpMenu.Top = frmMMain.fraCmdButton.Height + cmdCopy.Top + frmDemands3.Top + fraEditDemand.Top + tabDmdRcpt.Top + 1160
'   frmPopUpMenu.Left = frmMMain.tvwLandLord.Width + frmDemands3.Left + fraEditDemand.Left + tabDmdRcpt.Left + cmdCopy.Left + 80

   frmPopUpMenu.CallingFrom "Demands"
   frmPopUpMenu.TRANSACITON_ID_LONG = SelectedID(szType)
   frmPopUpMenu.TRANS_TYPE = szType
   frmPopUpMenu.Show
End Sub

Private Sub cmdCopySalesTranHistory_Click()
   Dim i As Integer, iDmdSel As Integer

   iDmdSel = 0
   For i = 1 To flxDemandHistory.Rows - 1
      If flxDemandHistory.TextMatrix(i, 0) = "X" Then iDmdSel = iDmdSel + 1
   Next i

   If iDmdSel <> 1 Then
      MsgBox "Please select one demand only.", vbInformation + vbOKOnly, "Demand Selection"
      flxDemandHistory.SetFocus
      Exit Sub
   End If '   frmPopUpMenu.Top = x

  
   frmPopUpMenu.CallingFrom "Demands"
   frmPopUpMenu.Show
End Sub

Private Sub cmdDemandList_MouseMove(Index As Integer, Button As Integer, Shift As Integer, X As Single, Y As Single)
'  Me.MousePointer = vbArrow
End Sub

Private Sub cmdDLCancel_Click()
   Label7(5).Caption = "Date Range:"
   fraDemandListCriteria.Visible = False
   tabDmdRcpt.Enabled = True
End Sub

Private Sub cmdDLCancel_LostFocus()
   If Not fraDemandListCriteria.Visible Then Exit Sub
   txtDLFrom.SetFocus
End Sub

Private Sub cmdDLOk_Click()
'   MousePointer = vbHourglass

   If Not optDmdListSng.Visible Then
      If txtDLFrom.text = "" Then
         ShowMsgInTaskBar "Please enter the Service Charge Start Date.", "Y", "N"
         txtDLFrom.SetFocus
         Exit Sub
      End If
      If txtDLTo.text = "" Then
         ShowMsgInTaskBar "Please enter the Service Charge End Date.", "Y", "N"
         txtDLTo.SetFocus
         Exit Sub
      End If

      dtSC_StFrom = txtDLFrom.text
      dtSC_StTo = txtDLTo.text

      optDmdListSng.Visible = True
      optDmdListCons.Visible = True
      Label7(5).Caption = "Date Range:"
      fraDemandListCriteria.Visible = False
      tabDmdRcpt.Enabled = True

      cmdEmailDmds_Click

      Exit Sub
   End If

   Dim adoConn As New ADODB.Connection
   Dim szSQL As String, i As Integer
   Dim reportApp As New CRAXDRT.Application
   Dim Report As CRAXDRT.Report
   Dim rep As frmReport

   Set adoConn = New ADODB.Connection
   adoConn.Open getConnectionString

   szSQL = "UPDATE DemandRecords " & _
           "SET DemandRecords.spare2 = '' " & _
           "WHERE DemandRecords.spare2 <> ''"

   adoConn.Execute szSQL

   For i = 1 To flxDemands.Rows - 1
      szSQL = "UPDATE DemandRecords " & _
              "SET DemandRecords.spare2 = 'Y' " & _
              "WHERE DemandRecords.DemandID = " & Val(flxDemands.TextMatrix(i, 1)) & ";"

      adoConn.Execute szSQL
   Next i

   If optDmdListSng.Value Then
      Set Report = reportApp.OpenReport(App.Path & szReportPath & "\PrintDemandListSng.rpt")
   Else
      Set Report = reportApp.OpenReport(App.Path & szReportPath & "\PrintDemandList.rpt")
   End If
   Report.Database.Tables(1).ConnectionProperties.Item("Database Password") = accessDBPws

   Report.EnableParameterPrompting = False
   Report.DiscardSavedData

   Report.ParameterFields(1).AddCurrentValue CDate(txtDLFrom.text)
   Report.ParameterFields(2).AddCurrentValue CDate(txtDLTo.text)

   Set rep = New frmReport
   Load rep
   rep.LoadReportViewer Report

'   MousePointer = vbDefault

   adoConn.Close
   Set adoConn = Nothing

   fraDemandListCriteria.Visible = False
   tabDmdRcpt.Enabled = True
End Sub

Private Sub cmdDmdGridUnitLookup_Click()
   picDmdLeaseList.Visible = False
   txtDmdTenantSearchID.text = ""
   tabDmdRcpt.Enabled = True
   cmdDmdTenantLookup.SetFocus
End Sub

Private Function FlxDemandHistorySelectionCount() As Integer
   Dim i As Integer

   FlxDemandHistorySelectionCount = 0
   For i = 1 To flxDemandHistory.Rows - 1
      If flxDemandHistory.TextMatrix(i, 0) = "X" Then _
         FlxDemandHistorySelectionCount = FlxDemandHistorySelectionCount + 1
   Next i
End Function

Private Sub cmdDmdHist_PrtSel_Click()
   Dim rsMinDueDate As New ADODB.Recordset
   Dim szSQL As String, varAns As Integer, rRow As Integer
   Dim reportApp As New CRAXDRT.Application
   Dim Report As CRAXDRT.Report
   Dim adoRptDr As New ADODB.Recordset
'    Declare Variables
   Dim szDataPath As String
   Call ChangeReportODBC
   varAns = FlxDemandHistorySelectionCount()
   If varAns < 1 Then
      MsgBox "Please select atleast one demand from the grid.", vbCritical, "No demand selected"
      Exit Sub
   End If

   Dim iRow As Integer, szWhere As String, iTemp As Integer
   Dim adoConn As New ADODB.Connection
   Dim adoRstDRecords As New ADODB.Recordset, adoRstDRCurrent As New ADODB.Recordset
   Dim adoTenants As New ADODB.Recordset

   adoConn.Open getConnectionString

   adoConn.Execute "DELETE * FROM tlbDRCURRENTPRINT;"
   szSQL = "SELECT * FROM tlbDRCURRENTPRINT;"
   adoRstDRCurrent.Open szSQL, adoConn, adOpenDynamic, adLockPessimistic

'*********************************************************************************************
   For iRow = 1 To flxDemandHistory.Rows - 1
      If flxDemandHistory.TextMatrix(iRow, 0) = "X" Then

         szWhere = "DR.DEMANDID = " + CStr(CLng(flxDemandHistory.TextMatrix(iRow, 1))) + ""
         szSQL = "SELECT DR.DEMANDID AS D_ID, DR.BATCHID AS B_ID, " & _
                           "DR.SAGEACCOUNTNUMBER AS S_AC, " & _
                           "DR.UNITNUMBER AS U_NUM, DR.SOURCE AS SOU, " & _
                           "DR.TRANSACTIONTYPE AS T_TYPE, " & _
                           "DR.ISSUEDATE AS IDT, DR.GenerateDemand AS CS, DSR.A_M AS A_M, " & _
                           "DSR.splitid as S_ID, DSR.NOMINALCODEFORAMOUNT AS NCA, " & _
                           "DSR.NOMINALNAMEFORAMOUNT AS NNA, " & _
                           "DSR.NOMINALCODEFORVAT AS NCV, " & _
                           "DSR.NOMINALNAMEFORVAT AS NNV, " & _
                           "DSR.NOMINALCODEFORTOTAL AS NCT, " & _
                           "DSR.NOMINALNAMEFORTOTAL AS NNT, " & _
                           "DSR.AMOUNT AS AMT, DSR.VATAMOUNT AS VAMT, " & _
                           "DSR.TOTALAMOUNT AS TAMT, " & _
                           "DSR.SAGEREF AS SREF, " & _
                           "DSR.DUEDATE AS DDT, " & _
                           "DSR.VATMONTH AS VMTH, " & _
                           "DSR.TYPEOFDEMAND AS TDM, " & _
                           "DSR.DESCRIPTION AS DESCR, " & _
                           "DSR.DEMANDSTATEMENT AS D_ST, " & _
                           "DSR.DATEFROM AS D_FROM, " & _
                           "DSR.DATETO AS D_TO, Tenants.spare1, DemandTypes.DTGroup, " & _
                           "DemandTypes.DemandReportName AS DRN, DemandTypes.CategoryCode "
         szSQL = szSQL & _
                        "FROM DemandRecords as DR, DemandSplitRecords as DSR, Tenants, DemandTypes "
         szSQL = szSQL & _
                        "WHERE (" & szWhere & ") AND " & _
                           "DSR.DEMANDID = DR.DEMANDID AND " & _
                           "Tenants.SAGEACCOUNTNUMBER = DR.SAGEACCOUNTNUMBER AND " & _
                           "DSR.TYPEOFDEMAND = DemandTypes.ID " & _
                        "ORDER BY DSR.splitid;"
'Debug.Print szSQL
         adoRstDRecords.Open szSQL, adoConn, adOpenDynamic, adLockPessimistic

'           GET N UNDATE THE INVOICE NUMBER
         strSelectedPrintRef = Format(NextRef(adoConn, "PRINT_REF"), "00000000")

         While Not adoRstDRecords.EOF
            If IsNull(adoRstDRecords.Fields.Item("spare1").Value) Or _
                  InStr(adoRstDRecords.Fields.Item("spare1").Value, "NotD") = 0 Then
               adoRstDRCurrent.AddNew

               adoRstDRCurrent.Fields("UniqueRefNumber").Value = adoRstDRecords.Fields("D_ID").Value
               adoRstDRCurrent.Fields("Batch").Value = adoRstDRecords.Fields("B_ID").Value
               adoRstDRCurrent.Fields("AutomaticManual").Value = adoRstDRecords.Fields("A_M").Value
               adoRstDRCurrent.Fields("SageAccountNumber").Value = adoRstDRecords.Fields("S_AC").Value
               szSQL = "SELECT sum(SWITCH(TYPE =1,Amount,TYPE =23,Amount,TYPE =2,-Amount,TYPE =3,-Amount,TYPE =4,-Amount))  as Amt, " & _
                "tlbReceipt.SageAccountNumber  From tlbReceipt where SageAccountNumber='" & adoRstDRecords.Fields("S_AC").Value & _
                "'  group by SageAccountNumber "
                'AND RDate <=#" & Format(adoRstDRecords.Fields("IDT").Value, "dd MMM yyyy") & "#
                adoRptDr.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
                If Not adoRptDr.EOF Then
                      adoConn.Execute "Update Tenants set Balance=" & IIf(IsNull(adoRptDr("amt").Value), 0, adoRptDr("amt").Value) _
                      & "  where SageAccountNumber='" & adoRstDRecords.Fields("S_AC").Value & "' "
                End If
                adoRptDr.Close
                  
               adoRstDRCurrent.Fields("UnitNumber").Value = adoRstDRecords.Fields("U_NUM").Value
               adoRstDRCurrent.Fields("NominalCodeforAmount").Value = adoRstDRecords.Fields("NCA").Value
               adoRstDRCurrent.Fields("NominalNameforAmount").Value = adoRstDRecords.Fields("NNA").Value
               adoRstDRCurrent.Fields("NominalCodeforVAT").Value = adoRstDRecords.Fields("NCV").Value
               adoRstDRCurrent.Fields("NominalNameforVAT").Value = adoRstDRecords.Fields("NNV").Value
               adoRstDRCurrent.Fields("NominalCodeforTotal").Value = adoRstDRecords.Fields("NCT").Value
               adoRstDRCurrent.Fields("NominalNameforTotal").Value = adoRstDRecords.Fields("NNT").Value
               adoRstDRCurrent.Fields("Source").Value = adoRstDRecords.Fields("DTGroup").Value
               adoRstDRCurrent.Fields("TransactionType").Value = adoRstDRecords.Fields("T_TYPE").Value
               adoRstDRCurrent.Fields("IssueDate").Value = adoRstDRecords.Fields("IDT").Value
               adoRstDRCurrent.Fields("VATMonth").Value = adoRstDRecords.Fields("VMTH").Value
               adoRstDRCurrent.Fields("Typeofdemand").Value = adoRstDRecords.Fields("TDM").Value
               adoRstDRCurrent.Fields("Reference").Value = adoRstDRecords.Fields("SREF").Value
               adoRstDRCurrent.Fields("Description").Value = adoRstDRecords.Fields("DESCR").Value
               adoRstDRCurrent.Fields("PRINT_ID").Value = strSelectedPrintRef
               adoRstDRCurrent.Fields("DemandReportName").Value = adoRstDRecords.Fields("DRN").Value
'               If adoRstDRecords.Fields("CS").Value = "S" Then
               adoRstDRCurrent.Fields("DTCategory").Value = adoRstDRecords.Fields("CategoryCode").Value
'               Else
'                  adoRstDRCurrent.Fields("DTCategory").Value = 0
'               End If

               If adoRstDRecords.Fields("D_ST").Value Then
                  adoRstDRCurrent.Fields("DueDate").Value = adoRstDRecords.Fields("DDT").Value
                   rsMinDueDate.Open "Select MIN(DUEDATE) as mindate From DemandSplitRecords DSR where DSR.DEMANDID = " + CStr(CLng(flxDemandHistory.TextMatrix(iRow, 1))) + "", adoConn, adOpenKeyset, adLockReadOnly
                      If Not rsMinDueDate.EOF Then
                            adoRstDRCurrent.Fields("MinDueDate").Value = rsMinDueDate.Fields("mindate").Value
                      End If
                  rsMinDueDate.Close

                  adoRstDRCurrent.Fields("TotalAmount").Value = adoRstDRecords.Fields("TAMT").Value
                  adoRstDRCurrent.Fields("VATAmount").Value = adoRstDRecords.Fields("VAMT").Value
                  adoRstDRCurrent.Fields("Amount").Value = adoRstDRecords.Fields("AMT").Value
                  adoRstDRCurrent.Fields("DemandFrom").Value = adoRstDRecords.Fields("D_FROM").Value
                  adoRstDRCurrent.Fields("DemandTo").Value = adoRstDRecords.Fields("D_TO").Value
               End If

               adoRstDRCurrent.Update
            End If
            adoRstDRecords.MoveNext
         Wend
         adoRstDRecords.Close
      End If
   Next iRow
   adoRstDRCurrent.Close

'PRINT DEMAND INVOICES ACCORDING TO DEMAND TYPE
   szSQL = "SELECT tlbDRCurrentPrint.DemandReportName, tlbDRCurrentPrint.Source " & _
                  "FROM tlbDRCurrentPrint " & _
                  "GROUP BY tlbDRCurrentPrint.DemandReportName, Source;"
'Debug.Print szSQL
   adoRstDRCurrent.Open szSQL, adoConn, adOpenStatic, adLockReadOnly

   Dim rep As frmReport

   If adoRstDRCurrent.EOF Then
      
      'Resolved by BOSL. Issue No: 0000481
      'Modified by Asif. 28 Sep 2014 12:32 AM
      
      'MsgBox "No Demand to print.", vbInformation + vbOKOnly, "Demand Printing"
      
      MsgBox "The print demand option is not set for the selected Lessee(s). " & vbNewLine & vbNewLine & "Please tick the print demand check box on the lessee record to print your demands.", vbInformation + vbOKOnly, "Demand Printing"
   End If

   On Error GoTo ERR_REPORT
   While Not adoRstDRCurrent.EOF
      ' Passing the from and to date values to Crystal Reports
      Set Report = reportApp.OpenReport(App.Path & szReportPath & "\" & adoRstDRCurrent.Fields.Item("DemandReportName").Value)
      Report.Database.Tables(1).ConnectionProperties.Item("Database Password") = accessDBPws

      Report.EnableParameterPrompting = False
      Report.DiscardSavedData

      Report.ParameterFields(1).AddCurrentValue CInt(adoRstDRCurrent.Fields("Source").Value)

      Set rep = New frmReport
      Load rep
      rep.LoadReportViewer Report
      adoRstDRCurrent.MoveNext
   Wend
   adoRstDRCurrent.Close
   Set adoRstDRCurrent = Nothing
   'clearing the X mark
   LoadFlxGrid flxDemandHistory, True, adoConn, ""  'True - uploading history records
   adoConn.Close
   Set adoConn = Nothing
   Exit Sub

ERR_REPORT:
   MsgBox "The report name has not been set properly in the demand type form. Please check!", vbCritical + vbOKOnly, "Report Printing"
   adoRstDRCurrent.Close
   Set adoRstDRCurrent = Nothing
   adoConn.Close
   Set adoConn = Nothing
End Sub
'Private Sub cboDmdClientList_Click()
''rem rhis code was by anol 23 Dec 2015
''Resolved by BOSL
''Issue 459 :Manual Demand Invoice
''select an invoice. Then change the client to a different value. You should notice the property remains the same. Now click Lessee. This should cause the program to crash.
''newly create this event by anol 18 Aug 2014
'     If cboDmdClientList.ListCount = 0 Then Exit Sub
'
'   Dim adoConn As New ADODB.Connection
'   Dim adoRst As New ADODB.Recordset
'   Dim szSQL As String, Data() As String
'   Dim TotalRow As Integer, TotalCol As Integer
'   Dim i As Integer, j As Integer
'
'   On Error GoTo ErrorHandler
'
'   adoConn.Open getConnectionString
'
'   szSQL = "SELECT PropertyID, PropertyName, " & _
'               "ProAddressLine1, ProPostCode " & _
'           "FROM Property " & _
'           "WHERE ClientID = '" & txtDmdClientList.text & "' " & _
'           "ORDER BY PropertyID;"
'
'   adoRst.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
'
'   If adoRst.EOF Then GoTo NoRes
'
'   TotalRow = adoRst.RecordCount
'   TotalCol = adoRst.Fields.count
'
'   ReDim Data(TotalCol, TotalRow) As String
'
'   For i = 0 To TotalRow - 1
'       For j = 0 To TotalCol - 1
'           Data(j, i) = IIf(IsNull(adoRst.Fields(j).Value), "", adoRst.Fields(j).Value)
'       Next j
'       adoRst.MoveNext
'       If adoRst.EOF Then Exit For
'   Next i
'   cboDmdPropertyList.Column() = Data()
'   If cboDmdPropertyList.ListCount > 0 Then
'        cboDmdPropertyList.ListIndex = 0
'   End If
'NoRes:
'   adoRst.Close
'   adoConn.Close
'   Set adoRst = Nothing
'   Set adoConn = Nothing
'   Exit Sub
'
'ErrorHandler:
'   MsgBox ERR.description & "::" & ERR.Number
'
'   adoRst.Close
'   adoConn.Close
'   Set adoRst = Nothing
'   Set adoConn = Nothing
'End Sub
Private Sub cmdDmdTenantLookup_Click()
    'Resolved by BOSL
    'issue 459 :Manual Demand Invoice.Select an invoice. Then change the client to a different value. You should notice the property remains the same. Now click Lessee. This should cause the program to crash.
    'Modified by Anol 18 Aug 2014
'       If Trim(txtDmdPropertyList.text) = "" Then
'             ShowMsgInTaskBar "Please select property.", "Y"
'             cmdDmdPropertyList.SetFocus
'             Exit Sub
'        End If
   'Me.MousePointer = vbHourglass

   Dim adoConn As New ADODB.Connection
   Dim szSQL As String

   adoConn.Open getConnectionString

   ConfigureDmdFlxLeaseList

   If txtDmdClientList.text = "ALL" And txtDmdPropertyList.text = "" And Not chkCL.Value Then
      If chkOldTenats.Value Then
         szSQL = "SELECT Tenants.SageAccountNumber, Name, LeaseDetails.UnitNumber, LeaseDetails.Status " & _
              "From Tenants, LeaseDetails " & _
              "WHERE ((Tenants.Comments) IS NULL OR Tenants.Comments='') AND " & _
               "Tenants.SageAccountNumber = LeaseDetails.SageAccountNumber " & _
             "ORDER BY Tenants.SageAccountNumber;"
      Else
         szSQL = "SELECT Tenants.SageAccountNumber, Name, LeaseDetails.UnitNumber, LeaseDetails.Status " & _
              "From Tenants, LeaseDetails " & _
              "WHERE ((Tenants.Comments) IS NULL OR Tenants.Comments='') AND " & _
               "Tenants.SageAccountNumber = LeaseDetails.SageAccountNumber AND " & _
               "LeaseDetails.Status = True " & _
             "ORDER BY Tenants.SageAccountNumber;"
      End If
   End If

   If txtDmdClientList.text <> "ALL" And txtDmdPropertyList.text = "" And Not chkCL.Value Then
      If chkOldTenats.Value Then
         szSQL = "SELECT Tenants.SageAccountNumber, Name, LeaseDetails.UnitNumber, LeaseDetails.Status " & _
              "From Tenants, LeaseDetails, Units, Property " & _
              "WHERE ((Tenants.Comments) IS NULL OR Tenants.Comments='') AND " & _
               "Tenants.SageAccountNumber = LeaseDetails.SageAccountNumber AND " & _
               "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
               "Units.PropertyID = Property.PropertyID AND " & _
               "Property.ClientID = '" & txtDmdClientList.text & "' " & _
             "ORDER BY Tenants.SageAccountNumber;"
      Else
         szSQL = "SELECT Tenants.SageAccountNumber, Name, LeaseDetails.UnitNumber, LeaseDetails.Status " & _
              "From Tenants, LeaseDetails, Units, Property " & _
              "WHERE ((Tenants.Comments) IS NULL OR Tenants.Comments='') AND " & _
               "Tenants.SageAccountNumber = LeaseDetails.SageAccountNumber AND " & _
               "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
               "LeaseDetails.Status = True AND " & _
               "Units.PropertyID = Property.PropertyID AND " & _
               "Property.ClientID = '" & txtDmdClientList.text & "' " & _
             "ORDER BY Tenants.SageAccountNumber;"
      End If
   End If

   If txtDmdClientList.text = "ALL" And txtDmdPropertyList.text <> "" And Not chkCL.Value Then
      If chkOldTenats.Value Then
         szSQL = "SELECT Tenants.SageAccountNumber, Name, LeaseDetails.UnitNumber, LeaseDetails.Status " & _
              "From Tenants, LeaseDetails, Units " & _
              "WHERE ((Tenants.Comments) IS NULL OR Tenants.Comments='') AND " & _
               "Tenants.SageAccountNumber = LeaseDetails.SageAccountNumber AND " & _
               "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
               "Units.PropertyID = '" & txtDmdPropertyList.text & "' " & _
             "ORDER BY Tenants.SageAccountNumber;"
      Else
         szSQL = "SELECT Tenants.SageAccountNumber, Name, LeaseDetails.UnitNumber, LeaseDetails.Status " & _
              "From Tenants, LeaseDetails, Units " & _
              "WHERE ((Tenants.Comments) IS NULL OR Tenants.Comments='') AND " & _
               "Tenants.SageAccountNumber = LeaseDetails.SageAccountNumber AND " & _
               "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
               "LeaseDetails.Status = True AND " & _
               "Units.PropertyID = '" & txtDmdPropertyList.text & "' " & _
             "ORDER BY Tenants.SageAccountNumber;"
      End If
   End If

   If txtDmdClientList.text <> "ALL" And txtDmdPropertyList.text <> "" And Not chkCL.Value Then
      If chkOldTenats.Value Then
         szSQL = "SELECT Tenants.SageAccountNumber, Name, LeaseDetails.UnitNumber, LeaseDetails.Status " & _
              "From Tenants, LeaseDetails, Units, Property " & _
              "WHERE ((Tenants.Comments) IS NULL OR Tenants.Comments='') AND " & _
               "Tenants.SageAccountNumber = LeaseDetails.SageAccountNumber AND " & _
               "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
               "Units.PropertyID = Property.PropertyID AND " & _
               "Property.ClientID = '" & txtDmdClientList.text & "' AND " & _
               "Units.PropertyID = '" & txtDmdPropertyList.text & "' " & _
             "ORDER BY Tenants.SageAccountNumber;"
      Else
         szSQL = "SELECT Tenants.SageAccountNumber, Name, LeaseDetails.UnitNumber, LeaseDetails.Status " & _
              "From Tenants, LeaseDetails, Units, Property " & _
              "WHERE ((Tenants.Comments) IS NULL OR Tenants.Comments='') AND " & _
               "Tenants.SageAccountNumber = LeaseDetails.SageAccountNumber AND " & _
               "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
               "LeaseDetails.Status = True AND " & _
               "Units.PropertyID = Property.PropertyID AND " & _
               "Property.ClientID = '" & txtDmdClientList.text & "' AND " & _
               "Units.PropertyID = '" & txtDmdPropertyList.text & "' " & _
             "ORDER BY Tenants.SageAccountNumber;"
      End If
   End If

   If chkCL.Value Then
      szSQL = "SELECT LandlordID AS CLID, LandlordName AS CLNAME, 'LANDLORD' AS VAL " & _
              "FROM Landlord " & _
              "UNION " & _
              "SELECT AgentID AS CLID, AgentName AS CLNAME, 'AGENT' AS VAL " & _
              "FROM Agent;"
   End If

   PopulateDmdTenantLookup adoConn, szSQL
   If frmMMain.frmDemand3_LesseList_isUptoDate = False Then
        '  Load all tenants with balance in gridTenantLookup
        TenantAccountBalance adoConn
        frmMMain.frmDemand3_LesseList_isUptoDate = True
   End If
  'TenantAccountBalance adoConn
  
  'added by anol
   UpdateBalance2
   adoConn.Close
   Set adoConn = Nothing

   txtDmdTenantSearchID.text = ""
   txtDmdTenantSearchName.text = ""
   txtDmdTenantSearchUnitName.text = ""
   picDmdLeaseList.Top = txtTenantName.Top + 330
   picDmdLeaseList.Left = txtTenantName.Left + 500
   picDmdLeaseList.Visible = True
   Label20(7).Caption = "Unit ID"
   Label20(7).Visible = True
   Label20(8).Caption = "Lessee Name"
   txtDmdTenantSearchUnitName.Visible = True
   picDmdLeaseList.ZOrder 0
   tabDmdRcpt.Enabled = False
   txtDmdTenantSearchID.SetFocus

   Me.MousePointer = vbArrow
End Sub

Private Sub cmdEdit_MouseMove(Button As Integer, Shift As Integer, X As Single, Y As Single)
  Me.MousePointer = vbArrow
'
'   If fraInvCrChoice.Visible Then fraInvCrChoice.Visible = False
End Sub

Private Sub cmdEditReceipt_Click()
   Dim szaTenant() As String
   Dim adoConn As New ADODB.Connection
   adoConn.Open getConnectionString
   If sEditSRR = 1 Then 'upper grid ...for type 23
           
          'issue 571 note 1153
          'by anol 30 Aug 2015
          If Not editexception Then
                If flxSPayment.TextMatrix(flxSPayment.row, 20) <> "" Then
                   'ShowMsgInTaskBar "The refund has been reconciled and cannot be edited", "Y", "N"
                   'Exit Sub
                   '515-Modification to edit transactions
                   frmReceiptEdit.BoolReconciled = True
                Else
                   frmReceiptEdit.BoolReconciled = False
                End If
                ''End If
                If Val(flxSPayment.TextMatrix(flxSPayment.row, 8)) <> Val(flxSPayment.TextMatrix(flxSPayment.row, 9)) Then
                   ShowMsgInTaskBar "You cannot edit a part allocated refund. Please unallocate fully before edit", "Y", "N"
                   Exit Sub
                End If
          End If
           szaTenant = Split(txtTenantID.text, " \ ")
        
           Load frmReceiptEdit
        '------------------------------
           With frmReceiptEdit
              .Caption = .Caption & " Refund - " & flxSPayment.TextMatrix(flxSPayment.row, 1)
              .txtLessee.text = szaTenant(0)
              .txtLesseeName.text = szaTenant(1)
             
              .txtDate.text = flxSPayment.TextMatrix(flxSPayment.row, 5)
              .lblRptPostingDate.ToolTipText = flxSPayment.TextMatrix(flxSPayment.row, 23)
              .txtRef.text = flxSPayment.TextMatrix(flxSPayment.row, 6)
              .TransactionID = flxSPayment.TextMatrix(flxSPayment.row, 19)
              .InvoiceNO = flxSPayment.TextMatrix(flxSPayment.row, 1)
              'client for screen
              'by anol issue 571 25 aug 2015
              '.cboClient.ListIndex = FindComboIndex(.cboClient, flxSPayment.TextMatrix(flxSPayment.row, 17), 0)
              .txtClient.text = txtRptClientList.text 'flxSPayment.TextMatrix(flxSPayment.row, 17)
              .txtClient.Tag = txtRptClientList.Tag
              .LoadBank_Fund_amtType adoConn
              .cmbRptAmtType.ListIndex = FindComboIndex(.cmbRptAmtType, flxSPayment.TextMatrix(flxSPayment.row, 22), 0)
              .cmbBankAc.ListIndex = FindComboIndex(.cmbBankAc, flxSPayment.TextMatrix(flxSPayment.row, 21), 0)
              .LoadFlxReceiptSplit adoConn
              
               
           End With
        
           Me.Enabled = False
           frmReceiptEdit.txtClient.Locked = True
           frmReceiptEdit.Show

   End If
    If sEditSRR = 2 Then 'lower grid for type 3,4
           If flxCrPoA.row = 0 Then
              MsgBox "Please select a receipt.", vbInformation + vbOKOnly, "Edit Receipt"
              Exit Sub
           End If
        
           If Left(flxCrPoA.TextMatrix(flxCrPoA.row, 0), 2) = "SC" Then
              MsgBox "Please edit the Sales Credit transaction in the demand grid.", vbInformation + vbOKOnly, "Edit Receipt"
              Exit Sub
           End If
        
           If flxCrPoA.TextMatrix(flxCrPoA.row, 7) = "" Then Exit Sub
           'locking check start
            'validation on locking
            flxCrPoA.col = 0
            Dim rsLockCheck As New ADODB.Recordset
            rsLockCheck.Open "Select UserSessionID,WindowsUserName,MachineName,Module,ClientID from tlbreceipt where transactionID=" & flxCrPoA.TextMatrix(flxCrPoA.row, 10) & _
            "", adoConn, adOpenStatic, adLockReadOnly
            If Not rsLockCheck.EOF Then
                If rsLockCheck("UserSessionID").Value <> "" And rsLockCheck("UserSessionID").Value <> UserSessionID Then
                    flxCrPoA.CellBackColor = vbRed
                    MsgBox "The selected " & flxCrPoA.TextMatrix(flxCrPoA.row, 1) & " is currently locked by '" & IIf(IsNull(rsLockCheck("WindowsUserName").Value), "", rsLockCheck("WindowsUserName").Value) & _
                            "' on '" & IIf(IsNull(rsLockCheck("MachineName").Value), "", rsLockCheck("MachineName").Value) & "' in the '" & IIf(IsNull(rsLockCheck("Module").Value), "", rsLockCheck("Module").Value) & "'" & vbCrLf & "" & _
                            "screen for the Client '" & IIf(IsNull(rsLockCheck("ClientID").Value), "", rsLockCheck("ClientID").Value) & "' and cannot be edited. Please wait until it is released.", vbInformation, "Warning"
                    Exit Sub
                Else
                    flxCrPoA.CellBackColor = vbWhite
                    'you need to now lock it for your screen because other person has released it
                     adoConn.Execute "Update tlbReceipt Set  DateTimeStamp='" & Now & "',Module='Demand Receipt',UserSessionID='" & UserSessionID & "',WindowsUserName='" & SystemUser & "',MachineName='" & WS_Name & "'," & _
                   "PrestigeUserName='" & User & "',ServerIPaddress='" & GetIPaddress & "' where TransactionID=" & flxCrPoA.TextMatrix(flxCrPoA.row, 10) & ""
                End If
           End If
           rsLockCheck.Close
           Set rsLockCheck = Nothing
           
           'locking check ends
        
        '   If Not baBankRecon(flxCrPoA.row) Then
        '      MsgBox "This receipt is Bank Reconciled and cannot be edited.", vbInformation + vbOKOnly, "Edit Receipt"
        '      Exit Sub
        '   End If
        'issue 571 note 1153
        'by anol 30 Aug 2015
            If Not editexception Then
                Dim rsCheck As New ADODB.Recordset
                'rsCheck.Close
                rsCheck.Open "Select ReconNow from tlbReceipt where TransactionID=" & flxCrPoA.TextMatrix(flxCrPoA.row, 10) & "", adoConn, adOpenDynamic, adLockOptimistic
                If Not rsCheck.EOF Then
                     If Not IsNull(rsCheck.Fields.Item("ReconNow").Value) Then
                        'MsgBox "This receipt is Bank Reconciled and cannot be edited.", vbInformation + vbOKOnly, "Edit Receipt"
                        '515-Modification to edit transactions
                        frmReceiptEdit.BoolReconciled = True
                        'adoConn.Close
                        'Set adoConn = Nothing
                        'Exit Sub
                     Else
                        frmReceiptEdit.BoolReconciled = False
                     End If
                    
                End If
                
           End If
          'end of modification
           If Val(flxCrPoA.TextMatrix(flxCrPoA.row, 7)) <> Val(flxCrPoA.TextMatrix(flxCrPoA.row, 8)) Or _
                    flxCrPoA.TextMatrix(flxCrPoA.row, 7) = "" Then
              MsgBox "You can't edit a part allocated receipt. Please unallocate fully before edit.", vbInformation + vbOKOnly, "Edit Receipt"
              Exit Sub
           End If
           If txtTenantID.text = "" Then Exit Sub
           szaTenant = Split(txtTenantID.text, " \ ")
        
           Load frmReceiptEdit
        '------------------------------
           With frmReceiptEdit
              .Caption = .Caption & " - " & flxCrPoA.TextMatrix(flxCrPoA.row, 0)
              .txtLessee.text = szaTenant(0)
              .txtLesseeName.text = szaTenant(1)
              
              .txtDate.text = flxCrPoA.TextMatrix(flxCrPoA.row, 4)
              .lblRptPostingDate.ToolTipText = flxCrPoA.TextMatrix(flxCrPoA.row, 18)
              .txtRef.text = flxCrPoA.TextMatrix(flxCrPoA.row, 5)
              .TransactionID = flxCrPoA.TextMatrix(flxCrPoA.row, 10)
              .InvoiceNO = flxCrPoA.TextMatrix(flxCrPoA.row, 0)
               'client for  screen
               'by anol issue 571 25 aug 2015
              '.cboClient.ListIndex = FindComboIndex(.cboClient, flxCrPoA.TextMatrix(flxCrPoA.row, 17), 0)
              .txtClient.text = flxCrPoA.TextMatrix(flxCrPoA.row, 17)
              .LoadBank_Fund_amtType adoConn
              .LoadFlxReceiptSplit adoConn
              .cmbBankAc.ListIndex = FindComboIndex(.cmbBankAc, flxCrPoA.TextMatrix(flxCrPoA.row, 14), 0)
              .cmbRptAmtType.ListIndex = FindComboIndex(.cmbRptAmtType, flxCrPoA.TextMatrix(flxCrPoA.row, 16), 0)
           End With
        
           Me.Enabled = False
           frmReceiptEdit.txtClient.Locked = True
           frmReceiptEdit.Show
   End If
   adoConn.Close
End Sub

Public Sub GenerateDemandPreview()
   Dim adoConn As New ADODB.Connection
   Dim szSQL As String

   adoConn.Open getConnectionString

   Call RentReview_Report(adoConn)

   If Not GenSngDmdPreView(adoConn) Then 'This function is used for both single and consolidated demand preview
      adoConn.Close
      Set adoConn = Nothing
      Unload frmDemandTypesSel
      Exit Sub
   End If

   szSQL = "UPDATE DemandRecPreview " & _
           "SET DemandRecPreview.spare2 = 'Y';"

   adoConn.Execute szSQL


   'below line added by anol 18 Jan 2016 because data was not showing to report although it is in.so making a small delay for reading.
   Call Sleep(300)
   If frmDemandTypesSel.optAutoGenSig Then
      ShowReport App.Path & szReportPath & "\PrintPreGeneratedDemandList.rpt"
   Else
      ShowReport App.Path & szReportPath & "\PrintPreGenDemandListConsolidated.rpt"
   End If

   If PrintExpiredLeases(adoConn) Then
      ShowReport App.Path & szReportPath & "\RecentlyExpLease.rpt"
   End If

   adoConn.Close
   Set adoConn = Nothing
'   Unload frmDemandTypesSel
End Sub

Private Sub cmdEmailDmds_Click()
   On Error GoTo Err
   Call ChangeReportODBC
   Dim K As Integer
   Dim iBooladditionalAttach As Boolean
   Dim rsMinDueDate As New ADODB.Recordset
   
   Dim adoRptDr As New ADODB.Recordset
   If IsLoadedAndVisible("frmReport") Then
      MsgBox "There are open reports found. Please must close all open reports before sending an email.", vbCritical + vbOKOnly, "Sending email"
      Exit Sub
   End If
   Dim szTemp As String
   szTemp = Replace(FullDatabasePath, "mdb", "ldb")
'   If FileExists(szTemp) Then
'      MsgBox "There are open demand reports on another computer. Please close all open demand reports before sending an email.", vbCritical + vbOKOnly, "Sending email"
'      Exit Sub
'   End If

   Dim szSQL         As String, iEmailDmd    As Integer
   Dim iRow          As Integer, szWhere     As String
   Dim bEmailResult  As Boolean, szLeseList  As String
   Dim szSub         As String, szBody       As String
   Dim szDemandCat   As String

   Dim adoConn As New ADODB.Connection
   Dim adoRstDRecords As New ADODB.Recordset
   Dim adoRstDRecordsEmailDmndNo As New ADODB.Recordset
   Dim adoRstDRCurrent As New ADODB.Recordset
   Dim adoRstEmailDetails  As New ADODB.Recordset
'    Declare Objects
   Dim reportApp As New CRAXDRT.Application
   Dim Report As CRAXDRT.Report

'   If szFromEmail = "" Or szSMTPserver = "" Then
'      ShowMsgInTaskBar "Company email or SMTP server IP has not been setup.", "Y", "N"
'      Exit Sub
'   End If
   
   Dim rCount As Integer
   iSelectedDemandsRow = 0
   For rCount = 1 To flxDemands.Rows - 1
        If flxDemands.TextMatrix(rCount, 0) = "X" Then
            iSelectedDemandsRow = iSelectedDemandsRow + 1
        End If
   Next
   
   If iSelectedDemandsRow < 1 Then
      MsgBox "Please select atleast one demand from the grid.", vbCritical, "No demand selected"
      Exit Sub
   End If

'   MousePointer = vbHourglass
   iLes = 0
   szEmailDmdIdList = ""

   adoConn.Open getConnectionString
   
   'Newly added by anol 2023-08-25
   ConfigureSMTP adoConn
   
   If DemandPrintIsLocked(adoConn) Then
      MsgBox "The system is busy printing demands, please come back in few minutes.", vbInformation + vbOKOnly, "Demand Printing"
      adoConn.Close
      Set adoConn = Nothing
      Exit Sub
   Else
      DemandPrintLock adoConn
   End If
'-----------------------------------------------------------------------------------------------
'  Get the subject and body of the email from template
   szSQL = "SELECT * FROM Template WHERE TemplateName = 'Demand Email Template';"
   adoRstEmailDetails.Open szSQL, adoConn, adOpenStatic, adLockReadOnly

   If Not adoRstEmailDetails.EOF Then
      szSub = adoRstEmailDetails.Fields.Item("Description").Value
      szBody = adoRstEmailDetails.Fields.Item("Body").Value
   End If
   adoRstEmailDetails.Close

'-----------------------------------------------------------------------------------------------------------
'  In this context check - will SC Statement go with demand, if so then user will be asked to put st and end date
   If dtSC_StFrom = 0 And dtSC_StTo = 0 Then
      For iRow = 1 To flxDemands.Rows - 1
         If flxDemands.TextMatrix(iRow, 0) = "X" Then
            szWhere = "" & flxDemands.TextMatrix(iRow, 1) & "" & ", " & szWhere
         End If
      Next iRow
      szWhere = Left(szWhere, Len(szWhere) - 2)

      szSQL = "SELECT Tenants.spare1, Tenants.EmailSC,U.UnitName " & _
              "FROM DemandRecords as DR, Tenants,Units U " & _
              "WHERE DR.DEMANDID IN (" & szWhere & ") AND " & _
                 "Tenants.SAGEACCOUNTNUMBER = DR.SAGEACCOUNTNUMBER AND " & _
                 "Tenants.EmailDmd = TRUE AND " & _
                 "U.UnitNumber = DR.UnitNumber AND " & _
                 "Tenants.EmailSC  = TRUE AND " & _
                 "IIF(Tenants.InvoiceTo = 'B', Tenants.Email2, Tenants.Email1) <> '';"
'   Debug.Print szSQL
      adoRstDRecords.Open szSQL, adoConn, adOpenDynamic, adLockPessimistic

      If Not adoRstDRecords.EOF Then
'        first get the start and end date of the sc statement
         fraDemandListCriteria.Left = Me.Width / 2 - fraDemandListCriteria.Width / 2
         fraDemandListCriteria.Top = Me.Height / 2 - fraDemandListCriteria.Width / 2
         'rem below function by anol 2019-11-09
         'CreateBorder4Frame fraDemandListCriteria, Shape4(37), Shape4(36)
         Label7(5).Caption = "Service Charge Statement:"
         fraDemandListCriteria.Visible = True
         tabDmdRcpt.Enabled = False
         fraDemandListCriteria.ZOrder 0
         txtDLFrom.SetFocus
         txtDLTo.text = Format(Date, "dd/mm/yyyy")
         optDmdListSng.Visible = False
         optDmdListCons.Visible = False

         adoConn.Close
         Set adoConn = Nothing

         Exit Sub
      End If
      adoRstDRecords.Close
   End If
'-----------------------------------------------------------------------------------------------------------
   If attachmentframePlayed = False Then
        If MsgBox("Do you wish to include additional attachments with this email?", vbYesNo, "Additional attachments") = vbYes Then
             iBooladditionalAttach = True
               flxAttachment.Cols = 3
               flxAttachment.Rows = 2
                flxAttachment.ColWidth(0) = 250
                flxAttachment.ColWidth(1) = 2000
                flxAttachment.ColWidth(2) = 4500
                flxAttachment.RowHeight(0) = 0
'             cmbFiles.Clear
'             ReDim DataAttach(2, 0) As String
             Frame17(0).Left = 5625
             Frame17(0).Top = 5940
             Frame17(0).Visible = True
             Exit Sub
        Else
             iBooladditionalAttach = False
             Frame17(0).Visible = False
        End If
  End If


   With adoRstDRCurrent
'   *********************************************************************************************#
'First it will loop throught grid (selected ones) and write it into DRcurrent print
      szLeseList = ""
      For iRow = 1 To flxDemands.Rows - 1
         If flxDemands.TextMatrix(iRow, 0) = "X" Then
            adoConn.BeginTrans
            adoConn.Execute "DELETE * FROM tlbDRCURRENTPRINT;"
            adoConn.CommitTrans
'            EmailDelay 20
            adoConn.BeginTrans
            adoConn.Execute "DELETE * FROM tlbDRCURRENTPRINT;"
            adoConn.CommitTrans

            szSQL = "SELECT * FROM tlbDRCURRENTPRINT;"
            .Open szSQL, adoConn, adOpenDynamic, adLockPessimistic
            
            '*****starting for updating status Where condition is now allowed to email deman
             szSQL = "SELECT DR.DEMANDID AS D_ID, DR.BATCHID AS B_ID, " & _
                           "DR.SAGEACCOUNTNUMBER AS S_AC, " & _
                           "DR.UNITNUMBER AS U_NUM, DR.SOURCE AS SOU, " & _
                           "DR.TRANSACTIONTYPE AS T_TYPE, DSR.DSR, " & _
                           "DR.ISSUEDATE AS IDT, DR.GenerateDemand AS CS, DSR.A_M AS A_M, " & _
                           "DSR.splitid as S_ID, DSR.NOMINALCODEFORAMOUNT AS NCA, " & _
                           "DSR.NOMINALNAMEFORAMOUNT AS NNA, DSR.NOMINALCODEFORVAT AS NCV, " & _
                           "DSR.NOMINALNAMEFORVAT AS NNV, DSR.NOMINALCODEFORTOTAL AS NCT, DSR.NOMINALNAMEFORTOTAL AS NNT, " & _
                           "DSR.AMOUNT AS AMT, DSR.VATAMOUNT AS VAMT, " & _
                           "DSR.TOTALAMOUNT AS TAMT, DSR.SAGEREF AS SREF, DSR.DUEDATE AS DDT, " & _
                           "DSR.VATMONTH AS VMTH, DSR.TYPEOFDEMAND AS TDM, " & _
                           "DSR.DESCRIPTION AS DESCR, DSR.DEMANDSTATEMENT AS D_ST, " & _
                           "DSR.DATEFROM AS D_FROM, DSR.VAT_CODE, " & _
                           "DSR.DATETO AS D_TO, Tenants.spare1, Tenants.EmailSC, " & _
                           "DSR.ChargingFigure, DemandTypes.DTGroup, Tenants.Name, " & _
                           "DemandTypes.EmailInvoiceTemplate AS DRN, DemandTypes.CategoryCode AS CC, " & _
                           "IIF(Tenants.InvoiceTo = 'B', Tenants.Email2, Tenants.Email1) AS EMAIL "
            szSQL = szSQL & _
                           "FROM DemandRecords as DR, DemandSplitRecords as DSR, Tenants, DemandTypes "
            szSQL = szSQL & _
                           "WHERE (DR.DEMANDID = " + CStr(CLng(flxDemands.TextMatrix(iRow, 1))) + ") AND " & _
                              "DSR.DEMANDID = DR.DEMANDID AND " & _
                              "Tenants.SAGEACCOUNTNUMBER = DR.SAGEACCOUNTNUMBER AND " & _
                              "DSR.TYPEOFDEMAND = DemandTypes.ID And Tenants.EmailDmd = false AND " & _
                              "IIF(Tenants.InvoiceTo = 'B', Tenants.Email2, Tenants.Email1) <> '' " & _
                           "ORDER BY DSR.splitid;"
            adoRstDRecordsEmailDmndNo.Open szSQL, adoConn, adOpenDynamic, adLockPessimistic
            If Not adoRstDRecordsEmailDmndNo.EOF Then
                  adoConn.Execute "update DemandRecords set SentByEmail=2 where demandID  = " + CStr(CLng(flxDemands.TextMatrix(iRow, 1))) + ";"
            End If
            adoRstDRecordsEmailDmndNo.Close
            Set adoRstDRecordsEmailDmndNo = Nothing
            
            '*****
             
             
             
             
'            szWhere = "DR.DEMANDID = " + CStr(CLng(flxDemands.TextMatrix(iRow, 1))) + ""
            szSQL = "SELECT DR.DEMANDID AS D_ID, DR.BATCHID AS B_ID, " & _
                           "DR.SAGEACCOUNTNUMBER AS S_AC, " & _
                           "DR.UNITNUMBER AS U_NUM, DR.SOURCE AS SOU, " & _
                           "DR.TRANSACTIONTYPE AS T_TYPE, DSR.DSR, " & _
                           "DR.ISSUEDATE AS IDT, DR.GenerateDemand AS CS, DSR.A_M AS A_M, " & _
                           "DSR.splitid as S_ID, DSR.NOMINALCODEFORAMOUNT AS NCA, " & _
                           "DSR.NOMINALNAMEFORAMOUNT AS NNA, DSR.NOMINALCODEFORVAT AS NCV, " & _
                           "DSR.NOMINALNAMEFORVAT AS NNV, DSR.NOMINALCODEFORTOTAL AS NCT, DSR.NOMINALNAMEFORTOTAL AS NNT, " & _
                           "DSR.AMOUNT AS AMT, DSR.VATAMOUNT AS VAMT, " & _
                           "DSR.TOTALAMOUNT AS TAMT, DSR.SAGEREF AS SREF, DSR.DUEDATE AS DDT, " & _
                           "DSR.VATMONTH AS VMTH, DSR.TYPEOFDEMAND AS TDM, " & _
                           "DSR.DESCRIPTION AS DESCR, DSR.DEMANDSTATEMENT AS D_ST, " & _
                           "DSR.DATEFROM AS D_FROM, DSR.VAT_CODE, " & _
                           "DSR.DATETO AS D_TO, Tenants.spare1, Tenants.EmailSC, " & _
                           "DSR.ChargingFigure, DemandTypes.DTGroup, Tenants.Name, " & _
                           "DemandTypes.EmailInvoiceTemplate AS DRN, DemandTypes.CategoryCode AS CC, " & _
                           "IIF(Tenants.InvoiceTo = 'B', Tenants.Email2, Tenants.Email1) AS EMAIL,U.UnitName  "
            szSQL = szSQL & _
                           "FROM DemandRecords as DR, DemandSplitRecords as DSR, Tenants, DemandTypes, Units U "
            szSQL = szSQL & _
                           "WHERE (DR.DEMANDID = " + CStr(CLng(flxDemands.TextMatrix(iRow, 1))) + ") AND " & _
                              "DSR.DEMANDID = DR.DEMANDID AND " & _
                              "U.UnitNumber = DR.UnitNumber AND " & _
                              "Tenants.SAGEACCOUNTNUMBER = DR.SAGEACCOUNTNUMBER AND " & _
                              "DSR.TYPEOFDEMAND = DemandTypes.ID And Tenants.EmailDmd = True AND " & _
                              "IIF(Tenants.InvoiceTo = 'B', Tenants.Email2, Tenants.Email1) <> '' " & _
                           "ORDER BY DSR.splitid;"
'Debug.Print szSQL
            adoRstDRecords.Open szSQL, adoConn, adOpenDynamic, adLockPessimistic

'         GET N UPDATE THE INVOICE NUMBER
            strSelectedPrintRef = Format(NextRef(adoConn, "PRINT_REF"), "00000000")
            iEmailDmd = -1
'writing tlbDRCURRENTPRINT tables lines
            While Not adoRstDRecords.EOF
               If ((IsNull(adoRstDRecords.Fields.Item("spare1").Value) Or _
                     InStr(adoRstDRecords.Fields.Item("spare1").Value, "NotD") = 0)) Then
                  .AddNew

                  .Fields.Item("UniqueRefNumber").Value = adoRstDRecords.Fields.Item("D_ID").Value
                  .Fields.Item("Batch").Value = adoRstDRecords.Fields.Item("B_ID").Value
                  .Fields.Item("AutomaticManual").Value = adoRstDRecords.Fields.Item("A_M").Value
                  .Fields.Item("SageAccountNumber").Value = adoRstDRecords.Fields.Item("S_AC").Value
                  szSQL = "SELECT sum(SWITCH(TYPE =1,Amount,TYPE =23,Amount,TYPE =2,-Amount,TYPE =3,-Amount,TYPE =4,-Amount))  as Amt, " & _
                  "tlbReceipt.SageAccountNumber  From tlbReceipt where SageAccountNumber='" & adoRstDRecords.Fields("S_AC").Value & _
                  "' group by SageAccountNumber "
                  'AND RDate <=#" & Format(adoRstDRecords.Fields("IDT").Value, "dd MMM yyyy") & "#
                  adoRptDr.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
                  If Not adoRptDr.EOF Then
                        adoConn.Execute "Update Tenants set Balance=" & IIf(IsNull(adoRptDr("amt").Value), 0, adoRptDr("amt").Value) _
                        & "  where SageAccountNumber='" & adoRstDRecords.Fields("S_AC").Value & "' "
                  End If
                  adoRptDr.Close
                  szLeseList = szLeseList & "#" & adoRstDRecords.Fields.Item("S_AC").Value & "#"
                  .Fields.Item("UnitNumber").Value = adoRstDRecords.Fields.Item("U_NUM").Value
                  .Fields.Item("NominalCodeforAmount").Value = adoRstDRecords.Fields.Item("NCA").Value
                  .Fields.Item("NominalNameforAmount").Value = adoRstDRecords.Fields.Item("NNA").Value
                  .Fields.Item("NominalCodeforVAT").Value = adoRstDRecords.Fields.Item("NCV").Value
                  .Fields.Item("NominalNameforVAT").Value = adoRstDRecords.Fields.Item("NNV").Value
                  .Fields.Item("NominalCodeforTotal").Value = adoRstDRecords.Fields.Item("NCT").Value
                  .Fields.Item("NominalNameforTotal").Value = adoRstDRecords.Fields.Item("NNT").Value
                  .Fields.Item("Source").Value = adoRstDRecords.Fields.Item("DTGroup").Value
                  .Fields.Item("TransactionType").Value = adoRstDRecords.Fields.Item("T_TYPE").Value
                  .Fields.Item("IssueDate").Value = adoRstDRecords.Fields.Item("IDT").Value
                  .Fields.Item("VATMonth").Value = adoRstDRecords.Fields.Item("VMTH").Value
                  .Fields.Item("Typeofdemand").Value = adoRstDRecords.Fields.Item("TDM").Value
                  .Fields.Item("Reference").Value = adoRstDRecords.Fields.Item("SREF").Value
                  .Fields.Item("Description").Value = adoRstDRecords.Fields.Item("DESCR").Value
                  .Fields.Item("PRINT_ID").Value = strSelectedPrintRef
                  .Fields.Item("DemandReportName").Value = adoRstDRecords.Fields.Item("DRN").Value
                  .Fields.Item("SptSlNo").Value = adoRstDRecords.Fields.Item("S_ID").Value
                  .Fields.Item("DTCategory").Value = adoRstDRecords.Fields.Item("CC").Value

                  If adoRstDRecords.Fields.Item("D_ST").Value Then
                     .Fields.Item("DueDate").Value = adoRstDRecords.Fields.Item("DDT").Value
                      rsMinDueDate.Open "Select MIN(DUEDATE) as mindate From DemandSplitRecords DSR where DSR.DEMANDID = " + CStr(CLng(flxDemands.TextMatrix(iRow, 1))) + "", adoConn, adOpenKeyset, adLockReadOnly
                      If Not rsMinDueDate.EOF Then
                            .Fields("MinDueDate").Value = rsMinDueDate.Fields("mindate").Value
                      End If
                      rsMinDueDate.Close

                     .Fields.Item("TotalAmount").Value = adoRstDRecords.Fields.Item("TAMT").Value
                     .Fields.Item("VATAmount").Value = adoRstDRecords.Fields.Item("VAMT").Value
                     .Fields.Item("Amount").Value = adoRstDRecords.Fields.Item("AMT").Value
                     .Fields.Item("DemandFrom").Value = adoRstDRecords.Fields.Item("D_FROM").Value
                     .Fields.Item("DemandTo").Value = adoRstDRecords.Fields.Item("D_TO").Value
                  End If

                  .Fields.Item("ChargingFigure").Value = adoRstDRecords.Fields.Item("ChargingFigure").Value
                  .Fields.Item("spare1").Value = adoRstDRecords.Fields.Item("DSR").Value
                  .Fields.Item("spare2").Value = adoRstDRecords.Fields.Item("VAT_CODE").Value
                  .Fields.Item("EmailSC").Value = adoRstDRecords.Fields.Item("EmailSC").Value
                  If InStr(InStr(szLeseList, "#" & adoRstDRecords.Fields.Item("S_AC").Value & "#") + 1, _
                                 szLeseList, "#" & adoRstDRecords.Fields.Item("S_AC").Value & "#") = 0 Then
                     .Fields.Item("PrintBBF").Value = True
                  End If
                  szDemandCat = CStr(adoRstDRecords.Fields.Item("CC").Value) + ", " + szDemandCat
                  .Update

'                  Creating the list of Lessee ID & Email, Client
                  If adoRstDRecords.Fields.Item("U_NUM").Value <> "" Then 'from DemandRecords as DR, DemandSplitRecords as DSR
                     iEmailDmd = ReceiverEmailList(adoRstDRecords.Fields.Item("S_AC").Value, _
                                                   adoRstDRecords.Fields.Item("EMAIL").Value, _
                                                   adoRstDRecords.Fields.Item("D_ID").Value, _
                                                   adoRstDRecords.Fields.Item("Name").Value, _
                                                   adoRstDRecords.Fields.Item("UnitName").Value, _
                                                   GetClientNameByUnit(adoRstDRecords.Fields.Item("U_NUM").Value, adoConn))
                  Else
                     iEmailDmd = ReceiverEmailList(adoRstDRecords.Fields.Item("S_AC").Value, _
                                                   adoRstDRecords.Fields.Item("EMAIL").Value, _
                                                   adoRstDRecords.Fields.Item("D_ID").Value, _
                                                   adoRstDRecords.Fields.Item("Name").Value, _
                                                   adoRstDRecords.Fields.Item("UnitName").Value)
                  End If
               End If
               adoRstDRecords.MoveNext
            Wend
            adoRstDRecords.Close
            .Close

            If szDemandCat <> "" Then
               If Right(Trim(szDemandCat), 1) = "," Then
                  szDemandCat = Left(szDemandCat, Len(Trim(szDemandCat)) - 1)
               End If
            End If

            If iEmailDmd >= 0 Then     'Create PDF and
               szSQL = "SELECT   DemandReportName, Source, SageAccountNumber, EmailSC, UniqueRefNumber " & _
                       "FROM     tlbDRCurrentPrint " & _
                       "GROUP BY DemandReportName, Source, SageAccountNumber, EmailSC, UniqueRefNumber;"
               .Open szSQL, adoConn, adOpenStatic, adLockReadOnly
'Debug.Print szSQL
               While Not .EOF
'                 Passing the FROM and TO date values to Crystal Reports
                  Set Report = reportApp.OpenReport(App.Path & szReportPath & "\" & .Fields.Item("DemandReportName").Value)
                  Report.Database.Tables(1).ConnectionProperties.Item("Database Password") = accessDBPws

                  Report.EnableParameterPrompting = False
                  If Report.HasSavedData Then Report.DiscardSavedData
    
                  Report.ParameterFields(1).AddCurrentValue .Fields.Item("Source").Value
'                 Collecting all demand ID to mark them as SENT EMAIL
                  szEmailDmdIdList = szEmailDmdIdList & .Fields.Item("UniqueRefNumber").Value & ", "

'                  Transfer report into PDF file
                  szSQL = .Fields.Item("SageAccountNumber").Value & "_" & UniqueID() & ".pdf"

                  Report.ExportOptions.DiskFileName = DB_PATH & "\AllStuff\Temp\" & szSQL
                  Report.ExportOptions.DestinationType = crEDTDiskFile
                  Report.ExportOptions.FormatType = crEFTPortableDocFormat
                  Report.ExportOptions.PDFExportAllPages = True
                  Report.Export False

                  Set Report = Nothing

'                    add the PDF in the collection
                  SaveAttachment DB_PATH & "\AllStuff\Temp\" & szSQL, .Fields.Item("SageAccountNumber").Value
                  'Debug.Print "first loop on grid creating attachement"

                  EmailDelay 20
                  Set Report = Nothing

'                 will Statement go with demand?
                  If .Fields.Item("EmailSC").Value Then
'                     YES >> Statement will go with demand
'                     if its single demand then check ?has SC St generated and attached?
'                     If optAutoGenSig.Value Then
                     If Not SC_St_Attached(.Fields.Item("SageAccountNumber").Value) Then 'check SCST in the the collection for that lessee
'                       generate the pdf statement Name
                        szSQL = .Fields.Item("SageAccountNumber").Value & "_SCST_" & UniqueID() & ".pdf"

                        CreateSC_Statement .Fields.Item("SageAccountNumber").Value, DB_PATH & "\AllStuff\Temp\" & szSQL
                        'Debug.Print "first loop on grid creating SC"
'                       add the PDF in the collection (Attaching the SC statement to the email list)
                       'if you want to add an extra attachment which shall be unique for each lessee you cannot add in here beacse in this leesee loop by grid can contain two demand for a lessee
                        'then what will happen: item will be attached twice
                        SaveAttachment DB_PATH & "\AllStuff\Temp\" & szSQL, .Fields.Item("SageAccountNumber").Value
                     End If
                  End If
                  .MoveNext
               Wend
               .Close
            End If
         End If '  "X"
      Next iRow 'Loop of grid
   End With

   Set adoRstDRCurrent = Nothing

   chkSelectAllDemands.Value = 0

   ReplaceEmailTextTag szSub, szBody, szDemandCat
   'added by anol issue 720 adding attachment to demand 2019-03-07
   
  ' cmbFiles.ListIndex = -1
   If attachmentframePlayed = True Then
'       For k = 0 To UBound(DataAttach, 2)
'            Call SaveAttachmentExtra1File(cmbFiles.Column(1, k))
'       Next k
        For K = 1 To flxAttachment.Rows - 1
            Call SaveAttachmentExtra1File(flxAttachment.TextMatrix(K, 2))
       Next K
   End If
   attachmentframePlayed = False
'   cmbFiles.Clear
'   ReDim DataAttach(2, 0) As String
    flxAttachment.Cols = 3
    flxAttachment.Rows = 2
    flxAttachment.ColWidth(0) = 250
    flxAttachment.ColWidth(1) = 2000
    flxAttachment.ColWidth(2) = 4500
    flxAttachment.RowHeight(0) = 0
   
'  Sending Email with demand invoice as attachments
   iEmailedCounter = 0
   iEmailedCounterFailed = 0
   bEmailResult = SendDemandByE_Mail(szSub, szBody, adoConn)
   dtSC_StFrom = 0
   dtSC_StTo = 0

'  Update all demands' SENT EMAIL flag
   If Len(szEmailDmdIdList) > 2 Then
      szEmailDmdIdList = Left(szEmailDmdIdList, Len(szEmailDmdIdList) - 2)
'      If UCase(SystemUser) <> "BOSLUSER" And UCase(WS_Name) <> "PCM-DEV2" Then
'            adoConn.Execute "UPDATE DemandRecords " & _
'                            "SET SentByEmail = 1 " & _
'                            "WHERE DemandID IN (" & szEmailDmdIdList & ");"
'      End If
   End If

   'LoadFlxGrid flxDemands, False, adoConn, ""
    LoadFlxDemands adoConn, ""
   If chkSelectAllDemands.Value Then chkSelectAllDemands.Value = 0

   DemandPrintUnlock adoConn

   adoConn.Close
   Set adoConn = Nothing

'   MousePointer = vbDefault

'   If iLes > 0 And bEmailResult Then
'      MsgBox "Email sent.", vbInformation + vbOKOnly, "Demands"
'   Else
'      MsgBox "No email sent.", vbExclamation + vbOKOnly, "Demands"
'   End If
   If iEmailedCounterFailed > 0 Then
   End If
   If iEmailedCounter > 0 Then
        MsgBox iEmailedCounter & " Email sent" & IIf((iEmailedCounterFailed > 0), " And " & iEmailedCounterFailed & " Email Failed", "") & ".", vbInformation + vbOKOnly, "Demands"
   Else
        MsgBox "No email sent. " & IIf((iEmailedCounterFailed > 0), iEmailedCounterFailed & " Email Failed. ", ""), vbExclamation + vbOKOnly, "Demands"
   End If
   Exit Sub
Err:
    flxAttachment.Cols = 3
    flxAttachment.Rows = 2
    flxAttachment.ColWidth(0) = 250
    flxAttachment.ColWidth(1) = 2000
    flxAttachment.ColWidth(2) = 4500
    flxAttachment.RowHeight(0) = 0
    If Err.Number = -2147206461 Then
          MsgBox "The name of the email demand report template has not been set correctly in the Demand Type screen. Please check!", vbCritical + vbOKOnly, "Email Demand Report Template"
    Else
          MsgBox Err.description, vbInformation, "Error SendDemandByE_Mail! "
          
    End If

End Sub

Private Sub ReplaceEmailTextTag(ByRef szSub As String, ByRef szBody As String, ByVal szDemandCat As String)
   Dim bR As Boolean, bS As Boolean, bI As Boolean

   bR = IIf(InStr(szDemandCat, "1") > 0, True, False)
   bS = IIf(InStr(szDemandCat, "2") > 0, True, False)
   bI = IIf(InStr(szDemandCat, "3") > 0, True, False)

   szSub = Replace(szSub, "<Rent,>", IIf(bR, IIf(bS Or bI, "Rent, ", "Rent "), ""))
   szSub = Replace(szSub, "<Service Charge,>", IIf(bS, IIf(bI, "Service Charge, ", "Service Charge "), ""))
   szSub = Replace(szSub, "<Insurance Charge>", IIf(bI, "Insurance Charge", ""))

   szBody = Replace(szBody, "<Rent,>", IIf(bR, IIf(bS Or bI, "Rent, ", "Rent "), ""))
   szBody = Replace(szBody, "<Service Charge,>", IIf(bS, IIf(bI, "Service Charge, ", "Service Charge "), ""))
   szBody = Replace(szBody, "<Insurance Charge>", IIf(bI, "Insurance Charge", ""))
End Sub

Private Function SC_St_Attached(szLessee As String) As Boolean
   SC_St_Attached = False

   Dim i          As Integer
   Dim j          As Integer
   Dim szaTemp()  As String

   On Error GoTo DeclareArray

   For i = 0 To iLes - 1
      If uLessee(i).szLesseeID = szLessee Then
         For j = 1 To uLessee(i).colAtt.Count
            szaTemp = Split(uLessee(i).colAtt(j), "\")
            szaTemp = Split(szaTemp(UBound(szaTemp)), "_")
            If szaTemp(1) = "SCST" Then
               SC_St_Attached = True
               Exit For
            End If
         Next j

         If SC_St_Attached Then Exit For
      End If
   Next i

   Exit Function
DeclareArray:
   Set uLessee(i).colAtt = New Collection
End Function

Private Sub CreateSC_Statement(szLessee As String, szFileName As String)
   Dim reportApp  As New CRAXDRT.Application
   Dim Report     As CRAXDRT.Report

   Set Report = reportApp.OpenReport(App.Path & szReportPath & "\SC_St_AutoEmail.rpt")
   Report.Database.Tables(1).ConnectionProperties.Item("Database Password") = accessDBPws

   Report.EnableParameterPrompting = False
   If Report.HasSavedData Then Report.DiscardSavedData

   Report.ParameterFields(1).AddCurrentValue szLessee
   Report.ParameterFields(2).AddCurrentValue dtSC_StFrom
   Report.ParameterFields(3).AddCurrentValue dtSC_StTo

'   Transfer report into PDF file
   Report.ExportOptions.DiskFileName = szFileName
   Report.ExportOptions.DestinationType = crEDTDiskFile
   Report.ExportOptions.FormatType = crEFTPortableDocFormat
   Report.ExportOptions.PDFExportAllPages = True
   Report.Export False
   Set Report = Nothing
End Sub
Private Function ListDemandID(i As Integer) As String
   Dim j As Integer

   For j = 1 To uLessee(i).lURN.Count
      ListDemandID = ListDemandID & CStr(uLessee(i).lURN(j)) & ", "
   Next j

   ListDemandID = Left(ListDemandID, Len(ListDemandID) - 2)
End Function
Private Function SendDemandByE_Mail(szSub As String, szBody As String, adoConn As ADODB.Connection) As Boolean
   On Error GoTo Err
   Dim i As Integer
   Dim rsDemandNo As New ADODB.Recordset
   Dim strDemandId As String
   For i = 0 To iLes - 1
      szSub = Replace(szSub, "<CLIENT NAME>", uLessee(i).szClient)
      szBody = Replace(szBody, "<CLIENT NAME>", uLessee(i).szClient)

      szSub = Replace(szSub, "<lesseename>", uLessee(i).szLesseeName)
      szBody = Replace(szBody, "<lesseename>", uLessee(i).szLesseeName)
      
      szSub = Replace(szSub, "<unitname>", uLessee(i).szUnitName)
      szBody = Replace(szBody, "<unitname>", uLessee(i).szUnitName)
      
      rsDemandNo.Open "Select iif(TransactionType=1,'SI','SC') & DmdSlNo as DemandNo from DemandRecords where DemandID IN (" & ListDemandID(i) & ")", adoConn, adOpenStatic, adLockReadOnly
      If Not rsDemandNo.EOF Then
            strDemandId = rsDemandNo("DemandNo").Value
      Else
            strDemandId = ""
      End If
      rsDemandNo.Close
      Set rsDemandNo = Nothing
'SendEmail(ByVal strSender As String, _
'          ByVal strRecipient As String, _
'          ByVal strSubject As String, _
'          ByVal strBody As String, _
'          Optional ByVal strCc As String, _
'          Optional ByVal strBcc As String, _
'          Optional ByVal colAttachments As Collection, _
'          Optional ByVal szRecipID As String, _
'          Optional ByVal szEmailType As String, _
'          Optional ByVal szRef As String) As Boolean
'               uLessee(i).szLesseeEmail = Null
       If IsNull(szFromEmail) Or Len(Trim(uLessee(i).szLesseeEmail)) = 0 Or IsNull(uLessee(i).szLesseeEmail) = True Then
            GoTo NextLoop
       End If
       SendDemandByE_Mail = SendEmail(szFromEmail, Trim(uLessee(i).szLesseeEmail), _
                                     szSub, _
                                     szBody, , , _
                                     uLessee(i).colAtt, uLessee(i).szLesseeID, "SI", , strDemandId) ' uLessee(i).lURN is a demandID
          
         'Update sendEmail  flag here
         If SendDemandByE_Mail = True Then
            adoConn.Execute "Update DemandRecords set SentByEmail=1 where DemandID IN (" & ListDemandID(i) & ")" '1 shall set flag yes
            iEmailedCounter = iEmailedCounter + 1
         Else
            adoConn.Execute "Update DemandRecords set SentByEmail=3 where DemandID IN (" & ListDemandID(i) & ")" '3 shall set flag FAILED
            iEmailedCounterFailed = iEmailedCounterFailed + 1
         End If
NextLoop:
   Next i
   Exit Function
Err:
   MsgBox Err.description
End Function

Private Sub SaveAttachment(szFile As String, szLessee As String)
   Dim i As Integer

   On Error GoTo DeclareArray
   For i = 0 To iLes - 1
      If uLessee(i).szLesseeID = szLessee Then
         uLessee(i).colAtt.Add szFile
         Exit For
      End If
   Next i
   Exit Sub

DeclareArray:
   Set uLessee(i).colAtt = New Collection
   uLessee(i).colAtt.Add szFile
End Sub
Private Sub SaveAttachmentExtra1File(szFile As String) 'This shall attach extra 1 file for each of the lessee and we know this lollection of lessee has unique lessee on each index
   Dim i As Integer

   On Error GoTo DeclareArray
   For i = 0 To UBound(uLessee)
         uLessee(i).colAtt.Add szFile
   Next i
   Exit Sub

DeclareArray:
   Set uLessee(i).colAtt = New Collection
   uLessee(i).colAtt.Add szFile
End Sub



Private Sub cmdEmailSt_Click()
   Load frmEmailLesseeSt
   frmEmailLesseeSt.Show
   Me.Enabled = False
End Sub

Private Sub cmdGenAll_MouseMove(Button As Integer, Shift As Integer, X As Single, Y As Single)
  Me.MousePointer = vbArrow
'
'   If fraInvCrChoice.Visible Then fraInvCrChoice.Visible = False
End Sub
'
'Private Sub cmdGenerateManual_MouseMove(Button As Integer, Shift As Integer, x As Single, y As Single)
'   Me.MousePointer = vbArrow
'
'   If Not cmdGenAll.Enabled Then Exit Sub
'
'   Dim szChoice As String, szaChoice() As String
'
'   cmbManualDemand.Clear
'   cmbManualDemand.AddItem "Lessee", 0
'   cmbManualDemand.AddItem "Landlord", 1
'   cmbManualDemand.ListIndex = 0
'
'   fraInvCrChoice.Left = fraGenerateDemands.Left + cmdGenerateManual.Left + cmdGenerateManual.Width + tabDmdRcpt.Left
'   fraInvCrChoice.Top = fraGenerateDemands.Top + cmdGenerateManual.Top + tabDmdRcpt.Top
'   fraInvCrChoice.Visible = True
'   fraInvCrChoice.ZOrder 0
'
'   txtGridRowNo.text = "1"
'
'   szChoice = GetSetting("PropertyManagement", "ChoosedOption", "Demand-c" & CStr(SCID))
'   szaChoice = Split(szChoice, "#")
'
'   If UBound(szaChoice) > 1 Then
'      If szaChoice(2) <> "" Then
'         If InStr(szaChoice(2), "IN") > 0 Then optManualInv.Value = True
'         If InStr(szaChoice(2), "CN") > 0 Then optManualCrNote.Value = True
'         If InStr(szaChoice(2), "AI") > 0 Then optManualAdjInv.Value = True
'         If InStr(szaChoice(2), "AC") > 0 Then optManualAdjCrNote.Value = True
'      End If
'   End If
'
''   cmdGenerateManual.Enabled = False
'   cmdManualDmdOk.SetFocus
'End Sub

Private Sub cmdGridUnitLookup_Click()
   picLeaseList.Visible = False
   txtTenantSearchID.text = ""
   chkExlessee.Enabled = True
   tabDmdRcpt.Enabled = True
    'adde by anol 08 07 2016
   tabPayment.Enabled = True
End Sub

Private Function SelDmdHistory(ByRef SelDmdHisID() As String)
   Dim i As Integer
   Dim j As Integer
   
   For i = 1 To flxDemandHistory.Rows - 1
      If flxDemandHistory.TextMatrix(i, 0) = "X" Then
'         SelDmdHistory = SelDmdHistory & CStr(Val(flxDemandHistory.TextMatrix(i, 1)))
'         SelDmdHistory = SelDmdHistory & ","
        j = j + 1
      End If
   Next i
   ReDim SelDmdHisID(j) As String
   j = 0
   For i = 1 To flxDemandHistory.Rows - 1
      If flxDemandHistory.TextMatrix(i, 0) = "X" Then
         SelDmdHisID(j) = "" & CStr(flxDemandHistory.TextMatrix(i, 1)) & ""
         j = j + 1
      End If
   Next i
   
End Function

Private Sub cmdPostDemands_MouseMove(Button As Integer, Shift As Integer, X As Single, Y As Single)
  Me.MousePointer = vbArrow
End Sub

Private Sub cmdPreViewGenDmds_MouseMove(Button As Integer, Shift As Integer, X As Single, Y As Single)
   'Me.MousePointer = vbArrow
End Sub

Private Sub cmdPrintAll_MouseMove(Button As Integer, Shift As Integer, X As Single, Y As Single)
   'Me.MousePointer = vbArrow
End Sub

Private Sub cmdPrintReceipt_Click()
        'Resolved by BOSL
        'Issue 452
        'Modified by Anol 18 Aug 2014
    Call ChangeReportODBC
    If flxReceiptHistory.TextMatrix(flxReceiptHistory.row, 2) = "" Then
        ShowMsgInTaskBar "Please select a receipt that you wish to print.", "Y", "N"
        Exit Sub
    End If
    If flxReceiptHistory.TextMatrix(1, 2) <> "" Then 'Modification end
      Dim reportApp As New CRAXDRT.Application
      Dim Report As CRAXDRT.Report
      Dim rep As frmReport
      
      Set Report = reportApp.OpenReport(App.Path & szReportPath & "\Receipt.rpt")
      Report.Database.Tables(1).ConnectionProperties.Item("Database Password") = accessDBPws

      Report.EnableParameterPrompting = False
      If Report.HasSavedData Then Report.DiscardSavedData
    'when SR27675 comes is crashing
    'anol 2020-01-04
    'fixed by anol 2020-01-13
'    StrDigitVal
      Report.ParameterFields(1).AddCurrentValue StrDigitVal(flxReceiptHistory.TextMatrix(flxReceiptHistory.row, 2))

      Set rep = New frmReport
      Load rep
      rep.LoadReportViewer Report
    Else
        'Resolved by BOSL
        'Issue 452
        'Modified by Anol 18 Aug 2014
        ShowMsgInTaskBar "Please select a receipt that you wish to print.", "Y", "N"
   End If
End Sub

Private Sub cmdPrintStatement_MouseMove(Button As Integer, Shift As Integer, X As Single, Y As Single)
   'Me.MousePointer = vbArrow
End Sub

Private Sub cmdPrintThis_MouseMove(Button As Integer, Shift As Integer, X As Single, Y As Single)
   'Me.MousePointer = vbArrow
End Sub

Private Sub cmdPrnMrk_Click()
   If iSelectedDemandsRow < 1 Then
      MsgBox "Please select atleast one demand from the grid.", vbCritical, "No demand selected"
      Exit Sub
   End If

   Dim adoConn    As New ADODB.Connection
   Dim szSQL      As String
   Dim szWhere    As String
   Dim iRow       As Integer

   adoConn.Open getConnectionString

   For iRow = 1 To flxDemands.Rows - 1
      If flxDemands.TextMatrix(iRow, 0) = "X" Then
         szWhere = "" & flxDemands.TextMatrix(iRow, 1) & "" & ", " & szWhere
         flxDemands.TextMatrix(iRow, 8) = IIf(flxDemands.TextMatrix(iRow, 8) = "YES", "NO", "YES")
      End If
   Next iRow

   szWhere = Left(szWhere, Len(szWhere) - 2)

   adoConn.Execute "UPDATE DemandRecords " & _
                   "SET    IsPrinted = IIF(IsPrinted,FALSE,TRUE) " & _
                   "WHERE  DemandID IN (" & szWhere & ");"
'#
   adoConn.Close
   Set adoConn = Nothing
   picPrnMrk.Visible = False
End Sub

Private Sub cmdPrnMrk_LostFocus()
   picPrnMrk.Visible = False
End Sub

Private Sub cmdRevHistory_Click()
   Dim szSQL As String
   Dim SelDmdHisID() As String
   Dim j As Integer
   Dim K As Integer
   Dim iRow As Integer, szDmdID As String
   Dim adoConn As New ADODB.Connection

   'On Error GoTo Catch_Error
   Call SelDmdHistory(SelDmdHisID())
   j = UBound(SelDmdHisID())
   If j = 0 Then
        MsgBox "Please select a demands from the history.", vbCritical + vbOKOnly, "Demand History"
        Exit Sub
   End If
   
   If MsgBox("Are you sure to reverse back selected demands from the history?", vbQuestion + vbYesNo, "Demand History") = vbNo Then Exit Sub
   adoConn.Open getConnectionString
   K = CInt(j / 50)
   
   If K = j / 50 Then
        'No no need to do ceiling, this is fully divisible
        K = j / 50
   Else
        K = CInt(j / 50) + 1 'This is ceiling function
   End If
   For K = 0 To K - 1
           
           szDmdID = ReturnString(K * 50, (K + 1) * 50 - 1, SelDmdHisID())
           If szDmdID = "" Then
                Exit For
           End If
           szSQL = "UPDATE DemandRecords " & _
           "SET    DemandHistory = FALSE " & _
           "WHERE  DemandID IN (" & szDmdID & ") "
'           Debug.Print szDmdID
'           Debug.Print k
            adoConn.Execute szSQL
            'DemandID is a number field
   Next
   
   
'   szSQL = "UPDATE DemandRecords " & _
'           "SET    DemandHistory = FALSE " & _
'           "WHERE  DemandID IN (" & szDmdID & ") "
           '"Below part has been commented by anol'
           'Date 10 Jun 2015
'           AND " & _
'                  "  DemandID NOT IN (" & _
'                  "     SELECT DemandRef " & _
'                  "     From tlbReceipt " & _
'                  "     WHERE Type = 1 AND Amount > OSAmount);"
''Debug.Print szSQL
'   adoconn.Execute szSQL

   LoadFlxGrid flxDemandHistory, True, adoConn, ""  'True - uploading history records
   'LoadFlxGrid flxDemands, False, adoConn, ""          'False - uploading history, which are already posted and printed and exported to sage
   LoadFlxDemands adoConn, ""
   'If chkSelectAllDemands.Value Then chkSelectAllDemands.Value = 0

   ConfigFlxGrid flxChildDemands
   ConfigFlxGrid flxChildDemandHistory

   adoConn.Close
   Set adoConn = Nothing
   chkCheckAllHisDemand.Value = 0
   If j = 1 Then
        ShowMsgInTaskBar j & " invoice has been reversed from history"
   Else
        ShowMsgInTaskBar j & " invoices have been reversed from history"
   End If
   'ShowMsgInTaskBar "System has reversed " & j & " invoices.", "Y", "P"
   
   Exit Sub

Catch_Error:
   MsgBox "Select a demand to reverese.", vbCritical + vbOKOnly, "Demand"
End Sub
Private Function ReturnString(i As Long, j As Long, ByRef SelDmdHisID() As String) As String
    On Error GoTo Err
    For j = i To j
        If SelDmdHisID(j) = "" Then
                Exit For
        End If
        ReturnString = ReturnString & SelDmdHisID(j)
        ReturnString = ReturnString & ","
    Next j
Err:
    If Len(ReturnString) > 0 Then
        ReturnString = Left(ReturnString, Len(ReturnString) - 1)
    End If
 End Function
Private Sub cmdTRH_Click()
''   'Resolved by BOSL
''    'Issue 452 Incorrect filtering
''    'Modified by Anol 11 Aug 2014
''   Dim szSQL As String, i As Integer, szWhTenant As String
''   Dim szTemp() As String, szWhClient As String, szWhProperty As String
''   Dim szWhRef As String, szWhType As String
''   Dim szWhbankcode As String
''   Dim szrpthistoryType As String
''   Dim adoConn As New ADODB.Connection
''   Dim adoRst As New ADODB.Recordset
''
''   picLeaseList.Visible = False
''   txtTenantSearchID.text = ""
''
''   If txtRptClientList1.text = "ALL" Then
''      szWhClient = ""
''   Else
''      szWhClient = " AND Property.ClientID = '" & txtRptClientList1.text & "' "
''   End If
''
''   If txtRptPropertyList1.text = "ALL" Then
''      szWhProperty = ""
''   Else
''      szWhProperty = " AND Property.PropertyID = '" & txtRptPropertyList1.text & "' "
''   End If
''
''   If txtTenantID1.text = "All Lessees" Then
''      szWhTenant = ""
''   Else
''      szTemp = Split(txtTenantID1.text, " \ ")
''      szWhTenant = " AND Tenants.SageAccountNumber = '" & szTemp(0) & "' "
''   End If
''   'If Not IsNull(cboRptBankList1.Column(0)) Then
''        If cboRptBankList1.Column(0) = "ALL" Then
''           szWhbankcode = ""
''        Else
''           szWhbankcode = " AND tlbReceipt.BankCode = '" & cboRptBankList1.Column(0) & "' "
''        End If
''   'End If
''
'''   If txtTRHRef.text = "" Then
'''      szWhRef = ""
'''   Else
'''      szWhRef = " AND tlbReceipt.ExtRef = '" & Trim(txtTRHRef.text) & "' "
'''   End If
''
''
''
''   '   connect to database
''   adoConn.Open getConnectionString
''    'If szrpthistoryType = "" Then
''         'Resolved by BOSL
'''Modified by anol 20 Apr 2015
'''Issue 0000530: Batch receipts not working correctly
'''Note 1014When the user processes a multiple batch receipt, the reference shown should be the reference entered by the user in batch receipts with multiple. This should be displayed in
'''1/ Lessee receipt history
'''I have chaged Extref to Ref for tlbReceipt
'''   szSQL = "SELECT tlbReceipt.SlNumber, tlbReceipt.SageAccountNumber, tlbReceipt.RDate, SUM(RT.ReceiptAmount) AS ReceiptAmount, tlbReceipt.Ref as Details, RIGHT(tlbTransactionTypes.CONSTANT, 2) AS TYPE, Tenants.Name, Property.PropertyID, tlbReceipt.UnitID, tlbReceipt.BankCode " & _
'''           "FROM tlbReceipt, tlbTransactionTypes, Tenants, LeaseDetails, Units, Property, RptTransactions AS RT " & _
'''           "WHERE tlbReceipt.Type = 3 AND " & _
'''            "tlbReceipt.Type = tlbTransactionTypes.TYPE_ID  AND tlbReceipt.SageAccountNumber = Tenants.SageAccountNumber AND " & _
'''            "Tenants.SageAccountNumber  = LeaseDetails.SageAccountNumber AND LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
'''            "LeaseDetails.Status = True AND Units.PropertyID = Property.PropertyID  AND RT.FromTran = tlbReceipt.TransactionID AND " & _
'''            "tlbReceipt.SlNumber >= " & Val(txtRptIDFrom.text) & " AND " & _
'''            "tlbReceipt.SlNumber <= " & Val(txtRptIDTo.text) & " AND " & _
'''            "tlbReceipt.RDate >= #" & Format(txtDateFrom1, "dd mmmm yyyy") & "# AND " & _
'''            "tlbReceipt.RDate <= #" & Format(txtDateTo1.text, "dd mmmm yyyy") & "# "
'''   szSQL = szSQL & szWhClient & szWhProperty & szWhTenant & szWhRef & szWhbankcode
'''   szSQL = szSQL & "GROUP BY tlbReceipt.SlNumber, tlbReceipt.SageAccountNumber, tlbReceipt.RDate, tlbReceipt.Ref, RIGHT(tlbTransactionTypes.CONSTANT, 2), Tenants.Name, Property.PropertyID, tlbReceipt.UnitID, tlbReceipt.BankCode"
'''   szSQL = szSQL & " UNION "
'''   szSQL = szSQL & _
'''           "SELECT tlbReceipt.SlNumber, tlbReceipt.SageAccountNumber, tlbReceipt.RDate, SUM(tlbReceipt.Amount) AS ReceiptAmount, tlbReceipt.Ref as Details, RIGHT(tlbTransactionTypes.CONSTANT, 2) AS TYPE, Tenants.Name, Property.PropertyID, tlbReceipt.UnitID, tlbReceipt.BankCode " & _
'''           "From tlbReceipt, tlbTransactionTypes, Tenants, LeaseDetails, Units, Property " & _
'''           "WHERE (tlbReceipt.Type = 4 OR tlbReceipt.Type = 23) AND " & _
'''               "tlbReceipt.Type = tlbTransactionTypes.TYPE_ID  AND tlbReceipt.SageAccountNumber = Tenants.SageAccountNumber AND " & _
'''               "Tenants.SageAccountNumber  = LeaseDetails.SageAccountNumber AND LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
'''               "LeaseDetails.Status = True AND Units.PropertyID = Property.PropertyID AND " & _
'''            "tlbReceipt.SlNumber >= " & Val(txtRptIDFrom.text) & " AND " & _
'''            "tlbReceipt.SlNumber <= " & Val(txtRptIDTo.text) & " AND " & _
'''            "tlbReceipt.RDate >= #" & Format(txtDateFrom1, "dd mmmm yyyy") & "# AND " & _
'''            "tlbReceipt.RDate <= #" & Format(txtDateTo1.text, "dd mmmm yyyy") & "# "
'''   szSQL = szSQL & szWhClient & szWhProperty & szWhTenant & szWhRef & szWhbankcode
'''   szSQL = szSQL & "GROUP BY tlbReceipt.SlNumber, tlbReceipt.SageAccountNumber, tlbReceipt.RDate, tlbReceipt.Ref, RIGHT(tlbTransactionTypes.CONSTANT, 2), Tenants.Name, Property.PropertyID, tlbReceipt.UnitID, tlbReceipt.BankCode"
'''
'''Updated by anol 02 Sep 2015
'''Lessee receipt history needs to display 0 values.
'''szSQL = ""
''   szSQL = "SELECT tlbReceipt.SlNumber, tlbReceipt.SageAccountNumber, tlbReceipt.RDate, SUM(tlbReceipt.Amount)  AS ReceiptAmount, tlbReceipt.Ref as Details, RIGHT(tlbTransactionTypes.CONSTANT, 2) AS TYPE, Tenants.Name, Property.PropertyID, tlbReceipt.UnitID, tlbReceipt.BankCode " & _
''           "FROM tlbReceipt, tlbTransactionTypes, Tenants, LeaseDetails, Units, Property " & _
''           "WHERE tlbReceipt.Type = 3 AND " & _
''            "tlbReceipt.Type = tlbTransactionTypes.TYPE_ID  AND tlbReceipt.SageAccountNumber = Tenants.SageAccountNumber AND " & _
''            "Tenants.SageAccountNumber  = LeaseDetails.SageAccountNumber AND LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
''            "LeaseDetails.Status = True AND Units.PropertyID = Property.PropertyID AND " & _
''            "tlbReceipt.RDate >= #" & Format(txtDateFrom1, "dd mmmm yyyy") & "# AND " & _
''            "tlbReceipt.RDate <= #" & Format(txtDateTo1.text, "dd mmmm yyyy") & "# "
''   szSQL = szSQL & szWhClient & szWhProperty & szWhTenant & szWhRef & szWhbankcode
''   szSQL = szSQL & "GROUP BY tlbReceipt.SlNumber, tlbReceipt.SageAccountNumber, tlbReceipt.RDate, tlbReceipt.Ref, RIGHT(tlbTransactionTypes.CONSTANT, 2), Tenants.Name, Property.PropertyID, tlbReceipt.UnitID, tlbReceipt.BankCode"
''   szSQL = szSQL & " UNION "
''   szSQL = szSQL & _
''           "SELECT tlbReceipt.SlNumber, tlbReceipt.SageAccountNumber, tlbReceipt.RDate, SUM(tlbReceipt.Amount) AS ReceiptAmount, tlbReceipt.Ref as Details, RIGHT(tlbTransactionTypes.CONSTANT, 2) AS TYPE, Tenants.Name, Property.PropertyID, tlbReceipt.UnitID, tlbReceipt.BankCode " & _
''           "From tlbReceipt, tlbTransactionTypes, Tenants, LeaseDetails, Units, Property " & _
''           "WHERE (tlbReceipt.Type = 4 OR tlbReceipt.Type = 23) AND " & _
''               "tlbReceipt.Type = tlbTransactionTypes.TYPE_ID  AND tlbReceipt.SageAccountNumber = Tenants.SageAccountNumber AND " & _
''               "Tenants.SageAccountNumber  = LeaseDetails.SageAccountNumber AND LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
''               "LeaseDetails.Status = True AND Units.PropertyID = Property.PropertyID AND " & _
''            "tlbReceipt.SlNumber >= " & Val(txtRptIDFrom.text) & " AND " & _
''            "tlbReceipt.SlNumber <= " & Val(txtRptIDTo.text) & " AND " & _
''            "tlbReceipt.RDate >= #" & Format(txtDateFrom1, "dd mmmm yyyy") & "# AND " & _
''            "tlbReceipt.RDate <= #" & Format(txtDateTo1.text, "dd mmmm yyyy") & "# "
''   szSQL = szSQL & szWhClient & szWhProperty & szWhTenant & szWhRef & szWhbankcode
''   szSQL = szSQL & "GROUP BY tlbReceipt.SlNumber, tlbReceipt.SageAccountNumber, tlbReceipt.RDate, tlbReceipt.Ref, RIGHT(tlbTransactionTypes.CONSTANT, 2), Tenants.Name, Property.PropertyID, tlbReceipt.UnitID, tlbReceipt.BankCode"
''
''
'''Debug.Print szSQL
''   ConfigFlxReceiptHistory
''
''   adoRst.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
''
''   i = 1
''   'Resolved by BOSL
''   'Issue 440
''   'modified by by Anol 11 Aug 2014
''   While Not adoRst.EOF
''      flxReceiptHistory.TextMatrix(i, 0) = adoRst!Type & adoRst!SlNumber
''     ' flxReceiptHistory.TextMatrix(i, 1) = adoRst!Type
''      flxReceiptHistory.TextMatrix(i, 1) = adoRst!RDate
''      flxReceiptHistory.TextMatrix(i, 2) = adoRst!BankCode
''      flxReceiptHistory.TextMatrix(i, 3) = adoRst!SageAccountNumber
''      flxReceiptHistory.TextMatrix(i, 4) = adoRst!propertyID
''      flxReceiptHistory.TextMatrix(i, 5) = IIf(IsNull(adoRst!unitid), "", adoRst!unitid)
''      flxReceiptHistory.TextMatrix(i, 6) = IIf(IsNull(adoRst!Details), "", adoRst!Details) ' null problem fixed by anol 20160705
''      flxReceiptHistory.TextMatrix(i, 7) = Format(adoRst!receiptAmount, "0.00")
''      If Not adoRst.EOF Then flxReceiptHistory.AddItem ""
''      adoRst.MoveNext
''      i = i + 1
''   Wend
''
''   adoRst.Close
''   Set adoRst = Nothing
''   adoConn.Close
''   Set adoConn = Nothing
''    'Resolved by BOSL
''    'Issue 452 Incorrect filtering solve of Note 3
''    'Modified by Anol 11 Aug 2014
''
''    If cmbRptHistory.text = "Sales Receipt" Then
''        For i = 1 To flxReceiptHistory.Rows - 1
''            flxReceiptHistory.RowHeight(i) = 240
''            If UCase(Left(flxReceiptHistory.TextMatrix(i, 0), 2)) <> UCase("SR") Then
''               flxReceiptHistory.RowHeight(i) = 0
''            End If
''        Next i
''    ElseIf cmbRptHistory.text = "Sales Receipt on Account" Then
''         For i = 1 To flxReceiptHistory.Rows - 1
''            flxReceiptHistory.RowHeight(i) = 240
''            If UCase(Left(flxReceiptHistory.TextMatrix(i, 0), 2)) <> UCase("SA") Then
''                flxReceiptHistory.RowHeight(i) = 0
''            End If
''         Next i
''    ElseIf cmbRptHistory.text = "Sales Receipt Refund" Then
''         For i = 1 To flxReceiptHistory.Rows - 1
''            flxReceiptHistory.RowHeight(i) = 240
''            If UCase(Left(flxReceiptHistory.TextMatrix(i, 0), 2)) <> UCase("RR") Then
''                flxReceiptHistory.RowHeight(i) = 0
''            End If
''        Next i
''   End If
End Sub
Public Sub loadflxReceiptHistory(adoConn As ADODB.Connection, Filter As String)
    'Resolved by BOSL
    'Issue 452 Incorrect filtering
    'Modified by Anol 11 Aug 2014
   Dim szSQL As String, i As Long, szWhTenant As String
   Dim szTemp() As String, szWhClient As String, szWhProperty As String
   Dim szWhRef As String, szWhType As String
   Dim szWhbankcode As String
   Dim szrpthistoryType As String
   Dim strTopWhere As String
   Dim adoRST As New ADODB.Recordset
   Dim strWhere As String
   Dim tempstr As String
   Dim dblRctTotal As Double
   picLeaseList.Visible = False
   txtTenantSearchID.text = ""
   txtArray(1).text = "0.00"
   Dim dblOSAmount As Double

   If txtRptClientList1.text = "ALL" Then
      szWhClient = ""
   Else
      szWhClient = " AND Property.ClientID = '" & txtRptClientList1.text & "' "
   End If

   If txtRptPropertyList1.text = "ALL" Then
      szWhProperty = ""
   Else
      szWhProperty = " AND Property.PropertyID = '" & txtRptPropertyList1.text & "' "
   End If

   If txtTenantID1.text = "All Lessees \ All Lessees" Or txtTenantID1.text = "All Lessees" Then
      szWhTenant = ""
   Else
      szTemp = Split(txtTenantID1.text, " \ ")
      szWhTenant = " AND Tenants.SageAccountNumber = '" & szTemp(0) & "' "
   End If

   If cmbRptHistory.text = "All Types" Or Trim(cmbRptHistory.text) = "" Then
        szWhType = "(tlbReceipt.Type = 3 Or tlbReceipt.Type = 4 OR tlbReceipt.Type = 23 ) AND "
   Else
        If cmbRptHistory.text = "Sales Receipt" Then
                szWhType = "tlbReceipt.Type = 3 AND "
        ElseIf cmbRptHistory.text = "Sales Receipt on Account" Then
                szWhType = "tlbReceipt.Type = 4 AND "
        ElseIf cmbRptHistory.text = "Sales Receipt Refund" Then
                szWhType = "tlbReceipt.Type = 23 AND "
        End If
   End If

    If Filter = "4" Then
         If txtSearchFromD.text <> "" And txtSearchToD.text <> "" Then
            strWhere = " AND tlbReceipt.RDate >=#" & Format(txtSearchFromD.text, "dd/mmm/yyyy") & "# AND tlbReceipt.RDate <=#" & Format(txtSearchToD.text, "dd/mmm/yyyy") & "#"
            If Len(txtSearchFromD.text) > 0 And Len(txtSearchToD.text) > 0 Then
                 cmdSearchLesseReceipthistory.Caption = "Clear Sea&rch"
            Else
                 cmdSearchLesseReceipthistory.Caption = "Sea&rch"
            End If
        End If
    End If
   
   '   connect to database
'   adoConn.Open getConnectionString

'Updated by anol 02 Sep 2015
'Lessee receipt history needs to display 0 values.
'szSQL = ""
   If Filter = "" And Val(txtArray(2).text) > 0 Then
        strTopWhere = " Top " & txtArray(2).text
   End If
'   szSQL = "SELECT " & strTopWhere & " Mid(tlbTransactionTypes.CONSTANT, 4, (Len(tlbTransactionTypes.CONSTANT)-3)) & tlbReceipt.SlNumber as INVNO, " & _
'           "tlbReceipt.SageAccountNumber, tlbReceipt.RDate, tlbReceipt.Amount as  ReceiptAmount," & _
'           "tlbReceipt.ExtRef, RIGHT(tlbTransactionTypes.CONSTANT, 2) AS TYPE, Tenants.Name, Property.PropertyID, tlbReceipt.UnitID, tlbReceipt.BankCode, " & _
'           "Tenants.Name,tlbReceipt.PostingDate,tlbReceipt.RptAmtType,tlbReceipt.FundID,tlbReceipt.Details,tlbReceipt.ClientID,tlbReceipt.TransactionID,tlbReceipt.ReconNow " & _
'           "FROM tlbReceipt, tlbTransactionTypes, Tenants, LeaseDetails, Units, Property " & _
'           "WHERE " & szWhType & _
'           "tlbReceipt.Type = tlbTransactionTypes.TYPE_ID  AND tlbReceipt.SageAccountNumber = Tenants.SageAccountNumber AND " & _
'           "Tenants.SageAccountNumber  = LeaseDetails.SageAccountNumber AND LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
'           "LeaseDetails.Status = True AND Units.PropertyID = Property.PropertyID "
'   szSQL = szSQL & szWhClient & szWhProperty & szWhTenant & szWhRef & szWhbankcode & strWhere
'   szSQL = szSQL & " Order by TransactionID Desc"
' szSQL = ""
   szSQL = " Select " & strTopWhere & "  sign,TransactionI,SplitID,Description, INVNO, FundCode, ReceiptAmount, SageAccountNumber, RDate,  ReceiptAmount,ExtRef,OS,MGT, " & _
            " TYPE, Name1, Property.PropertyID, UnitID, BankCode, Name1,PostingDate,RptAmtType,FundID,Details,ClientID,TransactionID,ReconNow " & _
            " from (SELECT  '+' as sign, Mid(tlbTransactionTypes.CONSTANT, 4, (Len(tlbTransactionTypes.CONSTANT)-3)) & tlbReceipt.SlNumber as INVNO,TransactionID as TransactionI,'0' as SplitID,'' as" & _
            " Description,'' as MGT, '' as FundCode, tlbReceipt.SageAccountNumber, tlbReceipt.RDate, tlbReceipt.Amount as  ReceiptAmount,tlbReceipt.OSAmount as OS, " & _
            " tlbReceipt.ExtRef, RIGHT(tlbTransactionTypes.CONSTANT, 2) AS TYPE, Tenants.Name as Name1, Property.PropertyID, tlbReceipt.UnitID, tlbReceipt.BankCode, " & _
            " Tenants.Name,tlbReceipt.PostingDate,tlbReceipt.RptAmtType,tlbReceipt.FundID,tlbReceipt.Details,tlbReceipt.ClientID,tlbReceipt.TransactionID,tlbReceipt.ReconNow " & _
            " FROM tlbReceipt, tlbTransactionTypes, Tenants," & _
            " LeaseDetails, Units, Property WHERE (tlbReceipt.Type = 3 Or tlbReceipt.Type = 4" & _
            " OR tlbReceipt.Type = 23 ) AND tlbReceipt.Type = tlbTransactionTypes.TYPE_ID  AND" & _
            " tlbReceipt.SageAccountNumber = Tenants.SageAccountNumber AND Tenants.SageAccountNumber  = LeaseDetails.SageAccountNumber AND LeaseDetails.UnitNumber =" & _
            " Units.UnitNumber AND Units.PropertyID = Property.PropertyID  " & szWhClient & szWhProperty & szWhTenant & szWhRef & szWhbankcode & strWhere & _
            " UNION ALL Select  '-' as sign,'' as INVNO,RptHeader as TransactionI,SplitID,tlbReceiptSplit.Description,iif(tlbReceiptSplit.isMgtFees=true,'Mgt Fee Taken','Mgt Fee not Taken') AS MGT,F.FundCode as" & _
            " FundCode,tlbReceipt.SageAccountNumber, tlbReceipt.RDate,tlbReceiptSplit.Amount as ReceiptAmount,tlbReceiptSplit.osAmount as OS, " & _
            " tlbReceipt.ExtRef, RIGHT(tlbTransactionTypes.CONSTANT, 2) AS TYPE, Tenants.Name as Name1, Property.PropertyID, tlbReceipt.UnitID, tlbReceipt.BankCode, " & _
            " Tenants.Name,tlbReceipt.PostingDate,tlbReceipt.RptAmtType,tlbReceipt.FundID,tlbReceipt.Details,tlbReceipt.ClientID,tlbReceipt.TransactionID,tlbReceipt.ReconNow " & _
            " from  tlbReceiptSplit,tlbReceipt, tlbTransactionTypes,FUND F, Tenants, LeaseDetails," & _
            " Units, Property WHERE (tlbReceipt.Type = 3 Or tlbReceipt.Type = 4 OR" & _
            " tlbReceipt.Type = 23 ) AND tlbReceipt.Type = tlbTransactionTypes.TYPE_ID AND F.FundID=tlbReceiptSplit.FundID AND" & _
            " tlbReceipt.SageAccountNumber = Tenants.SageAccountNumber AND Tenants.SageAccountNumber  = LeaseDetails.SageAccountNumber AND tlbReceiptSplit.RptHeader=tlbReceipt.TransactionID AND" & _
            " LeaseDetails.UnitNumber = Units.UnitNumber AND Units.PropertyID = Property.PropertyID " & szWhClient & szWhProperty & szWhTenant & szWhRef & szWhbankcode & strWhere & ")"
            szSQL = szSQL & " order by TransactionI,SplitID "


   ConfigFlxReceiptHistory
  ' adoRst.Close
'  Exit Sub
   adoRST.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
   If Filter = "1" Then
        If txtSearchNo.text <> "" Then
            tempstr = Replace(UCase(txtSearchNo.text), "'", "''")
            adoRST.Filter = "invNo Like '%" & tempstr & "%'"
        End If
    End If
    If Filter = "2" Then
         If txtSearchRef.text <> "" Then
            tempstr = Replace(UCase(txtSearchRef.text), "'", "''")
            adoRST.Filter = "Details Like '%" & tempstr & "%'"
        End If
    End If
   i = 1
   fmeLoading.Visible = True
   fmeLoading.Refresh
   flxReceiptHistory.Rows = adoRST.RecordCount + 1
   While Not adoRST.EOF
      flxReceiptHistory.TextMatrix(i, 1) = adoRST!SIGN
      If flxReceiptHistory.TextMatrix(i, 1) = "+" Then
                flxReceiptHistory.TextMatrix(i, 2) = adoRST!InvNo
                flxReceiptHistory.TextMatrix(i, 3) = adoRST!RDate
                flxReceiptHistory.TextMatrix(i, 4) = adoRST!BankCode
                flxReceiptHistory.TextMatrix(i, 5) = adoRST!SageAccountNumber
                flxReceiptHistory.TextMatrix(i, 6) = adoRST!propertyID
                'flxReceiptHistory.TextMatrix(i, 7) = IIf(IsNull(adoRst!unitid), "", adoRst!unitid)
                 flxReceiptHistory.TextMatrix(i, 7) = IIf(IsNull(adoRST!MGT), "", adoRST!MGT)
                flxReceiptHistory.TextMatrix(i, 8) = IIf(IsNull(adoRST!ExtRef), "", adoRST!ExtRef) ' null problem fixed by anol 20160705
                flxReceiptHistory.TextMatrix(i, 9) = Format(adoRST!receiptAmount, "0.00")
                dblRctTotal = dblRctTotal + Format(adoRST!receiptAmount, "0.00")
                flxReceiptHistory.TextMatrix(i, 10) = IIf(IsNull(adoRST!Name1), "", adoRST!Name1)
                flxReceiptHistory.TextMatrix(i, 11) = IIf(IsNull(adoRST!postingDate), "", adoRST!postingDate)
                flxReceiptHistory.TextMatrix(i, 12) = IIf(IsNull(adoRST!fundID), "", adoRST!fundID)
                flxReceiptHistory.TextMatrix(i, 13) = IIf(IsNull(adoRST!Details), "", adoRST!Details)
                flxReceiptHistory.TextMatrix(i, 14) = IIf(IsNull(adoRST!RptAmtType), "", adoRST!RptAmtType)
                flxReceiptHistory.TextMatrix(i, 15) = IIf(IsNull(adoRST!ClientID), "", adoRST!ClientID)
                flxReceiptHistory.TextMatrix(i, 16) = IIf(IsNull(adoRST!transactionI), "", adoRST!transactionI)
                flxReceiptHistory.TextMatrix(i, 17) = IIf(IsNull(adoRST!ReconNow), "", adoRST!ReconNow)
                flxReceiptHistory.TextMatrix(i, 18) = Format(adoRST!OS, "0.00")
                dblOSAmount = dblOSAmount + adoRST!OS
                flxReceiptHistory.RowHeight(i) = 280
      Else
                flxReceiptHistory.TextMatrix(i, 7) = IIf(IsNull(adoRST!MGT), "", adoRST!MGT)
                'flxReceiptHistory.TextMatrix(i, 7) = IIf(IsNull(adoRst!FundCode), "", adoRst!FundCode) ' null problem fixed by anol 20160705
                flxReceiptHistory.TextMatrix(i, 9) = Format(adoRST!receiptAmount, "0.00")
                flxReceiptHistory.TextMatrix(i, 8) = IIf(IsNull(adoRST!description), "", adoRST!description)
                flxReceiptHistory.RowHeight(i) = 0
'                flxReceiptHistory.TextMatrix(i, 11) = IIf(IsNull(adoRst!postingDate), "", adoRst!postingDate)
'                flxReceiptHistory.TextMatrix(i, 12) = IIf(IsNull(adoRst!fundID), "", adoRst!fundID)
'                flxReceiptHistory.TextMatrix(i, 13) = IIf(IsNull(adoRst!Details), "", adoRst!Details)
'                flxReceiptHistory.TextMatrix(i, 14) = IIf(IsNull(adoRst!RptAmtType), "", adoRst!RptAmtType)
'                flxReceiptHistory.TextMatrix(i, 15) = IIf(IsNull(adoRst!clientID), "", adoRst!clientID)
'                flxReceiptHistory.TextMatrix(i, 16) = IIf(IsNull(adoRst!transactionI), "", adoRst!transactionI)
'                flxReceiptHistory.TextMatrix(i, 17) = IIf(IsNull(adoRst!ReconNow), "", adoRst!ReconNow)
                flxReceiptHistory.TextMatrix(i, 7) = IIf(IsNull(adoRST!FundCode), "", adoRST!FundCode) ' null problem fixed by anol 20160705
                flxReceiptHistory.TextMatrix(i, 9) = Format(adoRST!receiptAmount, "0.00")
                flxReceiptHistory.TextMatrix(i, 8) = IIf(IsNull(adoRST!description), "", adoRST!description)
      End If
        
      'If Not adoRst.EOF Then flxReceiptHistory.AddItem ""
      adoRST.MoveNext
      i = i + 1
   Wend
   txtArray(1).text = Format(dblRctTotal, "0.00")
   txtArray(0).text = Format(dblOSAmount, "0.00")
   fmeLoading.Visible = False
   fmeLoading.Refresh
   adoRST.Close
   Set adoRST = Nothing
    
End Sub
Private Sub SquezeExpand()
    On Error GoTo Err
       Dim i As Integer, iCurRowHeight As Integer

  iCurRowHeight = 280
   

   If flxReceiptHistory.TextMatrix(flxReceiptHistory.row, 1) = "+" Then           'Expanding the grid 'flxReceiptHistory.col = 1 And
      flxReceiptHistory.TextMatrix(flxReceiptHistory.row, 1) = ">"
      iCurRowHeight = flxReceiptHistory.RowHeight(flxReceiptHistory.row)
      i = 1

      While flxReceiptHistory.TextMatrix(flxReceiptHistory.row + i, 1) = "-"
         flxReceiptHistory.RowHeight(flxReceiptHistory.row + i) = iCurRowHeight
         i = i + 1
         If (flxReceiptHistory.row + i) = flxReceiptHistory.Rows Then Exit Sub
      Wend
      Exit Sub
   End If

   If flxReceiptHistory.TextMatrix(flxReceiptHistory.row, 1) = ">" Then          'Squeezing the grid 'flxReceiptHistory.col = 1 And
      flxReceiptHistory.TextMatrix(flxReceiptHistory.row, 1) = "+"
      i = 1
      While flxReceiptHistory.TextMatrix(flxReceiptHistory.row + i, 1) = "-"
         flxReceiptHistory.RowHeight(flxReceiptHistory.row + i) = 0
         i = i + 1
         If (flxReceiptHistory.row + i) = flxReceiptHistory.Rows Then Exit Sub
      Wend
      Exit Sub
   End If
   Exit Sub
Err:
   'HighLightRowFlxGridA flxReceiptHistory, flxReceiptHistory.row
End Sub
Private Sub cmdGridUnitLookup_LostFocus()
   If picLeaseList.Visible Then
      flxLeaseList.SetFocus
   End If
End Sub

Private Sub cmdPreViewGenDmds_Click()
   Me.Enabled = False

   Load frmDemandTypesSel
   frmDemandTypesSel.szCallingFrom = "Demand Preview"
   frmDemandTypesSel.Caption = "Generating Demands Preview - Options"
   frmDemandTypesSel.fraSC_St.Visible = False
   frmDemandTypesSel.chkSentAutoEmail.Visible = False
'   Posting Date
   frmDemandTypesSel.Label19(0).Visible = False
   frmDemandTypesSel.txtPostingDate.Visible = False
   frmDemandTypesSel.Top = 435
   frmDemandTypesSel.Left = 100
   frmDemandTypesSel.Show
    
End Sub

Private Function GenSngDmdPreView(adoConn As ADODB.Connection) As Boolean 'generate for both single and cosolidated
   Dim szaNCode() As String, szaNCName() As String, szaPrefix() As String, szaTemp() As String
   Dim szaPartofYear() As Integer ' This variable shall hold part of the year from recordset so that you need to go to the database for  once
   Dim SQLStr1 As String
   Dim adoRST As New ADODB.Recordset
   Dim szDes As String, CutOffDate As String, szSQL As String

   Dim BRcount As Integer, SCcount As Integer, IPcount As Integer, ICcount As Integer
   Dim NextUniqueRefNo As Long, iProp As Integer, iSerial As Integer
   Dim lDemand As Long, iChildId As Integer
   Dim DaysB4Due As Integer, bProceed As Boolean
   Dim dtNtDueDate   As Date

   Dim adoRstDemandRec     As New ADODB.Recordset
   Dim adoRstDemandSplit   As New ADODB.Recordset
   Dim adoRstDmdTyp        As New ADODB.Recordset
   Dim adoMaxDmdType       As New ADODB.Recordset
   Dim adoRstLeaseDtl      As ADODB.Recordset
   Dim adoRstRC            As ADODB.Recordset
   Dim adoRstSC            As ADODB.Recordset
   Dim adoRstPro           As ADODB.Recordset
   Dim adoRstIns           As ADODB.Recordset
   Dim i    As Integer
   GenSngDmdPreView = True

'   If MsgBox("Please ensure your global data has been correctly inputted.", vbYesNo + vbQuestion, _
'             "Generate Automatic Demands") = vbNo Then
'      GenSngDmdPreView = False
'      Exit Function
'   End If
   
'   MousePointer = vbHourglass    'change the mouse cursor to show program is busy/working

'  Empty the temporary table
   adoConn.Execute "DELETE * FROM DemandSplPreview;"
   adoConn.Execute "DELETE * FROM DemandRecPreview;"

   SQLStr1 = "SELECT ID,PARTOFYEAR  FROM FREQUENCIES  Order By ID "
   adoRST.Open SQLStr1, adoConn, adOpenStatic, adLockReadOnly
   ReDim szaPartofYear(RecordCount(adoRST)) As Integer
   While Not adoRST.EOF
        i = i + 1
        szaPartofYear(i) = adoRST("PARTOFYEAR").Value
        adoRST.MoveNext
   Wend
   adoRST.Close
   'Exit Function

'   Connect to Demands table to add new demands.
   szSQL = "SELECT * FROM DemandRecPreview"
   adoRstDemandRec.Open szSQL, adoConn, adOpenDynamic, adLockPessimistic

   szSQL = "SELECT * FROM DemandSplPreview"
   adoRstDemandSplit.Open szSQL, adoConn, adOpenDynamic, adLockPessimistic

'   get nominal codes and prefix for base rent from demand types.
   szSQL = "SELECT * FROM DemandTypes;"
   adoRstDmdTyp.Open szSQL, adoConn, adOpenStatic, adLockReadOnly

   If adoRstDmdTyp.EOF Then
      MsgBox "There are no Demand Type in the database", vbCritical, "DATA Input Error"

      adoRstDemandSplit.Close
      adoRstDemandRec.Close
      adoRstDmdTyp.Close

      Set adoRstDemandSplit = Nothing
      Set adoRstDemandRec = Nothing
      Set adoRstDmdTyp = Nothing

      Exit Function
   End If

   adoMaxDmdType.Open "SELECT MAX(ID) AS X FROM DemandTypes;", adoConn, adOpenStatic, adLockReadOnly

   ReDim szaPrefix(adoMaxDmdType.Fields.Item(0).Value) As String
   ReDim szaNCName(adoMaxDmdType.Fields.Item(0).Value) As String
   ReDim szaNCode(adoMaxDmdType.Fields.Item(0).Value) As String

   adoMaxDmdType.Close
   Set adoMaxDmdType = Nothing
'**Saving all Nominal Codes and Prefixes in the array
   While Not adoRstDmdTyp.EOF
      szaPrefix(adoRstDmdTyp!Id) = adoRstDmdTyp!prefix
      szaNCName(adoRstDmdTyp!Id) = adoRstDmdTyp!NominalNameforAmount & " # " & adoRstDmdTyp!NominalNameforVAT & " # " & adoRstDmdTyp!NominalNameforTotal
      szaNCode(adoRstDmdTyp!Id) = adoRstDmdTyp!NominalCodeforAmount & " # " & adoRstDmdTyp!NominalCodeForVAT & " # " & adoRstDmdTyp!NominalCodeForTotal
      adoRstDmdTyp.MoveNext
   Wend
   adoRstDmdTyp.Close
   Set adoRstDmdTyp = Nothing

   Set adoRstLeaseDtl = New ADODB.Recordset
   Set adoRstPro = New ADODB.Recordset

   iSerial = 0

   For iProp = 1 To frmDemandTypesSel.flxProperties.Rows - 1
      If frmDemandTypesSel.flxProperties.TextMatrix(iProp, 0) = "X" Then
         iSerial = iSerial + 1
         szDes = szDes & "Units.PropertyID = '" & frmDemandTypesSel.flxProperties.TextMatrix(iProp, 1) & "'"
         If iSerial < frmDemandTypesSel.iSelProperties Then szDes = szDes & " OR "
      End If
   Next iProp
    'Fixed by anol 20160920
    If Right(szDes, 4) = " OR " Then
        szDes = Mid(szDes, 0, Len(szDes) - 4)
    End If
    
   szSQL = "SELECT LeaseDetails.*, Units.PropertyID, NoOfDaysToSendDemandsB4Due " & _
           "FROM   LeaseDetails, Units, GlobalData " & _
           "WHERE  LeaseDetails.Status = TRUE AND " & _
                  "Units.PropertyID = GlobalData.PropertyID AND " & _
                  "LeaseDetails.UnitNumber = Units.UnitNumber AND (" & szDes & ")"
'Debug.Print szSQL
   adoRstLeaseDtl.Open szSQL, adoConn, adOpenStatic, adLockReadOnly

   iSerial = 1
   szDes = ""  'Empty the variable for further use

   If adoRstLeaseDtl.EOF Then
      adoRstLeaseDtl.Close
      Set adoRstLeaseDtl = Nothing
   Else
      While Not adoRstLeaseDtl.EOF

'*********************** SAMRAT 25/11/2005***************************************
'*** Determin the date boundray in future, in this boundary
'*** we have to find those demands' due date to calcuate
'*** demands from lease table and we have to calculate &
'*** collect all those demands in DemandRecPreview table.
'*********************************************************************************
         DaysB4Due = adoRstLeaseDtl!NoOfDaysToSendDemandsB4Due ' GlbDaysBeforeDue(adoRstLeaseDtl.Fields("LeaseID").Value, adoConn)
         CutOffDate = DateAdd("d", DaysB4Due, Date)                                       'Date boundary


'************************************************************************************
'*********************        Interest Charge            ****************************
'************************************************************************************
         If adoRstLeaseDtl.Fields("InterestChargeable").Value = "Y" Then
            Dim cTotalOSAmt As Currency, sIntCalDays As Single
'**** Insert the Header info in the DemandRecPreview table
            lDemand = lDemand + 1

            With adoRstDemandRec
               .AddNew
               .Fields.Item("DemandID").Value = lDemand
               .Fields.Item("BatchID").Value = 1
               .Fields.Item("SageAccountNumber").Value = adoRstLeaseDtl!SageAccountNumber
               .Fields.Item("TenantCompanyName").Value = adoRstLeaseDtl!CompanyName
               .Fields.Item("UnitNumber").Value = adoRstLeaseDtl!UnitNumber
               .Fields.Item("Source").Value = 1
               .Fields.Item("TransactionType").Value = 1
'*** Here my thinking is, all type of demands due date is on the same day
'*** If its not correct then i have to change the manual demands grid and the demand table & split table
               .Fields.Item("IssueDate").Value = Format(Date, "dd/mm/yyyy")
               .Fields.Item("SageText").Value = adoRstLeaseDtl!SageAccountNumber
               .Fields.Item("IsPrinted").Value = False
               'below is tlbClientBanks.MY_ID=spare1
               .Fields.Item("Spare1").Value = ClientDefaultBankDts(adoRstLeaseDtl!propertyID, adoConn)
               .Fields.Item("LeaseRef").Value = adoRstLeaseDtl!LeaseID
               .Update
            End With

'*** Insert the split records in the DemandSplPreview table
            iChildId = 1

'*** Add new demand IN demand table.
            adoRstDemandSplit.AddNew
            adoRstDemandSplit!DSR = UniqueID()
            adoRstDemandSplit!splitID = iChildId
            adoRstDemandSplit!DEMANDID = lDemand
            If adoRstLeaseDtl!ServiceChargeDept = "AUTO" Then
               adoRstDemandSplit!A_M = "A"
            Else
               adoRstDemandSplit!A_M = "M"
            End If
            adoRstDemandSplit!NominalCodeforAmount = PartString(szaNCode(adoRstLeaseDtl!IntDemandType), 0, " # ")
            adoRstDemandSplit!NominalNameforAmount = PartString(szaNCName(adoRstLeaseDtl!IntDemandType), 0, " # ")
            adoRstDemandSplit!NominalCodeForTotal = PartString(szaNCode(adoRstLeaseDtl!IntDemandType), 2, " # ")
            adoRstDemandSplit!NominalNameforTotal = PartString(szaNCName(adoRstLeaseDtl!IntDemandType), 2, " # ")

            If adoRstLeaseDtl!ServiceChargeDept = "AUTO" Then
               adoRstDemandSplit!amount = CalAutoInterest(CSng(adoRstLeaseDtl!AdditionalInterest), CInt(adoRstLeaseDtl!DaysAfterInterestPayable), adoRstLeaseDtl!UnitNumber, adoRstLeaseDtl!SageAccountNumber, adoConn, cTotalOSAmt, sIntCalDays)
            Else
               adoRstDemandSplit!amount = adoRstLeaseDtl!InterestAmount
            End If

            adoRstDemandSplit!VATAMOUNT = 0
            adoRstDemandSplit!TotalAmount = CCur(adoRstDemandSplit!amount) + _
                                            CCur(adoRstDemandSplit!VATAMOUNT)
            If adoRstLeaseDtl!Text1 = "" Then
               szDes = "Interest Charges For " & adoRstLeaseDtl!DaysAfterInterestPayable & _
                       " Days on " & cTotalOSAmt
            Else
               szDes = adoRstLeaseDtl!Text1
            End If
            adoRstDemandSplit!SageRef = szaPrefix(adoRstLeaseDtl!IntDemandType) & Format(SlNumber("SI", "DemandRecords", adoConn), "00000")
            adoRstDemandSplit!DueDate = Format(Date, "dd/mm/yyyy")
            adoRstDemandSplit!VATMonth = Month(Date)
            adoRstDemandSplit!TypeOfDemand = adoRstLeaseDtl!IntDemandType
            adoRstDemandSplit!description = szDes
            adoRstDemandSplit!DemandStatement = True
            adoRstDemandSplit!FrequencyID = 0
            adoRstDemandSplit.Update

            IPcount = IPcount + 1
            iSerial = iSerial + 1
         End If
'*********************************************************************************************************
'         Rent Charges Demands
'*********************************************************************************************************
         szSQL = "SELECT R.RentCharges, R.LeaseID, " & _
                        "R.RentChargeDept, R.BRFrequency, " & _
                        "R.BRStartDate, R.BRNextDueDate, " & _
                        "R.RRTotal, R.RRAmount, " & _
                        "R.BRDemandType, R.RentDesc, " & _
                        "Units.PropertyID, DemandTypes.Spare1 as ClientBankID, " & _
                        "Frequencies.CalDays, R.StopRC " & _
                    "FROM LRentCharges AS R, LeaseDetails, Units, DemandTypes, Frequencies "

         If frmDemandTypesSel.cboGDPFreq.Column(0) = 0 Then 'This means you have selected all frequencies

        szSQL = szSQL & _
                    "WHERE R.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                        "R.LeaseID = LeaseDetails.LeaseID AND (R.StopAutoDmd = FALSE OR LeaseDetails.GPrataDmd =FALSE OR " & _
                        "(R.StopAutoDmd = TRUE AND LeaseDetails.EndDate >=CDATE(R.FDD))) AND " & _
                        "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
                        "R.RRTotal > 0 AND (ISNULL(R.spare3) OR R.spare3 <> 'DELETED') AND " & _
                        "R.BRDemandType = DemandTypes.ID AND " & _
                        "R.BRFrequency = Frequencies.ID;"
         Else

            szSQL = szSQL & _
                     "WHERE R.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                         "R.LeaseID = LeaseDetails.LeaseID AND (R.StopAutoDmd = FALSE OR LeaseDetails.GPrataDmd =FALSE OR " & _
                        "(R.StopAutoDmd = TRUE AND LeaseDetails.EndDate >= CDATE(R.FDD))) AND " & _
                         "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
                         "R.RRTotal > 0 AND (ISNULL(R.spare3) OR R.spare3 <> 'DELETED') AND " & _
                         "R.BRDemandType = DemandTypes.ID AND " & _
                         "R.BRFrequency = Frequencies.ID AND " & _
                         "Frequencies.ID = " & frmDemandTypesSel.cboGDPFreq.Column(0) & ";"
         End If

         Set adoRstRC = New ADODB.Recordset
         adoRstRC.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
If adoRstLeaseDtl!LeaseID = "375160119085126" Then
    Debug.Print "test"
End If

         While Not adoRstRC.EOF
            If IsNull(adoRstRC.Fields.Item("StopRC")) Or adoRstRC.Fields.Item("StopRC") = "" Then
               bProceed = True
            Else
               bProceed = IIf(DateDiff("d", adoRstRC.Fields.Item("BRNextDueDate"), CDate(adoRstRC.Fields.Item("StopRC"))) > 0, True, False)
            End If

            If adoRstLeaseDtl!BRPayable = "Y" And _
                  DateDiff("d", Date, IIf(adoRstRC.Fields.Item("BRNextDueDate") = "", _
                  DateAdd("d", -1, Date), adoRstRC.Fields.Item("BRNextDueDate"))) <= DaysB4Due And bProceed And _
                  IsDmdTypeSel(adoRstRC.Fields("BRDemandType").Value) And _
                  IIf(adoRstLeaseDtl!OLED, True, adoRstLeaseDtl!EndDate > adoRstRC.Fields.Item("BRNextDueDate")) Then

   '**** Insert the Header info in the DemandRecPreview table
               lDemand = lDemand + 1
               With adoRstDemandRec
                  .AddNew
                  .Fields.Item("DemandID").Value = lDemand
                  .Fields.Item("BatchID").Value = 1
                  .Fields.Item("SageAccountNumber").Value = adoRstLeaseDtl!SageAccountNumber
                  .Fields.Item("TenantCompanyName").Value = adoRstLeaseDtl!CompanyName
                  .Fields.Item("UnitNumber").Value = adoRstLeaseDtl!UnitNumber
                  .Fields.Item("Source").Value = 1
                  .Fields.Item("TransactionType").Value = 1
   '***Here my thinking is, all type of demands due date is on the same day
   '***If its not correct then i have to change the manual demands grid and the demand table & split table
                  .Fields.Item("IssueDate").Value = Format(Date, "dd/mm/yyyy")
                  .Fields.Item("SageText").Value = adoRstLeaseDtl!SageAccountNumber
                  .Fields.Item("IsPrinted").Value = False
                  .Fields.Item("Spare1").Value = adoRstRC.Fields.Item("ClientBankID")
                  .Fields.Item("LeaseRef").Value = adoRstLeaseDtl!LeaseID
                  .Update
               End With

               iChildId = 1

               szDes = IIf(IIf(IsNull(adoRstRC.Fields.Item("RentDesc")), "", adoRstRC.Fields.Item("RentDesc")) = "", DemandTypeName(adoRstRC.Fields.Item("BRDemandType"), adoConn), adoRstRC.Fields.Item("RentDesc"))

               dtNtDueDate = FindNextDueDate(adoRstRC.Fields.Item("BRNextDueDate"), _
                                 adoRstRC.Fields.Item("BRfrequency"), adoRstRC.Fields.Item("BRDemandType"), adoRstRC.Fields.Item("PropertyID"), adoConn)

''******* if the override lease end date is false then the lease is open, lease is not expairing.
''******* if the lease end date is open then we dont need to compare the NextDueDate with the lease expaire date.
'               If Not adoRstLeaseDtl.Fields("OLED").Value Then
'                  dtEndDate = Format(DateAdd("d", 1, adoRstLeaseDtl!EndDate), "dd/mm/yyyy")
'                  If DateDiff("d", dtEndDate, dtNtDueDate) > 0 Then dtNtDueDate = dtEndDate
'               End If

               adoRstDemandSplit.AddNew
               adoRstDemandSplit!DSR = UniqueID()
               adoRstDemandSplit!splitID = iChildId
               adoRstDemandSplit!DEMANDID = lDemand
               adoRstDemandSplit!A_M = "A"
               adoRstDemandSplit!NominalCodeforAmount = PartString(szaNCode(adoRstRC.Fields.Item("BRDemandType")), 0, " # ")
               adoRstDemandSplit!NominalNameforAmount = PartString(szaNCName(adoRstRC.Fields.Item("BRDemandType")), 0, " # ")
               adoRstDemandSplit!NominalCodeForVAT = PartString(szaNCode(adoRstRC.Fields.Item("BRDemandType")), 1, " # ")
               adoRstDemandSplit!NominalNameforVAT = PartString(szaNCName(adoRstRC.Fields.Item("BRDemandType")), 1, " # ")
               adoRstDemandSplit!NominalCodeForTotal = PartString(szaNCode(adoRstRC.Fields.Item("BRDemandType")), 2, " # ")
               adoRstDemandSplit!NominalNameforTotal = PartString(szaNCName(adoRstRC.Fields.Item("BRDemandType")), 2, " # ")
               adoRstDemandSplit!amount = adoRstRC.Fields.Item("RRAmount")
               adoRstDemandSplit!VATAMOUNT = RoundingNumber(adoRstRC.Fields.Item("RRAmount") * GetVAT_Tenant(adoRstLeaseDtl!SageAccountNumber, adoConn) / 100, 2)
               adoRstDemandSplit!TotalAmount = adoRstDemandSplit!amount + adoRstDemandSplit!VATAMOUNT

               adoRstDemandSplit!SageRef = szaPrefix(adoRstRC.Fields.Item("BRDemandType")) & Format(SlNumber("SI", "DemandRecords", adoConn), "00000")
               adoRstDemandSplit!DueDate = Format(adoRstRC.Fields.Item("BRNextDueDate").Value, "dd/mm/yyyy")
               adoRstDemandSplit!VATMonth = Month(adoRstRC.Fields.Item("BRNextDueDate"))
               adoRstDemandSplit!TypeOfDemand = adoRstRC.Fields.Item("BRDemandType")
               adoRstDemandSplit!description = szDes
               adoRstDemandSplit!DemandStatement = True
               adoRstDemandSplit!VAT_CODE = GetVATCode_Tenant(adoRstLeaseDtl!SageAccountNumber, adoConn)
               If Left(adoRstRC.Fields.Item("CalDays"), 1) <> "-" Then
'                          ADVANCE
                  adoRstDemandSplit!dateFrom = CDate(adoRstRC.Fields.Item("BRNextDueDate"))
                  adoRstDemandSplit!DateTO = DateAdd("d", -1, dtNtDueDate)
               Else
'                          ARREARS
'                  adoRstDemandSplit!DateFrom = DateAdd(Right(adoRstRC.Fields.Item("CalDays"), 1), Left(adoRstRC.Fields.Item("CalDays"), Len(adoRstRC.Fields.Item("CalDays")) - 1), adoRstRC.Fields.Item("BRNextDueDate")) 'CDate(adoRstRC.fields.item("BRNextDueDate"))
                  adoRstDemandSplit!dateFrom = ArrFromDate(adoRstRC.Fields.Item("BRNextDueDate"), _
                                 adoRstRC.Fields.Item("BRfrequency"), adoRstRC.Fields.Item("BRDemandType"), adoRstRC.Fields.Item("PropertyID"), adoRstRC.Fields.Item("CalDays"), adoConn)
                  adoRstDemandSplit!DateTO = DateAdd("d", -1, adoRstRC.Fields.Item("BRNextDueDate"))
               End If
               adoRstDemandSplit!SageDepartment = adoRstRC.Fields.Item("RentChargeDept") ' DepartmentID(adoRstLeaseDtl!SageAccountNumber, adoRstLeaseDtl!UnitNumber, "Rent Charges", adoConn)
               adoRstDemandSplit!FrequencyID = adoRstRC.Fields.Item("BRfrequency")
               adoRstDemandSplit!LChildsRef = adoRstRC.Fields.Item("RentCharges")
               adoRstDemandSplit.Update

               BRcount = BRcount + 1
               iSerial = iSerial + 1
            End If
            adoRstRC.MoveNext
         Wend
         adoRstRC.Close
         
'If adoRstLeaseDtl!LeaseID = "375160119085126" Then
'    Debug.Print "test"
'End If

'*********************************************************************************************************
'         Rent Charges Demands  ---  PRO-RATA
'*********************************************************************************************************
         szSQL = "SELECT R.RentCharges, R.LeaseID, " & _
                        "R.RentChargeDept, R.BRFrequency, " & _
                        "R.BRStartDate, R.BRNextDueDate, " & _
                        "R.RRTotal, R.RRAmount, R.BRDemandType, " & _
                        "R.RentDesc, Units.PropertyID, " & _
                        "DemandTypes.Spare1 as ClientBankID, " & _
                        "Frequencies.CalDays, R.StopRC,Frequencies.ID,R.FDD " & _
                 "FROM   LRentCharges AS R, LeaseDetails, Units, DemandTypes, Frequencies "

         If frmDemandTypesSel.cboGDPFreq.Column(0) = 0 Then

            szSQL = szSQL & _
                    "WHERE R.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                        "LeaseDetails.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                        "LeaseDetails.GPrataDmd = TRUE  AND " & _
                        "R.StopAutoDmd = TRUE AND " & _
                        "LeaseDetails.EndDate < CDATE(R.FDD) AND " & _
                        "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
                        "R.RRTotal > 0 AND (ISNULL(R.spare3) OR R.spare3 <> 'DELETED') AND " & _
                        "R.BRDemandType = DemandTypes.ID AND " & _
                        "R.BRFrequency = Frequencies.ID;"
         Else

        szSQL = szSQL & _
                    "WHERE R.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                        "LeaseDetails.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                        "LeaseDetails.GPrataDmd = TRUE AND R.GPD = TRUE AND " & _
                        "R.StopAutoDmd = TRUE AND " & _
                        "LeaseDetails.EndDate < CDATE(R.FDD) AND " & _
                        "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
                        "R.RRTotal > 0 AND (ISNULL(R.spare3) OR R.spare3 <> 'DELETED') AND " & _
                        "R.BRDemandType = DemandTypes.ID AND " & _
                        "R.BRFrequency = Frequencies.ID AND " & _
                        "Frequencies.ID = " & frmDemandTypesSel.cboGDPFreq.Column(0) & ";"
         End If
'Debug.Print adoRstLeaseDtl!OLED

         adoRstRC.Open szSQL, adoConn, adOpenStatic, adLockReadOnly

         While Not adoRstRC.EOF
            If IsNull(adoRstRC.Fields.Item("StopRC")) Or adoRstRC.Fields.Item("StopRC") = "" Then
               bProceed = True
            Else
               bProceed = IIf(DateDiff("d", adoRstRC.Fields.Item("BRNextDueDate"), CDate(adoRstRC.Fields.Item("StopRC"))) > 0, True, False)
            End If

            If adoRstLeaseDtl!BRPayable = "Y" And _
               DateDiff("d", Date, IIf(adoRstRC.Fields.Item("BRNextDueDate") = "", _
                  DateAdd("d", -1, Date), adoRstRC.Fields.Item("BRNextDueDate"))) <= DaysB4Due And bProceed And _
                  IsDmdTypeSel(adoRstRC.Fields("BRDemandType").Value) Then

   '**** Insert the Header info in the DemandRecPreview table
               lDemand = lDemand + 1
               With adoRstDemandRec
                  .AddNew
                  .Fields("DemandID").Value = lDemand
                  
                  .Fields("BatchID").Value = 1
                  .Fields("SageAccountNumber").Value = adoRstLeaseDtl!SageAccountNumber
                  .Fields("TenantCompanyName").Value = adoRstLeaseDtl!CompanyName
                  .Fields("UnitNumber").Value = adoRstLeaseDtl!UnitNumber
                  .Fields("Source").Value = 1
                  .Fields("TransactionType").Value = 1
   '***Here my thinking is, all type of demands due date is on the same day
   '***If its not correct then i have to change the manual demands grid and the demand table & split table
                  .Fields("IssueDate").Value = Format(Date, "dd/mm/yyyy")
                  .Fields("SageText").Value = "S/L " & adoRstLeaseDtl!SageAccountNumber
                  .Fields("IsPrinted").Value = False
                  .Fields("Spare1").Value = adoRstRC.Fields.Item("ClientBankID")
                  .Fields.Item("LeaseRef").Value = adoRstLeaseDtl!LeaseID
                  .Update
               End With

               iChildId = 1

               szDes = IIf(IIf(IsNull(adoRstRC.Fields.Item("RentDesc")), "", adoRstRC.Fields.Item("RentDesc")) = "", DemandTypeName(adoRstRC.Fields.Item("BRDemandType"), adoConn), adoRstRC.Fields.Item("RentDesc"))

'               dtNtDueDate = FindNextDueDate(adoRstRC.fields.item("BRNextDueDate, _
                                 adoRstRC.fields.item("BRfrequency, adoRstRC.fields.item("BRDemandType, adoRstRC.fields.item("PropertyID, adoConn)

''******* if the override lease end date is false then the lease is open, lease is not expairing.
''******* if the lease end date is open then we dont need to compare the NextDueDate with the lease expaire date.
'               If Not adoRstLeaseDtl.Fields("OLED").Value Then
'                  dtEndDate = Format(DateAdd("d", 1, adoRstLeaseDtl!EndDate), "dd/mm/yyyy")
'                  If DateDiff("d", dtEndDate, dtNtDueDate) > 0 Then dtNtDueDate = dtEndDate
'               End If

               With adoRstDemandSplit
                  .AddNew
                  !DSR = UniqueID()
                  !splitID = iChildId
                  !DEMANDID = lDemand
                  !A_M = "A"
                  !NominalCodeforAmount = PartString(szaNCode(adoRstRC.Fields.Item("BRDemandType")), 0, " # ")
                  !NominalNameforAmount = PartString(szaNCName(adoRstRC.Fields.Item("BRDemandType")), 0, " # ")
                  !NominalCodeForVAT = PartString(szaNCode(adoRstRC.Fields.Item("BRDemandType")), 1, " # ")
                  !NominalNameforVAT = PartString(szaNCName(adoRstRC.Fields.Item("BRDemandType")), 1, " # ")
                  !NominalCodeForTotal = PartString(szaNCode(adoRstRC.Fields.Item("BRDemandType")), 2, " # ")
                  !NominalNameforTotal = PartString(szaNCName(adoRstRC.Fields.Item("BRDemandType")), 2, " # ")
                  !SageRef = "EL"
                  !DueDate = Format(adoRstRC.Fields.Item("BRNextDueDate"), "dd/mm/yyyy")
                  !VATMonth = Month(adoRstRC.Fields.Item("BRNextDueDate"))
                  !TypeOfDemand = adoRstRC.Fields.Item("BRDemandType")
                  !description = szDes
                  !DemandStatement = True
                  !VAT_CODE = GetVATCode_Tenant(adoRstLeaseDtl!SageAccountNumber, adoConn)

                  If Left(adoRstRC.Fields.Item("CalDays"), 1) <> "-" Then  '                          ADVANCE
                     !dateFrom = CDate(adoRstRC.Fields.Item("BRNextDueDate"))
                  Else                                      '                          ARREARS
'                     !DateFrom = DateAdd(Right(adoRstRC.Fields.Item("CalDays"), 1), Left(adoRstRC.Fields.Item("CalDays"), Len(adoRstRC.Fields.Item("CalDays")) - 1), adoRstRC.Fields.Item("BRNextDueDate"))
                     !dateFrom = ArrFromDate(adoRstRC.Fields.Item("BRNextDueDate"), _
                                    adoRstRC.Fields.Item("BRfrequency"), adoRstRC.Fields.Item("BRDemandType"), adoRstRC.Fields.Item("PropertyID"), adoRstRC.Fields.Item("CalDays"), adoConn)
                  End If
                  !DateTO = adoRstLeaseDtl!EndDate
                  If DateDiff("d", adoRstLeaseDtl!EndDate, adoRstRC.Fields.Item("FDD")) = 1 Then
                    'do not calculatate prorata ,calculate full
                    !amount = RoundingNumber(Val(adoRstRC.Fields.Item("RRTotal") / szaPartofYear(adoRstRC("ID").Value)), 2)
                  Else
                    'calculate prorata and also add 1 day with datediff
                     !amount = RoundingNumber((Val(adoRstRC.Fields.Item("RRTotal")) / 365) * (DateDiff("D", !dateFrom, !DateTO) + 1), 2)
                  End If
                  
                  '!DateTo = adoRstLeaseDtl!EndDate
                'Here one issue we need to resolve calculation should not be based on from date and todate rather its should be based on frequency table anol 2020-06-09 issue 853
                 
                  '
                  !VATAMOUNT = RoundingNumber(!amount * GetVAT_Tenant(adoRstLeaseDtl!SageAccountNumber, adoConn) / 100, 2)
                  !TotalAmount = !amount + !VATAMOUNT

                  !SageDepartment = adoRstRC.Fields.Item("RentChargeDept") ' DepartmentID(adoRstLeaseDtl!SageAccountNumber, adoRstLeaseDtl!UnitNumber, "Rent Charges", adoConn)
                  !FrequencyID = adoRstRC.Fields.Item("BRfrequency")
                  !LChildsRef = adoRstRC.Fields.Item("RentCharges")
                  .Update
               End With

               BRcount = BRcount + 1
               iSerial = iSerial + 1
            End If
            adoRstRC.MoveNext
         Wend
         adoRstRC.Close
         Set adoRstRC = Nothing
'call service charge demand preview SNG
        Call WriteServiceChargesSngPreview(adoConn, adoRstLeaseDtl, adoRstDemandRec, adoRstDemandSplit, DaysB4Due, szaNCode, szaNCName, szaPartofYear, szaPrefix(), SCcount, lDemand)
'************************************************************************************************
'   Insurance Charge demands
'************************************************************************************************
         szSQL = "SELECT I.InsCharges, I.LeaseID, " & _
                        "I.InsuranceStartDate, I.InsuranceFrequency, " & _
                        "I.InsuranceEndDate, I.InsuranceDemandType, " & _
                        "I.InsuranceEachPeriod, I.InsuranceNextDueDate, " & _
                        "I.ChargingType, I.ChargingFigure, " & _
                        "I.TotalYearlyInsurance, I.InsuranceDept, " & _
                        "I.InsDesc, Units.PropertyID, " & _
                        "DemandTypes.Spare1 as ClientBankID, " & _
                        "Frequencies.CalDays, StopIC " & _
                    "FROM LInsuranceCharges AS I, LeaseDetails, Units, DemandTypes, Frequencies "

         If frmDemandTypesSel.cboGDPFreq.Column(0) = 0 Then
  'issue 331 Modified by anol 20170315
'            szSQL = szSQL & _
'                    "WHERE I.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
'                        "I.LeaseID = LeaseDetails.LeaseID AND (I.StopAutoDmd = FALSE OR " & _
'                        "(I.StopAutoDmd = TRUE AND LeaseDetails.EndDate < CDATE(I.FDD))) AND " & _
'                        "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
'                        "I.InsuranceEachPeriod > 0 AND (ISNULL(I.spare3) OR I.spare3 <> 'DELETED') AND " & _
'                        "I.InsuranceDemandType = DemandTypes.ID AND " & _
'                        "I.InsuranceFrequency = Frequencies.ID;"
           szSQL = szSQL & _
                    "WHERE I.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                        "I.LeaseID = LeaseDetails.LeaseID AND (I.StopAutoDmd = FALSE OR LeaseDetails.GPrataDmd =FALSE OR " & _
                        "(I.StopAutoDmd = TRUE AND LeaseDetails.EndDate >= CDATE(I.FDD))) AND " & _
                        "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
                        "I.InsuranceEachPeriod > 0 AND (ISNULL(I.spare3) OR I.spare3 <> 'DELETED') AND " & _
                        "I.InsuranceDemandType = DemandTypes.ID AND " & _
                        "I.InsuranceFrequency = Frequencies.ID;"
         Else
          'issue 331 Modified by anol 20170315
'            szSQL = szSQL & _
'                    "WHERE I.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
'                        "I.LeaseID = LeaseDetails.LeaseID AND (I.StopAutoDmd = FALSE OR " & _
'                        "(I.StopAutoDmd = TRUE AND LeaseDetails.EndDate < CDATE(I.FDD))) AND " & _
'                        "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
'                        "I.InsuranceEachPeriod > 0 AND (ISNULL(I.spare3) OR I.spare3 <> 'DELETED') AND " & _
'                        "I.InsuranceDemandType = DemandTypes.ID AND " & _
'                        "I.InsuranceFrequency = Frequencies.ID AND " & _
'                        "Frequencies.ID = " & frmDemandTypesSel.cboGDPFreq.Column(0) & ";"
            szSQL = szSQL & _
                    "WHERE I.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                        "I.LeaseID = LeaseDetails.LeaseID AND (I.StopAutoDmd = FALSE OR LeaseDetails.GPrataDmd =FALSE OR " & _
                        "(I.StopAutoDmd = TRUE AND LeaseDetails.EndDate >= CDATE(I.FDD))) AND " & _
                        "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
                        "I.InsuranceEachPeriod > 0 AND (ISNULL(I.spare3) OR I.spare3 <> 'DELETED') AND " & _
                        "I.InsuranceDemandType = DemandTypes.ID AND " & _
                        "I.InsuranceFrequency = Frequencies.ID AND " & _
                        "Frequencies.ID = " & frmDemandTypesSel.cboGDPFreq.Column(0) & ";"
                        
         End If

         Set adoRstIns = New ADODB.Recordset
         adoRstIns.Open szSQL, adoConn, adOpenStatic, adLockReadOnly

         While Not adoRstIns.EOF
            If IsNull(adoRstIns!StopIC) Or adoRstIns!StopIC = "" Then
               bProceed = True
            Else
               bProceed = IIf(DateDiff("d", adoRstIns!InsuranceNextDueDate, CDate(adoRstIns!StopIC)) > 0, True, False)
            End If
            If adoRstLeaseDtl!InsurancePayable = "Y" And _
               DateDiff("d", Date, IIf(adoRstIns!InsuranceNextDueDate = "", _
                  DateAdd("d", -1, Date), adoRstIns!InsuranceNextDueDate)) <= DaysB4Due And bProceed And _
               IsDmdTypeSel(adoRstIns.Fields("InsuranceDemandType").Value) And _
               IIf(adoRstLeaseDtl!OLED, True, adoRstLeaseDtl!EndDate > adoRstIns!InsuranceNextDueDate) Then
   '**** Insert the Header info in the DemandRecPreview table
               lDemand = lDemand + 1
               With adoRstDemandRec
                  .AddNew
                  .Fields("DemandID").Value = lDemand
                  
                  .Fields("BatchID").Value = 1
                  .Fields("SageAccountNumber").Value = adoRstLeaseDtl!SageAccountNumber
                  .Fields("TenantCompanyName").Value = adoRstLeaseDtl!CompanyName
                  .Fields("UnitNumber").Value = adoRstLeaseDtl!UnitNumber
                  .Fields("Source").Value = 1
                  .Fields("TransactionType").Value = 1
   '***Here my thinking is, all type of demands due date is on the same day
   '***If its not correct then i have to change the manual demands grid and the demand table & split table
                  .Fields("IssueDate").Value = Format(Date, "dd/mm/yyyy")
                  .Fields("SageText").Value = "S/L " & adoRstLeaseDtl!SageAccountNumber
                  .Fields("IsPrinted").Value = False
                  .Fields("Spare1").Value = adoRstIns!ClientBankID
                  .Fields.Item("LeaseRef").Value = adoRstLeaseDtl!LeaseID
                  .Update
               End With

               iChildId = 1
               szDes = IIf(IIf(IsNull(adoRstIns!InsDesc), "", adoRstIns!InsDesc) = "", DemandTypeName(adoRstIns!InsuranceDemandType, adoConn), adoRstIns!InsDesc)

               dtNtDueDate = FindNextDueDate(adoRstIns!InsuranceNextDueDate, _
                              adoRstIns!InsuranceFrequency, _
                              adoRstIns!InsuranceDemandType, adoRstIns!propertyID, adoConn)

               adoRstDemandSplit.AddNew
               adoRstDemandSplit!DSR = UniqueID()
               adoRstDemandSplit!splitID = iChildId
               adoRstDemandSplit!DEMANDID = lDemand
               adoRstDemandSplit!A_M = "A"
               adoRstDemandSplit!NominalCodeforAmount = PartString(szaNCode(adoRstIns!InsuranceDemandType), 0, " # ")
               adoRstDemandSplit!NominalNameforAmount = PartString(szaNCName(adoRstIns!InsuranceDemandType), 0, " # ")
               adoRstDemandSplit!NominalCodeForVAT = PartString(szaNCode(adoRstIns!InsuranceDemandType), 1, " # ")
               adoRstDemandSplit!NominalNameforVAT = PartString(szaNCName(adoRstIns!InsuranceDemandType), 1, " # ")
               adoRstDemandSplit!NominalCodeForTotal = PartString(szaNCode(adoRstIns!InsuranceDemandType), 2, " # ")
               adoRstDemandSplit!NominalNameforTotal = PartString(szaNCName(adoRstIns!InsuranceDemandType), 2, " # ")
               adoRstDemandSplit!amount = adoRstIns!InsuranceEachPeriod
               adoRstDemandSplit!VATAMOUNT = RoundingNumber(adoRstIns!InsuranceEachPeriod * GetVAT_Tenant(adoRstLeaseDtl!SageAccountNumber, adoConn) / 100, 2)
               adoRstDemandSplit!TotalAmount = adoRstDemandSplit!amount + adoRstDemandSplit!VATAMOUNT
               adoRstDemandSplit!SageRef = szaPrefix(adoRstIns!InsuranceDemandType) & Format(SlNumber("SI", "DemandRecords", adoConn), "00000")
               adoRstDemandSplit!DueDate = Format(adoRstIns!InsuranceNextDueDate, "dd/mm/yyyy")
               adoRstDemandSplit!VATMonth = Month(adoRstIns!InsuranceNextDueDate)
               adoRstDemandSplit!TypeOfDemand = adoRstIns!InsuranceDemandType
               adoRstDemandSplit!description = szDes
               adoRstDemandSplit!DemandStatement = True
               adoRstDemandSplit!VAT_CODE = GetVATCode_Tenant(adoRstLeaseDtl!SageAccountNumber, adoConn)
               If Left(adoRstIns!CalDays, 1) <> "-" Then
               '           ADVANCE
                  adoRstDemandSplit!dateFrom = CDate(adoRstIns!InsuranceNextDueDate)
                  adoRstDemandSplit!DateTO = DateAdd("d", -1, dtNtDueDate)
               Else
               '           ARREARS
'                  adoRstDemandSplit!DateFrom = DateAdd(Right(adoRstIns!CalDays, 1), Left(adoRstIns!CalDays, Len(adoRstIns!CalDays) - 1), adoRstIns!InsuranceNextDueDate) 'CDate(adoRstIns!InsuranceNextDueDate)
                  adoRstDemandSplit!dateFrom = ArrFromDate(adoRstIns!InsuranceNextDueDate, _
                                                   adoRstIns!InsuranceFrequency, _
                                                   adoRstIns!InsuranceDemandType, adoRstIns!propertyID, adoRstIns!CalDays, adoConn)
                  adoRstDemandSplit!DateTO = DateAdd("d", -1, adoRstIns!InsuranceNextDueDate)
               End If

               adoRstDemandSplit!SageDepartment = adoRstIns!InsuranceDept ' DepartmentID(adoRstLeaseDtl!SageAccountNumber, adoRstLeaseDtl!UnitNumber, "Insurance Charge", adoConn)
               adoRstDemandSplit!FrequencyID = adoRstIns!InsuranceFrequency
               adoRstDemandSplit!LChildsRef = adoRstIns!InsCharges
               adoRstDemandSplit.Update

               ICcount = ICcount + 1
               iSerial = iSerial + 1
            End If
            adoRstIns.MoveNext
         Wend
         adoRstIns.Close
'************************************************************************************************
'   Insurance Charge demands     --->     PRO-RATA
'************************************************************************************************
         szSQL = "SELECT I.InsCharges, I.LeaseID, " & _
                        "I.InsuranceStartDate, I.InsuranceFrequency, " & _
                        "I.InsuranceEndDate, I.InsuranceDemandType, " & _
                        "I.InsuranceEachPeriod, I.InsuranceNextDueDate, " & _
                        "I.ChargingType, I.ChargingFigure,I.FDD, " & _
                        "I.TotalYearlyInsurance, I.InsuranceDept, " & _
                        "I.InsDesc, Units.PropertyID, " & _
                        "DemandTypes.Spare1 as ClientBankID, " & _
                        "Frequencies.CalDays, StopIC,Frequencies.ID " & _
                    "FROM LInsuranceCharges AS I, LeaseDetails, Units, DemandTypes, Frequencies "

         If frmDemandTypesSel.cboGDPFreq.Column(0) = 0 Then
          'issue 331 Modified by anol 20170315
'            szSQL = szSQL & _
'                    "WHERE I.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
'                        "LeaseDetails.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
'                        "LeaseDetails.GPrataDmd = TRUE AND I.GPD = FALSE AND " & _
'                        "I.LeaseID = LeaseDetails.LeaseID AND I.StopAutoDmd = TRUE AND " & _
'                        "LeaseDetails.EndDate >= CDATE(I.FDD) AND " & _
'                        "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
'                        "I.InsuranceEachPeriod > 0 AND (ISNULL(I.spare3) OR I.spare3 <> 'DELETED') AND " & _
'                        "I.InsuranceDemandType = DemandTypes.ID AND " & _
'                        "I.InsuranceFrequency = Frequencies.ID;"
'AND I.GPD = TRUE I have removed this field from where clause before proper implementation is done. anol 2020-06-11 In prorata
szSQL = szSQL & _
                    "WHERE I.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                        "LeaseDetails.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                        "LeaseDetails.GPrataDmd = TRUE  AND " & _
                        "I.LeaseID = LeaseDetails.LeaseID AND I.StopAutoDmd = TRUE AND " & _
                        "LeaseDetails.EndDate < CDATE(I.FDD) AND " & _
                        "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
                        "I.InsuranceEachPeriod > 0 AND (ISNULL(I.spare3) OR I.spare3 <> 'DELETED') AND " & _
                        "I.InsuranceDemandType = DemandTypes.ID AND " & _
                        "I.InsuranceFrequency = Frequencies.ID;"
         Else
          'issue 331 Modified by anol 20170315
'            szSQL = szSQL & _
'                    "WHERE I.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
'                        "LeaseDetails.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
'                        "LeaseDetails.GPrataDmd = TRUE AND I.GPD = FALSE AND " & _
'                        "I.LeaseID = LeaseDetails.LeaseID AND I.StopAutoDmd = TRUE AND " & _
'                        "LeaseDetails.EndDate >= CDATE(I.FDD) AND " & _
'                        "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
'                        "I.InsuranceEachPeriod > 0 AND (ISNULL(I.spare3) OR I.spare3 <> 'DELETED') AND " & _
'                        "I.InsuranceDemandType = DemandTypes.ID AND " & _
'                        "I.InsuranceFrequency = Frequencies.ID AND " & _
'                        "Frequencies.ID = " & frmDemandTypesSel.cboGDPFreq.Column(0) & ";"
'AND I.GPD = FALSE IN prorata
 szSQL = szSQL & _
                    "WHERE I.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                        "LeaseDetails.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                        "LeaseDetails.GPrataDmd = TRUE AND " & _
                        "I.LeaseID = LeaseDetails.LeaseID AND I.StopAutoDmd = TRUE AND " & _
                        "LeaseDetails.EndDate < CDATE(I.FDD) AND " & _
                        "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
                        "I.InsuranceEachPeriod > 0 AND (ISNULL(I.spare3) OR I.spare3 <> 'DELETED') AND " & _
                        "I.InsuranceDemandType = DemandTypes.ID AND " & _
                        "I.InsuranceFrequency = Frequencies.ID AND " & _
                        "Frequencies.ID = " & frmDemandTypesSel.cboGDPFreq.Column(0) & ";"
         End If
'Debug.Print szSQL
         adoRstIns.Open szSQL, adoConn, adOpenStatic, adLockReadOnly

         While Not adoRstIns.EOF
            If IsNull(adoRstIns!StopIC) Or adoRstIns!StopIC = "" Then
               bProceed = True
            Else
               bProceed = IIf(DateDiff("d", adoRstIns!InsuranceNextDueDate, CDate(adoRstIns!StopIC)) > 0, True, False)
            End If
            If adoRstLeaseDtl!InsurancePayable = "Y" And _
               DateDiff("d", Date, IIf(adoRstIns!InsuranceNextDueDate = "", _
                  DateAdd("d", -1, Date), adoRstIns!InsuranceNextDueDate)) <= DaysB4Due And bProceed And _
               IsDmdTypeSel(adoRstIns.Fields("InsuranceDemandType").Value) Then
   '**** Insert the Header info in the DemandRecPreview table
               lDemand = lDemand + 1
               With adoRstDemandRec
                  .AddNew
                  .Fields("DemandID").Value = lDemand
                 
                  .Fields("BatchID").Value = 1
                  .Fields("SageAccountNumber").Value = adoRstLeaseDtl!SageAccountNumber
                  .Fields("TenantCompanyName").Value = adoRstLeaseDtl!CompanyName
                  .Fields("UnitNumber").Value = adoRstLeaseDtl!UnitNumber
                  .Fields("Source").Value = 1
                  .Fields("TransactionType").Value = 1
   '***Here my thinking is, all type of demands due date is on the same day
   '***If its not correct then i have to change the manual demands grid and the demand table & split table
                  .Fields("IssueDate").Value = Format(Date, "dd/mm/yyyy")
                  .Fields("SageText").Value = "S/L " & adoRstLeaseDtl!SageAccountNumber
                  .Fields("IsPrinted").Value = False
                  .Fields("Spare1").Value = adoRstIns!ClientBankID
                  .Fields.Item("LeaseRef").Value = adoRstLeaseDtl!LeaseID
                  .Update
               End With

               iChildId = 1
               szDes = IIf(IIf(IsNull(adoRstIns!InsDesc), "", adoRstIns!InsDesc) = "", DemandTypeName(adoRstIns!InsuranceDemandType, adoConn), adoRstIns!InsDesc)

               adoRstDemandSplit.AddNew
               adoRstDemandSplit!DSR = UniqueID()
               adoRstDemandSplit!splitID = iChildId
               adoRstDemandSplit!DEMANDID = lDemand
               adoRstDemandSplit!A_M = "A"
               adoRstDemandSplit!NominalCodeforAmount = PartString(szaNCode(adoRstIns!InsuranceDemandType), 0, " # ")
               adoRstDemandSplit!NominalNameforAmount = PartString(szaNCName(adoRstIns!InsuranceDemandType), 0, " # ")
               adoRstDemandSplit!NominalCodeForVAT = PartString(szaNCode(adoRstIns!InsuranceDemandType), 1, " # ")
               adoRstDemandSplit!NominalNameforVAT = PartString(szaNCName(adoRstIns!InsuranceDemandType), 1, " # ")
               adoRstDemandSplit!NominalCodeForTotal = PartString(szaNCode(adoRstIns!InsuranceDemandType), 2, " # ")
               adoRstDemandSplit!NominalNameforTotal = PartString(szaNCName(adoRstIns!InsuranceDemandType), 2, " # ")
               adoRstDemandSplit!SageRef = "EL"
               adoRstDemandSplit!DueDate = Format(adoRstIns!InsuranceNextDueDate, "dd/mm/yyyy")
               adoRstDemandSplit!VATMonth = Month(adoRstIns!InsuranceNextDueDate)
               adoRstDemandSplit!TypeOfDemand = adoRstIns!InsuranceDemandType
               adoRstDemandSplit!description = szDes
               adoRstDemandSplit!DemandStatement = True
               adoRstDemandSplit!VAT_CODE = GetVATCode_Tenant(adoRstLeaseDtl!SageAccountNumber, adoConn)

               If Left(adoRstIns!CalDays, 1) <> "-" Then             '           ADVANCE
                  adoRstDemandSplit!dateFrom = CDate(adoRstIns!InsuranceNextDueDate)
               Else                                                  '           ARREARS
'                  adoRstDemandSplit!DateFrom = DateAdd(Right(adoRstIns!CalDays, 1), Left(adoRstIns!CalDays, Len(adoRstIns!CalDays) - 1), adoRstIns!InsuranceNextDueDate) 'CDate(adoRstIns!InsuranceNextDueDate)
                  adoRstDemandSplit!dateFrom = ArrFromDate(adoRstIns!InsuranceNextDueDate, _
                                                   adoRstIns!InsuranceFrequency, _
                                                   adoRstIns!InsuranceDemandType, adoRstIns!propertyID, adoRstIns!CalDays, adoConn)
               End If
               adoRstDemandSplit!DateTO = adoRstLeaseDtl!EndDate

               If DateDiff("d", adoRstLeaseDtl!EndDate, adoRstIns.Fields.Item("FDD")) = 1 Then
                  'do not calculatate prorata ,calculate full
                  adoRstDemandSplit!amount = RoundingNumber(Val(adoRstIns.Fields.Item("TotalYearlyInsurance") / szaPartofYear(adoRstIns("ID").Value)), 2)
               Else
                  'calculate prorata and also add 1 day with datediff
                   adoRstDemandSplit!amount = RoundingNumber((Val(adoRstIns.Fields.Item("TotalYearlyInsurance")) / 365) * (DateDiff("D", adoRstDemandSplit!dateFrom, adoRstDemandSplit!DateTO) + 1), 2)
               End If
               'adoRstDemandSplit!amount = RoundingNumber(adoRstIns!TotalYearlyInsurance / 365 * DateDiff("D", adoRstDemandSplit!DateFrom, adoRstDemandSplit!DateTo), 2)
               adoRstDemandSplit!VATAMOUNT = RoundingNumber(adoRstDemandSplit!amount * GetVAT_Tenant(adoRstLeaseDtl!SageAccountNumber, adoConn) / 100, 2)
               adoRstDemandSplit!TotalAmount = adoRstDemandSplit!amount + adoRstDemandSplit!VATAMOUNT

               adoRstDemandSplit!SageDepartment = adoRstIns!InsuranceDept ' DepartmentID(adoRstLeaseDtl!SageAccountNumber, adoRstLeaseDtl!UnitNumber, "Insurance Charge", adoConn)
               adoRstDemandSplit!FrequencyID = adoRstIns!InsuranceFrequency
               adoRstDemandSplit!LChildsRef = adoRstIns!InsCharges
               adoRstDemandSplit.Update

               ICcount = ICcount + 1
               iSerial = iSerial + 1
            End If
            adoRstIns.MoveNext
         Wend
         adoRstIns.Close
         Set adoRstIns = Nothing
'MsgBox adoRstLeaseDtl.RecordCount
         adoRstLeaseDtl.MoveNext
      Wend

      adoRstLeaseDtl.Close
      adoRstDemandRec.Close
      adoRstDemandSplit.Close

      Set adoRstLeaseDtl = Nothing
      Set adoRstDemandRec = Nothing
      Set adoRstDemandSplit = Nothing
   End If

   MousePointer = vbDefault

   Exit Function
ErrH:
   'This can only pick up error 13 (type mis-match) and it is at the users discretion to not enter a date.
   MsgBox Err.Number & " - (pcm_001)" & Err.description, vbOKOnly, "Error - Pre Demand View"
End Function
Private Sub WriteServiceChargesSngPreview(adoConn As ADODB.Connection, adoRstLeaseDtl As ADODB.Recordset, adoRstDemandRec As ADODB.Recordset, _
         adoRstDemandSplit As ADODB.Recordset, DaysB4Due As Integer, szaNCode() As String, _
        szaNCName() As String, szaPartofYear() As Integer, szaPrefix() As String, SCcount As Integer, lDemand As Long)

    Dim bSC As Boolean
    Dim bProceed As Boolean
    Dim bPRSC As Boolean
    Dim bSCNeg As Boolean
    Dim bPRSCNeg As Boolean
    Dim szSQL As String
   'Dim lDemand As Long
    Dim lBatch As Long

    Dim iChildId As Long
    Dim iSerial As Long
    Dim szDes As String
    Dim dtNtDueDate As Date
    Dim dtFDD As Date
    Dim adoRstSC As New ADODB.Recordset
    Dim adoRstSCNeg As New ADODB.Recordset
    Dim adoPRRstSC As New ADODB.Recordset
    Dim adoPRRstSCNeg As New ADODB.Recordset
'************************************************************************************************
'   Service Charge demands
'************************************************************************************************
         szSQL = "SELECT S.ServiceCharge, S.LeaseID, " & _
                        "S.SCFrequency, S.SCPayableFrom, " & _
                        "S.SCNextDueDate, S.ChargingMethod, " & _
                        "S.CMFigure, S.SCTotal, " & _
                        "S.SCAmount, S.SCTOLimit, " & _
                        "S.SCDemandType, S.ServiceChargeDept, " & _
                        "S.SCDesc, Units.PropertyID, StopSC, " & _
                        "DemandTypes.Spare1 as ClientBankID, Frequencies.CalDays " & _
                    "FROM LServiceCharges AS S, LeaseDetails, Units, DemandTypes, Frequencies "

         If frmDemandTypesSel.cboGDPFreq.Column(0) = 0 Then

            szSQL = szSQL & _
                    "WHERE S.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                        "S.LeaseID = LeaseDetails.LeaseID AND (S.StopAutoDmd = FALSE OR LeaseDetails.GPrataDmd =FALSE OR " & _
                        "(S.StopAutoDmd = TRUE AND LeaseDetails.EndDate >= CDATE(S.FDD))) AND " & _
                        "S.SCAmount > 0 AND LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
                        "(ISNULL(S.spare3) OR S.spare3 <> 'DELETED') AND " & _
                        "S.SCDemandType = DemandTypes.ID AND " & _
                        "S.SCFrequency = Frequencies.ID;"
                        
         Else

           szSQL = szSQL & _
                    "WHERE S.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                        "S.LeaseID = LeaseDetails.LeaseID AND (S.StopAutoDmd = FALSE OR LeaseDetails.GPrataDmd =FALSE OR " & _
                        "(S.StopAutoDmd = TRUE AND LeaseDetails.EndDate >= CDATE(S.FDD))) AND " & _
                        "S.SCAmount > 0 AND  LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
                        "(ISNULL(S.spare3) OR S.spare3 <> 'DELETED') AND " & _
                        "S.SCDemandType = DemandTypes.ID AND " & _
                        "S.SCFrequency = Frequencies.ID AND " & _
                        "Frequencies.ID = " & frmDemandTypesSel.cboGDPFreq.Column(0) & ";"
         End If
'Debug.Print szSQL
  'Remming S.SCAmount > 0 AND  2020-12-02 issue 898
  'Exit Sub
         Set adoRstSC = New ADODB.Recordset

         adoRstSC.Open szSQL, adoConn, adOpenStatic, adLockReadOnly

         While Not adoRstSC.EOF
            If IsNull(adoRstSC!StopSC) Or adoRstSC!StopSC = "" Then
               bProceed = True
            Else
               bProceed = IIf(DateDiff("d", adoRstSC!SCNextDueDate, CDate(adoRstSC!StopSC)) > 0, True, False)
            End If
            If adoRstLeaseDtl!SCPayable = "Y" And _
               DateDiff("d", Date, IIf(adoRstSC!SCNextDueDate = "", _
                  DateAdd("d", -1, Date), adoRstSC!SCNextDueDate)) <= DaysB4Due And bProceed And _
               IsDmdTypeSel(adoRstSC.Fields("SCDemandType").Value) And _
               IIf(adoRstLeaseDtl!OLED, True, adoRstLeaseDtl!EndDate > adoRstSC!SCNextDueDate) Then
'**** Insert the Header info in the DemandRecPreview table
               lDemand = lDemand + 1
               With adoRstDemandRec
                  .AddNew
                  .Fields("DemandID").Value = lDemand
                  .Fields("BatchID").Value = 1
                  .Fields("SageAccountNumber").Value = adoRstLeaseDtl!SageAccountNumber
                  .Fields("TenantCompanyName").Value = adoRstLeaseDtl!CompanyName
                  .Fields("UnitNumber").Value = adoRstLeaseDtl!UnitNumber
                  .Fields("Source").Value = 1
                  .Fields("TransactionType").Value = 1
   '***Here my thinking is, all type of demands due date is on the same day
   '***If its not correct then i have to change the manual demands grid and the demand table & split table
                  .Fields("IssueDate").Value = Format(Date, "dd/mm/yyyy")
                  .Fields("SageText").Value = "S/L " & adoRstLeaseDtl!SageAccountNumber
                  .Fields("IsPrinted").Value = False
                  .Fields("Spare1").Value = adoRstSC!ClientBankID
                  .Fields.Item("LeaseRef").Value = adoRstLeaseDtl!LeaseID
                  .Update
               End With

               iChildId = 1
               szDes = IIf(IIf(IsNull(adoRstSC!SCDesc), "", adoRstSC!SCDesc) = "", DemandTypeName(adoRstSC!SCDemandType, adoConn), adoRstSC!SCDesc)

               dtNtDueDate = FindNextDueDate(adoRstSC!SCNextDueDate, _
                                 adoRstSC!SCFrequency, adoRstSC!SCDemandType, adoRstSC!propertyID, adoConn)

               adoRstDemandSplit.AddNew
               adoRstDemandSplit!DSR = UniqueID()
               adoRstDemandSplit!splitID = iChildId
               adoRstDemandSplit!DEMANDID = lDemand
               adoRstDemandSplit!A_M = "A"
               adoRstDemandSplit!NominalCodeforAmount = PartString(szaNCode(adoRstSC!SCDemandType), 0, " # ")
               adoRstDemandSplit!NominalNameforAmount = PartString(szaNCName(adoRstSC!SCDemandType), 0, " # ")
               adoRstDemandSplit!NominalCodeForVAT = PartString(szaNCode(adoRstSC!SCDemandType), 1, " # ")
               adoRstDemandSplit!NominalNameforVAT = PartString(szaNCName(adoRstSC!SCDemandType), 1, " # ")
               adoRstDemandSplit!NominalCodeForTotal = PartString(szaNCode(adoRstSC!SCDemandType), 2, " # ")
               adoRstDemandSplit!NominalNameforTotal = PartString(szaNCName(adoRstSC!SCDemandType), 2, " # ")
               adoRstDemandSplit!amount = CCur(adoRstSC!SCAmount)
               adoRstDemandSplit!VATAMOUNT = RoundingNumber(adoRstSC!SCAmount * GetVAT_Tenant(adoRstLeaseDtl!SageAccountNumber, adoConn) / 100, 2)
               adoRstDemandSplit!TotalAmount = adoRstDemandSplit!amount + adoRstDemandSplit!VATAMOUNT
               adoRstDemandSplit!SageRef = szaPrefix(adoRstSC!SCDemandType) & Format(SlNumber("SI", "DemandRecords", adoConn), "00000")
               adoRstDemandSplit!DueDate = Format(adoRstSC!SCNextDueDate.Value, "dd/mm/yyyy")
               adoRstDemandSplit!VATMonth = Month(adoRstSC!SCNextDueDate)
               adoRstDemandSplit!TypeOfDemand = adoRstSC!SCDemandType
               adoRstDemandSplit!description = szDes
               adoRstDemandSplit!DemandStatement = True
               adoRstDemandSplit!VAT_CODE = GetVATCode_Tenant(adoRstLeaseDtl!SageAccountNumber, adoConn)
               If Left(adoRstSC!CalDays, 1) <> "-" Then
'                          ADVANCE
                  adoRstDemandSplit!dateFrom = CDate(adoRstSC!SCNextDueDate)
                  adoRstDemandSplit!DateTO = DateAdd("d", -1, dtNtDueDate)
               Else
'                          ARREARS
'                  adoRstDemandSplit!DateFrom = DateAdd(Right(adoRstSC!CalDays, 1), Left(adoRstSC!CalDays, Len(adoRstSC!CalDays) - 1), adoRstSC!SCNextDueDate) 'CDate(adoRstSC!SCNextDueDate)
                  adoRstDemandSplit!dateFrom = ArrFromDate(adoRstSC!SCNextDueDate, _
                                                adoRstSC!SCFrequency, adoRstSC!SCDemandType, adoRstSC!propertyID, adoRstSC!CalDays, adoConn)
                  adoRstDemandSplit!DateTO = DateAdd("d", -1, adoRstSC!SCNextDueDate)
               End If

               adoRstDemandSplit!SageDepartment = adoRstSC!ServiceChargeDept ' DepartmentID(adoRstLeaseDtl!SageAccountNumber, adoRstLeaseDtl!UnitNumber, "Service Charge", adoConn)
               adoRstDemandSplit!FrequencyID = adoRstSC!SCFrequency
               adoRstDemandSplit!LChildsRef = adoRstSC!ServiceCharge
               adoRstDemandSplit.Update

               SCcount = SCcount + 1
               iSerial = iSerial + 1
            End If
            adoRstSC.MoveNext
         Wend
         adoRstSC.Close
'************************************************************************************************
'   Service Charge demands   Negative charge Amount -> Credit note
'************************************************************************************************
         szSQL = "SELECT S.ServiceCharge, S.LeaseID, " & _
                        "S.SCFrequency, S.SCPayableFrom, " & _
                        "S.SCNextDueDate, S.ChargingMethod, " & _
                        "S.CMFigure, S.SCTotal, " & _
                        "S.SCAmount, S.SCTOLimit, " & _
                        "S.SCDemandType, S.ServiceChargeDept, " & _
                        "S.SCDesc, Units.PropertyID, StopSC, " & _
                        "DemandTypes.Spare1 as ClientBankID, Frequencies.CalDays " & _
                    "FROM LServiceCharges AS S, LeaseDetails, Units, DemandTypes, Frequencies "

         If frmDemandTypesSel.cboGDPFreq.Column(0) = 0 Then

            szSQL = szSQL & _
                    "WHERE S.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                        "S.LeaseID = LeaseDetails.LeaseID AND (S.StopAutoDmd = FALSE OR LeaseDetails.GPrataDmd =FALSE OR " & _
                        "(S.StopAutoDmd = TRUE AND LeaseDetails.EndDate >= CDATE(S.FDD))) AND " & _
                        "S.SCAmount < 0 AND LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
                        "(ISNULL(S.spare3) OR S.spare3 <> 'DELETED') AND " & _
                        "S.SCDemandType = DemandTypes.ID AND " & _
                        "S.SCFrequency = Frequencies.ID;"
                        
         Else

           szSQL = szSQL & _
                    "WHERE S.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                        "S.LeaseID = LeaseDetails.LeaseID AND (S.StopAutoDmd = FALSE OR LeaseDetails.GPrataDmd =FALSE OR " & _
                        "(S.StopAutoDmd = TRUE AND LeaseDetails.EndDate >= CDATE(S.FDD))) AND " & _
                        "S.SCAmount < 0 AND  LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
                        "(ISNULL(S.spare3) OR S.spare3 <> 'DELETED') AND " & _
                        "S.SCDemandType = DemandTypes.ID AND " & _
                        "S.SCFrequency = Frequencies.ID AND " & _
                        "Frequencies.ID = " & frmDemandTypesSel.cboGDPFreq.Column(0) & ";"
         End If
'Debug.Print szSQL
  'Remming S.SCAmount > 0 AND  2020-12-02 issue 898
         Set adoRstSC = New ADODB.Recordset

         adoRstSC.Open szSQL, adoConn, adOpenStatic, adLockReadOnly

         While Not adoRstSC.EOF
            If IsNull(adoRstSC!StopSC) Or adoRstSC!StopSC = "" Then
               bProceed = True
            Else
               bProceed = IIf(DateDiff("d", adoRstSC!SCNextDueDate, CDate(adoRstSC!StopSC)) > 0, True, False)
            End If
            If adoRstLeaseDtl!SCPayable = "Y" And _
               DateDiff("d", Date, IIf(adoRstSC!SCNextDueDate = "", _
                  DateAdd("d", -1, Date), adoRstSC!SCNextDueDate)) <= DaysB4Due And bProceed And _
               IsDmdTypeSel(adoRstSC.Fields("SCDemandType").Value) And _
               IIf(adoRstLeaseDtl!OLED, True, adoRstLeaseDtl!EndDate > adoRstSC!SCNextDueDate) Then
'**** Insert the Header info in the DemandRecPreview table
               lDemand = lDemand + 1
               With adoRstDemandRec
                  .AddNew
                  .Fields("DemandID").Value = lDemand
                  .Fields("BatchID").Value = 1
                  .Fields("SageAccountNumber").Value = adoRstLeaseDtl!SageAccountNumber
                  .Fields("TenantCompanyName").Value = adoRstLeaseDtl!CompanyName
                  .Fields("UnitNumber").Value = adoRstLeaseDtl!UnitNumber
                  .Fields("Source").Value = 1
                  .Fields("TransactionType").Value = 2
   '***Here my thinking is, all type of demands due date is on the same day
   '***If its not correct then i have to change the manual demands grid and the demand table & split table
                  .Fields("IssueDate").Value = Format(Date, "dd/mm/yyyy")
                  .Fields("SageText").Value = "S/L " & adoRstLeaseDtl!SageAccountNumber
                  .Fields("IsPrinted").Value = False
                  .Fields("Spare1").Value = adoRstSC!ClientBankID
                  .Fields.Item("LeaseRef").Value = adoRstLeaseDtl!LeaseID
                  .Update
               End With

               iChildId = 1
               szDes = IIf(IIf(IsNull(adoRstSC!SCDesc), "", adoRstSC!SCDesc) = "", DemandTypeName(adoRstSC!SCDemandType, adoConn), adoRstSC!SCDesc)

               dtNtDueDate = FindNextDueDate(adoRstSC!SCNextDueDate, _
                                 adoRstSC!SCFrequency, adoRstSC!SCDemandType, adoRstSC!propertyID, adoConn)

               adoRstDemandSplit.AddNew
               adoRstDemandSplit!DSR = UniqueID()
               adoRstDemandSplit!splitID = iChildId
               adoRstDemandSplit!DEMANDID = lDemand
               adoRstDemandSplit!A_M = "A"
               adoRstDemandSplit!NominalCodeforAmount = PartString(szaNCode(adoRstSC!SCDemandType), 0, " # ")
               adoRstDemandSplit!NominalNameforAmount = PartString(szaNCName(adoRstSC!SCDemandType), 0, " # ")
               adoRstDemandSplit!NominalCodeForVAT = PartString(szaNCode(adoRstSC!SCDemandType), 1, " # ")
               adoRstDemandSplit!NominalNameforVAT = PartString(szaNCName(adoRstSC!SCDemandType), 1, " # ")
               adoRstDemandSplit!NominalCodeForTotal = PartString(szaNCode(adoRstSC!SCDemandType), 2, " # ")
               adoRstDemandSplit!NominalNameforTotal = PartString(szaNCName(adoRstSC!SCDemandType), 2, " # ")
               adoRstDemandSplit!amount = (CCur(adoRstSC!SCAmount))
               adoRstDemandSplit!VATAMOUNT = (RoundingNumber(adoRstSC!SCAmount * GetVAT_Tenant(adoRstLeaseDtl!SageAccountNumber, adoConn) / 100, 2))
               adoRstDemandSplit!TotalAmount = (adoRstDemandSplit!amount + adoRstDemandSplit!VATAMOUNT)
               adoRstDemandSplit!SageRef = szaPrefix(adoRstSC!SCDemandType) & Format(SlNumber("SC", "DemandRecords", adoConn), "00000")
               adoRstDemandSplit!DueDate = Format(adoRstSC!SCNextDueDate.Value, "dd/mm/yyyy")
               adoRstDemandSplit!VATMonth = Month(adoRstSC!SCNextDueDate)
               adoRstDemandSplit!TypeOfDemand = adoRstSC!SCDemandType
               adoRstDemandSplit!description = szDes
               adoRstDemandSplit!DemandStatement = True
               adoRstDemandSplit!VAT_CODE = GetVATCode_Tenant(adoRstLeaseDtl!SageAccountNumber, adoConn)
               If Left(adoRstSC!CalDays, 1) <> "-" Then
'                          ADVANCE
                  adoRstDemandSplit!dateFrom = CDate(adoRstSC!SCNextDueDate)
                  adoRstDemandSplit!DateTO = DateAdd("d", -1, dtNtDueDate)
               Else
'                          ARREARS
'                  adoRstDemandSplit!DateFrom = DateAdd(Right(adoRstSC!CalDays, 1), Left(adoRstSC!CalDays, Len(adoRstSC!CalDays) - 1), adoRstSC!SCNextDueDate) 'CDate(adoRstSC!SCNextDueDate)
                  adoRstDemandSplit!dateFrom = ArrFromDate(adoRstSC!SCNextDueDate, _
                                                adoRstSC!SCFrequency, adoRstSC!SCDemandType, adoRstSC!propertyID, adoRstSC!CalDays, adoConn)
                  adoRstDemandSplit!DateTO = DateAdd("d", -1, adoRstSC!SCNextDueDate)
               End If

               adoRstDemandSplit!SageDepartment = adoRstSC!ServiceChargeDept ' DepartmentID(adoRstLeaseDtl!SageAccountNumber, adoRstLeaseDtl!UnitNumber, "Service Charge", adoConn)
               adoRstDemandSplit!FrequencyID = adoRstSC!SCFrequency
               adoRstDemandSplit!LChildsRef = adoRstSC!ServiceCharge
               adoRstDemandSplit.Update

               SCcount = SCcount + 1
               iSerial = iSerial + 1
            End If
            adoRstSC.MoveNext
         Wend
         adoRstSC.Close
'************************************************************************************************
'   Service Charge demands   .--- PRO-RATA
'************************************************************************************************'
         szSQL = "SELECT S.ServiceCharge, S.LeaseID, " & _
                        "S.SCFrequency, S.SCPayableFrom, " & _
                        "S.SCNextDueDate, S.ChargingMethod, " & _
                        "S.CMFigure, S.SCTotal, " & _
                        "S.SCAmount, S.SCTOLimit, " & _
                        "S.SCDemandType, S.ServiceChargeDept,S.FDD, " & _
                        "S.SCDesc, Units.PropertyID, StopSC, " & _
                        "DemandTypes.Spare1 as ClientBankID, Frequencies.CalDays,Frequencies.ID " & _
                    "FROM LServiceCharges AS S, LeaseDetails, Units, DemandTypes, Frequencies "

         If frmDemandTypesSel.cboGDPFreq.Column(0) = 0 Then

            szSQL = szSQL & _
                    "WHERE S.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                        "LeaseDetails.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                        "LeaseDetails.GPrataDmd = TRUE AND " & _
                        "S.StopAutoDmd = TRUE AND " & _
                        "LeaseDetails.EndDate < CDATE(S.FDD) AND " & _
                        "S.SCAmount > 0 AND LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
                        "(ISNULL(S.spare3) OR S.spare3 <> 'DELETED') AND " & _
                        "S.SCDemandType = DemandTypes.ID AND " & _
                        "S.SCFrequency = Frequencies.ID;"
         Else

            szSQL = szSQL & _
                    "WHERE S.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                        "LeaseDetails.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                        "LeaseDetails.GPrataDmd = TRUE  AND " & _
                        "S.StopAutoDmd = TRUE AND " & _
                        "S.SCAmount > 0 AND LeaseDetails.EndDate < CDATE(S.FDD) AND " & _
                        "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
                        "(ISNULL(S.spare3) OR S.spare3 <> 'DELETED') AND " & _
                        "S.SCDemandType = DemandTypes.ID AND " & _
                        "S.SCFrequency = Frequencies.ID AND " & _
                        "Frequencies.ID = " & frmDemandTypesSel.cboGDPFreq.Column(0) & ";"
         End If
           'Remming S.SCAmount > 0 AND  2020-12-02 issue 898
'Debug.Print szSQL
'testing code
'        If "0101150316103109" = adoRstLeaseDtl!LeaseID Then
'            MsgBox "break"
'        End If
         adoRstSC.Open szSQL, adoConn, adOpenStatic, adLockReadOnly

         While Not adoRstSC.EOF
            If IsNull(adoRstSC!StopSC) Or adoRstSC!StopSC = "" Then
               bProceed = True
            Else
               bProceed = IIf(DateDiff("d", adoRstSC!SCNextDueDate, CDate(adoRstSC!StopSC)) > 0, True, False)
            End If
            If adoRstLeaseDtl!SCPayable = "Y" And _
               DateDiff("d", Date, IIf(adoRstSC!SCNextDueDate = "", _
                  DateAdd("d", -1, Date), adoRstSC!SCNextDueDate)) <= DaysB4Due And bProceed And _
               IsDmdTypeSel(adoRstSC.Fields("SCDemandType").Value) Then
'**** Insert the Header info in the DemandRecPreview table
               lDemand = lDemand + 1
               With adoRstDemandRec
                  .AddNew
                  .Fields("DemandID").Value = lDemand
                  .Fields("BatchID").Value = 1
                  .Fields("SageAccountNumber").Value = adoRstLeaseDtl!SageAccountNumber
                  .Fields("TenantCompanyName").Value = adoRstLeaseDtl!CompanyName
                  .Fields("UnitNumber").Value = adoRstLeaseDtl!UnitNumber
                  .Fields("Source").Value = 1
                  .Fields("TransactionType").Value = 1
   '***Here my thinking is, all type of demands due date is on the same day
   '***If its not correct then i have to change the manual demands grid and the demand table & split table
                  .Fields("IssueDate").Value = Format(Date, "dd/mm/yyyy")
                  .Fields("SageText").Value = "S/L " & adoRstLeaseDtl!SageAccountNumber
                  .Fields("IsPrinted").Value = False
                  .Fields("Spare1").Value = adoRstSC!ClientBankID
                  .Fields.Item("LeaseRef").Value = adoRstLeaseDtl!LeaseID
                  .Update
               End With

               iChildId = 1
               szDes = IIf(IIf(IsNull(adoRstSC!SCDesc), "", adoRstSC!SCDesc) = "", DemandTypeName(adoRstSC!SCDemandType, adoConn), adoRstSC!SCDesc)

               adoRstDemandSplit.AddNew
               adoRstDemandSplit!DSR = UniqueID()
               adoRstDemandSplit!splitID = iChildId
               adoRstDemandSplit!DEMANDID = lDemand
               adoRstDemandSplit!A_M = "A"
               adoRstDemandSplit!NominalCodeforAmount = PartString(szaNCode(adoRstSC!SCDemandType), 0, " # ")
               adoRstDemandSplit!NominalNameforAmount = PartString(szaNCName(adoRstSC!SCDemandType), 0, " # ")
               adoRstDemandSplit!NominalCodeForVAT = PartString(szaNCode(adoRstSC!SCDemandType), 1, " # ")
               adoRstDemandSplit!NominalNameforVAT = PartString(szaNCName(adoRstSC!SCDemandType), 1, " # ")
               adoRstDemandSplit!NominalCodeForTotal = PartString(szaNCode(adoRstSC!SCDemandType), 2, " # ")
               adoRstDemandSplit!NominalNameforTotal = PartString(szaNCName(adoRstSC!SCDemandType), 2, " # ")
               adoRstDemandSplit!SageRef = "EL"
               adoRstDemandSplit!DueDate = Format(adoRstSC!SCNextDueDate.Value, "dd/mm/yyyy")
               adoRstDemandSplit!VATMonth = Month(adoRstSC!SCNextDueDate)
               adoRstDemandSplit!TypeOfDemand = adoRstSC!SCDemandType
               adoRstDemandSplit!description = szDes
               adoRstDemandSplit!DemandStatement = True
               adoRstDemandSplit!VAT_CODE = GetVATCode_Tenant(adoRstLeaseDtl!SageAccountNumber, adoConn)

               If Left(adoRstSC!CalDays, 1) <> "-" Then           '                          ADVANCE
                  adoRstDemandSplit!dateFrom = CDate(adoRstSC!SCNextDueDate)
               Else                                               '                          ARREARS
'                  adoRstDemandSplit!DateFrom = DateAdd(Right(adoRstSC!CalDays, 1), Left(adoRstSC!CalDays, Len(adoRstSC!CalDays) - 1), adoRstSC!SCNextDueDate) 'CDate(adoRstSC!SCNextDueDate)
                  adoRstDemandSplit!dateFrom = ArrFromDate(adoRstSC!SCNextDueDate, _
                                                adoRstSC!SCFrequency, adoRstSC!SCDemandType, adoRstSC!propertyID, adoRstSC!CalDays, adoConn)
               End If
               adoRstDemandSplit!DateTO = adoRstLeaseDtl!EndDate


               If DateDiff("d", adoRstLeaseDtl!EndDate, adoRstSC.Fields.Item("FDD")) = 1 Then
                  'do not calculatate prorata ,calculate full
                  adoRstDemandSplit!amount = RoundingNumber(Val(adoRstSC.Fields.Item("SCTotal") / szaPartofYear(adoRstSC("ID").Value)), 2)
               Else
                  'calculate prorata and also add 1 day with datediff
                   adoRstDemandSplit!amount = RoundingNumber((Val(adoRstSC.Fields.Item("SCTotal")) / 365) * (DateDiff("D", adoRstDemandSplit!dateFrom, adoRstDemandSplit!DateTO) + 1), 2)
               End If
                  
               'adoRstDemandSplit!amount = RoundingNumber((adoRstSC!SCTotal) / 365 * DateDiff("D", adoRstDemandSplit!DateFrom, adoRstDemandSplit!DateTo), 2)
               adoRstDemandSplit!VATAMOUNT = RoundingNumber(adoRstDemandSplit!amount * GetVAT_Tenant(adoRstLeaseDtl!SageAccountNumber, adoConn) / 100, 2)
               adoRstDemandSplit!TotalAmount = adoRstDemandSplit!amount + adoRstDemandSplit!VATAMOUNT

               adoRstDemandSplit!SageDepartment = adoRstSC!ServiceChargeDept
               adoRstDemandSplit!FrequencyID = adoRstSC!SCFrequency
               adoRstDemandSplit!LChildsRef = adoRstSC!ServiceCharge
               adoRstDemandSplit.Update

               SCcount = SCcount + 1
               iSerial = iSerial + 1
            End If
            adoRstSC.MoveNext
         Wend
         adoRstSC.Close
         Set adoRstSC = Nothing
        
        '************************************************************************************************
'   Service Charge demands   .--- PRO-RATA   Negative charge amount -Credit note
'************************************************************************************************'
         szSQL = "SELECT S.ServiceCharge, S.LeaseID, " & _
                        "S.SCFrequency, S.SCPayableFrom, " & _
                        "S.SCNextDueDate, S.ChargingMethod, " & _
                        "S.CMFigure, S.SCTotal, " & _
                        "S.SCAmount, S.SCTOLimit, " & _
                        "S.SCDemandType, S.ServiceChargeDept,S.FDD, " & _
                        "S.SCDesc, Units.PropertyID, StopSC, " & _
                        "DemandTypes.Spare1 as ClientBankID, Frequencies.CalDays,Frequencies.ID " & _
                    "FROM LServiceCharges AS S, LeaseDetails, Units, DemandTypes, Frequencies "

         If frmDemandTypesSel.cboGDPFreq.Column(0) = 0 Then

            szSQL = szSQL & _
                    "WHERE S.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                        "LeaseDetails.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                        "LeaseDetails.GPrataDmd = TRUE AND " & _
                        "S.StopAutoDmd = TRUE AND " & _
                        "LeaseDetails.EndDate < CDATE(S.FDD) AND " & _
                        "S.SCAmount < 0 AND LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
                        "(ISNULL(S.spare3) OR S.spare3 <> 'DELETED') AND " & _
                        "S.SCDemandType = DemandTypes.ID AND " & _
                        "S.SCFrequency = Frequencies.ID;"
         Else

            szSQL = szSQL & _
                    "WHERE S.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                        "LeaseDetails.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                        "LeaseDetails.GPrataDmd = TRUE  AND " & _
                        "S.StopAutoDmd = TRUE AND " & _
                        "S.SCAmount < 0 AND LeaseDetails.EndDate < CDATE(S.FDD) AND " & _
                        "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
                        "(ISNULL(S.spare3) OR S.spare3 <> 'DELETED') AND " & _
                        "S.SCDemandType = DemandTypes.ID AND " & _
                        "S.SCFrequency = Frequencies.ID AND " & _
                        "Frequencies.ID = " & frmDemandTypesSel.cboGDPFreq.Column(0) & ";"
         End If
           'Remming S.SCAmount > 0 AND  2020-12-02 issue 898
'Debug.Print szSQL
'testing code
'        If "0101150316103109" = adoRstLeaseDtl!LeaseID Then
'            MsgBox "break"
'        End If
         adoRstSC.Open szSQL, adoConn, adOpenStatic, adLockReadOnly

         While Not adoRstSC.EOF
            If IsNull(adoRstSC!StopSC) Or adoRstSC!StopSC = "" Then
               bProceed = True
            Else
               bProceed = IIf(DateDiff("d", adoRstSC!SCNextDueDate, CDate(adoRstSC!StopSC)) > 0, True, False)
            End If
            If adoRstLeaseDtl!SCPayable = "Y" And _
               DateDiff("d", Date, IIf(adoRstSC!SCNextDueDate = "", _
                  DateAdd("d", -1, Date), adoRstSC!SCNextDueDate)) <= DaysB4Due And bProceed And _
               IsDmdTypeSel(adoRstSC.Fields("SCDemandType").Value) Then
'**** Insert the Header info in the DemandRecPreview table
               lDemand = lDemand + 1
               With adoRstDemandRec
                  .AddNew
                  .Fields("DemandID").Value = lDemand
                  .Fields("BatchID").Value = 1
                  .Fields("SageAccountNumber").Value = adoRstLeaseDtl!SageAccountNumber
                  .Fields("TenantCompanyName").Value = adoRstLeaseDtl!CompanyName
                  .Fields("UnitNumber").Value = adoRstLeaseDtl!UnitNumber
                  .Fields("Source").Value = 1
                  .Fields("TransactionType").Value = 2
   '***Here my thinking is, all type of demands due date is on the same day
   '***If its not correct then i have to change the manual demands grid and the demand table & split table
                  .Fields("IssueDate").Value = Format(Date, "dd/mm/yyyy")
                  .Fields("SageText").Value = "S/L " & adoRstLeaseDtl!SageAccountNumber
                  .Fields("IsPrinted").Value = False
                  .Fields("Spare1").Value = adoRstSC!ClientBankID
                  .Fields.Item("LeaseRef").Value = adoRstLeaseDtl!LeaseID
                  .Update
               End With

               iChildId = 1
               szDes = IIf(IIf(IsNull(adoRstSC!SCDesc), "", adoRstSC!SCDesc) = "", DemandTypeName(adoRstSC!SCDemandType, adoConn), adoRstSC!SCDesc)

               adoRstDemandSplit.AddNew
               adoRstDemandSplit!DSR = UniqueID()
               adoRstDemandSplit!splitID = iChildId
               adoRstDemandSplit!DEMANDID = lDemand
               adoRstDemandSplit!A_M = "A"
               adoRstDemandSplit!NominalCodeforAmount = PartString(szaNCode(adoRstSC!SCDemandType), 0, " # ")
               adoRstDemandSplit!NominalNameforAmount = PartString(szaNCName(adoRstSC!SCDemandType), 0, " # ")
               adoRstDemandSplit!NominalCodeForVAT = PartString(szaNCode(adoRstSC!SCDemandType), 1, " # ")
               adoRstDemandSplit!NominalNameforVAT = PartString(szaNCName(adoRstSC!SCDemandType), 1, " # ")
               adoRstDemandSplit!NominalCodeForTotal = PartString(szaNCode(adoRstSC!SCDemandType), 2, " # ")
               adoRstDemandSplit!NominalNameforTotal = PartString(szaNCName(adoRstSC!SCDemandType), 2, " # ")
               adoRstDemandSplit!SageRef = "EL"
               adoRstDemandSplit!DueDate = Format(adoRstSC!SCNextDueDate.Value, "dd/mm/yyyy")
               adoRstDemandSplit!VATMonth = Month(adoRstSC!SCNextDueDate)
               adoRstDemandSplit!TypeOfDemand = adoRstSC!SCDemandType
               adoRstDemandSplit!description = szDes
               adoRstDemandSplit!DemandStatement = True
               adoRstDemandSplit!VAT_CODE = GetVATCode_Tenant(adoRstLeaseDtl!SageAccountNumber, adoConn)

               If Left(adoRstSC!CalDays, 1) <> "-" Then           '                          ADVANCE
                  adoRstDemandSplit!dateFrom = CDate(adoRstSC!SCNextDueDate)
               Else                                               '                          ARREARS
'                  adoRstDemandSplit!DateFrom = DateAdd(Right(adoRstSC!CalDays, 1), Left(adoRstSC!CalDays, Len(adoRstSC!CalDays) - 1), adoRstSC!SCNextDueDate) 'CDate(adoRstSC!SCNextDueDate)
                  adoRstDemandSplit!dateFrom = ArrFromDate(adoRstSC!SCNextDueDate, _
                                                adoRstSC!SCFrequency, adoRstSC!SCDemandType, adoRstSC!propertyID, adoRstSC!CalDays, adoConn)
               End If
               adoRstDemandSplit!DateTO = adoRstLeaseDtl!EndDate


               If DateDiff("d", adoRstLeaseDtl!EndDate, adoRstSC.Fields.Item("FDD")) = 1 Then
                  'do not calculatate prorata ,calculate full
                  adoRstDemandSplit!amount = Abs(RoundingNumber(Val(adoRstSC.Fields.Item("SCTotal") / szaPartofYear(adoRstSC("ID").Value)), 2))
               Else
                  'calculate prorata and also add 1 day with datediff
                   adoRstDemandSplit!amount = Abs(RoundingNumber((Val(adoRstSC.Fields.Item("SCTotal")) / 365) * (DateDiff("D", adoRstDemandSplit!dateFrom, adoRstDemandSplit!DateTO) + 1), 2))
               End If
                  
               'adoRstDemandSplit!amount = RoundingNumber((adoRstSC!SCTotal) / 365 * DateDiff("D", adoRstDemandSplit!DateFrom, adoRstDemandSplit!DateTo), 2)
               adoRstDemandSplit!VATAMOUNT = Abs(RoundingNumber(adoRstDemandSplit!amount * GetVAT_Tenant(adoRstLeaseDtl!SageAccountNumber, adoConn) / 100, 2))
               adoRstDemandSplit!TotalAmount = Abs(adoRstDemandSplit!amount + adoRstDemandSplit!VATAMOUNT)

               adoRstDemandSplit!SageDepartment = adoRstSC!ServiceChargeDept
               adoRstDemandSplit!FrequencyID = adoRstSC!SCFrequency
               adoRstDemandSplit!LChildsRef = adoRstSC!ServiceCharge
               adoRstDemandSplit.Update

               SCcount = SCcount + 1
               iSerial = iSerial + 1
            End If
            adoRstSC.MoveNext
         Wend
         adoRstSC.Close
         Set adoRstSC = Nothing
End Sub
Public Sub PrintAllDemands()
   Dim rsMinDueDate As New ADODB.Recordset
   Dim bPrintMarked As Boolean
   Dim strSQLTitles As String
   Dim varAns
   Dim rRow As Integer
   Dim reportApp As New CRAXDRT.Application
   Dim Report As CRAXDRT.Report

   ' Declare Variables
   Dim szDataPath As String

   bPrintMarked = False
   varAns = MsgBox("Do you want to set the status of your demands to ""Printed""?", vbYesNoCancel, "Print Demand")
   bPrintMarked = IIf(varAns = vbYes, True, False)
   If varAns = vbCancel Then Exit Sub

   Dim iRow       As Integer
   Dim szWhere    As String
   Dim iTemp      As Integer

   Dim adoConn          As New ADODB.Connection
   Dim adoRstDRecords   As New ADODB.Recordset
   Dim adoRstDRCurrent  As New ADODB.Recordset
   Dim adoTenants       As New ADODB.Recordset

   MousePointer = vbHourglass

   adoConn.Open getConnectionString
   If DemandPrintIsLocked(adoConn) Then
      MsgBox "The system is busy printing demands, please come back in few minutes.", vbInformation + vbOKOnly, "Demand Printing"
      adoConn.Close
      Set adoConn = Nothing
      Exit Sub
   Else
      DemandPrintLock adoConn
   End If
   
   adoConn.Execute "DELETE * FROM tlbDRCURRENTPRINT"

   strSQLTitles = "SELECT * FROM tlbDRCURRENTPRINT;"
   adoRstDRCurrent.Open strSQLTitles, adoConn, adOpenDynamic, adLockPessimistic

   For iRow = 1 To flxDemands.Rows - 1
      szWhere = "DR.DEMANDID = " + CStr(CLng(flxDemands.TextMatrix(iRow, 1))) + ""
      strSQLTitles = "SELECT DR.DEMANDID AS D_ID, DR.BATCHID AS B_ID, " & _
                        "DR.SAGEACCOUNTNUMBER AS S_AC, " & _
                        "DR.UNITNUMBER AS U_NUM, DR.SOURCE AS SOU, " & _
                        "DR.TRANSACTIONTYPE AS T_TYPE, " & _
                        "DR.ISSUEDATE AS IDT, DSR.A_M AS A_M, " & _
                        "DSR.splitid as S_ID, DSR.NOMINALCODEFORAMOUNT AS NCA, " & _
                        "DSR.NOMINALNAMEFORAMOUNT AS NNA, DSR.NOMINALCODEFORVAT AS NCV, " & _
                        "DSR.NOMINALNAMEFORVAT AS NNV, DSR.NOMINALCODEFORTOTAL AS NCT, " & _
                        "DSR.NOMINALNAMEFORTOTAL AS NNT, DSR.AMOUNT AS AMT, DSR.VATAMOUNT AS VAMT, " & _
                        "DSR.TOTALAMOUNT AS TAMT, " & _
                        "DSR.SAGEREF AS SREF, DSR.DUEDATE AS DDT, " & _
                        "DSR.VATMONTH AS VMTH, DSR.TYPEOFDEMAND AS TDM, " & _
                        "DSR.DESCRIPTION AS DESCR, DSR.DEMANDSTATEMENT AS D_ST, " & _
                        "DSR.DATEFROM AS D_FROM, " & _
                        "DSR.DATETO AS D_TO, Tenants.spare1, " & _
                        "DemandTypes.DemandReportName AS DRN, DemandTypes.CategoryCode "
      strSQLTitles = strSQLTitles & _
                     "FROM DemandRecords as DR, DemandSplitRecords as DSR, Tenants, " & _
                          "DemandTypes, Units AS U "
      strSQLTitles = strSQLTitles & _
                     "WHERE (" & szWhere & ") AND " & _
                        "DSR.DEMANDID = DR.DEMANDID AND " & _
                        "Tenants.SAGEACCOUNTNUMBER = DR.SAGEACCOUNTNUMBER AND " & _
                        "DSR.TYPEOFDEMAND = DemandTypes.ID AND " & _
                        "U.UnitNumber = DR.UnitNumber AND " & _
                        "U.PropertyID IN (" & szSelProperties & ") " & _
                     "ORDER BY DSR.splitid;"
'Debug.Print strSQLTitles
      adoRstDRecords.Open strSQLTitles, adoConn, adOpenDynamic, adLockPessimistic

'      GET N UNDATE THE INVOICE NUMBER
      strSelectedPrintRef = Format(NextRef(adoConn, "PRINT_REF"), "00000000")

      While Not adoRstDRecords.EOF
         If (IsNull(adoRstDRecords.Fields.Item("spare1").Value) Or _
               InStr(adoRstDRecords.Fields.Item("spare1").Value, "NotD") = 0) And _
            IsDmdTypeSel(adoRstDRecords.Fields("TDM").Value) Then
            adoRstDRCurrent.AddNew

            adoRstDRCurrent.Fields("UniqueRefNumber").Value = adoRstDRecords.Fields("D_ID").Value
            adoRstDRCurrent.Fields("Batch").Value = adoRstDRecords.Fields("B_ID").Value
            adoRstDRCurrent.Fields("AutomaticManual").Value = adoRstDRecords.Fields("A_M").Value
            adoRstDRCurrent.Fields("SageAccountNumber").Value = adoRstDRecords.Fields("S_AC").Value
            adoRstDRCurrent.Fields("UnitNumber").Value = adoRstDRecords.Fields("U_NUM").Value
            adoRstDRCurrent.Fields("NominalCodeforAmount").Value = adoRstDRecords.Fields("NCA").Value
            adoRstDRCurrent.Fields("NominalNameforAmount").Value = adoRstDRecords.Fields("NNA").Value
            adoRstDRCurrent.Fields("NominalCodeforVAT").Value = adoRstDRecords.Fields("NCV").Value
            adoRstDRCurrent.Fields("NominalNameforVAT").Value = adoRstDRecords.Fields("NNV").Value
            adoRstDRCurrent.Fields("NominalCodeforTotal").Value = adoRstDRecords.Fields("NCT").Value
            adoRstDRCurrent.Fields("NominalNameforTotal").Value = adoRstDRecords.Fields("NNT").Value
            adoRstDRCurrent.Fields("Source").Value = adoRstDRecords.Fields("SOU").Value
            adoRstDRCurrent.Fields("TransactionType").Value = adoRstDRecords.Fields("T_TYPE").Value
            adoRstDRCurrent.Fields("IssueDate").Value = adoRstDRecords.Fields("IDT").Value
            adoRstDRCurrent.Fields("VATMonth").Value = adoRstDRecords.Fields("VMTH").Value
            adoRstDRCurrent.Fields("Typeofdemand").Value = CInt(adoRstDRecords.Fields("TDM").Value)
            'fixed to Cint from cbyte 27 FEB 2016
            adoRstDRCurrent.Fields("Reference").Value = adoRstDRecords.Fields("SREF").Value
            adoRstDRCurrent.Fields("Description").Value = adoRstDRecords.Fields("DESCR").Value
            adoRstDRCurrent.Fields("PRINT_ID").Value = strSelectedPrintRef
            adoRstDRCurrent.Fields("DemandReportName").Value = adoRstDRecords.Fields("DRN").Value
            adoRstDRCurrent.Fields("DTCategory").Value = adoRstDRecords.Fields("CategoryCode").Value

            If adoRstDRecords.Fields("D_ST").Value Then
               adoRstDRCurrent.Fields("DueDate").Value = adoRstDRecords.Fields("DDT").Value
                rsMinDueDate.Open "Select MIN(DUEDATE) as mindate From DemandSplitRecords DSR where DSR.DEMANDID = " + CStr(CLng(flxDemands.TextMatrix(iRow, 1))) + "", adoConn, adOpenKeyset, adLockReadOnly
                      If Not rsMinDueDate.EOF Then
                            adoRstDRecords.Fields("MinDueDate").Value = rsMinDueDate.Fields("mindate").Value
                      End If
               rsMinDueDate.Close

               adoRstDRCurrent.Fields("TotalAmount").Value = adoRstDRecords.Fields("TAMT").Value
               adoRstDRCurrent.Fields("VATAmount").Value = adoRstDRecords.Fields("VAMT").Value
               adoRstDRCurrent.Fields("Amount").Value = adoRstDRecords.Fields("AMT").Value
               adoRstDRCurrent.Fields("DemandFrom").Value = adoRstDRecords.Fields("D_FROM").Value
               adoRstDRCurrent.Fields("DemandTo").Value = adoRstDRecords.Fields("D_TO").Value
            End If

            adoRstDRCurrent.Update
         End If
         adoRstDRecords.MoveNext
      Wend
      adoRstDRecords.Close
   Next iRow
   adoRstDRCurrent.Close





'****************************************************************************************************************
'PRINT DEMAND INVOICES ACCORDING TO DEMAND TYPE
'   strSQLTitles = "SELECT   tlbDRCurrentPrint.DemandReportName, DemandTypes.CategoryCode " & _
'                  "FROM     tlbDRCurrentPrint, DemandTypes " & _
'                  "WHERE    tlbDRCurrentPrint.TypeOfDemand = DemandTypes.ID " & _
'                  "GROUP BY tlbDRCurrentPrint.DemandReportName, CategoryCode;"
   strSQLTitles = "SELECT   tlbDRCurrentPrint.DemandReportName, tlbDRCurrentPrint.Source " & _
                  "FROM     tlbDRCurrentPrint " & _
                  "GROUP BY tlbDRCurrentPrint.DemandReportName, Source;"
'Debug.Print strSQLTitles
   adoRstDRCurrent.Open strSQLTitles, adoConn, adOpenStatic, adLockReadOnly

   Dim rep As frmReport

   If adoRstDRCurrent.EOF Then
      'Resolved by BOSL. Issue No: 0000481
      'Modified by Asif. 28 Sep 2014 12:32 AM
      
      'MsgBox "No Demand to print.", vbInformation + vbOKOnly, "Demand Printing"
      
      MsgBox "The print demand option is not set for the selected Lessee(s). " & vbNewLine & vbNewLine & "Please tick the print demand check box on the lessee record to print your demands.", vbInformation + vbOKOnly, "Demand Printing"
   End If

   On Error GoTo ERR_REPORT

   While Not adoRstDRCurrent.EOF
'     Passing the from and to date values to Crystal Reports
      Set Report = reportApp.OpenReport(App.Path & szReportPath & "\" & adoRstDRCurrent.Fields.Item("DemandReportName").Value)
      Report.Database.Tables(1).ConnectionProperties.Item("Database Password") = accessDBPws

      Report.EnableParameterPrompting = False
      Report.DiscardSavedData

'      Report.ParameterFields(1).AddCurrentValue CInt(adoRstDRCurrent.Fields("CategoryCode").Value)
      Report.ParameterFields(1).AddCurrentValue CInt(adoRstDRCurrent.Fields("Source").Value)

      Set rep = New frmReport
      Load rep
      rep.LoadReportViewer Report
      adoRstDRCurrent.MoveNext
   Wend
   adoRstDRCurrent.Close
   Set adoRstDRCurrent = Nothing

   If bPrintMarked Then

      szWhere = "("
      For iRow = 1 To flxDemands.Rows - 1
         szWhere = szWhere + CStr(CLng(flxDemands.TextMatrix(iRow, 1))) + ", "
      Next iRow
      szWhere = Left(szWhere, Len(szWhere) - 2) + ")"
      strSQLTitles = "UPDATE DemandRecords " & _
                     "SET IsPrinted = TRUE " & _
                     "WHERE DemandRecords.DEMANDID IN " & szWhere
'Debug.Print strSQLTitles
      adoRstDRecords.Open strSQLTitles, adoConn, adOpenDynamic, adLockPessimistic
   End If

   Set adoRstDRecords = Nothing

   'LoadFlxGrid flxDemands, False, adoConn, ""
    LoadFlxDemands adoConn, ""
   ConfigFlxAddNewDemands
   If chkSelectAllDemands.Value Then chkSelectAllDemands.Value = 0

   DemandPrintUnlock adoConn

   adoConn.Close
   Set adoConn = Nothing

'   fraAllDemandPrint.Visible = False
   tabDmdRcpt.Enabled = True

   MousePointer = vbDefault
   Exit Sub

ERR_REPORT:
   MsgBox "The report name has not been set properly in the demand type form. Please check!", vbCritical + vbOKOnly, "Report Printing"

   Set adoRstDRCurrent = Nothing
   adoConn.Close
   Set adoConn = Nothing
   MousePointer = vbDefault
End Sub

Private Function IsDmdTypeSel(szDemandTypeID As String) As Boolean
   Dim i As Integer, szaTemp() As String

   IsDmdTypeSel = False
   For i = 1 To frmDemandTypesSel.flxDemandTypes.Rows - 1
      If frmDemandTypesSel.flxDemandTypes.TextMatrix(i, 0) = "X" And _
            frmDemandTypesSel.flxDemandTypes.TextMatrix(i, 2) = szDemandTypeID Then
         IsDmdTypeSel = True
         Exit For
      End If
   Next i
End Function

Private Sub cmdSetAmtType_Click()
 

   frmSecondaryCode.PRIMARY_CODE_SHOW = "RAT"
   Load frmSecondaryCode
   frmSecondaryCode.Show 1
   
End Sub
Private Sub loadInvoiceType()
    Dim i As Integer
    flxReceiptType.Clear
    flxReceiptType.Rows = 4
    flxReceiptType.Cols = 3
    flxReceiptType.RowHeight(0) = 0
    flxReceiptType.ColWidth(0) = 120
    flxReceiptType.ColWidth(1) = 900
    flxReceiptType.ColWidth(2) = 1200
    i = 1
   flxReceiptType.TextMatrix(i, 1) = "ALL"
   flxReceiptType.TextMatrix(i, 2) = "ALL"
    i = 2
   flxReceiptType.TextMatrix(i, 1) = "SI"
   flxReceiptType.TextMatrix(i, 2) = "Sales Invoice"
    i = 3
   flxReceiptType.TextMatrix(i, 1) = "SC"
   flxReceiptType.TextMatrix(i, 2) = "Credit Notes"
End Sub
Private Sub loadReceiptType(szValue As String, adoConn As ADODB.Connection)
    Dim SQLStr1 As String, i As Integer
    Dim adoRST As New ADODB.Recordset
    flxReceiptType.Clear
    flxReceiptType.Rows = 2
    flxReceiptType.Cols = 3
    flxReceiptType.RowHeight(0) = 0
    flxReceiptType.ColWidth(0) = 120
    flxReceiptType.ColWidth(1) = 900
    flxReceiptType.ColWidth(2) = 1200
  
    SQLStr1 = "SELECT SecondaryCode.Code as C, SecondaryCode.Value as V " & _
           "FROM PrimaryCode, SecondaryCode " & _
           "WHERE PrimaryCode.Value = '" & szValue & "' AND " & _
                "PrimaryCode.CODE = SecondaryCode.PrimaryCode " & _
           "ORDER BY SecondaryCode.Value;"
    
    adoRST.Open SQLStr1, adoConn, adOpenStatic, adLockReadOnly
    
    If adoRST.EOF Then
        adoRST.Close
        Set adoRST = Nothing
        Exit Sub
    End If
    flxReceiptType.Rows = adoRST.RecordCount + 1
    i = 1
    While Not adoRST.EOF
        flxReceiptType.TextMatrix(i, 1) = adoRST!c
        flxReceiptType.TextMatrix(i, 2) = adoRST!V
        adoRST.MoveNext
        i = i + 1
    Wend
    adoRST.Close
    Set adoRST = Nothing

End Sub

Private Sub cmdTenantLookup_Click()
'   If cmbBankAc.text = "" Then
'      MsgBox "Please select the client's bank account", vbCritical + vbOKOnly, "Receipt - Bank Account missing"
'      cmbBankAc.Enabled = True
'      cmbBankAc.SetFocus
'      Exit Sub
'   End If

   'Me.MousePointer = vbHourglass
'added by anol 20160518
   tabPayment.Enabled = False
   tabDmdRcpt.Enabled = False
   'end of addition
   Dim adoConn As New ADODB.Connection
   

   adoConn.Open getConnectionString

   strCommandSource = "Lease"

   ConfigFlxLeaseList
   If txtRptClientList.text = "ALL" And txtRptPropertyList.text = "ALL" And Not chkLl.Value Then
      If chkExlessee.Value Then
         szTenantsSQL = "SELECT Tenants.SageAccountNumber, Name, LeaseDetails.UnitNumber,Property.ClientID,Property.PropertyID " & _
                 "From Tenants, LeaseDetails, Units, Property  " & _
                 "WHERE ((Tenants.Comments) IS NULL OR Tenants.Comments='') AND " & _
                 "Units.PropertyID = Property.PropertyID AND " & _
                 "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
                 "Tenants.SageAccountNumber = LeaseDetails.SageAccountNumber " & _
                 "ORDER BY Tenants.SageAccountNumber;"
      Else
         szTenantsSQL = "SELECT Tenants.SageAccountNumber, Name, LeaseDetails.UnitNumber,Property.ClientID,Property.PropertyID  " & _
                 "From Tenants, LeaseDetails, Units, Property  " & _
                 "WHERE ((Tenants.Comments) IS NULL OR Tenants.Comments='') AND " & _
                 "Tenants.SageAccountNumber = LeaseDetails.SageAccountNumber AND " & _
                 "Units.PropertyID = Property.PropertyID AND " & _
                 "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
                 "LeaseDetails.Status = True " & _
                 "ORDER BY Tenants.SageAccountNumber;"
      End If
   End If

   If txtRptClientList.text <> "ALL" And txtRptPropertyList.text = "ALL" And Not chkLl.Value Then
      If chkExlessee.Value Then
         szTenantsSQL = "SELECT Tenants.SageAccountNumber, Name, LeaseDetails.UnitNumber,Property.ClientID,Property.PropertyID " & _
                 "From Tenants, LeaseDetails, Units, Property " & _
                 "WHERE ((Tenants.Comments) IS NULL OR Tenants.Comments='') AND " & _
                  "Tenants.SageAccountNumber = LeaseDetails.SageAccountNumber AND " & _
                  "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
                  "Units.PropertyID = Property.PropertyID AND " & _
                  "Property.ClientID = '" & txtRptClientList.text & "' " & _
                "ORDER BY Tenants.SageAccountNumber;"
      Else
         szTenantsSQL = "SELECT Tenants.SageAccountNumber, Name, LeaseDetails.UnitNumber,Property.ClientID,Property.PropertyID " & _
                 "From Tenants, LeaseDetails, Units, Property " & _
                 "WHERE ((Tenants.Comments) IS NULL OR Tenants.Comments='') AND " & _
                  "Tenants.SageAccountNumber = LeaseDetails.SageAccountNumber AND " & _
                  "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
                  "LeaseDetails.Status = True AND " & _
                  "Units.PropertyID = Property.PropertyID AND " & _
                  "Property.ClientID = '" & txtRptClientList.text & "' " & _
                "ORDER BY Tenants.SageAccountNumber;"
      End If
   End If

   If txtRptClientList.text = "ALL" And txtRptPropertyList.text <> "ALL" And Not chkLl.Value Then
      If chkExlessee.Value Then
         szTenantsSQL = "SELECT Tenants.SageAccountNumber, Name, LeaseDetails.UnitNumber,Property.ClientID,Property.PropertyID " & _
                 "From Tenants, LeaseDetails, Units , Property " & _
                 "WHERE ((Tenants.Comments) IS NULL OR Tenants.Comments='') AND " & _
                 "Tenants.SageAccountNumber = LeaseDetails.SageAccountNumber AND " & _
                 "Units.PropertyID = Property.PropertyID AND " & _
                 "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
                 "Units.PropertyID = '" & txtRptPropertyList.text & "' " & _
                 "ORDER BY Tenants.SageAccountNumber;"
      Else
         szTenantsSQL = "SELECT Tenants.SageAccountNumber, Name, LeaseDetails.UnitNumber,Property.ClientID,Property.PropertyID  " & _
                 "From Tenants, LeaseDetails, Units , Property " & _
                 "WHERE ((Tenants.Comments) IS NULL OR Tenants.Comments='') AND " & _
                 "Tenants.SageAccountNumber = LeaseDetails.SageAccountNumber AND " & _
                 "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
                 "Units.PropertyID = Property.PropertyID AND " & _
                 "LeaseDetails.Status = True AND " & _
                 "Units.PropertyID = '" & txtRptPropertyList.text & "' " & _
                 "ORDER BY Tenants.SageAccountNumber;"
      End If
   End If

   If txtRptClientList.text <> "ALL" And txtRptPropertyList.text <> "ALL" And Not chkLl.Value Then
      If chkExlessee.Value Then
         szTenantsSQL = "SELECT Tenants.SageAccountNumber, Name, LeaseDetails.UnitNumber,Property.ClientID,Property.PropertyID " & _
                 "From Tenants, LeaseDetails, Units, Property " & _
                 "WHERE ((Tenants.Comments) IS NULL OR Tenants.Comments='') AND " & _
                  "Tenants.SageAccountNumber = LeaseDetails.SageAccountNumber AND " & _
                  "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
                  "Units.PropertyID = Property.PropertyID AND " & _
                  "Property.ClientID = '" & txtRptClientList.text & "' AND " & _
                  "Units.PropertyID = '" & txtRptPropertyList.text & "' " & _
                "ORDER BY Tenants.SageAccountNumber;"
      Else
         szTenantsSQL = "SELECT Tenants.SageAccountNumber, Name, LeaseDetails.UnitNumber,Property.ClientID,Property.PropertyID " & _
                 "From Tenants, LeaseDetails, Units, Property " & _
                 "WHERE ((Tenants.Comments) IS NULL OR Tenants.Comments='') AND " & _
                  "Tenants.SageAccountNumber = LeaseDetails.SageAccountNumber AND " & _
                  "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
                  "LeaseDetails.Status = True AND " & _
                  "Units.PropertyID = Property.PropertyID AND " & _
                  "Property.ClientID = '" & txtRptClientList.text & "' AND " & _
                  "Units.PropertyID = '" & txtRptPropertyList.text & "' " & _
                "ORDER BY Tenants.SageAccountNumber;"
      End If
   End If

   If chkLl.Value Then
      szTenantsSQL = "SELECT DISTINCT L.LandlordID, L.LandlordName, 'LANDLORD' " & _
              "FROM tlbReceipt AS R, Landlord AS L " & _
              "WHERE R.SageAccountNumber = L.LandlordID AND " & _
                  "ROUND(R.OSAmount, 2) > 0 " & _
              "ORDER BY L.LandlordID;"
'Debug.Print szTenantsSQL
   End If

   PopulateTenantLookup adoConn, szTenantsSQL
   If frmMMain.frmDemand3_LesseList_isUptoDate = False Then
        '  Load all tenants with balance in gridTenantLookup
        TenantAccountBalance adoConn
        frmMMain.frmDemand3_LesseList_isUptoDate = True
   End If
   'TenantAccountBalance adoConn
   UpdateBalance
   'added by anol
   
'   UpdateBalance2 'for flxDmdLeaseList

   adoConn.Close
   Set adoConn = Nothing

   txtTenantSearchID.text = ""
   txtTenantSearchName.text = ""
   txtTenantSearchUnitName.text = ""
   picLeaseList.Top = tabDmdRcpt.Top + tabPayment.Top + Frame5(5).Top + txtTenantID.Top + 5
   picLeaseList.Left = tabDmdRcpt.Left + tabPayment.Left + Frame5(5).Left + txtTenantID.Left + 5
   picLeaseList.Visible = True
   picLeaseList.ZOrder 0
   If flxLeaseList.Rows > 1 And flxLeaseList.row = 0 Then
        flxLeaseList.row = 1
   End If
   txtTenantSearchID.SetFocus
   chkExlessee.Enabled = False

'  Me.MousePointer = vbArrow
End Sub

'  Get all lessees' Account History in an array
Private Sub TenantAccountBalance(adoConn As ADODB.Connection)
   On Error GoTo Err
   Dim szSQL As String, i As Integer, iIndex As Integer
   Dim adoRptDr As New ADODB.Recordset, adoRptCr As New ADODB.Recordset

   szSQL = "SELECT COUNT(SageAccountNumber) AS X " & _
           "From " & _
            "(" & _
             "SELECT tlbReceipt.SageAccountNumber  " & _
             "From tlbReceipt " & _
             "GROUP BY tlbReceipt.SageAccountNumber" & _
            ");"
   adoRptDr.Open szSQL, adoConn, adOpenStatic, adLockReadOnly

   If adoRptDr.EOF Then
      adoRptDr.Close
      Set adoRptDr = Nothing
      Exit Sub
   End If

   ReDim szaTenantBalance(1, adoRptDr.Fields.Item(0).Value) As String
   adoRptDr.Close

   szSQL = "SELECT SageAccountNumber, SUM(Amount) AS Dr " & _
           "FROM tlbReceipt AS Rpt " & _
           "WHERE Type = 1 OR Type = 23 " & _
           "GROUP BY SageAccountNumber;"

   adoRptDr.Open szSQL, adoConn, adOpenStatic, adLockReadOnly

   iIndex = 0
   While Not adoRptDr.EOF
      szaTenantBalance(0, iIndex) = adoRptDr.Fields.Item("SageAccountNumber").Value
      szaTenantBalance(1, iIndex) = adoRptDr.Fields.Item("Dr").Value
      iIndex = iIndex + 1
      adoRptDr.MoveNext
   Wend

   adoRptDr.Close

   szSQL = "SELECT SageAccountNumber, SUM(Amount) AS Cr " & _
           "FROM tlbReceipt AS Rpt " & _
           "WHERE Type <> 1 AND Type <> 23 AND NOT ISNULL(SageAccountNumber)  " & _
           "GROUP BY SageAccountNumber;"

   adoRptCr.Open szSQL, adoConn, adOpenStatic, adLockReadOnly

   While Not adoRptCr.EOF
      For i = 0 To iIndex - 1
'        If i = 853 And adoRptCr.Fields.Item("SageAccountNumber").Value = "STGID11B" Then
'            Debug.Print ""
'        End If
         If szaTenantBalance(0, i) = adoRptCr.Fields.Item("SageAccountNumber").Value Then
            Exit For
         End If
      Next i
      If i < iIndex Then
         szaTenantBalance(1, i) = szaTenantBalance(1, i) - Val(adoRptCr.Fields.Item("Cr").Value)
      Else
         iIndex = iIndex + 1
         szaTenantBalance(0, iIndex) = adoRptCr.Fields.Item("Cr").Value
      End If
      adoRptCr.MoveNext
   Wend
Err:
   adoRptCr.Close

   Set adoRptDr = Nothing
   Set adoRptCr = Nothing
End Sub

Private Sub UpdateBalance() '  for flxLeaseList

   On Error GoTo Err
   Dim i As Integer, j As Integer

   For i = 1 To flxLeaseList.Rows - 1
      For j = 0 To UBound(szaTenantBalance, 2) - 1
         If flxLeaseList.TextMatrix(i, 1) = szaTenantBalance(0, j) Then
            'flxLeaseList.TextMatrix(i, 4) = Format(szaTenantBalance(1, j), "0.00")
            flxLeaseList.TextMatrix(i, 4) = RoundingNumber2(szaTenantBalance(1, j))
            Exit For
         End If
      Next j
      If j = UBound(szaTenantBalance, 2) Then flxLeaseList.TextMatrix(i, 4) = "0.00"
   Next i
   Exit Sub
Err:
End Sub
Private Sub UpdateBalance2() '  for flxDmdLeaseList
   On Error GoTo Err
   Dim i As Integer, j As Integer

   For i = 1 To flxDmdLeaseList.Rows - 1
      For j = 0 To UBound(szaTenantBalance, 2) - 1
         If flxDmdLeaseList.TextMatrix(i, 1) = szaTenantBalance(0, j) Then
            'flxDmdLeaseList.TextMatrix(i, 4) = Format(szaTenantBalance(1, j), "0.00")
            flxDmdLeaseList.TextMatrix(i, 4) = RoundingNumber2(szaTenantBalance(1, j))
            Exit For
         End If
      Next j
      If j = UBound(szaTenantBalance, 2) Then flxDmdLeaseList.TextMatrix(i, 4) = "0.00"
   Next i
    Exit Sub
Err:
End Sub

Public Function PopulateTenantLookup(adoConn As ADODB.Connection, ByVal sSQLQuery_ As String)
   Dim adoRST As New ADODB.Recordset

   adoRST.Open sSQLQuery_, adoConn, adOpenStatic, adLockReadOnly

   Dim iRow As Integer
      iRow = 1
      If tabDmdRcpt.Tab <> 2 Or tabPayment.Tab <> 0 Then
        flxLeaseList.TextMatrix(iRow, 1) = "All Lessees" 'adoRst.Fields.Item(0).Value
        flxLeaseList.TextMatrix(iRow, 2) = "All Lessees" 'adoRst.Fields.Item(1).Value
        flxLeaseList.TextMatrix(iRow, 3) = "" ' adoRst.Fields.Item(2).Value
        iRow = 2
        flxLeaseList.AddItem ""
       End If
      'flxLeaseList.AddItem ""
     
      'iRow = 2
   While Not adoRST.EOF
      flxLeaseList.TextMatrix(iRow, 1) = adoRST.Fields.Item(0).Value
      flxLeaseList.TextMatrix(iRow, 2) = adoRST.Fields.Item(1).Value
      flxLeaseList.TextMatrix(iRow, 3) = adoRST.Fields.Item(2).Value
      If tabDmdRcpt.Tab = 2 And tabPayment.Tab = 0 Then
            flxLeaseList.TextMatrix(iRow, 5) = adoRST.Fields.Item(3).Value
            flxLeaseList.TextMatrix(iRow, 6) = adoRST.Fields.Item(4).Value
      End If
      iRow = iRow + 1
      adoRST.MoveNext

      If Not adoRST.EOF Then flxLeaseList.AddItem ""
   Wend
   adoRST.Close
   Set adoRST = Nothing
End Function

Public Function PopulateDmdTenantLookup(adoConn As ADODB.Connection, ByVal sSQLQuery_ As String)
   Dim adoRST As New ADODB.Recordset
'Debug.Print sSQLQuery_
   adoRST.Open sSQLQuery_, adoConn, adOpenStatic, adLockReadOnly

   Dim iRow As Integer
   iRow = 1

   If Not chkCL.Value Then
      While Not adoRST.EOF
         flxDmdLeaseList.TextMatrix(iRow, 1) = adoRST!SageAccountNumber
         flxDmdLeaseList.TextMatrix(iRow, 2) = adoRST!Name
         flxDmdLeaseList.TextMatrix(iRow, 3) = adoRST!UnitNumber
         flxDmdLeaseList.TextMatrix(iRow, 4) = IIf(adoRST.Fields.Item(3).Value, "LL", "EL")
         flxDmdLeaseList.RowHeight(iRow) = 280
         iRow = iRow + 1
         adoRST.MoveNext

         If Not adoRST.EOF Then flxDmdLeaseList.AddItem ""
      Wend
   End If
   If chkCL.Value Then 'Landlord/MA only
      While Not adoRST.EOF
         flxDmdLeaseList.TextMatrix(iRow, 1) = adoRST.Fields.Item(0).Value
         flxDmdLeaseList.TextMatrix(iRow, 2) = adoRST.Fields.Item(1).Value
         flxDmdLeaseList.TextMatrix(iRow, 3) = adoRST.Fields.Item(2).Value
         flxDmdLeaseList.RowHeight(iRow) = 280
         iRow = iRow + 1
         adoRST.MoveNext

         If Not adoRST.EOF Then flxDmdLeaseList.AddItem ""
      Wend
   End If

   adoRST.Close
   Set adoRST = Nothing
End Function

Private Sub ConfigFlxLeaseList()
   Dim szHeader As String

   picLeaseList.Width = 6855
   flxLeaseList.Width = 6735
   Label20(0).Caption = "Lessee Id"
   Label20(1).Caption = "Lessee Name"
   Label20(0).Width = 690
   Label20(0).Left = 120
   Label20(1).Width = 930
   Label20(1).Left = 1560
   Label20(2).Visible = True
   txtTenantSearchUnitName.Visible = True
   Shape4(6).Width = 6480
   cmdGridUnitLookup.Left = 6555

   flxLeaseList.Clear
   flxLeaseList.Cols = 7
   flxLeaseList.RowHeight(0) = 0
   szHeader$ = "|<Lessee ID|<Lessee Name|<Lessee Name|>Ac Balance"
   flxLeaseList.FormatString = szHeader$
   flxLeaseList.ColWidth(0) = Label20(0).Left - flxLeaseList.Left   '240        Solid column
   flxLeaseList.ColWidth(1) = Label20(1).Left - Label20(0).Left - 20  '1400       'Tenant ID
   flxLeaseList.ColWidth(2) = Label20(2).Left - Label20(1).Left - 20         'Tenant Name
   flxLeaseList.ColWidth(3) = Label20(10).Left - Label20(2).Left - 20         'Unit Name
   flxLeaseList.ColWidth(4) = flxLeaseList.Left + flxLeaseList.Width - Label20(10).Left - 300 'Ac Balance
   flxLeaseList.ColWidth(5) = 0
   flxLeaseList.ColWidth(6) = 0
   flxLeaseList.Rows = 2
End Sub

Private Sub ConfigureDmdFlxLeaseList()
   Dim szHeader As String

   flxDmdLeaseList.Clear
   flxDmdLeaseList.Cols = 6
   flxDmdLeaseList.RowHeight(0) = 0
   szHeader$ = "|<Lessee ID|<Lessee Name|<Unit ID|<ExpLes"
   flxDmdLeaseList.FormatString = szHeader$
   flxDmdLeaseList.ColWidth(0) = Label20(9).Left - flxDmdLeaseList.Left   '240        Solid column
   flxDmdLeaseList.ColWidth(1) = Label20(8).Left - Label20(9).Left - 20   '1400       'Tenant ID
   flxDmdLeaseList.ColWidth(2) = Label20(7).Left - Label20(8).Left - 20               'Tenant Name
   flxDmdLeaseList.ColWidth(3) = Label20(11).Left - Label20(7).Left 'flxDmdLeaseList.Left + flxDmdLeaseList.Width - Label20(7).Left - 300 'Unit Name
   flxDmdLeaseList.ColWidth(4) = 1200
   flxDmdLeaseList.ColAlignment(4) = vbRightJustify
   flxDmdLeaseList.ColWidth(5) = 0
   flxDmdLeaseList.Rows = 2

   If chkCL.Value Then
      Label20(7).Visible = False
      txtDmdTenantSearchUnitName.Visible = False
   Else
      Label20(7).Visible = True
      txtDmdTenantSearchUnitName.Visible = True
   End If
End Sub

Private Function LoadVatOption(Conn As ADODB.Connection) As Integer
    Dim rsGlobalData As New ADODB.Recordset
    rsGlobalData.Open "Select vatOptionEnabled from Globaldata where PropertyID='" & txtDmdPropertyList.text & "'", Conn, adOpenStatic, adLockReadOnly
    If Not rsGlobalData.EOF Then
            LoadVatOption = IIf(IsNull(rsGlobalData("vatOptionEnabled").Value), 0, rsGlobalData("vatOptionEnabled").Value)
    End If
    rsGlobalData.Close
    Set rsGlobalData = Nothing
End Function
Private Sub cmdaddnewline_Click()
        'Issue 571 Validation
        'Added by anol 17 May 2015
         If txtDmdClientList.text = "" Or txtDmdClientList.text = "ALL" Then
           MsgBox "Please select a client.", vbCritical + vbOKOnly, "Lessee Selection"
           FocusControl cmdDmdClientList
           Exit Sub
        End If
        If Trim(txtDmdPropertyList.text) = "" Or txtDmdPropertyList.text = "ALL" Then
           MsgBox "You must select the property.", vbCritical + vbOKOnly, "Lessee Selection"
           cmdDmdPropertyList.SetFocus
           Exit Sub
        End If
        '   If Trim(txtDmdPropertyList.text) = "" Then
        '            If MsgBox("You have not selected a property. Do you wish to add a property?", vbYesNo, "Select a Property") = vbYes Then
        '                cmdDmdPropertyList.SetFocus
        '                Exit Sub
        '            End If
        '   End If
        If txtTenantName.text = "" Then
           MsgBox "Please select the Lessee.", vbCritical + vbOKOnly, "Lessee Selection"
           cmdDmdTenantLookup.SetFocus
           Exit Sub
        End If
        
        If txtIssueDate.text = "" Then
           MsgBox "Please type issue date.", vbCritical + vbOKOnly, "Issue Date"
           txtIssueDate_Click
           Exit Sub
        End If
        Dim adoConn As New ADODB.Connection
        adoConn.Open getConnectionString
        vatOptionEnabled = LoadVatOption(adoConn)
        adoConn.Close
        Set adoConn = Nothing
        'Modified by BOSL
        'issue 468
        'Modified by anol 01 Sep 2014
    If frmMMain.IsRibbonVersion And lblPostingDate.ToolTipText <> "" Then
        Dim szSQL As String
        If txtDmdClientList.text = "" Then
            ShowMsgInTaskBar "Please select a client", "Y"
            cmdDmdClientList.SetFocus
            Exit Sub
        End If
        adoConn.Open getConnectionString
        If IsPeriodStatus(lblPostingDate.ToolTipText, txtDmdClientList.text, adoConn) = 0 Then
            ShowMsgInTaskBar "The posting date cannot fall within a closed financial period", "Y", "P"
            adoConn.Close
            Set adoConn = Nothing
            If txtIssueDate.Enabled = True Then
            txtIssueDate.SetFocus
        End If
        Exit Sub
        ElseIf IsPeriodStatus(lblPostingDate.ToolTipText, txtDmdClientList.text, adoConn) = 9 Then
            ShowMsgInTaskBar "The posting date does not fall in any existing financial period", "Y", "P"
            adoConn.Close
            Set adoConn = Nothing
            If txtIssueDate.Enabled = True Then
                txtIssueDate.SetFocus
            End If
            Exit Sub
        End If
        adoConn.Close
        Set adoConn = Nothing
    End If
        'End of modification
    If txtAmount.text = "" Then ' 'you need not clear the tag of tax code
            txtVAT.text = ""
            txtTotal.text = ""
    End If
    ComponenetAddNewLine EnableMode
   ' FraTopAddNewLine.Enabled = False
    txtTenantName.Locked = True
    txtIssueDate.Locked = True
    bAddNew = True
    If txtAmount.text = "" Then
        txtVAT.text = ""
        txtTotal.text = ""
    End If
        adoConn.Open getConnectionString
        Dim rstRec As New ADODB.Recordset
        vatOptionEnabled = LoadVatOption(adoConn)
        
        szSQL = "SELECT P.PropertyID, P.PropertyName,G.VATRate,V.VAT_Rate as RateValue,V.VAT_CODE as VAT_CODE1,G.VATRate  as  Rate,G.vatOptionEnabled " & _
                            " from ((Property P INNER JOIN globalData G ON P.PropertyID=G.PropertyID) LEFT JOIN tlbVatCode V ON G.VATRate=V.VAT_ID) " & _
                            "WHERE P.PropertyID = '" & txtDmdPropertyList.text & "' " & _
                            "ORDER BY P.PropertyID;"
       rstRec.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
           
        If vatOptionEnabled = True Then
            Label1(24).Caption = IIf(IsNull(rstRec.Fields("VAT_CODE1").Value), "", rstRec.Fields("VAT_CODE1").Value) 'Vat_Code
            Label1(24).Tag = IIf(IsNull(rstRec.Fields("Rate").Value), "", rstRec.Fields("Rate").Value) 'VAT_ID
            nTaxCode = Val(IIf(IsNull(rstRec.Fields("RateValue").Value), "0", rstRec.Fields("RateValue").Value))
            txtVAT.text = Format(Val(txtAmount.text) * (Val(IIf(IsNull(rstRec.Fields("RateValue").Value), "0", rstRec.Fields("RateValue").Value)) / 100), "0.00")
            cmdVATCode.Enabled = True
            txtVAT.Enabled = True
        Else
            txtVAT.text = "0.00"
            Label1(24).Tag = ""
            Label1(24).Caption = ""
            cmdVATCode.Enabled = False
            txtVAT.Enabled = False
        End If
        rstRec.Close
        adoConn.Close
       FocusControl cmdType
End Sub

Private Sub SumUpDrCr()
   Dim i As Integer

   dDrOS = 0
   dCrOS = 0
   dCrOS_Adj = 0
   dDrOS_Adj = 0

   For i = 1 To flxSPayment.Rows - 1
      If (flxSPayment.TextMatrix(i, 2) = "ADJC") Then
         If flxSPayment.TextMatrix(i, 0) <> "-" Then
            dDrOS_Adj = dDrOS_Adj + Val(flxSPayment.TextMatrix(i, 9))
         End If
      Else
         If flxSPayment.TextMatrix(i, 0) <> "-" Then
            dDrOS = dDrOS + Val(flxSPayment.TextMatrix(i, 9))
         End If
      End If
   Next i
   dDrOS = dDrOS + dDrOS_Adj
   For i = 1 To flxCrPoA.Rows - 1
      If (flxCrPoA.TextMatrix(i, 1) = "ADJC") Then
         If flxCrPoA.TextMatrix(i, 0) <> "-" Then
            dCrOS_Adj = dCrOS_Adj + Val(flxCrPoA.TextMatrix(i, 9))
         End If
      Else
         If flxCrPoA.TextMatrix(i, 0) <> "-" Then
            dCrOS = dCrOS + Val(flxCrPoA.TextMatrix(i, 8))
         End If
      End If
   Next i
   dCrOS = dCrOS + dCrOS_Adj
End Sub

Private Sub cmdAllocate_Click()
    If bToggleAllocationView = False Then
          bToggleAllocationView = True
'          Label19(8).Visible = True
'          txtAllocationDAte.Visible = True
    Else
          bToggleAllocationView = False
'           Label19(8).Visible = False
'           txtAllocationDAte.Visible = False
    End If
    If bToggleAllocationView = False Then 'If cmdAllocate.Caption = "&Receipt Only" Then          'Receipt Only
      If cmdAllocateSave.Enabled Then
         If MsgBox("Do like to cancel the allocation?", vbYesNo + vbQuestion, "Allocation") = vbNo Then
            cmdAllocateSave.SetFocus
            Exit Sub
         End If
         chkSettleAll.Visible = True
         Frame4(1).Visible = False
         tabDmdRcpt.Enabled = True
         tabPayment.Enabled = True

         cmdAllocateSave.Enabled = False
         cmdAutomatic.Enabled = True
      End If
      cmeRevereseAllocation.Visible = True

      flxSPayment.Enabled = True
      flxCrPoA.Enabled = True
      txtArray(4).text = "0.00"

      Dim adoConn As New ADODB.Connection

      Frame5(0).Visible = True
      Frame5(0).Enabled = True
      Frame5(4).Visible = False
      cmdAllocate.Caption = "All&ocation Only"
      Label3(1).Visible = False
      txtArray(4).Visible = False
      Label3(2).Visible = False
      Frame5(5).Enabled = True
      lblAllocating.Visible = False

      adoConn.Open getConnectionString

      ConfigFlxCrPoA
      'Unlock previous locked item
      adoConn.Execute "Update tlbReceipt Set  DateTimeStamp='',Module='',UserSessionID='',WindowsUserName='',MachineName=''," & _
                   "PrestigeUserName='',ServerIPaddress='' where UserSessionID='" & UserSessionID & "'"
                   
      ConfigFlxSPayment
      flxSPayment.Clear
      flxSPayment.Rows = 2
      flxCrPoA.Clear
      flxCrPoA.Rows = 2
      LoadFlxSPayment adoConn
      LoadFlxCrPoA adoConn

      adoConn.Close
      Set adoConn = Nothing
   End If
   If Val(txtSPaymentTotal.text) < 0 Then Exit Sub
   If txtTenantID.text = "" Then Exit Sub
   If flxCrPoA.Rows = 0 Then Exit Sub
   If flxSPayment.TextMatrix(1, 1) = "" Then Exit Sub
'   If txtBankAc.text = "" Then
'    'Added by anol 20180327 issue 560
'      cmdBankAc.Enabled = True
'      MsgBox "Please select a bank account.", vbCritical + vbOKOnly, "Please select a bank account."
'      FocusControl cmdBankAc
'      Exit Sub
'   End If
    chkApplyFund.Value = False
   
'We need to do this validation when we save no need to do it here anol 20210401
'Call SumUpDrCr
'   If dDrOS = 0 Or dCrOS = 0 Then
'      MsgBox "There are no transactions to allocate.", vbCritical + vbOKOnly, "Allocation Warning"
'      Exit Sub
'   End If

   cmdEditReceipt.Enabled = False

   Dim iRow As Integer

   If bToggleAllocationView = True Then  'If cmdAllocate.Caption = "All&ocation Only" Then                   'Allocation Only
'      added by anol 20170118 sattle all feature is not for allocation
      chkSettleAll.Value = 0
      chkSettleAll.Visible = False
      
      cmeRevereseAllocation.Visible = False
      Frame5(0).Visible = False
      Frame5(4).Left = Frame5(0).Left
      Frame5(4).Top = Frame5(0).Top
      Frame5(4).Visible = True
      cmdAllocate.Caption = "&Receipt Only"
      Label3(1).Visible = True
      txtArray(4).Visible = True
      Label3(2).Visible = True
      Frame5(5).Enabled = False
      cmdBankAc.Enabled = True

      cTotalAdjI = 0
      cTotalSI = 0

      For iRow = 1 To flxSPayment.Rows - 1
         If (flxSPayment.TextMatrix(iRow, 0) <> "-") Then
            If (flxSPayment.TextMatrix(iRow, 2) = "AdjI") Then
               cTotalAdjI = cTotalAdjI + CCur(flxSPayment.TextMatrix(iRow, 9))
            Else
               txtSPaymentTotal.text = Format(Val(txtSPaymentTotal.text) - Val(flxSPayment.TextMatrix(iRow, 10)), "0.00")
               flxSPayment.TextMatrix(iRow, 10) = "0.00"
               cTotalSI = cTotalSI + CCur(flxSPayment.TextMatrix(iRow, 9))
            End If
         End If
      Next iRow

      Frame5(4).Enabled = True
      flxCrPoA.Enabled = True
   
   End If
End Sub
Private Sub LoadGridsOnReceipt()
'written by anol 20170215
'issue 306
'1\ The allocation process needs to be modified so that when the user does an allocation, and saves it,
'the allocation screen remains open and the user can make the next allocation.
        tabDmdRcpt.Enabled = True
        tabPayment.Enabled = True
   If strCommandSource = "Lease" Then
          Dim adoConn As New ADODB.Connection
          adoConn.Open getConnectionString
          flxSPayment.Clear
          flxSPayment.Rows = 2
          flxCrPoA.Clear
          flxCrPoA.Rows = 2
'          chkApplyFund.Value = False
          If Not CheckSavedBtRpt(adoConn) Then
          'Unlock previous locked item
            adoConn.Execute "Update tlbReceipt Set  DateTimeStamp='',Module='',UserSessionID='',WindowsUserName='',MachineName=''," & _
                   "PrestigeUserName='',ServerIPaddress='' where UserSessionID='" & UserSessionID & "'"
             LoadFlxSPayment adoConn
             LoadFlxCrPoA adoConn
          Else
             MsgBox "This lessee is locked by Batch Receipt." & Chr(13) & _
                    "Please clear down batch receipts to book manual receipt.", vbExclamation + vbOKOnly, "Batch Receipt"
             adoConn.Close
             Set adoConn = Nothing
             Exit Sub
          End If
    
          txtTntAcBal.text = Format(AccountBalance(adoConn), "0.00")
          If Val(txtTntAcBal.text) >= 0 Then
             txtTntAcBal.ForeColor = vbBlack
          Else
             txtTntAcBal.ForeColor = vbRed
          End If
    
          adoConn.Close
          Set adoConn = Nothing
    
          ReDim baChangesMade(flxSPayment.Rows) As Boolean
    
          Frame5(0).Enabled = True
          txtReceiptEntered.text = "0.00"
          txtSPaymentTotal.text = "0.00"
          lblAllocating.Caption = ""
'         txtReceiptReference.SetFocus
   End If
End Sub
Private Sub cmdAllocateSave_Click()
'   If MsgBox("Do you wish to save allocations?", vbQuestion + vbYesNo, "Allocation") = vbNo Then Exit Sub
   Dim adoConn  As New ADODB.Connection
   If txtAllocationDAte.text = "" Then
        MsgBox "Please enter allocation date", vbInformation, "Enter allocation date."
        FocusControl txtAllocationDAte
   End If
   adoConn.Open getConnectionString
   If chkSettleAll.Value = 0 Then
        
      adoConn.BeginTrans
      cmdAllocateSave.Enabled = False
      If SavingAllocationS(adoConn) = False Then
            adoConn.RollbackTrans
            MsgBox "Saving of Allocations has failed!! Please contact with the PCM consulting Ltd."
           ' Frame5(4).Enabled = False
            Exit Sub
       Else
'            ConfigFlxCrPoA
'            ConfigFlxSPayment
'            txtTenantID.text = ""
'            cmbBankAc.text = ""
            
            txtReceiptEntered.text = "0.00"
            txtSPaymentTotal.text = "0.00"
            
            flxCrPoA.Enabled = True
'            ReDim baChangesMade(flxSPayment.Rows) As Boolean
            adoConn.CommitTrans
            'added by anol 20170215 issue issue 306
            '1\ The allocation process needs to be modified so that when the user does an allocation, and saves it,
            'the allocation screen remains open and the user can make the next allocation.
            Call LoadGridsOnReceipt
            'thi statement has beem moved here by nol 20170801
            ReDim baChangesMade(flxSPayment.Rows) As Boolean
            MsgBox "Allocations have been saved successfully.", vbInformation, "Saved"
       End If
       adoConn.Close
   Else
      
      adoConn.BeginTrans
      cmdAllocateSave.Enabled = False
      If SettleAllCrAllocation(adoConn) = True Then
            adoConn.RollbackTrans
            MsgBox "Saving of Allocations has failed!! Please contact with the PCM consulting Ltd."
            Frame5(4).Enabled = False
            Exit Sub
       Else
            ConfigFlxCrPoA
            ConfigFlxSPayment
            txtTenantID.text = ""
            cmdBankAc.text = ""
            txtReceiptEntered.text = "0.00"
            txtSPaymentTotal.text = "0.00"
            
            flxCrPoA.Enabled = True
            ReDim baChangesMade(flxSPayment.Rows) As Boolean
            adoConn.CommitTrans
            ShowMsgInTaskBar "Allocations have been saved successfully."
       End If
       adoConn.Close
   End If

   
  cmdAllocateSave.Enabled = False ' do not enable it here. this willl be enabled when you settle 1 receipt automatically
  cmdAutomatic.Enabled = True
  'But if there is no invoice or receipt to allocate then The screen should come to normal mode
  'added by anol 20170310
  If flxCrPoA.TextMatrix(1, 1) = "" Or flxSPayment.TextMatrix(1, 1) = "" Then
        cmdAllocate.Caption = "All&ocation Only"
        bToggleAllocationView = False
        Label3(1).Visible = False
        txtArray(4).Visible = False
        Label3(2).Visible = False
        lblAllocating.Visible = False
        flxSPayment.Enabled = True
        flxCrPoA.Enabled = True
        lblAllocating.Visible = False
        Frame5(0).Enabled = True                     'Receipt - Saving
        Frame5(4).Enabled = False                    'Allocation - Saving
        Frame5(4).Visible = False
        Frame5(5).Enabled = True
        Frame5(0).Visible = True
        txtArray(4).text = "0.00"
        cmdAutomatic.Enabled = True
        cmeRevereseAllocation.Visible = True
  End If

End Sub

Private Function SavingAllocationS(adoConn As ADODB.Connection) As Boolean
   Dim rsInvoice As New ADODB.Recordset
   Dim rstTrans  As New ADODB.Recordset
   Dim rstSplit  As New ADODB.Recordset
   Dim iRow      As Integer
   Dim szSQL     As String
   Dim lRT_ID    As Long
   Dim cSumSplits As Double
   Dim rsAllocationSplit As New ADODB.Recordset

    

   szSQL = "SELECT MAX(TRANSACTIONID)+1 AS TID FROM RptTransactions;"
   rstTrans.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
   lRT_ID = CLng(IIf(IsNull(rstTrans!TID), 1, rstTrans!TID))
   rstTrans.Close

'  Update the OSAmt of credit transaction by receipt amount
   If Val(flxCrPoA.TextMatrix(Label10(4).Caption, 8)) - _
      Val(flxCrPoA.TextMatrix(Label10(4).Caption, 9)) = 0 Then                                  'Fully allocated
      szSQL = "UPDATE tlbReceipt " & _
              "SET OSAmount = " & RoundingNumber(CCur(flxCrPoA.TextMatrix(Label10(4).Caption, 8)) - _
                                  CCur(flxCrPoA.TextMatrix(Label10(4).Caption, 9)), 2) & ", " & _
                  "ReceiptView = False,DateTimeStamp = '',  Module = '', UserSessionID = '', WindowsUserName = '', MachineName ='', PrestigeUserName = '', ServerIPaddress ='' " & _
              "WHERE TransactionID = " & CLng(lblSelectedTranID.Caption) & ";"
   Else      '-------------------------------------------------------------------------------    'Part payment
      szSQL = "UPDATE tlbReceipt " & _
              "SET OSAmount = " & RoundingNumber(CCur(flxCrPoA.TextMatrix(Label10(4).Caption, 8)) - _
                                  CCur(flxCrPoA.TextMatrix(Label10(4).Caption, 9)), 2) & " " & _
              "WHERE TransactionID = " & CLng(lblSelectedTranID.Caption) & ";"
   End If
   adoConn.Execute szSQL

   rstTrans.Open "SELECT * FROM RptTransactions;", adoConn, adOpenDynamic, adLockOptimistic

   For iRow = 1 To flxSPayment.Rows - 1
      If flxSPayment.TextMatrix(iRow, 15) = "A" And flxSPayment.TextMatrix(iRow, 0) <> "-" Then
'  Update the OSAmt of Invoices/Debit transactions by receipt amount
         If CCur(flxSPayment.TextMatrix(iRow, 9)) - _
             CCur(flxSPayment.TextMatrix(iRow, 10)) = 0 Then                'OutStanding Amount = 0
             szSQL = "UPDATE tlbReceipt " & _
                     "SET tlbReceipt.OSAmount = " & _
                        RoundingNumber(CCur(flxSPayment.TextMatrix(iRow, 9)) - _
                         CCur(flxSPayment.TextMatrix(iRow, 10)), 2) & ", " & _
                        "ReceiptView = False, DateTimeStamp = '',  Module = '', UserSessionID = '', WindowsUserName = '', MachineName ='', PrestigeUserName = '', ServerIPaddress ='' " & _
                     "WHERE tlbReceipt.TransactionID = " & CLng(flxSPayment.TextMatrix(iRow, 19)) & ";"
         Else                                                               'OutStanding Amount > 0
            szSQL = "UPDATE tlbReceipt " & _
                    "SET tlbReceipt.OSAmount = " & _
                        RoundingNumber(CCur(flxSPayment.TextMatrix(iRow, 9)) - _
                         CCur(flxSPayment.TextMatrix(iRow, 10)), 2) & " " & _
                    "WHERE tlbReceipt.TransactionID = " & CLng(flxSPayment.TextMatrix(iRow, 19)) & ";"
         End If
         adoConn.Execute szSQL
'  Saving the cross referencing in the RptTransacitons table
'         ~CREDIT NOTE~ & ~RECEIPT ON ACCOUNT~
         If flxCrPoA.TextMatrix(Label10(4).Caption, 13) >= 2 Or _
            flxCrPoA.TextMatrix(Label10(4).Caption, 13) <= 4 Then
             With rstTrans
               .AddNew
               !TranType = IIf(UCase(flxCrPoA.TextMatrix(Label10(4).Caption, 1)) = "ADJC", "ADJAL", "AL")
               !TransactionID = lRT_ID
               !Alloc_Unalloc = 1
               !FromTran = CLng(lblSelectedTranID.Caption)
               !ToTran = CLng(flxSPayment.TextMatrix(iRow, 19))
               !AllocDate = Format(txtAllocationDAte.text, "dd mmmm yyyy")
               !receiptAmount = CCur(flxSPayment.TextMatrix(iRow, 10))
               !Discount = 0
               !IsSageUpdate = IIf(UCase(flxCrPoA.TextMatrix(Label10(4).Caption, 1)) = "ADJC", False, True)
               !UpdateSage = False
               !BankCode = txtBankCode.text
               !nominalCode = rstTrans!BankCode
               !SlNumber = Mid(flxCrPoA.TextMatrix(Label10(4).Caption, 0), 3)
               !fundID = CLng(flxSPayment.TextMatrix(iRow, 14))
               !deleteFlag = False
               lRT_ID = lRT_ID + 1
               .Update
            End With
             End If
      End If
   Next iRow

'  Delete all splits of SA, SC, SR except the first one
   adoConn.Execute "DELETE * FROM tlbReceiptSplit " & _
                   "WHERE RptHeader = " & CLng(lblSelectedTranID.Caption)

   rstSplit.Open "SELECT * FROM tlbReceiptSplit;", adoConn, adOpenDynamic, adLockOptimistic
   Dim lRptT_ID_Split As Long
   szSQL = "SELECT MAX(TransactionID) AS TID FROM RptTransactionsSplit"
   rsAllocationSplit.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
   lRptT_ID_Split = CLng(IIf(IsNull(rsAllocationSplit!TID), 1, rsAllocationSplit!TID))
   rsAllocationSplit.Close
   
   For iRow = 1 To flxSPayment.Rows - 1
      If flxSPayment.TextMatrix(iRow, 0) <> "+" And _
               flxSPayment.TextMatrix(iRow, 0) <> ">" And _
            Val(flxSPayment.TextMatrix(iRow, 10)) <> 0 Then
'  Saving the allocation splits
        lRptT_ID_Split = lRptT_ID_Split + 1
         With rstSplit
            .AddNew
            .Fields.Item("TransactionID").Value = UniqueID()
            .Fields.Item("RptHeader").Value = CLng(lblSelectedTranID.Caption)
            .Fields.Item("FundID").Value = flxSPayment.TextMatrix(iRow, 14)
            .Fields.Item("Amount").Value = flxSPayment.TextMatrix(iRow, 10)
            flxCrPoA.TextMatrix(flxCrPoA.row, 9) = Val(flxCrPoA.TextMatrix(flxCrPoA.row, 9)) - _
                                                   Val(.Fields.Item("Amount").Value)
            If flxSPayment.TextMatrix(iRow, 0) = "" Then
               .Fields.Item("SplitID").Value = iRow
            Else
               .Fields.Item("SplitID").Value = flxSPayment.TextMatrix(iRow, 1)
            End If

            .Fields.Item("DueDate").Value = Format(Now, "dd mmmm yyyy")
            .Fields.Item("Description").Value = flxSPayment.TextMatrix(iRow, 7)
            .Fields.Item("AllocTranID").Value = flxSPayment.TextMatrix(iRow, 19)
            .Fields.Item("RptTransactionsIDSplit").Value = lRptT_ID_Split
            .Fields.Item("PropertyID").Value = flxSPayment.TextMatrix(iRow, 30)
            .Update

            If flxSPayment.TextMatrix(iRow, 0) = "" Then
               adoConn.Execute "UPDATE tlbReceiptSplit " & _
                               "SET OSAmount = " & RoundingNumber(CCur(flxSPayment.TextMatrix(iRow, 9)) - _
                                     CCur(flxSPayment.TextMatrix(iRow, 10)), 2) & " " & _
                               "WHERE TransactionID = '" & flxSPayment.TextMatrix(iRow, 3) & "';"
            Else
            'flxSPayment.TextMatrix(iRow, 9) is OS amount
            'flxSPayment.TextMatrix(iRow, 10)) is inputed amount
               adoConn.Execute "UPDATE tlbReceiptSplit " & _
                               "SET OSAmount = " & RoundingNumber(CCur(flxSPayment.TextMatrix(iRow, 9)) - _
                                     CCur(flxSPayment.TextMatrix(iRow, 10)), 2) & " " & _
                               "WHERE TransactionID = '" & flxSPayment.TextMatrix(iRow, 19) & "';" ''flxSPayment.TextMatrix(iRow, 19) is transaction ID tlbReceipt
            End If
        
         ''start  of code by anol 2021-10-24
                szSQL = "SELECT * FROM RptTransactionsSplit;"
                rsAllocationSplit.Open szSQL, adoConn, adOpenDynamic, adLockPessimistic
                rsAllocationSplit.AddNew
                rsAllocationSplit!TransactionID = lRptT_ID_Split
                rsAllocationSplit!FromTran = rstSplit.Fields.Item("RptHeader").Value  'receipt ID
                rsAllocationSplit!ToTran = CLng(flxSPayment.TextMatrix(iRow, 3)) 'rpt Header in the RceiptSplit transaction ID
                '!AllocDate = Format(Date, "DD MMMM YYYY")
                rsAllocationSplit!AllocDate = Format(txtAllocationDAte.text, "dd mmmm yyyy")
                rsAllocationSplit!receiptAmount = CCur(flxSPayment.TextMatrix(iRow, 10))
                rsAllocationSplit!fundID = flxSPayment.TextMatrix(iRow, 14)
                rsAllocationSplit!BankCode = txtBankCode.text
                rsAllocationSplit!nominalCode = rsAllocationSplit!BankCode
                    'I should pass demand ID in the second parameter
                   
                If flxSPayment.TextMatrix(iRow, 29) = "" Then  'This condition is fpr PPR . enter full amount as net amount and vat is zero
                        rsAllocationSplit!VATAMOUNT = 0
                        rsAllocationSplit!NetAmount = rstSplit.Fields.Item("Amount").Value
                Else ' 'if demand type is SI/1 then this
                
                    rsAllocationSplit!VATAMOUNT = CalculateVatAmountFormdmsplit(adoConn, CLng(flxSPayment.TextMatrix(iRow, 29)), rstSplit.Fields.Item("SplitID").Value, rstSplit.Fields.Item("Amount").Value)
                    rsAllocationSplit!NetAmount = CalculateNetAmountFormdmsplit(adoConn, CLng(flxSPayment.TextMatrix(iRow, 29)), rstSplit.Fields.Item("SplitID").Value, rstSplit.Fields.Item("Amount").Value)
                End If
                
                rsAllocationSplit!VAT_PERIOD_END_DATE = Null ' I am not sure about it, need to ask
                rsAllocationSplit!SplitIDofSI = rstSplit.Fields.Item("SplitID").Value
                rsAllocationSplit!deleteFlag = False
                rsAllocationSplit.Update
                rsAllocationSplit.Close
            End With
            
      End If
   Next iRow

'   ConfigFlxCrPoA
'   ConfigureFlxSPayment
'   txtTenantID.text = ""
'   cmbBankAc.text = ""
'
'   txtReceiptEntered.text = "0.00"
'   txtSPaymentTotal.text = "0.00"
'
'   flxCrPoA.Enabled = True
'   ReDim baChangesMade(flxSPayment.Rows) As Boolean

   rstTrans.Close
   rstSplit.Close
   
   Set rstTrans = Nothing
   Set rstSplit = Nothing
   If SalesInvoice_Check(adoConn) = True Then 'false means fine and true means there is some garbage data
        Exit Function
   End If
   If ReceiptAllocation_check(adoConn) = False Then 'here false means not ok. but true means data is ok.
        Exit Function
   End If
   SavingAllocationS = True
End Function

Private Function SettleAllCrAllocation(adoConn As ADODB.Connection) As Boolean
   Dim iRow  As Integer, szSQL  As String, i As Integer, j As Integer
   Dim lRT_ID As Long
   Dim dAlloc As Double                         'Total     Allocated  amount
   Dim dPA As Double                            'Process   Allocation amount
   Dim dCA As Double                            'Currently Allocating amount
   Dim dCAd As Double                           'Currently Allocated  amount
   
   Dim rstRst As New ADODB.Recordset

   dPA = MinAmtAlloc(flxSPayment, flxCrPoA)

   

   j = 1

   While dPA > dAlloc
'  Update the credit side first.
'  First determin the amount to be allocated. Then allocate that amount in the Invoice side.
      If dPA >= flxCrPoA.TextMatrix(j, 8) Then
         szSQL = "UPDATE tlbReceipt " & _
                 "SET OSAmount = 0, " & _
                     "ReceiptView = False, FundID = -999 " & _
                 "WHERE TransactionID = " & CLng(flxCrPoA.TextMatrix(j, 10)) & ";"
         dAlloc = dAlloc + flxCrPoA.TextMatrix(j, 8)
         flxCrPoA.TextMatrix(j, 8) = Format(0, "0.00")
         dCA = flxCrPoA.TextMatrix(j, 9)
      Else
         szSQL = "UPDATE tlbReceipt " & _
                 "SET OSAmount = OSAmount - " & dPA & ", " & _
                     "FundID = (-1) * (FundID) " & _
                 "WHERE TransactionID = " & CLng(flxCrPoA.TextMatrix(j, 10)) & ";"
         dAlloc = dAlloc + dPA
         dCA = dPA
         flxCrPoA.TextMatrix(j, 8) = Format(flxCrPoA.TextMatrix(j, 8) - dPA, "0.00")
      End If

      adoConn.Execute szSQL

'  dCA amount to be allocated in the invoice side.
      i = 0
      While dCA > 0
         If flxSPayment.TextMatrix(dSortIndex(i), 9) > 0 Then
            If dCA >= flxSPayment.TextMatrix(dSortIndex(i), 9) Then
                szSQL = "UPDATE tlbReceipt " & _
                        "SET tlbReceipt.OSAmount = 0, " & _
                           "ReceiptView = False " & _
                        "WHERE tlbReceipt.TransactionID = " & CLng(flxSPayment.TextMatrix(dSortIndex(i), 19)) & ";"
               dCA = dCA - CDbl(flxSPayment.TextMatrix(dSortIndex(i), 9))
               dCAd = flxSPayment.TextMatrix(dSortIndex(i), 9)
               flxSPayment.TextMatrix(dSortIndex(i), 9) = Format(0, "0.00")
            Else
               szSQL = "UPDATE tlbReceipt " & _
                       "SET tlbReceipt.OSAmount = " & RoundingNumber(Val(flxSPayment.TextMatrix(dSortIndex(i), 9)) - dCA, 2) & " " & _
                       "WHERE tlbReceipt.TransactionID = " & CLng(flxSPayment.TextMatrix(dSortIndex(i), 19)) & ";"
               dCAd = dCA
               flxSPayment.TextMatrix(dSortIndex(i), 9) = Format(flxSPayment.TextMatrix(dSortIndex(i), 9) - dCA, "0.00")
               dCA = 0
            End If
            adoConn.Execute szSQL

            szSQL = "SELECT MAX(TRANSACTIONID)+1 AS TID FROM RptTransactions;"
            rstRst.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
            lRT_ID = CLng(IIf(IsNull(rstRst!TID), 1, rstRst!TID))
            rstRst.Close

   '  Now this allocation is needed to save in the RptTransactions table
            szSQL = "SELECT * FROM RptTransactions;"
            rstRst.Open szSQL, adoConn, adOpenDynamic, adLockOptimistic

            With rstRst
               .AddNew
               !TranType = IIf(UCase(flxCrPoA.TextMatrix(j, 8)) = "ADJC", "ADJAL", "AL")
               !TransactionID = lRT_ID
               !Alloc_Unalloc = 1
               !FromTran = CLng(flxCrPoA.TextMatrix(j, 10))
               !ToTran = CLng(flxSPayment.TextMatrix(dSortIndex(i), 19))
               !AllocDate = Format(txtAllocationDAte.text, "dd mmmm yyyy")
               !receiptAmount = CCur(dCAd)
               !Discount = 0
               !IsSageUpdate = IIf(UCase(flxCrPoA.TextMatrix(j, 1)) = "ADJC", False, True)
               !UpdateSage = False
               !BankCode = txtBankCode.text
               !nominalCode = rstRst!BankCode
               .Update
               .Close
            End With
         End If
         i = i + 1
      Wend
      j = j + 1
   Wend

'   ConfigFlxCrPoA
'   ConfigureFlxSPayment
'   txtTenantID.text = ""
'   cmbBankAc.text = ""
'   txtReceiptEntered.text = "0.00"
'   txtSPaymentTotal.text = "0.00"
'
'   flxCrPoA.Enabled = True
'   ReDim baChangesMade(flxSPayment.Rows) As Boolean

'   adoConn.Close
   Set rstRst = Nothing
'   Set adoConn = Nothing
    If SalesInvoice_Check(adoConn) = True Then
        SettleAllCrAllocation = True
    End If
End Function

Private Function SqNumber(szTran As String) As Long
   Dim i As Integer

   For i = 1 To flxCrPoA.Rows - 1
      If flxCrPoA.TextMatrix(i, 10) = szTran Then
         SqNumber = CLng(flxCrPoA.TextMatrix(i, 0))
         Exit Function
      End If
   Next i
End Function

Private Sub cmdCancel_Click()
    ComponenetAddNewLine ClearTextBoxes
    ComponenetAddNewLine DisableMode
    
    flxAddNewDemands.RowSel = 0
    txtDateDue.text = ""
    txtVAT.text = ""
    txtTotal.text = ""
    FraTopAddNewLine.Enabled = True
    Label1(24).Caption = ""
    Label1(24).Tag = ""
    nTaxCode = 0
End Sub

Private Sub cmdDeleteLine_Click()
   Dim i As Integer, iRow As Integer

   If flxAddNewDemands.TextMatrix(1, 0) = "" Then Exit Sub

   If MsgBox("Do you want to delete the line?", vbQuestion + vbYesNo, "Delete the line") = vbYes Then
      flxAddNewDemands.RowHeight(flxAddNewDemands.row) = 0
      flxAddNewDemands.TextMatrix(flxAddNewDemands.row, 0) = "DELETED"

      For i = flxAddNewDemands.row + 1 To flxAddNewDemands.Rows - 1
         If flxAddNewDemands.RowHeight(i) > 0 Then
            flxAddNewDemands.TextMatrix(i, 0) = flxAddNewDemands.TextMatrix(i, 0) - 1
         End If
      Next i
      'added by anol 20 Nov 2015
      CalSubTotal flxAddNewDemands, txtArray(8), txtArray(7), txtArray(6)
   End If
   Dim Flag As Boolean
'   If flxAddNewDemands.row = 1 Then
'        If flxAddNewDemands.TextMatrix(1, 0) = "DELETED" Then
'                Debug.Print ""
'        End If
'         flxAddNewDemands.TextMatrix(lRow, 24) = txtDmdClientList.Tag
        For i = 0 To flxAddNewDemands.Rows - 1
            If flxAddNewDemands.TextMatrix(i, 0) <> "DELETED" And flxAddNewDemands.TextMatrix(i, 0) <> "" And flxAddNewDemands.TextMatrix(i, 0) <> "SL" Then
                Flag = True 'this variable true means you have  some valid entered row in the details grid
                Exit For
            End If
        Next i
        If Flag = False Then  'this variable false means you do not have  some valid entered row in the details grid so you can now change client and property
            cmdDmdClientList.Enabled = True
            cmdDmdPropertyList.Enabled = True
        End If
   
'   End If
End Sub

Private Sub cmdDemandList_Click(Index As Integer)
   Call ChangeReportODBC
   If Index = 0 Then
      If CheckDemandTypePrintingTemplate Then
         fraDemandListCriteria.Left = fraDetails.Left + 80
         fraDemandListCriteria.Top = fraPrint.Top + cmdDemandList(0).Top + tabDmdRcpt.Top
'         CreateBorder4Frame fraDemandListCriteria, Shape4(37), Shape4(36)
         fraDemandListCriteria.Visible = True
         tabDmdRcpt.Enabled = False
         fraDemandListCriteria.ZOrder 0
         txtDLFrom.SetFocus
         txtDLFrom.text = "01/01/2000"
         txtDLTo.text = Format(Date, "dd/mm/yyyy")
      Else
         MsgBox "Demand will not be printed." & Chr(10) & _
                "Please set the report name of all demand types.", vbCritical + vbOKOnly, "Demand Printing"
      End If
   Else
'      Dim reportApp As New CRAXDRT.Application
'      Dim Report As CRAXDRT.Report
'      Dim rep As frmReport
'
'      Set Report = reportApp.OpenReport(App.Path & szReportPath & "\PrintDemandHistory.rpt")
'      Report.Database.Tables(1).ConnectionProperties.Item("Database Password") = accessDBPws
'
'      Report.EnableParameterPrompting = False
'      Report.DiscardSavedData
'
'      Set rep = New frmReport
'      Load rep
'      rep.LoadReportViewer Report
             If CheckDemandTypePrintingTemplate Then
                 fraDemandListCriteria.ZOrder 0
                 fraDemandListCriteria.Left = flxChildDemandHistory.Left + 80
                 fraDemandListCriteria.Top = flxChildDemandHistory.Top
'                 CreateBorder4Frame fraDemandListCriteria, Shape4(37), Shape4(36)
                 fraDemandListCriteria.Visible = True
                 tabDmdRcpt.Enabled = False
                 fraDemandListCriteria.ZOrder 0
                 txtDLFrom.SetFocus
                 txtDLFrom.text = "01/01/2000"
                 txtDLTo.text = Format(Date, "dd/mm/yyyy")
              Else
                 MsgBox "Demand will not be printed." & Chr(10) & _
                        "Please set the report name of all demand types.", vbCritical + vbOKOnly, "Demand Printing"
              End If
   End If
End Sub

Private Sub cmdEditLine_Click()
    Dim lRow As Long, i As Integer, szaTemp() As String
    If flxAddNewDemands.RowSel = 0 Then
        MsgBox "Please select a line from the grid.", vbInformation + vbOKOnly, "Edit a Line"
        Exit Sub
    End If
    If flxAddNewDemands.TextMatrix(1, 0) = "" Then Exit Sub
    strAddNewAmountMode = "Edit"
    'If IsDemandIDLocked = False Then cmdAddNewLine.SetFocus
    lRow = CLng(GridRowNo)
    If flxAddNewDemands.TextMatrix(lRow, 0) = "DELETED" Then
        MsgBox "Please select a line from the grid.", vbInformation + vbOKOnly, "Edit a Line"
        Exit Sub
    End If
    'this fix is added by anol 2020-10-09
    'You need to load the variable for demand type array befor you edit the lines
    ComponenetAddNewLine EnableMode
    strSelectedFundCode = flxAddNewDemands.TextMatrix(lRow, 3)
    txtAddNewDescription.text = flxAddNewDemands.TextMatrix(lRow, 4)
    txtDateFrom.text = flxAddNewDemands.TextMatrix(lRow, 5)
    txtDateTo.text = flxAddNewDemands.TextMatrix(lRow, 6)
    txtDateDue.text = flxAddNewDemands.TextMatrix(lRow, 7)
'    For i = 0 To UBound(szaJobCode)
'        If szaJobCode(i, 0) = flxAddNewDemands.TextMatrix(lRow, 8) Then Exit For
'    Next i
    txtJob.text = returnJobName(flxAddNewDemands.TextMatrix(lRow, 8))
    txtJob.Tag = flxAddNewDemands.TextMatrix(lRow, 8)
    txtAmount.text = Format(flxAddNewDemands.TextMatrix(lRow, 9), "0.00")
    txtVAT.text = Format(flxAddNewDemands.TextMatrix(lRow, 10), "0.00")
    txtTotal.text = Format(flxAddNewDemands.TextMatrix(lRow, 11), "0.00")
    If flxAddNewDemands.TextMatrix(lRow, 13) = "-1" Or flxAddNewDemands.TextMatrix(lRow, 13) = "" Then
          Label1(24).Caption = ""
          Label1(24).Tag = ""
    Else
          Label1(24).Caption = "T" & flxAddNewDemands.TextMatrix(lRow, 13)
          Label1(24).Tag = flxAddNewDemands.TextMatrix(lRow, 13)
          set_nTaxCode (Label1(24).Tag)
          
    End If
    txtType.Tag = flxAddNewDemands.TextMatrix(lRow, 20) 'szaDemandData(i, 0)
    txtFund.Tag = flxAddNewDemands.TextMatrix(lRow, 21)
    txtAdiComment.text = Left(szAdiComment(lRow), 22) & "..."
    If Val(flxAddNewDemands.TextMatrix(lRow, 23)) = 1 Or Val(flxAddNewDemands.TextMatrix(lRow, 23)) = 2 Then
        txtChargingAmt.text = Format(flxAddNewDemands.TextMatrix(lRow, 22), "0.000000")
    End If
    txtType.text = flxAddNewDemands.TextMatrix(lRow, 2) 'szaDemandData(i, 1)
    txtFund.text = flxAddNewDemands.TextMatrix(lRow, 26)
    cmdVATCode.Enabled = True
    txtVAT.Enabled = True
    If IsDemandIDLocked = False Then cmdType.SetFocus
End Sub
Private Sub set_nTaxCode(strNTaxCode As String)
    Dim adoConn As New ADODB.Connection
    adoConn.Open getConnectionString
    Dim rsTax As New ADODB.Recordset
    rsTax.Open "Select Vat_rate from tlbVatCode where VAT_ID=" & strNTaxCode & "", adoConn, adOpenStatic, adLockReadOnly
    If Not rsTax.EOF Then
        nTaxCode = rsTax("Vat_rate").Value
    End If
    rsTax.Close
    adoConn.Close
    Set adoConn = Nothing
    
End Sub
Private Function returnJobName(strJobId As String) As String
    Dim adoConn As New ADODB.Connection
    Dim szSQL As String
    Dim rsJob As New ADODB.Recordset
    adoConn.Open getConnectionString
    szSQL = "SELECT ID, Job_DiaryName,H.MaintenanceType " & _
           "FROM PropertyMaintHistory H where ID='" & strJobId & "'"
    rsJob.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
    If Not rsJob.EOF Then
            returnJobName = rsJob("Job_DiaryName").Value
    End If
    rsJob.Close
    adoConn.Close
    Set adoConn = Nothing
End Function
Private Sub cmdCancelNew_Click()
   If bAddNew Then _
      If MsgBox("Are you sure you wish to discard all changes?", vbYesNo + vbQuestion, "Add Manual Demands") = vbNo Then _
         Exit Sub

'   If DemandLock = I_Locked_It Then
'      Dim adoConn As New ADODB.Connection
'      adoConn.Open getConnectionString
'
'      'Resolved By BOSL. Date: 29-11-2014
'      'Issue No: 0000506
'      'Modified by Asif.Validate whether szLastIDClicked has a numeric value before converting it to Long.
'
'      If IsNumeric(szLastIDClicked) = True Then
'         ReleaseLockedRecord adoConn, "DemandRecords", "DemandID", "LONG", , CLng(szLastIDClicked)
'      End If
'      '''' END
'
'      adoConn.Close
'      Set adoConn = Nothing
'   End If
   ' If youHaveDoneTransaction = False Then  ' This means you have done no edit or no new save . So you need to release existing lock for edit button. actual record edit shall newly create row's on tlb receipt
        Dim adoConn As New ADODB.Connection
        adoConn.Open getConnectionString
        adoConn.Execute "Update tlbReceipt Set  DateTimeStamp='',Module='',UserSessionID='',WindowsUserName='',MachineName=''," & _
                       "PrestigeUserName='',ServerIPaddress='' where UserSessionID='" & UserSessionID & "' AND Module='Demand Invoice'"
        adoConn.Close
        Set adoConn = Nothing
    'End If
   fraCreateManualDemand.Visible = False
   ShowMsgInTaskBar "The manual demand has not been saved.", "Y", "N"

   cmdEdit.Enabled = True
   txtArray(8).text = ""
   txtArray(7).text = ""
   txtArray(6).text = ""
   txtDateDue.text = ""

   txtTenantName.text = ""
   txtIssueDate.text = ""
   cmdDmdTenantLookup.Enabled = True

   ComponenetAddNewLine ClearTextBoxes
   ComponenetAddNewLine DisableMode

   Unload frmAdiComment
   Label1(7).Visible = False
   FraTopAddNewLine.Enabled = True
End Sub

Private Sub cmdCloseBk_LostFocus(Index As Integer)
   tabPayment.SetFocus
End Sub

Private Sub LoadDeptBk()
   flxLeaseList.Clear
   flxLeaseList.Rows = 2
   flxLeaseList.Cols = 4
   flxLeaseList.ColWidth(1) = 800
   flxLeaseList.ColWidth(2) = 2500
   flxLeaseList.ColAlignment = vbLeftJustify

'    ~~~ Added by Senthuran~~~ Configuring width and position of labels and search boxes.

   flxLeaseList.ColWidth(0) = 0
   flxLeaseList.ColWidth(3) = 0
   Label20(0).Width = 1400
   Label20(0).Left = 50
   Label20(1).Width = 2600
   Label20(1).Left = Label20(0).Left + flxLeaseList.ColWidth(1)

   txtTenantSearchID.Width = 700
   txtTenantSearchID.Left = 40

   txtTenantSearchName.Width = 2400
   txtTenantSearchName.Left = txtTenantSearchID.Left + flxLeaseList.ColWidth(1)

   txtTenantSearchUnitName.Visible = False

'   ~~~Added By Senthuran~~~ Code to configuer Label Caption
   Label20(0).Caption = "Fund"
   Label20(1).Caption = "Name"
   Label20(2).Visible = False

   '~~~ End of config

   ' Error Handler
   On Error GoTo Error_Handler

   Dim adoConn As ADODB.Connection
   Dim adoRST As New ADODB.Recordset
   Dim szSQL As String

   Set adoConn = New ADODB.Connection
   adoConn.Open getConnectionString

   szSQL = "SELECT FundID, FundName " & _
           "FROM Fund;"

   adoRST.Open szSQL, adoConn, adOpenStatic, adLockReadOnly

   flxLeaseList.Clear
   flxLeaseList.TextMatrix(0, 0) = "Dept. ID"
   flxLeaseList.TextMatrix(0, 1) = "Department Name"

   Dim rRow As Integer
   rRow = 1
   While Not adoRST.EOF
      flxLeaseList.TextMatrix(rRow, 1) = adoRST.Fields.Item("FundID").Value
      flxLeaseList.TextMatrix(rRow, 2) = adoRST.Fields.Item("FundName").Value
      rRow = rRow + 1
      adoRST.MoveNext
      If Not adoRST.EOF Then flxLeaseList.AddItem ""
   Wend

   Set adoRST = Nothing
   Set adoConn = Nothing
   Exit Sub

Error_Handler:
   ' Destroy Objects
   Set adoRST = Nothing
   Set adoConn = Nothing
End Sub

Private Function PossibleToEdit(szDemandID As String, ByVal adoConn As ADODB.Connection, Optional ByRef IsDemandIDLocked As Boolean) As Boolean
   Dim adoRST As New ADODB.Recordset
   Dim szSQL As String
   Dim TransactionID As String
   szSQL = "SELECT R.TransactionID,R.UserSessionID,R.WindowsUserName,R.MachineName,R.Module,R.ClientID  " & _
           "FROM tlbReceipt R, DemandRecords D " & _
           "WHERE (R.ReceiptAmount > 0 OR " & _
               "R.Amount <> R.OSAmount) And " & _
               "R.DemandRef = " & szDemandID & " AND R.DemandRef=D.DemandID;"
   adoRST.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
   If adoRST.EOF Then
      PossibleToEdit = True
   Else
      PossibleToEdit = False
      MsgBox "You cannot edit a Demand once it has been allocated.", vbInformation + vbOKOnly, "Edit Demand"
      GoTo XX
   End If
   adoRST.Close
    szSQL = "SELECT R.TransactionID,R.UserSessionID,R.WindowsUserName,R.MachineName,R.Module,R.ClientID  " & _
           "FROM tlbReceipt R, DemandRecords D " & _
           "WHERE R.DemandRef = " & szDemandID & " AND R.DemandRef=D.DemandID;"
   adoRST.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
   
   If PossibleToEdit = True Then
            If Not adoRST.EOF Then
                TransactionID = adoRST("TransactionID").Value
                szSQL = IIf(IsNull(adoRST("UserSessionID").Value), "", adoRST("UserSessionID").Value)
                If Len(szSQL) > 0 And szSQL <> UserSessionID Then 'szSQL <> UserSessionID shall be always true bcoz PI is generating only one seeion through out this module.
                    flxDemands.col = 0
                    flxDemands.row = iDemandRow ' iDemandRow contains the row number of last valid selected Demand anol
                    flxDemands.CellBackColor = vbRed
                    IsDemandIDLocked = True
                    MsgBox "The selected invoice is currently locked by '" & IIf(IsNull(adoRST("WindowsUserName").Value), "", adoRST("WindowsUserName").Value) & _
                    "' on '" & IIf(IsNull(adoRST("MachineName").Value), "", adoRST("MachineName").Value) & "' in the '" & IIf(IsNull(adoRST("Module").Value), "", adoRST("Module").Value) & "'" & vbCrLf & "" & _
                            "screen for the Client '" & IIf(IsNull(adoRST("ClientID").Value), "", adoRST("ClientID").Value) & "' and cannot be edited. Please wait until it is released.", vbInformation, "Warning"
                   ' PossibleToEdit = False
                Else 'lock row for this user in database
                    IsDemandIDLocked = False
                    flxDemands.col = 1
                    flxDemands.row = iDemandRow
                    flxDemands.CellBackColor = vbWhite
                End If
            Else
                GoTo XX:
            End If
    End If
    adoRST.Close
    If PossibleToEdit = True Then
            szSQL = "SELECT  B.BatchNo,T.* FROM tblBatchReceipt AS B, tblBtRptTran AS T " & _
              "WHERE B.BR = T.BR AND B.Generated = FALSE AND T.RptAmt > 0 AND T.TransactionID=" & TransactionID & ";"
            adoRST.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
            If Not adoRST.EOF Then
                 PossibleToEdit = False
                 MsgBox "The selected invoice cannot be edited. This transaction has been saved in Batch Receipt.", vbInformation, "Warning"
            End If
            adoRST.Close
    End If
    If PossibleToEdit = True And IsDemandIDLocked = False Then  'the reason I need to lock it here because it has passed all the tests here to open SI and now I can lock
             adoConn.Execute "Update tlbReceipt Set  DateTimeStamp='" & Now & "',Module='Demand Invoice',UserSessionID='" & UserSessionID & "',WindowsUserName='" & SystemUser & "',MachineName='" & WS_Name & "'," & _
                "PrestigeUserName='" & User & "',ServerIPaddress='" & GetIPaddress & "' where tlbReceipt.transactionID = " & TransactionID & ""
    End If
XX:
   'adoRst.Close
   Set adoRST = Nothing
End Function

Private Function ExportedSI2Other(adoConn As ADODB.Connection) As Boolean
   Dim adoRST As New ADODB.Recordset
   Dim szSQL As String

   szSQL = "SELECT spare3 " & _
           "FROM DemandRecords " & _
           "WHERE DemandID = " & szLastIDClicked & ";"
   adoRST.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
'Debug.Print szSQL
   If Not adoRST.EOF Then
      ExportedSI2Other = IIf(IsNull(adoRST.Fields.Item(0)), False, True)
   End If

   adoRST.Close
   Set adoRST = Nothing
End Function
'Private Function IsDemandRecordLocked(adoConn As ADODB.Connection, ByRef strUserID As String, ByRef strSystemID As String, szTable As String, IdFiledName As String, IdFieldType As String, Optional szID As String, Optional lID As Long) As Boolean
'   Dim szSQL      As String
'   Dim adoRst     As New ADODB.Recordset
'
'   If IdFieldType = "STRING" Then
'      szSQL = "SELECT EditRecord, UserID, SystemID FROM " & szTable & " WHERE " & IdFiledName & " = '" & szID & "';"
'   Else
'      szSQL = "SELECT EditRecord, UserID, SystemID FROM " & szTable & " WHERE " & IdFiledName & " = " & lID & ";"
'   End If
'
'   adoRst.Open szSQL, adoConn, adOpenKeyset, adLockPessimistic
'
'   If Not adoRst.EOF Then
'      If adoRst.Fields.Item(0).Value Then
'         IsDemandRecordLocked = True
'         strUserID = IIf(IsNull(adoRst.Fields.Item("UserID").Value), "", adoRst.Fields.Item("UserID").Value)
'         strSystemID = IIf(IsNull(adoRst.Fields.Item("SystemID").Value), "", adoRst.Fields.Item("SystemID").Value)
'         DemandLock = He_Locked_It
'      Else
'         IsDemandRecordLocked = False
''         strUserID = ""
''         strSystemID = ""
'         adoRst.Fields.Item(0).Value = True
'         adoRst.Fields.Item(1).Value = SystemUser
'         adoRst.Fields.Item(2).Value = WS_Name
'         adoRst.Update
'         DemandLock = I_Locked_It
'      End If
'      adoRst.Close
'   Else
'      DemandLock = It_Is_Not_Locked
'   End If
'
'   Set adoRst = Nothing
'End Function
'Private Function IsdatabaseConnected() As Boolean
'   Dim szTemp As String
'   szTemp = Replace(FullDatabasePath, "mdb", "ldb")
'   If FileExists(szTemp) Then
'      IsdatabaseConnected = True
'   End If
'End Function
Private Sub SetFreqID(szFreqID As String)
   
   If szFreqID = "" Or szFreqID = "0" Then
         txtFreq.text = ""
         txtFreq.Tag = ""
   ElseIf szFreqID = "1" Then
        txtFreq.text = "W Ad"
        txtFreq.Tag = "1"
        
   ElseIf szFreqID = "2" Then
        txtFreq.text = "Y Ar"
        txtFreq.Tag = "2"
        
   ElseIf szFreqID = "3" Then
        txtFreq.text = "F Ad"
        txtFreq.Tag = "3"
        
   ElseIf szFreqID = "4" Then
        txtFreq.text = "F Ar"
        txtFreq.Tag = "4"
        
   ElseIf szFreqID = "5" Then
        txtFreq.text = "M Ad"
        txtFreq.Tag = "5"
        
   ElseIf szFreqID = "6" Then
        txtFreq.text = "M Ar"
        txtFreq.Tag = "6"
        
   ElseIf szFreqID = "7" Then
        txtFreq.text = "Q Ad"
        txtFreq.Tag = "7"
        
   ElseIf szFreqID = "8" Then
        txtFreq.text = "Q Ar"
        txtFreq.Tag = "8"
        
   ElseIf szFreqID = "9" Then
        txtFreq.text = "HY Ad"
        txtFreq.Tag = "9"
        
   ElseIf szFreqID = "10" Then
        txtFreq.text = "HY Ar"
        txtFreq.Tag = "10"
        
   ElseIf szFreqID = "11" Then
        txtFreq.text = "Y Ad"
        txtFreq.Tag = "11"
        
   ElseIf szFreqID = "12" Then
        txtFreq.text = "Y Ar"
        txtFreq.Tag = "12"
        
   ElseIf szFreqID = "13" Then
        txtFreq.text = "Daily"
        txtFreq.Tag = "13"
        
   ElseIf szFreqID = "14" Then
        txtFreq.text = "4W Ad"
        txtFreq.Tag = "14"
        
   ElseIf szFreqID = "15" Then
        txtFreq.text = "4W Ar"
        txtFreq.Tag = "15"
        
   ElseIf szFreqID = "16" Then
        txtFreq.text = "4M Ad"
        txtFreq.Tag = "16"
        
   ElseIf szFreqID = "17" Then
        txtFreq.text = "4M Ar"
        txtFreq.Tag = "17"
        
   End If
   Exit Sub
Err:
   
End Sub
Private Sub cmdEdit_Click()
   'Dim isOpenDatabaseByOtherUser As Boolean
   If fraCreateManualDemand.Visible Then Exit Sub
  
   Dim szComp As String, szUnit As String, szBt As String, szLeaseExp As String
   Dim szSageAC As String, dtIssueDt As Date, chIC As String, szLeaseID As String
   Dim szPropertyID As String, szClientID As String, szSo As String, szFreqID As String
   Dim szexclCRNtoCS As Boolean
   Dim dtPostingDt As Date
   Dim adoConn As New ADODB.Connection
   Dim iCol As Integer
   Dim strUserID As String
   Dim strSystemID As String
   Label1(24).Caption = ""
   Label1(24).Tag = ""
   txtDmdClientList.ForeColor = vbBlack
   'isOpenDatabaseByOtherUser = IsdatabaseConnected
  
'   If isOpenDatabaseByOtherUser = False Then
'    'here I am removing all locks if database is not connected by other user
'            adoConn.Execute "Update DemandRecords set EditRecord=0, UserID='', SystemID=''"
'   End If
   'If cboVatCode.ListCount = 0 Then Call FillCboVatCode(cboVatCode, adoConn)
   'fixed by anol 20160920
   iIncDec = 0
   Dim rCount As Integer
   Dim selRow As Integer
   For rCount = 1 To flxDemands.Rows - 1
        If flxDemands.TextMatrix(rCount, 0) = "X" Then
            iIncDec = iIncDec + 1
            selRow = rCount 'flxDemands.row
        End If
   Next
   If iIncDec <> 1 Then
      MsgBox "Please select a demand to edit.", vbInformation + vbOKOnly, "Demand Selection"
      chkSelectAllDemands.Value = 0
      ClearGridSelection
      
'      adoConn.Close
'      Set adoConn = Nothing
      Exit Sub
   End If
  adoConn.Open getConnectionString
'  Check for possibility to Edit the demand. Rule is: if user enter any receipt amount against
'  the demand in the receipt form then it will not allow user to edit the Invoice.
   If Not PossibleToEdit(CLng(szLastIDClicked), adoConn, IsDemandIDLocked) Then 'PossibleToEdit
      'MsgBox "You cannot edit a Demand once it has been allocated.", vbInformation + vbOKOnly, "Edit Demand"
      adoConn.Close
      Set adoConn = Nothing
      'added by anol 01 Sep 2016
        flxDemands.TextMatrix(iDemandRow, 0) = ""
        'flxDemands.CellBackColor = vbCyan 'RGB(179, 233, 174)
            If flxDemands.row > 0 Then
                If flxDemands.TextMatrix(iDemandRow, 0) = "" Then
                         For iCol = 1 To flxDemands.Cols - 1
                            flxDemands.col = iCol
                            flxDemands.CellBackColor = RGB(174, 199, 200)
                         Next iCol
                End If
         End If
        iIncDec = iIncDec - 1
      Exit Sub
   End If
'  If system is Export to 3rd Party enabled, then user cannot edit the demand if it has been
'  exported to 3rd party sotfware.
  If UCase(SystemUser) <> "BOSLUSER" And UCase(WS_Name) <> "PCM-DEV2" Then
        If ExpTrans3rdParty And ExportedSI2Other(adoConn) Then
           MsgBox "You cannot edit Demand after exported the transaction to other system.", vbInformation + vbOKOnly, "Edit Demand"
           adoConn.Close
           Set adoConn = Nothing
           Exit Sub
        End If
  End If
   'added by anol 24 Jan 2016
   ComponenetAddNewLine DisableMode
'  MULTI-USER/MULTIUSER SYSTEM
'szLastIDClicked is the correct demand ID that is selected properly ,you cannot use grid.row becasue may not have 'X' on the first column
   'DemandLock = It_Is_Not_Locked
   If IsDemandIDLocked Then 'it is opening as view only when demand is locked
   'If IsDemandRecordLocked(adoConn, strUserID, strSystemID, "DemandRecords", "DemandID", "LONG", , CLng(szLastIDClicked)) Then
      'ShowMsgInTaskBar "You cannot access this record because it is being edited by another user: " & strUserID & ", from system: " & strSystemID, "Y", "N"
      Label1(7).Visible = True
'      adoConn.Close
'      Set adoConn = Nothing
'      Exit Sub
      txtDmdClientList.Locked = True
      txtDmdPropertyList.Locked = True
      cmdDmdTenantLookup.Enabled = False
      txtDateDue.Locked = True
      lblPostingDate.Enabled = False
      txtIssueDate.Locked = True
      cmdaddnewline.Enabled = False
      cmdUpdate.Enabled = False
      cmdSaveNew.Enabled = False
      'cboVatCode.Locked = True
      cmdVATCode.Enabled = False
      'cboType.Locked = True
      cmdType.Enabled = False
      'cboFund.Locked = True
      cmdFund.Enabled = False
      txtAddNewDescription.Locked = True
      txtDateFrom.Locked = True
      txtDateTo.Locked = True
      txtAdiComment.Locked = True
      txtChargingAmt.Locked = True
      'cboJob.Locked = True
      cmdJob.Enabled = False
      txtAmount.Locked = True
      cmdDeleteLine.Enabled = False
   Else
      Label1(7).Visible = False
      txtDmdClientList.Locked = True
      txtDmdPropertyList.Locked = True
      cmdDmdTenantLookup.Enabled = True
      txtDateDue.Locked = False
      lblPostingDate.Enabled = True
      txtIssueDate.Locked = False
      cmdaddnewline.Enabled = True
      cmdUpdate.Enabled = False
      cmdSaveNew.Enabled = True
      'cboVatCode.Locked = False
      cmdVATCode.Enabled = True
      'cboType.Locked = False
      cmdFund.Enabled = True
'        cmdType.Enabled = False
'      Else
      cmdType.Enabled = False
'      End If
     
      cmdFund.Enabled = False
      txtAddNewDescription.Locked = False
      txtDateFrom.Locked = False
      txtDateTo.Locked = False
      txtAdiComment.Locked = False
      txtChargingAmt.Locked = False
      'cboJob.Locked = False
      cmdJob.Enabled = True
      txtAmount.Locked = False
      cmdDeleteLine.Enabled = True '
      'added by anol 05 Sep 2016
      cmdDmdClientList.Enabled = False
      cmdDmdPropertyList.Enabled = False
      cmdDmdTenantLookup.Enabled = False
   End If

   ConfigFlxAddNewDemands
   Call FindLastSelID(szLeaseID, szLeaseExp, szComp, szUnit, szSageAC, dtIssueDt, szBt, dtPostingDt, szPropertyID, szClientID, szSo, szexclCRNtoCS, szFreqID, adoConn)
   szCurCompSageAccNum = szSageAC

   Call SelectedID(chIC)
   strCommandSource = "12"
'   Call LoadFunds(adoconn)'we do not need to load funds here by anol 2020-11-12 issue 889
   'Call LoadDept(adoConn)
   strCommandSource = "13"
   Call LoadJobs(adoConn)

   fraCreateManualDemand.Caption = "Edit Demand - " & IIf(chIC = "INV", "Invoice", "Credit") & " - " & flxDemands.TextMatrix(selRow, 2)
   PrepareList adoConn, txtDmdClientList, txtDmdPropertyList
   txtDmdClientList.text = szClientID
   txtDmdClientList.Tag = szClientID
   txtDmdPropertyList.text = szPropertyID
   txtTenantName.text = szSageAC & " / " & szComp
   txtLeaseEndDate.text = szLeaseExp
   Label1(41).Caption = IIf(IsNull(szLeaseID), "NotFound", szLeaseID)
   txtIssueDate.text = Format(dtIssueDt, "dd/mm/yyyy")
   lblPostingDate.ToolTipText = Format(dtPostingDt, "dd/mm/yyyy")
   txtDemandID.text = szLastIDClicked
   txtDateDue.text = Format(flxChildDemands.TextMatrix(1, 6), "dd/mm/yyyy")
   chkSO.Value = szSo
   chkExcludeInCS = szexclCRNtoCS
'   If szFreqID = "" Or szFreqID = "0" Then
'         cboFreq.ListIndex = -1
'   Else
'         cboFreq.Value = szFreqID
'   End If
   Call SetFreqID(szFreqID)
'  30/11/2009  Salia told me to let user change lessee in the invoice
   'If DemandLock = It_Is_Not_Locked Then cmdDmdTenantLookup.Enabled = True ' IIf(flxChildDemands.TextMatrix(1, 2) = "A", False, True)
   'removing prevois locking methid by anol 20190426
   cmdDmdTenantLookup.Enabled = True ' IIf(flxChildDemands.TextMatrix(1, 2) = "A", False, True)

   txtUnit.text = szUnit
   'added by anol  21 Jan 2016
   strCommandSource = "11"
   Call loadflxDemandType(szSageAC, adoConn)

'*****Fill detail grid   by selected demands****
   Call loadflxAddNewDemands(szLastIDClicked, szBt, adoConn) 'loading the detail grid of demand Main function
    
   CalSubTotal flxAddNewDemands, txtArray(8), txtArray(7), txtArray(6)

   bEditDmd = True

   fraCreateManualDemand.Left = fraGenerateDemands.Left + fraGenerateDemands.Width + 25
   fraCreateManualDemand.Top = 379 'fraGenerateDemands.Top
   fraCreateManualDemand.Visible = True
   fraCreateManualDemand.ZOrder 0

   Load frmAdiComment

   szDemandBankID = ""
   Label1(38).Visible = True
   txtChargingAmt.Visible = True
   'added by anol 01 Sep 2016
   flxDemands.TextMatrix(flxDemands.row, 0) = ""
   'flxDemands.CellBackColor = vbCyan 'RGB(179, 233, 174)
       If flxDemands.row > 0 Then

       If flxDemands.TextMatrix(flxDemands.row, 0) = "" Then
            'If flxDemands.CellBackColor = RGB(174, 179, 233) Then
                For iCol = 1 To flxDemands.Cols - 1
                   flxDemands.col = iCol
                   flxDemands.CellBackColor = RGB(174, 199, 200)
                Next iCol
           ' End If
       End If
    End If
   txtDateDue.text = ""
   txtVAT.text = ""
   txtTotal.text = ""
   adoConn.Close
   Set adoConn = Nothing
   cmdVATCode.Enabled = False
   If cmdaddnewline.Enabled Then cmdaddnewline.SetFocus
End Sub

Private Sub cmdGenAll_Click()
   Me.Enabled = False

   Load frmDemandTypesSel
   frmDemandTypesSel.szCallingFrom = "Automatic Demand"
   frmDemandTypesSel.Caption = "Generating Demands - Options"
   frmDemandTypesSel.fraSC_St.Visible = True
   frmDemandTypesSel.chkSentAutoEmail.Visible = True
   frmDemandTypesSel.Top = 435
   frmDemandTypesSel.Left = 100
   frmDemandTypesSel.Show
End Sub

Public Sub FillFrequency(conCombo As Control)
   Dim i As Integer, Data() As String, SQLStr1 As String
   Dim Conn1 As New ADODB.Connection
   Dim Rst1 As New ADODB.Recordset

   'fill the frequencies
   Conn1.Open getConnectionString

   SQLStr1 = "SELECT * FROM Frequencies"
   Rst1.Open SQLStr1, Conn1, adOpenStatic, adLockReadOnly

   i = Rst1.RecordCount
   If Rst1.EOF = False Then
      ReDim Preserve Data(1, i) As String
      Data(0, 0) = 0
      Data(1, 0) = "ALL Frequencies"
      i = 1
      While Rst1.EOF = False
         Data(0, i) = Rst1!Id
         Data(1, i) = Rst1!Frequency
         i = i + 1
         Rst1.MoveNext
      Wend
      conCombo.Clear

      conCombo.Column() = Data()
      conCombo.ListIndex = 0
   End If

   '' Fill the Head leases
   Rst1.Close
   Conn1.Close
   Set Rst1 = Nothing
   Set Conn1 = Nothing
End Sub

Private Sub cmdGenerateManual_Click()
   If Not cmdGenAll.Enabled Then Exit Sub

   Dim szChoice As String, szaChoice() As String

'   cmbManualDemand.Clear
'   cmbManualDemand.AddItem "Lessee", 0
'   cmbManualDemand.AddItem "Landlord", 1
'   cmbManualDemand.ListIndex = 0

   fraInvCrChoice.Left = 1440 'fraGenerateDemands.Left + cmdGenerateManual.Left + cmdGenerateManual.Width + tabDmdRcpt.Left
   fraInvCrChoice.Top = 540 'fraGenerateDemands.Top + cmdGenerateManual.Top + tabDmdRcpt.Top
   fraInvCrChoice.Visible = True
   fraInvCrChoice.ZOrder 0

   GridRowNo = "1"

   szChoice = GetSetting("PropertyManagement", "ChoosedOption", "Demand-c" & CStr(SCID))
   szaChoice = Split(szChoice, "#")

   If UBound(szaChoice) > 1 Then
      If szaChoice(2) <> "" Then
         If InStr(szaChoice(2), "IN") > 0 Then optManualInv.Value = True
         If InStr(szaChoice(2), "CN") > 0 Then optManualCrNote.Value = True
         If InStr(szaChoice(2), "AI") > 0 Then optManualAdjInv.Value = True
         If InStr(szaChoice(2), "AC") > 0 Then optManualAdjCrNote.Value = True
      End If
   End If

   cmdGenerateManual.Enabled = False
   cmdManualDmdOk.SetFocus
End Sub

Private Sub cmdManualDmdOk_Click()
    
   Dim adoConn As New ADODB.Connection
   Dim szChoice As String, szaChoice() As String
   cmdDmdClientList.Enabled = True
   cmdDmdPropertyList.Enabled = True
   cmdDmdTenantLookup.Enabled = True
'  Remember choice
   szChoice = GetSetting("PropertyManagement", "ChoosedOption", "Demand-c" & CStr(SCID))
   szaChoice = Split(szChoice, "#")
   Label1(24).Caption = ""
   txtUnit.text = ""
   txtLeaseEndDate.text = ""
   txtDmdPropertyList.text = ""
   Label1(24).Tag = ""
   nTaxCode = 0
   
   adoConn.Open getConnectionString

   ConfigFlxAddNewDemands

'  Prepare Client and Property dropdown list
'comment out by anol 23 Dec 2015
   'If cboDmdClientList.ListCount < 1 Then PrepareList adoConn, cboDmdClientList, cboDmdPropertyList
   'If cboVatCode.ListCount = 0 Then Call FillCboVatCode(cboVatCode, adoConn)

   If UBound(szaChoice) < 2 Then ReDim Preserve szaChoice(2) As String

'  Saving the selection settings in the registry
   If optManualInv.Value Then szaChoice(2) = "IN"
   If optManualCrNote.Value Then szaChoice(2) = "CN"
   If optManualAdjInv.Value Then szaChoice(2) = "AI"
   If optManualAdjCrNote.Value Then szaChoice(2) = "AC"
   szChoice = Join(szaChoice, "#")
   SaveSetting "PropertyManagement", "ChoosedOption", "Demand-c" & CStr(SCID), szChoice

   fraInvCrChoice.Visible = False
   ConfigFlxAddNewDemands
   'added by anol 25 Jan 2015
   strCommandSource = "12"
'    Call LoadFunds(adoconn) I have remmed this 2020-11-12 This gives warning if no fund has been set up for this client issue 889
   'Call LoadDept(adoConn)

   fraCreateManualDemand.Caption = "Generate Manual Demands - " & _
                                   IIf(optManualAdjInv.Value Or optManualAdjCrNote.Value, "Adjustment ", "") & _
                                   IIf(optManualInv.Value Or optManualAdjInv.Value, "Invoice", "Credit Note")
   bEditDmd = False

   txtDemandID.text = Format(NextRef(adoConn, "DEMAND_REF"), "00000000")

   txtIssueDate.text = Format(Date, "dd/mm/yyyy")
   lblPostingDate.ToolTipText = txtIssueDate.text
'   txtDateDue.text = Format(Date, "dd/mm/yyyy")

   fraCreateManualDemand.Left = fraGenerateDemands.Left + fraGenerateDemands.Width + 25
   fraCreateManualDemand.Top = 379 'fraGenerateDemands.Top
   fraCreateManualDemand.Visible = True
   fraCreateManualDemand.ZOrder 0

   Load frmAdiComment

   ComponenetAddNewLine DisableMode
   ComponenetAddNewLine ClearTextBoxes
   szDemandBankID = ""

   cmdGenerateManual.Enabled = True
   Dim strTemp As String
    txtDmdClientList.ForeColor = vbBlack
    strTemp = isControlAccountSet(txtDmdClientList.text)
    If Len(strTemp) > 0 Then
        MsgBox "No Nominal Account Codes have been setup in the Control Accounts for the Client: " & txtDmdClientList.text & _
        vbNewLine & "Please setup the Control Accounts in Tools > Configuration > Control Accounts"
        strTemp = ""
        txtDmdClientList.ForeColor = vbRed
        Exit Sub
    End If
   adoConn.Close
   Set adoConn = Nothing
   Label1(38).Visible = False
   txtChargingAmt.Visible = False
   'added by anol 20 May 2015
    'issue 571 validation
   cmdSaveNew.Enabled = False
   'End of modification
   cmdDmdClientList.SetFocus
   txtVAT.text = ""
   txtTotal.text = ""
End Sub

Private Sub ComponenetAddNewLine(ByVal mode As ComponentsEnableDisable)
   Select Case mode
      Case ComponentsEnableDisable.EnableMode
      'added by anol 11 Jun 2015
        cmdFund.Enabled = True
        txtAdiComment.Enabled = True
        cmdJob.Enabled = True
        'End of modification
        cmdaddnewline.Enabled = False
        cmdType.Enabled = True
        txtAddNewDescription.Enabled = True
        txtDateFrom.Enabled = True
        txtDateTo.Enabled = True
        '         txtDateDue.Enabled = False
        txtAmount.Enabled = True
        txtDateDue.Enabled = True
        If vatOptionEnabled = True Then
               cmdVATCode.Enabled = True
               txtVAT.Enabled = True
        Else
               cmdVATCode.Enabled = False
               txtVAT.Enabled = False
               txtVAT.text = "0.00"
               Label1(24).Caption = ""
        End If
        If IsDemandIDLocked = False Then
           cmdUpdate.Enabled = True
           cmdDeleteLine.Enabled = False
        End If
        cmdCancel.Enabled = True
        cmdSaveNew.Enabled = False
        txtChargingAmt.Enabled = True
        
        flxAddNewDemands.Enabled = False
        cmdEditLine.Enabled = False
        
        If flxAddNewDemands.TextMatrix(flxAddNewDemands.Rows - 1, 0) <> "" And strAddNewAmountMode <> "Edit" Then
           flxAddNewDemands.AddItem ""
        End If
        ReDim Preserve szAdiComment(flxAddNewDemands.Rows)

      Case ComponentsEnableDisable.DisableMode
      'added by anol 11 Jun 2015
        cmdFund.Enabled = False
        txtAdiComment.Enabled = False
        cmdJob.Enabled = False
        'End of modification
         cmdType.Enabled = False
         txtAddNewDescription.Enabled = False
         txtDateFrom.Enabled = False
         txtDateTo.Enabled = False
         txtDateDue.Enabled = True
         txtAmount.Enabled = False
         txtDateDue.Enabled = False
         txtChargingAmt.Enabled = False
         cmdVATCode.Enabled = False
         cmdUpdate.Enabled = False
         cmdCancel.Enabled = False
         txtIssueDate.Locked = False
            
         flxAddNewDemands.Enabled = True
         cmdEditLine.Enabled = True
         If IsDemandIDLocked = False Then
            cmdDeleteLine.Enabled = True
            cmdSaveNew.Enabled = True
            cmdaddnewline.Enabled = True
         End If

      Case ComponentsEnableDisable.ClearTextBoxes
      'added by anol 11 Jun 2015
        txtFund.text = ""
        txtAdiComment.text = ""
         txtJob.text = ""
        'End of modification
         txtAddNewDescription.text = ""
         txtDateFrom.text = ""
         txtDateTo.text = ""
         txtAmount.text = ""
         txtChargingAmt.text = ""
         txtVAT.text = "0.00"
         txtTotal.text = "0.00"
         txtAdiComment.text = ""
         txtDateDue.text = ""

         txtType.text = ""
   End Select
End Sub

Private Sub LoadDemandTypeInObj(conFlxGrid As Control, conCombo As Control)
   Dim iLoop As Integer, iRow As Integer
   Dim szaTemp() As String
'
   For iRow = 1 To conFlxGrid.Rows - 1
      If conFlxGrid.TextMatrix(iRow, 2) <> "" Then
         For iLoop = 0 To conCombo.ListCount - 1
            szaTemp = Split(conCombo.List(iLoop), " / ")
            If conFlxGrid.TextMatrix(iRow, 2) = szaTemp(1) Then Exit For
         Next iLoop
         objDemandType.AddItemPos Trim(szaTemp(1)), iLoop
      End If
   Next iRow
End Sub

Private Sub CalSubTotal(conGrid As Control, conTextTA As Control, conTextVAT As Control, conTextTotal As Control)
   Dim iRow As Integer

   conTextTA.text = "0.00"
   conTextVAT.text = "0.00"
   conTextTotal.text = "0.00"
   For iRow = 1 To conGrid.Rows - 1
      If conGrid.TextMatrix(iRow, 0) <> "DELETED" Then 'condition added by anol 20 Nov 2015
            conTextTA.text = Format(Val(conTextTA.text) + Val(conGrid.TextMatrix(iRow, 9)), "0.00")
            conTextVAT.text = Format(Val(conTextVAT.text) + Val(conGrid.TextMatrix(iRow, 10)), "0.00")
            conTextTotal.text = Format(Val(conTextTotal.text) + Val(conGrid.TextMatrix(iRow, 11)), "0.00")
      End If
   Next iRow
End Sub

Private Sub FindLastSelID(szLeaseID As String, szLeaseExp As String, szComp As String, szUnit As String, szSageAC As String, dtIssueDt As Date, szBt As String, dtPostingDt As Date, szPropertyID As String, szClientID As String, szSo As String, szexclCRNtoCS As Boolean, szFreqID As String, adoDBConn As ADODB.Connection)
   Dim adoRST As New ADODB.Recordset
   Dim szSQL As String

   szSQL = "SELECT D.TenantCompanyName as TCN, " & _
               "D.UnitNumber as UN, D.SageAccountNumber as SAC, " & _
               "D.IssueDate as ID, D.BatchID as BI, D.PostingDate, " & _
               "L.EndDate, L.OLED, L.LeaseID, P.ClientID, P.PropertyID, D.SO, S.FrequencyID,D.exclCRNtoCS " & _
           "FROM (((DemandRecords AS D LEFT OUTER JOIN DemandSplitRecords AS S ON " & _
               "D.DemandID = S.DemandID) INNER JOIN LeaseDetails AS L ON " & _
               "D.LeaseRef = L.LeaseID)  INNER JOIN Units AS U ON " & _
               "L.UnitNumber = U.UnitNumber) INNER JOIN Property AS P ON " & _
               "U.PropertyID = P.PropertyID " & _
           "WHERE D.DEMANDID = " & szLastIDClicked & ";"
'Debug.Print szSQL
   adoRST.Open szSQL, adoDBConn, adOpenDynamic, adLockPessimistic

   If Not adoRST.EOF Then
      If adoRST!OLED Then
         szLeaseExp = "OVERRIDE"
      Else
         szLeaseExp = adoRST!EndDate
      End If

      szLeaseID = adoRST!LeaseID
      szComp = adoRST!TCN
      szUnit = adoRST!UN
      szSageAC = adoRST!SAC
      dtIssueDt = adoRST!Id
      szBt = adoRST!bI
      dtPostingDt = adoRST!postingDate
      szPropertyID = adoRST!propertyID
      szClientID = adoRST!ClientID
      'added by anol 16 Aug 2016
      szSo = CBool(adoRST!SO)
      'szExcludeInCS = CBool(adoRst!chkExcludeInCS)
      szexclCRNtoCS = CBool(adoRST!exclCRNtoCS)
      szFreqID = IIf(IsNull(adoRST!FrequencyID), "", adoRST!FrequencyID)
   End If

   adoRST.Close
   Set adoRST = Nothing
End Sub

Private Sub FillCboVatCode(adoConnection As ADODB.Connection)
   Dim adoRST As New ADODB.Recordset
   Dim SQLStr1 As String

   

   SQLStr1 = "SELECT VAT_ID, VAT_CODE, VAT_RATE FROM TLBVATCODE where IN_USE"
   adoRST.Open SQLStr1, adoConnection, adOpenDynamic, adLockPessimistic

'   If Not adoRst.EOF Then
'       While Not adoRst.EOF
'           conCombo.AddItem adoRst!VAT_ID & " / " & adoRst!VAT_CODE & " / " & adoRst!VAT_RATE
'           adoRst.MoveNext
'       Wend
'   End If
   txtSearchClientID.text = ""
   txtSearchClientID.Left = 250
   
   txtSearchClientID.Width = 3200
   txtSearchClientName.Visible = False
   
   txtSearchClientName.text = ""
   flxClient.RowHeight(0) = 0
   flxClient.Cols = 3
   
   flxClient.ColWidth(0) = 100
   flxClient.ColWidth(1) = 1200
   flxClient.ColWidth(2) = 1800
   picClient.Width = 3500
   flxClient.Width = 3300
   cmdPicCLose.Left = 3200
   txtSearchClientID.Left = 145
   Label20(14).Visible = False
   flxClient.Clear
   flxClient.Rows = 2
   flxClient.ColAlignment(0) = vbLeftJustify
   flxClient.ColAlignment(1) = vbLeftJustify
   flxClient.ColAlignment(2) = vbLeftJustify

   '~~~ Added by Anol Configuring width and position of labels and search boxes.
   Label20(12).Caption = "VAT Code"
   Label20(13).Caption = ""
   Label20(12).Width = 1400
   Label20(12).Left = 250
   Label20(13).Width = 3600
   Dim rRow As Integer
   Label20(13).Left = Label20(12).Left + flxClient.ColWidth(0)
'           flxClient.row = 1
'           flxClient.RowSel = 1
'           flxClient.ColSel = 1
'           flxClient.CellBackColor = &HC0FFFF
           
    If strCommandSource = "14" Then
        rRow = 1
        While Not adoRST.EOF
           flxClient.row = 1
           flxClient.TextMatrix(rRow, 0) = "  " & adoRST.Fields.Item("VAT_ID").Value
           flxClient.TextMatrix(rRow, 1) = adoRST.Fields.Item("VAT_CODE").Value
           flxClient.TextMatrix(rRow, 2) = adoRST.Fields.Item("VAT_RATE").Value
            flxClient.RowHeight(rRow) = 280
           adoRST.MoveNext
           If Not adoRST.EOF Then flxClient.AddItem ""
           rRow = rRow + 1
        Wend
   End If
   adoRST.Close
   Set adoRST = Nothing
End Sub
'Private Sub FillDemandType(szLessee As String, conConnection As ADODB.Connection)
'   Dim adoRst As New ADODB.Recordset
'   Dim SQLStr1 As String
'
''   SQLStr1 = "SELECT D.ID, D.Type " & _
''             "FROM ((DemandTypes AS D INNER JOIN Units AS U ON D.PropertyID = U.PropertyID) INNER JOIN " & _
''                  "LeaseDetails AS L ON U.UnitNumber = L.UnitNumber) INNER JOIN " & _
''                  "Tenants AS T ON L.SageAccountNumber = T.SageAccountNumber " & _
''             "WHERE T.SageAccountNumber = '" & szLessee & "' AND " & _
''                  "L.STATUS = TRUE " & _
''             "ORDER BY ID;"
''modified by anol 05 sep 2016
'  SQLStr1 = "SELECT D.ID, D.Type, P.ClientID " & _
'             "FROM (((DemandTypes AS D INNER JOIN Units AS U ON D.PropertyID = U.PropertyID)INNER JOIN Property P on P.PropertyID=U.PropertyID )INNER JOIN " & _
'                  "LeaseDetails AS L ON U.UnitNumber = L.UnitNumber) INNER JOIN " & _
'                  "Tenants AS T ON L.SageAccountNumber = T.SageAccountNumber " & _
'             "WHERE T.SageAccountNumber = '" & szLessee & "' AND " & _
'                  "L.STATUS = TRUE " & _
'             "ORDER BY ID;"
'
'   adoRst.Open SQLStr1, conConnection, adOpenKeyset, adLockReadOnly
'
'   If adoRst.EOF Then
'      adoRst.Close
''      SQLStr1 = "SELECT D.ID, D.Type " & _
''                "FROM ((DemandTypes AS D INNER JOIN Units AS U ON D.PropertyID = U.PropertyID) INNER JOIN " & _
''                     "LeaseDetails AS L ON U.UnitNumber = L.UnitNumber) INNER JOIN " & _
''                     "Tenants AS T ON L.SageAccountNumber = T.SageAccountNumber " & _
''                "WHERE T.SageAccountNumber = '" & szLessee & "' " & _
''                "ORDER BY ID;"
''modified by anol 05 sep 2016
'                SQLStr1 = "SELECT D.ID, D.Type, P.ClientID " & _
'                "FROM (((DemandTypes AS D INNER JOIN Units AS U ON D.PropertyID = U.PropertyID)INNER JOIN Property P on P.PropertyID=U.PropertyID ) INNER JOIN " & _
'                     "LeaseDetails AS L ON U.UnitNumber = L.UnitNumber) INNER JOIN " & _
'                     "Tenants AS T ON L.SageAccountNumber = T.SageAccountNumber " & _
'                "WHERE T.SageAccountNumber = '" & szLessee & "' " & _
'                "ORDER BY ID;"
'      adoRst.Open SQLStr1, conConnection, adOpenKeyset, adLockReadOnly
'   End If
'
'
'   txtSearchDemandtype.text = ""
'
'   flxDemandType.RowHeight(0) = 0
'   flxDemandType.Cols = 3
'   flxDemandType.ColWidth(0) = 0
'   flxDemandType.ColWidth(1) = 0
'   flxDemandType.ColWidth(2) = 2600
'
'
'   txtSearchClientID.Width = 1530
'   txtSearchClientName.Visible = True
'   picClient.Width = 5295
'   cmdPicCLose.Left = 5010
'
'   flxDemandType.Clear
'   flxDemandType.Rows = 2
'   flxDemandType.ColAlignment(0) = vbLeftJustify
'   flxDemandType.ColAlignment(1) = vbLeftJustify
'   flxClient.ColAlignment(2) = vbLeftJustify
'
'
'
'   Label20(15).Caption = "Demand Type"
'   Dim rRow As Integer
'   ReDim szaDemandData(adoRst.RecordCount - 1, 2) As String
'   If strCommandSource = "11" Then
'        rRow = 1
'        While Not adoRst.EOF
'           flxDemandType.TextMatrix(rRow, 0) = ""
'           flxDemandType.TextMatrix(rRow, 1) = adoRst.Fields.Item("ID").Value
'           flxDemandType.TextMatrix(rRow, 2) = adoRst.Fields.Item("Type").Value
'           szaDemandData(rRow - 1, 0) = adoRst.Fields.Item("ID").Value
'           szaDemandData(rRow - 1, 1) = adoRst.Fields.Item("Type").Value
'           szaDemandData(rRow - 1, 2) = adoRst.Fields.Item("ClientID").Value
'           flxDemandType.RowHeight(rRow) = 280
'           adoRst.MoveNext
'           If Not adoRst.EOF Then flxDemandType.AddItem ""
'           rRow = rRow + 1
'        Wend
'   End If
'End Sub

'
   
Private Sub loadflxDemandType(szLessee As String, conConnection As ADODB.Connection)
   Dim adoRST As New ADODB.Recordset
   Dim SQLStr1 As String

'   SQLStr1 = "SELECT D.ID, D.Type " & _
'             "FROM ((DemandTypes AS D INNER JOIN Units AS U ON D.PropertyID = U.PropertyID) INNER JOIN " & _
'                  "LeaseDetails AS L ON U.UnitNumber = L.UnitNumber) INNER JOIN " & _
'                  "Tenants AS T ON L.SageAccountNumber = T.SageAccountNumber " & _
'             "WHERE T.SageAccountNumber = '" & szLessee & "' AND " & _
'                  "L.STATUS = TRUE " & _
'             "ORDER BY ID;"
'modified by anol 05 sep 2016
  SQLStr1 = "SELECT D.ID, D.Type, P.ClientID " & _
             "FROM (((DemandTypes AS D INNER JOIN Units AS U ON D.PropertyID = U.PropertyID)INNER JOIN Property P on P.PropertyID=U.PropertyID )INNER JOIN " & _
                  "LeaseDetails AS L ON U.UnitNumber = L.UnitNumber) INNER JOIN " & _
                  "Tenants AS T ON L.SageAccountNumber = T.SageAccountNumber " & _
             "WHERE T.SageAccountNumber = '" & szLessee & "' AND " & _
                  "L.STATUS = TRUE " & _
             "ORDER BY ID;"
'Debug.Print SQLStr1
'   If txtDmdPropertyList.text = "ALL" Then
'      SQLStr1 = "SELECT ID, Type " & _
'                "FROM DemandTypes " & _
'                "ORDER BY ID;"
'   Else
'      SQLStr1 = "SELECT ID, Type " & _
'                "FROM DemandTypes " & _
'                "WHERE PropertyID = '" & txtDmdPropertyList.text & "' " & _
'                "ORDER BY ID;"
'   End If

   adoRST.Open SQLStr1, conConnection, adOpenKeyset, adLockReadOnly

   If adoRST.EOF Then
      adoRST.Close
'      SQLStr1 = "SELECT D.ID, D.Type " & _
'                "FROM ((DemandTypes AS D INNER JOIN Units AS U ON D.PropertyID = U.PropertyID) INNER JOIN " & _
'                     "LeaseDetails AS L ON U.UnitNumber = L.UnitNumber) INNER JOIN " & _
'                     "Tenants AS T ON L.SageAccountNumber = T.SageAccountNumber " & _
'                "WHERE T.SageAccountNumber = '" & szLessee & "' " & _
'                "ORDER BY ID;"
'   modified by anol 05 sep 2016
        SQLStr1 = "SELECT D.ID, D.Type, P.ClientID " & _
                "FROM (((DemandTypes AS D INNER JOIN Units AS U ON D.PropertyID = U.PropertyID)INNER JOIN Property P on P.PropertyID=U.PropertyID ) INNER JOIN " & _
                     "LeaseDetails AS L ON U.UnitNumber = L.UnitNumber) INNER JOIN " & _
                     "Tenants AS T ON L.SageAccountNumber = T.SageAccountNumber " & _
                "WHERE T.SageAccountNumber = '" & szLessee & "' " & _
                "ORDER BY ID;"
      adoRST.Open SQLStr1, conConnection, adOpenKeyset, adLockReadOnly
   End If
  ' conCombo.Clear

'   If Not adoRst.EOF Then
'       While Not adoRst.EOF
'           conCombo.AddItem adoRst!ID & " / " & adoRst!Type
'           adoRst.MoveNext
'       Wend
'   End If
'   Dim TotalRow As Long, TotalCol As Long
'   Dim Data() As String
'   TotalRow = adoRst.RecordCount
'   TotalCol = adoRst.Fields.count
'   ReDim Data(TotalCol - 1, TotalRow - 1) As String
'
'   Dim i As Integer, j As Integer
'
'   For i = 0 To adoRst.RecordCount - 1
'      For j = 0 To adoRst.Fields.count - 1
'         Data(j, i) = IIf(IsNull(adoRst.Fields(j)), "", adoRst.Fields(j))
'      Next j
'      adoRst.MoveNext
'   Next i
'
'   adoRst.Close
'   Set adoRst = Nothing
''   conConnection.Close
''   Set conConnection = Nothing
'
'   cboType.Column() = Data()
''   adoRst.Close
'   Set adoRst = Nothing
'DoEvents
   txtSearchClientID.text = ""
   txtSearchClientID.Left = 250
   
   txtSearchClientID.Width = 2700
   txtSearchClientName.Visible = False
   
   txtSearchClientName.text = ""
   flxClient.Clear
   flxClient.RowHeight(0) = 0
   flxClient.Cols = 3

   flxClient.ColWidth(0) = 200
   flxClient.ColWidth(1) = 0
   flxClient.ColWidth(2) = 2800
   picClient.Width = 3500
   cmdPicCLose.Left = 3200
   txtSearchClientID.Left = 145
   txtSearchClientID.Width = 3240
   Label20(14).Visible = False

   'flxClient.Clear
   flxClient.Rows = 2
   flxClient.Height = 2845
   If strCommandSource = "11" Or strCommandSource = "14" Then
        flxClient.Width = 3200
   Else
        flxClient.Width = 5175
   End If
   'flxClient.Refresh
   picClient.Height = 3595
   'flxClient.BorderStyle = flexBorderSingle
   flxClient.ColAlignment(0) = vbLeftJustify
   flxClient.ColAlignment(1) = vbLeftJustify
   flxClient.ColAlignment(2) = vbLeftJustify

'           flxClient.RowSel = 1
'           flxClient.ColSel = 1
'           flxClient.row = 1
'           flxClient.BackColorSel = &HC0FFFF
   '~~~ Added by Anol Configuring width and position of labels and search boxes.
   Label20(12).Caption = "Demand Type"
   Label20(13).Caption = ""
   Label20(12).Width = 1400
   Label20(12).Left = 250
   Label20(13).Width = 3600
   Label20(13).Left = Label20(12).Left + flxClient.ColWidth(0)
   Dim rRow As Integer
   If adoRST.RecordCount > 0 Then
        ReDim szaDemandData(adoRST.RecordCount - 1, 2) As String
   Else
        ReDim szaDemandData(1, 2) As String
   End If
   If strCommandSource = "11" Then
        rRow = 1
        While Not adoRST.EOF
           
           
          ' flxClient.SelectionMode = &HC0FFFF
           'flxClient.row = flxClient.FixedRows
           'flxClient.SelectionMode = flexSelectionByRow
           flxClient.TextMatrix(rRow, 0) = "" 'adoRst.Fields.Item(0).Value
           flxClient.TextMatrix(rRow, 1) = adoRST.Fields.Item("ID").Value
           flxClient.TextMatrix(rRow, 2) = adoRST.Fields.Item("Type").Value
           szaDemandData(rRow - 1, 0) = adoRST.Fields.Item("ID").Value
           szaDemandData(rRow - 1, 1) = adoRST.Fields.Item("Type").Value
           szaDemandData(rRow - 1, 2) = adoRST.Fields.Item("ClientID").Value
           'Debug.Print adoRst.Fields.Item("ID").Value & adoRst.Fields.Item("Type").Value & adoRst.Fields.Item("ClientID").Value
'           flxClient.row = 1
'           flxClient.RowSel = 1
'           flxClient.ColSel = 2
'           flxClient.CellBackColor = &HC0FFFF
           flxClient.RowHeight(rRow) = 280
           adoRST.MoveNext
           If Not adoRST.EOF Then flxClient.AddItem ""
           rRow = rRow + 1
        Wend
'         Dim iRow As Integer
'                flxClient.row = 1
'                For iRow = 1 To flxClient.Cols - 1
'                   flxClient.col = iRow
'                   flxClient.CellBackColor = &HC0FFFF 'RGB(174, 179, 233)
'                Next iRow
'       MsgBox rRow
'       MsgBox adoRst.RecordCount
   End If
End Sub
'Private Sub UpdateBalance()
'   Dim i As Integer, j As Integer
'
'   For i = 1 To flxLeaseList.Rows - 1
'      For j = 0 To UBound(szaTenantBalance, 2) - 1
'         If flxLeaseList.TextMatrix(i, 2) = szaTenantBalance(0, j) Then
'            flxLeaseList.TextMatrix(i, 10) = Format(szaTenantBalance(1, j), "0.00")
'            Exit For
'         End If
'      Next j
'      If j = UBound(szaTenantBalance, 2) Then flxLeaseList.TextMatrix(i, 10) = "0.00"
'   Next i
'End Sub
'Private Sub TenantAccountBalance(adoConn As ADODB.Connection)
'   Dim szSQL As String, i As Integer, iIndex As Integer
'   Dim adoRptDr As New ADODB.Recordset, adoRptCr As New ADODB.Recordset
'
'   szSQL = "SELECT COUNT(SageAccountNumber), 2 " & _
'           "From " & _
'            "(" & _
'             "SELECT tlbReceipt.SageAccountNumber  " & _
'             "From tlbReceipt " & _
'             "GROUP BY tlbReceipt.SageAccountNumber" & _
'            ");"
'   adoRptDr.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
'
'   If adoRptDr.EOF Then
'      adoRptDr.Close
'      Set adoRptDr = Nothing
'      Exit Sub
'   End If
'
'   ReDim szaTenantBalance(1, adoRptDr.Fields.Item(0).Value) As String
'   adoRptDr.Close
'
'   szSQL = "SELECT SageAccountNumber, SUM(Amount) AS Dr " & _
'           "FROM tlbReceipt AS Rpt " & _
'           "WHERE Type = 1 OR Type = 23 " & _
'           "GROUP BY SageAccountNumber " & _
'           "ORDER BY SageAccountNumber;"
''Debug.Print szSQL
'   adoRptDr.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
'
'   iIndex = 0
'   While Not adoRptDr.EOF
'      szaTenantBalance(0, iIndex) = adoRptDr.Fields.Item("SageAccountNumber").Value
''If adoRptDr.Fields.Item("SageAccountNumber").Value = "Payden01" Then
''MsgBox ""
''End If
'      szaTenantBalance(1, iIndex) = RoundingNumber(adoRptDr.Fields.Item("Dr").Value, 2)
'      iIndex = iIndex + 1
'      adoRptDr.MoveNext
'   Wend
'
'   adoRptDr.Close
'
'   szSQL = "SELECT SageAccountNumber, SUM(Amount) AS Cr " & _
'           "FROM tlbReceipt AS Rpt " & _
'           "WHERE Type <> 1 AND Type <> 23 " & _
'           "GROUP BY SageAccountNumber;"
''Debug.Print szSQL
'   adoRptCr.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
'
'   While Not adoRptCr.EOF
'      For i = 0 To iIndex - 1
'         If szaTenantBalance(0, i) = adoRptCr.Fields.Item("SageAccountNumber").Value Then
'            Exit For
'         End If
'      Next i
''If adoRptCr.Fields.Item("SageAccountNumber").Value = "Payden01" Then
''MsgBox ""
''End If
'      If i < iIndex Then
'         szaTenantBalance(1, i) = Val(szaTenantBalance(1, i)) - RoundingNumber(adoRptCr.Fields.Item("Cr").Value, 2)
'      Else
'         iIndex = iIndex + 1
'         szaTenantBalance(0, iIndex) = RoundingNumber(adoRptCr.Fields.Item("Cr").Value, 2)
'      End If
'      adoRptCr.MoveNext
'   Wend
'
'   adoRptCr.Close
'
'   Set adoRptDr = Nothing
'   Set adoRptCr = Nothing
'End Sub
Private Sub LoadFunds(conConnection As ADODB.Connection)
   Dim adoRST As New ADODB.Recordset
   Dim SQLStr1 As String
   Dim iSel As Integer
   Dim rsFundMatrix As New ADODB.Recordset
   rsFundMatrix.Open "Select isfundAssign from shoppingcentre", conConnection, adOpenStatic, adLockReadOnly
   If rsFundMatrix("isfundAssign").Value = False Then
        iSel = 1
        SQLStr1 = "SELECT FundID, FundName, FundCode FROM Fund;"
   Else
        iSel = 2
        SQLStr1 = "Select * from fundMatrix where PropertyID='" & txtDmdPropertyList.text & "' and ClientID='" & txtDmdClientList.text & "' and isDeleted=false"
   End If
   rsFundMatrix.Close
   
   adoRST.Open SQLStr1, conConnection, adOpenKeyset, adLockReadOnly

   txtSearchClientID.text = ""
   txtSearchClientID.Left = 250
   
   txtSearchClientID.Width = 2700
   txtSearchClientName.Visible = False
   
   txtSearchClientName.text = ""
   flxClient.RowHeight(0) = 0
   flxClient.Cols = 3

   flxClient.ColWidth(0) = 100
   flxClient.ColWidth(1) = 1500
   flxClient.ColWidth(2) = 3600
   txtSearchClientID.Width = 1500
   txtSearchClientName.Visible = True
   picClient.Width = 5295
   flxClient.Width = 5175
   Label20(14).Visible = False
   cmdPicCLose.Left = 5010
   txtSearchClientID.Left = 45
   txtSearchClientName.Left = 1580
   txtSearchClientName.Width = 3600
   picClient.Height = 4095
   flxClient.Height = 3345
   
   flxClient.Clear
   flxClient.Rows = 2
   flxClient.ColAlignment(0) = vbLeftJustify
   flxClient.ColAlignment(1) = vbLeftJustify
   flxClient.ColAlignment(2) = vbLeftJustify

   '~~~ Added by Anol Configuring width and position of labels and search boxes.
   Label20(12).Caption = "Fund Code"
   Label20(13).Caption = "Fund Name"
   Label20(12).Width = 1400
   Label20(12).Left = 250
   Label20(13).Width = 3600
   Label20(13).Left = Label20(12).Left + flxClient.ColWidth(1)
   
   
   ReDim szaFundCode(adoRST.RecordCount, 2) As String
   
   Dim rRow As Integer
   If adoRST.EOF Then
        If iSel = 1 Then
            MsgBox "No Funds have not been setup for this company.", vbExclamation, "Please create a Fund"
        Else
            MsgBox "Please assign a fund to this client", vbOKOnly, "Warning!"
        End If
   Else
       If strCommandSource = "12" Then
            rRow = 1
            While Not adoRST.EOF
               flxClient.row = 1
               flxClient.RowSel = 1
               flxClient.ColSel = 1
'               flxClient.TextMatrix(rRow, 0) = adoRst.Fields.Item("FundCode").Value
'               flxClient.TextMatrix(rRow, 1) = adoRst.Fields.Item("FundName").Value
'               flxClient.TextMatrix(rRow, 2) = adoRst.Fields.Item("FundID").Value
               
               flxClient.TextMatrix(rRow, 0) = "  " & adoRST.Fields.Item("FundID").Value
               flxClient.TextMatrix(rRow, 1) = adoRST.Fields.Item("FundCode").Value
               flxClient.TextMatrix(rRow, 2) = adoRST.Fields.Item("FundName").Value
               
               szaFundCode(rRow - 1, 0) = adoRST.Fields.Item("FundCode").Value 'because array starts from 0 and grid from 1
               szaFundCode(rRow - 1, 1) = adoRST.Fields.Item("FundName").Value
               szaFundCode(rRow - 1, 2) = adoRST.Fields.Item("FundID").Value
                flxClient.RowHeight(rRow) = 280
               adoRST.MoveNext
               If Not adoRST.EOF Then flxClient.AddItem ""
               rRow = rRow + 1
            Wend
       End If
   End If
End Sub
Private Sub LoadFrequency()
   txtSearchClientID.text = ""
   txtSearchClientID.Left = 250
   
   txtSearchClientID.Width = 2700
   txtSearchClientName.Visible = False
   
   txtSearchClientName.text = ""
   flxClient.RowHeight(0) = 0
   flxClient.Cols = 3

   flxClient.ColWidth(0) = 100
   flxClient.ColWidth(1) = 1500
   flxClient.ColWidth(2) = 3600
   txtSearchClientID.Width = 1500
   txtSearchClientName.Visible = True
   picClient.Width = 5295
   flxClient.Width = 5175
   Label20(14).Visible = False
   cmdPicCLose.Left = 5010
   txtSearchClientID.Left = 45
   txtSearchClientName.Left = 1580
   txtSearchClientName.Width = 3600
   picClient.Height = 4095
   flxClient.Height = 3345
   
   flxClient.Clear
   flxClient.Rows = 2
   flxClient.ColAlignment(0) = vbLeftJustify
   flxClient.ColAlignment(1) = vbLeftJustify
   flxClient.ColAlignment(2) = vbLeftJustify

   '~~~ Added by Anol Configuring width and position of labels and search boxes.
   Label20(12).Caption = "Frequency Code"
   Label20(13).Caption = "Frequency Description"
   Label20(12).Width = 1400
   Label20(12).Left = 250
   Label20(13).Width = 3600
   Label20(13).Left = Label20(12).Left + flxClient.ColWidth(1)
   
   
   
   
   Dim rRow As Integer
    rRow = 1
    'While Not adoRst.EOF
       flxClient.row = 1
       flxClient.RowSel = 1
       flxClient.ColSel = 1
       flxClient.TextMatrix(1, 0) = "  " & "1"
       flxClient.TextMatrix(1, 1) = "W Ad"
       flxClient.TextMatrix(1, 2) = "Weekly In Advance"
       flxClient.RowHeight(1) = 280
       flxClient.AddItem ""
       
       
       flxClient.TextMatrix(2, 0) = "  " & "2"
       flxClient.TextMatrix(2, 1) = "W Ar"
       flxClient.TextMatrix(2, 2) = "Weekly In Arrears"
       flxClient.RowHeight(2) = 280
       flxClient.AddItem ""
       
       
       flxClient.TextMatrix(3, 0) = "  " & "3"
       flxClient.TextMatrix(3, 1) = "F Ad"
       flxClient.TextMatrix(3, 2) = "Fortnightly In Advance"
       flxClient.RowHeight(3) = 280
       flxClient.AddItem ""
       
       
       flxClient.TextMatrix(4, 0) = "  " & "4"
       flxClient.TextMatrix(4, 1) = "F Ar"
       flxClient.TextMatrix(4, 2) = "Fortnightly In Arrears"
       flxClient.RowHeight(4) = 280
       flxClient.AddItem ""
       
       flxClient.TextMatrix(5, 0) = "  " & "5"
       flxClient.TextMatrix(5, 1) = "M Ad"
       flxClient.TextMatrix(5, 2) = "Monthly In Advance"
       flxClient.RowHeight(5) = 280
       flxClient.AddItem ""
       
       flxClient.TextMatrix(6, 0) = "  " & "6"
       flxClient.TextMatrix(6, 1) = "M Ar"
       flxClient.TextMatrix(6, 2) = "Monthly In Arrears"
       flxClient.RowHeight(6) = 280
       flxClient.AddItem ""
       
       
       flxClient.TextMatrix(7, 0) = "  " & "7"
       flxClient.TextMatrix(7, 1) = "Q Ad"
       flxClient.TextMatrix(7, 2) = "Quarterly In Advance"
       flxClient.RowHeight(7) = 280
       flxClient.AddItem ""
       
       
       flxClient.TextMatrix(8, 0) = "  " & "8"
       flxClient.TextMatrix(8, 1) = "Q Ar"
       flxClient.TextMatrix(8, 2) = "Quarterly In Arrears"
       flxClient.RowHeight(8) = 280
       flxClient.AddItem ""
       
       
       flxClient.TextMatrix(9, 0) = "  " & "9"
       flxClient.TextMatrix(9, 1) = "HF Ad"
       flxClient.TextMatrix(9, 2) = "Half Yearly In Advance"
       flxClient.RowHeight(9) = 280
       flxClient.AddItem ""
       
       
       flxClient.TextMatrix(10, 0) = "  " & "10"
       flxClient.TextMatrix(10, 1) = "HF Ar"
       flxClient.TextMatrix(10, 2) = "Half Yearly In Arrears"
       flxClient.RowHeight(10) = 280
       flxClient.AddItem ""
       
       
       flxClient.TextMatrix(11, 0) = "  " & "11"
       flxClient.TextMatrix(11, 1) = "Y Ad"
       flxClient.TextMatrix(11, 2) = "Yearly In Advance"
       flxClient.RowHeight(11) = 280
       flxClient.AddItem ""
       
       flxClient.TextMatrix(12, 0) = "  " & "12"
       flxClient.TextMatrix(12, 1) = "Y Ar"
       flxClient.TextMatrix(12, 2) = "Yearly In Arrears"
       flxClient.RowHeight(12) = 280
       flxClient.AddItem ""
       
       flxClient.TextMatrix(13, 0) = "  " & "13"
       flxClient.TextMatrix(13, 1) = "Daily"
       flxClient.TextMatrix(13, 2) = "Daily"
       flxClient.RowHeight(13) = 280
       flxClient.AddItem ""
       
       flxClient.TextMatrix(14, 0) = "  " & "14"
       flxClient.TextMatrix(14, 1) = "4W Ad"
       flxClient.TextMatrix(14, 2) = "4 Weekly in Advance"
       flxClient.RowHeight(14) = 280
       flxClient.AddItem ""
       
       flxClient.TextMatrix(15, 0) = "  " & "15"
       flxClient.TextMatrix(15, 1) = "4W Ar"
       flxClient.TextMatrix(15, 2) = "4 Weekly in Arrears"
       flxClient.RowHeight(15) = 280
       flxClient.AddItem ""
       
       flxClient.TextMatrix(16, 0) = "  " & "16"
       flxClient.TextMatrix(16, 1) = "4M Ad"
       flxClient.TextMatrix(16, 2) = "4 Monthly in Advance"
       flxClient.RowHeight(16) = 280
       flxClient.AddItem ""
       
       flxClient.TextMatrix(17, 0) = "  " & "17"
       flxClient.TextMatrix(17, 1) = "4M Ar"
       flxClient.TextMatrix(17, 2) = "4 Monthly in Arrears"
       flxClient.RowHeight(17) = 280
       flxClient.AddItem ""
       
    'Wend
      
'   End If
End Sub
Private Sub LoadJobs(conConnection As ADODB.Connection)
   Dim adoRST As New ADODB.Recordset
   Dim SQLStr1 As String
   SQLStr1 = "SELECT ID, Job_DiaryName,H.MaintenanceType " & _
           "FROM PropertyMaintHistory AS H, SecondaryCode AS S " & _
           "WHERE  S.Code = H.MaintenanceType AND S.PrimaryCode = 'MTYP' AND H.PropertyID = '" & txtDmdPropertyList.text & "' " & _
           "ORDER BY ID;"
   adoRST.Open SQLStr1, conConnection, adOpenKeyset, adLockReadOnly
   
   txtSearchClientID.text = ""
   txtSearchClientID.Left = 250
   
   txtSearchClientID.Width = 2700
   txtSearchClientName.Visible = False
   
   txtSearchClientName.text = ""
   flxClient.RowHeight(0) = 0
   flxClient.Cols = 3
   
'   flxClient.ColWidth(0) = 200
'   flxClient.ColWidth(1) = 0
'   flxClient.ColWidth(2) = 3000
'   picClient.Width = 3500
'   cmdPicCLose.Left = 3200
'   txtSearchClientID.Left = 45

   flxClient.ColWidth(0) = 1000
   flxClient.ColWidth(1) = 2300
   flxClient.ColWidth(2) = 1400
   txtSearchClientID.Width = 1430
   txtSearchClientName.Visible = True
   picClient.Width = 5295
   flxClient.Width = 5175
   cmdPicCLose.Left = 5010
   txtSearchClientID.Left = 1090
   txtSearchClientID.ZOrder 0
   txtSearchClientID.Width = 2250
   txtSearchClientName.Left = 3380
   txtSearchClientName.Width = 1400
   Label20(14).Visible = True
    picClient.Height = 3095
   flxClient.Height = 2345
   
   flxClient.Clear
   flxClient.Rows = 2
   flxClient.ColAlignment(0) = vbLeftJustify
   flxClient.ColAlignment(1) = vbLeftJustify
   flxClient.ColAlignment(2) = vbLeftJustify

   '~~~ Added by Anol Configuring width and position of labels and search boxes.
   Label20(12).Caption = "Job No"
   Label20(13).Caption = "Job Type"
   Label20(12).Width = 1400
   Label20(12).Left = 350
   Label20(13).Width = 3600
   Label20(13).Left = 3600
   
   
'   ReDim szaJobCode(adoRst.RecordCount, 2) As String
   
   Dim rRow As Integer
   If adoRST.EOF Then
      'MsgBox "Fund has not been setup for this company.", vbExclamation, "Load Fund in Global"
   Else
       If strCommandSource = "13" Then
            rRow = 1
            While Not adoRST.EOF
               flxClient.row = 1
               flxClient.RowSel = 1
               flxClient.ColSel = 1
               flxClient.TextMatrix(rRow, 0) = adoRST.Fields.Item("ID").Value
               flxClient.TextMatrix(rRow, 1) = adoRST.Fields.Item("Job_DiaryName").Value
               flxClient.TextMatrix(rRow, 2) = adoRST.Fields.Item("MaintenanceType").Value
'               szaJobCode(rRow - 1, 0) = adoRst.Fields.Item("ID").Value
'               szaJobCode(rRow - 1, 1) = adoRst.Fields.Item("Job_DiaryName").Value
'               szaJobCode(rRow - 1, 2) = adoRst.Fields.Item("MaintenanceType").Value
                flxClient.RowHeight(rRow) = 280
               adoRST.MoveNext
               If Not adoRST.EOF Then flxClient.AddItem ""
               rRow = rRow + 1
            Wend
       End If
   End If
End Sub
Private Sub cmdManualDmdCancel_Click()
   fraInvCrChoice.Visible = False
   cmdGenerateManual.Enabled = True
End Sub

Private Sub LoadNominalCodeBk()
   flxLeaseList.Clear
   flxLeaseList.Rows = 2
   flxLeaseList.Cols = 4
   flxLeaseList.ColWidth(1) = 800
   flxLeaseList.ColWidth(2) = 2500
   flxLeaseList.ColAlignment = vbLeftJustify

   '~~~ Added by Senthuran~~~ Configuring width and position of labels and search boxes.
   flxLeaseList.ColWidth(0) = 0
   flxLeaseList.ColWidth(3) = 0
   Label20(0).Width = 1400
   Label20(0).Left = 50
   Label20(1).Width = 2600
   Label20(1).Left = Label20(0).Left + flxLeaseList.ColWidth(1)

   txtTenantSearchID.Width = 700
   txtTenantSearchID.Left = 40

   txtTenantSearchName.Width = 2400
   txtTenantSearchName.Left = txtTenantSearchID.Left + flxLeaseList.ColWidth(1)

   txtTenantSearchUnitName.Visible = False

   '~~~Added By Senthuran~~~ Code to configuer Label Caption
   Label20(0).Caption = "Code"
   Label20(1).Caption = "Name"
   Label20(2).Visible = False

   '~~~ End of config

' Error Handler
  On Error GoTo Error_Handler

   Dim adoConn As New ADODB.Connection
   Dim rRow As Integer, iRec As Integer
   Dim adoRST As New ADODB.Recordset
   Dim szSQL As String

   adoConn.Open getConnectionString

   szSQL = "SELECT NominalLedger.* FROM NominalLedger ORDER BY CODE;"
   adoRST.Open szSQL, adoConn, adOpenStatic, adLockReadOnly

   Dim i As Integer
   i = 1
   While Not adoRST.EOF
      flxLeaseList.TextMatrix(i, 1) = adoRST.Fields.Item("Code").Value
      flxLeaseList.TextMatrix(i, 2) = adoRST.Fields.Item("Name").Value

      i = i + 1
      adoRST.MoveNext
      If Not adoRST.EOF Then flxLeaseList.AddItem ""
   Wend

   ' Destroy Objects
   Set adoRST = Nothing
   Set adoConn = Nothing

   flxLeaseList.Sort = 1
'   flxLeaseList.RowHeight(1) = 0
   Exit Sub

' Error Handling Code
Error_Handler:

   ' Destroy Objects
   Set adoRST = Nothing
   Set adoConn = Nothing
End Sub

Private Function SelectedDemandID(ByRef SelDmdID() As String) As String
   Dim i As Integer
   Dim j As Integer
    
   SelectedDemandID = ""
   For i = 1 To flxDemands.Rows - 1
      If flxDemands.TextMatrix(i, 0) = "X" Then
'         SelectedDemandID = SelectedDemandID & CStr(Val(flxDemands.TextMatrix(i, 1)))
'         SelectedDemandID = SelectedDemandID & ","
        j = j + 1
      End If
   Next i
   ReDim SelDmdID(j) As String
   j = 0
   For i = 1 To flxDemands.Rows - 1
      If flxDemands.TextMatrix(i, 0) = "X" Then
         SelDmdID(j) = "" & CStr(flxDemands.TextMatrix(i, 1)) & ""
         j = j + 1
      End If
   Next i
   
'   If SelectedDemandID <> "" Then
'      SelectedDemandID = Left(SelectedDemandID, Len(SelectedDemandID) - 1)
'   Else
'      SelectedDemandID = ""
'   End If
End Function
Private Function SelectedDemandID_old() As String
   Dim i As Integer
   Dim j As Integer
    
   SelectedDemandID_old = ""
   For i = 1 To flxDemands.Rows - 1
      If flxDemands.TextMatrix(i, 0) = "X" Then
         SelectedDemandID_old = SelectedDemandID_old & CStr(Val(flxDemands.TextMatrix(i, 1)))
         SelectedDemandID_old = SelectedDemandID_old & ","
        j = j + 1
      End If
   Next i
'   ReDim SelDmdID(j) As String
'   j = 0
'   For i = 1 To flxDemands.Rows - 1
'      If flxDemands.TextMatrix(i, 0) = "X" Then
'         SelDmdID(j) = "" & CStr(flxDemands.TextMatrix(i, 1)) & ""
'         j = j + 1
'      End If
'   Next i
   
   If SelectedDemandID_old <> "" Then
      SelectedDemandID_old = Left(SelectedDemandID_old, Len(SelectedDemandID_old) - 1)
   Else
      SelectedDemandID_old = ""
   End If
End Function

Private Function DateRangeDemandID(dtFrom As Date, dtTo As Date, ByRef SelDmdID() As String) As String
   Dim i As Integer
   Dim j As Integer

'   DateRangeDemandID = ""
   For i = 1 To flxDemands.Rows - 1
      If CDate(flxDemands.TextMatrix(i, 6)) >= dtFrom And CDate(flxDemands.TextMatrix(i, 6)) <= dtTo Then
'         DateRangeDemandID = DateRangeDemandID & CStr(Val(flxDemands.TextMatrix(i, 1)))
'         DateRangeDemandID = DateRangeDemandID & ","
          j = j + 1
      End If
   Next i
   ReDim SelDmdID(j) As String
   j = 0
   For i = 1 To flxDemands.Rows - 1
      If CDate(flxDemands.TextMatrix(i, 6)) >= dtFrom And CDate(flxDemands.TextMatrix(i, 6)) <= dtTo Then
            SelDmdID(j) = "" & CStr(flxDemands.TextMatrix(i, 1)) & ""
             j = j + 1
      End If
   Next i
   
'   DateRangeDemandID = Left(DateRangeDemandID, Len(DateRangeDemandID) - 1)
End Function

Private Function FullyPaidDemandID(adoConn As ADODB.Connection, ByRef SelDmdID() As String) As String
   Dim i          As Integer
  
   Dim szSQL      As String
   Dim adoRST     As New ADODB.Recordset

   szSQL = "SELECT D.DemandID " & _
           "FROM tlbReceipt AS R INNER JOIN DemandRecords AS D ON R.DemandRef = D.DemandID " & _
           "WHERE R.OSAmount = 0 AND D.TransactionType = 1 AND D.DemandHistory = FALSE;"

   adoRST.Open szSQL, adoConn, adOpenStatic, adLockReadOnly

'   FullyPaidDemandID = ""
   ReDim SelDmdID(adoRST.RecordCount) As String
   If adoRST.RecordCount = 0 Then GoTo NoRecord
   While Not adoRST.EOF
'      FullyPaidDemandID = FullyPaidDemandID & adoRst.Fields.Item(0).Value
'      FullyPaidDemandID = FullyPaidDemandID & ","
       SelDmdID(i) = adoRST.Fields.Item(0).Value
       i = i + 1
      adoRST.MoveNext
   Wend
   adoRST.Close
'   FullyPaidDemandID = Left(FullyPaidDemandID, Len(FullyPaidDemandID) - 1)

NoRecord:

   Set adoRST = Nothing
End Function

Private Function PrintedDemand(ByRef SelDmdID() As String) As String
   Dim i As Integer
   Dim j  As Integer
'   PrintedDemand = ""
'   X = 0
   For i = 1 To flxDemands.Rows - 1
      If flxDemands.TextMatrix(i, 9) = "YES" Then
'         PrintedDemand = PrintedDemand & CStr(Val(flxDemands.TextMatrix(i, 1)))
'         PrintedDemand = PrintedDemand & ","
         j = j + 1
      End If
   Next i
   ReDim SelDmdID(j) As String
   j = 0
   For i = 1 To flxDemands.Rows - 1
      If flxDemands.TextMatrix(i, 9) = "YES" Then
         SelDmdID(j) = CStr(Val(flxDemands.TextMatrix(i, 1)))
         j = j + 1
      End If
   Next i
   
'   PrintedDemand = Left(PrintedDemand, Len(PrintedDemand) - 1)
End Function

Private Function EmailedDemand(ByRef SelDmdID() As String) As String
   Dim i As Integer
    Dim j  As Integer

'   EmailedDemand = ""
'   X = 0
   For i = 1 To flxDemands.Rows - 1
      If flxDemands.TextMatrix(i, 11) = "YES" Then
'         EmailedDemand = EmailedDemand & CStr(Val(flxDemands.TextMatrix(i, 1)))
'         EmailedDemand = EmailedDemand & ","
           j = j + 1
      End If
   Next i
   ReDim SelDmdID(j) As String
   j = 0
   For i = 1 To flxDemands.Rows - 1
      If flxDemands.TextMatrix(i, 11) = "YES" Then
         SelDmdID(j) = CStr(Val(flxDemands.TextMatrix(i, 1)))
          j = j + 1
      End If
   Next i
   
   
'   EmailedDemand = Left(EmailedDemand, Len(EmailedDemand) - 1)
End Function

Private Function SINoRangeDemand(lNoFrom As Long, lNoTo As Long, ByRef SelDmdID() As String) As String
   Dim i As Integer
   Dim l As Long
   Dim j As Integer

   If lNoTo < lNoFrom Then
      l = lNoTo
      lNoTo = lNoFrom
      lNoFrom = l
   End If
   j = lNoTo - lNoFrom + 1
   ReDim SelDmdID(j) As String
   j = 0
'   SINoRangeDemand = ""
   For i = 1 To flxDemands.Rows - 1
      If Left(flxDemands.TextMatrix(i, 2), 2) = "SI" Then
         If StrDigitVal(flxDemands.TextMatrix(i, 2)) >= lNoFrom And StrDigitVal(flxDemands.TextMatrix(i, 2)) <= lNoTo Then
'            SINoRangeDemand = SINoRangeDemand & CStr(StrDigitVal(flxDemands.TextMatrix(i, 1)))
'            SINoRangeDemand = SINoRangeDemand & ","
             SelDmdID(j) = CStr(StrDigitVal(flxDemands.TextMatrix(i, 1)))
             j = j + 1
         End If
      End If
   Next i
'   SINoRangeDemand = Left(SINoRangeDemand, Len(SINoRangeDemand) - 1)
End Function

Private Function SCNoRangeDemand(lNoFrom As Long, lNoTo As Long, ByRef SelDmdID() As String) As String
   Dim i As Integer
   Dim l As Long
   Dim j As Integer

   If lNoTo < lNoFrom Then
      l = lNoTo
      lNoTo = lNoFrom
      lNoFrom = l
   End If
    j = lNoTo - lNoFrom + 1
    ReDim SelDmdID(j) As String
    j = 0
'   SCNoRangeDemand = ""
   For i = 1 To flxDemands.Rows - 1
      If Left(flxDemands.TextMatrix(i, 2), 2) = "SC" Then
         If StrDigitVal(flxDemands.TextMatrix(i, 2)) >= lNoFrom And _
               StrDigitVal(flxDemands.TextMatrix(i, 2)) <= lNoTo Then
               
'            SCNoRangeDemand = SCNoRangeDemand & CStr(StrDigitVal(flxDemands.TextMatrix(i, 1)))
'            SCNoRangeDemand = SCNoRangeDemand & ","
             SelDmdID(j) = CStr(StrDigitVal(flxDemands.TextMatrix(i, 1)))
             j = j + 1

         End If
      End If
   Next i
'   SCNoRangeDemand = Left(SCNoRangeDemand, Len(SCNoRangeDemand) - 1)
End Function

Public Sub PostDemands()
'   On Error GoTo ERR
   Dim szDmdID As String
   Dim SQLStr1 As String
   Dim iPosted As Integer               'Finally posted
   Dim iDP     As Integer               'To be posted
   Dim adoConn As New ADODB.Connection
   Dim adoRST  As New ADODB.Recordset
   Dim K As Integer
   Dim j As Integer
    
   Dim SelDmdID() As String
   adoConn.Open getConnectionString

   If frmPopUpMenu.optDPSelDmds.Value Then szDmdID = SelectedDemandID(SelDmdID())
   If frmPopUpMenu.optDPDtRange.Value Then szDmdID = DateRangeDemandID(CDate(frmPopUpMenu.txtDPDtRangeFrom.text), CDate(frmPopUpMenu.txtDPDtRangeTo.text), SelDmdID())
   If frmPopUpMenu.optDPFPDemands.Value Then szDmdID = FullyPaidDemandID(adoConn, SelDmdID())
   
   If frmPopUpMenu.optDPPrintedDmds.Value Then szDmdID = PrintedDemand(SelDmdID())
   If frmPopUpMenu.optDPEmailDmds.Value Then szDmdID = EmailedDemand(SelDmdID())
   If frmPopUpMenu.optDPSlNoRange.Value Then
      If frmPopUpMenu.optSI Then szDmdID = SINoRangeDemand(frmPopUpMenu.txtDPSlRangeFrom.text, frmPopUpMenu.txtDPSlRangeTo.text, SelDmdID())
      If frmPopUpMenu.optSC Then szDmdID = SCNoRangeDemand(frmPopUpMenu.txtDPSlRangeFrom.text, frmPopUpMenu.txtDPSlRangeTo.text, SelDmdID())
   End If

   j = UBound(SelDmdID())
   If j = 0 Then
      MsgBox "No demand to post to history.", vbInformation, "No demand to post"
      adoConn.Close
      Set adoConn = Nothing
      Exit Sub
   End If
   Dim i As Integer
''    'Fixed by anol 9 July 2015
''   Dim intcountSeleted As Integer
''   intcountSeleted = 0
''   For i = 1 To flxDemands.Rows - 1
''      If flxDemands.TextMatrix(i, 0) = "X" Then
''         intcountSeleted = intcountSeleted + 1
''      End If
''   Next i
''   'End of addition

   K = CInt(j / 50)
   
   If K = j / 50 Then
        'No no need to do ceiling, this is fully divisible
        K = j / 50
   Else
        K = CInt(j / 50) + 1 'This is ceiling function
   End If
   Dim rsCheck As New ADODB.Recordset
   
   For K = 0 To K - 1
           szDmdID = ReturnString(K * 50, (K + 1) * 50 - 1, SelDmdID())
           If szDmdID = "" Then
                Exit For
           End If
           SQLStr1 = "UPDATE DemandRecords " & _
             "SET DemandRecords.DemandHistory=TRUE " & _
             "WHERE DemandRecords.IsPrinted = TRUE AND " & _
                  "DemandRecords.DemandID IN (" & szDmdID & ");"
           adoConn.Execute SQLStr1
           If Len(szDmdID) > 0 Then
                    rsCheck.Open "Select * from  DemandRecords " & _
                   "WHERE DemandRecords.IsPrinted = False AND " & _
                        "DemandRecords.DemandID IN (" & szDmdID & ");", adoConn, adOpenKeyset, adLockReadOnly
                        If Not rsCheck.EOF Then
                              MsgBox "Please ensure you have printed your demands before posting them to demand history", vbInformation, "Warning"
                        End If
                        rsCheck.Close
        End If
                
                  
'           Debug.Print szDmdID
'           Debug.Print k
            
            'DemandID is a number field
   Next
   
   
   
'   SQLStr1 = "UPDATE DemandRecords " & _
'             "SET DemandRecords.DemandHistory=TRUE " & _
'             "WHERE DemandRecords.IsPrinted = TRUE AND " & _
'                  "DemandRecords.DemandID IN (" & szDmdID & ");"
'
'   adoconn.Execute SQLStr1
'## Clearning all 0 amount invoices to history from the grid
   SQLStr1 = "SELECT COUNT(*) AS Z " & _
             "From " & _
             "(" & _
               "SELECT SUM(DS.TOTALAMOUNT) AS TOTAL, DR.DemandID " & _
               "FROM DEMANDRECORDS AS DR, DEMANDSPLITRECORDS AS DS " & _
               "WHERE DR.DEMANDID=DS.DEMANDID AND " & _
                  "DR.DEMANDHISTORY = False " & _
               "GROUP BY DR.DemandID " & _
             ") AS X " & _
             "WHERE X.TOTAL=0;"
'Debug.Print SQLStr1
   adoRST.Open SQLStr1, adoConn, adOpenStatic, adLockReadOnly

   If adoRST.Fields.Item("Z").Value > 0 Then
      If MsgBox("Do you wish to post 0 amount invoice to history?", vbQuestion + vbYesNo, "Posting to History") = vbYes Then
         SQLStr1 = "UPDATE DemandRecords AS DR " & _
                   "Set DR.DEMANDHISTORY = True " & _
                   "WHERE DR.DemandID IN " & _
                   "( " & _
                     "SELECT DemandID FROM " & _
                     "( " & _
                        "SELECT SUM(DS.TOTALAMOUNT) AS TOTAL, DR1.DemandID " & _
                        "FROM DEMANDRECORDS AS DR1, DEMANDSPLITRECORDS AS DS " & _
                        "Where DR1.DemandId = DS.DemandId And DR1.DEMANDHISTORY = False " & _
                        "GROUP BY DR1.DemandID " & _
                     ") AS X " & _
                     "Where X.Total = 0 " & _
                   ");"
         adoConn.Execute SQLStr1
      End If
   End If

   adoRST.Close
   Set adoRST = Nothing
   Dim intinvCount1 As Integer
   Dim intinvCount2 As Integer
   'Fixed by anol 1 July 2015
   'Invoice count was not showing properly for the posting to history
'   intinvCount1 = flxDemandHistory.Rows
'   If intinvCount1 > 1 Then
'       If flxDemandHistory.TextMatrix(1, 0) = "" Then
'            intinvCount1 = intinvCount1 - 1
'       End If
'
'   End If
   LoadFlxGrid flxDemandHistory, True, adoConn, ""  'True - uploading history records
   intinvCount2 = flxDemandHistory.Rows
   'LoadFlxGrid flxDemands, False, adoConn, ""       'False - uploading history, which are already posted and printed and exported to sage
    LoadFlxDemands adoConn, ""
   ConfigFlxGrid flxChildDemands
   If chkSelectAllDemands.Value Then chkSelectAllDemands.Value = 0
   If Len(szDmdID) > 0 Then
        SQLStr1 = "SELECT COUNT(*) " & _
                  "FROM DemandRecords " & _
                  "WHERE DemandRecords.DemandHistory = FALSE AND " & _
                       "DemandRecords.DemandID IN (" & szDmdID & ");"
        adoRST.Open SQLStr1, adoConn, adOpenStatic, adLockReadOnly
        iPosted = CInt(adoRST.Fields.Item(0).Value)
        adoRST.Close
        Set adoRST = Nothing
   Else
        iPosted = 0
   End If
   MousePointer = vbDefault

   adoConn.Close
   Set adoConn = Nothing
'   If iDP - iPosted < 0 Then
'      ShowMsgInTaskBar "System could not post any demands to history", "Y", "P"
'   Else
      'ShowMsgInTaskBar "System has posted " & iDP - iPosted & " demands to history", "Y", "P"
   If j = 1 Then
        ShowMsgInTaskBar j & " invoice has been posted to history"
   Else
        ShowMsgInTaskBar j & " invoices have been posted to history"
   End If
      'ShowMsgInTaskBar j & " demands has been posted to history", "Y", "P"
'   End If
    Exit Sub
Err:
    'MsgBox Err.description
End Sub

Private Sub cmdPostDemands_Click()
   Dim szTemp As String
   Dim SelDmdID() As String
   Dim j As Integer
'
'   frmPopUpMenu.Top = frmMMain.fraCmdButton.Height + cmdPostDemands.Top + frmDemands3.Top + fraEditDemand.Top + tabDmdRcpt.Top + 1160
'   frmPopUpMenu.Left = frmMMain.tvwLandLord.Width + frmDemands3.Left + fraEditDemand.Left + tabDmdRcpt.Left + cmdPostDemands.Left + 80
   frmPopUpMenu.CallingFrom "PostDemands"

   szTemp = SelectedDemandID(SelDmdID())
   j = UBound(SelDmdID())
   If j > 0 Then
      frmPopUpMenu.optDPSelDmds.Value = True
   Else
      frmPopUpMenu.optDPSelDmds.Value = False
      frmPopUpMenu.optDPSelDmds.Enabled = False
   End If

   frmPopUpMenu.Show 1
End Sub

Private Function CheckDemandTypePrintingTemplate() As Boolean
   Dim adoDemandType As New ADODB.Recordset
   Dim adoConn As New ADODB.Connection
   Dim strSQL As String

   adoConn.Open getConnectionString

   strSQL = "SELECT DemandReportName " & _
            "FROM DemandTypes " & _
            "WHERE ID > 0;"
   adoDemandType.Open strSQL, adoConn, adOpenStatic, adLockReadOnly

   CheckDemandTypePrintingTemplate = True
   While Not adoDemandType.EOF
      If IIf(IsNull(adoDemandType.Fields(0).Value), "", adoDemandType.Fields(0).Value) = "" Then
         CheckDemandTypePrintingTemplate = False
      End If
      adoDemandType.MoveNext
   Wend
   adoDemandType.Close
   Set adoDemandType = Nothing
   adoConn.Close
   Set adoConn = Nothing
End Function

Private Sub cmdPrintAll_Click()
   Call ChangeReportODBC
   If CheckDemandTypePrintingTemplate Then
      Me.Enabled = False

      Load frmDemandTypesSel
      frmDemandTypesSel.szCallingFrom = "Print All Demands"
      frmDemandTypesSel.Caption = "Print All Demands - Options"
      frmDemandTypesSel.Show
   Else
      MsgBox "Demand will not be printed." & Chr(10) & _
             "Please set the report name of all demand types.", vbCritical + vbOKOnly, "Demand Printing"
   End If
End Sub

Private Sub cmdPrintStatement_Click()
    Dim adoConn As New ADODB.Connection
    Dim strSQLTitles As String
    ' Declare Objects
    Dim rRow As Integer
    Call ChangeReportODBC
    ' Declare Variables
    Dim szDataPath As String
    Dim rsMinDueDate As New ADODB.Recordset
    Dim szSQL As String
    Dim adoRptDr As New ADODB.Recordset
   If iSelectedDemandsRow < 1 Then
      MsgBox "Please select atleast one demand from the grid.", vbCritical, "No demand selected"
      Exit Sub
   End If

   Dim iRow As Integer, szWhere As String, iTemp As Integer
   Dim adoRstDRecords   As New ADODB.Recordset
   Dim adoRstDRCurrent  As New ADODB.Recordset
   Dim adoTenants       As New ADODB.Recordset

   adoConn.Open getConnectionString

   adoConn.Execute "DELETE * FROM tlbDRCURRENTPRINT;"

   strSQLTitles = "SELECT * FROM tlbDRCURRENTPRINT;"
   adoRstDRCurrent.Open strSQLTitles, adoConn, adOpenDynamic, adLockPessimistic

'*********************************************************************************************
   For iRow = 1 To flxDemands.Rows - 1
      If flxDemands.TextMatrix(iRow, 0) = "X" Then

         szWhere = "DR.DEMANDID = " + CStr(CLng(flxDemands.TextMatrix(iRow, 1))) + ""
         strSQLTitles = "SELECT DR.DEMANDID AS D_ID, DR.BATCHID AS B_ID, " & _
                           "DR.SAGEACCOUNTNUMBER AS S_AC, " & _
                           "DR.UNITNUMBER AS U_NUM, DR.SOURCE AS SOU, " & _
                           "DR.TRANSACTIONTYPE AS T_TYPE, DSR.DSR, " & _
                           "DR.ISSUEDATE AS IDT, DR.GenerateDemand AS CS, DSR.A_M AS A_M, " & _
                           "DSR.splitid as S_ID, DSR.NOMINALCODEFORAMOUNT AS NCA, " & _
                           "DSR.NOMINALNAMEFORAMOUNT AS NNA, DSR.NOMINALCODEFORVAT AS NCV, DSR.NOMINALNAMEFORVAT AS NNV, DSR.NOMINALCODEFORTOTAL AS NCT, DSR.NOMINALNAMEFORTOTAL AS NNT, " & _
                           "DSR.AMOUNT AS AMT, DSR.VATAMOUNT AS VAMT, " & _
                           "DSR.TOTALAMOUNT AS TAMT, DSR.SAGEREF AS SREF, DSR.DUEDATE AS DDT, " & _
                           "DSR.VATMONTH AS VMTH, DSR.TYPEOFDEMAND AS TDM, " & _
                           "DSR.DESCRIPTION AS DESCR, DSR.DEMANDSTATEMENT AS D_ST, " & _
                           "DSR.DATEFROM AS D_FROM, " & _
                           "DSR.DATETO AS D_TO, Tenants.spare1, " & _
                           "DSR.ChargingFigure, DemandTypes.DTGroup, " & _
                           "DemandTypes.DemandReportName AS DRN, DemandTypes.CategoryCode AS CC "
         strSQLTitles = strSQLTitles & _
                        "FROM DemandRecords as DR, DemandSplitRecords as DSR, Tenants, DemandTypes "
         strSQLTitles = strSQLTitles & _
                        "WHERE (" & szWhere & ") AND " & _
                           "DSR.DEMANDID = DR.DEMANDID AND " & _
                           "Tenants.SAGEACCOUNTNUMBER = DR.SAGEACCOUNTNUMBER AND " & _
                           "DSR.TYPEOFDEMAND = DemandTypes.ID " & _
                        "ORDER BY DSR.splitid;"
'Debug.Print strSQLTitles
         adoRstDRecords.Open strSQLTitles, adoConn, adOpenDynamic, adLockPessimistic

'      GET N UNDATE THE INVOICE NUMBER
         strSelectedPrintRef = Format(NextRef(adoConn, "PRINT_REF"), "00000000")

         While Not adoRstDRecords.EOF
            If IsNull(adoRstDRecords.Fields.Item("spare1").Value) Or InStr(adoRstDRecords.Fields.Item("spare1").Value, "NotS") = 0 Then
               adoRstDRCurrent.AddNew

               adoRstDRCurrent.Fields("UniqueRefNumber").Value = adoRstDRecords.Fields("D_ID").Value
               adoRstDRCurrent.Fields("Batch").Value = adoRstDRecords.Fields("B_ID").Value
               adoRstDRCurrent.Fields("AutomaticManual").Value = adoRstDRecords.Fields("A_M").Value
               adoRstDRCurrent.Fields("SageAccountNumber").Value = adoRstDRecords.Fields("S_AC").Value
               
               szSQL = "SELECT sum(SWITCH(TYPE =1,Amount,TYPE =23,Amount,TYPE =2,-Amount,TYPE =3,-Amount,TYPE =4,-Amount))  as Amt, " & _
                  "tlbReceipt.SageAccountNumber  From tlbReceipt where SageAccountNumber='" & adoRstDRecords.Fields("S_AC").Value & _
                  "'  group by SageAccountNumber "
                  'AND RDate <=#" & Format(adoRstDRecords.Fields("IDT").Value, "dd MMM yyyy") & "#
                  adoRptDr.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
                  If Not adoRptDr.EOF Then
                        adoConn.Execute "Update Tenants set Balance=" & IIf(IsNull(adoRptDr("amt").Value), 0, adoRptDr("amt").Value) _
                        & "  where SageAccountNumber='" & adoRstDRecords.Fields("S_AC").Value & "' "
                  End If
                  adoRptDr.Close

               adoRstDRCurrent.Fields("UnitNumber").Value = adoRstDRecords.Fields("U_NUM").Value
               adoRstDRCurrent.Fields("NominalCodeforAmount").Value = adoRstDRecords.Fields("NCA").Value
               adoRstDRCurrent.Fields("NominalNameforAmount").Value = adoRstDRecords.Fields("NNA").Value
               adoRstDRCurrent.Fields("NominalCodeforVAT").Value = adoRstDRecords.Fields("NCV").Value
               adoRstDRCurrent.Fields("NominalNameforVAT").Value = adoRstDRecords.Fields("NNV").Value
               adoRstDRCurrent.Fields("NominalCodeforTotal").Value = adoRstDRecords.Fields("NCT").Value
               adoRstDRCurrent.Fields("NominalNameforTotal").Value = adoRstDRecords.Fields("NNT").Value
               adoRstDRCurrent.Fields("Source").Value = adoRstDRecords.Fields("SOU").Value
               adoRstDRCurrent.Fields("TransactionType").Value = adoRstDRecords.Fields("T_TYPE").Value
               adoRstDRCurrent.Fields("IssueDate").Value = adoRstDRecords.Fields("IDT").Value
               adoRstDRCurrent.Fields("VATMonth").Value = adoRstDRecords.Fields("VMTH").Value
               adoRstDRCurrent.Fields("Typeofdemand").Value = adoRstDRecords.Fields("TDM").Value
               adoRstDRCurrent.Fields("Reference").Value = adoRstDRecords.Fields("SREF").Value
               adoRstDRCurrent.Fields("Description").Value = adoRstDRecords.Fields("DESCR").Value
               adoRstDRCurrent.Fields("PRINT_ID").Value = strSelectedPrintRef
               adoRstDRCurrent.Fields("DTCategory").Value = adoRstDRecords.Fields("CC").Value

               If adoRstDRecords.Fields("D_ST").Value Then
                  adoRstDRCurrent.Fields("DueDate").Value = adoRstDRecords.Fields("DDT").Value
                  rsMinDueDate.Open "Select MIN(DUEDATE) as mindate From DemandSplitRecords DSR where DSR.DEMANDID = " + CStr(CLng(flxDemands.TextMatrix(iRow, 1))) + "", adoConn, adOpenKeyset, adLockReadOnly
                      If Not rsMinDueDate.EOF Then
                            adoRstDRCurrent.Fields("MinDueDate").Value = rsMinDueDate.Fields("mindate").Value
                      End If
                  rsMinDueDate.Close
                  adoRstDRCurrent.Fields("TotalAmount").Value = adoRstDRecords.Fields("TAMT").Value
                  adoRstDRCurrent.Fields("VATAmount").Value = adoRstDRecords.Fields("VAMT").Value
                  adoRstDRCurrent.Fields("Amount").Value = adoRstDRecords.Fields("AMT").Value
                  adoRstDRCurrent.Fields("DemandFrom").Value = adoRstDRecords.Fields("D_FROM").Value
                  adoRstDRCurrent.Fields("DemandTo").Value = adoRstDRecords.Fields("D_TO").Value
               End If

               adoRstDRCurrent.Fields.Item("ChargingFigure").Value = adoRstDRecords.Fields.Item("ChargingFigure").Value
               adoRstDRCurrent.Fields.Item("spare1").Value = adoRstDRecords.Fields.Item("DSR").Value
               adoRstDRCurrent.Update
            End If
            adoRstDRecords.MoveNext
         Wend
         adoRstDRecords.Close
      End If
   Next iRow
   adoRstDRCurrent.Close
'  Get all the PropertyID to be printed
   strSQLTitles = "SELECT DISTINCT PropertyID " & _
                  "FROM Units AS U, LeaseDetails AS L, tlbDRCurrentPrint AS P " & _
                  "WHERE U.UnitNumber = L.UnitNumber AND " & _
                      "L.SageAccountNumber = P.SageAccountNumber;"

   adoRstDRCurrent.Open strSQLTitles, adoConn, adOpenStatic, adLockReadOnly

   While Not adoRstDRCurrent.EOF
      strSQLTitles = SeekStFileName(adoConn, adoRstDRCurrent.Fields.Item(0).Value)
      If strSQLTitles = "NULL" Then
         MsgBox "Please set the statement path in the setting.", vbCritical + vbOKOnly, "Statement"
      Else
         ShowReport strSQLTitles
      End If
      adoRstDRCurrent.MoveNext
   Wend

   adoRstDRCurrent.Close
   Set adoRstDRCurrent = Nothing

   Set adoRstDRecords = Nothing

   adoConn.Close
   Set adoConn = Nothing
End Sub

Private Function SeekStFileName(adoConn As ADODB.Connection, szProp As String) As String
   Dim szSQL As String
   Dim adoRST As New ADODB.Recordset

   szSQL = "SELECT StPath " & _
           "FROM GlobalData " & _
           "WHERE PropertyID = '" & szProp & "';"
'Debug.Print szSQL
   adoRST.Open szSQL, adoConn, adOpenStatic, adLockReadOnly

   If Not adoRST.EOF Then
      SeekStFileName = IIf(IsNull(adoRST.Fields.Item(0).Value), "NULL", adoRST.Fields.Item(0).Value)
   End If

   adoRST.Close
   Set adoRST = Nothing
End Function
Private Function addFreqID(adoConn As ADODB.Connection)
        Dim Rst1 As New ADODB.Recordset
        On Error GoTo createaddFreqID
        Rst1.Open "SELECT FreqID  FROM LeaseDetails ;", adoConn, adOpenStatic, adLockReadOnly
        If Rst1.State = 1 Then
            Rst1.Close
        End If
        Exit Function
createaddFreqID:
    adoConn.Execute "ALTER TABLE LeaseDetails ADD COLUMN FreqID INTEGER;"
    If Rst1.State = 1 Then
         Rst1.Close
    End If
End Function
Private Sub cmdPrintThis_Click()
   Call ChangeReportODBC
   Dim bPrintMarked As Boolean
   Dim adoConn As New ADODB.Connection
   Dim strSQLTitles As String
   Dim adoRptDr As New ADODB.Recordset
   Dim varAns
'    Declare Objects
   Dim rRow As Integer
   Dim reportApp As New CRAXDRT.Application
   Dim Report As CRAXDRT.Report
   Dim rep As frmReport
   Dim rsMinDueDate As New ADODB.Recordset

'    Declare Variables
   Dim szDataPath As String
   
   Dim rCount As Integer
   iSelectedDemandsRow = 0
   For rCount = 1 To flxDemands.Rows - 1
        If flxDemands.TextMatrix(rCount, 0) = "X" Then
            iSelectedDemandsRow = iSelectedDemandsRow + 1
        End If
   Next
   
   If iSelectedDemandsRow < 1 Then
      MsgBox "Please select atleast one demand from the grid.", vbCritical, "No demand selected"
      Exit Sub
   End If

   adoConn.Open getConnectionString
   
   If DemandPrintIsLocked(adoConn) Then
      MsgBox "The system is busy printing demands, please come back in few minutes.", vbInformation + vbOKOnly, "Demand Printing"
      adoConn.Close
      Set adoConn = Nothing
      Exit Sub
   Else
      DemandPrintLock adoConn
   End If
   
   bPrintMarked = False
   varAns = MsgBox("Do you want to set the status of your demands to ""Printed""?", vbYesNoCancel, "Print Demand")
   bPrintMarked = IIf(varAns = vbYes, True, False)
   If varAns = vbCancel Then Exit Sub

   Dim iRow As Integer, szWhere As String, iTemp As Integer
   Dim adoRstDRecords As New ADODB.Recordset, adoRstDRCurrent As New ADODB.Recordset
   Dim adoTenants As New ADODB.Recordset
''added by anol 28 FEB 2016
''Adding FreqID column to LeaseDetails table
'   Call addFreqID(adoConn)
'   'Updating frequency ID
'   adoConn.Execute "Update LeaseDetails,LRentCharges,Frequencies set LeaseDetails.FreqID =LRentCharges.BRFrequency where Frequencies.ID=LRentCharges.BRFrequency AND LRentCharges.LeaseID=LeaseDetails.LeaseID"
'    adoConn.Execute "Update LeaseDetails,LInsuranceCharges,Frequencies set LeaseDetails.FreqID =LInsuranceCharges.InsuranceFrequency where  Frequencies.ID=LInsuranceCharges.InsuranceFrequency AND LInsuranceCharges.LeaseID=LeaseDetails.LeaseID"
'     adoConn.Execute "Update LeaseDetails,LServiceCharges,Frequencies set LeaseDetails.FreqID =LServiceCharges.SCFrequency where  Frequencies.ID=LServiceCharges.SCFrequency AND LServiceCharges.LeaseID=LeaseDetails.LeaseID"
'   'end of addition
   With adoRstDRCurrent
      adoConn.Execute "DELETE * FROM tlbDRCURRENTPRINT;"
      strSQLTitles = "SELECT * FROM tlbDRCURRENTPRINT;"
      .Open strSQLTitles, adoConn, adOpenDynamic, adLockPessimistic

   '*********************************************************************************************
      For iRow = 1 To flxDemands.Rows - 1
         If flxDemands.TextMatrix(iRow, 0) = "X" Then

            szWhere = "DR.DEMANDID = " + CStr(CLng(flxDemands.TextMatrix(iRow, 1))) + ""
            strSQLTitles = "SELECT DR.DEMANDID AS D_ID, DR.BATCHID AS B_ID, " & _
                              "DR.SAGEACCOUNTNUMBER AS S_AC, " & _
                              "DR.UNITNUMBER AS U_NUM, " & _
                              "DR.TRANSACTIONTYPE AS T_TYPE, DSR.DSR, " & _
                              "DR.ISSUEDATE AS IDT, DR.GenerateDemand AS CS, DSR.A_M AS A_M, " & _
                              "DSR.splitid as S_ID, DSR.NOMINALCODEFORAMOUNT AS NCA, " & _
                              "DSR.NOMINALNAMEFORAMOUNT AS NNA, DSR.NOMINALCODEFORVAT AS NCV, DSR.NOMINALNAMEFORVAT AS NNV, DSR.NOMINALCODEFORTOTAL AS NCT, DSR.NOMINALNAMEFORTOTAL AS NNT, " & _
                              "DSR.AMOUNT AS AMT, DSR.VATAMOUNT AS VAMT, " & _
                              "DSR.TOTALAMOUNT AS TAMT, DSR.SAGEREF AS SREF, DSR.DUEDATE AS DDT, " & _
                              "DSR.VATMONTH AS VMTH, DSR.TYPEOFDEMAND AS TDM, " & _
                              "DSR.DESCRIPTION AS DESCR, DSR.DEMANDSTATEMENT AS D_ST, " & _
                              "DSR.DATEFROM AS D_FROM, DSR.VAT_CODE, " & _
                              "DSR.DATETO AS D_TO, Tenants.spare1, " & _
                              "DSR.ChargingFigure, DemandTypes.DTGroup, " & _
                              "DemandTypes.DemandReportName AS DRN, DemandTypes.CategoryCode AS CC "
            strSQLTitles = strSQLTitles & _
                           "FROM DemandRecords as DR, DemandSplitRecords as DSR, Tenants, DemandTypes "
            strSQLTitles = strSQLTitles & _
                           "WHERE (" & szWhere & ") AND " & _
                              "DSR.DEMANDID = DR.DEMANDID AND " & _
                              "Tenants.SAGEACCOUNTNUMBER = DR.SAGEACCOUNTNUMBER AND " & _
                              "DSR.TYPEOFDEMAND = DemandTypes.ID " & _
                           "ORDER BY DSR.splitid;"
   'Debug.Print strSQLTitles
            adoRstDRecords.Open strSQLTitles, adoConn, adOpenDynamic, adLockPessimistic

   '      GET N UPDATE THE INVOICE NUMBER
            strSelectedPrintRef = Format(NextRef(adoConn, "PRINT_REF"), "00000000")
            Dim szSQL As String
            While Not adoRstDRecords.EOF
               If (IsNull(adoRstDRecords.Fields.Item("spare1").Value) Or _
                     InStr(adoRstDRecords.Fields.Item("spare1").Value, "NotD") = 0) Then
                  .AddNew

                  .Fields("UniqueRefNumber").Value = adoRstDRecords.Fields("D_ID").Value
                  .Fields("Batch").Value = adoRstDRecords.Fields("B_ID").Value
                  .Fields("AutomaticManual").Value = adoRstDRecords.Fields("A_M").Value
                  .Fields("SageAccountNumber").Value = adoRstDRecords.Fields("S_AC").Value
                  'Update the balance of a tenant in tenant table
                  szSQL = "SELECT sum(SWITCH(TYPE =1,Amount,TYPE =23,Amount,TYPE =2,-Amount,TYPE =3,-Amount,TYPE =4,-Amount))  as Amt, " & _
                  "tlbReceipt.SageAccountNumber  From tlbReceipt where SageAccountNumber='" & adoRstDRecords.Fields("S_AC").Value & _
                  "'  group by SageAccountNumber "
                  'AND RDate <=#" & Format(adoRstDRecords.Fields("IDT").Value, "dd MMM yyyy") & "#
                  adoRptDr.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
                  If Not adoRptDr.EOF Then
                        adoConn.Execute "Update Tenants set Balance=" & IIf(IsNull(adoRptDr("amt").Value), 0, adoRptDr("amt").Value) _
                        & "  where SageAccountNumber='" & adoRstDRecords.Fields("S_AC").Value & "' "
                  End If
                  adoRptDr.Close
                  .Fields("UnitNumber").Value = adoRstDRecords.Fields("U_NUM").Value
                  .Fields("NominalCodeforAmount").Value = adoRstDRecords.Fields("NCA").Value
                  .Fields("NominalNameforAmount").Value = adoRstDRecords.Fields("NNA").Value
                  .Fields("NominalCodeforVAT").Value = adoRstDRecords.Fields("NCV").Value
                  .Fields("NominalNameforVAT").Value = adoRstDRecords.Fields("NNV").Value
                  .Fields("NominalCodeforTotal").Value = adoRstDRecords.Fields("NCT").Value
                  .Fields("NominalNameforTotal").Value = adoRstDRecords.Fields("NNT").Value
                  .Fields("Source").Value = adoRstDRecords.Fields("DTGroup").Value
                  .Fields("TransactionType").Value = adoRstDRecords.Fields("T_TYPE").Value
                  .Fields("IssueDate").Value = adoRstDRecords.Fields("IDT").Value
                  .Fields("VATMonth").Value = adoRstDRecords.Fields("VMTH").Value
                  .Fields("Typeofdemand").Value = adoRstDRecords.Fields("TDM").Value
                  .Fields("Reference").Value = adoRstDRecords.Fields("SREF").Value
                  .Fields("Description").Value = adoRstDRecords.Fields("DESCR").Value
                  .Fields("PRINT_ID").Value = strSelectedPrintRef
                  .Fields("DemandReportName").Value = adoRstDRecords.Fields("DRN").Value
                  .Fields("SptSlNo").Value = adoRstDRecords.Fields("S_ID").Value
                  .Fields("DTCategory").Value = adoRstDRecords.Fields("CC").Value

                  If adoRstDRecords.Fields("D_ST").Value Then
                     .Fields("DueDate").Value = adoRstDRecords.Fields("DDT").Value
                      rsMinDueDate.Open "Select MIN(DUEDATE) as mindate From DemandSplitRecords DSR where DSR.DEMANDID = " + CStr(CLng(flxDemands.TextMatrix(iRow, 1))) + "", adoConn, adOpenKeyset, adLockReadOnly
                      If Not rsMinDueDate.EOF Then
                            .Fields("MinDueDate").Value = rsMinDueDate.Fields("mindate").Value
                      End If
                      rsMinDueDate.Close
                     .Fields("TotalAmount").Value = adoRstDRecords.Fields("TAMT").Value
                     .Fields("VATAmount").Value = adoRstDRecords.Fields("VAMT").Value
                     .Fields("Amount").Value = adoRstDRecords.Fields("AMT").Value
                     .Fields("DemandFrom").Value = adoRstDRecords.Fields("D_FROM").Value
                     .Fields("DemandTo").Value = adoRstDRecords.Fields("D_TO").Value
                  End If

                  .Fields.Item("ChargingFigure").Value = adoRstDRecords.Fields.Item("ChargingFigure").Value
                  .Fields.Item("spare1").Value = adoRstDRecords.Fields.Item("DSR").Value
                  .Fields("spare2").Value = adoRstDRecords.Fields("VAT_CODE").Value
                  .Update
               End If
               adoRstDRecords.MoveNext
            Wend
            adoRstDRecords.Close
         End If
      Next iRow
      .Close
   End With

'UPDATE THE PrintBBF FIELD.
   strSQLTitles = "UPDATE tlbDRCurrentPrint " & _
                  "SET PrintBBF = True " & _
                  "WHERE UniqueRefNumber IN ( " & _
                     "SELECT MIN(Q.UniqueRefNumber) AS UniqueRefNumber " & _
                     "FROM ( " & _
                     "SELECT DISTINCT UniqueRefNumber, SageAccountNumber " & _
                     "FROM tlbDRCurrentPrint) AS Q " & _
                     "GROUP BY Q.SageAccountNumber)"
'Debug.Print strSQLTitles
   adoConn.Execute strSQLTitles
   
   'Update minimum due date
   'Select MIN(DUEDATE) as mindate ,UNiqueRefNumber From tlbDRcurrentprint group by UNiqueRefNumber

'PRINT DEMAND INVOICES ACCORDING TO DEMAND TYPE
   strSQLTitles = "SELECT   tlbDRCurrentPrint.DemandReportName, tlbDRCurrentPrint.Source " & _
                  "FROM     tlbDRCurrentPrint " & _
                  "GROUP BY tlbDRCurrentPrint.DemandReportName, Source;"
'Debug.Print strSQLTitles

   adoRstDRCurrent.Open strSQLTitles, adoConn, adOpenStatic, adLockReadOnly

   If adoRstDRCurrent.EOF Then
      'Resolved by BOSL. Issue No: 0000481
      'Modified by Asif. 28 Sep 2014 12:32 AM
      
      'MsgBox "No Demand to print.", vbInformation + vbOKOnly, "Demand Printing"
      
      MsgBox "The print demand option is not set for the selected Lessee(s). " & vbNewLine & vbNewLine & "Please tick the print demand check box on the lessee record to print your demands.", vbInformation + vbOKOnly, "Demand Printing"
   End If

   On Error GoTo ERR_REPORT

   While Not adoRstDRCurrent.EOF
'     Passing the from and to date values to Crystal Reports
      Set Report = reportApp.OpenReport(App.Path & szReportPath & "\" & adoRstDRCurrent.Fields.Item("DemandReportName").Value)
      Report.Database.Tables(1).ConnectionProperties.Item("Database Password") = accessDBPws

      Report.EnableParameterPrompting = False
      Report.DiscardSavedData

      Report.ParameterFields(1).AddCurrentValue adoRstDRCurrent.Fields.Item("Source").Value
     '  Report.RecordSelectionFormula = "{tlbDRCurrentPrint.Amount} > 0 and {LeaseDetails.Status}"

      Set rep = New frmReport
      Load rep
      rep.LoadReportViewer Report
      Set rep = Nothing
      Set Report = Nothing
      adoRstDRCurrent.MoveNext
   Wend
   adoRstDRCurrent.Close
   Set adoRstDRCurrent = Nothing

   If bPrintMarked Then
      iTemp = iSelectedDemandsRow
      szWhere = SelectedDemandID_old()

      strSQLTitles = "UPDATE DemandRecords " & _
                     "SET IsPrinted = TRUE " & _
                     "WHERE DemandRecords.DemandID IN (" & szWhere & ");"
      adoRstDRecords.Open strSQLTitles, adoConn, adOpenDynamic, adLockPessimistic
   End If

   Set adoRstDRecords = Nothing
   'if I only code for color fix this will take huge time rather than loading the whole list
  ' LoadFlxGrid flxDemands, False, adoConn, ""
   LoadFlxDemands adoConn, ""
   ConfigFlxAddNewDemands
   If chkSelectAllDemands.Value Then chkSelectAllDemands.Value = 0

   DemandPrintUnlock adoConn

   adoConn.Close
   Set adoConn = Nothing
   Exit Sub

ERR_REPORT:
   MsgBox "The name of the print demand report template has not been set correctly in the Demand Type screen. Please check!", vbCritical + vbOKOnly, "Print Demand Report Template"
   If adoRstDRCurrent.State = 1 Then
        adoRstDRCurrent.Close
   End If
   Set adoRstDRCurrent = Nothing
   adoConn.Close
   Set adoConn = Nothing
End Sub

Private Sub cmdReceiptDiscard_Click()
   If MsgBox("Do you wish to discard all changes?", vbQuestion + vbYesNo, "Receipts") = vbNo Then Exit Sub

   cmeRevereseAllocation.Enabled = True
   cmdAllocate.Enabled = True
    'added by anol 06 July
    cmdRptClientList.Enabled = True
    cmdRptPropertyList.Enabled = True
    'End of modification
   Dim iRow As Integer

   'If bChangesMade Then
      For iRow = 1 To flxSPayment.Rows - 1
        ' If Val(flxSPayment.TextMatrix(iRow, 10)) > 0 Then
            'flxSPayment.TextMatrix(iRow, 9) = szIntitalOSAmount(iRow) 'intitila os amount
            flxSPayment.TextMatrix(iRow, 10) = "0.00"
            flxSPayment.TextMatrix(iRow, 33) = "0.00"
         'End If
      Next iRow
      txtReceiptEntered.text = "0.00"
      flxCrPoA.Enabled = True
      txtSPaymentTotal.text = "0.00"
      bChangesMade = False
      cGridRptTotal = 0
      bTotalRptTyped = False
      cmdBankAc.Enabled = True
   'End If
End Sub

Private Sub cmdSaveNew_Click() 'Manual demand save
   Dim szSage() As String, szSAGEID As String, szUnit() As String, szProp As String
   Dim strSQLTitles As String
   Dim iLoop As Integer, iDemandID As Integer
   Dim iSplit As Integer
   Dim adoConn As ADODB.Connection
   'issue 571 Validation
   'flxAddNewDemands.Rows
   'checking the freq if SO is ticked by anol 01 Sep 2016
   If txtDmdClientList.text = "" Then
        MsgBox "Please select a client.", vbInformation, "Warning"
        Exit Sub
   End If
   If txtDmdPropertyList.text = "" Then
        MsgBox "Please select a property.", vbInformation, "Warning"
        Exit Sub
   End If
   If txtTenantName.text = "" Then
         MsgBox "Please select a property.", vbInformation, "Warning"
        Exit Sub
   End If
   If txtDmdClientList.ForeColor = vbRed Then
         MsgBox "No Nominal Account Codes have been setup in the Control Accounts for the Client: " & txtDmdClientList.text & _
         vbNewLine & "Please setup the Control Accounts in Tools > Configuration > Control Accounts"
         Exit Sub
   End If
   If flxAddNewDemands.TextMatrix(1, 20) = "" Then
        MsgBox "Please enter values in the details grid", vbInformation, "Warning"
        
        Exit Sub
   End If
   If chkSO.Value = True And Val(txtFreq.Tag) = 0 Then
        MsgBox "Please select a frequency", vbInformation, "Warning"
        If cmdFreq.Enabled Then cmdFreq.SetFocus
        Exit Sub
   End If
   If txtDmdClientList.ForeColor = vbRed Then
        MsgBox "Please select a frequency", vbInformation, "Warning"
        If cmdFreq.Enabled Then cmdFreq.SetFocus
        Exit Sub
   End If
   If Trim(txtTenantName.text) = "" Then
        MsgBox "Please select a tenant", vbInformation, "Warning!!"
        Exit Sub
   End If
   'issue 521
   If DateDiff("d", lblPostingDate.ToolTipText, txtIssueDate.text) > 0 Then
          MsgBox "Posting date cannot be before the transaction date", vbInformation, "Posting Date"
          Exit Sub
   End If
   If CDbl(txtArray(6)) < 0 Then
         MsgBox "Total Invoice amount cannot be negative", vbInformation, "Invoice amount negative"
         Exit Sub
   End If
   
   Dim adoRstSplitDemand As New ADODB.Recordset, adoRstDemandRec As New ADODB.Recordset

  ' If cmdUpdate.Enabled Then Exit Sub

'   If flxAddNewDemands.TextMatrix(flxAddNewDemands.Rows - 1, 11) = "" And flxAddNewDemands.TextMatrix(flxAddNewDemands.Rows - 1, 7) <> "" Then
'      MsgBox "Please give the VAT Code.", vbCritical + vbOKOnly, "Error"
'      flxAddNewDemands.col = 18
'      flxAddNewDemands_Click
'      Exit Sub
'   End If
   FraTopAddNewLine.Enabled = True
   Set adoConn = New ADODB.Connection
   adoConn.Open getConnectionString
   adoConn.BeginTrans
    'issue 519
    'it should not be possible to change the posting date on a transaction
    'if the posting date on that transaction falls within a closed financial period.
    
    If IsPeriodStatus(lblPostingDate.ToolTipText, txtDmdClientList.text, adoConn) = 0 Then
        ShowMsgInTaskBar "The posting date cannot fall within a closed financial period", "Y", "N"
        adoConn.Close
        Exit Sub
    ElseIf IsPeriodStatus(lblPostingDate.ToolTipText, txtDmdClientList.text, adoConn) = 9 Then
        ShowMsgInTaskBar "The Posting date does not fall in any existing financial period", "Y", "N"
        adoConn.Close
        Exit Sub
    End If
    cmdSaveNew.Enabled = False
   'Resolved by BOSL
   'Issue No: 0000476
   'Retrieving the Sales Ledger Control and Output VAT Control Accounts from the Tools > Configuration instead
   'of the default control accounts set in the demand types records.
   'If not found, then exit the function before it updates or post any transaction to the database.
   'Modified By: Asif. 20 Sep 2014
   
   Dim OutputVATNominalCode As String
   Dim SalesLedgerNominalCode As String
   
   Dim OutputVATNominalName As String
   Dim SalesLedgerNominalName As String
   
   OutputVATNominalCode = ""
   SalesLedgerNominalCode = ""

   OutputVATNominalCode = GetNominalCodeForControlAccount(adoConn, "Output VAT", txtDmdClientList.text)
   If (OutputVATNominalCode = "") Then
       Exit Sub
   Else
       OutputVATNominalName = GetNominalNameOfCode(adoConn, OutputVATNominalCode, txtDmdClientList.text)
'       If MsgBox("There is no Nominal Code set for Output VAT Control Account. Do you want to continue", vbYesNo, "No Nominal Code set for Output VAT Control") = vbNo Then
'            Exit Function
'       End If
   End If
   
   SalesLedgerNominalCode = GetNominalCodeForControlAccount(adoConn, "Sales Ledger Control", txtDmdClientList.text)
   If (SalesLedgerNominalCode = "") Then
       Exit Sub
   Else
       SalesLedgerNominalName = GetNominalNameOfCode(adoConn, SalesLedgerNominalCode, txtDmdClientList.text)
'       If MsgBox("There is no Nominal Code set for Sales Ledger Control Account. Do you want to continue", vbYesNo, "No Nominal Code set for Sales Ledger Control") = vbNo Then
'            Exit Function
'       End If
   End If
   
   '''''''''''''''''''''''''''''''''''''''''''''''
   
'*********************************Clear Demand Table according to the deamnd id********************************
   szSage = Split(txtTenantName.text, " / ")
   szSAGEID = szSage(0)
   szUnit = Split(txtUnit.text, "-")      'this will not work if the property name is like "1-200 ABC Block", which Property ID is "1-01"

   szProp = Left(txtUnit.text, 4)

'Save the header part in the DemandRecords table
'Save all transactions from temp grid to the database
   If bEditDmd Then
      strSQLTitles = "SELECT * FROM DemandRecords WHERE DEMANDID = " & CLng(txtDemandID.text) & ""
   Else
      strSQLTitles = "SELECT * FROM DemandRecords;"
      txtDemandID.text = Format(NextRef(adoConn, "DEMAND_REF"), "00000000")
   End If
   adoRstDemandRec.Open strSQLTitles, adoConn, adOpenDynamic, adLockPessimistic

   With adoRstDemandRec
      If Not bEditDmd Then
         .AddNew
         !DEMANDID = CLng(txtDemandID.text)
         .Fields.Item("DmdSlNo").Value = SlNumber(IIf(InStr(fraCreateManualDemand.Caption, "Invoice") = 0, "SC", "SI"), "DemandRecords", adoConn)
         .Fields.Item("LeaseRef").Value = Label1(41).Caption
         
      End If
        'adding standing order flag by anol 16 08 2016
         'This will not edited afterwards ,so no need to implement this field in the edit manual demand part
         .Fields.Item("SO").Value = chkSO.Value
         .Fields.Item("exclCRNtoCS").Value = chkExcludeInCS.Value
'         If chkSO.Value Then
'            .Fields.Item("FREQID").Value = cboFreq.Value
'         Else
'            .Fields.Item("FREQID").Value = Null
'         End If
      !SageAccountNumber = szSAGEID
      !TenantCompanyName = szSage(1)
      !UnitNumber = IIf(txtUnit.text = "NOT OCCUPYING", Null, txtUnit.text)
      !TransactionType = CByte(IIf(InStr(fraCreateManualDemand.Caption, "Invoice") = 0, 2, 1))
      !issueDate = Format(txtIssueDate.text, "dd mmmm yyyy")
      !Details = Left(flxAddNewDemands.TextMatrix(1, 3), 70)
      !IsPrinted = False
      !DemandHistory = False
      !spare1 = BankOfDemandType(flxAddNewDemands.TextMatrix(1, 20), adoConn)
      !AdjTag = IIf(InStr(fraCreateManualDemand.Caption, "Adjustment") > 0, "Y", "N")
      !postingDate = Format(lblPostingDate.ToolTipText, "dd mmmm yyyy")
      !LastModifiedBy = User
      !LastModifiedDate = Now
      .Update
      .Close
   End With

'Save the split lines in the split table
'Before saving the Demand, delete the demand from the demand table and demand split table
   If bEditDmd Then
'Now SET a flag in the NLPosting table
      adoConn.Execute "UPDATE NLPosting AS N, DemandSplitRecords AS S " & _
                      "SET    N.DeleteFlag = TRUE " & _
                      "WHERE  N.PARENT_RECORD = S.DSR AND " & _
                             "S.DEMANDID=" & CLng(txtDemandID.text) & ";"

      adoConn.Execute "DELETE * FROM DemandSplitRecords WHERE DEMANDID=" & CLng(txtDemandID.text) & ""
      adoConn.Execute "UPDATE DemandRecords SET ExportedToExcel = FALSE WHERE DEMANDID=" & CLng(txtDemandID.text) & ""
   End If

   strSQLTitles = "SELECT * FROM DemandSplitRecords"
   adoRstSplitDemand.Open strSQLTitles, adoConn, adOpenDynamic, adLockPessimistic

'Now, delete the demand from the Receipt table and Receipt Split table
   If bEditDmd Then
      strSQLTitles = "DELETE FROM tlbReceiptSplit " & _
                     "WHERE EXISTS " & _
                          "(SELECT * " & _
                           "FROM tlbReceipt " & _
                           "WHERE tlbReceipt.TransactionID = tlbReceiptSplit.RptHeader AND " & _
                                 "(tlbReceipt.Type = 1 OR tlbReceipt.Type = 2) AND " & _
                                 "tlbReceipt.DemandRef = " & CLng(txtDemandID.text) & ")"
      adoConn.Execute strSQLTitles

      strSQLTitles = "DELETE FROM  tlbReceipt " & _
                     "WHERE (Type = 1 OR Type = 2) AND DemandRef = " & CLng(txtDemandID.text) & ""
      adoConn.Execute strSQLTitles
   End If
iSplit = 1
   For iLoop = 1 To flxAddNewDemands.Rows - 1
      If flxAddNewDemands.TextMatrix(iLoop, 0) <> "DELETED" And flxAddNewDemands.TextMatrix(iLoop, 0) <> "" Then
         With adoRstSplitDemand
            .AddNew
            !DSR = UniqueID()
            !splitID = iSplit 'CInt(flxAddNewDemands.TextMatrix(iLoop, 0))
            iSplit = iSplit + 1 ' Increasing the split ID for writing in demandSplitRecord
            !DEMANDID = CLng(txtDemandID.text)
            !A_M = flxAddNewDemands.TextMatrix(iLoop, 1)
            !NominalCodeforAmount = flxAddNewDemands.TextMatrix(iLoop, 14)
            !NominalNameforAmount = flxAddNewDemands.TextMatrix(iLoop, 15) 'fixed 2022-03-22 was index 16
'            If flxAddNewDemands.TextMatrix(iLoop, 12) = "" Then
'                MsgBox "No nominal code"
'            End If
           'Resolved by BOSL
            'Issue No: 0000476
            'Assiging the Sales Ledger Control and Output VAT Control Accounts in the transaction lines
            'Modified By: Asif. 20 Sep 2014

            '!NominalCodeForVAT = flxAddNewDemands.TextMatrix(iLoop, 14)
            !NominalCodeForVAT = OutputVATNominalCode
            
            '!NominalNameforVAT = flxAddNewDemands.TextMatrix(iLoop, 15)
            !NominalNameforVAT = OutputVATNominalName
            
            
            '!NominalCodeForTotal = flxAddNewDemands.TextMatrix(iLoop, 16)
            !NominalCodeForTotal = SalesLedgerNominalCode
            
            '!NominalNameforTotal = flxAddNewDemands.TextMatrix(iLoop, 17)
            !NominalNameforTotal = SalesLedgerNominalName
            '''''''''''''''''''''''''''''''''''''''''''''''''
            !amount = IIf(flxAddNewDemands.TextMatrix(iLoop, 9) = "", Null, flxAddNewDemands.TextMatrix(iLoop, 9))
            !VATAMOUNT = IIf(flxAddNewDemands.TextMatrix(iLoop, 10) = "", 0, flxAddNewDemands.TextMatrix(iLoop, 10))
            !TotalAmount = IIf(flxAddNewDemands.TextMatrix(iLoop, 11) = "", 0, flxAddNewDemands.TextMatrix(iLoop, 11))
            !SageRef = flxAddNewDemands.TextMatrix(iLoop, 12) 'DTPrefix(CInt(flxAddNewDemands.TextMatrix(iLoop, 18)), adoConn) & Format(CLng(txtDemandID.text), "00000")
            !dateFrom = Format(flxAddNewDemands.TextMatrix(iLoop, 5), "dd mmmm yyyy")
            !DateTO = Format(flxAddNewDemands.TextMatrix(iLoop, 6), "dd mmmm yyyy")
            !DueDate = Format(flxAddNewDemands.TextMatrix(iLoop, 7), "dd mmmm yyyy")
            !VATMonth = IIf(flxAddNewDemands.TextMatrix(iLoop, 5) <> "", Month(txtIssueDate.text), "")
            !TypeOfDemand = CInt(flxAddNewDemands.TextMatrix(iLoop, 20))
            !description = flxAddNewDemands.TextMatrix(iLoop, 4)
            !DemandStatement = IIf(flxAddNewDemands.TextMatrix(iLoop, 2) = "" And _
                                   flxAddNewDemands.TextMatrix(iLoop, 9) = "", False, True)
            !VAT_CODE = IIf(flxAddNewDemands.TextMatrix(iLoop, 13) = "", "-1", flxAddNewDemands.TextMatrix(iLoop, 13))
            !ChargingFigure = IIf(flxAddNewDemands.TextMatrix(iLoop, 22) = "", Null, Val(flxAddNewDemands.TextMatrix(iLoop, 22)))
            !TrfReceipt = False
            !SageDepartment = flxAddNewDemands.TextMatrix(iLoop, 21) 'Fund ID
            !AdiComment = szAdiComment(iLoop)
            !JobID = flxAddNewDemands.TextMatrix(iLoop, 8) 'Job ID
            'added by anol 01 Sep 2016
            If chkSO.Value And Val(txtFreq.Tag) > 0 Then
                     .Fields.Item("FrequencyID").Value = txtFreq.Tag
            Else
              'does nothing to auto demand or new manual demand so originl value reatained for auto demand and for new manaul demand this shall be 0
            End If
            .Update
            If bEditDmd Then .MoveNext
         End With
      Else
         strSQLTitles = "DELETE * FROM DemandSplitRecords " & _
                        "WHERE DSR = '" & flxAddNewDemands.TextMatrix(iLoop, 17) & "';"
         adoConn.Execute strSQLTitles
      End If
   Next iLoop

   adoRstSplitDemand.Close
   Set adoRstSplitDemand = Nothing
  
   
'  System will check the header amount with the split total amount.--------------------

  'Fix the demadsplit that starts with 2 by anol 20160421
    'BUGFIX_DemandSplitRecords_SplitID adoConn
'end of fix
'   If SI_Check(adoConn, "SI", "15876") = False Then
'         adoConn.RollbackTrans
'         adoConn.Close
'         Set adoConn = Nothing
'   End If
'--------------------------------------------------------------------------------------
'  Export Transactions to Nominal Ledger (NLPosting table)
' added by anol 20170112
' an error was occuring on the next procedure ......"no transaction to save"
'   If adoConn.State = 1 Then
'        adoConn.Close
'   End If
'   adoConn.Open getConnectionString
    If SI_Check(adoConn) = False Or Export_SInSC_2_NL(adoConn) = False Then
         adoConn.RollbackTrans
         adoConn.Close
         Set adoConn = Nothing
         MsgBox "There was a problem saving this transaction. It has therefore been rolled back", vbInformation, "Transaction rolled back"
         'Exit Sub
    Else
         'This part shall work when sucessfully saved transactions
    '--------------------------------------------------------------------------------------
        adoConn.CommitTrans
        MsgBox "Manual Demands have been saved.", vbInformation, "Saved"
        frmMMain.Leasee1_LesseList_isUptoDate = False
        frmMMain.Leasee4_LesseList_isUptoDate = False
        frmMMain.frmDemand3_LesseList_isUptoDate = False
        If bEditDmd = False Or szLastIDClicked = "" Then
             'LoadFlxGrid flxDemands, False, adoConn, ""
              LoadFlxDemands adoConn, ""
        Else
             'added by anol 18 Aug 2016
            LoadFlxGridOneRow flxDemands, iDemandRow, szLastIDClicked, adoConn
            flxDemands.row = iDemandRow
            flxDemands.col = 0
            flxDemands.CellBackColor = vbWhite
        End If
        
     
     '  EXPORT all Invoices or Demands into tlbReceipt table *********************************************
        MigrateInvIntoReceipt adoConn
        'We don't have to clear lock after you save a demand because it is alwas creating a new set of rows in tlbReceipt
'        If DemandLock = I_Locked_It Then
'            ReleaseLockedRecord adoConn, "DemandRecords", "DemandID", "LONG", , CLng(Val(szLastIDClicked))
'        End If
        adoConn.Close
        Set adoConn = Nothing
    End If
    ConfigFlxAddNewDemands
    fraCreateManualDemand.Visible = False
    cmdDmdTenantLookup.Enabled = True
    txtTenantName.Locked = False
    txtIssueDate.Locked = False
    cmdEdit.Enabled = True
    txtArray(8).text = ""
    txtArray(7).text = ""
    txtArray(6).text = ""
    txtDateDue.text = ""
    
    txtTenantName.text = ""
    txtIssueDate.text = ""
    
    Unload frmAdiComment

   

  
   cmdSaveNew.Enabled = True
   'added by anol 18 Aug 2016
   If szLastIDClicked <> "" Then
        ConfigFlxGrid flxChildDemands
        Call FillChildinGrid(szLastIDClicked, flxChildDemands)
        'fraDetails.Caption = "Demand Details: " & szSlNo
   End If
   
End Sub
'Private Function DuplicateSplitinDmnd(adoconn As ADODB.Connection) As Boolean
'    Dim szSQL      As String
'    Dim Rst2     As New ADODB.Recordset
'   ' Dim szTran2Fix As String
'    szSQL = "SELECT q.DmdSlNo from (Select DemandID,DmdSlNo from DemandRecords) as q  INNER JOIN" & _
'    "(SELECT DemandID,SplitID from DemandSplitRecords GROUP BY  DemandID,SplitID " & _
'    "HAVING (  COUNT(splitID)  > 1 ))  as Q1  ON  Q1.DemandID=q.DemandID   order by  q.DmdSlNo Desc"
'    Rst2.Open szSQL, adoconn, adOpenStatic, adLockReadOnly
'
'    If Not Rst2.EOF Then
'   'Due to program error Dupplice splitID was generating at demand split table. That was creating from edit demand.
'   'That area has been fixed. as well as this procedure is here if in the old  database we still have this problem. FIxed by anol Jun 2106
'        MsgBox "This database is not up to date. Please contact PCM support quoting the reference: DMND_SPLIT_DUP", vbInformation, "Prestige warning. DemandID : " & SQL2String(Rst2, 0)
'    Else
'        DuplicateSplitinDmnd = True
'    End If
'    Rst2.Close
'    Set Rst2 = Nothing
'End Function

Public Function SI_Check(adoConn As ADODB.Connection) As Boolean
   Dim szSQL      As String
   Dim adoRST     As New ADODB.Recordset
   Dim szTran2Fix As String
  
    szSQL = "SELECT  R.TransactionID " & _
             "FROM tlbReceipt AS R, (" & _
                   "SELECT RptHeader, ROUND(Sum(Amount) - Sum(OSAmount), 2) AS T " & _
                   "From tlbReceiptSplit " & _
                   "Group by RptHeader " & _
                   ") AS Q " & _
             "WHERE R.TransactionID = Q.RptHeader AND R.Amount <> R.OSAmount AND " & _
                   "ROUND(R.Amount - R.OSAmount, 2) <> Q.T;"
    
    adoRST.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
    
    While Not adoRST.EOF
       szTran2Fix = szTran2Fix + ", " + CStr(adoRST.Fields.Item("TransactionID").Value)
    
       adoRST.MoveNext
    Wend
    
    adoRST.Close
  

   Set adoRST = Nothing

   If Len(szTran2Fix) > 0 Then szTran2Fix = Mid(szTran2Fix, 3)

   If Len(szTran2Fix) > 0 Then
    
      MsgBox "The following transactions need fixing immediately: " & _
             Chr(13) & szTran2Fix & "." & _
             "Please contact PCM Consulting Support.", _
             vbInformation + vbOKOnly, " SI_Check "
   Else
        SI_Check = True
   End If
End Function
Private Function SalesInvoice_Check(adoConn As ADODB.Connection) As Boolean
   Dim szSQL      As String
   Dim adoRST     As New ADODB.Recordset
   Dim szTran2Fix As String

   
      szSQL = "SELECT  R.TransactionID " & _
               "FROM tlbReceipt AS R, (" & _
                     "SELECT RptHeader, ROUND(Sum(Amount) - Sum(OSAmount), 2) AS T " & _
                     "From tlbReceiptSplit " & _
                     "Group by RptHeader " & _
                     ") AS Q " & _
               "WHERE R.TransactionID = Q.RptHeader AND R.Amount <> R.OSAmount AND " & _
                     "ROUND(R.Amount - R.OSAmount, 2) <> Q.T;"

      adoRST.Open szSQL, adoConn, adOpenStatic, adLockReadOnly

      While Not adoRST.EOF
         szTran2Fix = szTran2Fix + ", " + CStr(adoRST.Fields.Item("TransactionID").Value)
         adoRST.MoveNext
      Wend

      adoRST.Close
   

   Set adoRST = Nothing

   If Len(szTran2Fix) > 0 Then szTran2Fix = Mid(szTran2Fix, 3)

   If Len(szTran2Fix) > 0 Then
          SalesInvoice_Check = True
   End If
      
End Function
Private Function BUGFIX_DemandSplitRecords_SplitID(Conn1 As ADODB.Connection)
        Dim Rst1 As New ADODB.Recordset
        Rst1.Open "SELECT Q1.* " & _
             "FROM ( " & _
               "SELECT DS.DemandID, Max(DS.SplitID) AS M " & _
               "FROM DemandSplitRecords AS DS " & _
               "GROUP BY DS.DemandID " & _
             ") AS Q1 INNER JOIN " & _
             "( " & _
               "SELECT DS.DemandID, COUNT(DSR) AS C " & _
               "FROM DemandSplitRecords AS DS " & _
               "GROUP BY DS.DemandID " & _
             ") AS Q2 ON Q2.DemandID = Q1.DemandID " & _
             "WHERE Q1.M <> Q2.C", Conn1, adOpenStatic, adLockReadOnly
   If Not Rst1.EOF Then                                                 'There are demand split without SplitID
      Rst1.Close
      Conn1.Execute "UPDATE DemandSplitRecords " & _
                    "Set SplitID = SplitID - 1 " & _
                    "WHERE DSR IN ( " & _
                    "SELECT DS.DSR " & _
                    "FROM ((" & _
                       "SELECT DS.DemandID, Max(DS.SplitID) AS M " & _
                       "FROM DemandSplitRecords AS DS " & _
                       "GROUP BY DS.DemandID " & _
                    ") AS Q1 INNER JOIN " & _
                    "( " & _
                       "SELECT DS.DemandID, COUNT(DSR) AS C " & _
                       "FROM DemandSplitRecords AS DS " & _
                       "GROUP BY DS.DemandID " & _
                    ") AS Q2 ON Q2.DemandID = Q1.DemandID) INNER JOIN " & _
                       "DemandSplitRecords AS DS ON Q1.DemandID = DS.DemandID " & _
                    "WHERE Q1.M <> Q2.C);"

         Conn1.Execute "UPDATE tlbReceiptSplit AS R, DemandSplitRecords AS S " & _
                       "SET R.SplitID = S.SplitID " & _
                       "WHERE R.AllocTranID = S.DSR AND R.Amount = S.TotalAmount;"

       
         
         Exit Function
   End If
   Rst1.Close
End Function

'ConfigFlxDemands
Private Sub ConfigFlxGridDemand(conFlxGrid As MSHFlexGrid)
   Dim szHeader As String

   If conFlxGrid.Name = "flxDemands" Then
      'flxDemands.Cols = 13
      ' I am adding five more columns for locking issue
        flxDemands.Cols = 18
        flxDemands.Clear
        szHeader$ = "|<ID|<Sl|<I/C|<Company Name|<Unit No|<Issue Dt.|>Total|>Outstanding|<Printed|SAGE|<SentEmail|<BATCHID"
        flxDemands.FormatString = szHeader$
        flxDemands.RowHeight(0) = 0
        
        flxDemands.ColWidth(0) = Label44(2).Left - flxDemands.Left       'Solid column
        flxDemands.ColWidth(1) = 0                                       'Demand ID
        flxDemands.ColWidth(2) = Label44(4).Left - Label44(2).Left       'Serial No
        flxDemands.ColWidth(3) = 0                                       'Transaction Type
        flxDemands.ColWidth(4) = Label44(5).Left - Label44(4).Left       'Comp Name
        flxDemands.ColWidth(5) = Label44(6).Left - Label44(5).Left       'Unit Number
        flxDemands.ColWidth(6) = Label44(7).Left - Label44(6).Left       'Issue Date
        flxDemands.ColWidth(7) = Label44(36).Left - Label44(7).Left      'Total
        flxDemands.ColWidth(8) = Label44(8).Left - Label44(36).Left      'Outstnding
        flxDemands.ColWidth(9) = Label44(34).Left - Label44(8).Left      'Print
        flxDemands.ColWidth(10) = 0                                      'Sage
        flxDemands.ColWidth(11) = flxDemands.Width + flxDemands.Left - Label44(34).Left - 350 'Email
        flxDemands.ColWidth(12) = 0         'BATCHID  *This column always at the end for keep BATCHID number
        flxDemands.ColWidth(13) = 0 'sessionID
        flxDemands.ColWidth(14) = 0
        flxDemands.ColWidth(15) = 0
        flxDemands.ColWidth(16) = 0
        flxDemands.ColWidth(17) = 0 'transactionID
        flxDemands.Rows = 2

        Exit Sub
   End If

'   Label44(18).Left = 600
'   Label44(19).Left = 1400
'   Label44(20).Left = 3500
'   Label44(21).Left = 6800
'   Label44(22).Left = 8200
'   Label44(23).Left = 9500
'   Label44(24).Left = 10500

   'flxDemandHistory.Cols = 13
    ' I am adding four more columns for locking issue
   flxDemandHistory.Cols = 18
   flxDemandHistory.Clear
   szHeader$ = "|<ID|<Sl|<I/C|<Company Name|<Unit No|<Issue Dt.|>Total|>Outstanding|<Printed|SAGE|<SentEmail|<BATCHID"
   flxDemandHistory.FormatString = szHeader$
   flxDemandHistory.RowHeight(0) = 0

   flxDemandHistory.ColWidth(0) = Label44(18).Left - flxDemandHistory.Left    'Solid column
   flxDemandHistory.ColWidth(1) = 0                                           'Demand ID
   flxDemandHistory.ColWidth(2) = Label44(20).Left - Label44(18).Left         'Serial No
   flxDemandHistory.ColWidth(3) = 0          'Transaction Type
   flxDemandHistory.ColWidth(4) = Label44(21).Left - Label44(20).Left       'Comp Name
   flxDemandHistory.ColWidth(5) = Label44(22).Left - Label44(21).Left       'Unit Number
   flxDemandHistory.ColWidth(6) = Label44(23).Left - Label44(22).Left       'Issue Date
   flxDemandHistory.ColWidth(7) = Label44(37).Left - Label44(23).Left       'Total
   flxDemandHistory.ColWidth(8) = Label44(24).Left - Label44(37).Left       'Print
   flxDemandHistory.ColWidth(9) = Label44(35).Left - Label44(24).Left       'Email
   flxDemandHistory.ColWidth(10) = 0         'Sage
   flxDemandHistory.ColWidth(11) = flxDemandHistory.Width + flxDemandHistory.Left - Label44(35).Left - 350      'Email
   flxDemandHistory.ColWidth(12) = 0         'BATCHID  *This column always at the end for keep BATCHID number
    flxDemandHistory.ColWidth(13) = 0
    flxDemandHistory.ColWidth(14) = 0
    flxDemandHistory.ColWidth(15) = 0
    flxDemandHistory.ColWidth(16) = 0
    flxDemandHistory.ColWidth(17) = 0 'transactionID

'   conFlxGrid.ColWidth(0) = 200        'Solid column
'   conFlxGrid.ColWidth(1) = 0          'Demand ID
'   conFlxGrid.ColWidth(2) = 1100       'Serial No
'   conFlxGrid.ColWidth(3) = 0          'Transaction Type
'   conFlxGrid.ColWidth(4) = 4300       'Comp Name
'   conFlxGrid.ColWidth(5) = 1800       'Unit Number
'   conFlxGrid.ColWidth(6) = 1200       'Issue Date
'   conFlxGrid.ColWidth(7) = 1000       'Total
'   conFlxGrid.ColWidth(8) = 1000       'Print
'   conFlxGrid.ColWidth(9) = 0          'Sage A/C No.
'   conFlxGrid.ColWidth(10) = 0         'Sage
'   conFlxGrid.ColWidth(11) = 1000      'Email
'   conFlxGrid.ColWidth(12) = 0         'BATCHID  *This column always at the end for keep BATCHID number

   flxDemandHistory.Rows = 2
End Sub
Private Sub ConfigflxDemands()
      Dim szHeader As String
    ' I am adding five more columns for locking issue
      flxDemands.Cols = 18
      flxDemands.Clear
      szHeader$ = "|<ID|<Sl|<I/C|<Company Name|<Unit No|<Issue Dt.|>Total|>Outstanding|<Printed|SAGE|<SentEmail|<BATCHID"
      flxDemands.FormatString = szHeader$
      flxDemands.RowHeight(0) = 0
      
      flxDemands.ColWidth(0) = Label44(2).Left - flxDemands.Left       'Solid column
      flxDemands.ColWidth(1) = 0                                       'Demand ID
      flxDemands.ColWidth(2) = Label44(4).Left - Label44(2).Left       'Serial No
      flxDemands.ColWidth(3) = 0                                       'Transaction Type
      flxDemands.ColWidth(4) = Label44(5).Left - Label44(4).Left       'Comp Name
      flxDemands.ColWidth(5) = Label44(6).Left - Label44(5).Left       'Unit Number
      flxDemands.ColWidth(6) = Label44(7).Left - Label44(6).Left       'Issue Date
      flxDemands.ColWidth(7) = Label44(36).Left - Label44(7).Left      'Total
      flxDemands.ColWidth(8) = Label44(8).Left - Label44(36).Left      'Outstnding
      flxDemands.ColWidth(9) = Label44(34).Left - Label44(8).Left      'Print
      flxDemands.ColWidth(10) = 0                                      'Sage
      flxDemands.ColWidth(11) = flxDemands.Width + flxDemands.Left - Label44(34).Left - 350 'Email
      flxDemands.ColWidth(12) = 0         'BATCHID  *This column always at the end for keep BATCHID number
      flxDemands.ColWidth(13) = 0 'sessionID
      flxDemands.ColWidth(14) = 0
      flxDemands.ColWidth(15) = 0
      flxDemands.ColWidth(16) = 0
      flxDemands.ColWidth(17) = 0 'transactionID
      flxDemands.Rows = 2

   
   
End Sub
Private Sub cmdSPayAll_Click()
   Dim iPayTran As Integer, i As Integer

   For i = 1 To flxSPayment.Rows - 1
      If flxSPayment.TextMatrix(i, 0) = "+" Or _
            flxSPayment.TextMatrix(i, 0) = "" Or _
            flxSPayment.TextMatrix(i, 0) = ">" Then _
      iPayTran = iPayTran + 1
   Next i

   flxSPayment.row = 1

   For i = 1 To iPayTran
      cmdSPFull_Click
   Next i

   cmeRevereseAllocation.Enabled = False
   cmdAllocate.Enabled = False

   Exit Sub
End Sub

Private Sub cmdSPClose_LostFocus()
   tabPayment.SetFocus
End Sub

Private Sub cmdAllocationDiscard_Click()
   Dim iRow As Integer, iRowSp As Integer

   If MsgBox("Are you sure to discard allocation?", vbQuestion + vbYesNo, "Clear Allocation") = vbYes Then
      For iRow = 1 To flxSPayment.Rows - 1
'         If flxSPayment.TextMatrix(iRow, 15) = "A" Then
            flxSPayment.TextMatrix(iRow, 10) = "0.00"
            flxSPayment.TextMatrix(iRow, 15) = ""
            flxSPayment.TextMatrix(iRow, 16) = ""

            If flxSPayment.TextMatrix(iRow, 0) = "+" Or _
                   flxSPayment.TextMatrix(iRow, 0) = ">" Then
               iRowSp = iRow + 1
               Do
                  flxSPayment.TextMatrix(iRowSp, 10) = "0.00"
                  iRowSp = iRowSp + 1
                  If flxSPayment.Rows = iRowSp Then Exit Do
               Loop While flxSPayment.TextMatrix(iRowSp, 0) = "-"
               iRow = iRowSp - 1
            End If
'         End If
      Next iRow

      For iRow = 1 To flxCrPoA.Rows - 1
         flxCrPoA.TextMatrix(iRow, 9) = "0.00"
      Next iRow

      flxSPayment.Enabled = True
      flxCrPoA.Enabled = True
      cmdAllocateSave.Enabled = False
      lblAllocating.Visible = False
      Frame5(4).Enabled = True                       'Allocation - Saving
      txtArray(4).text = "0.00"
      cmdAutomatic.Enabled = True
   End If
End Sub

Private Sub cmdSPFull_Click()
Dim iInc As Integer

   If Val(txtSPaymentTotal.text) < 0 Then Exit Sub                         'Refund -ve

   cmeRevereseAllocation.Enabled = False
   cmdAllocate.Enabled = False

   If flxSPayment.TextMatrix(flxSPayment.row, 9) = flxSPayment.TextMatrix(flxSPayment.row, 10) Then
      If flxSPayment.TextMatrix(flxSPayment.row, 0) = "+" Or flxSPayment.TextMatrix(flxSPayment.row, 0) = ">" Then
         iInc = flxSPayment.row + 1
         While flxSPayment.TextMatrix(iInc, 0) <> "-"
            iInc = iInc + 1
         Wend
         flxSPayment.row = iInc
      Else
         If flxSPayment.row < flxSPayment.Rows - 2 Then flxSPayment.row = flxSPayment.row + 1
      End If

      Exit Sub
   End If

   If flxSPayment.row = 0 Then Exit Sub
   If flxSPayment.TextMatrix(flxSPayment.row, 2) = "ADJI" Then Exit Sub

   On Error GoTo ErrorHandler

   flxSPayment.col = 9

   If Val(flxSPayment.TextMatrix(flxSPayment.row, 10)) > 0 And Not bTotalRptTyped Then
      txtSPaymentTotal.text = Val(txtSPaymentTotal.text) - Val(flxSPayment.TextMatrix(flxSPayment.row, 10))
   End If

   If bTotalRptTyped Then                'Receipt amount has put in the "Total Receipt Amt"
      If Val(txtDifference.text) > Val(flxSPayment.TextMatrix(flxSPayment.row, 9)) Then
         flxSPayment.TextMatrix(flxSPayment.row, 10) = flxSPayment.TextMatrix(flxSPayment.row, 9)
      Else
         flxSPayment.TextMatrix(flxSPayment.row, 10) = IIf(baChangesMade(flxSPayment.row), flxSPayment.TextMatrix(flxSPayment.row, 10), txtDifference.text)
      End If
   Else
      flxSPayment.TextMatrix(flxSPayment.row, 10) = flxSPayment.TextMatrix(flxSPayment.row, 9)
      txtSPaymentTotal.text = Format(CCur(txtSPaymentTotal.text) + CCur(flxSPayment.TextMatrix(flxSPayment.row, 10)), "0.00")
   End If

   iInc = 1

   iCurRow = flxSPayment.row
   If flxSPayment.TextMatrix(flxSPayment.row, 0) = "+" Or flxSPayment.TextMatrix(flxSPayment.row, 0) = ">" Then
      iInc = SpreadHeaderInSplits
   End If
   If flxSPayment.TextMatrix(flxSPayment.row, 0) = "-" Then
      SumUpHeaderBySplits
   End If

   cGridRptTotal = TotalReceiptEntered '' ReceiptEntered based on header. as split updated Header
   baChangesMade(flxSPayment.row) = IIf(Val(flxSPayment.TextMatrix(flxSPayment.row, 10)) > 0, True, False)

   txtReceiptEntered.text = Format(cGridRptTotal, "0.00")

   If flxSPayment.row < flxSPayment.Rows - 1 Then
      flxSPayment.row = flxSPayment.row + iInc
      HighLightRowFlxGrid flxSPayment, flxSPayment.row
   End If

   Exit Sub

ErrorHandler:
   Debug.Print "Reached the end of the records"
'   Dim iInc As Integer
'
'   If Val(txtSPaymentTotal.text) < 0 Then Exit Sub                         'Refund -ve
'
'   cmeRevereseAllocation.Enabled = False
'   cmdAllocate.Enabled = False
'
'   If flxSPayment.TextMatrix(flxSPayment.row, 9) = flxSPayment.TextMatrix(flxSPayment.row, 10) Then
'      If flxSPayment.TextMatrix(flxSPayment.row, 0) = "+" Or flxSPayment.TextMatrix(flxSPayment.row, 0) = ">" Then
'         iInc = flxSPayment.row + 1
'         While flxSPayment.TextMatrix(iInc, 0) <> "-"
'            iInc = iInc + 1
'         Wend
'         flxSPayment.row = iInc
'      Else
'         If flxSPayment.row < flxSPayment.Rows - 2 Then flxSPayment.row = flxSPayment.row + 1
'      End If
'
'      Exit Sub
'   End If
'
'   If flxSPayment.row = 0 Then Exit Sub
'   If flxSPayment.TextMatrix(flxSPayment.row, 2) = "ADJI" Then Exit Sub
'
'   On Error GoTo ErrorHandler
'
'   flxSPayment.col = 9
'
'   If Val(flxSPayment.TextMatrix(flxSPayment.row, 10)) > 0 And Not bTotalRptTyped Then
'      txtSPaymentTotal.text = Val(txtSPaymentTotal.text) - Val(flxSPayment.TextMatrix(flxSPayment.row, 10))
'   End If
'
'   If bTotalRptTyped Then                'Receipt amount has put in the "Total Receipt Amt"
'      If Val(txtDifference.text) > Val(flxSPayment.TextMatrix(flxSPayment.row, 9)) Then
'         flxSPayment.TextMatrix(flxSPayment.row, 10) = flxSPayment.TextMatrix(flxSPayment.row, 9)
'      Else
'         flxSPayment.TextMatrix(flxSPayment.row, 10) = IIf(baChangesMade(flxSPayment.row), flxSPayment.TextMatrix(flxSPayment.row, 10), txtDifference.text)
'      End If
'   Else
'      flxSPayment.TextMatrix(flxSPayment.row, 10) = flxSPayment.TextMatrix(flxSPayment.row, 9)
'      txtSPaymentTotal.text = Format(CCur(txtSPaymentTotal.text) + CCur(flxSPayment.TextMatrix(flxSPayment.row, 10)), "0.00")
'   End If
'
'   iInc = 1
'
'   iCurRow = flxSPayment.row
'   If flxSPayment.TextMatrix(flxSPayment.row, 0) = "+" Or flxSPayment.TextMatrix(flxSPayment.row, 0) = ">" Then
'      iInc = SpreadHeaderInSplits
'   End If
'   If flxSPayment.TextMatrix(flxSPayment.row, 0) = "-" Then
'      SumUpHeaderBySplits
'   End If
'
'   cGridRptTotal = TotalReceiptEntered
'   baChangesMade(flxSPayment.row) = IIf(Val(flxSPayment.TextMatrix(flxSPayment.row, 10)) > 0, True, False)
'
'   txtReceiptEntered.text = Format(cGridRptTotal, "0.00")
'
'   If flxSPayment.row < flxSPayment.Rows - 1 Then
'      flxSPayment.row = flxSPayment.row + iInc
'      HighLightRowFlxGrid flxSPayment, flxSPayment.row
'   End If
'
'   Exit Sub
'
'ErrorHandler:
'   Debug.Print "Reached the end of the records"
End Sub

Private Function ReturnBankCode(adonConn As ADODB.Connection, fundID As Long) As String
    Dim rsClientBank As New ADODB.Recordset
    rsClientBank.Open "Select * from BankFund where CLIENTID='" & txtRptClientList.text & "' AND FundId=" & fundID & "", adonConn, adOpenStatic, adLockReadOnly
    If Not rsClientBank.EOF Then
            ReturnBankCode = rsClientBank("BankCode").Value
    End If
    rsClientBank.Close
End Function
Private Function isThereBankFundSetup(adonConn As ADODB.Connection) As Boolean
    Dim rsClientBank As New ADODB.Recordset
    rsClientBank.Open "Select * from BankFund where CLIENTID='" & txtRptClientList.text & "'", adonConn, adOpenStatic, adLockReadOnly
    If Not rsClientBank.EOF Then
            isThereBankFundSetup = True
    End If
    rsClientBank.Close
End Function
Private Sub cmdSPSave_Click()
   Dim cRoA As Currency            'Receipt on Account
   Dim lSlNumber As Long
   Dim adoConn As New ADODB.Connection
   Dim rsInvoice As New ADODB.Recordset
   Dim rstSet As New ADODB.Recordset
   Dim szaTenant() As String, tSageDept As Byte
   Dim szUnit As String
   Dim szDemandID As String
   Dim rsSSR As New ADODB.Recordset
   Dim isOverDraftAllowed As Boolean
   Dim dblOverdraftAmount As Double
   Dim cSumSplits As Double
   Dim rsAllocationSplit As New ADODB.Recordset
   Dim dblBankBanlance As Double
   Dim lRpt_ID As Long, lRptT_ID As Long, szSQL As String
   Dim RptTransactionsSplit As New ADODB.Recordset
   Dim lRptT_ID_Split As Long
   Dim iRow As Integer
   Dim rsReceipt As New ADODB.Recordset
   Dim rsReceiptViewCheck As New ADODB.Recordset
   Dim rsRptTransactions As New ADODB.Recordset
   Dim rstlbReceipt As New ADODB.Recordset
   Dim rstlbReceiptSplit As New ADODB.Recordset
   
   If txtRptClientList.ForeColor = vbRed Then
         MsgBox "No Nominal Account Codes have been setup in the Control Accounts for the Client: " & txtRptClientList.text & _
         vbNewLine & "Please setup the Control Accounts in Tools > Configuration > Control Accounts"
         Exit Sub
   End If
   If Not bChangesMade Then
      MsgBox "There is no transaction to save.", vbInformation + vbOKOnly, "Save"
      Exit Sub
   End If
   If txtBankAc.text = "" And chkApplyFund.Value = False Then
    'Added by anol 05 July 2015
      cmdBankAc.Enabled = True
      MsgBox "Please select a bank account.", vbCritical + vbOKOnly, "Please select a bank account."
      FocusControl cmdBankAc
      Exit Sub
   End If
   
   
   If txtRcptAmtType.text = "" Then
        MsgBox "Please select an amount type.", vbCritical + vbOKOnly, "Receipt amount type missing"
        FocusControl cmdAmountType
        Exit Sub
   End If
   'issue 521
   If Trim(txtSPDate.text) = "" Then
        MsgBox "Please enter a valid receipt date", vbInformation, "receipt Date"
        FocusControl txtSPDate
        Exit Sub
   End If
   If DateDiff("d", lblRptPostingDate.ToolTipText, txtSPDate.text) > 0 Then
        MsgBox "Posting date cannot be before the transaction date", vbInformation, "Posting Date"
        Exit Sub
   End If
  cGridRptTotal = TotalReceiptEntered ' ReceiptEntered based on header. as split updated Header
  If txtAllocationDAte.text = "" And cGridRptTotal > 0 Then
        MsgBox "Please enter allocation date", vbInformation, "Enter allocation date."
        FocusControl txtAllocationDAte
        Exit Sub
    ElseIf (txtAllocationDAte.text <> "" And cGridRptTotal > 0) Then
        If DateDiff("d", txtAllocationDAte.text, txtSPDate) > 0 Then
            MsgBox "Allocation date must be greater than or equal to receipt date.", vbInformation, "Enter allocation date."
            FocusControl txtAllocationDAte
            Exit Sub
        End If
   End If
   
   'added by anol 06 July
    txtRptClientList.Enabled = True
    txtRptPropertyList.Enabled = True
   'added by anol 09 Apr 2015
'   If cboRptClientList.ListIndex = -1 Then
'      MsgBox "Please select a client.", vbCritical + vbOKOnly, "Please select a client."
'      cboRptClientList.SetFocus
'      Exit Sub
'   End If
   
   'End of addition by anol
   'added by anol 28 Apr 2015
'   If cmbRptAmtType.ListIndex = -1 Then
'      MsgBox "Please select an amount type.", vbCritical + vbOKOnly, "Please select an amount type."
'      cmbRptAmtType.SetFocus
'      Exit Sub
'   End If
    'End of addition by anol
    'issue 519
    'it should not be possible to change the posting date on a transaction
    'if the posting date on that transaction falls within a closed financial period.
    adoConn.Open getConnectionString
    If IsPeriodStatus(lblRptPostingDate.ToolTipText, txtRptClientList.text, adoConn) = 0 Then
        ShowMsgInTaskBar "The posting date cannot fall within a closed financial period", "Y", "N"
        adoConn.Close
        Exit Sub
    ElseIf IsPeriodStatus(lblRptPostingDate.ToolTipText, txtRptClientList.text, adoConn) = 9 Then
        ShowMsgInTaskBar "The Posting date does not fall in any existing financial period", "Y", "N"
        adoConn.Close
        Exit Sub
    End If
    
    
   If txtReceiptReference.text = "" Then
      If MsgBox("Do you wish to save this transaction without entering a reference?", vbQuestion + vbYesNo, "Save") = vbNo Then
         txtReceiptReference.SetFocus
         Exit Sub
      End If
   End If
   If chkApplyFund.Value = True Then
        If isThereBankFundSetup(adoConn) = False Then
            'MsgBox "", vbOKOnly, "Warning"
            MsgBox "You must assign a Bank Account to all funds being processed.", vbInformation, "Warning"
            Exit Sub
        End If
   End If
   
   If isThereBankFundSetup(adoConn) = True Then
        If chkApplyFund.Value = False Then
            If MsgBox("Do you wish to apply a Fund Bank A/C to this receipt?", vbYesNo, "Confirmation?") = vbYes Then
                chkApplyFund.Value = True
            End If
        End If
   End If
   adoConn.Close
   If Val(txtSPaymentTotal.text) < 0 Then
    'Anol implement bank overdraft here 09 Apr 2015
    'issue 525
     
     adoConn.Open getConnectionString
     

     dblBankBanlance = BankAccBalance(adoConn, txtBankCode.text, txtRptClientList.text)
     adoConn.Close
     If dblBankBanlance - Val(txtSPaymentTotal.text) < 0 Then 'Account balance-Current Amount
          Call UpdateBankOverDraft(adoConn, isOverDraftAllowed, dblOverdraftAmount) 'which updates isOverDraftAllowed,dblOverdraftAmount variables for future use
          If isOverDraftAllowed Then
             If dblOverdraftAmount > 0 Then
                If (dblBankBanlance - Val(txtSPaymentTotal.text)) * (-1) > dblOverdraftAmount Then
                   If MsgBox("This Bank Account is over its overdraft limit. Do you wish to continue?", vbQuestion + vbYesNo, "Bank Overdrawn") = vbNo Then Exit Sub
                End If
             End If
          Else
             MsgBox "This Bank Account cannot go overdrawn", vbInformation + vbOKOnly, "Bank Overdraft"
             Exit Sub
          End If
    End If
    'End of modification
      If MsgBox("Would you like to book a receipt refund?", vbQuestion + vbYesNo, "Refund") = vbNo Then
         txtSPaymentTotal.text = "0.00"
         Exit Sub
      Else
         Load frmFund4RptPay
         frmFund4RptPay.szCallerForm = "Demand"
         frmFund4RptPay.Show 1
         If lFund = -1 Then
            MsgBox "You cannot book a receipt refund without a fund.", vbInformation + vbOKOnly, "Refund"
            SelTxtInCtrl txtSPaymentTotal
            txtSPaymentTotal.SetFocus
            Exit Sub
         End If
      End If
   End If

   cRoA = -1
'   cGridRptTotal = TotalReceiptEntered ' ReceiptEntered based on header. as split updated Header
   If Val(txtSPaymentTotal.text) > cGridRptTotal Then
      If MsgBox("There is an unallocated payment of " & _
                 Format(Val(txtSPaymentTotal.text) - cGridRptTotal, "0.00") & "." & Chr(10) & Chr(10) & _
                "Do you wish to Post this as a Receipt on Account?", vbQuestion + vbYesNo, "Confirm") = vbNo Then
         txtSPaymentTotal.SetFocus
         SelTxtInCtrl txtSPaymentTotal
         Exit Sub
      Else
         cRoA = Val(txtSPaymentTotal.text) - cGridRptTotal
         Load frmFund4RptPay
         frmFund4RptPay.szCallerForm = "Demand"
         frmFund4RptPay.Show 1
         If lFund = -1 Then
            MsgBox "You cannot save a Receipt on Account without a fund.", vbInformation + vbOKOnly, "Receipt on Account"
            SelTxtInCtrl txtSPaymentTotal
            txtSPaymentTotal.SetFocus
            Exit Sub
         End If
      End If
   Else
      If Val(txtSPaymentTotal.text) > 0 Then _
         If MsgBox("Do you want to save?", vbQuestion + vbYesNo, "Save") = vbNo Then Exit Sub
   End If

   
   adoConn.Open getConnectionString
   adoConn.BeginTrans
   szaTenant = Split(txtTenantID.text, " \ ")

'  Generate the next Transaction Id from the tlbReceipt
 
   szSQL = "SELECT MAX(TransactionID) AS TID FROM tlbReceipt"
   rstSet.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
   lRpt_ID = CLng(IIf(IsNull(rstSet!TID), 1, rstSet!TID))
   rstSet.Close
   szSQL = "SELECT MAX(TransactionID) AS TID FROM RptTransactions;"
   rstSet.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
   lRptT_ID = CLng(IIf(IsNull(rstSet!TID), 1, rstSet!TID))
   rstSet.Close
   
   szSQL = "SELECT MAX(TransactionID) AS TID FROM RptTransactionsSplit;"
   RptTransactionsSplit.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
   lRptT_ID_Split = CLng(IIf(IsNull(RptTransactionsSplit!TID), 1, RptTransactionsSplit!TID))
   RptTransactionsSplit.Close

   If cGridRptTotal > 0 Then              'if any receipts in the grid have been created
      

      bTotalRptTyped = False
     If chkApplyFund.Value = False Then
            '*******************************************************  RECEIPT ******************************************
            '     Save the header part of the receipt in the tlbReceipt table.
                  szSQL = "SELECT * FROM tlbReceipt;"
                  rstSet.Open szSQL, adoConn, adOpenDynamic, adLockPessimistic
            
                  lSlNumber = SlNumber("SR", "tlbReceipt", adoConn)
            
                  With rstSet
                     .AddNew
                     lRpt_ID = lRpt_ID + 1 'primary key of tlbReceipt (a long number)
                     !TransactionID = lRpt_ID
                     !szTransactionID = CStr(!TransactionID)
                     !Type = 3                                             'CByte(sdoSR)
                     !SageAccountNumber = szaTenant(0)
                     szUnit = GetUnitIDbyTenantID(szaTenant(0), adoConn)
                     !unitid = IIf(szUnit = "NOT OCCUPYING", Null, szUnit)
                     !RDate = Format(txtSPDate.text, "dd mmmm yyyy")
                     !dDate = Format(txtSPDate.text, "dd mmmm yyyy")
                     !ref = txtReceiptReference.text '"SR" & Format(Now, "yymmddhhmmss") Modified by anol 2016 July 07
                     !Details = "SALES RECEIPT"
                     'cGridRptTotal= ReceiptEntered based on header. as split updated Header
                     !amount = CCur(cGridRptTotal) 'Note I do not find fund and OSamount here anol 20181125,explanation: FundID is used in split. OS amount is updated at the end
                    'updating OSamount later after some calculations
                     !IsSageUpdate = False
                     !UpdateSage = False
                     !ReceiptView = False
                     !ExtRef = txtReceiptReference.text
                     !RptAmtType = txtRcptAmtType.Tag
                     !BankCode = txtBankCode.text
                     !nominalCode = !BankCode
                     !SlNumber = lSlNumber 'max SR no from tlbreceipt
                     !postingDate = Format(lblRptPostingDate.ToolTipText, "dd mmmm yyyy")
                     !ClientID = Trim(txtRptClientList.text)
                     .Update
                     .Close
                  End With
                
            '*******************************************  RECEIPT SPLITS  ******************************************
            '     Saving the split(s) of the header.
            '     Each split will keep track of the corresponding SI's split ID in @AllocTranID
                  szSQL = "SELECT * FROM tlbReceiptSplit;"
                  rstSet.Open szSQL, adoConn, adOpenDynamic, adLockPessimistic
            'This split loop only run for positive values . need to branch for the negative lines
                  For iRow = 1 To flxSPayment.Rows - 1
                     If baChangesMade(iRow) And CCur(IIf(flxSPayment.TextMatrix(iRow, 10) = "", 0, flxSPayment.TextMatrix(iRow, 10))) > 0 And _
                           (flxSPayment.TextMatrix(iRow, 0) = "" Or flxSPayment.TextMatrix(iRow, 0) = "-") Then
                            lRptT_ID_Split = lRptT_ID_Split + 1
                        With rstSet
                           .AddNew
                           .Fields.Item("TransactionID").Value = UniqueID()
                           .Fields.Item("RptHeader").Value = lRpt_ID
                           .Fields.Item("FundID").Value = flxSPayment.TextMatrix(iRow, 14)
                           .Fields.Item("Amount").Value = flxSPayment.TextMatrix(iRow, 10) 'we are updating osAmount later. at the end of the procedure
                           If flxSPayment.TextMatrix(iRow, 0) = "" Then
                              .Fields.Item("SplitID").Value = 1
                           Else
                              .Fields.Item("SplitID").Value = flxSPayment.TextMatrix(iRow, 1)
                           End If
                           .Fields.Item("DueDate").Value = Format(Now, "dd mmmm yyyy")
                           .Fields.Item("Description").Value = flxSPayment.TextMatrix(iRow, 7)
                           .Fields.Item("AllocTranID").Value = flxSPayment.TextMatrix(iRow, 19)
                           '.Fields.Item("PropertyID").Value = flxSPayment.TextMatrix(iRow, 19)
                           .Fields.Item("RptTransactionsIDSplit").Value = lRptT_ID_Split ' flxSPayment.TextMatrix(iRow, 19)
                           .Fields.Item("PropertyID").Value = flxSPayment.TextMatrix(iRow, 30)
                           .Update
                        End With
                        ''start  of code by anol 2021-10-24
                        szSQL = "SELECT * FROM RptTransactionsSplit;"
                        rsAllocationSplit.Open szSQL, adoConn, adOpenDynamic, adLockPessimistic
                        With rsAllocationSplit
                                .AddNew
                                !TransactionID = lRptT_ID_Split
                                !FromTran = lRpt_ID   'receipt ID
                                !ToTran = CLng(flxSPayment.TextMatrix(iRow, 3)) 'rpt Header in the RceiptSplit
                                '!AllocDate = Format(Date, "DD MMMM YYYY")
                                !AllocDate = Format(txtAllocationDAte.text, "dd mmmm yyyy")
                                !receiptAmount = CCur(flxSPayment.TextMatrix(iRow, 10))
                                !BankCode = txtBankCode.text
                                !nominalCode = !BankCode
                                 If flxSPayment.TextMatrix(iRow, 29) = "" Then  'This condition is for PPR . enter full amount as net amount and vat is zero
                                            !VATAMOUNT = 0
                                            !NetAmount = flxSPayment.TextMatrix(iRow, 10)
                                 Else ' 'if demand type is SI/1 then this
                                         !VATAMOUNT = CalculateVatAmountFormdmsplit(adoConn, CLng(flxSPayment.TextMatrix(iRow, 29)), flxSPayment.TextMatrix(iRow, 1), flxSPayment.TextMatrix(iRow, 10))
                                         !NetAmount = CalculateNetAmountFormdmsplit(adoConn, CLng(flxSPayment.TextMatrix(iRow, 29)), flxSPayment.TextMatrix(iRow, 1), flxSPayment.TextMatrix(iRow, 10))
                                 End If
                                 !VAT_PERIOD_END_DATE = Null ' I am not sure about it, need to ask
                                 !SplitIDofSI = rstSet.Fields.Item("SplitID").Value
                                 !deleteFlag = False
                                 
                                 .Update
                                .Close
                        End With
                        'End of code by anol
                     End If
                  Next iRow
                  rstSet.Close
            
                  cGridRptTotal = 0
            '  ************   Update the OS balance of tlbReceipt ( SR )in the receipt table
                  For iRow = 1 To flxSPayment.Rows - 1
                     If baChangesMade(iRow) And _
                        CCur(IIf(flxSPayment.TextMatrix(iRow, 10) = "", 0, flxSPayment.TextMatrix(iRow, 10))) > 0 And _
                              flxSPayment.TextMatrix(iRow, 0) <> "-" Then
            
                        szSQL = "SELECT * FROM tlbReceipt " & _
                                "WHERE TransactionID = " & flxSPayment.TextMatrix(iRow, 19) & ";"
                        rstSet.Open szSQL, adoConn, adOpenDynamic, adLockOptimistic
            
                        rstSet!OSAmount = RoundingNumber(CCur(flxSPayment.TextMatrix(iRow, 9)) - _
                                          CCur(flxSPayment.TextMatrix(iRow, 10)) - _
                                          CCur(IIf(flxSPayment.TextMatrix(iRow, 11) = "", 0, flxSPayment.TextMatrix(iRow, 11))), 2)
                        rstSet!OSAmount = RoundingNumber(rstSet!OSAmount, 2)
                        rstSet!ReceiptView = IIf(rstSet!OSAmount > 0, True, False)
                        rstSet.Update
                        rstSet.Close
                        
            '   Create the relationship btn the SI and SR header. Relationship btn SI split and SR split is recorded in
            '   receipt split table.
            '   refix done on 2021-10-24 by anol
                                szSQL = "SELECT * FROM RptTransactions;"
                                            With rstSet
                                               .Open szSQL, adoConn, adOpenDynamic, adLockOptimistic
                                               .AddNew
                                               !TranType = "AL"
                                               lRptT_ID = lRptT_ID + 1
                                               !TransactionID = lRptT_ID
                                               !Alloc_Unalloc = 1
                                               !FromTran = lRpt_ID   'receipt ID
                                               !ToTran = CLng(flxSPayment.TextMatrix(iRow, 19)) 'SI ID
                                               !AllocDate = Format(txtAllocationDAte, "DD MMMM YYYY")
                                               !receiptAmount = CCur(flxSPayment.TextMatrix(iRow, 10))
                                               !BankCode = txtBankCode.text
                                               !nominalCode = !BankCode
                                               !SlNumber = lSlNumber 'max SR no from tlbreceipt
                                               !deleteFlag = False
                                               .Update
                                               .Close
                                            End With
                                           
                     End If
                     If baChangesMade(iRow) And CCur(IIf(flxSPayment.TextMatrix(iRow, 10) = "", 0, flxSPayment.TextMatrix(iRow, 10))) > 0 And _
                              (flxSPayment.TextMatrix(iRow, 0) = "-" Or flxSPayment.TextMatrix(iRow, 0) = "") Then
                        If flxSPayment.TextMatrix(iRow, 0) = "" Then
                           adoConn.Execute "UPDATE tlbReceiptSplit " & _
                                           "SET OSAmount = " & RoundingNumber(CCur(flxSPayment.TextMatrix(iRow, 9)), 2) - _
                                             CCur(flxSPayment.TextMatrix(iRow, 10)) - _
                                             CCur(IIf(flxSPayment.TextMatrix(iRow, 11) = "", 0, _
                                             flxSPayment.TextMatrix(iRow, 11))) & " " & _
                                           "WHERE RptHeader = " & flxSPayment.TextMatrix(iRow, 19) & " AND " & _
                                             "SplitID = 1;"
                                             
                        End If
                        If flxSPayment.TextMatrix(iRow, 0) = "-" Then
            
                                   adoConn.Execute "UPDATE tlbReceiptSplit " & _
                                                   "SET OSAmount = " & RoundingNumber(CCur(flxSPayment.TextMatrix(iRow, 9)), 2) - _
                                                     CCur(flxSPayment.TextMatrix(iRow, 10)) - _
                                                     CCur(IIf(flxSPayment.TextMatrix(iRow, 11) = "", 0, _
                                                     flxSPayment.TextMatrix(iRow, 11))) & " " & _
                                                   "WHERE RptHeader = " & flxSPayment.TextMatrix(iRow, 3) & " AND " & _
                                                     "SplitID = " & flxSPayment.TextMatrix(iRow, 1) & ";"
                                                     'column 11 is discount and this column isn't in use
                        End If
                     End If
                  Next iRow
               
    Else 'This else is starting for when you are allocating by fund and you save separate SR for each lines
           ' Exit Sub
                  lSlNumber = SlNumber("SR", "tlbReceipt", adoConn)
                  szUnit = GetUnitIDbyTenantID(szaTenant(0), adoConn)
            '     Saving the split(s) of the header.
            '     Each split will keep track of the corresponding SI's split ID in @AllocTranID
                  szSQL = "SELECT * FROM tlbReceiptSplit;"
                  rstSet.Open szSQL, adoConn, adOpenDynamic, adLockPessimistic
            'This split loop only run for positive values . need to branch for the negative lines
                  For iRow = 1 To flxSPayment.Rows - 1
                     If baChangesMade(iRow) And CCur(IIf(flxSPayment.TextMatrix(iRow, 10) = "", 0, flxSPayment.TextMatrix(iRow, 10))) > 0 And _
                           (flxSPayment.TextMatrix(iRow, 0) = "" Or flxSPayment.TextMatrix(iRow, 0) = "-") Then
                     '*******************************************************  RECEIPT ******************************************
                     '     Save the header part of the receipt in the tlbReceipt table.
                           szSQL = "SELECT * FROM tlbReceipt;"
                            rsReceipt.Open szSQL, adoConn, adOpenDynamic, adLockPessimistic
                            With rsReceipt
                               .AddNew
                               lRpt_ID = lRpt_ID + 1 'primary key of tlbReceipt (a long number)
                               !TransactionID = lRpt_ID
                               !szTransactionID = CStr(!TransactionID)
                               !Type = 3                                             'CByte(sdoSR)
                               !SageAccountNumber = szaTenant(0)
                               !unitid = IIf(szUnit = "NOT OCCUPYING", Null, szUnit)
                               !RDate = Format(txtSPDate.text, "dd mmmm yyyy")
                               !dDate = Format(txtSPDate.text, "dd mmmm yyyy")
                               !ref = txtReceiptReference.text '"SR" & Format(Now, "yymmddhhmmss") Modified by anol 2016 July 07
                               !Details = "SALES RECEIPT"
                               'Exit Sub
                               'cGridRptTotal= ReceiptEntered based on header. as split updated Header
                               !amount = CCur(flxSPayment.TextMatrix(iRow, 10))
                               !OSAmount = 0
'                              'updating OSamount later after some calculations
                               !IsSageUpdate = False
                               !UpdateSage = False
                               !ReceiptView = False
                               !ExtRef = txtReceiptReference.text
                               !RptAmtType = txtRcptAmtType.Tag
                               !BankCode = ReturnBankCode(adoConn, flxSPayment.TextMatrix(iRow, 14))
                               If !BankCode = "" Then
                                    '.Close
                                    MsgBox "You must assign a Bank Account to all funds being processed.", vbInformation, "Warning"
                                    Exit Sub
                               End If
                               !nominalCode = !BankCode
                               !SlNumber = lSlNumber 'max SR no from tlbreceipt
                               !postingDate = Format(lblRptPostingDate.ToolTipText, "dd mmmm yyyy")
                               !ClientID = Trim(txtRptClientList.text)
                               .Update
                               .Close
                            End With
                   '*******************************************  RECEIPT SPLITS  ******************************************
                            lSlNumber = lSlNumber + 1
                            lRptT_ID_Split = lRptT_ID_Split + 1
                        With rstSet
                           .AddNew
                           .Fields.Item("TransactionID").Value = UniqueID()
                           .Fields.Item("RptHeader").Value = lRpt_ID
                           .Fields.Item("FundID").Value = flxSPayment.TextMatrix(iRow, 14)
                           .Fields.Item("Amount").Value = flxSPayment.TextMatrix(iRow, 10) 'we are updating osAmount later. at the end of the procedure
                           .Fields.Item("OSAmount").Value = 0
                           .Fields.Item("SplitID").Value = 1
                           .Fields.Item("DueDate").Value = Format(Now, "dd mmmm yyyy")
                           .Fields.Item("Description").Value = flxSPayment.TextMatrix(iRow, 7)
                           .Fields.Item("AllocTranID").Value = flxSPayment.TextMatrix(iRow, 19)
                           .Fields.Item("RptTransactionsIDSplit").Value = lRptT_ID_Split ' flxSPayment.TextMatrix(iRow, 19)
                           .Fields.Item("PropertyID").Value = flxSPayment.TextMatrix(iRow, 30)
                           .Update
                        End With
                        '   Create the relationship btn the SI and SR header. Relationship btn SI split and SR split is recorded in
                        'Exit Sub
                         szSQL = "SELECT * FROM RptTransactions;"
                            With rsRptTransactions
                               .Open szSQL, adoConn, adOpenDynamic, adLockOptimistic
                               .AddNew
                               !TranType = "AL"
                               lRptT_ID = lRptT_ID + 1
                               !TransactionID = lRptT_ID
                               !Alloc_Unalloc = 1
                               !FromTran = lRpt_ID   'receipt ID
                               !ToTran = CLng(flxSPayment.TextMatrix(iRow, 3)) 'SI ID why 19 not working
                               !AllocDate = Format(txtAllocationDAte, "DD MMMM YYYY")
                               !receiptAmount = CCur(flxSPayment.TextMatrix(iRow, 10))
                               !BankCode = txtBankCode.text
                               !nominalCode = !BankCode
                               !SlNumber = lSlNumber 'max SR no from tlbreceipt
                               !deleteFlag = False
                               .Update
                               .Close
                            End With
                                            
                        ''start  of code by anol 2021-10-24
                        szSQL = "SELECT * FROM RptTransactionsSplit;"
                        rsAllocationSplit.Open szSQL, adoConn, adOpenDynamic, adLockPessimistic
                        With rsAllocationSplit
                                .AddNew
                                !TransactionID = lRptT_ID_Split
                                !FromTran = lRpt_ID   'receipt ID
                                !ToTran = CLng(flxSPayment.TextMatrix(iRow, 3)) 'rpt Header in the ReceiptSplit
                                !AllocDate = Format(txtAllocationDAte.text, "dd mmmm yyyy")
                                !receiptAmount = CCur(flxSPayment.TextMatrix(iRow, 10))
                                !BankCode = txtBankCode.text
                                !nominalCode = !BankCode
                                 If flxSPayment.TextMatrix(iRow, 29) = "" Then  'This condition is for PPR . enter full amount as net amount and vat is zero
                                         !VATAMOUNT = 0
                                         !NetAmount = rstSet.Fields.Item("Amount").Value
                                 Else ' 'if demand type is SI/1 then this
                                         !VATAMOUNT = CalculateVatAmountFormdmsplit(adoConn, CLng(flxSPayment.TextMatrix(iRow, 29)), CLng(flxSPayment.TextMatrix(iRow, 1)), CCur(flxSPayment.TextMatrix(iRow, 10)))
                                         !NetAmount = CalculateNetAmountFormdmsplit(adoConn, CLng(flxSPayment.TextMatrix(iRow, 29)), CLng(flxSPayment.TextMatrix(iRow, 1)), CCur(flxSPayment.TextMatrix(iRow, 10)))
                                 End If
                                 !VAT_PERIOD_END_DATE = Null ' I am not sure about it, need to ask
                                 !SplitIDofSI = CLng(flxSPayment.TextMatrix(iRow, 1))
                                 !deleteFlag = False
                                 .Update
                                .Close
                        End With
                        'Exit Sub
                        'UPdate OsAmount of SI split
                        szSQL = "SELECT * FROM tlbReceiptSplit " & _
                                "WHERE RptHeader = " & flxSPayment.TextMatrix(iRow, 3) & " AND SplitID = " & flxSPayment.TextMatrix(iRow, 1) & " ;" 'need to check properly here was 19 index
                        rstlbReceiptSplit.Open szSQL, adoConn, adOpenDynamic, adLockOptimistic
                        rstlbReceiptSplit!OSAmount = CCur(flxSPayment.TextMatrix(iRow, 9)) - _
                                    CCur(flxSPayment.TextMatrix(iRow, 10))
                        rstlbReceiptSplit!OSAmount = RoundingNumber(rstlbReceiptSplit!OSAmount, 2)
                        rstlbReceiptSplit.Update
                        rstlbReceiptSplit.Close
            
                        'Update OS Amount and view of SI
                        szSQL = "SELECT * FROM tlbReceipt " & _
                                "WHERE TransactionID = " & flxSPayment.TextMatrix(iRow, 3) & ";" 'need to check properly here was 19 index
                        rstlbReceipt.Open szSQL, adoConn, adOpenDynamic, adLockOptimistic
            
                        
                        Dim iHeaderRow As Integer
                        iHeaderRow = iRow
                        Do
                                iHeaderRow = iHeaderRow - 1
                                 If flxSPayment.TextMatrix(iHeaderRow, 0) = "+" Or flxSPayment.TextMatrix(iHeaderRow, 0) = ">" Then
                                            rstlbReceipt!OSAmount = RoundingNumber(CCur(flxSPayment.TextMatrix(iHeaderRow, 9)) - _
                                                CCur(flxSPayment.TextMatrix(iHeaderRow, 10)) - _
                                                CCur(IIf(flxSPayment.TextMatrix(iHeaderRow, 11) = "", 0, flxSPayment.TextMatrix(iHeaderRow, 11))), 2)
                                                Exit Do
                                 End If
                                 
                                 If iCurRow = 0 Then Exit Do
                        Loop While Not (flxSPayment.TextMatrix(iHeaderRow, 0) = "+" Or flxSPayment.TextMatrix(iHeaderRow, 0) = ">")
         
                        
                        rstlbReceipt!OSAmount = RoundingNumber(rstlbReceipt!OSAmount, 2)
                        rstlbReceipt!ReceiptView = IIf(rstlbReceipt!OSAmount > 0, True, False)
                        rstlbReceipt.Update
                        rstlbReceipt.Close
                        
                        
                     End If
                  Next iRow
          End If
    End If
    chkApplyFund.Value = 0
'**************************************************************************************
'  Saving Receipt on Account            ************* RoA *****************************
'**************************************************************************************
   If cRoA > 0 Then
      lRpt_ID = lRpt_ID + 1

      szSQL = "SELECT * FROM tlbReceipt;"
      With rstSet
        If rstSet.State = 1 Then
            rstSet.Close
        End If
         .Open szSQL, adoConn, adOpenDynamic, adLockOptimistic

         lSlNumber = SlNumber("SA", "tlbReceipt", adoConn)

         .AddNew
         !TransactionID = lRpt_ID
         !szTransactionID = !TransactionID
         !Type = 4 'CByte(sdoSA)                   'tlbTransactionType.TYPE_ID (4) = Sales Receipt on Account
         !SageAccountNumber = szaTenant(0)
         !unitid = GetUnitIDbyTenantID(szaTenant(0), adoConn)
         !RDate = Format(txtSPDate.text, "dd mmmm yyyy")
         !dDate = Format(txtSPDate.text, "dd mmmm yyyy")
         !ref = "SA" & Format(Now, "yymmddhhmmss")
         !Details = "Receipt on Account"
         !amount = cRoA
         !OSAmount = RoundingNumber(!amount, 2)           'amount to be allocated
         !ReceiptView = True
         If isThereBankFundSetup(adoConn) = False Then
            !BankCode = txtBankCode.text
         Else
                !BankCode = ReturnBankCode(adoConn, lFund)
                 If !BankCode = "" Then
                    MsgBox "You must assign a Bank Account to all funds being processed.", vbInformation, "Warning"
                    Exit Sub
                 End If
          End If
         !nominalCode = !BankCode
         !ExtRef = txtReceiptReference.text
         !RptAmtType = txtRcptAmtType.Tag
         !SlNumber = lSlNumber
         !fundID = lFund
         !postingDate = Format(lblRptPostingDate.ToolTipText, "dd mmmm yyyy")
         !ClientID = Trim(txtRptClientList.text)
         .Update
         .Close
      End With

'     Saving the split(s) of the header
      szSQL = "SELECT * FROM tlbReceiptSplit;"
      rstSet.Open szSQL, adoConn, adOpenDynamic, adLockPessimistic

      With rstSet
         .AddNew
         .Fields.Item("TransactionID").Value = UniqueID()
         .Fields.Item("RptHeader").Value = lRpt_ID
         .Fields.Item("FundID").Value = lFund
         .Fields.Item("Amount").Value = cRoA
         .Fields.Item("OSAmount").Value = .Fields.Item("Amount").Value
         .Fields.Item("SplitID").Value = 1
         .Fields.Item("DueDate").Value = Format(txtSPDate.text, "dd mmmm yyyy")
         .Fields.Item("Description").Value = "Receipt on Account"
         .Update
      End With
      rstSet.Close
   End If

'**************************************************************************************
'  Saving Refund      ******************* SALES RECEIPT REFUND ********  SRR  *********
'**************************************************************************************
   If Val(txtSPaymentTotal.text) < 0 Then
      lRpt_ID = lRpt_ID + 1

      szSQL = "SELECT * FROM tlbReceipt;"
      rstSet.Open szSQL, adoConn, adOpenDynamic, adLockOptimistic

      lSlNumber = SlNumber("SRR", "tlbReceipt", adoConn)

      rstSet.AddNew
      rstSet!TransactionID = lRpt_ID
      rstSet!szTransactionID = rstSet!TransactionID
      rstSet!Type = 23
      rstSet!SageAccountNumber = szaTenant(0)
      rstSet!unitid = GetUnitIDbyTenantID(szaTenant(0), adoConn)
      rstSet!RDate = Format(txtSPDate.text, "dd mmmm yyyy")
      rstSet!dDate = Format(txtSPDate.text, "dd mmmm yyyy")
      rstSet!ref = "SRR" & Format(Now, "yymmddhhmmss")
      rstSet!Details = "Sales Receipt Refund"
      rstSet!amount = txtSPaymentTotal.text * (-1)
      rstSet!OSAmount = RoundingNumber(rstSet!amount, 2)
      rstSet!ReceiptView = True
      If isThereBankFundSetup(adoConn) = False Then
            rstSet!BankCode = txtBankCode.text
      Else
            rstSet!BankCode = ReturnBankCode(adoConn, lFund)
            If rstSet!BankCode = "" Then
                MsgBox "You must assign a Bank Account to all funds being processed.", vbInformation, "Warning"
                Exit Sub
            End If
      End If
      rstSet!nominalCode = rstSet!BankCode
      rstSet!ExtRef = txtReceiptReference.text
      rstSet!RptAmtType = txtRcptAmtType.Tag
      rstSet!SlNumber = lSlNumber
      rstSet!fundID = lFund
      rstSet!postingDate = Format(lblRptPostingDate.ToolTipText, "dd mmmm yyyy")
      rstSet!ClientID = Trim(txtRptClientList.text)
      rstSet.Update
      rstSet.Close

'     Saving the split(s) of the header
      szSQL = "SELECT * FROM tlbReceiptSplit;"
      rstSet.Open szSQL, adoConn, adOpenDynamic, adLockPessimistic

      With rstSet
         .AddNew
         .Fields.Item("TransactionID").Value = UniqueID()
         .Fields.Item("RptHeader").Value = lRpt_ID
         .Fields.Item("FundID").Value = lFund
         .Fields.Item("Amount").Value = txtSPaymentTotal.text * (-1)
         .Fields.Item("OSAmount").Value = .Fields.Item("Amount").Value
         .Fields.Item("SplitID").Value = 1
         .Fields.Item("DueDate").Value = Format(txtSPDate.text, "dd mmmm yyyy")
         .Fields.Item("Description").Value = "Sales Receipt Refund"
         .Update
      End With
      rstSet.Close
   End If

   MousePointer = vbArrow

   

'********    System will check the header amount with the split total amount ****************
   'added by anol 20170117
'   Call SiPi_Check(adoConn, "SI", "15876")
   If SI_Check2(adoConn, "15876") = True Or ChecksumValidationOnAllocation(adoConn) = False Then
        adoConn.RollbackTrans
        adoConn.Close
        Exit Sub
   Else
        adoConn.CommitTrans
        adoConn.Close
        frmMMain.Leasee1_LesseList_isUptoDate = False
        frmMMain.Leasee4_LesseList_isUptoDate = False
        frmMMain.frmDemand3_LesseList_isUptoDate = False
   End If
   
   adoConn.Open getConnectionString
'--------------------------------------------------------------------------------------------
'  Export Sales receipt and sales receipt refund Transactions to Nominal Ledger (NLPosting table)
   Export_SRnSRR_2_NL adoConn
'--------------------------------------------------------------------------------------
'  ShowMsgInTaskBar "Receipt has been saved successfully."
   bChangesMade = False
   cmdBankAc.Enabled = True
   txtArray(5).text = "0.00"
   txtArray(3).text = "0.00"
   Set rstSet = Nothing

   'issue 523
   'Modified by anol 20 Jan 2015
   UpdateBankAcBal_Plus adoConn, Val(txtSPaymentTotal.text), txtBankCode.text, txtRptClientList.text

   MousePointer = vbHourglass

   ConfigFlxCrPoA
   ConfigFlxSPayment

   UpdateLesseeAccBal

   txtTenantID.text = ""
   'modified by anol 20170922 issue 409
'   cmbBankAc.text = ""
   txtReceiptReference.text = ""
   txtReceiptEntered.text = "0.00"
   txtSPaymentTotal.text = "0.00"
   txtTntAcBal.text = "0.00"

   flxCrPoA.Enabled = True
   cmeRevereseAllocation.Enabled = True
   cmdAllocate.Enabled = True

   ReDim baChangesMade(flxSPayment.Rows) As Boolean

'  ****************                 UPDATING OPENED ### CASHBOOK ### GRIDS
   UpdatingCB adoConn
'  ***********************************************************************

   If IsLoadedAndVisible("frmAutoBankReconciliation") Then
      frmAutoBankReconciliation.LoadDataExternally adoConn
   End If

   'LoadFlxGrid flxDemands, False, adoConn, ""
    LoadFlxDemands adoConn, ""
   ConfigFlxGrid flxChildDemands
   LoadFlxGrid flxDemandHistory, True, adoConn, ""  'True - uploading history records
   ConfigFlxGrid flxChildDemandHistory

   adoConn.Close
   Set adoConn = Nothing

   MousePointer = vbDefault
   'modified by anol 20170922 issue 409
   cmdTenantLookup_Click
   cmdRptClientList.Enabled = True
   cmdRptPropertyList.Enabled = True
   cmdBankAc.Enabled = True
   If IsLoadedAndVisible("frmCashbook") = True Then
            frmCashbook.cboBC_Click
   End If
   MsgBox "Receipt has been saved successfully.", vbInformation, "Saved"
   lblAllocating.Visible = False
   bTotalRptTyped = False
End Sub
Private Function CalculateVatAmountFormdmsplit(adoConn As ADODB.Connection, szDemandID As String, szSpitID As Integer, dblSIVATAmount As Double) As Double
    Dim rsDemandSplitRecords As New ADODB.Recordset
    rsDemandSplitRecords.Open "Select AMOUNT+VATAMOUNT as amt,VATAMOUNT from DemandSplitRecords where DemandID=" & szDemandID & " and SplitID=" & szSpitID & " ", adoConn, adOpenStatic, adLockReadOnly
    If Not rsDemandSplitRecords.EOF Then
            CalculateVatAmountFormdmsplit = dblSIVATAmount / IIf(IsNull(rsDemandSplitRecords("amt").Value), 0, rsDemandSplitRecords("amt").Value)
             CalculateVatAmountFormdmsplit = CalculateVatAmountFormdmsplit * IIf(IsNull(rsDemandSplitRecords("VATAMOUNT").Value), 0, rsDemandSplitRecords("VATAMOUNT").Value)
    End If
    rsDemandSplitRecords.Close
    
End Function
Private Function CalculateNetAmountFormdmsplit(adoConn As ADODB.Connection, szDemandID As String, szSpitID As Integer, dblSINetAmount) As Double
    Dim rsDemandSplitRecords As New ADODB.Recordset
    rsDemandSplitRecords.Open "Select AMOUNT+VATAMOUNT as amt,AMOUNT  from DemandSplitRecords where DemandID=" & szDemandID & "  and SplitID=" & szSpitID & "", adoConn, adOpenStatic, adLockReadOnly
    If Not rsDemandSplitRecords.EOF Then
             CalculateNetAmountFormdmsplit = dblSINetAmount / IIf(IsNull(rsDemandSplitRecords("amt").Value), 0, rsDemandSplitRecords("amt").Value)
             CalculateNetAmountFormdmsplit = CalculateNetAmountFormdmsplit * IIf(IsNull(rsDemandSplitRecords("AMOUNT").Value), 0, rsDemandSplitRecords("AMOUNT").Value)
    End If
    rsDemandSplitRecords.Close

End Function
Private Function ChecksumValidationOnAllocation(adoConn As ADODB.Connection) As Boolean ' if returns true then true means data is fine and false means there is some inconsistent data
    'this function is written by anol 20181123 when found that (issue 673 )Updated OS amount 102 extra incorrectly
    'This function shall prevent saving the data if when outstading amount on receipt is not updated.
    'This function shall compare allocation with receipt amount and outstanding amount
    Dim rsChecksum As New ADODB.Recordset
    Dim adoRST As New ADODB.Recordset
    Dim szTran2Fix As String
    rsChecksum.Open "Select SlNumber,amount,osamount,amt,R.sageaccountnumber from tlbReceipt R,(select Sum(ReceiptAmount) as amt,ToTran from RptTransactions where DeleteFLag=False group By ToTran ) as A " & _
                    "Where a.ToTran = r.TransactionID And R.sageaccountnumber= '" & txtTenantID.Tag & "' AND Round((amount - amt), 2) <> Round(OSAmount, 2)", adoConn, adOpenStatic, adLockReadOnly
                    
'        If rsChecksum.EOF Then
'                ChecksumValidationOnAllocation = True
'        Else
'        rsChecksum.MoveFirst
                While Not rsChecksum.EOF
                    szTran2Fix = szTran2Fix + IIf(szTran2Fix = "", "SI", ",SI") + CStr(rsChecksum("SlNumber").Value) + " (" + rsChecksum("sageaccountnumber").Value + ") "
                    rsChecksum.MoveNext
                Wend
'        End If
        rsChecksum.Close
        Set rsChecksum = Nothing
     'for which records does not have entry in the allocation but osamount>amount
         adoRST.Open "Select R.transactionID,R.SlNumber,sageaccountnumber,amount,osamount from tlbReceipt R LEFT JOIN RptTransactions A ON " & _
                "A.Totran=R.transactionID where  DeleteFLag=False AND A.Totran IS NULL And R.sageaccountnumber= '" & txtTenantID.Tag & "' AND osamount>amount", adoConn, adOpenKeyset, adLockReadOnly
        While Not adoRST.EOF
             szTran2Fix = szTran2Fix + IIf(szTran2Fix = "", "SI", ",SI") + CStr(adoRST("SlNumber").Value) + " (" + adoRST("sageaccountnumber").Value + ") "
             adoRST.MoveNext
        Wend
        adoRST.Close
        Set adoRST = Nothing
        If szTran2Fix = "" Then
                ChecksumValidationOnAllocation = True
        Else
'                MsgBox "A problem occurred while creating this transaction: " & _
'                     Chr(13) & szTran2Fix & "." & _
'                     "Please contact PCM Consulting. This transaction has not been saved.", _
'                     vbInformation + vbOKOnly, "Demand receipt not saved!"
                MsgBox "A problem exists relating to a previous transaction entered against the selected lessee: " & _
                     Chr(13) & szTran2Fix & "." & _
                     "Please contact PCM Consulting. The current transaction will not be saved", _
                     vbInformation + vbOKOnly, "Warning! Problem Transaction Found!"

        End If
                
'Select  R.transactionID,R.SlNumber,'',R.sageaccountnumber,amount,osamount,amt from tlbReceipt R,(select Sum(ReceiptAmount) as amt,
'                   ToTran from RptTransactions  group By ToTran ) as A where A.ToTran=R.transactionID AND round((amount-amt),2)<>round(osamount,2)

'receipt check is fine on allocation
'Select  R.transactionID,R.SlNumber,'',R.sageaccountnumber,amount,osamount,amt from tlbReceipt R,(select Sum(ReceiptAmount) as amt, FromTran from
'RptTransactions  group By FromTran ) as A where A.FromTran=R.transactionID AND round((amount-amt),2)<>round(osamount,2)
                    
End Function
Private Function ReceiptAllocation_check(adoConn As ADODB.Connection) As Boolean ' ' if returns true then true means data is fine and false means there is some inconsistent data
    'this function is written by anol 20181123 when found that (issue 673 )Updated OS amount 102 extra incorrectly
    'This function shall prevent saving the data if when outstading amount on receipt is not updated.
    'This function shall compare allocation with receipt amount and outstanding amount
    Dim rsChecksum As New ADODB.Recordset
    Dim adoRST As New ADODB.Recordset
    Dim szTran2Fix As String
    rsChecksum.Open "Select SlNumber,amount,osamount,amt,R.sageaccountnumber from tlbReceipt R,(select Sum(ReceiptAmount) as amt,ToTran from RptTransactions where DeleteFlag=False group By ToTran ) as A " & _
                    "Where a.ToTran = r.TransactionID And R.sageaccountnumber= '" & txtTenantID.Tag & "' AND Round((amount - amt), 2) <> Round(OSAmount, 2)", adoConn, adOpenStatic, adLockReadOnly
                    
                While Not rsChecksum.EOF
                    szTran2Fix = szTran2Fix + IIf(szTran2Fix = "", "SI", ",SI") + CStr(rsChecksum("SlNumber").Value) + " (" + rsChecksum("sageaccountnumber").Value + ") "
                    rsChecksum.MoveNext
                Wend

        rsChecksum.Close
        Set rsChecksum = Nothing
     'for which records does not have entry in the allocation but osamount>amount
         adoRST.Open "Select R.transactionID,R.SlNumber,sageaccountnumber,amount,osamount from tlbReceipt R LEFT JOIN RptTransactions A ON " & _
                "A.Totran=R.transactionID where A.DeleteFlag=False AND A.Totran IS NULL And R.sageaccountnumber= '" & txtTenantID.Tag & "' AND osamount>amount", adoConn, adOpenKeyset, adLockReadOnly
        While Not adoRST.EOF
             szTran2Fix = szTran2Fix + IIf(szTran2Fix = "", "SI", ",SI") + CStr(adoRST("SlNumber").Value) + " (" + adoRST("sageaccountnumber").Value + ") "
             adoRST.MoveNext
        Wend
        adoRST.Close
        Set adoRST = Nothing
        If szTran2Fix = "" Then
             ReceiptAllocation_check = True
        Else
                
             MsgBox "A problem occurred while creating this transaction: " & _
             Chr(13) & szTran2Fix & "." & _
             "Please contact PCM Consulting. This transaction has not been saved.", _
             vbInformation + vbOKOnly, "SI Receipt Allocation rollbacked!"
        End If
        
End Function
Private Function ChecksumValidationOnAllocationTenantClick(adoConn As ADODB.Connection) As Boolean ' if returns true then true means data is fine and false means there is some inconsistent data
    'this function is written by anol 20181123 when found that (issue 673 )Updated OS amount 102 extra incorrectly
    'This function shall prevent saving the data if when outstading amount on receipt is not updated.
    'This function shall compare allocation with receipt amount and outstanding amount
    Dim rsChecksum As New ADODB.Recordset
    Dim adoRST As New ADODB.Recordset
    Dim szTran2Fix As String
    rsChecksum.Open "Select SlNumber,amount,osamount,amt,R.sageaccountnumber from tlbReceipt R,(select Sum(ReceiptAmount) as amt,ToTran from RptTransactions where deleteFlag=false  group By ToTran ) as A " & _
                    "Where a.ToTran = r.TransactionID And R.sageaccountnumber= '" & txtTenantID.Tag & "' AND Round((amount - amt), 2) <> Round(OSAmount, 2)", adoConn, adOpenStatic, adLockReadOnly
                    
'        If rsChecksum.EOF Then
'                ChecksumValidationOnAllocation = True
'        Else
'        rsChecksum.MoveFirst
                While Not rsChecksum.EOF
                    szTran2Fix = szTran2Fix + IIf(szTran2Fix = "", "SI", ",SI") + CStr(rsChecksum("SlNumber").Value) + " (" + rsChecksum("sageaccountnumber").Value + ") "
                    rsChecksum.MoveNext
                Wend
'        End If
        rsChecksum.Close
        Set rsChecksum = Nothing
     'for which records does not have entry in the allocation but osamount>amount
         adoRST.Open "Select R.transactionID,R.SlNumber,sageaccountnumber,amount,osamount from tlbReceipt R LEFT JOIN RptTransactions A ON " & _
                "A.Totran=R.transactionID where A.deleteFlag=false AND A.Totran IS NULL And R.sageaccountnumber= '" & txtTenantID.Tag & "' AND round(osamount,2)>round(amount,2)", adoConn, adOpenKeyset, adLockReadOnly
        While Not adoRST.EOF
             szTran2Fix = szTran2Fix + IIf(szTran2Fix = "", "SI", ",SI") + CStr(adoRST("SlNumber").Value) + " (" + adoRST("sageaccountnumber").Value + ") "
             adoRST.MoveNext
        Wend
        adoRST.Close
        Set adoRST = Nothing
        If szTran2Fix = "" Then
                ChecksumValidationOnAllocationTenantClick = True
        Else
                MsgBox "A problem transaction exists against this lessee: " & _
                     Chr(13) & szTran2Fix & "." & _
                     "Please contact PCM Consulting.", _
                     vbInformation + vbOKOnly, "Warning! Problem Transaction Found!"
        End If
                
'Select  R.transactionID,R.SlNumber,'',R.sageaccountnumber,amount,osamount,amt from tlbReceipt R,(select Sum(ReceiptAmount) as amt,
'                   ToTran from RptTransactions  group By ToTran ) as A where A.ToTran=R.transactionID AND round((amount-amt),2)<>round(osamount,2)

'receipt check is fine on allocation
'Select  R.transactionID,R.SlNumber,'',R.sageaccountnumber,amount,osamount,amt from tlbReceipt R,(select Sum(ReceiptAmount) as amt, FromTran from
'RptTransactions  group By FromTran ) as A where A.FromTran=R.transactionID AND round((amount-amt),2)<>round(osamount,2)
                    
End Function
Private Function SI_Check2(adoConn As ADODB.Connection, szErrorCode As String) As Boolean
   Dim szSQL      As String
   Dim adoRST     As New ADODB.Recordset
   Dim szTran2Fix As String




      szSQL = "SELECT  R.TransactionID,ROUND(R.Amount - R.OSAmount, 2) AS HeaderOS ,Q.T " & _
               "FROM tlbReceipt AS R, (" & _
                     "SELECT RptHeader, ROUND(Sum(Amount) - Sum(OSAmount), 2) AS T " & _
                     "From tlbReceiptSplit " & _
                     "Group by RptHeader " & _
                     ") AS Q " & _
               "WHERE R.TransactionID = Q.RptHeader AND R.Amount <> R.OSAmount AND " & _
                     "ROUND(R.Amount - R.OSAmount, 2) <> Q.T;"
'Debug.Print szSQL
      adoRST.Open szSQL, adoConn, adOpenStatic, adLockReadOnly

      While Not adoRST.EOF
         szTran2Fix = szTran2Fix + ", " + CStr(adoRST.Fields.Item("TransactionID").Value)

         adoRST.MoveNext
      Wend

      adoRST.Close


   Set adoRST = Nothing

   If Len(szTran2Fix) > 0 Then
        szTran2Fix = Mid(szTran2Fix, 3)
        SI_Check2 = True
    End If

   If Len(szTran2Fix) > 0 Then _
      MsgBox "An error occurred while creating this transaction: " & _
             Chr(13) & szTran2Fix & "." & _
             "Please contact PCM Consulting. The transaction was not saved.", _
             vbInformation + vbOKOnly, " Data No: " & szErrorCode
End Function
Private Sub UpdateLesseeAccBal()
   Dim i As Integer
   Dim szaTemp() As String

   szaTemp = Split(txtTenantID.text, " \ ")

   For i = LBound(szaTenantBalance, 1) To UBound(szaTenantBalance, 2)
      If szaTenantBalance(0, i) = szaTemp(0) Then
         szaTenantBalance(1, i) = szaTenantBalance(1, i) - txtReceiptEntered.text
         Exit For
      End If
   Next i

End Sub

Private Sub StopViewingReceipt(TID As Long, adoConn As ADODB.Connection)
   Dim szSQL As String

   szSQL = "UPDATE tlbReceipt " & _
           "SET tlbReceipt.ReceiptView = False " & _
           "WHERE tlbReceipt.TransactionID = " & TID & ";"
   adoConn.Execute szSQL
End Sub
Private Sub StopViewingPoA(TID As Long, adoConn As ADODB.Connection)
   Dim szSQL As String

   szSQL = "UPDATE tblPoA " & _
           "SET tblPoA.PoAView = False " & _
           "WHERE tblPoA.TransactionID = " & TID & ";"
   adoConn.Execute szSQL
End Sub

Private Sub LoadVATBk()
   flxLeaseList.Clear
   flxLeaseList.Cols = 4
   flxLeaseList.ColWidth(1) = 800
   flxLeaseList.ColWidth(2) = 800

   flxLeaseList.TextMatrix(0, 1) = "CODE"
   flxLeaseList.TextMatrix(0, 2) = "RATE"

'      ~~~ Added by Senthuran~~~ Configuring width and position of labels and search boxes.

   flxLeaseList.ColWidth(0) = 0
   flxLeaseList.ColWidth(3) = 0
   Label20(0).Width = 600
   Label20(0).Left = 50
   Label20(1).Width = 600
   Label20(1).Left = Label20(0).Left + flxLeaseList.ColWidth(1)

   txtTenantSearchID.Width = 600
   txtTenantSearchID.Left = 40

   txtTenantSearchName.Width = 600
   txtTenantSearchName.Left = txtTenantSearchID.Left + flxLeaseList.ColWidth(1)

   txtTenantSearchUnitName.Visible = False

'         ~~~Added By Senthuran~~~ Code to configuer Label Caption
   Label20(0).Caption = "Code"
   Label20(1).Caption = "Rate"
   Label20(2).Visible = False

'   ~~~ End of config

   Dim rRow As Integer
   Dim Conn2 As New ADODB.Connection

   Dim szSQL As String
   Dim rstRec As New ADODB.Recordset

'   Reset screen to show all the units in cboUnits.
   Conn2.Open getConnectionString

   szSQL = "SELECT VAT_CODE, VAT_RATE " & _
           "FROM tlbVatCode;"
   rstRec.Open szSQL, Conn2, adOpenStatic, adLockReadOnly

   If Not rstRec.EOF Then
      flxLeaseList.Clear

      rstRec.MoveFirst
      flxLeaseList.ColAlignment(1) = vbRightJustify

      rRow = 1
      While Not rstRec.EOF
         flxLeaseList.TextMatrix(rRow, 1) = rstRec!VAT_CODE
         flxLeaseList.TextMatrix(rRow, 2) = rstRec!VAT_RATE
         rstRec.MoveNext
         If Not rstRec.EOF Then flxLeaseList.AddItem ""
         rRow = rRow + 1
      Wend
   End If

   rstRec.Close
   Conn2.Close

   Set rstRec = Nothing
   Set Conn2 = Nothing
End Sub

Private Sub cmdUpdate_Click()
   'On Error GoTo Error_Handler
'issue 571 Validation
'Modified by Anol
   Dim NumOfSpaces As Integer
   If txtType.text = "" Then
      MsgBox "Please select a valid Demand Type to proceed.", vbCritical + vbOKOnly, "Demand Type"
      cmdType.SetFocus
      Exit Sub
   End If
'   If isdemandSameBank = False Then
'         Exit Sub
'   End If
   If txtFund.text = "" Then
      MsgBox "Please select a valid Fund Code to proceed.", vbCritical + vbOKOnly, "Demand Fund"
      cmdFund.SetFocus
      Exit Sub
   End If
   If txtAddNewDescription.text = "" Then
      MsgBox "Please enter a description.", vbCritical + vbOKOnly, "Description"
      txtAddNewDescription.SetFocus
      Exit Sub
   End If
   If txtDateFrom.text = "" Then
      MsgBox "Please enter a valid 'From Date' to proceed.", vbCritical + vbOKOnly, "From Date"
      txtDateFrom.SetFocus
      Exit Sub
   End If
   If txtDateTo.text = "" Then
      MsgBox "Please enter a valid 'To Date' to proceed.", vbCritical + vbOKOnly, "To Date"
      txtDateTo.SetFocus
      Exit Sub
   End If
   If txtAmount.text = "" Then
      MsgBox "Please enter an amount to proceed.", vbCritical + vbOKOnly, "Demand Amount"
      txtAmount.SetFocus
      Exit Sub
   End If
   If Val(txtAmount.text) = 0 Then
      If MsgBox("You have entered a 0.00 amount, do you wish to continue?", vbCritical + vbYesNo, "Demand Amount") = vbNo Then
         txtAmount.SetFocus
         Exit Sub
      End If
   End If
   If txtDateDue.text = "" Then
      MsgBox "Please enter a valid 'Due Date' to proceed.", vbCritical + vbOKOnly, "Due Date"
      txtDateDue.SetFocus
      Exit Sub
   End If
   Dim lRow As Long
   Dim adoConn As New ADODB.Connection
   'Dim szaDemandType() As String

   If strAddNewAmountMode = "Edit" Then
      strAddNewAmountMode = ""
      lRow = CInt(GridRowNo)
   Else
      lRow = flxAddNewDemands.Rows - 1
      GridRowNo = NextSplitID
   End If

   bAddNew = True
   adoConn.Open getConnectionString
   'added by anol 20160421 - Nominal was not saving iin demand split
   Nominal CInt(txtType.Tag), flxAddNewDemands.Rows - 1, flxAddNewDemands
   'szaDemandType = Split(cboType.text, " / ")
   flxAddNewDemands.RowHeight(lRow) = 270
   flxAddNewDemands.TextMatrix(lRow, 0) = GridRowNo
   flxAddNewDemands.TextMatrix(lRow, 1) = "M"
   flxAddNewDemands.TextMatrix(lRow, 2) = txtType.text ' Demand Type
   flxAddNewDemands.TextMatrix(lRow, 3) = strSelectedFundCode
   flxAddNewDemands.TextMatrix(lRow, 4) = txtAddNewDescription.text
   flxAddNewDemands.TextMatrix(lRow, 5) = txtDateFrom.text
   flxAddNewDemands.TextMatrix(lRow, 6) = txtDateTo.text
   flxAddNewDemands.TextMatrix(lRow, 7) = txtDateDue.text
   If Not IsNull(txtJob.text) And txtJob.text <> "" Then _
      flxAddNewDemands.TextMatrix(lRow, 8) = txtJob.Tag
      
   flxAddNewDemands.TextMatrix(lRow, 9) = IIf(Val(txtAmount.text) = 0, "0.00", txtAmount.text)
   flxAddNewDemands.TextMatrix(lRow, 10) = Format(IIf(Val(txtVAT.text) = 0, "0.00", txtVAT.text), "0.00")
   If Len(flxAddNewDemands.TextMatrix(lRow, 10)) < 8 Then
        NumOfSpaces = 17 - Len(txtVAT.text)
   End If
   flxAddNewDemands.TextMatrix(lRow, 10) = Space$(NumOfSpaces) & Format(IIf(Val(txtVAT.text) = 0, "0.00", txtVAT.text), "0.00")
   flxAddNewDemands.TextMatrix(lRow, 11) = IIf(Val(txtTotal.text) = 0, "0.00", txtTotal.text)
   
 
   If flxAddNewDemands.TextMatrix(lRow, 12) = "" Then 'Sage ref
'      flxAddNewDemands.TextMatrix(lRow, 10) = szPrefix & Format( _
'               SlNumber(IIf(InStr(fraCreateManualDemand.Caption, "Invoice") = 0, "SC", "SI"), "DemandRecords", adoConn), "00000")
        'new requirement from WD they want  Startdate and end date as 2nd ref 2019-11-18
         flxAddNewDemands.TextMatrix(lRow, 12) = Format(txtDateFrom.text, "dd/mm/yy") & "-" & Format(txtDateTo.text, "dd/mm/yy")
   End If
   flxAddNewDemands.TextMatrix(lRow, 13) = Label1(24).Tag 'VAT_ID fixed by anol 2020-10-08
   flxAddNewDemands.TextMatrix(lRow, 14) = szaNominalCode(0)
   flxAddNewDemands.TextMatrix(lRow, 15) = szaNominalCode(1)
   flxAddNewDemands.TextMatrix(lRow, 16) = szaNominalCode(2)
   flxAddNewDemands.TextMatrix(lRow, 17) = szaNominalCode(3)
   flxAddNewDemands.TextMatrix(lRow, 18) = szaNominalCode(4)
   flxAddNewDemands.TextMatrix(lRow, 19) = szaNominalCode(5)
   flxAddNewDemands.TextMatrix(lRow, 20) = txtType.Tag
   flxAddNewDemands.TextMatrix(lRow, 21) = txtFund.Tag
   If Val(flxAddNewDemands.TextMatrix(lRow, 23)) = 1 Or Val(flxAddNewDemands.TextMatrix(lRow, 23)) = 2 Then
      flxAddNewDemands.TextMatrix(lRow, 22) = IIf(Val(txtChargingAmt.text) = 0, "0.00", txtChargingAmt.text)
   End If

   
   'added by anol 05 Sep 2016
   flxAddNewDemands.TextMatrix(lRow, 24) = txtDmdClientList.Tag
   CalSubTotal flxAddNewDemands, txtArray(8), txtArray(7), txtArray(6)
   flxAddNewDemands.TextMatrix(lRow, 25) = txtType.text
   flxAddNewDemands.TextMatrix(lRow, 26) = txtFund.text
   If Val(flxAddNewDemands.TextMatrix(lRow, 0)) = 1 Then szDemandBankID = DemandBankID(adoConn, txtType.Tag)
'   rem by anol 2020-11-24
   ComponenetAddNewLine DisableMode
   ComponenetAddNewLine ClearTextBoxes
   'FraMiddleAddNewLine
  ' cmdAddNewLine.SetFocus
    FocusControl cmdaddnewline
    flxAddNewDemands.RowSel = 0

    adoConn.Close
    Set adoConn = Nothing
    txtJob.text = ""
    txtFund.text = ""
    txtDateDue.text = ""
    If txtAmount.text = "" Then ' 'you need not clear the tag of tax code
            txtVAT.text = ""
            txtTotal.text = ""
    End If
    cmdSaveNew.Enabled = True
    flxAddNewDemands.Enabled = True
    Dim Flag As Boolean
    Dim i As Integer
    For i = 0 To flxAddNewDemands.Rows - 1
        If flxAddNewDemands.TextMatrix(i, 0) <> "DELETED" And flxAddNewDemands.TextMatrix(i, 0) <> "" And flxAddNewDemands.TextMatrix(i, 0) <> "SL" Then
            Flag = True 'this variable true means you have  some valid entered row in the details grid
            Exit For
        End If
    Next i
    If Flag = True Then  'this variable false means you do not have  some valid entered row in the details grid so you can now change client and property
        cmdDmdClientList.Enabled = False
        cmdDmdPropertyList.Enabled = False
    End If
        
    Exit Sub

Error_Handler:
   MsgBox Err.Number & ": " & Err.description & ". ", vbOKOnly, "Manual Demand"
   flxAddNewDemands.RowSel = 0
   Set adoConn = Nothing
End Sub

Private Function NextSplitID() As Integer
   Dim i As Integer

   NextSplitID = 1
   For i = 1 To flxAddNewDemands.Rows - 2
      NextSplitID = NextSplitID + Val(IIf(flxAddNewDemands.TextMatrix(i, 0) = "DELETED", 0, 1))
   Next i
End Function

Private Sub FlxSumUp(conFlxGrid As Control, iNet As Integer, iVat As Integer, conTextBoxNet As Control, conTextBoxVat As Control)
   Dim iRow As Integer, dNet As Double, dVat As Double

   dNet = 0
   dVat = 0

   For iRow = 1 To conFlxGrid.Rows - 1
      dNet = dNet + Val(conFlxGrid.TextMatrix(iRow, iNet))
      dVat = dVat + Val(conFlxGrid.TextMatrix(iRow, iVat))
   Next iRow

   conTextBoxNet.text = CStr(Format(dNet, "0.00"))
   conTextBoxVat.text = CStr(Format(dVat, "0.00"))
End Sub

Private Sub cmdVatCode_Click()
'   cboVatCode.Visible = True
'   cboVatCode.ZOrder 0
'   cboVatCode.SetFocus
    picClient.Left = 8400
    picClient.Top = 2160
    
    If txtTenantName.text = "" Then Exit Sub
    strCommandSource = "14"
   
    Dim adoConn As New ADODB.Connection
    adoConn.Open getConnectionString
    Call FillCboVatCode(adoConn)
    
    adoConn.Close
    picClient.Visible = True
    tabDmdRcpt.Enabled = False
    txtSearchClientID.SetFocus
End Sub

Private Sub cmdReceiptTenantLookup_Click()
   'Me.MousePointer = vbHourglass
   tabPayment.Enabled = False
   strCommandSource = "receipt"
'   sCurrTenantRptHis = txtTenantID1.text
'   If txtTenantID1.text <> "All Lessees" Then
'      txtTenantID1.text = "All Lessees"
'   End If

   Dim adoConn As New ADODB.Connection
   Dim szSQL As String

   adoConn.Open getConnectionString
   MousePointer = vbArrow
   ConfigFlxLeaseList

   If txtRptClientList1.text = "ALL" And txtRptPropertyList1.text = "ALL" Then
      szSQL = "SELECT Tenants.SageAccountNumber, Name, LeaseDetails.UnitNumber " & _
              "From Tenants, LeaseDetails " & _
              "WHERE ((Tenants.Comments) IS NULL OR Tenants.Comments='') AND " & _
               "Tenants.SageAccountNumber = LeaseDetails.SageAccountNumber AND " & _
               "LeaseDetails.Status = True " & _
             "ORDER BY Tenants.SageAccountNumber;"
   End If

   If txtRptClientList1.text <> "ALL" And txtRptPropertyList1.text = "ALL" Then
      szSQL = "SELECT Tenants.SageAccountNumber, Name, LeaseDetails.UnitNumber " & _
              "From Tenants, LeaseDetails, Units, Property " & _
              "WHERE ((Tenants.Comments) IS NULL OR Tenants.Comments='') AND " & _
               "Tenants.SageAccountNumber = LeaseDetails.SageAccountNumber AND " & _
               "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
               "LeaseDetails.Status = True AND " & _
               "Units.PropertyID = Property.PropertyID AND " & _
               "Property.ClientID = '" & txtRptClientList1.text & "' " & _
             "ORDER BY Tenants.SageAccountNumber;"
   End If

   If txtRptClientList1.text = "ALL" And txtRptPropertyList1.text <> "ALL" Then
      szSQL = "SELECT Tenants.SageAccountNumber, Name, LeaseDetails.UnitNumber " & _
              "From Tenants, LeaseDetails, Units " & _
              "WHERE ((Tenants.Comments) IS NULL OR Tenants.Comments='') AND " & _
               "Tenants.SageAccountNumber = LeaseDetails.SageAccountNumber AND " & _
               "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
               "LeaseDetails.Status = True AND " & _
               "Units.PropertyID = '" & txtRptPropertyList1.text & "' " & _
             "ORDER BY Tenants.SageAccountNumber;"
   End If

   If txtRptClientList1.text <> "ALL" And txtRptPropertyList1.text <> "ALL" Then
      szSQL = "SELECT Tenants.SageAccountNumber, Name, LeaseDetails.UnitNumber " & _
               "From Tenants, LeaseDetails, Units, Property " & _
               "WHERE ((Tenants.Comments) IS NULL OR Tenants.Comments='') AND " & _
               "Tenants.SageAccountNumber = LeaseDetails.SageAccountNumber AND " & _
               "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
               "LeaseDetails.Status = True AND " & _
               "Units.PropertyID = Property.PropertyID AND " & _
               "Property.ClientID = '" & txtRptClientList1.text & "' AND " & _
               "Units.PropertyID = '" & txtRptPropertyList1.text & "' " & _
               "ORDER BY Tenants.SageAccountNumber;"
   End If

   PopulateTenantLookup adoConn, szSQL
   UpdateBalance
   adoConn.Close
   Set adoConn = Nothing

   txtTenantSearchID.text = ""
   txtTenantSearchName.text = ""
   txtTenantSearchUnitName.text = ""
   picLeaseList.Top = 900 'tabDmdRcpt.Top + tabPayment.Top + txtTenantID1.Top + txtTenantID1.Height + 5
   picLeaseList.Left = 3015 'tabDmdRcpt.Left + tabPayment.Left + txtTenantID1.Left + 5
   picLeaseList.Visible = True
   picLeaseList.ZOrder 0

   'Me.MousePointer = vbArrow
   tabDmdRcpt.Enabled = False
   txtTenantSearchID.SetFocus
End Sub

Private Sub cmeRevereseAllocation_Click()
   If Trim(txtTenantID.text) = "" Then
      MsgBox "Please select a lessee.", vbExclamation + vbOKOnly, "Reverse Allocation"
      Exit Sub
   End If

   'Me.Hide
   LoadForm frmReverseAllocation
End Sub

Private Sub cmdDmdHist_PrtSt_Click()
   Dim szSQL As String, rRow As Integer, varAns As Integer
   Dim rsMinDueDate As New ADODB.Recordset

   ' Declare Variables
   Dim szDataPath As String
   Call ChangeReportODBC
   varAns = FlxDemandHistorySelectionCount()
   If varAns < 1 Then
      MsgBox "Please select atleast one demand from the grid.", vbCritical, "No demand selected"
      Exit Sub
   End If

   Dim iRow As Integer, szWhere As String, iTemp As Integer
   Dim adoConn As New ADODB.Connection
   Dim adoRstDRecords As New ADODB.Recordset, adoRstDRCurrent As New ADODB.Recordset
   Dim adoTenants As New ADODB.Recordset

   adoConn.Open getConnectionString

   adoConn.Execute "DELETE * FROM tlbDRCURRENTPRINT;"
   szSQL = "SELECT * FROM tlbDRCURRENTPRINT;"
   adoRstDRCurrent.Open szSQL, adoConn, adOpenDynamic, adLockPessimistic

'*********************************************************************************************
   For iRow = 1 To flxDemandHistory.Rows - 1
      If flxDemandHistory.TextMatrix(iRow, 0) = "X" Then

         szWhere = "DR.DEMANDID = " + CStr(CLng(flxDemandHistory.TextMatrix(iRow, 1))) + ""
         szSQL = "SELECT DR.DEMANDID AS D_ID, DR.BATCHID AS B_ID, " & _
                           "DR.SAGEACCOUNTNUMBER AS S_AC, " & _
                           "DR.UNITNUMBER AS U_NUM, DR.SOURCE AS SOU, " & _
                           "DR.TRANSACTIONTYPE AS T_TYPE, DSR.DSR, " & _
                           "DR.ISSUEDATE AS IDT, DR.GenerateDemand AS CS, DSR.A_M AS A_M, " & _
                           "DSR.splitid as S_ID, DSR.NOMINALCODEFORAMOUNT AS NCA, " & _
                           "DSR.NOMINALNAMEFORAMOUNT AS NNA, DSR.NOMINALCODEFORVAT AS NCV, DSR.NOMINALNAMEFORVAT AS NNV, DSR.NOMINALCODEFORTOTAL AS NCT, DSR.NOMINALNAMEFORTOTAL AS NNT, " & _
                           "DSR.AMOUNT AS AMT, DSR.VATAMOUNT AS VAMT, " & _
                           "DSR.TOTALAMOUNT AS TAMT, DSR.SAGEREF AS SREF, DSR.DUEDATE AS DDT, " & _
                           "DSR.VATMONTH AS VMTH, DSR.TYPEOFDEMAND AS TDM, " & _
                           "DSR.DESCRIPTION AS DESCR, DSR.DEMANDSTATEMENT AS D_ST, " & _
                           "DSR.DATEFROM AS D_FROM, " & _
                           "DSR.DATETO AS D_TO, Tenants.spare1, " & _
                           "DSR.ChargingFigure, DemandTypes.DTGroup, " & _
                           "DemandTypes.StatementTemplate AS DRN, DemandTypes.CategoryCode AS CC "
         szSQL = szSQL & _
                        "FROM DemandRecords as DR, DemandSplitRecords as DSR, Tenants, DemandTypes "
         szSQL = szSQL & _
                        "WHERE (" & szWhere & ") AND " & _
                           "DSR.DEMANDID = DR.DEMANDID AND " & _
                           "Tenants.SAGEACCOUNTNUMBER = DR.SAGEACCOUNTNUMBER AND " & _
                           "DSR.TYPEOFDEMAND = DemandTypes.ID " & _
                        "ORDER BY DSR.splitid;"
'Debug.Print szSQL

         adoRstDRecords.Open szSQL, adoConn, adOpenDynamic, adLockPessimistic

'      GET N UNDATE THE INVOICE NUMBER
         strSelectedPrintRef = Format(NextRef(adoConn, "PRINT_REF"), "00000000")

         While Not adoRstDRecords.EOF
'            If IsNull(adoRstDRecords.Fields.Item("spare1").Value) Or _
                  InStr(adoRstDRecords.Fields.Item("spare1").Value, "NotS") = 0 Then
               adoRstDRCurrent.AddNew

               adoRstDRCurrent.Fields("UniqueRefNumber").Value = adoRstDRecords.Fields("D_ID").Value
               adoRstDRCurrent.Fields("Batch").Value = adoRstDRecords.Fields("B_ID").Value
               adoRstDRCurrent.Fields("AutomaticManual").Value = adoRstDRecords.Fields("A_M").Value
               adoRstDRCurrent.Fields("SageAccountNumber").Value = adoRstDRecords.Fields("S_AC").Value
               adoRstDRCurrent.Fields("UnitNumber").Value = adoRstDRecords.Fields("U_NUM").Value
               adoRstDRCurrent.Fields("NominalCodeforAmount").Value = adoRstDRecords.Fields("NCA").Value
               adoRstDRCurrent.Fields("NominalNameforAmount").Value = adoRstDRecords.Fields("NNA").Value
               adoRstDRCurrent.Fields("NominalCodeforVAT").Value = adoRstDRecords.Fields("NCV").Value
               adoRstDRCurrent.Fields("NominalNameforVAT").Value = adoRstDRecords.Fields("NNV").Value
               adoRstDRCurrent.Fields("NominalCodeforTotal").Value = adoRstDRecords.Fields("NCT").Value
               adoRstDRCurrent.Fields("NominalNameforTotal").Value = adoRstDRecords.Fields("NNT").Value
               adoRstDRCurrent.Fields("Source").Value = adoRstDRecords.Fields("SOU").Value
               adoRstDRCurrent.Fields("TransactionType").Value = adoRstDRecords.Fields("T_TYPE").Value
               adoRstDRCurrent.Fields("IssueDate").Value = adoRstDRecords.Fields("IDT").Value
               adoRstDRCurrent.Fields("VATMonth").Value = adoRstDRecords.Fields("VMTH").Value
               adoRstDRCurrent.Fields("Typeofdemand").Value = adoRstDRecords.Fields("TDM").Value
               adoRstDRCurrent.Fields("Reference").Value = adoRstDRecords.Fields("SREF").Value
               adoRstDRCurrent.Fields("Description").Value = adoRstDRecords.Fields("DESCR").Value
               adoRstDRCurrent.Fields("PRINT_ID").Value = strSelectedPrintRef
               adoRstDRCurrent.Fields("DTCategory").Value = adoRstDRecords.Fields("CC").Value
               adoRstDRCurrent.Fields("DemandReportName").Value = adoRstDRecords.Fields("DRN").Value

               If adoRstDRecords.Fields("D_ST").Value Then
                  adoRstDRCurrent.Fields("DueDate").Value = adoRstDRecords.Fields("DDT").Value
                  rsMinDueDate.Open "Select MIN(DUEDATE) as mindate From DemandSplitRecords DSR where DSR.DEMANDID = " + CStr(CLng(flxDemandHistory.TextMatrix(iRow, 1))) + "", adoConn, adOpenKeyset, adLockReadOnly
                      If Not rsMinDueDate.EOF Then
                            adoRstDRCurrent.Fields("MinDueDate").Value = rsMinDueDate.Fields("mindate").Value
                      End If
                  rsMinDueDate.Close
                  adoRstDRCurrent.Fields("TotalAmount").Value = adoRstDRecords.Fields("TAMT").Value
                  adoRstDRCurrent.Fields("VATAmount").Value = adoRstDRecords.Fields("VAMT").Value
                  adoRstDRCurrent.Fields("Amount").Value = adoRstDRecords.Fields("AMT").Value
                  adoRstDRCurrent.Fields("DemandFrom").Value = adoRstDRecords.Fields("D_FROM").Value
                  adoRstDRCurrent.Fields("DemandTo").Value = adoRstDRecords.Fields("D_TO").Value
               End If

               adoRstDRCurrent.Fields.Item("ChargingFigure").Value = adoRstDRecords.Fields.Item("ChargingFigure").Value
               adoRstDRCurrent.Fields.Item("spare1").Value = adoRstDRecords.Fields.Item("DSR").Value
               adoRstDRCurrent.Update
'            End If
            adoRstDRecords.MoveNext
         Wend
         adoRstDRecords.Close
      End If
   Next iRow
   adoRstDRCurrent.Close

   Set adoRstDRecords = Nothing

'PRINT DEMAND INVOICES ACCORDING TO DEMAND TYPE
   szSQL = "SELECT   tlbDRCurrentPrint.DemandReportName, tlbDRCurrentPrint.Source " & _
           "FROM     tlbDRCurrentPrint " & _
           "GROUP BY tlbDRCurrentPrint.DemandReportName, Source;"
'Debug.Print strSQLTitles

   adoRstDRCurrent.Open szSQL, adoConn, adOpenStatic, adLockReadOnly

   If adoRstDRCurrent.EOF Then
      MsgBox "No Statement to print.", vbInformation + vbOKOnly, "Statement Printing"
   End If

   While Not adoRstDRCurrent.EOF
      ShowReport App.Path & szReportPath & "\" & adoRstDRCurrent.Fields.Item("DemandReportName").Value

      adoRstDRCurrent.MoveNext
   Wend
   adoRstDRCurrent.Close
   Set adoRstDRCurrent = Nothing

   adoConn.Close
   Set adoConn = Nothing
End Sub

'Private Sub cmdCopyReceipt_Click()
'   If flxReceiptHistory.row < 1 Then
'      MsgBox "Please select a transaction from the grid.", vbInformation + vbOKOnly, "Selection"
'      flxReceiptHistory.SetFocus
'      Exit Sub
'   End If
'
'   frmPopUpMenu.Top = frmMMain.fraCmdButton.Height + cmdCopyReceipt.Top + _
'                      frmDemands3.Top + tabDmdRcpt.Top + _
'                      tabPayment.Top + 1160
'   frmPopUpMenu.Left = frmMMain.tvwLandLord.Width + frmDemands3.Left + _
'                       tabDmdRcpt.Left + tabPayment.Left + _
'                       cmdCopyReceipt.Left + 80
'   If flxReceiptHistory.TextMatrix(flxReceiptHistory.row, 1) = "SRR" Then frmPopUpMenu.CallingFrom "DEMAND_SRR"
'   If flxReceiptHistory.TextMatrix(flxReceiptHistory.row, 1) = "SR" Then frmPopUpMenu.CallingFrom "DemandReceipt"
'   If flxReceiptHistory.TextMatrix(flxReceiptHistory.row, 1) = "SA" Then frmPopUpMenu.CallingFrom "DEMAND_SA"
'
'   frmPopUpMenu.Show
'End Sub

Private Sub flxAddNewDemands_Click()
   GridRowNo = flxAddNewDemands.RowSel
   If flxAddNewDemands.RowSel = 0 Then GridRowNo = "1"
   cmdEditLine.Enabled = True
   cmdDeleteLine.Enabled = True
End Sub

Private Sub flxAddNewDemands_DblClick()
   flxAddNewDemands_Click
End Sub

'Private Sub flxChildDemands_DblClick()
'        If flxChildDemands.col = 7 Then
'                iCurRow = flxChildDemands.row
'                txtArrayEditDemand(0).Top = flxChildDemands.CellTop + flxChildDemands.Top
'                txtArrayEditDemand(0).Left = flxChildDemands.CellLeft + flxChildDemands.Left
'                txtArrayEditDemand(0).Width = 1200
'                txtArrayEditDemand(0).Height = flxChildDemands.RowHeight(flxSPayment.row) - 15
'                txtArrayEditDemand(0).text = flxChildDemands.TextMatrix(flxSPayment.row, 7)
'                txtArrayEditDemand(0).Visible = True
'                FocusControl txtArrayEditDemand(0)
'                flxChildDemands.col = 8
'         End If
'
'
'
'
''   If szLastIDClicked = "" Then Exit Sub
''
''   Dim adoConn As New ADODB.Connection
''   adoConn.Open getConnectionString
''
'''  Check for possibility to Edit the demand. Rule is: if user enter any receipt amount against
'''  the demand in the receipt form then it will not allow user to edit the Invoice.
''   If Not PossibleToEdit(flxDemands.TextMatrix(iDemandRow, 1), adoConn) Then
''      'MsgBox "You cannot edit a Demand once it has been allocated.", vbInformation + vbOKOnly, "Edit Demand"
''      adoConn.Close
''      Set adoConn = Nothing
''      Exit Sub
''   End If
'''  If system is Export to 3rd Party enabled, then user cannot edit the demand if it has been
'''  exported to 3rd party sotfware.
''
''   If ExpTrans3rdParty And ExportedSI2Other(adoConn) Then
''      MsgBox "You cannot edit Demand after exported the transaction to other system.", vbInformation + vbOKOnly, "Edit Demand"
''      adoConn.Close
''      Set adoConn = Nothing
''      Exit Sub
''   End If
''
''   adoConn.Close
''   Set adoConn = Nothing
''
''   With flxChildDemands
''      If .TextMatrix(.row, .col) = "" Or .col < 3 Or .col = 9 Then Exit Sub
''
''      If .col = 8 Then
''         ShowMsgInTaskBar "You cannot edit vat from this screen", "Y", "N"
''         Exit Sub
''      End If
''
''      iSelSplitCol = .col
''      txtStValue.Top = .CellTop + .Top
''      txtStValue.Left = .CellLeft + .Left
''      txtStValue.Width = .ColWidth(.col)
''      txtStValue.Visible = True
''      If .col < 7 Then
''         txtStValue.Alignment = vbLeftJustify
''      Else
''         txtStValue.Alignment = vbRightJustify
''      End If
''
''      txtStValue.text = .TextMatrix(.row, .col)
''      txtStValue.SelStart = 0
''      txtStValue.SelLength = Len(txtStValue.text)
''      txtStValue.SetFocus
''   End With
'End Sub

Private Sub flxCrPoA_Click()
   sEditSRR = 2
   If Left(flxCrPoA.TextMatrix(flxCrPoA.row, 0), 2) = "SR" Or _
      Left(flxCrPoA.TextMatrix(flxCrPoA.row, 0), 2) = "SA" Then
      cmdEditReceipt.Enabled = True
   Else
      cmdEditReceipt.Enabled = False
   End If

   If flxCrPoA.RowSel = 0 Then Exit Sub
   If flxCrPoA.TextMatrix(1, 0) = "" Then Exit Sub
   If cmdAllocate.Caption = "All&ocation Only" Then Exit Sub

   iCrPoARowSel = IIf(flxCrPoA.TextMatrix(flxCrPoA.RowSel, 8) > 0, flxCrPoA.RowSel, 0)

   Dim i As Integer, iFlxCrPoACol As Integer

   iFlxCrPoACol = 9
   flxCrPoA.col = iFlxCrPoACol

   If flxCrPoA.TextMatrix(flxCrPoA.row, 2) = "" Then Exit Sub

   txtCrPayment.BackColor = vbWhite
   txtCrPayment.text = flxCrPoA.TextMatrix(flxCrPoA.row, 8)

   Label10(4).Caption = flxCrPoA.row

'  from txtCrPayment.gotfocus
   iCurRow = flxCrPoA.row
   HighLightRowFlxGrid flxCrPoA, iCurRow

'  from LostFocus
   flxCrPoA.TextMatrix(iCurRow, 9) = txtCrPayment.text
   txtArray(4).text = Format(txtCrPayment.text, "0.00")
   lblSelectedTranID.Caption = flxCrPoA.TextMatrix(iCurRow, 10) ' TransactionID of tlbReceipt 'Lable10(2).Caption  'lblSelectedTranID.Caption
   flxCrPoA.Enabled = False

   lblAllocating.Caption = "Allocating...                      " & flxCrPoA.TextMatrix(iCrPoARowSel, 1)
   lblAllocating.Visible = True
   Frame5(0).Enabled = False                     'Receipt - Saving
   Frame5(4).Enabled = True                      'Allocation - Saving

   flxSPayment.Enabled = True
End Sub

Private Sub flxDemandHistory_Click()
   Call SelectFlxGridRow(0, flxDemandHistory, flxDemandHistory.RowSel)
   ConfigFlxGrid flxChildDemandHistory

   Call FillChildinGrid(flxDemandHistory.TextMatrix(flxDemandHistory.RowSel, 1), flxChildDemandHistory)
End Sub

Public Function SelectedID(Optional ByRef szIC As String, Optional ByRef szSlNo As String, Optional ByRef szRowNo As Integer) As String
   Dim iRow As Integer

   SelectedID = ""
   For iRow = flxDemands.Rows - 1 To 1 Step -1
      If flxDemands.TextMatrix(iRow, 0) = "X" Then
         SelectedID = flxDemands.TextMatrix(iRow, 1)
         szIC = flxDemands.TextMatrix(iRow, 3)
         szSlNo = flxDemands.TextMatrix(iRow, 2)
         Label50(10).Caption = "Transaction ID(tlbReceipt):" & flxDemands.TextMatrix(iRow, 17)
         szRowNo = iRow
         Exit For
      End If
   Next iRow
End Function

Private Sub FillChildinGrid(szPID As String, conFlxGrid As Control)
   If szPID = "" Then Exit Sub
   If Not IsNumeric(szPID) Then Exit Sub

   Dim szStr As String, iRow As Integer
   Dim adoConn As New ADODB.Connection
   Dim adoRST As New ADODB.Recordset

'   connect to database
   adoConn.Open getConnectionString
'***get sendtoprint field for all demands that were set to be sent to print***
   szStr = "SELECT S.SPLITID AS S_ID, S.A_M AS A_M, " & _
               "S.NOMINALCODEFORAMOUNT AS NC_A, " & _
               "S.NOMINALNAMEFORAMOUNT AS NN_A, " & _
               "S.NOMINALCODEFORVAT AS NC_V, " & _
               "S.NOMINALNAMEFORVAT AS NN_V, " & _
               "S.NOMINALCODEFORTOTAL AS NC_T, " & _
               "S.NOMINALNAMEFORTOTAL AS NN_T, " & _
               "S.AMOUNT AS AMT, S.VATAMOUNT AS VAMT, " & _
               "S.TOTALAMOUNT AS TAMT, S.DUEDATE AS D_DATE, " & _
               "S.DESCRIPTION AS DESCP, S.SAGEREF AS SREF, " & _
               "S.DATEFROM AS D_FROM, S.DATETO AS D_TO, S.DSR " & _
           "FROM DEMANDRECORDS AS D, DEMANDSPLITRECORDS AS S " & _
           "WHERE S.DEMANDID = " & CLng(szPID) & " AND " & _
               "S.DEMANDID = D.DEMANDID " & _
           "ORDER BY S.SPLITID;"
'Debug.Print szStr
   adoRST.Open szStr, adoConn, adOpenStatic, adLockReadOnly

   iRow = 1
   While Not adoRST.EOF
      conFlxGrid.TextMatrix(iRow, 1) = Format(adoRST!S_ID, "000")
      conFlxGrid.TextMatrix(iRow, 2) = adoRST!A_M
      conFlxGrid.TextMatrix(iRow, 3) = adoRST!DESCP
      conFlxGrid.TextMatrix(iRow, 4) = IIf(IsNull(adoRST!D_FROM), "", adoRST!D_FROM)
      conFlxGrid.TextMatrix(iRow, 5) = IIf(IsNull(adoRST!D_TO), "", adoRST!D_TO)
      conFlxGrid.TextMatrix(iRow, 6) = IIf(IsNull(adoRST!D_DATE), "", adoRST!D_DATE)
      conFlxGrid.TextMatrix(iRow, 7) = IIf(IsNull(adoRST!amt), "0.00", Format(adoRST!amt, "0.00"))
      conFlxGrid.TextMatrix(iRow, 8) = IIf(adoRST!VAMT = 0, "0.00", Format(adoRST!VAMT, "0.00"))
      conFlxGrid.TextMatrix(iRow, 9) = IIf(adoRST!TAMT = 0, "0.00", Format(adoRST!TAMT, "0.00"))
      conFlxGrid.TextMatrix(iRow, 10) = IIf(IsNull(adoRST!NC_A), "", adoRST!NC_A)
      conFlxGrid.TextMatrix(iRow, 11) = IIf(IsNull(adoRST!NN_A), "", adoRST!NN_A)
      conFlxGrid.TextMatrix(iRow, 12) = IIf(IsNull(adoRST!NC_V), "", adoRST!NC_V)
      conFlxGrid.TextMatrix(iRow, 13) = IIf(IsNull(adoRST!NN_V), "", adoRST!NN_V)
      conFlxGrid.TextMatrix(iRow, 14) = IIf(IsNull(adoRST!NC_T), "", adoRST!NC_T)
      conFlxGrid.TextMatrix(iRow, 15) = IIf(IsNull(adoRST!NN_T), "", adoRST!NN_T)

      conFlxGrid.TextMatrix(iRow, 17) = IIf(IsNull(adoRST!SREF), "", adoRST!SREF)          'SageRef FROM SPLIT TABLE
      conFlxGrid.TextMatrix(iRow, 18) = adoRST!DSR

      adoRST.MoveNext
      If Not adoRST.EOF Then conFlxGrid.AddItem ""
      iRow = iRow + 1
   Wend
   adoRST.Close
   adoConn.Close
   Set adoRST = Nothing
   Set adoConn = Nothing
End Sub

Private Sub loadflxAddNewDemands(szDemandID As String, szBt As String, adoConn As ADODB.Connection)
   Dim szStr As String, iRow As Integer
   Dim adoRST As ADODB.Recordset
   Dim NumOfSpaces As Integer
   
   Set adoRST = New ADODB.Recordset

'   get sendtoprint field for all demands that were set to be sent to print
   szStr = "SELECT DSR.DSR, DSR.SPLITID AS S_ID, " & _
            "DSR.A_M AS A_M, " & _
            "DSR.NOMINALCODEFORAMOUNT AS NC_A, DSR.NOMINALNAMEFORAMOUNT AS NN_A, " & _
            "DSR.NOMINALCODEFORVAT AS NC_V, DSR.NOMINALNAMEFORVAT AS NN_V, " & _
            "DSR.NOMINALCODEFORTOTAL AS NC_T, DSR.NOMINALNAMEFORTOTAL AS NN_T, " & _
            "DSR.AMOUNT AS AMT, DSR.SageDepartment AS SD,F.FundName,F.FundCode, " & _
            "DSR.VATAMOUNT AS VAMT, DSR.TOTALAMOUNT AS TAMT, " & _
            "DSR.DUEDATE AS D_DATE, DSR.DESCRIPTION AS DESCP, " & _
            "DSR.SAGEREF AS SREF, DSR.ChargingFigure, DSR.VAT_CODE AS V_CODE, " & _
            "DSR.DATEFROM AS D_FROM, DSR.DATETO AS D_TO, " & _
            "DSR.TYPEOFDEMAND AS TD, " & _
            "DR.BATCHID AS BT, DSR.AdiComment, DSR.ChargingMethod AS CM,DSR.JobID AS JobI,DEMANDTYPES.Type " & _
            "FROM DEMANDRECORDS AS DR, DEMANDSPLITRECORDS AS DSR, DEMANDTYPES,FUND F " & _
            "WHERE F.FundID=DSR.SageDepartment AND DR.DEMANDID = " & CLng(szDemandID) & " AND " & _
            "DR.DEMANDID = DSR.DEMANDID " & _
            "AND DSR.TYPEOFDEMAND = DEMANDTYPES.ID " & _
            "ORDER BY DSR.SPLITID;"
'Debug.Print szStr
   adoRST.Open szStr, adoConn, adOpenDynamic, adLockPessimistic

   ReDim szAdiComment(RecordCount(adoRST)) As String

   iRow = 1
   While Not adoRST.EOF
      flxAddNewDemands.TextMatrix(iRow, 0) = adoRST!DSR
      flxAddNewDemands.TextMatrix(iRow, 1) = adoRST!A_M
      flxAddNewDemands.TextMatrix(iRow, 2) = IIf(IsNull(adoRST!Type), "", adoRST!Type) 'Demand Type
      flxAddNewDemands.TextMatrix(iRow, 3) = IIf(IsNull(adoRST!FundCode), "", adoRST!FundCode) 'Fund Code
      flxAddNewDemands.TextMatrix(iRow, 4) = adoRST!DESCP
      flxAddNewDemands.TextMatrix(iRow, 5) = Format(adoRST!D_FROM, "dd/mm/yyyy")
      flxAddNewDemands.TextMatrix(iRow, 6) = Format(adoRST!D_TO, "dd/mm/yyyy")
      flxAddNewDemands.TextMatrix(iRow, 7) = Format(adoRST!D_DATE, "dd/mm/yyyy")
      flxAddNewDemands.TextMatrix(iRow, 8) = IIf(IsNull(adoRST!JobI), "", adoRST!JobI)
      flxAddNewDemands.TextMatrix(iRow, 9) = Format(IIf(IsNull(adoRST!amt), "0.00", adoRST!amt), "0.00")
      flxAddNewDemands.TextMatrix(iRow, 10) = Format(IIf(adoRST!VAMT = 0, "0.00", adoRST!VAMT), "0.00")
      If Len(flxAddNewDemands.TextMatrix(iRow, 10)) < 8 Then 'reason of this small programming is alignment is left and we need  right alignment
             NumOfSpaces = 17 - Len(flxAddNewDemands.TextMatrix(iRow, 10))
      End If
      flxAddNewDemands.TextMatrix(iRow, 10) = Space$(NumOfSpaces) & Format(IIf(adoRST!VAMT = 0, "0.00", adoRST!VAMT), "0.00")
      
      flxAddNewDemands.TextMatrix(iRow, 11) = Format(IIf(adoRST!TAMT = 0, "0.00", adoRST!TAMT), "0.00")
      flxAddNewDemands.TextMatrix(iRow, 12) = IIf(IsNull(adoRST!SREF), "", adoRST!SREF)     'SAGEREF
      flxAddNewDemands.TextMatrix(iRow, 13) = IIf(IsNull(adoRST!V_CODE), "", adoRST!V_CODE)
      flxAddNewDemands.TextMatrix(iRow, 14) = IIf(IsNull(adoRST!NC_A), "", adoRST!NC_A)     'NOMINALCODEFORAMOUNT
      flxAddNewDemands.TextMatrix(iRow, 15) = IIf(IsNull(adoRST!NN_A), "", adoRST!NN_A)     'NOMINALNAMEFORAMOUNT
      flxAddNewDemands.TextMatrix(iRow, 16) = IIf(IsNull(adoRST!NC_V), "", adoRST!NC_V)     'NOMINALCODEFORVAT
      flxAddNewDemands.TextMatrix(iRow, 17) = IIf(IsNull(adoRST!DSR), "", adoRST!DSR)
      flxAddNewDemands.TextMatrix(iRow, 18) = IIf(IsNull(adoRST!NC_T), "", adoRST!NC_T)     'NOMINALCODEFORTotalAmount
      flxAddNewDemands.TextMatrix(iRow, 19) = IIf(IsNull(adoRST!NN_T), "", adoRST!NN_T)
      flxAddNewDemands.TextMatrix(iRow, 20) = IIf(IsNull(adoRST!TD), "", adoRST!TD)         'Demand Type ID
      flxAddNewDemands.TextMatrix(iRow, 21) = IIf(IsNull(adoRST!SD), "", adoRST!SD)         'This is Fund ID
      flxAddNewDemands.TextMatrix(iRow, 22) = IIf(IsNull(adoRST!ChargingFigure), "", adoRST!ChargingFigure)
      flxAddNewDemands.TextMatrix(iRow, 23) = IIf(IsNull(adoRST!CM), "", adoRST!CM)          'Charging Method
      flxAddNewDemands.TextMatrix(iRow, 24) = txtDmdClientList.Tag                           'This is client ID you are selecting at the very top when u create invoice
      flxAddNewDemands.TextMatrix(iRow, 25) = IIf(IsNull(adoRST!Type), "", adoRST!Type)      'Demand Type this is what we are laoding twice twice
      flxAddNewDemands.TextMatrix(iRow, 26) = IIf(IsNull(adoRST!FundName), "", adoRST!FundName) 'Fund Name
      flxAddNewDemands.RowHeight(iRow) = 270
      szAdiComment(iRow) = IIf(IsNull(adoRST!AdiComment), "", adoRST!AdiComment)

      adoRST.MoveNext
      If Not adoRST.EOF Then flxAddNewDemands.AddItem ""
      iRow = iRow + 1
   Wend
   adoRST.Close
   Set adoRST = Nothing
End Sub

Private Sub flxDemands_DblClick()
   cmdEdit_Click
End Sub

Private Sub flxDemands_MouseMove(Button As Integer, Shift As Integer, X As Single, Y As Single)
  Me.MousePointer = vbArrow
'
'   If fraInvCrChoice.Visible Then fraInvCrChoice.Visible = False
End Sub

Private Sub flxDemands_MouseUp(Button As Integer, Shift As Integer, X As Single, Y As Single)
   If Button = 2 Then
      If flxDemands.MouseCol = 8 Then
         If flxDemands.TextMatrix(flxDemands.MouseRow, 0) = "" Then
            flxDemands.row = flxDemands.MouseRow
            flxDemands_RowColChange
         End If

         picPrnMrk.Top = Y + flxDemands.Top + tabDmdRcpt.Top
         picPrnMrk.Left = X + flxDemands.Left + tabDmdRcpt.Left
         picPrnMrk.Height = 375
         picPrnMrk.Visible = True
         cmdPrnMrk.SetFocus
      Else
         picPrnMrk.Visible = False
      End If
   End If
End Sub

Private Sub flxDemands_RowColChange()
   Dim szSlNo As String

   If flxDemands.TextMatrix(flxDemands.row, 1) = "" Then Exit Sub
  
   iIncDec = iIncDec + SelectFlxGridRow(0, flxDemands, flxDemands.row) 'Returns 1 or -1 depends on selection
   'If iIncDec < 1 And chkSelectAllDemands.Value Then chkSelectAllDemands.Value = 0
   'ConfigFlxGrid flxChildDemands
   Call configflxChildDemands
'    'by anol 04 Sep 2016
'    If iDemandRow > 0 Then
'         Dim iCol As Integer
'       If flxDemands.TextMatrix(iDemandRow, 0) = "" Then
'         flxDemands.row = iDemandRow
'         If flxDemands.CellBackColor = RGB(174, 179, 233) Then
'            For iCol = 1 To flxDemands.Cols - 1
'               flxDemands.col = iCol
'               flxDemands.CellBackColor = vbWhite
'            Next iCol
'         End If
'       End If
'    End If
'        'End of addition
   szLastIDClicked = SelectedID(, szSlNo, iDemandRow)
   
   Call InstantLockingCheck
    
   'Call FillChildinGrid(szLastIDClicked, flxChildDemands)
   Call loadflxChildDemands(szLastIDClicked)
   fraDetails.Caption = "Demand Details: " & szSlNo
   iSelectedDemandsRow = iIncDec
End Sub
Private Sub configflxChildDemands()
   Dim i       As Integer
   Dim Index   As Integer
   flxChildDemands.Clear
   flxChildDemands.Cols = 24
   flxChildDemands.Rows = 2
   flxChildDemands.RowHeight(0) = 240

   If flxChildDemands.Rows = 2 Then
        If tabDmdRcpt.Tab = 0 Then
           Index = 9
        Else
           Index = 25
        End If
        flxChildDemands.ColWidth(0) = 90 'Label44(Index).Left - flxChildDemands.Left
        flxChildDemands.ColWidth(1) = 500
        flxChildDemands.ColAlignment(1) = vbLeftJustify
        Index = Index + 1
        flxChildDemands.ColWidth(2) = 600
        flxChildDemands.ColAlignment(2) = vbLeftJustify
        flxChildDemands.ColWidth(3) = 1330
        flxChildDemands.ColWidth(4) = 1330
        flxChildDemands.ColWidth(5) = 1730
        flxChildDemands.ColWidth(4) = 1230
        flxChildDemands.ColWidth(5) = 1630
        flxChildDemands.ColWidth(6) = 1530
        flxChildDemands.ColWidth(7) = 1730
        For i = 8 To 14
           flxChildDemands.ColWidth(i) = 1390 'Label44(Index + 1).Left - Label44(Index).Left
           flxChildDemands.ColAlignment(i) = vbLeftJustify
           Index = Index + 1
        Next i
        'flxChildDemands.ColWidth(i) = Label44(index).Width
        For i = 14 To 23
           flxChildDemands.ColWidth(i) = 0
        Next i
   End If
  
   

   flxChildDemands.TextMatrix(0, 1) = "Split ID"
   flxChildDemands.TextMatrix(0, 2) = "A/M"
   flxChildDemands.TextMatrix(0, 3) = "Client ID"
   flxChildDemands.TextMatrix(0, 4) = "Property ID"
   flxChildDemands.TextMatrix(0, 5) = "Demand Type"
   flxChildDemands.TextMatrix(0, 6) = "Fund Code"
   flxChildDemands.TextMatrix(0, 7) = "Description"
   flxChildDemands.TextMatrix(0, 8) = "From Date"
   flxChildDemands.TextMatrix(0, 9) = "To date"
   flxChildDemands.TextMatrix(0, 10) = "Due Date"
   flxChildDemands.TextMatrix(0, 11) = "Amount"
   flxChildDemands.TextMatrix(0, 12) = "VAT"
   flxChildDemands.TextMatrix(0, 13) = "Total Amount"
   

End Sub
'Private Sub ConfigFlxGrid(conFlxGrid As Control)
'   Dim i       As Integer
'   Dim Index   As Integer
'
'   conFlxGrid.Cols = 19
'   conFlxGrid.RowHeight(0) = 0
'
'   If conFlxGrid.Rows = 2 Then
''
'      If tabDmdRcpt.Tab = 0 Then
'         Index = 9
'      Else
'         Index = 25
'      End If
'      conFlxGrid.ColWidth(0) = Label44(Index).Left - conFlxGrid.Left
'      For i = 1 To 8
'         conFlxGrid.ColWidth(i) = Label44(Index + 1).Left - Label44(Index).Left
'         Index = Index + 1
'      Next i
'      conFlxGrid.ColWidth(i) = Label44(Index).Width
'      For i = 10 To 18
'         conFlxGrid.ColWidth(i) = 0
'      Next i
'   End If
'   conFlxGrid.Rows = 2
'   conFlxGrid.Clear
'
'   conFlxGrid.TextMatrix(0, 1) = "S_ID"
'   conFlxGrid.TextMatrix(0, 2) = "A/M"
'   conFlxGrid.TextMatrix(0, 3) = "Description"
'   conFlxGrid.TextMatrix(0, 4) = "From Dt"
'   conFlxGrid.TextMatrix(0, 5) = "To Dt"
'   conFlxGrid.TextMatrix(0, 6) = "Due Dt"
'   conFlxGrid.TextMatrix(0, 7) = "Amount"
'   conFlxGrid.TextMatrix(0, 8) = "VAT"
'   conFlxGrid.TextMatrix(0, 9) = "Total"
'   conFlxGrid.TextMatrix(0, 17) = "SageRef"
'   conFlxGrid.TextMatrix(0, 18) = "DSR"
'
'End Sub
Private Sub loadflxChildDemands(szPID As String)
   If szPID = "" Then Exit Sub
   If Not IsNumeric(szPID) Then Exit Sub

   Dim szStr As String, iRow As Integer
   Dim adoConn As New ADODB.Connection
   Dim adoRST As New ADODB.Recordset

'   connect to database
   adoConn.Open getConnectionString
'***get sendtoprint field for all demands that were set to be sent to print***
   szStr = "SELECT S.DSR,S.SPLITID AS S_ID, S.A_M AS A_M, " & _
               "S.NOMINALCODEFORAMOUNT AS NC_A, " & _
               "S.NOMINALNAMEFORAMOUNT AS NN_A, " & _
               "S.NOMINALCODEFORVAT AS NC_V, " & _
               "S.NOMINALNAMEFORVAT AS NN_V, " & _
               "S.NOMINALCODEFORTOTAL AS NC_T, " & _
               "S.NOMINALNAMEFORTOTAL AS NN_T, " & _
               "S.AMOUNT AS AMT, S.VATAMOUNT AS VAMT, " & _
               "S.TOTALAMOUNT AS TAMT, S.DUEDATE AS D_DATE, " & _
               "S.DESCRIPTION AS DESCP, S.SAGEREF AS SREF, " & _
               "S.DATEFROM AS D_FROM, S.DATETO AS D_TO, S.DSR,P.ClientID,P.PropertyID, F.FundCode,DT.Type " & _
           "FROM DEMANDRECORDS AS D, DEMANDSPLITRECORDS AS S, UNITS U, Property P, DemandTypes DT,Fund F " & _
           "WHERE P.PropertyID=U.PropertyID AND U.UnitNumber=D.UnitNumber AND S.DEMANDID = " & CLng(szPID) & " AND " & _
               "DT.ID=S.TypeOfDemand AND F.FundID=S.SageDepartment AND S.DEMANDID = D.DEMANDID " & _
           "ORDER BY S.SPLITID;"
'Debug.Print szStr
   adoRST.Open szStr, adoConn, adOpenStatic, adLockReadOnly

   iRow = 1
   While Not adoRST.EOF
     flxChildDemands.TextMatrix(iRow, 0) = adoRST!DSR
      flxChildDemands.TextMatrix(iRow, 1) = adoRST!S_ID
      flxChildDemands.TextMatrix(iRow, 2) = adoRST!A_M
      flxChildDemands.TextMatrix(iRow, 3) = adoRST!ClientID
      flxChildDemands.TextMatrix(iRow, 4) = adoRST!propertyID
      flxChildDemands.TextMatrix(iRow, 5) = adoRST!Type
      flxChildDemands.TextMatrix(iRow, 6) = adoRST!FundCode
      
      flxChildDemands.TextMatrix(iRow, 7) = adoRST!DESCP
      flxChildDemands.TextMatrix(iRow, 8) = IIf(IsNull(adoRST!D_FROM), "", adoRST!D_FROM)
      flxChildDemands.TextMatrix(iRow, 9) = IIf(IsNull(adoRST!D_TO), "", adoRST!D_TO)
      flxChildDemands.TextMatrix(iRow, 10) = IIf(IsNull(adoRST!D_DATE), "", adoRST!D_DATE)
      flxChildDemands.TextMatrix(iRow, 11) = IIf(IsNull(adoRST!amt), "0.00", Format(adoRST!amt, "0.00"))
      flxChildDemands.TextMatrix(iRow, 12) = IIf(adoRST!VAMT = 0, "0.00", Format(adoRST!VAMT, "0.00"))
      flxChildDemands.TextMatrix(iRow, 13) = IIf(adoRST!TAMT = 0, "0.00", Format(adoRST!TAMT, "0.00"))
      flxChildDemands.TextMatrix(iRow, 14) = IIf(IsNull(adoRST!NC_A), "", adoRST!NC_A)
      flxChildDemands.TextMatrix(iRow, 15) = IIf(IsNull(adoRST!NN_A), "", adoRST!NN_A)
      flxChildDemands.TextMatrix(iRow, 16) = IIf(IsNull(adoRST!NC_V), "", adoRST!NC_V)
      flxChildDemands.TextMatrix(iRow, 17) = IIf(IsNull(adoRST!NN_V), "", adoRST!NN_V)
      flxChildDemands.TextMatrix(iRow, 18) = IIf(IsNull(adoRST!NC_T), "", adoRST!NC_T)
      flxChildDemands.TextMatrix(iRow, 19) = IIf(IsNull(adoRST!NN_T), "", adoRST!NN_T)

      flxChildDemands.TextMatrix(iRow, 20) = IIf(IsNull(adoRST!SREF), "", adoRST!SREF)          'SageRef FROM SPLIT TABLE
     ' flxChildDemands.TextMatrix(iRow, 19) = adoRst!DSR

      adoRST.MoveNext
      If Not adoRST.EOF Then flxChildDemands.AddItem ""
      iRow = iRow + 1
   Wend
   adoRST.Close
   adoConn.Close
   Set adoRST = Nothing
   Set adoConn = Nothing
End Sub
Public Sub ConfigFlxSPayment()
   Dim szHeader As String

   flxSPayment.Clear
   'flxSPayment.Cols = 24
   'adding Five more col for locking issue
   flxSPayment.Cols = 35
   'modified by anol 18 Nov 2015
   flxSPayment.Rows = 2
   flxSPayment.RowHeight(0) = 0

   szHeader$ = "|<No.|<Type|<Lessee A/C|<Unit ID|<Due Date|<Ref|<Details|>Amount " & _
               "|>O/S Amt. |>Receipt |>Discount|<DemandID|>SAGE O/S |FundID|AllocRef|AllocAmt" & _
               "|SageDept|RptNo"
   flxSPayment.FormatString = szHeader$

   flxSPayment.ColWidth(0) = Label19(10).Left - flxSPayment.Left '200    'Sign
   flxSPayment.ColAlignment(0) = vbCenter
   flxSPayment.ColWidth(1) = Label19(11).Left - Label19(10).Left '620     'No
   flxSPayment.ColWidth(2) = Label19(13).Left - Label19(11).Left '2140    'Type
   flxSPayment.ColWidth(3) = 0       'SPLIT ID
   flxSPayment.ColWidth(4) = Label19(14).Left - Label19(13).Left '1000    'Unit ID
   flxSPayment.ColWidth(5) = Label19(15).Left - Label19(14).Left '1000    'Date
   flxSPayment.ColWidth(6) = Label19(16).Left - Label19(15).Left '1360    'Ref
   flxSPayment.ColWidth(7) = Label19(17).Left - Label19(16).Left '3000    'Details
   flxSPayment.ColWidth(8) = Label19(18).Left - Label19(17).Left '1100    'Amount
   flxSPayment.ColWidth(9) = Label19(19).Left - Label19(18).Left '1100    'O/S Amount
   flxSPayment.ColWidth(10) = flxSPayment.Left + flxSPayment.Width - Label19(19).Left - 360 '1100   'Receipt
   flxSPayment.ColWidth(11) = 0      'Discount
   flxSPayment.ColWidth(12) = 0      'DemandID
   flxSPayment.ColWidth(13) = 0      'SAGE O/S 
   flxSPayment.ColWidth(14) = 0      'FundID
   flxSPayment.ColWidth(15) = 0      'R/A; R -> receipt, A -> allocation
   flxSPayment.ColWidth(16) = 0      'allocation ref
   flxSPayment.ColWidth(17) = 0      'allocation amount
   flxSPayment.ColWidth(18) = 0      'Sage Department
   flxSPayment.ColWidth(19) = 0      'Receipt No 'TransactionID
   flxSPayment.ColWidth(20) = 0      'RECON
   flxSPayment.ColWidth(21) = 0      'Bank Code
   flxSPayment.ColWidth(22) = 0      'RptAmtType
   flxSPayment.ColWidth(23) = 0      'Posting date
    flxSPayment.ColWidth(24) = 0      'SessionID
    flxSPayment.ColWidth(25) = 0      'WindowsUserName
    flxSPayment.ColWidth(26) = 0      'MachineName
    flxSPayment.ColWidth(27) = 0      'Module
    flxSPayment.ColWidth(28) = 0      'clientID
    flxSPayment.ColWidth(29) = 0     'Demand ID
    flxSPayment.ColWidth(30) = 0      'vat amount
    flxSPayment.ColWidth(31) = 0      'Calculated vat amount for allication
      flxSPayment.ColWidth(32) = 0      'is Negative invoice there, if any of the invoice line is negative then put -1 else 1 for all other invoice line
      flxSPayment.ColWidth(33) = 0 'actual os after neg allocation
      flxSPayment.ColWidth(34) = 0 ' total splits
End Sub

Public Sub ConfigFlxCrPoA()
   Dim szHeader As String

   flxCrPoA.Clear
   flxCrPoA.Cols = 19
   flxCrPoA.Rows = 2
   flxCrPoA.RowHeight(0) = 0

   szHeader$ = "<No.|<Type|<Lessee A/C|<Unit ID|<Date|<Ref|<Details|>Amount |>O/S Amt. " & _
               "|>Receipt |Transactions Number|DemandID|SAGE O/S |TypeID|BankAC|FundID|RptAmtType"
   flxCrPoA.FormatString = szHeader$

   flxCrPoA.ColWidth(0) = 700    'Sequential Number
   flxCrPoA.ColWidth(1) = 2000   'Type
   flxCrPoA.ColWidth(2) = 0      'Lessee A/c - no need to show it in the grid, its already in the header part
   flxCrPoA.ColWidth(3) = 1000   'Unit ID
   flxCrPoA.ColWidth(4) = 1000   'Date
   flxCrPoA.ColWidth(5) = 1400   'Ref
   flxCrPoA.ColWidth(6) = 2460   'Details
   flxCrPoA.ColWidth(7) = 1100   'Amount
   flxCrPoA.ColWidth(8) = 1100   'O/S Amount
   flxCrPoA.ColWidth(9) = 1100   'Receipt
   flxCrPoA.ColWidth(10) = 0     'Transactions Number
   flxCrPoA.ColWidth(11) = 0     'DemandID
   flxCrPoA.ColWidth(12) = 0     'SAGE O/S 
   flxCrPoA.ColWidth(13) = 0     'Type ID    ID of col 1
   flxCrPoA.ColWidth(14) = 0     'Bank A/C
   flxCrPoA.ColWidth(15) = 0     'Fund ID
   flxCrPoA.ColWidth(16) = 0     'Rpt Amt Type
   'added by anol 25 aug 2015
   flxCrPoA.ColWidth(17) = 0     'clientID
   flxCrPoA.ColWidth(18) = 0     'Posting date

   Label19(20).Left = 300
   Label19(21).Left = 1500
   Label19(23).Left = 2700
   Label19(24).Left = 3750
   Label19(25).Left = 5000
   Label19(26).Left = 7000
   Label19(27).Left = 8750
   Label19(28).Left = 9800
   Label19(29).Left = 10900

   flxCrPoA.row = 0
   flxCrPoA.col = 0
End Sub

Private Function AccountBalance(adoConn As ADODB.Connection) As Currency
   Dim szSQL As String, iKount As Integer, cDr As Currency, cCr As Currency
   Dim adoRpt As New ADODB.Recordset, adoRptDtl As New ADODB.Recordset

   szSQL = "SELECT Rpt.*, TT.DESCRIPTION AS TT_DES " & _
           "FROM tlbReceipt AS Rpt, tlbTransactionTypes AS TT " & _
           "WHERE Rpt.SageAccountNumber = '" & flxLeaseList.TextMatrix(flxLeaseList.row, 1) & "' And " & _
               "Rpt.Type = TT.TYPE_ID " & _
           "ORDER BY Rpt.RDate;"
'Debug.Print szSQL
   adoRpt.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
   iKount = 1

   While Not adoRpt.EOF
      If adoRpt!Type = 1 Or adoRpt!Type = 23 Then
         cDr = cDr + Format(adoRpt.Fields.Item("Amount").Value, "0.00")         'Debit
      Else
         cCr = cCr + Format(adoRpt.Fields.Item("Amount").Value, "0.00")         'Credit
      End If
      adoRpt.MoveNext
   Wend
   adoRpt.Close

'############################## if there any unposted demand in the demand then its picking up here ##################

   szSQL = "SELECT D.DemandID, D.IssueDate, D.Details, SUM(DS.TotalAmount) " & _
           "FROM DemandRecords AS D, DemandSplitRecords AS DS " & _
           "WHERE D.DemandID = DS.DemandID AND " & _
               "D.SageAccountNumber = '" & flxLeaseList.TextMatrix(flxLeaseList.row, 1) & "' AND " & _
               "DS.TrfReceipt = FALSE " & _
           "GROUP BY D.DemandID, D.IssueDate, D.Details;"
   adoRpt.Open szSQL, adoConn, adOpenStatic, adLockReadOnly

   While Not adoRpt.EOF
      cDr = cDr + CCur(adoRpt.Fields.Item(3).Value)            'Debit
      adoRpt.MoveNext
   Wend
   adoRpt.Close

   Set adoRpt = Nothing

   AccountBalance = cDr - cCr
End Function

Public Sub AfterEditReceipt(adoConn As ADODB.Connection)
   'If sEditSRR = 2 Then GoTo EditReceipt

   flxSPayment.Clear
   flxSPayment.Rows = 2
    'Unlock previous locked item
      adoConn.Execute "Update tlbReceipt Set  DateTimeStamp='',Module='',UserSessionID='',WindowsUserName='',MachineName=''," & _
                   "PrestigeUserName='',ServerIPaddress='' where UserSessionID='" & UserSessionID & "'"
   LoadFlxSPayment adoConn

'   Exit Sub
'EditReceipt:

   flxCrPoA.Clear
   flxCrPoA.Rows = 2

   LoadFlxCrPoA adoConn
End Sub

Private Function CheckSavedBtRpt(adoConn As ADODB.Connection) As Boolean
   On Error GoTo MissingTable_GlobalRC

   Dim adoBP As New ADODB.Recordset
   Dim szaTenant() As String

   adoBP.Open "SELECT * FROM tblBatchPayment;", adoConn, adOpenStatic, adLockReadOnly
   adoBP.Close

   adoBP.Open "SELECT * FROM tblBatchTransaction;", adoConn, adOpenStatic, adLockReadOnly
   adoBP.Close

   szaTenant = Split(txtTenantID.text, " \ ")

   adoBP.Open "SELECT * " & _
              "FROM tblBtRptTran " & _
              "WHERE TenantID = '" & szaTenant(0) & "' AND " & _
              "BR IN (SELECT BR.BR FROM tblBatchReceipt AS BR " & _
                        "WHERE BR.Generated = FALSE);", adoConn, adOpenStatic, adLockReadOnly

   If Not adoBP.EOF Then
      CheckSavedBtRpt = True
   Else
      CheckSavedBtRpt = False
   End If
   adoBP.Close
   Set adoBP = Nothing

   Exit Function
MissingTable_GlobalRC:
   CheckSavedBtRpt = False
End Function

Public Sub flxLeaseList_Click()
    
   tabDmdRcpt.Enabled = True
   tabPayment.Enabled = True
   cmeRevereseAllocation.Enabled = True
   cmdAllocate.Enabled = True
   Dim adoConn As New ADODB.Connection
   If flxLeaseList.row = 0 Then Exit Sub
   adoConn.Open getConnectionString
   If strCommandSource = "Lease" Then
        txtRptClientList.text = flxLeaseList.TextMatrix(flxLeaseList.row, 5)
        'if you change a client you need to load the bank account accordingly 'anol
        Call LoadDefaultBankAC(adoConn) 'when you select a client it is loading a deafult Bank AC
        Call updateBankBalance
        txtReceiptReference.text = ""
        txtRcptAmtType.text = ""
        txtRcptAmtType.Tag = ""
        txtSPaymentTotal.text = "0.00"
       ' Call txtRptClientList_Change_Made
       chkApplyFund.Value = False
        txtRptPropertyList.text = "ALL"
        'txtRptClientList_Change_Made
      
      'below line added on 26/01/2018 by anol as account combo was not enabling after changing the lessee
      cmdBankAc.Enabled = True
      txtRptPropertyList.text = flxLeaseList.TextMatrix(flxLeaseList.row, 6)
      txtTenantID.text = flxLeaseList.TextMatrix(flxLeaseList.row, 1) & IIf((flxLeaseList.TextMatrix(flxLeaseList.row, 1) = ""), "", " \ ") & _
                         flxLeaseList.TextMatrix(flxLeaseList.row, 2)
     
      txtTenantID.Tag = flxLeaseList.TextMatrix(flxLeaseList.row, 1) 'added by anol 20181125 for use in checksum
      flxSPayment.Clear
      flxSPayment.Rows = 2
      flxCrPoA.Clear
      flxCrPoA.Rows = 2
      picLeaseList.Visible = False
      fmeLoading.Visible = True
      lblLoading.Caption = "Checking saved receipt.."
      fmeLoading.Refresh
      If Not CheckSavedBtRpt(adoConn) Then
         'Unlock previous locked item when changes of lessee
          adoConn.Execute "Update tlbReceipt Set  DateTimeStamp='',Module='',UserSessionID='',WindowsUserName='',MachineName=''," & _
                   "PrestigeUserName='',ServerIPaddress='' where UserSessionID='" & UserSessionID & "'"
         lblLoading.Caption = "Loading debit transactions..."
         lblLoading.Refresh
         LoadFlxSPayment adoConn
         'Debug.Print time
         lblLoading.Caption = "Loading Credit transactions..."
         lblLoading.Refresh
         LoadFlxCrPoA adoConn
         'Debug.Print time
      Else
         MsgBox "This lessee is locked by Batch Receipt." & Chr(13) & _
                "Please clear down batch receipts to book manual receipt.", vbExclamation + vbOKOnly, "Batch Receipt"
         adoConn.Close
         Set adoConn = Nothing
         Exit Sub
      End If
     fmeLoading.Visible = False
      txtTntAcBal.text = Format(AccountBalance(adoConn), "0.00")
      If Val(txtTntAcBal.text) >= 0 Then
         txtTntAcBal.ForeColor = vbBlack
      Else
         txtTntAcBal.ForeColor = vbRed
      End If

     
'      ReDim baChangesMade(flxSPayment.Rows) As Boolean

      Frame5(0).Enabled = True
      txtReceiptEntered.text = "0.00"
      txtSPaymentTotal.text = "0.00"
      'txtReceiptReference.SetFocus
      ChecksumValidationOnAllocationTenantClick adoConn
   End If

   If strCommandSource = "VAT" Then
      nTaxCode = flxLeaseList.TextMatrix(flxLeaseList.row, 2)
   End If

   If strCommandSource = "receipt" Then
      txtTenantID1.text = flxLeaseList.TextMatrix(flxLeaseList.row, 1) & " \ " & flxLeaseList.TextMatrix(flxLeaseList.row, 2)
      loadflxReceiptHistory adoConn, ""
   End If
    'Debug.Print time
   adoConn.Close
   Set adoConn = Nothing
 
   flxLeaseList.Clear
   flxLeaseList.Cols = 2
   'Modified by anol 18 Nov 2015
   flxLeaseList.Rows = 1
   picLeaseList.Visible = False
   txtTenantSearchID.text = ""
   chkExlessee.Enabled = True
   FocusControl cmdBankAc
End Sub

Private Sub flxDmdLeaseList_Click()
   Dim adoConn As New ADODB.Connection
   tabDmdRcpt.Enabled = True
   txtTenantName.text = flxDmdLeaseList.TextMatrix(flxDmdLeaseList.row, 1) & IIf((flxDmdLeaseList.TextMatrix(flxDmdLeaseList.row, 1) = ""), "", " / ") & _
   flxDmdLeaseList.TextMatrix(flxDmdLeaseList.row, 2)

   If flxDmdLeaseList.TextMatrix(flxDmdLeaseList.row, 4) = "EL" Then       'EXPIRED LEASE LABLE - Red in color
      Label1(0).Visible = True
   Else
      Label1(0).Visible = False
   End If

   Dim szaComp()        As String
   Dim szLeaseEndDate   As String
   Dim szExUnit         As String
   Dim LeaseID          As String
   If Trim(txtTenantName.text) = "" Then
        cmdDmdGridUnitLookup_Click
        Exit Sub
   End If
   szaComp = Split(txtTenantName.text, " / ")
   szCurCompSageAccNum = szaComp(0)

'   connect to database, Call the function "GetUnitIDbyTenantID" to get TenantID
   adoConn.Open getConnectionString
   'txtDmdPropertyList.text = flxDmdLeaseList.TextMatrix(flxDmdLeaseList.row, 3)
   txtUnit.text = GetUnitIDbyTenantID(szCurCompSageAccNum, adoConn, szLeaseEndDate, szExUnit, LeaseID)
   Label1(41).Caption = LeaseID
   If txtUnit.text = "NOT OCCUPYING" And szExUnit <> "NULL" Then
      txtUnit.text = szExUnit
   End If

   If flxDmdLeaseList.TextMatrix(flxDmdLeaseList.row, 3) <> "LANDLORD" And _
            flxDmdLeaseList.TextMatrix(flxDmdLeaseList.row, 3) <> "CLIENT" Then
            'Comment out by ANol 31 Jan 2016
      'cboVatCode.ListIndex = GetVATCode_Tenant(szCurCompSageAccNum, adoConn)
         Call GetVATCode_Tenant(szCurCompSageAccNum, adoConn)
   End If
    'ADDED BY ANOL 21 Jan 2016
   strCommandSource = "11"
   Call loadflxDemandType(flxDmdLeaseList.TextMatrix(flxDmdLeaseList.row, 1), adoConn)
   strCommandSource = "13"
   Call LoadJobs(adoConn)

'  Close the database connection
   adoConn.Close
   Set adoConn = Nothing

   txtLeaseEndDate.text = szLeaseEndDate
   txtIssueDate.SetFocus
   picDmdLeaseList.Visible = False
End Sub

Private Sub flxLeaseList_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
         flxLeaseList_Click
   End If
End Sub

Private Sub flxSPayment_Click()
   Dim i As Integer, iCurRowHeight As Integer

   sEditSRR = 1
   If Left(flxSPayment.TextMatrix(flxSPayment.row, 1), 3) = "SRR" Then
      cmdEditReceipt.Enabled = True
   Else
      cmdEditReceipt.Enabled = False
   End If

   If flxSPayment.col = 0 And flxSPayment.TextMatrix(flxSPayment.row, 0) = "+" Then          'Expanding the grid
      flxSPayment.TextMatrix(flxSPayment.row, 0) = ">"
      iCurRowHeight = flxSPayment.RowHeight(flxSPayment.row)
      i = 1

      While flxSPayment.TextMatrix(flxSPayment.row + i, 0) = "-"
         flxSPayment.RowHeight(flxSPayment.row + i) = iCurRowHeight
         i = i + 1
         If (flxSPayment.row + i) = flxSPayment.Rows Then Exit Sub
      Wend
      Exit Sub
   End If

   If flxSPayment.col = 0 And flxSPayment.TextMatrix(flxSPayment.row, 0) = ">" Then          'Squeezing the grid
      flxSPayment.TextMatrix(flxSPayment.row, 0) = "+"
      i = 1
      While flxSPayment.TextMatrix(flxSPayment.row + i, 0) = "-"
         flxSPayment.RowHeight(flxSPayment.row + i) = 0
         i = i + 1
         If (flxSPayment.row + i) = flxSPayment.Rows Then Exit Sub
      Wend
      Exit Sub
   End If
   HighLightRowFlxGridA flxSPayment, flxSPayment.row
   
   
End Sub
Public Sub HighLightRowFlxGridA(conFlxGrid As Control, iSelRow As Integer)
   Dim iRow As Integer, iCol As Integer, lTemp As Long, iOrgCol As Integer

   iOrgCol = conFlxGrid.col
   conFlxGrid.col = 2
   For iRow = 1 To conFlxGrid.Rows - 1
      conFlxGrid.row = iRow
      lTemp = conFlxGrid.CellBackColor
      
      If lTemp = RGB(233, 232, 155) Then
         For iCol = 1 To conFlxGrid.Cols - 1
            conFlxGrid.col = iCol
            conFlxGrid.CellBackColor = vbWhite
         Next iCol
         Exit For
      End If
   Next iRow

   conFlxGrid.row = iSelRow
   For iCol = 1 To conFlxGrid.Cols - 1
      conFlxGrid.col = iCol
      conFlxGrid.CellBackColor = RGB(233, 232, 155)
   Next iCol

   conFlxGrid.col = iOrgCol
End Sub
Private Sub flxSPayment_dblClick()

    If flxSPayment.RowHeight(flxSPayment.row) = 0 Then Exit Sub
    Dim i As Integer
     'added by anol for locking issue 749 will not be editable on double click
   flxSPayment.col = 0
   If flxSPayment.CellBackColor = vbRed Then
        MsgBox "The selected invoice is currently locked by  '" & flxSPayment.TextMatrix(flxSPayment.row, 25) & "' on '" & _
                    flxSPayment.TextMatrix(flxSPayment.row, 26) & "' in the '" & flxSPayment.TextMatrix(flxSPayment.row, 27) & "'" & vbCrLf & "" & _
                        "screen for the Client : '" & flxSPayment.TextMatrix(flxSPayment.row, 28) & "' and cannot be edited. Please wait until it is released.", vbInformation, "Warning"
        Exit Sub
   End If
   

   iFlxSPayCol = 10
   flxSPayment.col = iFlxSPayCol

   szUndoText = flxSPayment.TextMatrix(flxSPayment.row, iFlxSPayCol)
   'based lblAllocating.Visible is visible or false we can determing whether you are allocating from the lower grid or just entering value
   'when lblAllocating.Visible is visible then you are allocating based on lower grid
         'added by anol 18 Nov 2015
        If szUndoText = "" Then Exit Sub
        If Not lblAllocating.Visible And flxSPayment.TextMatrix(flxSPayment.row, 2) <> "ADJI" And _
                 Val(txtSPaymentTotal.text) >= 0 And Val(txtArray(4).text) = 0 And cmdAllocate.Caption <> "All&ocation Only" Then
                 MsgBox " You must first select a credit amount from the grid below before you can enter any amounts in this grid.", vbInformation + vbOKOnly, "Allocation"
                 Exit Sub
        End If
    
       If Not lblAllocating.Visible And flxSPayment.TextMatrix(flxSPayment.row, 2) <> "ADJI" And _
              cmdAllocate.Caption = "All&ocation Only" Then
          txtSPayment.Top = flxSPayment.CellTop + flxSPayment.Top
          txtSPayment.Left = flxSPayment.CellLeft + flxSPayment.Left
          txtSPayment.Width = flxSPayment.ColWidth(iFlxSPayCol)
          txtSPayment.Height = flxSPayment.RowHeight(flxSPayment.row) - 15
          txtSPayment.text = IIf(flxSPayment.TextMatrix(flxSPayment.row, iFlxSPayCol) = "", "0.00", flxSPayment.TextMatrix(flxSPayment.row, iFlxSPayCol))
          txtSPayment.Visible = True
          txtSPayment.SetFocus
       End If

'  ALLOCATION - Place the txtCrPayment text box in the grid to allocate agaist invoice
   If lblAllocating.Visible And Val(flxSPayment.TextMatrix(flxSPayment.row, iFlxSPayCol)) = 0 And Val(txtArray(4).text) > 0 Then
'      If (InStr(lblAllocating.Caption, "ADJ") > 0 And InStr(flxSPayment.TextMatrix(flxSPayment.row, 2), "ADJ") > 0) Or _
         (InStr(lblAllocating.Caption, "ADJ") = 0 And InStr(flxSPayment.TextMatrix(flxSPayment.row, 2), "ADJ") = 0) Then
         txtCrPayment.Top = flxSPayment.CellTop + flxSPayment.Top
         txtCrPayment.Left = flxSPayment.CellLeft + flxSPayment.Left
         txtCrPayment.Width = flxSPayment.ColWidth(iFlxSPayCol)
         txtCrPayment.Height = flxSPayment.RowHeight(flxSPayment.row) - 15
         txtCrPayment.text = Format(flxSPayment.TextMatrix(flxSPayment.row, iFlxSPayCol), "0.00")
         txtCrPayment.Visible = True
         txtCrPayment.SetFocus
         txtCrPayment.BackColor = RGB(233, 232, 155)
         Label10(3).Caption = flxSPayment.row
'      Else
'         If InStr(lblAllocating.Caption, "ADJ") > 0 Then
'            MsgBox "               Please select an Adjustment Invoice (ADJI) to allocate against." & Chr(13) & _
'                   "You can only allocate an Adjustment Credit (ADJC) against an Adjustment Invoice (ADJI).", vbCritical + vbOKOnly, "Allocation"
'         Else
'            MsgBox "                    Please select a Sales Invoice (SI) to allocate against." & Chr(13) & _
'                   "You can only allocate an Adjustment Credit (ADJC) against an Adjustment Invoice (ADJI).", vbCritical + vbOKOnly, "Allocation"
'         End If
'      End If
   End If
   '10/02/2017  Modification of allocation process
'
'1\ The allocation process needs to be modified so that when the user does an allocation, and saves it, the allocation screen remains open and the user can make the next allocation.'
'2\ When the user double clicks in the amount field of a line to allocate in the debit grid, the system should populate the full amount in the amount field in overtype mode to allow user to modify. On lost focus entry should be accepted as currently.
'Conditions
'For one credit line and one debit line respectively.'
'1/ If credit amount outstanding is less than or equal to the debit amount it will populate the whole of the credit amount'
'2/  If credit amount is greater than the debit amount outstanding  it will populate the whole of the debit amount'
'U:\Support Issues\Austin Chambers\Dyson Properties\Modification of allocation process'
    If cmdAllocate.Caption = "&Receipt Only" Then
        txtCrPayment.text = MinAmtAllocate
       
    End If
End Sub

Private Sub flxSPayment_Scroll()
   If txtSPayment.Visible Then      'The grid is in edting mode
      txtSPayment.text = szUndoText
      flxSPayment.Enabled = True
      txtSPayment.Visible = False
   End If
   If txtCrPayment.Visible Then
      txtCrPayment.text = Format(szUndoText, "0.00")
      flxSPayment.Enabled = True
      txtCrPayment.Visible = False
   End If
End Sub

Private Sub Form_Activate()
On Error GoTo Err
   Dim Control As Control
   Dim i As Integer
   For Each Control In Controls
            i = i + 1
   Next
   If UCase(SystemUser) = "BOSLUSER" And UCase(WS_Name) = "PCM-DEV2" Then
        Label50(10).Caption = "totalcontrols count :" & i
        Label50(10).Visible = True
   Else
        Label50(10).Visible = False
   End If
   
   
   Dim adoConn As New ADODB.Connection, adoRST As New ADODB.Recordset
   Dim szSQL As String, iCount As Integer, szClientDefaultBankID As String
   If isFormActive = True Then Exit Sub
 ' I need to investigate this procedure later becuase I don't know why this process should be here (anol 20170720)
'   connect to database
   adoConn.Open getConnectionString

'   Call UpdateLesseeAccountBalance(adoConn)  'Update all lessee's balance
   
'   szSQL = "SELECT A.DEMANDID, UNITS.PROPERTYID " & _
'           "From UNITS, " & _
'               "(SELECT DEMANDID, UnitNumber " & _
'                "From DemandRecords " & _
'                "WHERE SPARE1 = 'NULL') AS A " & _
'           "WHERE A.UnitNumber = UNITS.UnitNumber AND " & _
'               "A.DEMANDID NOT IN " & _
'                  "(SELECT DemandRecords.DemandID " & _
'                   "From DemandRecords " & _
'                   "WHERE DemandRecords.DemandID NOT IN " & _
'                     "(SELECT DemandSplitRecords.DEMANDID " & _
'                      "FROM DemandSplitRecords));"
'issue  381 SQL that is taking long time to complete 20170512 fixed by anol

'201200731 rem  by anol because it was taking 12 sec on dev pc and did not find any utility of this code
'Debug.Print time
' szSQL = "SELECT Y.DEMANDID, Y.PROPERTYID FROM  (SELECT A.DEMANDID, UNITS.PROPERTYID From UNITS, " & _
'           "(SELECT DEMANDID, UnitNumber  From DemandRecords  WHERE SPARE1 = 'NULL') AS A " & _
'               "WHERE A.UnitNumber = UNITS.UnitNumber) as Y LEFT JOIN " & _
'                "(SELECT DemandRecords.DemandID From DemandRecords  LEFT JOIN DemandSplitRecords ON  DemandRecords.DemandID = DemandSplitRecords.DEMANDID " & _
'                "where  DemandSplitRecords.DEMANDID is NULL) AS X ON Y.DemandID=x.demandID where X.DemandID is null;"
'Debug.Print time
'   adoRst.Open szSQL, adoConn, adOpenDynamic, adLockPessimistic
'
'   If Not adoRst.EOF Then
'      szClientDefaultBankID = ClientDefaultBankDts(adoRst!propertyID, adoConn)
'      While Not adoRst.EOF
'         szSQL = "UPDATE DEMANDRECORDS " & _
'                 "SET SPARE1 = '" & szClientDefaultBankID & "' " & _
'                 "WHERE DEMANDRECORDS.DEMANDID = " & CLng(adoRst.Fields.Item("DEMANDID").Value) & ";"
'         adoConn.Execute szSQL
'         'logging into error table
'         adoConn.Execute "Insert into SpareTable5(ClientID,Code,CC) values('DmndActv','" & Date & "' ,'ClientDefaultBankDts " & adoRst.Fields.Item("DEMANDID").Value & "' )"
'         adoRst.MoveNext
'      Wend
'   End If
   Debug.Print time
'rem by anol 08 Jan 2016
    txtRptClientList1.text = "ALL"
    txtRptPropertyList1.text = "ALL"
   'PrepareList adoConn, cboRptClientList1, cboRptPropertyList1
   AllBankList adoConn, cboRptBankList1

'  EXPORT all Invoices or Demands into tlbReceipt table *********************************************
   'MigrateInvIntoReceipt adoConn
   If frmMMain.frmDemand3_LesseList_isUptoDate = False Then
        '  Load all tenants with balance in gridTenantLookup
        TenantAccountBalance adoConn
        frmMMain.frmDemand3_LesseList_isUptoDate = True
   End If

   cGridRptTotal = 0
   iTotalTran = 0
   bTotalRptTyped = False
   iCrPoARowSel = 0

'   adoRst.Close
   adoConn.Close
   Set adoRST = Nothing
   Set adoConn = Nothing

   Dim szChoice As String, szaChoice() As String

   szChoice = GetSetting("PropertyManagement", "ChoosedOption", "Demand-c" & CStr(SCID))
   szaChoice = Split(szChoice, "#")

   If UBound(szaChoice) < 0 Then SaveSetting "PropertyManagement", "ChoosedOption", "Demand-c" & CStr(SCID), "ST#AP#IN"


   isFormActive = True
   Exit Sub
Err:
   MsgBox Err.description
End Sub
'Private Sub cboRptClientList1_Click()
'rem by anol 08 Jan 2015
'    'Resolved by BOSL
'    'Issue 452 newly added
'    'Modified by Anol 11 Aug 2014
'   On Error GoTo ERR
'   Dim adoConn As New ADODB.Connection
'   Dim adoRst As New ADODB.Recordset
'   Dim szSQL As String, Data() As String
'   Dim TotalRow As Integer, TotalCol As Integer
'   Dim i As Integer, j As Integer
'   adoConn.Open getConnectionString
'   If txtRptClientList1.text <> "ALL" Then
'      szSQL = "SELECT PropertyID, PropertyName, " & _
'                  "ProAddressLine1, ProPostCode " & _
'              "FROM Property " & _
'              "WHERE ClientID = '" & txtRptClientList1.text & "' " & _
'              "ORDER BY PropertyID;"
'   Else
'      szSQL = "SELECT PropertyID, PropertyName, " & _
'                  "ProAddressLine1, ProPostCode " & _
'              "FROM Property " & _
'              "ORDER BY PropertyID;"
'   End If
'   adoRst.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
'   'If adoRst.EOF Then GoTo NoRes
'   TotalRow = adoRst.RecordCount
'   TotalCol = adoRst.Fields.count
'
'   ReDim Data(TotalCol, TotalRow) As String
'
'   Data(0, 0) = "ALL"
'   Data(1, 0) = "All Properties"
'   For i = 1 To TotalRow
'       For j = 0 To TotalCol - 1
'           Data(j, i) = IIf(IsNull(adoRst.Fields(j).Value), "", adoRst.Fields(j).Value)
'       Next j
'       adoRst.MoveNext
'       If adoRst.EOF Then Exit For
'   Next i
'   cboRptPropertyList1.Column() = Data()
'   Exit Sub
'ERR:
'    MsgBox ERR.description
'End Sub
Private Sub Form_Load()
'    Me.Top = 0
'    Me.Left = 0
   GridRowNo = 1
   If UCase(SystemUser) = "BOSLUSER" And UCase(WS_Name) = "PCM-DEV2" Then
        cmdAdvanceProgr.Visible = True
   Else
        cmdAdvanceProgr.Visible = False
   End If
    txtInvoiceType.text = "ALL"
    txtInvoiceType.Tag = "ALL"
    fraGenerateDemands.BackColor = MODULEBACKCOLOR
    fraEditDemand.BackColor = MODULEBACKCOLOR
    fraPrint.BackColor = MODULEBACKCOLOR
    FraEmailSection.BackColor = MODULEBACKCOLOR
    fraDemandMainlist.BackColor = MODULEBACKCOLOR
    fraDetails.BackColor = MODULEBACKCOLOR
    fraCreateManualDemand.BackColor = MODULEBACKCOLOR
    Picture1(2).BackColor = MODULEBACKCOLOR
    optManualInv.BackColor = MODULEBACKCOLOR
    optManualAdjInv.BackColor = MODULEBACKCOLOR
    optManualCrNote.BackColor = MODULEBACKCOLOR
    optManualAdjCrNote.BackColor = MODULEBACKCOLOR
    chkSelectAllDemands.BackColor = MODULEBACKCOLOR
    lblGridCaption(0).BackColor = MODULEBACKCOLOR
    FraMiddleAddNewLine.BackColor = MODULEBACKCOLOR
    FraTopAddNewLine.BackColor = MODULEBACKCOLOR
    FraDemandDetails.BackColor = MODULEBACKCOLOR
    Frame5(5).BackColor = MODULEBACKCOLOR
    Frame5(0).BackColor = MODULEBACKCOLOR
    Frame1(0).BackColor = MODULEBACKCOLOR
    Frame5(4).BackColor = MODULEBACKCOLOR
    Frame9.BackColor = MODULEBACKCOLOR
    Frame8(0).BackColor = MODULEBACKCOLOR
    
 'On Error GoTo Err
''cascade form function created by anol 2019 -06-17
'    Dim iLeft As Integer
'    Dim iTop As Integer
'    Call BuildFormlist(Me.Name, iTop, iLeft)
'    frmBPPreForm.Top = iTop
'    frmBPPreForm.Left = iLeft
'    'Cascade Form End
'   frmMMain.Arrange vbCascade
   Me.ZOrder 0

   UserSessionID = GetTimeStamp
   BANK_PAYMENT_HISTORY_LOADED = False
   BATCH_DEMAND_PROCESS = False
   attachmentframePlayed = False
   flxAttachment.Clear
   flxAttachment.Rows = 2
   flxAttachment.Cols = 2
   flxAttachment.ColWidth(0) = 250
   flxAttachment.ColWidth(1) = 2000
   flxAttachment.ColWidth(2) = 4500
   flxAttachment.RowHeight(0) = 0
   Dim adoConn As New ADODB.Connection
   Dim adoRST As New ADODB.Recordset
   Dim szSQL As String
   'Resolved by BOSL
   'Issue 452
   'added by anol 01 Sep 2016
   LoadFrequency
   'Modified by Anol 11 Aug 2014
   flxReceiptHistory.row = 0
   
   FormLoad = True
'   connect to database
   adoConn.Open getConnectionString

   szSQL = "SELECT  CLIENTID " & _
           "FROM  Client " & _
           "ORDER BY CLIENTID;"

'Debug.Print szSQL
   adoRST.Open szSQL, adoConn, adOpenStatic, adLockReadOnly

   If adoRST.RecordCount = 0 Then
        MsgBox "You must create a Client before entering demands.", vbCritical + vbOKOnly, "Demand Form"
        adoRST.Close
        Set adoRST = Nothing
        adoConn.Close
        Set adoConn = Nothing
        FormLoad = False
        Exit Sub
   Else
        txtDmdClientList.text = adoRST.Fields("CLIENTID").Value
        txtDmdClientList.Tag = adoRST.Fields("CLIENTID").Value
        adoRST.Close
        
        
'        szSQL = "SELECT PropertyID, PropertyName, ProAddressLine1, ProPostCode " & _
'        "FROM Property WHERE ClientID = '" & txtDmdClientList.text & "' " & _
'        "ORDER BY PropertyID;"
'        adoRst.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
'        If Not adoRst.EOF Then
'          txtDmdPropertyList.text = IIf(IsNull(adoRst.Fields("PropertyID").Value), "", adoRst.Fields("PropertyID").Value)
'        Else
'          txtDmdPropertyList.text = ""
'        End If
         txtDmdPropertyList.text = ""
        
   End If
           
   iIncDec = 0

   Me.Height = 10410
   Me.Width = 16530
'   Me.Left = 0
'   Me.Top = 0
   Me.BackColor = MODULEBACKCOLOR
   tabDmdRcpt.BackColor = Me.BackColor

   bChangesMade = False
   nTaxCode = GetVATRate(1, adoConn)
   iSelected = 0
   bFormLoading = True

   Dim a As Integer

   Me.Caption = "Demands"

   tabDmdRcpt.Tab = 0
   'rem by anol 01 /01/2016
   'PrepareListIncAll adoConn, cboClientList, cboPropertyList
   txtClientList.text = "ALL"
   txtPropertyList.text = "ALL"
   txtUnitlist.text = "ALL"
   txtlesselist.text = "ALL"
   txtClientHistory.text = "ALL"
   txtPropertyHistory.text = "ALL"
   txtUnitListHist.text = "ALL"
   txtLesseeListHist.text = "ALL"
   txtRptClientList1.text = "ALL"
   
   txtRptPropertyList1.text = "ALL"
   'PrepareList adoConn, cboRptClientList1, cboRptPropertyList1
   AllBankList adoConn, cboRptBankList1
   
   'rem by anol 05 /01/2016
   'PrepareListHistoryCLPROPAll adoConn, cboClientHistory, cboPropertyHistory
  ' LoadFlxGrid flxDemands, False, adoConn, ""       'False - uploading history, which are already posted and printed and exported to sage
   LoadFlxDemands adoConn, ""
   ConfigFlxGrid flxChildDemands

   Call LoadFreq(adoConn)                    'Load all frequensis in the array string

   adoConn.Close
   Set adoConn = Nothing

   fVAT_Rate = 0

   flxDemands.row = 0
   flxDemands.col = 0

   bFormLoading = False
   Me.MousePointer = vbDefault
'   frmMMain.MousePointer = vbDefault
'  Prepair the Receipt type in Tenant Receipt History
   Dim Data(1, 3) As String

   Data(0, 0) = "ALL"
   Data(1, 0) = "All Types"
   Data(0, 1) = "3"
   Data(1, 1) = "Sales Receipt"
   Data(0, 2) = "4"
   Data(1, 2) = "Sales Receipt on Account"
   Data(0, 3) = "23"
   Data(1, 3) = "Sales Receipt Refund"

   cmbRptHistory.Column() = Data()
   cmbRptHistory.ListIndex = 0
   
   ReDim bSortingCol(8) As Boolean
   If UCase(SystemUser) <> "BOSLUSER" And UCase(WS_Name) <> "PCM-DEV2" Then
        Call WheelHook(Me.hWnd)
   End If
   Exit Sub
Err:
   MsgBox Err.description
End Sub
Private Sub loadfirstclient(adoConn As ADODB.Connection)
   Dim adoRST As New ADODB.Recordset
   Dim szSQL As String

   On Error GoTo ErrorHandler

'*************************************** CLIENT COMBO ******************************************
   szSQL = "SELECT CLIENTID, CLIENTNAME " & _
           "FROM CLIENT " & _
           "ORDER BY CLIENTID;"

   adoRST.Open szSQL, adoConn, adOpenStatic, adLockReadOnly

   If adoRST.EOF Then GoTo NoRes
   txtRptClientList1.text = adoRST("CLIENTID").Value
   txtRptClientList1.text = adoRST("CLIENTID").Value
   adoRST.Close

NoRes:
   Set adoRST = Nothing

   Exit Sub

ErrorHandler:
   MsgBox Err.description & "::" & Err.Number

   adoRST.Close
   Set adoRST = Nothing
End Sub
Private Sub UpdateLesseeAccountBalance1(ByVal adoConn As ADODB.Connection)
   Dim szSQL As String
   Dim adoRST As New ADODB.Recordset
   Dim adoLessee As New ADODB.Recordset

   szSQL = "SELECT SageAccountNumber, Balance FROM Tenants WHERE ISNULL(Comments);"
   adoLessee.Open szSQL, adoConn, adOpenDynamic, adLockOptimistic

   While Not adoLessee.EOF
      szSQL = "SELECT T " & _
              "FROM   TenantBalances " & _
              "WHERE  SageAccountNumber = '" & adoLessee.Fields.Item(0).Value & "';"

      adoRST.Open szSQL, adoConn, adOpenStatic, adLockReadOnly

      If Not adoRST.EOF Then _
         adoLessee.Fields.Item("Balance").Value = CCur(IIf(IsNull(adoRST.Fields.Item("T").Value), 0, adoRST.Fields.Item("T").Value))
      adoRST.Close

      adoLessee.Update
      adoLessee.MoveNext
   Wend

   Set adoRST = Nothing
   adoLessee.Close
   Set adoLessee = Nothing
End Sub

Public Sub UpdateLesseeAccountBalance(ByVal adoConn As ADODB.Connection)
   Dim szSQL As String, cAllOSInv As Currency, cAllPoA As Currency, cAllCredit As Currency
   Dim adoRST As New ADODB.Recordset
   Dim adoLessee As New ADODB.Recordset

   szSQL = "SELECT SageAccountNumber, Balance FROM Tenants WHERE ISNULL(Comments);"
   adoLessee.Open szSQL, adoConn, adOpenDynamic, adLockOptimistic

   While Not adoLessee.EOF
      DoEvents
      
      szSQL = "SELECT SUM(OSAmount) AS OSI " & _
              "FROM   tlbReceipt " & _
              "WHERE  SageAccountNumber = '" & adoLessee.Fields.Item(0).Value & "' AND " & _
                     "ReceiptView = TRUE AND TYPE <> 2;"

      adoRST.Open szSQL, adoConn, adOpenStatic, adLockReadOnly

      If Not adoRST.EOF Then _
         cAllOSInv = CCur(IIf(IsNull(adoRST.Fields.Item("OSI").Value), 0, adoRST.Fields.Item("OSI").Value))
      adoRST.Close

      szSQL = "SELECT SUM(OSAllocation) AS OSA " & _
              "FROM tblPoA " & _
              "WHERE SageAccountNumber = '" & adoLessee.Fields.Item(0).Value & "' AND " & _
                  "PoAView = TRUE;"
      adoRST.Open szSQL, adoConn, adOpenStatic, adLockReadOnly

      If Not adoRST.EOF Then _
         cAllPoA = CCur(IIf(IsNull(adoRST.Fields.Item("OSA").Value), 0, adoRST.Fields.Item("OSA").Value))
      adoRST.Close

      szSQL = "SELECT SUM(OSAmount) AS OSI " & _
              "FROM tlbReceipt " & _
              "WHERE SageAccountNumber = '" & adoLessee.Fields.Item(0).Value & "' AND " & _
                  "ReceiptView = TRUE AND TYPE = 2;"
      adoRST.Open szSQL, adoConn, adOpenStatic, adLockReadOnly

      If Not adoRST.EOF Then _
         cAllCredit = CCur(IIf(IsNull(adoRST.Fields.Item("OSI").Value), 0, adoRST.Fields.Item("OSI").Value))
      adoRST.Close

      cAllCredit = cAllCredit + cAllPoA
      adoLessee.Fields.Item("Balance").Value = cAllOSInv - cAllCredit
      adoLessee.Update
      adoLessee.MoveNext
   Wend

   Set adoRST = Nothing
   adoLessee.Close
   Set adoLessee = Nothing
End Sub

Private Sub AllBankList(adoConn As ADODB.Connection, cboClient As Control)
   Dim adoRST As New ADODB.Recordset
   Dim szSQL As String

   On Error GoTo ErrorHandler

   szSQL = "SELECT DISTINCT NominalCode, Bank_AC_Name " & _
           "FROM tlbClientBanks " & _
           "ORDER BY NominalCode;"

   adoRST.Open szSQL, adoConn, adOpenStatic, adLockReadOnly

   If adoRST.EOF Then GoTo NoRes

   Dim TotalRow As Integer, TotalCol As Integer
   Dim Data() As String
   Dim i As Integer, j As Integer

   TotalRow = adoRST.RecordCount
   TotalCol = adoRST.Fields.Count - 1

   ReDim Data(TotalCol, TotalRow) As String

   Data(0, 0) = "ALL"
   Data(1, 0) = "All Banks"
   For i = 1 To TotalRow
      For j = 0 To TotalCol
         Data(j, i) = IIf(IsNull(adoRST.Fields(j).Value), "", adoRST.Fields(j).Value)
      Next j
      adoRST.MoveNext
      If adoRST.EOF Then Exit For
   Next i
   cboRptBankList1.Column() = Data()
   cboRptBankList1.ListIndex = 0

NoRes:
   adoRST.Close
   Set adoRST = Nothing
   Exit Sub

ErrorHandler:
   MsgBox Err.description & "::" & Err.Number
   adoRST.Close
   Set adoRST = Nothing
End Sub

Private Sub PrepareListHistoryCLPROPAll(adoConn As ADODB.Connection, cboClient As Control, cboProperty As Control)
   Dim adoRST As New ADODB.Recordset
   Dim szSQL As String

   On Error GoTo ErrorHandler

'*************************************** CLIENT COMBO ******************************************
   szSQL = "SELECT CLIENTID, CLIENTNAME, CLIENTPOSTCODE,  " & _
               "LandLordSageCustAC, LandLordSageSuppAC " & _
           "FROM CLIENT " & _
           "ORDER BY CLIENTNAME;"

   adoRST.Open szSQL, adoConn, adOpenStatic, adLockReadOnly

   If adoRST.EOF Then GoTo NoRes

   Dim TotalRow As Integer, TotalCol As Integer
   Dim Data() As String
   Dim i As Integer, j As Integer

   TotalRow = adoRST.RecordCount
   TotalCol = adoRST.Fields.Count - 1

   ReDim Data(TotalCol, TotalRow) As String

   Data(0, 0) = "ALL"
   Data(1, 0) = "All Clients"
   For i = 1 To TotalRow
       For j = 0 To TotalCol
           Data(j, i) = IIf(IsNull(adoRST.Fields(j).Value), "", adoRST.Fields(j).Value)
       Next j
       adoRST.MoveNext
       If adoRST.EOF Then Exit For
   Next i

   cboClient.Column() = Data()
   cboClient.ListIndex = 0
   adoRST.Close
'*************************************** PROPERTY ******************************************
   If cboClient.Column(0) = "ALL" Then
      szSQL = "SELECT PropertyID, PropertyName, " & _
                  "ProAddressLine1, ProPostCode " & _
              "FROM Property " & _
              "ORDER BY PropertyID;"
   Else
      szSQL = "SELECT PropertyID, PropertyName, " & _
                  "ProAddressLine1, ProPostCode " & _
              "FROM Property " & _
              "WHERE ClientID = '" & cboClient.Column(0) & "' " & _
              "ORDER BY PropertyID;"
   End If
   adoRST.Open szSQL, adoConn, adOpenStatic, adLockReadOnly

   If adoRST.EOF Then GoTo NoRes

   TotalRow = adoRST.RecordCount
   TotalCol = adoRST.Fields.Count - 1

   ReDim Data(TotalCol, TotalRow) As String

   Data(0, 0) = "ALL"
   Data(1, 0) = "All Properties"
   For i = 1 To TotalRow
      For j = 0 To TotalCol - 1
         Data(j, i) = IIf(IsNull(adoRST.Fields(j).Value), "", adoRST.Fields(j).Value)
      Next j
      adoRST.MoveNext
      If adoRST.EOF Then Exit For
   Next i
   cboProperty.Column() = Data()
   cboProperty.ListIndex = 0

NoRes:
   adoRST.Close
   Set adoRST = Nothing

ErrorHandler:
End Sub
Private Sub PrepareListIncAll(adoConn As ADODB.Connection, cboClient As Control, cboProperty As Control)
   Dim adoRST As New ADODB.Recordset
   Dim szSQL As String

   On Error GoTo ErrorHandler

'*************************************** CLIENT COMBO ******************************************
   szSQL = "SELECT CLIENTID, CLIENTNAME, CLIENTPOSTCODE,  " & _
               "LandLordSageCustAC, LandLordSageSuppAC " & _
           "FROM CLIENT " & _
           "ORDER BY CLIENTNAME;"

   adoRST.Open szSQL, adoConn, adOpenStatic, adLockReadOnly

   If adoRST.EOF Then GoTo NoRes

   Dim TotalRow As Integer, TotalCol As Integer
   Dim Data() As String
   Dim i As Integer, j As Integer

   TotalRow = adoRST.RecordCount
   TotalCol = adoRST.Fields.Count - 1

   ReDim Data(TotalCol, TotalRow) As String

   Data(0, 0) = "ALL"
   Data(1, 0) = "All Clients"
   For i = 1 To TotalRow
       For j = 0 To TotalCol
           Data(j, i) = IIf(IsNull(adoRST.Fields(j).Value), "", adoRST.Fields(j).Value)
       Next j
       adoRST.MoveNext
       If adoRST.EOF Then Exit For
   Next i

   cboClient.Column() = Data()
   cboClient.ListIndex = 0
   adoRST.Close
'*************************************** PROPERTY ******************************************
   If cboClient.Column(0) = "ALL" Then
      szSQL = "SELECT PropertyID, PropertyName, " & _
                  "ProAddressLine1, ProPostCode " & _
              "FROM Property " & _
              "ORDER BY PropertyID;"
   Else
      szSQL = "SELECT PropertyID, PropertyName, " & _
                  "ProAddressLine1, ProPostCode " & _
              "FROM Property " & _
              "WHERE ClientID = '" & cboClient.Column(0) & "' " & _
              "ORDER BY PropertyID;"
   End If
   adoRST.Open szSQL, adoConn, adOpenStatic, adLockReadOnly

   If adoRST.EOF Then GoTo NoRes

   TotalRow = adoRST.RecordCount
   TotalCol = adoRST.Fields.Count - 1

   ReDim Data(TotalCol, TotalRow) As String

   Data(0, 0) = "ALL"
   Data(1, 0) = "All Properties"
   For i = 1 To TotalRow
      For j = 0 To TotalCol - 1
         Data(j, i) = IIf(IsNull(adoRST.Fields(j).Value), "", adoRST.Fields(j).Value)
      Next j
      adoRST.MoveNext
      If adoRST.EOF Then Exit For
   Next i
   cboProperty.Column() = Data()
   cboProperty.ListIndex = 0

NoRes:
   adoRST.Close
   Set adoRST = Nothing

   ConfigFlxLeaseList

   szSQL = "SELECT Tenants.SageAccountNumber, Name, UnitNumber " & _
          "From Tenants, LeaseDetails " & _
          "WHERE ((Tenants.Comments) IS NULL OR Tenants.Comments='') AND " & _
            "Tenants.SageAccountNumber = LeaseDetails.SageAccountNumber " & _
         "ORDER BY Tenants.SageAccountNumber;"

   PopulateTenantLookup adoConn, szSQL

   Exit Sub

ErrorHandler:
   MsgBox Err.description & "::" & Err.Number

   adoRST.Close
   Set adoRST = Nothing

   ConfigFlxLeaseList

   szSQL = "SELECT Tenants.SageAccountNumber, Name, UnitNumber " & _
          "From Tenants, LeaseDetails " & _
          "WHERE ((Tenants.Comments) IS NULL OR Tenants.Comments='') AND " & _
            "Tenants.SageAccountNumber = LeaseDetails.SageAccountNumber " & _
         "ORDER BY Tenants.SageAccountNumber;"

   PopulateTenantLookup adoConn, szSQL
End Sub

Private Sub PrepareList(adoConn As ADODB.Connection, cboClient As Control, cboProperty As Control)
   Dim adoRST As New ADODB.Recordset
   Dim szSQL As String
'Rem by anol 08 Jan 2016
'   On Error GoTo ErrorHandler
'
''*************************************** CLIENT COMBO ******************************************
'   szSQL = "SELECT CLIENTID, CLIENTNAME, CLIENTPOSTCODE,  " & _
'               "LandLordSageCustAC, LandLordSageSuppAC " & _
'           "FROM CLIENT " & _
'           "ORDER BY CLIENTNAME;"
'
'
'
'   adoRst.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
'
'   If adoRst.EOF Then GoTo NoRes
'
'   Dim TotalRow As Integer, TotalCol As Integer
'   Dim Data() As String
'   Dim i As Integer, j As Integer
'
'   TotalRow = adoRst.RecordCount - 1
'   TotalCol = adoRst.Fields.count - 1
'
'   ReDim Data(TotalCol, TotalRow) As String
'
'   For i = 0 To TotalRow
'       For j = 0 To TotalCol
'           Data(j, i) = IIf(IsNull(adoRst.Fields(j).Value), "", adoRst.Fields(j).Value)
'       Next j
'       adoRst.MoveNext
'       If adoRst.EOF Then Exit For
'   Next i
'
'   cboClient.Column() = Data()
'   cboClient.ListIndex = 0
'   adoRst.Close
''*************************************** PROPERTY ******************************************
'   szSQL = "SELECT PropertyID, PropertyName, " & _
'               "ProAddressLine1, ProPostCode " & _
'           "FROM Property " & _
'           "WHERE ClientID = '" & cboClient.Column(0) & "' " & _
'           "ORDER BY PropertyID;"
'
'   adoRst.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
'
'   If adoRst.EOF Then GoTo NoRes
'
'   TotalRow = adoRst.RecordCount
'   TotalCol = adoRst.Fields.count - 1
'
'   ReDim Data(TotalCol, TotalRow) As String
'
'   For i = 0 To TotalRow - 1
'      For j = 0 To TotalCol - 1
'         Data(j, i) = IIf(IsNull(adoRst.Fields(j).Value), "", adoRst.Fields(j).Value)
'      Next j
'      adoRst.MoveNext
'      If adoRst.EOF Then Exit For
'   Next i
'   cboProperty.Column() = Data()
'   cboProperty.ListIndex = 0
'
'NoRes:
'   adoRst.Close
'   Set adoRst = Nothing
'
'   ConfigureFlxLeaseList
'
'   szSQL = "SELECT Tenants.SageAccountNumber, Name, UnitNumber " & _
'          "From Tenants, LeaseDetails " & _
'          "WHERE ((Tenants.Comments) IS NULL OR Tenants.Comments='') AND " & _
'            "Tenants.SageAccountNumber = LeaseDetails.SageAccountNumber " & _
'         "ORDER BY Tenants.SageAccountNumber;"
'
'   PopulateTenantLookup adoConn, szSQL
'
'   Exit Sub
'
'ErrorHandler:
'   MsgBox ERR.description & "::" & ERR.Number
'
'   adoRst.Close
'   Set adoRst = Nothing

   ConfigFlxLeaseList

   szSQL = "SELECT Tenants.SageAccountNumber, Name, UnitNumber " & _
          "From Tenants, LeaseDetails " & _
          "WHERE ((Tenants.Comments) IS NULL OR Tenants.Comments='') AND " & _
            "Tenants.SageAccountNumber = LeaseDetails.SageAccountNumber " & _
         "ORDER BY Tenants.SageAccountNumber;"

   PopulateTenantLookup adoConn, szSQL
End Sub

Private Sub ConfigFlxGrid(conFlxGrid As Control)
   Dim i       As Integer
   Dim Index   As Integer

   conFlxGrid.Cols = 19
   conFlxGrid.RowHeight(0) = 0

   If conFlxGrid.Rows = 2 Then
'      conFlxGrid.ColWidth(0) = 30      'Solid column
'      conFlxGrid.ColWidth(1) = 550     'Split ID
'      conFlxGrid.ColWidth(2) = 500     'Generate Demand (A/M)
'      conFlxGrid.ColWidth(3) = 3500    'Description
'      conFlxGrid.ColWidth(4) = 1100    'From Date
'      conFlxGrid.ColWidth(5) = 1100    'To Date
'      conFlxGrid.ColWidth(6) = 1100    'Due Date
'      conFlxGrid.ColWidth(7) = 1200    'Amount
'      conFlxGrid.ColWidth(8) = 1000    'VAT
'      conFlxGrid.ColWidth(9) = 1200    'Total
'      conFlxGrid.ColWidth(10) = 0      'NC Amt
'      conFlxGrid.ColWidth(11) = 0      'NN Amt
'      conFlxGrid.ColWidth(12) = 0      'NC VAT
'      conFlxGrid.ColWidth(13) = 0      'NN VAT
'      conFlxGrid.ColWidth(14) = 0      'NC Tol
'      conFlxGrid.ColWidth(15) = 0      'NN Tol
'      conFlxGrid.ColWidth(16) = 0      'BATCHID number
'      conFlxGrid.ColWidth(17) = 0      'SageRef
'      conFlxGrid.ColWidth(18) = 0      'DSR
'
      If tabDmdRcpt.Tab = 0 Then
         Index = 9
      Else
         Index = 25
      End If
      conFlxGrid.ColWidth(0) = 1400 'Label44(Index).Left - conFlxGrid.Left
      For i = 1 To 8
         conFlxGrid.ColWidth(i) = 2000 'Label44(Index + 1).Left - Label44(Index).Left
         Index = Index + 1
      Next i
      conFlxGrid.ColWidth(i) = 1400 'Label44(Index).Width
      For i = 10 To 18
         conFlxGrid.ColWidth(i) = 0
      Next i
   End If
   conFlxGrid.Rows = 2
   conFlxGrid.Clear

   conFlxGrid.TextMatrix(0, 1) = "S_ID"
   conFlxGrid.TextMatrix(0, 2) = "A/M"
   conFlxGrid.TextMatrix(0, 3) = "Description"
   conFlxGrid.TextMatrix(0, 4) = "From Dt"
   conFlxGrid.TextMatrix(0, 5) = "To Dt"
   conFlxGrid.TextMatrix(0, 6) = "Due Dt"
   conFlxGrid.TextMatrix(0, 7) = "Amount"
   conFlxGrid.TextMatrix(0, 8) = "VAT"
   conFlxGrid.TextMatrix(0, 9) = "Total"
   conFlxGrid.TextMatrix(0, 17) = "SageRef"
   conFlxGrid.TextMatrix(0, 18) = "DSR"

'   Label44(9).Left = 250
'   Label44(10).Left = 800
'   Label44(11).Left = 2400
'   Label44(12).Left = 4900
'   Label44(13).Left = 6150
'   Label44(14).Left = 7100
'   Label44(15).Left = 8250
'   Label44(16).Left = 9500
'   Label44(17).Left = 10500
'   Label44(25).Left = 250
'   Label44(26).Left = 800
'   Label44(27).Left = 2400
'   Label44(28).Left = 4900
'   Label44(29).Left = 6150
'   Label44(30).Left = 7100
'   Label44(31).Left = 8250
'   Label44(32).Left = 9500
'   Label44(33).Left = 10500
End Sub

Private Sub ConfigFlxAddNewDemands()
   Dim szFlxHeader As String

   flxAddNewDemands.Rows = 2
   flxAddNewDemands.RowHeight(1) = 270

   flxAddNewDemands.Clear
   flxAddNewDemands.Cols = 27

   szFlxHeader$ = ">SL|<BRDemandType|<A/M|<Desc|<FDate|<TDate|<DDate|>Amt|>VAT|>Total|<SAGERef"
   flxAddNewDemands.FormatString = szFlxHeader$

   If flxAddNewDemands.Rows = 2 Then
      flxAddNewDemands.ColWidth(0) = lblGridCaption(2).Left - lblGridCaption(1).Left '600       'SL
      flxAddNewDemands.ColWidth(1) = lblGridCaption(3).Left - lblGridCaption(2).Left '1200      'A/M
      flxAddNewDemands.ColWidth(2) = lblGridCaption(4).Left - lblGridCaption(3).Left '1200     'BRDemandType
      flxAddNewDemands.ColWidth(3) = lblGridCaption(5).Left - lblGridCaption(4).Left '600       'Fund Code
      flxAddNewDemands.ColWidth(4) = lblGridCaption(6).Left - lblGridCaption(5).Left '3000      'Description
      flxAddNewDemands.ColWidth(5) = lblGridCaption(7).Left - lblGridCaption(6).Left '1000      'From Date
      flxAddNewDemands.ColWidth(6) = lblGridCaption(8).Left - lblGridCaption(7).Left + 100 '1000      'To Date
      flxAddNewDemands.ColWidth(7) = lblGridCaption(9).Left - lblGridCaption(8).Left - 100 '1000      'Due Date
      flxAddNewDemands.ColWidth(8) = lblGridCaption(10).Left - lblGridCaption(9).Left - 250          'Job ID
      flxAddNewDemands.ColWidth(9) = lblGridCaption(11).Left - lblGridCaption(10).Left - 200 '1200      'Amount
      flxAddNewDemands.ColWidth(10) = lblGridCaption(12).Left - lblGridCaption(11).Left '1000     'VAT
      flxAddNewDemands.ColAlignment(10) = vbRightJustify
      flxAddNewDemands.ColWidth(11) = lblGridCaption(12).Left - lblGridCaption(11).Left + 250 '1200    'Total
      flxAddNewDemands.ColWidth(12) = 0                                                         'SAGE REF
      flxAddNewDemands.ColWidth(13) = 0
      flxAddNewDemands.ColWidth(14) = 0
      flxAddNewDemands.ColWidth(15) = 0
      flxAddNewDemands.ColWidth(16) = 0
      flxAddNewDemands.ColWidth(17) = 0
      flxAddNewDemands.ColWidth(18) = 0
      flxAddNewDemands.ColWidth(19) = 0
      flxAddNewDemands.ColWidth(20) = 0 'Demand Type ID
      flxAddNewDemands.ColWidth(21) = 0 ' txtFund.Tag means Fund ID
      flxAddNewDemands.ColWidth(22) = 0
      flxAddNewDemands.ColWidth(23) = 0
      flxAddNewDemands.ColWidth(24) = 0 'client ID added by anol 05 Sep 2016
      flxAddNewDemands.ColWidth(25) = 0 'Demand Type Description
      flxAddNewDemands.ColWidth(26) = 0 'Fund Name
   End If
'   flxAddNewDemands.Clear
'   flxAddNewDemands.Rows = 2
   flxAddNewDemands.RowHeight(0) = 0
End Sub

Private Sub LoadFreq(adoConn As ADODB.Connection)
   Dim adoRstFreq As ADODB.Recordset
   Dim strSQLTitles As String

   Set adoRstFreq = New ADODB.Recordset
   strSQLTitles = "SELECT * FROM FREQUENCIES;"
   adoRstFreq.Open strSQLTitles, adoConn, adOpenStatic, adLockReadOnly

   ReDim szaFreq(adoRstFreq.RecordCount) As String

   While Not adoRstFreq.EOF
      szaFreq(adoRstFreq.Fields("ID").Value) = adoRstFreq.Fields("CALDAYS").Value
      adoRstFreq.MoveNext
   Wend
   adoRstFreq.Close
   Set adoRstFreq = Nothing
End Sub
Public Sub LoadFlxGridOneRow(conFlxGrid As Control, iRow As Integer, DEMANDID As String, adoConn As ADODB.Connection)
'Written by anol 18 08 2016
' This shall refresh only one rowno need to reload full grid
   

   Dim szStr As String
   Dim adoRST As New ADODB.Recordset

'*** get sendtoprint field for all demands that were set to be sent to print ***
szStr = ""
   szStr = "SELECT SUM(S.TOTALAMOUNT) AS TOTAL, " & _
               "D.SageAccountNumber AS SAGE_AC, D.TenantCompanyName AS T_NAME, " & _
               "D.UnitNumber AS U_NUM, D.TransactionType as T_TP, " & _
               "D.ISSUEDATE AS I_DATE, D.IsPrinted AS I_PRINT, " & _
               "D.DemandID AS D_ID, D.DemandHistory AS D_HIST, " & _
               "D.BATCHID AS BT, D.DmdSlNo, D.SentByEmail, R.OSAmount "
               'Modified by anol 22 Oct 2015
    
          szStr = szStr & _
                  "FROM (DemandRecords AS D LEFT JOIN DemandSplitRecords AS S ON " & _
                       "D.DEMANDID=S.DEMANDID) LEFT JOIN tlbReceipt AS R ON " & _
                       "D.DEMANDID=R.DemandRef "
          szStr = szStr & _
                  "WHERE D.DEMANDID = " & DEMANDID & " group by  D.SageAccountNumber, D.TenantCompanyName ,D.UnitNumber,TransactionType , D.ISSUEDATE, D.IsPrinted,D.DemandID, D.DemandHistory,D.BATCHID, D.DmdSlNo, D.SentByEmaiL, R.OSAmounT"
       
   adoRST.Open szStr, adoConn, adOpenStatic, adLockReadOnly
      While Not adoRST.EOF
         conFlxGrid.TextMatrix(iRow, 1) = adoRST!D_ID
         conFlxGrid.TextMatrix(iRow, 2) = IIf(adoRST!T_TP = 1, "SI", "SC") & adoRST!DmdSlNo
         conFlxGrid.TextMatrix(iRow, 3) = IIf(adoRST!T_TP = 1, "INV", "CRN")
         conFlxGrid.TextMatrix(iRow, 4) = adoRST!T_NAME
         conFlxGrid.TextMatrix(iRow, 5) = IIf(IsNull(adoRST!U_NUM), "", adoRST!U_NUM)
         conFlxGrid.TextMatrix(iRow, 6) = Format(adoRST!I_DATE, "dd/mm/yyyy")
         conFlxGrid.TextMatrix(iRow, 7) = IIf(IsNull(adoRST.Fields("TOTAL").Value), _
                                          "0.00", Format(adoRST.Fields("TOTAL").Value, "0.00"))
         conFlxGrid.TextMatrix(iRow, 8) = IIf(IsNull(adoRST.Fields.Item("OSAmount").Value), conFlxGrid.TextMatrix(iRow, 7), Format(adoRST.Fields.Item("OSAmount").Value, "0.00"))
         conFlxGrid.TextMatrix(iRow, 9) = IIf(adoRST!I_PRINT, "YES", "NO")
         conFlxGrid.TextMatrix(iRow, 11) = IIf(IsNull(adoRST!SentByEmail), "", IIf(adoRST!SentByEmail = 0, "NO", IIf(adoRST!SentByEmail = 1, "YES", "N/A")))
         conFlxGrid.TextMatrix(iRow, 12) = adoRST!BT
         adoRST.MoveNext
      Wend
   adoRST.Close
   Set adoRST = Nothing

  
End Sub
Public Sub LoadFlxDemands(adoConn As ADODB.Connection, Filter As String) 'loadflxDemands
   'ConfigFlxGridDemand flxDemands
   ConfigflxDemands
   Dim iRow As Integer, szStr As String
   Dim strWhere As String
   Dim adoRST As New ADODB.Recordset
   Dim strWhereTop As String
   Dim tempstr As String
   Dim strSentByEmail As String
'*** get sendtoprint field for all demands that were set to be sent to print ***
    '*** code for filtering starts
    colTransactionIDOtherSIGrid = ""
    If Filter = "3" Then
         If txtSearchFromD.text <> "" Then
           strWhere = " AND D.ISSUEDATE =#" & Format(txtSearchFromD.text, "dd/mmm/yyyy") & "#"
            If Len(txtSearchFromD.text) > 0 Then
                 cmdSearch.Caption = "Clear Sea&rch"
            Else
                 cmdSearch.Caption = "Sea&rch"
            End If
        End If
    End If
    If Filter = "4" Then
         If txtSearchFromD.text <> "" And txtSearchToD.text <> "" Then
            strWhere = " AND D.ISSUEDATE >=#" & Format(txtSearchFromD.text, "dd/mmm/yyyy") & "# AND D.ISSUEDATE <=#" & Format(txtSearchToD.text, "dd/mmm/yyyy") & "#"
            If Len(txtSearchFromD.text) > 0 And Len(txtSearchToD.text) > 0 Then
                 cmdSearch.Caption = "Clear Sea&rch"
            Else
                 cmdSearch.Caption = "Sea&rch"
            End If
        End If
    End If
    '*** code for filtering end
    strWhereTop = ""
    If Filter = "" And Val(txtArray(9).text) > 0 Then
        strWhereTop = "Top " & Val(txtArray(9).text)
    End If
   
   szStr = ""
   szStr = "SELECT " & strWhereTop & " SUM(S.TOTALAMOUNT) AS TOTAL,iif(TransactionType=1,'SI','SC') & DmdSlNo as invNo, " & _
               "D.SageAccountNumber AS SAGE_AC, D.TenantCompanyName AS T_NAME, " & _
               "D.UnitNumber AS U_NUM, D.TransactionType as T_TP, " & _
               "D.ISSUEDATE AS I_DATE, D.IsPrinted AS I_PRINT, " & _
               "D.DemandID AS D_ID, D.DemandHistory AS D_HIST, " & _
               "D.BATCHID AS BT, D.DmdSlNo, D.SentByEmail, R.OSAmount,R.UserSessionID,R.WindowsUserName,R.MachineName ,R.Module,R.transactionID "
               'Modified by anol 22 Oct 2015
               szStr = szStr & _
                  "FROM ((DemandRecords AS D LEFT JOIN DemandSplitRecords AS S ON " & _
                        "D.DemandID = S.DemandID)  LEFT JOIN tlbReceipt AS R ON " & _
                        "D.DEMANDID=R.DemandRef) INNER JOIN (Property INNER JOIN Units ON " & _
                        "Property.PropertyID = Units.PropertyID) ON " & _
                        "D.UnitNumber = Units.UnitNumber "
          szStr = szStr & _
                  "WHERE D.DEMANDHISTORY = false "


       If txtClientList.text <> "ALL" Then  'And txtPropertyList.text = "ALL"
          szStr = szStr & _
                  "AND Property.ClientID = '" & txtClientList.text & "'"
       End If

        If txtPropertyList.text <> "ALL" Then
          szStr = szStr & _
                  "AND Property.PropertyID = '" & txtPropertyList.text & "' "
       End If
       If txtUnitlist.text <> "ALL" Then
            szStr = szStr & _
                  "AND Units.UnitNumber = '" & txtUnitlist.text & "' "
       End If
       If txtlesselist.text <> "ALL" Then
            szStr = szStr & _
                  "AND D.SageAccountNumber = '" & txtlesselist.text & "' "
       End If

    
   szStr = szStr & strWhere & _
           "GROUP BY D.SageAccountNumber, D.TenantCompanyName, D.UnitNumber, " & _
                  "D.TransactionType, D.ISSUEDATE, D.IsPrinted, D.DemandID, " & _
                  "D.DemandHistory, D.BATCHID, D.DmdSlNo, D.SentByEmail, R.OSAmount,R.UserSessionID,R.WindowsUserName,R.MachineName ,R.Module,R.transactionID  " & _
           "ORDER BY  D.TransactionType,D.DmdSlNo Desc"
'Debug.Print szStr
   adoRST.Open szStr, adoConn, adOpenStatic, adLockReadOnly
   If Filter = "1" Then
        If txtSearchNo.text <> "" Then
            tempstr = Replace(UCase(txtSearchNo.text), "'", "''")
            adoRST.Filter = "invNo Like '%" & tempstr & "%'"
        End If
    End If
    If Filter = "2" Then
         If txtSearchRef.text <> "" Then
            tempstr = Replace(UCase(txtSearchRef.text), "'", "''")
            adoRST.Filter = "T_NAME Like '%" & tempstr & "%'"
        End If
    End If
   If Not adoRST.EOF Then
      iRow = 1
      flxDemands.Rows = adoRST.RecordCount + 1

      While Not adoRST.EOF
         flxDemands.TextMatrix(iRow, 1) = adoRST!D_ID
         flxDemands.TextMatrix(iRow, 2) = adoRST!InvNo 'IIf(adoRst!T_TP = 1, "SI", "SC") & adoRst!DmdSlNo
         flxDemands.TextMatrix(iRow, 3) = IIf(adoRST!T_TP = 1, "INV", "CRN")
         flxDemands.TextMatrix(iRow, 4) = adoRST!T_NAME
         flxDemands.TextMatrix(iRow, 5) = IIf(IsNull(adoRST!U_NUM), "", adoRST!U_NUM)
         flxDemands.TextMatrix(iRow, 6) = Format(adoRST!I_DATE, "dd/mm/yyyy")
         flxDemands.TextMatrix(iRow, 7) = IIf(IsNull(adoRST.Fields("TOTAL").Value), _
                                          "0.00", Format(adoRST.Fields("TOTAL").Value, "0.00"))
         flxDemands.TextMatrix(iRow, 8) = IIf(IsNull(adoRST.Fields.Item("OSAmount").Value), flxDemands.TextMatrix(iRow, 7), Format(adoRST.Fields.Item("OSAmount").Value, "0.00"))
         flxDemands.TextMatrix(iRow, 9) = IIf(adoRST!I_PRINT, "YES", "NO")
         strSentByEmail = ""
         If IsNull(adoRST!SentByEmail) = True Then
         End If
         If adoRST!SentByEmail = 0 Then
             strSentByEmail = "NO"
         End If
         If adoRST!SentByEmail = 1 Then
             strSentByEmail = "YES"
         End If
         If adoRST!SentByEmail = 2 Then
             strSentByEmail = "N/A"
         End If
         If adoRST!SentByEmail = 3 Then
             strSentByEmail = "FAILED"
         End If
         'R.UserSessionID,R.WindowsUserName,R.MachineName ,R.Module
         flxDemands.TextMatrix(iRow, 11) = strSentByEmail ' IIf(IsNull(adoRst!SentByEmail), "", IIf(adoRst!SentByEmail = 0, "NO", IIf(adoRst!SentByEmail = 1, "YES", "N/A")))
         flxDemands.TextMatrix(iRow, 12) = adoRST!BT
         flxDemands.TextMatrix(iRow, 13) = IIf(IsNull(adoRST!UserSessionID), "", adoRST!UserSessionID)
         flxDemands.TextMatrix(iRow, 14) = IIf(IsNull(adoRST!WindowsUserName), "", adoRST!WindowsUserName)
         flxDemands.TextMatrix(iRow, 15) = IIf(IsNull(adoRST!MachineName), "", adoRST!MachineName)
         flxDemands.TextMatrix(iRow, 16) = IIf(IsNull(adoRST!Module), "", adoRST!Module)
         flxDemands.TextMatrix(iRow, 17) = IIf(IsNull(adoRST!TransactionID), "", adoRST!TransactionID)
         If flxDemands.TextMatrix(iRow, 13) <> "" Then
            flxDemands.col = 0
            flxDemands.row = iRow
            flxDemands.CellBackColor = vbRed
             colTransactionIDOtherSIGrid = colTransactionIDOtherSIGrid & IIf(IsNull(adoRST.Fields.Item("TransactionID").Value), "", adoRST.Fields.Item("TransactionID").Value) & ","
         End If
         
         adoRST.MoveNext

         iRow = iRow + 1
      Wend
   Else
     ' If bHistory Then Label1(40).Caption = "There is no demand history recorded."
   End If
   If Len(colTransactionIDOtherSIGrid) > 0 Then
        colTransactionIDOtherSIGrid = Left(colTransactionIDOtherSIGrid, Len(colTransactionIDOtherSIGrid) - 1)
   End If
   adoRST.Close
   Set adoRST = Nothing

   iSelectedDemandsRow = 0
   iIncDec = 0
   flxDemands.row = 0
End Sub
Public Sub LoadFlxGrid(conFlxGrid As Control, bHistory As Boolean, adoConn As ADODB.Connection, Filter As String) 'loadflxDemands
   ConfigFlxGridDemand conFlxGrid

   Dim iRow As Integer, szStr As String
   Dim strWhere As String
   Dim adoRST As New ADODB.Recordset
   Dim strWhereTop As String
   Dim tempstr As String
   Dim strSentByEmail As String
'*** get sendtoprint field for all demands that were set to be sent to print ***
    '*** code for filtering starts
    colTransactionIDOtherSIGrid = ""
    If Filter = "3" Then
         If txtSearchFromD.text <> "" Then
           strWhere = " AND D.ISSUEDATE =#" & Format(txtSearchFromD.text, "dd/mmm/yyyy") & "#"
            If Len(txtSearchFromD.text) > 0 Then
                 cmdSearch.Caption = "Clear Sea&rch"
            Else
                 cmdSearch.Caption = "Sea&rch"
            End If
        End If
    End If
    If Filter = "4" Then
         If txtSearchFromD.text <> "" And txtSearchToD.text <> "" Then
            strWhere = " AND D.ISSUEDATE >=#" & Format(txtSearchFromD.text, "dd/mmm/yyyy") & "# AND D.ISSUEDATE <=#" & Format(txtSearchToD.text, "dd/mmm/yyyy") & "#"
            If Len(txtSearchFromD.text) > 0 And Len(txtSearchToD.text) > 0 Then
                 cmdSearch.Caption = "Clear Sea&rch"
            Else
                 cmdSearch.Caption = "Sea&rch"
            End If
        End If
    End If
    '*** code for filtering end
    strWhereTop = ""
    If Filter = "" And Val(txtArray(9).text) > 0 Then
        strWhereTop = "Top " & Val(txtArray(9).text)
    End If
   
   szStr = ""
   szStr = "SELECT " & strWhereTop & " SUM(S.TOTALAMOUNT) AS TOTAL,iif(TransactionType=1,'SI','SC') & DmdSlNo as invNo, " & _
               "D.SageAccountNumber AS SAGE_AC, D.TenantCompanyName AS T_NAME, " & _
               "D.UnitNumber AS U_NUM, D.TransactionType as T_TP, " & _
               "D.ISSUEDATE AS I_DATE, D.IsPrinted AS I_PRINT, " & _
               "D.DemandID AS D_ID, D.DemandHistory AS D_HIST, " & _
               "D.BATCHID AS BT, D.DmdSlNo, D.SentByEmail, R.OSAmount,R.UserSessionID,R.WindowsUserName,R.MachineName ,R.Module,R.transactionID "
               'Modified by anol 22 Oct 2015
               szStr = szStr & _
                  "FROM ((DemandRecords AS D LEFT JOIN DemandSplitRecords AS S ON " & _
                        "D.DemandID = S.DemandID)  LEFT JOIN tlbReceipt AS R ON " & _
                        "D.DEMANDID=R.DemandRef) INNER JOIN (Property INNER JOIN Units ON " & _
                        "Property.PropertyID = Units.PropertyID) ON " & _
                        "D.UnitNumber = Units.UnitNumber "
          szStr = szStr & _
                  "WHERE D.DEMANDHISTORY = " & bHistory & " "
    If bHistory = False Then
       If txtClientList.text <> "ALL" Then  'And txtPropertyList.text = "ALL"
          szStr = szStr & _
                  "AND Property.ClientID = '" & txtClientList.text & "'"
       End If
       If txtInvoiceType.text = "SI" Then
            szStr = szStr & _
                  "AND D.TransactionType = 1 "
       End If
       If txtInvoiceType.text = "SC" Then
            szStr = szStr & _
                  "AND D.TransactionType = 2 "
       End If
       If txtPropertyList.text <> "ALL" Then
            szStr = szStr & _
                  "AND Property.PropertyID = '" & txtPropertyList.text & "' "
       End If
       If txtUnitlist.text <> "ALL" Then
            szStr = szStr & _
                  "AND Units.UnitNumber = '" & txtUnitlist.text & "' "
       End If
       If txtlesselist.text <> "ALL" Then
            szStr = szStr & _
                  "AND D.SageAccountNumber = '" & txtlesselist.text & "' "
       End If
    Else
       'for history TAB
        
                    If txtClientHistory.text <> "ALL" Then  'And txtPropertyList.text = "ALL"
                            szStr = szStr & _
                              "AND Property.ClientID = '" & txtClientHistory.text & "'"
                    End If
           
                    If txtPropertyHistory.text <> "ALL" Then
                      szStr = szStr & _
                              "AND Property.PropertyID = '" & txtPropertyHistory.text & "' "
                   End If
                   If txtUnitListHist.text <> "ALL" Then
                        szStr = szStr & _
                              "AND D.UnitNumber = '" & txtUnitListHist.text & "' "
                   End If
                   If txtLesseeListHist.text <> "ALL" Then
                        szStr = szStr & _
                              "AND D.SageAccountNumber = '" & txtLesseeListHist.text & "' "
                   End If
    End If
    
   szStr = szStr & strWhere & _
           "GROUP BY D.SageAccountNumber, D.TenantCompanyName, D.UnitNumber, " & _
                  "D.TransactionType, D.ISSUEDATE, D.IsPrinted, D.DemandID, " & _
                  "D.DemandHistory, D.BATCHID, D.DmdSlNo, D.SentByEmail, R.OSAmount,R.UserSessionID,R.WindowsUserName,R.MachineName ,R.Module,R.transactionID  " & _
           "ORDER BY  D.TransactionType,D.DmdSlNo Desc"
'Debug.Print szStr
   adoRST.Open szStr, adoConn, adOpenStatic, adLockReadOnly
   If Filter = "1" Then
        If txtSearchNo.text <> "" Then
            tempstr = Replace(UCase(txtSearchNo.text), "'", "''")
            adoRST.Filter = "invNo Like '%" & tempstr & "%'"
        End If
    End If
    If Filter = "2" Then
         If txtSearchRef.text <> "" Then
            tempstr = Replace(UCase(txtSearchRef.text), "'", "''")
            adoRST.Filter = "T_NAME Like '%" & tempstr & "%'"
        End If
    End If
   If Not adoRST.EOF Then
      iRow = 1
      conFlxGrid.Rows = adoRST.RecordCount + 1

      While Not adoRST.EOF
         conFlxGrid.TextMatrix(iRow, 1) = adoRST!D_ID
         conFlxGrid.TextMatrix(iRow, 2) = adoRST!InvNo 'IIf(adoRst!T_TP = 1, "SI", "SC") & adoRst!DmdSlNo
         conFlxGrid.TextMatrix(iRow, 3) = IIf(adoRST!T_TP = 1, "INV", "CRN")
         conFlxGrid.TextMatrix(iRow, 4) = adoRST!T_NAME
         conFlxGrid.TextMatrix(iRow, 5) = IIf(IsNull(adoRST!U_NUM), "", adoRST!U_NUM)
         conFlxGrid.TextMatrix(iRow, 6) = Format(adoRST!I_DATE, "dd/mm/yyyy")
         conFlxGrid.TextMatrix(iRow, 7) = IIf(IsNull(adoRST.Fields("TOTAL").Value), _
                                          "0.00", Format(adoRST.Fields("TOTAL").Value, "0.00"))
         conFlxGrid.TextMatrix(iRow, 8) = IIf(IsNull(adoRST.Fields.Item("OSAmount").Value), conFlxGrid.TextMatrix(iRow, 7), Format(adoRST.Fields.Item("OSAmount").Value, "0.00"))
         conFlxGrid.TextMatrix(iRow, 9) = IIf(adoRST!I_PRINT, "YES", "NO")
         strSentByEmail = ""
         If IsNull(adoRST!SentByEmail) = True Then
         End If
         If adoRST!SentByEmail = 0 Then
             strSentByEmail = "NO"
         End If
         If adoRST!SentByEmail = 1 Then
             strSentByEmail = "YES"
         End If
         If adoRST!SentByEmail = 2 Then
             strSentByEmail = "N/A"
         End If
         If adoRST!SentByEmail = 3 Then
             strSentByEmail = "FAILED"
         End If
         'R.UserSessionID,R.WindowsUserName,R.MachineName ,R.Module
         conFlxGrid.TextMatrix(iRow, 11) = strSentByEmail ' IIf(IsNull(adoRst!SentByEmail), "", IIf(adoRst!SentByEmail = 0, "NO", IIf(adoRst!SentByEmail = 1, "YES", "N/A")))
         conFlxGrid.TextMatrix(iRow, 12) = adoRST!BT
         conFlxGrid.TextMatrix(iRow, 13) = IIf(IsNull(adoRST!UserSessionID), "", adoRST!UserSessionID)
         conFlxGrid.TextMatrix(iRow, 14) = IIf(IsNull(adoRST!WindowsUserName), "", adoRST!WindowsUserName)
         conFlxGrid.TextMatrix(iRow, 15) = IIf(IsNull(adoRST!MachineName), "", adoRST!MachineName)
         conFlxGrid.TextMatrix(iRow, 16) = IIf(IsNull(adoRST!Module), "", adoRST!Module)
         conFlxGrid.TextMatrix(iRow, 17) = IIf(IsNull(adoRST!TransactionID), "", adoRST!TransactionID)
         If conFlxGrid.TextMatrix(iRow, 13) <> "" Then
            conFlxGrid.col = 0
            conFlxGrid.row = iRow
            conFlxGrid.CellBackColor = vbRed
             colTransactionIDOtherSIGrid = colTransactionIDOtherSIGrid & IIf(IsNull(adoRST.Fields.Item("TransactionID").Value), "", adoRST.Fields.Item("TransactionID").Value) & ","
         End If
         
         adoRST.MoveNext

         iRow = iRow + 1
      Wend
   Else
      If bHistory Then Label1(40).Caption = "There is no demand history recorded."
   End If
   If Len(colTransactionIDOtherSIGrid) > 0 Then
        colTransactionIDOtherSIGrid = Left(colTransactionIDOtherSIGrid, Len(colTransactionIDOtherSIGrid) - 1)
   End If
   adoRST.Close
   Set adoRST = Nothing

   iSelectedDemandsRow = 0
   iIncDec = 0
   conFlxGrid.row = 0
End Sub
Private Function InstantLockingCheck() As Boolean 'unlocking for all row
   Dim adoPay As New ADODB.Recordset
   Dim rsLockDialog As New ADODB.Recordset
   Dim adoConn As New ADODB.Connection
   Dim szSQL As String, iRow As Integer
   Dim selRow As Integer
   Dim selcol As Integer
   Dim i As Integer
   Dim j As Integer
   Dim strSQL As String
   Dim szSlNo As String
   selRow = flxDemands.row
   selcol = flxDemands.col
'    szLastIDClicked = SelectedID(, szSlNo, iDemandRow)'we don't need this is this lock is 'X' Independent
'If szLastIDClicked = "" Then
'    MsgBox "Line not selected"
'    Exit Function
'End If
   If flxDemands.row = 0 Then Exit Function
   adoConn.Open getConnectionString
   'first part is instant lock
   szSQL = "SELECT R.TransactionID,R.UserSessionID,R.WindowsUserName,R.MachineName,R.Module,R.ClientID  " & _
           "FROM tlbReceipt R, DemandRecords D " & _
           "WHERE R.DemandRef = " & flxDemands.TextMatrix(flxDemands.row, 1) & " AND R.DemandRef=D.DemandID;"
   
   adoPay.Open szSQL, adoConn, adOpenStatic, adLockReadOnly

  'locking status show for current row
   If Not adoPay.EOF Then
            szSQL = IIf(IsNull(adoPay("UserSessionID").Value), "", adoPay("UserSessionID").Value)
            If Len(szSQL) > 0 Then   'szSQL <> UserSessionID shall be always true bcoz PI is generating only one session thrgh out this module.
                flxDemands.col = 0
                'flxDemands.row = flxDemands.row
                flxDemands.CellBackColor = vbRed
                InstantLockingCheck = False
                colTransactionIDOtherSIGrid = colTransactionIDOtherSIGrid & IIf(IsNull(adoPay("TransactionID").Value), "", adoPay("TransactionID").Value) & ","
            Else 'lock for this user
                        flxDemands.col = 0
                        i = flxDemands.row
                        flxDemands.CellBackColor = vbWhite
    '                    adoconn.Execute "Update tlbPayment Set  DateTimeStamp='" & Now & "',Module='Purchase Invoice',UserSessionID='" & UserSessionID & "',WindowsUserName='" & SystemUser & "',MachineName='" & WS_Name & "'," & _
    '                    "PrestigeUserName='" & User & "',ServerIPaddress='" & GetIPaddress & "' where tlbPayment.PI = '" & flxDemands.TextMatrix(iPIEdit, 0) & "'"
                        'Need to clear the locking flag
                        flxDemands.TextMatrix(i, 13) = ""
                        flxDemands.TextMatrix(i, 14) = ""
                        flxDemands.TextMatrix(i, 15) = ""
                        flxDemands.TextMatrix(i, 16) = ""
            End If

   End If
   'second part instant unlock

      If Len(colTransactionIDOtherSIGrid) > 0 Then
            szSQL = "SELECT TransactionID,SlNumber, Type, UserSessionID,WindowsUserName,MachineName,Module,ClientID " & _
                 "FROM tlbReceipt where (isnull(UserSessionID) OR UserSessionID='') " & _
                 " AND TransactionID in (" & colTransactionIDOtherSIGrid & ") order by 2,3 Desc;"
            rsLockDialog.Open szSQL, adoConn, adOpenStatic, adLockReadOnly 'Selecting those transaction which has been unlocked in the background with out knowing this form
             While Not rsLockDialog.EOF
                      flxDemands.col = 0
                      For j = 1 To flxDemands.Rows - 1
'                            If "PI9339" = flxDemands.TextMatrix(j, 2) Then
'                                'Debug.Print flxDemands.TextMatrix(j, 2)
'                            End If
'                            If j = 3 And rsLockDialog("SlNumber").Value = 9339 Then
'                                Debug.Print flxDemands.TextMatrix(j, 2)
'                            End If
'                           Debug.Print flxDemands.TextMatrix(j, 2)
                           'Debug.Print rsLockDialog("SlNumber").Value
                          If flxDemands.TextMatrix(j, 17) = rsLockDialog("transactionID").Value And i <> j Then 'no need to update row of first part check

                                flxDemands.row = j
                                'flxDemands.col = 1
                                'Debug.Print j
                                flxDemands.CellBackColor = vbWhite
                          End If
                       Next j
                    rsLockDialog.MoveNext
              Wend
        End If
        'second part ends here

        flxDemands.col = selcol
        flxDemands.row = selRow




   adoPay.Close
   adoConn.Close
   flxDemands.row = selRow
   flxDemands.col = selcol
   Set adoPay = Nothing
   Set adoConn = Nothing
End Function
Private Sub Form_MouseDown(Button As Integer, Shift As Integer, X As Single, Y As Single)
  Me.MousePointer = vbArrow
End Sub

Private Sub Form_MouseMove(Button As Integer, Shift As Integer, X As Single, Y As Single)
   Me.MousePointer = vbDefault
End Sub

Private Sub SetMark(ByVal bRef As Boolean, ByVal bSucc As Boolean, ByVal curOS As Currency, ByVal tranID As Long, adoConn As ADODB.Connection)
   Dim szSQLStr As String, szMark As String
   Dim adoRptCh As New ADODB.Recordset

   If bSucc Then
      szMark = "S"
   Else
      If bRef Then
         szMark = "F" & CStr(curOS)
      Else
         szMark = "F-1"
      End If
   End If

   szSQLStr = "SELECT UpDateSage, spare2  " & _
              "FROM tlbReceipt AS RPT " & _
              "WHERE RPT.TransactionID = " & tranID & ";"

   adoRptCh.Open szSQLStr, adoConn, adOpenDynamic, adLockPessimistic

   adoRptCh.Fields.Item("UpDateSage").Value = IIf(szMark = "S", False, True)
   adoRptCh.Fields.Item("spare2").Value = szMark
   adoRptCh.Update

   adoRptCh.Close
   Set adoRptCh = Nothing

   iTotalTran = iTotalTran + 1
End Sub

Private Sub ExportSR2Sage()
End Sub

Private Function SagePostingNumberInv(szTransactionID As String, adoConn As ADODB.Connection) As Long
   Dim szStr As String
   Dim adoRST As New ADODB.Recordset

   szStr = "SELECT DemandRecords.SAGEPostingNumber " & _
           "FROM DemandRecords, DemandSplitRecords, tlbReceipt " & _
           "WHERE tlbReceipt.TransactionID = " & CLng(szTransactionID) & " AND " & _
               "tlbReceipt.DemandRef = DemandSplitRecords.DSR AND " & _
               "DemandSplitRecords.DemandID = DemandRecords.DemandID;"
'Debug.Print szStr
   adoRST.Open szStr, adoConn, adOpenStatic, adLockReadOnly

   SagePostingNumberInv = adoRST.Fields.Item("SAGEPostingNumber").Value

   adoRST.Close
   Set adoRST = Nothing
End Function

Private Function SagePostingNumberPoA(szTransactionID As String, adoConn As ADODB.Connection) As Long
   Dim szStr As String
   Dim adoRST As New ADODB.Recordset

   szStr = "SELECT spare2 FROM tblPoA " & _
           "WHERE TransactionID = " & CLng(szTransactionID) & ";"

   adoRST.Open szStr, adoConn, adOpenStatic, adLockReadOnly

   SagePostingNumberPoA = adoRST.Fields.Item("spare2").Value

   adoRST.Close
   Set adoRST = Nothing
End Function

Private Sub SavePostingNumberPoA(tlbName As String, tblFieldName As String, lDemandID, lSPN As Long, adoConn As ADODB.Connection)
   Dim SQLStr As String

   If VarType(lDemandID) = vbString Then
      SQLStr = "UPDATE " & tlbName & " " & _
               "SET spare2 = " & lSPN & " " & _
               "WHERE UpDateSage = FALSE AND " & _
                     "" & tblFieldName & " = '" & lDemandID & "';"
   Else
      SQLStr = "UPDATE " & tlbName & " " & _
               "SET spare2 = " & lSPN & " " & _
               "WHERE UpDateSage = FALSE AND " & _
                     "" & tblFieldName & " = " & lDemandID & ";"
   End If
'Debug.Print SQLStr
   adoConn.Execute SQLStr
End Sub

Private Sub cmdSPClose_Click()
   Unload Me
End Sub

Private Sub Form_Unload(Cancel As Integer)
'   Call WheelUnHook(Me.hWnd)

   Dim X As Integer
   UnLoadForm Me
   Unload frmAdiComment

'   If DemandLock = I_Locked_It Then
'      Dim adoConn As New ADODB.Connection
'      adoConn.Open getConnectionString
'      'Resolved By BOSL. Date: 19 apr 2015
'      'Issue No: 0000506
'      'Modified by Anol.Validate whether szLastIDClicked has a numeric value before converting it to Long.
'      If IsNumeric(szLastIDClicked) = True Then
'            ReleaseLockedRecord adoConn, "DemandRecords", "DemandID", "LONG", , CLng(szLastIDClicked)
'      End If
'
'      adoConn.Close
'      Set adoConn = Nothing
'   End If
    Dim adoConn As New ADODB.Connection
    adoConn.Open getConnectionString
    adoConn.Execute "Update tlbReceipt Set  DateTimeStamp='',Module='',UserSessionID='',WindowsUserName='',MachineName=''," & _
         "PrestigeUserName='',ServerIPaddress='' where UserSessionID='" & UserSessionID & "'" ' AND Module='Demand Receipt'"
    adoConn.Close
    Set adoConn = Nothing
    'If Cancel = 0 Then frmMMain.fraCmdButton.Enabled = True
    
    If BANK_PAYMENT_HISTORY_LOADED Then
        BANK_PAYMENT_HISTORY_LOADED = False
        Unload frmBankPaymentHistory
    End If
    If BATCH_DEMAND_PROCESS Then
        BATCH_DEMAND_PROCESS = False
        Unload frmBatchDemands
    End If
   
End Sub

Private Sub fraCreateManualDemand_MouseMove(Button As Integer, Shift As Integer, X As Single, Y As Single)
  ' fraCreateManualDemand.MousePointer = vbArrow
End Sub

Private Sub fraEditDemand_MouseMove(Button As Integer, Shift As Integer, X As Single, Y As Single)
  Me.MousePointer = vbArrow
'
'   If fraInvCrChoice.Visible Then fraInvCrChoice.Visible = False
End Sub

Private Sub fraGenerateDemands_MouseMove(Button As Integer, Shift As Integer, X As Single, Y As Single)
  Me.MousePointer = vbArrow
'
'   If fraInvCrChoice.Visible Then fraInvCrChoice.Visible = False
End Sub

Private Sub fraInvCrChoice_MouseMove(Button As Integer, Shift As Integer, X As Single, Y As Single)
  ' fraInvCrChoice.MousePointer = vbArrow
End Sub

Private Sub fraPrint_MouseMove(Button As Integer, Shift As Integer, X As Single, Y As Single)
  Me.MousePointer = vbArrow
End Sub

Private Sub Label20_Click(Index As Integer)
   If Index < 3 Then                         'Sorting the leasse
      If Index = 0 Then                               ' Sort Tenant ID
         SortingGrid flxLeaseList, Index + 1, bSortingCol1
         bSortingCol1 = IIf(bSortingCol1, False, True)
         Label20(0).FontBold = True
         Label20(1).FontBold = False
         Label20(2).FontBold = False
      End If

      If Index = 1 Then                               ' Sort Tenant Name
         SortingGrid flxLeaseList, Index + 1, bSortingCol2
         bSortingCol2 = IIf(bSortingCol2, False, True)
         Label20(0).FontBold = False
         Label20(1).FontBold = True
         Label20(2).FontBold = False
      End If

      If Index = 2 Then                               ' Sort Unit Name
         SortingGrid flxLeaseList, Index + 1, bSortingCol3
         bSortingCol3 = IIf(bSortingCol3, False, True)
         Label20(0).FontBold = False
         Label20(1).FontBold = False
         Label20(2).FontBold = True
      End If
   End If
End Sub

Private Sub Label44_Click(Index As Integer)
       If Index >= 2 And Index <= 8 And Index <> 7 Then
      SortingGrid flxDemands, Index, bSortingCol(Index)

      bSortingCol(Index) = IIf(bSortingCol(Index), False, True)

      LblSortingClicked Index, Label44, 2, 8
   End If
End Sub

Private Sub lblPostingDate_DblClick(Cancel As MSForms.ReturnBoolean)
   If Not cmdaddnewline.Enabled Then Exit Sub
   If Trim(txtDmdClientList.text) = "" Then
      ShowMsgInTaskBar "Please select a client", "Y"
      Exit Sub
   End If
   If Trim(txtIssueDate.text) <> "" Then DispayCalendar Me, lblPostingDate.ToolTipText, txtIssueDate.text, txtDmdClientList.text
End Sub

Private Sub lblRptPostingDate_DblClick(Cancel As MSForms.ReturnBoolean)
   'Modified by BOSL
    'issue 468
    'Modified by anol 01 Sep 2014
'    If txtIssueDate.text <> "" Then
'        If TextBoxFormatDate(txtIssueDate) Then
'             If frmMMain.IsRibbonVersion And lblRptPostingDate.ToolTipText <> "" Then
'                Dim adoConn As New ADODB.Connection
'                Dim szSQL As String
'                adoConn.Open getConnectionString
'                If cboClient.Value = Null Then Exit Sub
'                If IsPeriodStatus(lblRptPostingDate.ToolTipText, txtRptClientList.text, adoConn) = 0 Then
'                    ShowMsgInTaskBar "The posting date cannot fall within a closed financial period", "Y", "N"
'                    adoConn.Close
'                    Exit Sub
'                ElseIf IsPeriodStatus(lblRptPostingDate.ToolTipText, txtRptClientList.text, adoConn) = 9 Then
'                    ShowMsgInTaskBar "The posting date does not fall in any existing financial period", "Y", "N"
'                    adoConn.Close
'                    Exit Sub
'                End If
'             End If
'            'End of modification
'        End If
'    End If

    If IsDate(lblRptPostingDate.ToolTipText) = False Or Len(txtSPDate.text) <> 10 Then Exit Sub
    DispayCalendar Me, lblRptPostingDate.ToolTipText, txtSPDate.text, txtRptClientList.text
End Sub

Private Sub Picture1_MouseMove(Index As Integer, Button As Integer, Shift As Integer, X As Single, Y As Single)
   'Picture1(Index).MousePointer = vbArrow
End Sub

Private Sub tabDmdRcpt_KeyPress(KeyAscii As Integer)
   If KeyAscii = 27 Then Unload Me
End Sub

Private Sub tabDmdRcpt_MouseMove(Button As Integer, Shift As Integer, X As Single, Y As Single)
    Me.MousePointer = vbArrow
End Sub

Private Sub tabPayment_Click(PreviousTab As Integer)
   Dim adoConn As New ADODB.Connection
'   Dim iRow As Integer
   If tabPayment.Tab = 0 And tabDmdRcpt.Tab = 2 Then
        If cmdRptClientList.Enabled = True Then
            cmdRptClientList.SetFocus
        End If
   End If
'   If tabPayment.Tab = 1 Then                      'TENANT RECEIPT HISTORY
'      txtDateTo1.text = Format(Now, "dd/mm/yyyy")
'      cmdRptClientList1.SetFocus
'   End If
   If tabDmdRcpt.Tab = 2 And tabPayment.Tab = 1 Then
        adoConn.Open getConnectionString
        Call loadfirstclient(adoConn)  ' to  control txtRptClientList1-> demand receipt history
        loadflxReceiptHistory adoConn, ""
        adoConn.Close
   End If
        
End Sub

Private Function PartString(szString As String, iStringPartNum As Integer, szDelemeter As String) As String
   Dim szaString() As String

   szaString = Split(szString, szDelemeter)
   PartString = szaString(iStringPartNum)
End Function

Private Function CheckPoACrNt(adoConn As ADODB.Connection, ByRef szaPoACrNt() As String) As Boolean
   Dim szSQL As String
   Dim adoRST As New ADODB.Recordset

   szSQL = "SELECT POACR.SAN " & _
           "FROM LEASEDETAILS AS LD LEFT JOIN " & _
                 "[SELECT DISTINCT RPT.SageAccountNumber AS SAN " & _
                  "FROM tlbReceipt as RPT " & _
                  "WHERE RPT.ReceiptView = True AND RPT.Type = 2 AND " & _
                       "ROUND(RPT.OSAMOUNT, 2) > 0 " & _
                  "Union " & _
                  "SELECT DISTINCT POA.SageAccountNumber AS SAN " & _
                  "FROM tblPoA AS POA " & _
                  "WHERE POA.PoAView = True And POA.Type = 4 AND " & _
                       "POA.OSALLOCATION > 0]. AS POACR ON LD.SageAccountNumber = POACR.SAN "
   szSQL = szSQL & _
           "WHERE LD.InterestChargeable='Y' AND " & _
               "LD.ServiceChargeDept='AUTO' AND " & _
           "(LD.LEASEID IN (SELECT LD.LeaseID " & _
                          "FROM LeaseDetails AS LD, LRentCharges AS LRC, GlobalData AS GD, Units AS U " & _
                          "WHERE LD.BRPayable = 'Y' AND " & _
                           "LRC.LeaseID = LD.LeaseID AND " & _
                           "DATEDIFF('d',DATE(),IIF(ISNULL(LRC.BRNextDueDate),DATEADD('d',-1,Date()),LRC.BRNextDueDate))>=0 AND " & _
                           "DATEDIFF('d',Date(),IIF(ISNULL(LRC.BRNextDueDate), DATEADD('d',-1,Date()),LRC.BRNextDueDate))<=VAL(GD.NoOfDaysToSendDemandsB4Due) AND " & _
                           "LD.UnitNumber=U.UnitNumber AND " & _
                           "U.PropertyID=GD.PropertyID) " & _
           "OR "
   szSQL = szSQL & _
           "LD.LEASEID IN (SELECT LD.LeaseID " & _
                         "FROM LeaseDetails AS LD, LServiceCharges AS LSC, GlobalData AS GD, Units AS U " & _
                         "WHERE LD.BRPayable = 'Y' AND " & _
                           "LSC.LeaseID = LD.LeaseID AND " & _
                           "DATEDIFF('d',DATE(),IIF(ISNULL(LSC.SCNextDueDate),DATEADD('d',-1,Date()),LSC.SCNextDueDate))>=0 AND " & _
                           "DATEDIFF('d',DATE(),IIF(ISNULL(LSC.SCNextDueDate),DATEADD('d',-1,Date()),LSC.SCNextDueDate))<=VAL(GD.NoOfDaysToSendDemandsB4Due) AND " & _
                           "LD.UnitNumber=U.UnitNumber AND " & _
                           "U.PropertyID=GD.PropertyID) " & _
           "OR "
   szSQL = szSQL & _
           "LD.LEASEID IN (SELECT LD.LeaseID " & _
                         "FROM LeaseDetails AS LD, LInsuranceCharges AS LINS, GlobalData AS GD, Units AS U " & _
                         "WHERE LD.BRPayable = 'Y' AND " & _
                           "LINS.LeaseID = LD.LeaseID AND " & _
                           "DATEDIFF('d',DATE(),IIF(ISNULL(LINS.InsuranceNextDueDate),DATEADD('d',-1,Date()),LINS.InsuranceNextDueDate))>=0 AND " & _
                           "DATEDIFF('d',DATE(),IIF(ISNULL(LINS.InsuranceNextDueDate),DATEADD('d',-1,Date()),LINS.InsuranceNextDueDate))<=VAL(GD.NoOfDaysToSendDemandsB4Due) AND " & _
                           "LD.UnitNumber=U.UnitNumber AND " & _
                           "U.PropertyID=GD.PropertyID));"
'Debug.Print szSQL

   adoRST.Open szSQL, adoConn, adOpenStatic, adLockReadOnly

   If adoRST.EOF Then
      CheckPoACrNt = True
   Else
      Dim i As Integer
      ReDim szaPoACrNt(adoRST.RecordCount) As String

      While Not adoRST.EOF
         szaPoACrNt(i) = adoRST!SAN
         i = i + 1
         adoRST.MoveNext
      Wend

      CheckPoACrNt = False
   End If

   adoRST.Close
   Set adoRST = Nothing
End Function

Private Function CalAutoInterest(ByVal sIntRate As Single, ByVal iDays As Integer, ByVal szUnitNum As String, ByVal szSAN As String, adoConn As ADODB.Connection, ByRef cTotalAmt As Currency, ByRef sDaysCalculated) As Currency
   Dim szSQL As String, dtStartDt As Date, iLoop As Integer, szaIntRate() As String
   Dim iNumOfdays As Integer
   Dim adoRST As New ADODB.Recordset, adoInt As New ADODB.Recordset

   szSQL = "SELECT TransactionID, DDate, OSAmount, IntCalDate " & _
           "FROM tlbReceipt " & _
           "WHERE ReceiptView = TRUE AND " & _
               "(DATEDIFF('D',DDate,DATE())-1)>= " & iDays & " AND Type = 1 AND " & _
               "SageAccountNumber = '" & szSAN & "';"
'Debug.Print szSQL
   adoRST.Open szSQL, adoConn, adOpenDynamic, adLockOptimistic

   szSQL = "SELECT InterestRates.BaseRate, InterestRates.AdditionalRate, " & _
               "InterestRates.DateFrom " & _
           "FROM InterestRates, Units " & _
           "WHERE Units.UnitNumber = '" & szUnitNum & "' AND " & _
               "Units.PropertyID = InterestRates.PropertyID AND " & _
               "InterestRates.Active = TRUE " & _
           "ORDER BY RateID;"
   adoInt.Open szSQL, adoConn, adOpenStatic, adLockReadOnly

   ReDim szaIntRate(adoInt.RecordCount, 1) As String

   While Not adoInt.EOF
      szaIntRate(iLoop, 0) = Format(adoInt!dateFrom, "dd/mmmm/yyyy")
      szaIntRate(iLoop, 1) = CStr(CCur(adoInt!BaseRate) + IIf(sIntRate = 0, CCur(adoInt!AdditionalRate), sIntRate))
      iLoop = iLoop + 1
      adoInt.MoveNext
   Wend
   szaIntRate(iLoop, 0) = Format(Date, "dd/mmmm/yyyy")
   adoInt.MoveFirst
   iLoop = 0

   CalAutoInterest = 0
   cTotalAmt = 0
   sDaysCalculated = 0

   While Not adoRST.EOF
      If adoRST!IntCalDate = "" Or IsNull(adoRST!IntCalDate) Then            'NO INT HAS BEEN CALCULATED BEFORE
         dtStartDt = IIf(DateDiff("d", CDate(adoRST!dDate), CDate(adoInt!dateFrom)) >= 0, CDate(adoInt!dateFrom), CDate(adoRST!dDate))
         For iLoop = 1 To adoInt.RecordCount
            iNumOfdays = DateDiff("d", dtStartDt, szaIntRate(iLoop, 0))
            If iNumOfdays >= 0 Then
               CalAutoInterest = CalAutoInterest + RoundingNumber(CCur(adoRST!OSAmount), 2) * (szaIntRate(iLoop - 1, 1) / 100) * (iNumOfdays - 1) / 365
               dtStartDt = CDate(szaIntRate(iLoop, 0))
               cTotalAmt = cTotalAmt + RoundingNumber(CCur(adoRST!OSAmount), 2)
               sDaysCalculated = sDaysCalculated + iNumOfdays
            End If
         Next iLoop
      Else
         dtStartDt = CDate(adoRST!IntCalDate)
         For iLoop = 1 To adoInt.RecordCount
            iNumOfdays = DateDiff("d", dtStartDt, szaIntRate(iLoop, 0))
            If iNumOfdays >= 0 Then
               CalAutoInterest = CalAutoInterest + RoundingNumber(CCur(adoRST!OSAmount), 2) * (szaIntRate(iLoop - 1, 1) / 100) * (iNumOfdays - 1) / 365
               dtStartDt = CDate(szaIntRate(iLoop, 0))
               cTotalAmt = cTotalAmt + RoundingNumber(CCur(adoRST!OSAmount), 2)
               sDaysCalculated = sDaysCalculated + iNumOfdays
            End If
         Next iLoop
      End If

      adoRST!IntCalDate = Format(Date, "dd/mmmm/yyyy")
      adoRST.Update
      adoRST.MoveNext
   Wend

   adoRST.Close
   Set adoRST = Nothing
End Function

Public Sub GenAutoConDemands(adoConn As ADODB.Connection)
   Dim szaNCode()    As String
   Dim szaNCName()   As String
   Dim szaPrefix()   As String
   Dim szaTemp()     As String
   Dim szaLessee()   As String
   Dim szDes         As String
   Dim CutOffDate    As String
   Dim szSQLStr      As String
   
   Dim szaPartofYear() As Integer ' This variable shall hold part of the year from recordset so that you need to go to the database for  once
   Dim SQLStr1 As String
   Dim adoRST As New ADODB.Recordset

   Dim BRcount    As Integer
   Dim SCcount    As Integer
   Dim SCYRCount  As Integer
   Dim IPcount    As Integer
   Dim ICcount    As Integer
   Dim UUcount    As Integer
   Dim iProp      As Integer
   Dim iSerial    As Integer
   Dim lBatch     As Long
   Dim lDemand    As Long
   Dim iChildId   As Integer
   Dim bProceed   As Boolean
   Dim DaysB4Due  As Integer
   Dim bRC        As Boolean
   Dim bINS       As Boolean
   Dim bSC        As Boolean
   Dim bPRRC      As Boolean     'PR - Pro-rata
   Dim bPRINS     As Boolean
   Dim bPRSC      As Boolean
   Dim bUTL       As Boolean
   Dim dtFDD      As Date
   Dim iDT        As Integer

   Dim dtNtDueDate      As Date
   Dim laBankID(4, 1)   As String
   Dim dtDueDate        As Date


   Dim adoRstDemandRec     As ADODB.Recordset
   Dim adoRstDT            As ADODB.Recordset
   Dim adoRstDmdTyp        As ADODB.Recordset
   Dim adoRstLeaseDtl      As ADODB.Recordset
   Dim adoRstSplitDemand   As ADODB.Recordset
   Dim adoRstRC            As ADODB.Recordset
   Dim adoRstSC            As ADODB.Recordset
   Dim adoRstIns           As ADODB.Recordset
   Dim adoPRRstRC          As ADODB.Recordset
   Dim adoPRRstSC          As ADODB.Recordset
   Dim adoPRRstIns         As ADODB.Recordset
   Dim adoRstUC            As ADODB.Recordset
   Dim i As Integer
   ReDim lArrDemand(0) As Long

   If MsgBox("  Are you sure you wish to generate automatic demands?" & (Chr(13) + Chr(10)) & _
             "Please ensure your global data has been correctly inputted.", vbYesNo + vbQuestion, _
             "Generate Automatic Demands") = vbNo Then Exit Sub

   Call RentReview(adoConn)
 

'   MousePointer = vbHourglass    'change the mouse cursor to show program is working

   SQLStr1 = "SELECT ID,PARTOFYEAR  FROM FREQUENCIES  Order By ID "
   adoRST.Open SQLStr1, adoConn, adOpenStatic, adLockReadOnly
   ReDim szaPartofYear(RecordCount(adoRST)) As Integer
   While Not adoRST.EOF
        i = i + 1
        szaPartofYear(i) = adoRST("PARTOFYEAR").Value
        adoRST.MoveNext
   Wend
   adoRST.Close
   i = 0
   Set adoRstDemandRec = New ADODB.Recordset
   szSQLStr = "SELECT COUNT(LeaseDetails.LeaseID) as TOTAL_LEASE " & _
              "FROM LeaseDetails " & _
              "WHERE LeaseDetails.Status = TRUE"
   adoRstDemandRec.Open szSQLStr, adoConn, adOpenDynamic, adLockPessimistic
   If Val(adoRstDemandRec!TOTAL_LEASE) > 0 Then ReDim SZALEASEE(Val(adoRstDemandRec!TOTAL_LEASE) - 1) As String
   adoRstDemandRec.Close
'   Set adoRstDemandRec = Nothing

'   Connect to Demands table to add new demands.
   szSQLStr = "SELECT * FROM DemandRecords"
   adoRstDemandRec.Open szSQLStr, adoConn, adOpenDynamic, adLockPessimistic

   Set adoRstSplitDemand = New ADODB.Recordset
   szSQLStr = "SELECT * FROM DemandSplitRecords"
   adoRstSplitDemand.Open szSQLStr, adoConn, adOpenDynamic, adLockPessimistic

'adoRstDemandRec.Close
'adoRstSplitDemand.Close
'GoTo xxxx

'   get nominal codes and prefix for base rent from demand types.
   Set adoRstDmdTyp = New ADODB.Recordset
   
   'Resolved By BOSL. Modified by Asif
   'Issue 0000476. The Control Account settings must be loaded from Configuration instead of the Demand Types.
   
   'szSQLStr = "SELECT * FROM DemandTypes;"
   
   Dim ClientID As String
   
   ClientID = frmDemandTypesSel.flxClients.TextMatrix(frmDemandTypesSel.flxClients.row, 1)
   
   If ClientID = "" Then
      MsgBox "No Client selected in the Automatic Demand Generation form", vbCritical, "DATA Input"

      adoRstSplitDemand.Close
      adoRstDemandRec.Close

      Set adoRstSplitDemand = Nothing
      Set adoRstDemandRec = Nothing
      Exit Sub
   End If
   
   szSQLStr = "SELECT DemandTypes.ID, DemandTypes.Type, DemandTypes.InvCrd, DemandTypes.Prefix, " & _
   "DemandTypes.NominalCodeforAmount, DemandTypes.NominalNameforAmount, " & _
   "(SELECT Code FROM NominalLedger WHERE ClientID = '" & ClientID & "' AND CAType = 'O') as NominalCodeforVAT, " & _
   "(SELECT Name FROM NominalLedger WHERE ClientID = '" & ClientID & "' AND CAType = 'O') as NominalNameforVAT, " & _
   "(SELECT Code FROM NominalLedger WHERE ClientID = '" & ClientID & "' AND CAType = 'S') as NominalCodeforTotal, " & _
   "(SELECT Name FROM NominalLedger WHERE ClientID = '" & ClientID & "' AND CAType = 'S') as NominalNameforTotal, " & _
   "DemandTypes.TransactionType, DemandTypes.CategoryCode, DemandTypes.PaymentDates, " & _
   "DemandTypes.spare1, DemandTypes.spare2, DemandTypes.spare3, DemandTypes.spare4, DemandTypes.spare5, " & _
   "DemandTypes.DTGroup, DemandTypes.DemandReportName, DemandTypes.PropertyID, " & _
   "DemandTypes.EmailInvoiceTemplate , DemandTypes.ULC, DemandTypes.StatementTemplate " & _
   "FROM DemandTypes;"
   'End of Modification
   
   adoRstDmdTyp.Open szSQLStr, adoConn, adOpenStatic, adLockReadOnly

   If adoRstDmdTyp.EOF Then
      MsgBox "There are no Demand Type in the database", vbCritical, "DATA Input Error"

      adoRstSplitDemand.Close
      adoRstDemandRec.Close
      adoRstDmdTyp.Close

      Set adoRstSplitDemand = Nothing
      Set adoRstDemandRec = Nothing
      Set adoRstDmdTyp = Nothing
      Exit Sub
   End If

   Set adoRstDT = New ADODB.Recordset
   szSQLStr = "SELECT MAX(ID) FROM DemandTypes;"
   adoRstDT.Open szSQLStr, adoConn, adOpenStatic, adLockReadOnly
   iDT = adoRstDT.Fields.Item(0).Value
   adoRstDT.Close
   Set adoRstDT = Nothing

   ReDim szaPrefix(iDT) As String
   ReDim szaNCName(iDT) As String
   ReDim szaNCode(iDT) As String

'**Saving all Nominal Codes and Prefixes in the array
   While Not adoRstDmdTyp.EOF
      szaPrefix(adoRstDmdTyp!Id) = adoRstDmdTyp!prefix
      szaNCName(adoRstDmdTyp!Id) = adoRstDmdTyp!NominalNameforAmount & " # " & adoRstDmdTyp!NominalNameforVAT & " # " & adoRstDmdTyp!NominalNameforTotal
      szaNCode(adoRstDmdTyp!Id) = adoRstDmdTyp!NominalCodeforAmount & " # " & adoRstDmdTyp!NominalCodeForVAT & " # " & adoRstDmdTyp!NominalCodeForTotal
      adoRstDmdTyp.MoveNext
   Wend
   adoRstDmdTyp.Close
   Set adoRstDmdTyp = Nothing

'****************************************************************************************************************************
'  If there any interest needed to be calculated, then need to check is there any unallocated PoA &
'  CrNt. If there any unallocated PoA & CrNt then system will show a warning messege. If user wants to
'  run ignoring those lessees then system will continue without calculating interest, otherwise system
'  will stop processing any demands.

   Dim szaPoACrNt() As String, szPoACrNt As String
  ' Dim i As Integer

   If Not CheckPoACrNt(adoConn, szaPoACrNt) Then
      szPoACrNt = Join(szaPoACrNt, ", ")
      szPoACrNt = MsgBox("There are unallocated payments on account and credit notes against " & Chr(10) & _
                     "following lessees on which Interest is due. " & szPoACrNt & ". " & Chr(10) & _
                     "Do you wish to continue without generating interest for these lessees?", vbInformation + vbQuestion + vbYesNo, "Generate Interest")

      If Val(szPoACrNt) = 7 Then Exit Sub
   End If
'****************************************************************************************************************************

   Set adoRstLeaseDtl = New ADODB.Recordset

'   If frmDemandTypesSel.chkProp.Value = 1 Then
'      szSQLStr = "SELECT LeaseDetails.*, Units.PropertyID " & _
'                 "FROM LeaseDetails, Units " & _
'                 "WHERE LeaseDetails.Status = TRUE AND " & _
'                     "(OLED = TRUE OR DATEDIFF('D', NOW, ENDDATE) >= 0) AND " & _
'                     "LeaseDetails.UnitNumber = Units.UnitNumber;"
'   Else
   i = 0

   For iProp = 1 To frmDemandTypesSel.flxProperties.Rows - 1
      If frmDemandTypesSel.flxProperties.TextMatrix(iProp, 0) = "X" Then ' lstProperties.Selected(iProp) Then
         i = i + 1
         szDes = szDes & "Units.PropertyID = '" & frmDemandTypesSel.flxProperties.TextMatrix(iProp, 1) & "'"
         If i < frmDemandTypesSel.iSelProperties Then szDes = szDes & " OR "
      End If
   Next iProp

   szSQLStr = "SELECT LeaseDetails.*, Units.PropertyID, Tenants.EmailDmd, NoOfDaysToSendDemandsB4Due " & _
              "FROM LeaseDetails, Units, Tenants, GlobalData " & _
              "WHERE LeaseDetails.Status = TRUE AND " & _
                  "Units.PropertyID = GlobalData.PropertyID AND " & _
                  "LeaseDetails.SageAccountNumber = Tenants.SageAccountNumber AND " & _
                  "LeaseDetails.UnitNumber = Units.UnitNumber And "
   szSQLStr = szSQLStr & "(" & szDes & ")"
'Debug.Print szSQLStr
   szDes = ""
'   End If
   adoRstLeaseDtl.Open szSQLStr, adoConn, adOpenDynamic, adLockPessimistic

   iSerial = 1
   lBatch = NextRef(adoConn, "BATCH_REF")
   If adoRstLeaseDtl.EOF Then
      adoRstLeaseDtl.Close
      Set adoRstLeaseDtl = Nothing
   Else
      While Not adoRstLeaseDtl.EOF

'*********************** SAMRAT 25/11/2005 ***************************************
'*** Determin the date boundray in future, in this boundary
'*** we have to find those demands' due date to calcuate
'*** demands from lease table and we have to calculate &
'*** collect all those demands in DemandRecords table.
'*********************************************************************************
         DaysB4Due = adoRstLeaseDtl!NoOfDaysToSendDemandsB4Due ' GlbDaysBeforeDue(adoRstLeaseDtl.Fields("LeaseID").Value, adoConn)
         CutOffDate = DateAdd("d", DaysB4Due, Date)
'*********************************************************************************************************
         bRC = False          'RENT CHARGE
'*********************************************************************************************************
'         Finding out is there any Rent Charges to generate
         szSQLStr = "SELECT R.RentCharges, R.LeaseID, R.RentChargeDept, R.BRFrequency, " & _
                        "R.BRStartDate, R.BRNextDueDate, R.BRTotal, " & _
                        "R.BRAmount, R.spare2, " & _
                        "R.BRDemandType, R.RentDesc, " & _
                        "Units.PropertyID, DemandTypes.Spare1 as DemandTypeBankID, " & _
                        "Frequencies.CalDays, StopRC, R.spare1 AS ChargingMethod " & _
                    "FROM LRentCharges AS R, LeaseDetails AS L, Units, DemandTypes, Frequencies "

         If frmDemandTypesSel.cboGDPFreq.Column(0) = 0 Then

            szSQLStr = szSQLStr & _
                        "WHERE R.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                            "R.LeaseID = L.LeaseID AND (R.StopAutoDmd = FALSE OR L.GPrataDmd =FALSE OR " & _
                            "(R.StopAutoDmd = TRUE AND L.EndDate >= CDATE(R.FDD))) AND " & _
                            "L.UnitNumber = Units.UnitNumber AND " & _
                            "R.BRTotal > 0 AND (ISNULL(R.spare3) OR R.spare3 <> 'DELETED') AND " & _
                            "R.BRDemandType = DemandTypes.ID AND " & _
                            "R.BRFrequency = Frequencies.ID AND L.Status;"
                            
         Else

             szSQLStr = szSQLStr & _
                        "WHERE R.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                            "R.LeaseID = L.LeaseID AND (R.StopAutoDmd = FALSE OR L.GPrataDmd =FALSE OR " & _
                            "(R.StopAutoDmd = TRUE AND L.EndDate >= CDATE(R.FDD))) AND " & _
                            "L.UnitNumber = Units.UnitNumber AND " & _
                            "R.BRTotal > 0 AND (ISNULL(R.spare3) OR R.spare3 <> 'DELETED') AND " & _
                            "R.BRDemandType = DemandTypes.ID AND " & _
                            "R.BRFrequency = Frequencies.ID AND " & _
                            "Frequencies.ID = " & frmDemandTypesSel.cboGDPFreq.Column(0) & " AND L.Status;"
         End If
'Debug.Print szSQLStr
         Set adoRstRC = New ADODB.Recordset
         adoRstRC.Open szSQLStr, adoConn, adOpenDynamic, adLockPessimistic

         While Not adoRstRC.EOF
            If IsNull(adoRstRC!StopRC) Or adoRstRC!StopRC = "" Then
               bProceed = True
            Else
               bProceed = IIf(DateDiff("d", adoRstRC!BRNextDueDate, CDate(adoRstRC!StopRC)) > 0, True, False)
            End If

            If adoRstLeaseDtl!BRPayable = "Y" And _
                  DateDiff("d", Date, IIf(adoRstRC!BRNextDueDate = "", _
                  DateAdd("d", -1, Date), adoRstRC!BRNextDueDate)) <= DaysB4Due And bProceed And _
                  IsDmdTypeSel(adoRstRC.Fields("BRDemandType").Value) And _
                  IIf(adoRstLeaseDtl!OLED, True, adoRstLeaseDtl!EndDate > adoRstRC!BRNextDueDate) Then

               bRC = True
               adoRstRC.MoveLast
            End If

            adoRstRC.MoveNext
         Wend
         If bRC Then adoRstRC.MoveFirst
'*********************************************************************************************************
         bPRRC = False          '         Rent Charges Demands        ---->  PRO-RATA                                                    '
'*********************************************************************************************************
         szSQLStr = "SELECT R.RentCharges, R.LeaseID, R.RentChargeDept, R.BRFrequency, " & _
                        "R.BRStartDate, R.BRNextDueDate, R.BRTotal, " & _
                        "R.BRAmount, R.spare2, " & _
                        "R.BRDemandType, R.RentDesc,R.FDD, " & _
                        "Units.PropertyID, DemandTypes.Spare1 as DemandTypeBankID, " & _
                        "Frequencies.CalDays,Frequencies.ID, StopRC, R.spare1 AS ChargingMethod,Frequencies.ID " & _
                    "FROM LRentCharges AS R, LeaseDetails AS L, Units, DemandTypes, Frequencies "

         If frmDemandTypesSel.cboGDPFreq.Column(0) = 0 Then

              szSQLStr = szSQLStr & _
                        "WHERE R.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                            "L.GPrataDmd = TRUE AND " & _
                            "R.LeaseID = L.LeaseID AND R.StopAutoDmd = TRUE AND " & _
                            "L.EndDate < CDATE(R.FDD) AND " & _
                            "L.UnitNumber = Units.UnitNumber AND " & _
                            "R.BRTotal > 0 AND (ISNULL(R.spare3) OR R.spare3 <> 'DELETED') AND " & _
                            "R.BRDemandType = DemandTypes.ID AND " & _
                            "R.BRFrequency = Frequencies.ID AND L.Status;"
         Else
  
                             szSQLStr = szSQLStr & _
                        "WHERE R.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                            "L.GPrataDmd = TRUE AND " & _
                            "R.LeaseID = L.LeaseID AND R.StopAutoDmd = TRUE AND " & _
                            "L.EndDate < CDATE(R.FDD) AND " & _
                            "L.UnitNumber = Units.UnitNumber AND " & _
                            "R.BRTotal > 0 AND (ISNULL(R.spare3) OR R.spare3 <> 'DELETED') AND " & _
                            "R.BRDemandType = DemandTypes.ID AND " & _
                            "R.BRFrequency = Frequencies.ID AND " & _
                            "Frequencies.ID = " & frmDemandTypesSel.cboGDPFreq.Column(0) & " AND L.Status;"
         End If
'If adoRstLeaseDtl!LeaseID = "01100303170211771318" Then
'Debug.Print szSQLStr
'End If
         Set adoPRRstRC = New ADODB.Recordset
         adoPRRstRC.Open szSQLStr, adoConn, adOpenDynamic, adLockPessimistic

         While Not adoPRRstRC.EOF
            If IsNull(adoPRRstRC!StopRC) Or adoPRRstRC!StopRC = "" Then
               bProceed = True
            Else
               bProceed = IIf(DateDiff("d", adoPRRstRC!BRNextDueDate, CDate(adoPRRstRC!StopRC)) > 0, True, False)
            End If

            If adoRstLeaseDtl!BRPayable = "Y" And _
               DateDiff("d", Date, IIf(adoPRRstRC!BRNextDueDate = "", _
                  DateAdd("d", -1, Date), adoPRRstRC!BRNextDueDate)) <= DaysB4Due And bProceed Then
'Debug.Print szSQLStr
               bPRRC = True
               adoPRRstRC.MoveLast
            End If

            adoPRRstRC.MoveNext
         Wend
         If bPRRC Then adoPRRstRC.MoveFirst
'*********************************************************************************************************
         bSC = False                'SERVICE CHARGE
'*********************************************************************************************************
'         Finding out is there any Service Charges to generate
         szSQLStr = "SELECT S.ServiceCharge, S.LeaseID, " & _
                        "S.SCFrequency, S.SCPayableFrom, " & _
                        "S.SCNextDueDate, S.ChargingMethod, " & _
                        "S.CMFigure, S.SCTotal, S.SCAmount, " & _
                        "S.SCTOLimit, S.SCDemandType, StopSC, " & _
                        "S.ServiceChargeDept, S.SCDesc, S.CMFigure, " & _
                        "Units.PropertyID, DemandTypes.Spare1 as DemandTypeBankID, Frequencies.CalDays " & _
                    "FROM LServiceCharges AS S, LeaseDetails, Units, DemandTypes, Frequencies "

         If frmDemandTypesSel.cboGDPFreq.Column(0) = 0 Then
           szSQLStr = szSQLStr & _
                    "WHERE S.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                        "S.LeaseID = LeaseDetails.LeaseID AND (S.StopAutoDmd = FALSE OR LeaseDetails.GPrataDmd =FALSE OR " & _
                        "(S.StopAutoDmd = TRUE AND LeaseDetails.EndDate  >=  CDATE(S.FDD))) AND " & _
                        "S.SCAmount > 0 AND LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
                        "(ISNULL(S.spare3) OR S.spare3 <> 'DELETED') AND " & _
                        "S.SCDemandType = DemandTypes.ID AND " & _
                        "S.SCFrequency = Frequencies.ID AND LeaseDetails.Status;"
         Else

            szSQLStr = szSQLStr & _
                    "WHERE S.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                        "S.LeaseID = LeaseDetails.LeaseID AND (S.StopAutoDmd = FALSE OR LeaseDetails.GPrataDmd =FALSE OR " & _
                        "(S.StopAutoDmd = TRUE AND LeaseDetails.EndDate  >=  CDATE(S.FDD))) AND " & _
                        "S.SCAmount > 0 AND LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
                        "(ISNULL(S.spare3) OR S.spare3 <> 'DELETED') AND " & _
                        "S.SCDemandType = DemandTypes.ID AND " & _
                        "S.SCFrequency = Frequencies.ID AND " & _
                        "Frequencies.ID = " & frmDemandTypesSel.cboGDPFreq.Column(0) & " AND LeaseDetails.Status;"
                        
         End If

         Set adoRstSC = New ADODB.Recordset
         adoRstSC.Open szSQLStr, adoConn, adOpenDynamic, adLockPessimistic
         While Not adoRstSC.EOF
            If IsNull(adoRstSC!StopSC) Or adoRstSC!StopSC = "" Then
               bProceed = True
            Else
               bProceed = IIf(DateDiff("d", adoRstSC!SCNextDueDate, CDate(adoRstSC!StopSC)) > 0, True, False)
            End If
            If adoRstLeaseDtl!SCPayable = "Y" And _
               DateDiff("d", Date, IIf(adoRstSC!SCNextDueDate = "", _
                  DateAdd("d", -1, Date), adoRstSC!SCNextDueDate)) <= DaysB4Due And bProceed And _
                     IsDmdTypeSel(adoRstSC.Fields("SCDemandType").Value) And _
               IIf(adoRstLeaseDtl!OLED, True, adoRstLeaseDtl!EndDate > adoRstSC!SCNextDueDate) Then

               bSC = True
               adoRstSC.MoveLast
            End If
            adoRstSC.MoveNext
         Wend
         If bSC Then adoRstSC.MoveFirst
'************************************************************************************************
         bPRSC = False                '   Service Charge demands       ---->    PRO-RATA
'************************************************************************************************
         szSQLStr = "SELECT S.ServiceCharge, S.LeaseID, " & _
                        "S.SCFrequency, S.SCPayableFrom, " & _
                        "S.SCNextDueDate, S.ChargingMethod, " & _
                        "S.CMFigure, S.SCTotal, S.SCAmount, " & _
                        "S.SCTOLimit, S.SCDemandType, StopSC,S.FDD, " & _
                        "S.ServiceChargeDept, S.SCDesc, S.CMFigure, " & _
                        "Units.PropertyID, DemandTypes.Spare1 as DemandTypeBankID, Frequencies.CalDays,Frequencies.ID " & _
                    "FROM LServiceCharges AS S, LeaseDetails, Units, DemandTypes, Frequencies "

         If frmDemandTypesSel.cboGDPFreq.Column(0) = 0 Then
'            szSQLStr = szSQLStr & _
'                    "WHERE S.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
'                        "LeaseDetails.GPrataDmd = TRUE AND S.GPD = FALSE AND " & _
'                        "S.LeaseID = LeaseDetails.LeaseID AND S.StopAutoDmd = TRUE AND " & _
'                        "LeaseDetails.EndDate >= CDATE(S.FDD) AND " & _
'                        "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
'                        "S.SCAmount > 0 AND (ISNULL(S.spare3) OR S.spare3 <> 'DELETED') AND " & _
'                        "S.SCDemandType = DemandTypes.ID AND " & _
'                        "S.SCFrequency = Frequencies.ID AND LeaseDetails.Status;"
 'issue 331 Modified by anol 20170314
 'AND S.GPD = FALSE I have removed this field from where clause before proper implementation is done. anol 2020-06-11
                szSQLStr = szSQLStr & _
                    "WHERE S.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                        "LeaseDetails.GPrataDmd = TRUE  AND " & _
                        "S.LeaseID = LeaseDetails.LeaseID AND S.StopAutoDmd = TRUE AND " & _
                        "S.SCAmount > 0 AND LeaseDetails.EndDate < CDATE(S.FDD) AND " & _
                        "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
                        "(ISNULL(S.spare3) OR S.spare3 <> 'DELETED') AND " & _
                        "S.SCDemandType = DemandTypes.ID AND " & _
                        "S.SCFrequency = Frequencies.ID AND LeaseDetails.Status;"
         Else
'            szSQLStr = szSQLStr & _
'                    "WHERE S.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
'                        "LeaseDetails.GPrataDmd = TRUE AND S.GPD = FALSE AND " & _
'                        "S.LeaseID = LeaseDetails.LeaseID AND S.StopAutoDmd = TRUE AND " & _
'                        "LeaseDetails.EndDate >= CDATE(S.FDD) AND " & _
'                        "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
'                        "S.SCAmount > 0 AND (ISNULL(S.spare3) OR S.spare3 <> 'DELETED') AND " & _
'                        "S.SCDemandType = DemandTypes.ID AND " & _
'                        "S.SCFrequency = Frequencies.ID AND " & _
'                        "Frequencies.ID = " & frmDemandTypesSel.cboGDPFreq.Column(0) & " AND LeaseDetails.Status;"
 'issue 331 Modified by anol 20170314
 'AND S.GPD = FALSE I have removed this field from where clause before proper implementation is done. anol 2020-06-11
                szSQLStr = szSQLStr & _
                    "WHERE S.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                        "LeaseDetails.GPrataDmd = TRUE AND " & _
                        "S.LeaseID = LeaseDetails.LeaseID AND S.StopAutoDmd = TRUE AND " & _
                        "S.SCAmount > 0 AND LeaseDetails.EndDate < CDATE(S.FDD) AND " & _
                        "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
                        "(ISNULL(S.spare3) OR S.spare3 <> 'DELETED') AND " & _
                        "S.SCDemandType = DemandTypes.ID AND " & _
                        "S.SCFrequency = Frequencies.ID AND " & _
                        "Frequencies.ID = " & frmDemandTypesSel.cboGDPFreq.Column(0) & " AND LeaseDetails.Status;"
         End If

         Set adoPRRstSC = New ADODB.Recordset
         adoPRRstSC.Open szSQLStr, adoConn, adOpenDynamic, adLockPessimistic

         While Not adoPRRstSC.EOF
            If IsNull(adoPRRstSC!StopSC) Or adoPRRstSC!StopSC = "" Then
               bProceed = True
            Else
               bProceed = IIf(DateDiff("d", adoPRRstSC!SCNextDueDate, CDate(adoPRRstSC!StopSC)) > 0, True, False)
            End If
            If adoRstLeaseDtl!SCPayable = "Y" And _
               DateDiff("d", Date, IIf(adoPRRstSC!SCNextDueDate = "", _
                  DateAdd("d", -1, Date), adoPRRstSC!SCNextDueDate)) <= DaysB4Due And bProceed Then

               bPRSC = True
               adoPRRstSC.MoveLast
            End If
            adoPRRstSC.MoveNext
         Wend

    Call WriteServiceChargeCons(adoConn, adoRstLeaseDtl, adoRstDemandRec, adoRstSplitDemand, DaysB4Due, laBankID, szaNCode, szaNCName, szaPartofYear, SCcount, SCYRCount)

         If bPRSC Then adoPRRstSC.MoveFirst
'*********************************************************************************************************
         bINS = False               'INSURANCE CHARGE
'*********************************************************************************************************
'         Finding out is there any Insurance Charges to generate
         szSQLStr = "SELECT I.InsCharges, I.LeaseID, " & _
                        "I.InsuranceStartDate, I.InsuranceFrequency, " & _
                        "I.InsuranceEndDate, I.InsuranceDemandType, " & _
                        "I.InsuranceEachPeriod, I.InsuranceNextDueDate, " & _
                        "I.ChargingType, " & _
                        "I.ChargingFigure, I.TotalYearlyInsurance, " & _
                        "I.InsuranceDept, I.InsDesc, " & _
                        "Units.PropertyID, DemandTypes.Spare1 as DemandTypeBankID, " & _
                        "Frequencies.CalDays, StopIC " & _
                    "FROM LInsuranceCharges AS I, LeaseDetails, Units, DemandTypes, Frequencies "

         If frmDemandTypesSel.cboGDPFreq.Column(0) = 0 Then
         'issue 331 Modified by anol 20170315
'            szSQLStr = szSQLStr & _
'                    "WHERE I.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
'                        "I.LeaseID = LeaseDetails.LeaseID AND (I.StopAutoDmd = FALSE OR " & _
'                        "(I.StopAutoDmd = TRUE AND LeaseDetails.EndDate < CDATE(I.FDD))) AND " & _
'                        "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
'                        "I.InsuranceEachPeriod > 0 AND (ISNULL(I.spare3) OR I.spare3 = '') AND " & _
'                        "I.InsuranceDemandType = DemandTypes.ID AND " & _
'                        "I.InsuranceFrequency = Frequencies.ID AND LeaseDetails.Status;"
        szSQLStr = szSQLStr & _
                    "WHERE I.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                        "I.LeaseID = LeaseDetails.LeaseID AND (I.StopAutoDmd = FALSE OR LeaseDetails.GPrataDmd =FALSE OR " & _
                        "(I.StopAutoDmd = TRUE AND LeaseDetails.EndDate < CDATE(I.FDD))) AND " & _
                        "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
                        "I.InsuranceEachPeriod > 0 AND (ISNULL(I.spare3) OR I.spare3 = '') AND " & _
                        "I.InsuranceDemandType = DemandTypes.ID AND " & _
                        "I.InsuranceFrequency = Frequencies.ID AND LeaseDetails.Status;"
         Else
         'issue 331 Modified by anol 20170315
'            szSQLStr = szSQLStr & _
'                    "WHERE I.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
'                        "I.LeaseID = LeaseDetails.LeaseID AND (I.StopAutoDmd = FALSE OR " & _
'                        "(I.StopAutoDmd = TRUE AND LeaseDetails.EndDate < CDATE(I.FDD))) AND " & _
'                        "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
'                        "I.InsuranceEachPeriod > 0 AND (ISNULL(I.spare3) OR I.spare3 = '') AND " & _
'                        "I.InsuranceDemandType = DemandTypes.ID AND " & _
'                        "I.InsuranceFrequency = Frequencies.ID AND " & _
'                        "Frequencies.ID = " & frmDemandTypesSel.cboGDPFreq.Column(0) & " AND LeaseDetails.Status;"
            szSQLStr = szSQLStr & _
                    "WHERE I.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                        "I.LeaseID = LeaseDetails.LeaseID AND (I.StopAutoDmd = FALSE OR LeaseDetails.GPrataDmd =FALSE OR " & _
                        "(I.StopAutoDmd = TRUE AND LeaseDetails.EndDate < CDATE(I.FDD))) AND " & _
                        "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
                        "I.InsuranceEachPeriod > 0 AND (ISNULL(I.spare3) OR I.spare3 = '') AND " & _
                        "I.InsuranceDemandType = DemandTypes.ID AND " & _
                        "I.InsuranceFrequency = Frequencies.ID AND " & _
                        "Frequencies.ID = " & frmDemandTypesSel.cboGDPFreq.Column(0) & " AND LeaseDetails.Status;"
         End If
'Debug.Print szSQLStr
         Set adoRstIns = New ADODB.Recordset
         adoRstIns.Open szSQLStr, adoConn, adOpenDynamic, adLockPessimistic

         While Not adoRstIns.EOF
            If IsNull(adoRstIns!StopIC) Or adoRstIns!StopIC = "" Then
               bProceed = True
            Else
               bProceed = IIf(DateDiff("d", adoRstIns!InsuranceNextDueDate, CDate(adoRstIns!StopIC)) > 0, True, False)
            End If
            If adoRstLeaseDtl!InsurancePayable = "Y" And _
                  DateDiff("d", Date, IIf(adoRstIns!InsuranceNextDueDate = "", _
                  DateAdd("d", -1, Date), adoRstIns!InsuranceNextDueDate)) <= DaysB4Due And bProceed And _
                  IsDmdTypeSel(adoRstIns.Fields("InsuranceDemandType").Value) And _
                  IIf(adoRstLeaseDtl!OLED, True, adoRstLeaseDtl!EndDate > adoRstIns!InsuranceNextDueDate) Then

               bINS = True
               adoRstIns.MoveLast
            End If
            adoRstIns.MoveNext
         Wend
         If bINS Then adoRstIns.MoveFirst
'************************************************************************************************
         bPRINS = False               '   Insurance Charge demands        --->     PRO-RATA
'************************************************************************************************
         szSQLStr = "SELECT I.InsCharges, I.LeaseID, " & _
                        "I.InsuranceStartDate, I.InsuranceFrequency, " & _
                        "I.InsuranceEndDate, I.InsuranceDemandType, " & _
                        "I.InsuranceEachPeriod, I.InsuranceNextDueDate, " & _
                        "I.ChargingType, " & _
                        "I.ChargingFigure, I.TotalYearlyInsurance,I.FDD, " & _
                        "I.InsuranceDept, I.InsDesc, " & _
                        "Units.PropertyID, DemandTypes.Spare1 as DemandTypeBankID, " & _
                        "Frequencies.CalDays, StopIC,Frequencies.ID " & _
                    "FROM LInsuranceCharges AS I, LeaseDetails, Units, DemandTypes, Frequencies "

         If frmDemandTypesSel.cboGDPFreq.Column(0) = 0 Then
          'issue 331 Modified by anol 20170314
'            szSQLStr = szSQLStr & _
'                    "WHERE I.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
'                        "LeaseDetails.GPrataDmd = TRUE AND I.GPD = FALSE AND " & _
'                        "I.LeaseID = LeaseDetails.LeaseID AND I.StopAutoDmd = TRUE AND " & _
'                        "LeaseDetails.EndDate >= CDATE(I.FDD) AND " & _
'                        "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
'                        "I.InsuranceEachPeriod > 0 AND (ISNULL(I.spare3) OR I.spare3 <> 'DELETED') AND " & _
'                        "I.InsuranceDemandType = DemandTypes.ID AND " & _
'                        "I.InsuranceFrequency = Frequencies.ID AND LeaseDetails.Status;"
'AND I.GPD = FALSE I have removed this field from where clause before proper implementation is done. anol 2020-06-11
                          szSQLStr = szSQLStr & _
                    "WHERE I.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                        "LeaseDetails.GPrataDmd = TRUE AND " & _
                        "I.LeaseID = LeaseDetails.LeaseID AND I.StopAutoDmd = TRUE AND " & _
                        "LeaseDetails.EndDate < CDATE(I.FDD) AND " & _
                        "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
                        "I.InsuranceEachPeriod > 0 AND (ISNULL(I.spare3) OR I.spare3 <> 'DELETED') AND " & _
                        "I.InsuranceDemandType = DemandTypes.ID AND " & _
                        "I.InsuranceFrequency = Frequencies.ID AND LeaseDetails.Status;"
         Else
          'issue 331 Modified by anol 20170314
'            szSQLStr = szSQLStr & _
'                    "WHERE I.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
'                        "LeaseDetails.GPrataDmd = TRUE AND I.GPD = FALSE AND " & _
'                        "I.LeaseID = LeaseDetails.LeaseID AND I.StopAutoDmd = TRUE AND " & _
'                        "LeaseDetails.EndDate >= CDATE(I.FDD) AND " & _
'                        "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
'                        "I.InsuranceEachPeriod > 0 AND (ISNULL(I.spare3) OR I.spare3 <> 'DELETED') AND " & _
'                        "I.InsuranceDemandType = DemandTypes.ID AND " & _
'                        "I.InsuranceFrequency = Frequencies.ID AND " & _
'                        "Frequencies.ID = " & frmDemandTypesSel.cboGDPFreq.Column(0) & " AND LeaseDetails.Status;"
'AND I.GPD = FALSE I have removed this field from where clause before proper implementation is done. anol 2020-06-11
         szSQLStr = szSQLStr & _
                    "WHERE I.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                        "LeaseDetails.GPrataDmd = TRUE  AND " & _
                        "I.LeaseID = LeaseDetails.LeaseID AND I.StopAutoDmd = TRUE AND " & _
                        "LeaseDetails.EndDate < CDATE(I.FDD) AND " & _
                        "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
                        "I.InsuranceEachPeriod > 0 AND (ISNULL(I.spare3) OR I.spare3 <> 'DELETED') AND " & _
                        "I.InsuranceDemandType = DemandTypes.ID AND " & _
                        "I.InsuranceFrequency = Frequencies.ID AND " & _
                        "Frequencies.ID = " & frmDemandTypesSel.cboGDPFreq.Column(0) & " AND LeaseDetails.Status;"
         End If
'Debug.Print szSQLStr
         Set adoPRRstIns = New ADODB.Recordset
         adoPRRstIns.Open szSQLStr, adoConn, adOpenDynamic, adLockPessimistic

         While Not adoPRRstIns.EOF
            If IsNull(adoPRRstIns!StopIC) Or adoPRRstIns!StopIC = "" Then
               bProceed = True
            Else
               bProceed = IIf(DateDiff("d", adoPRRstIns!InsuranceNextDueDate, CDate(adoPRRstIns!StopIC)) > 0, True, False)
            End If
            If adoRstLeaseDtl!InsurancePayable = "Y" And _
               DateDiff("d", Date, IIf(adoPRRstIns!InsuranceNextDueDate = "", _
                  DateAdd("d", -1, Date), adoPRRstIns!InsuranceNextDueDate)) <= DaysB4Due And bProceed Then

               bPRINS = True
               adoPRRstIns.MoveLast
            End If
            adoPRRstIns.MoveNext
         Wend
         If bPRINS Then adoPRRstIns.MoveFirst
'*********************************************************************************************************
         bUTL = False                     'UTILITY PAYABLE
'*********************************************************************************************************
'        Finding out is there any Service Charges to generate
         szSQLStr = "SELECT LUtilityUsage.*, DemandTypes.Spare1 as DemandTypeBankID " & _
                    "FROM LUtilityUsage, DemandTypes " & _
                    "WHERE LUtilityUsage.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                        "LUtilityUsage.IsGenerated = FALSE AND " & _
                        "LUtilityUsage.DemandType = DemandTypes.ID AND " & _
                        "LUtilityUsage.LatestReading = TRUE;"

         Set adoRstUC = New ADODB.Recordset
         adoRstUC.Open szSQLStr, adoConn, adOpenDynamic, adLockPessimistic

         If Not adoRstUC.EOF Then bUTL = True
'*********************************************************************************************************
         laBankID(0, 0) = ""
         laBankID(0, 1) = ""
         laBankID(1, 0) = ""
         laBankID(1, 1) = ""
         laBankID(2, 0) = ""
         laBankID(2, 1) = ""
         laBankID(3, 0) = ""
         laBankID(3, 1) = ""
         laBankID(4, 0) = ""
         laBankID(4, 1) = ""

         If adoRstLeaseDtl.Fields("InterestChargeable").Value = "Y" Then
            lDemand = NextRef(adoConn, "DEMAND_REF")           'GET THE NEXT DEMAND ID

' There are no demand type 'Intererst Charge', so for this client's default bank details has to use.
            laBankID(0, 0) = ClientDefaultBankDts(adoRstLeaseDtl!propertyID, adoConn)
            laBankID(0, 1) = CStr(lDemand)
            laBankID(1, 1) = laBankID(0, 1)
            laBankID(2, 1) = laBankID(0, 1)
            laBankID(3, 1) = laBankID(0, 1)
            laBankID(4, 1) = laBankID(0, 1)
            laBankID(1, 0) = laBankID(0, 0)
            laBankID(2, 0) = laBankID(0, 0)
            laBankID(3, 0) = laBankID(0, 0)
            laBankID(4, 0) = laBankID(0, 0)

            With adoRstDemandRec
               .AddNew
               .Fields("DemandID").Value = lDemand
               .Fields("CreatedBy").Value = User
               .Fields("CreatedDate").Value = Now
               lArrDemand(UBound(lArrDemand)) = lDemand
               ReDim Preserve lArrDemand(UBound(lArrDemand) + 1) As Long

               .Fields("BatchID").Value = lBatch
               .Fields("SageAccountNumber").Value = adoRstLeaseDtl!SageAccountNumber
               .Fields("TenantCompanyName").Value = adoRstLeaseDtl!CompanyName
               .Fields("UnitNumber").Value = adoRstLeaseDtl!UnitNumber
               .Fields("Source").Value = 1
               .Fields("TransactionType").Value = 1            'Invoice (I assume that in automatic demand all are invoice
               .Fields("IssueDate").Value = Format(frmDemandTypesSel.txtInitialIssueDate.text, "dd/mm/yyyy")
               .Fields("SageText").Value = "S/L " & adoRstLeaseDtl!SageAccountNumber
               .Fields("IsPrinted").Value = False
               .Fields("Spare1").Value = laBankID(0, 0)
               .Fields.Item("LeaseRef").Value = adoRstLeaseDtl!LeaseID
               .Fields.Item("DmdSlNo").Value = SlNumber("SI", "DemandRecords", adoConn)
               .Fields.Item("SuppText1").Value = adoRstLeaseDtl.Fields.Item("SuppText1").Value
               .Fields.Item("SentByEmail").Value = IIf(adoRstLeaseDtl.Fields.Item("EmailDmd").Value, Null, 2)
               .Fields.Item("PostingDate").Value = Format(frmDemandTypesSel.txtPostingDate.text, "dd mmmm yyyy")
               'aded by anol 16 08 2016
               .Fields.Item("SO").Value = True
               .Fields.Item("LastModifiedBy").Value = User
               .Fields.Item("LastModifiedDate").Value = Now
               .Update
            End With
         End If

         If bRC Then
            If laBankID(1, 0) <> adoRstRC!DemandTypeBankID Then
               laBankID(1, 0) = adoRstRC!DemandTypeBankID

               lDemand = NextRef(adoConn, "DEMAND_REF")        'GET THE NEXT DEMAND ID
               laBankID(1, 1) = CStr(lDemand)

               With adoRstDemandRec
                  .AddNew
                  .Fields("DemandID").Value = lDemand
                  .Fields("CreatedBy").Value = User
                  .Fields("CreatedDate").Value = Now
                  lArrDemand(UBound(lArrDemand)) = lDemand
                  ReDim Preserve lArrDemand(UBound(lArrDemand) + 1) As Long

                  .Fields("BatchID").Value = lBatch
                  .Fields("SageAccountNumber").Value = adoRstLeaseDtl!SageAccountNumber
                  .Fields("TenantCompanyName").Value = adoRstLeaseDtl!CompanyName
                  .Fields("UnitNumber").Value = adoRstLeaseDtl!UnitNumber
                  .Fields("Source").Value = 1
                  .Fields("TransactionType").Value = 1            'Invoice (I assume that in automatic demand all are invoice
                  .Fields("IssueDate").Value = Format(frmDemandTypesSel.txtInitialIssueDate.text, "dd/mm/yyyy")
                  .Fields("SageText").Value = "S/L " & adoRstLeaseDtl!SageAccountNumber
                  .Fields("IsPrinted").Value = False
                  .Fields("Spare1").Value = laBankID(1, 0)
                  .Fields.Item("LeaseRef").Value = adoRstLeaseDtl!LeaseID
                  .Fields.Item("DmdSlNo").Value = SlNumber("SI", "DemandRecords", adoConn)
                  .Fields.Item("SuppText1").Value = adoRstLeaseDtl.Fields.Item("SuppText1").Value
                  .Fields.Item("SentByEmail").Value = IIf(adoRstLeaseDtl.Fields.Item("EmailDmd").Value, Null, 2)
                  .Fields.Item("PostingDate").Value = Format(frmDemandTypesSel.txtPostingDate.text, "dd mmmm yyyy")
                  'aded by anol 16 08 2016
                  .Fields.Item("SO").Value = True
                  .Fields.Item("LastModifiedBy").Value = User
                  .Fields.Item("LastModifiedDate").Value = Now
                  .Update
               End With
            End If
         End If

         If Not bRC And bPRRC Then
            If laBankID(1, 0) <> adoPRRstRC!DemandTypeBankID Then
               laBankID(1, 0) = adoPRRstRC!DemandTypeBankID

               lDemand = NextRef(adoConn, "DEMAND_REF")        'GET THE NEXT DEMAND ID
               laBankID(1, 1) = CStr(lDemand)

               With adoRstDemandRec
                  .AddNew
                  .Fields("DemandID").Value = lDemand
                  .Fields("CreatedBy").Value = User
                  .Fields("CreatedDate").Value = Now
                  lArrDemand(UBound(lArrDemand)) = lDemand
                  ReDim Preserve lArrDemand(UBound(lArrDemand) + 1) As Long

                  .Fields("BatchID").Value = lBatch
                  .Fields("SageAccountNumber").Value = adoRstLeaseDtl!SageAccountNumber
                  .Fields("TenantCompanyName").Value = adoRstLeaseDtl!CompanyName
                  .Fields("UnitNumber").Value = adoRstLeaseDtl!UnitNumber
                  .Fields("Source").Value = 1
                  .Fields("TransactionType").Value = 1            'Invoice (I assume that in automatic demand all are invoice
                  .Fields("IssueDate").Value = Format(frmDemandTypesSel.txtInitialIssueDate.text, "dd/mm/yyyy")
                  .Fields("SageText").Value = "S/L " & adoRstLeaseDtl!SageAccountNumber
                  .Fields("IsPrinted").Value = False
                  .Fields("Spare1").Value = laBankID(1, 0)
                  .Fields.Item("LeaseRef").Value = adoRstLeaseDtl!LeaseID
                  .Fields.Item("DmdSlNo").Value = SlNumber("SI", "DemandRecords", adoConn)
                  .Fields.Item("SuppText1").Value = adoRstLeaseDtl.Fields.Item("SuppText1").Value
                  .Fields.Item("SentByEmail").Value = IIf(adoRstLeaseDtl.Fields.Item("EmailDmd").Value, Null, 2)
                  .Fields.Item("PostingDate").Value = Format(frmDemandTypesSel.txtPostingDate.text, "dd mmmm yyyy")
                  'aded by anol 16 08 2016
                 .Fields.Item("SO").Value = True
                 .Fields.Item("LastModifiedBy").Value = User
                  .Fields.Item("LastModifiedDate").Value = Now
                  .Update
               End With
            End If
         End If

         If bSC Then
            If laBankID(2, 0) <> adoRstSC!DemandTypeBankID Then
               If laBankID(1, 0) = adoRstSC!DemandTypeBankID Then
                  laBankID(2, 0) = laBankID(1, 0)
                  laBankID(2, 1) = laBankID(1, 1)
               Else
                  laBankID(2, 0) = adoRstSC!DemandTypeBankID

                  lDemand = NextRef(adoConn, "DEMAND_REF")        'GET THE NEXT DEMAND ID
                  laBankID(2, 1) = CStr(lDemand)

                  With adoRstDemandRec
                     .AddNew
                     .Fields("DemandID").Value = lDemand
                     .Fields("CreatedBy").Value = User
                     .Fields("CreatedDate").Value = Now
                     lArrDemand(UBound(lArrDemand)) = lDemand
                     ReDim Preserve lArrDemand(UBound(lArrDemand) + 1) As Long

                     .Fields("BatchID").Value = lBatch
                     .Fields("SageAccountNumber").Value = adoRstLeaseDtl!SageAccountNumber
                     .Fields("TenantCompanyName").Value = adoRstLeaseDtl!CompanyName
                     .Fields("UnitNumber").Value = adoRstLeaseDtl!UnitNumber
                     .Fields("Source").Value = 1
                     .Fields("TransactionType").Value = 1            'Invoice (I assume that in automatic demand all are invoice
      '*** Here my thinking is, all type of demands due date is on the same day
      '*** If its not correct then i have to change the manual demands grid and the demand table & split table
                     .Fields("IssueDate").Value = Format(frmDemandTypesSel.txtInitialIssueDate.text, "dd/mm/yyyy")
                     .Fields("SageText").Value = "S/L " & adoRstLeaseDtl!SageAccountNumber
                     .Fields("IsPrinted").Value = False
                     .Fields("Spare1").Value = laBankID(2, 0)
                     .Fields.Item("LeaseRef").Value = adoRstLeaseDtl!LeaseID
                     .Fields.Item("DmdSlNo").Value = SlNumber("SI", "DemandRecords", adoConn)
                     .Fields.Item("SuppText1").Value = adoRstLeaseDtl.Fields.Item("SuppText1").Value
                     .Fields.Item("SentByEmail").Value = IIf(adoRstLeaseDtl.Fields.Item("EmailDmd").Value, Null, 2)
                     .Fields.Item("PostingDate").Value = Format(frmDemandTypesSel.txtPostingDate.text, "dd mmmm yyyy")
                     'aded by anol 16 08 2016
                     .Fields.Item("SO").Value = True
                     .Fields.Item("LastModifiedBy").Value = User
                  .Fields.Item("LastModifiedDate").Value = Now
                     .Update
                  End With
               End If
            End If
         End If
         If Not bSC And bPRSC Then
            If laBankID(2, 0) <> adoPRRstSC!DemandTypeBankID Then
               If laBankID(1, 0) = adoPRRstSC!DemandTypeBankID Then
                  laBankID(2, 0) = laBankID(1, 0)
                  laBankID(2, 1) = laBankID(1, 1)
               Else
                  laBankID(2, 0) = adoPRRstSC!DemandTypeBankID

                  lDemand = NextRef(adoConn, "DEMAND_REF")        'GET THE NEXT DEMAND ID
                  laBankID(2, 1) = CStr(lDemand)

                  With adoRstDemandRec
                     .AddNew
                     .Fields("DemandID").Value = lDemand
                     .Fields("CreatedBy").Value = User
                     .Fields("CreatedDate").Value = Now

                     lArrDemand(UBound(lArrDemand)) = lDemand
                     ReDim Preserve lArrDemand(UBound(lArrDemand) + 1) As Long

                     .Fields("BatchID").Value = lBatch
                     .Fields("SageAccountNumber").Value = adoRstLeaseDtl!SageAccountNumber
                     .Fields("TenantCompanyName").Value = adoRstLeaseDtl!CompanyName
                     .Fields("UnitNumber").Value = adoRstLeaseDtl!UnitNumber
                     .Fields("Source").Value = 1
                     .Fields("TransactionType").Value = 1            'Invoice (I assume that in automatic demand all are invoice
      '*** Here my thinking is, all type of demands due date is on the same day
      '*** If its not correct then i have to change the manual demands grid and the demand table & split table
                     .Fields("IssueDate").Value = Format(frmDemandTypesSel.txtInitialIssueDate.text, "dd/mm/yyyy")
                     .Fields("SageText").Value = "S/L " & adoRstLeaseDtl!SageAccountNumber
                     .Fields("IsPrinted").Value = False
                     .Fields("Spare1").Value = laBankID(2, 0)
                     .Fields.Item("LeaseRef").Value = adoRstLeaseDtl!LeaseID
                     .Fields.Item("DmdSlNo").Value = SlNumber("SI", "DemandRecords", adoConn)
                     .Fields.Item("SuppText1").Value = adoRstLeaseDtl.Fields.Item("SuppText1").Value
                     .Fields.Item("SentByEmail").Value = IIf(adoRstLeaseDtl.Fields.Item("EmailDmd").Value, Null, 2)
                     .Fields.Item("PostingDate").Value = Format(frmDemandTypesSel.txtPostingDate.text, "dd mmmm yyyy")
                     'aded by anol 16 08 2016
                     .Fields.Item("SO").Value = True
                     .Fields.Item("LastModifiedBy").Value = User
                  .Fields.Item("LastModifiedDate").Value = Now
                     .Update
                  End With
               End If
            End If
         End If

         If bINS Then
            If laBankID(3, 0) <> adoRstIns!DemandTypeBankID Then
               If laBankID(2, 0) = adoRstIns!DemandTypeBankID Then
                  laBankID(3, 0) = laBankID(2, 0)
                  laBankID(3, 1) = laBankID(2, 1)
               Else
                  If laBankID(1, 0) = adoRstIns!DemandTypeBankID Then
                     laBankID(3, 0) = laBankID(1, 0)
                     laBankID(3, 1) = laBankID(1, 1)
                  Else
                     laBankID(3, 0) = adoRstIns!DemandTypeBankID

                     lDemand = NextRef(adoConn, "DEMAND_REF")        'GET THE NEXT DEMAND ID
                     laBankID(3, 1) = CStr(lDemand)

                     With adoRstDemandRec
                        .AddNew
                        .Fields("DemandID").Value = lDemand
                        .Fields("CreatedBy").Value = User
                        .Fields("CreatedDate").Value = Now
                        lArrDemand(UBound(lArrDemand)) = lDemand
                        ReDim Preserve lArrDemand(UBound(lArrDemand) + 1) As Long

                        .Fields("BatchID").Value = lBatch
                        .Fields("SageAccountNumber").Value = adoRstLeaseDtl!SageAccountNumber
                        .Fields("TenantCompanyName").Value = adoRstLeaseDtl!CompanyName
                        .Fields("UnitNumber").Value = adoRstLeaseDtl!UnitNumber
                        .Fields("Source").Value = 1
                        .Fields("TransactionType").Value = 1            'Invoice (I assume that in automatic demand all are invoice
         '*** Here my thinking is, all type of demands due date is on the same day
         '*** If its not correct then i have to change the manual demands grid and the demand table & split table
                        .Fields("IssueDate").Value = Format(frmDemandTypesSel.txtInitialIssueDate.text, "dd/mm/yyyy")
                        .Fields("SageText").Value = "S/L " & adoRstLeaseDtl!SageAccountNumber
                        .Fields("IsPrinted").Value = False
                        .Fields("Spare1").Value = laBankID(3, 0)
                        .Fields.Item("LeaseRef").Value = adoRstLeaseDtl!LeaseID
                        .Fields.Item("DmdSlNo").Value = SlNumber("SI", "DemandRecords", adoConn)
                        .Fields.Item("SuppText1").Value = adoRstLeaseDtl.Fields.Item("SuppText1").Value
                        .Fields.Item("SentByEmail").Value = IIf(adoRstLeaseDtl.Fields.Item("EmailDmd").Value, Null, 2)
                        .Fields.Item("PostingDate").Value = Format(frmDemandTypesSel.txtPostingDate.text, "dd mmmm yyyy")
                        'aded by anol 16 08 2016
                        .Fields.Item("SO").Value = True
                        .Fields.Item("LastModifiedBy").Value = User
                  .Fields.Item("LastModifiedDate").Value = Now
                        .Update
                     End With
                  End If
               End If
            End If
         End If
         If Not bINS And bPRINS Then
            If laBankID(3, 0) <> adoPRRstIns!DemandTypeBankID Then
               If laBankID(2, 0) = adoPRRstIns!DemandTypeBankID Then
                  laBankID(3, 0) = laBankID(2, 0)
                  laBankID(3, 1) = laBankID(2, 1)
               Else
                  If laBankID(1, 0) = adoPRRstIns!DemandTypeBankID Then
                     laBankID(3, 0) = laBankID(1, 0)
                     laBankID(3, 1) = laBankID(1, 1)
                  Else
                     laBankID(3, 0) = adoPRRstIns!DemandTypeBankID

                     lDemand = NextRef(adoConn, "DEMAND_REF")        'GET THE NEXT DEMAND ID
                     laBankID(3, 1) = CStr(lDemand)

                     With adoRstDemandRec
                        .AddNew
                        .Fields("DemandID").Value = lDemand
                        .Fields("CreatedBy").Value = User
                        .Fields("CreatedDate").Value = Now

                        lArrDemand(UBound(lArrDemand)) = lDemand
                        ReDim Preserve lArrDemand(UBound(lArrDemand) + 1) As Long

                        .Fields("BatchID").Value = lBatch
                        .Fields("SageAccountNumber").Value = adoRstLeaseDtl!SageAccountNumber
                        .Fields("TenantCompanyName").Value = adoRstLeaseDtl!CompanyName
                        .Fields("UnitNumber").Value = adoRstLeaseDtl!UnitNumber
                        .Fields("Source").Value = 1
                        .Fields("TransactionType").Value = 1            'Invoice (I assume that in automatic demand all are invoice
         '*** Here my thinking is, all type of demands due date is on the same day
         '*** If its not correct then i have to change the manual demands grid and the demand table & split table
                        .Fields("IssueDate").Value = Format(frmDemandTypesSel.txtInitialIssueDate.text, "dd/mm/yyyy")
                        .Fields("SageText").Value = "S/L " & adoRstLeaseDtl!SageAccountNumber
                        .Fields("IsPrinted").Value = False
                        .Fields("Spare1").Value = laBankID(3, 0)
                        .Fields.Item("LeaseRef").Value = adoRstLeaseDtl!LeaseID
                        .Fields.Item("DmdSlNo").Value = SlNumber("SI", "DemandRecords", adoConn)
                        .Fields.Item("SuppText1").Value = adoRstLeaseDtl.Fields.Item("SuppText1").Value
                        .Fields.Item("SentByEmail").Value = IIf(adoRstLeaseDtl.Fields.Item("EmailDmd").Value, Null, 2)
                        .Fields.Item("PostingDate").Value = Format(frmDemandTypesSel.txtPostingDate.text, "dd mmmm yyyy")
                        'aded by anol 16 08 2016
                        .Fields.Item("SO").Value = True
                        .Fields.Item("LastModifiedBy").Value = User
                  .Fields.Item("LastModifiedDate").Value = Now
                        .Update
                     End With
                  End If
               End If
            End If
         End If

         If bUTL Then
            If laBankID(4, 0) <> adoRstUC!DemandTypeBankID Then
               If laBankID(3, 0) = adoRstUC!DemandTypeBankID Then
                  laBankID(4, 0) = laBankID(3, 0)
                  laBankID(4, 1) = laBankID(3, 1)
               Else
                  If laBankID(2, 0) = adoRstUC!DemandTypeBankID Then
                     laBankID(4, 0) = laBankID(2, 0)
                     laBankID(4, 1) = laBankID(2, 1)
                  Else
                     If laBankID(1, 0) = adoRstUC!DemandTypeBankID Then
                        laBankID(4, 0) = laBankID(1, 0)
                        laBankID(4, 1) = laBankID(1, 1)
                     Else
                        laBankID(4, 0) = adoRstUC!DemandTypeBankID

                        lDemand = NextRef(adoConn, "DEMAND_REF")        'GET THE NEXT DEMAND ID
                        laBankID(4, 1) = CStr(lDemand)

                        With adoRstDemandRec
                           .AddNew
                           .Fields("DemandID").Value = lDemand
                           .Fields("CreatedBy").Value = User
                           .Fields("CreatedDate").Value = Now

                           lArrDemand(UBound(lArrDemand)) = lDemand
                           ReDim Preserve lArrDemand(UBound(lArrDemand) + 1) As Long

                           .Fields("BatchID").Value = lBatch
                           .Fields("SageAccountNumber").Value = adoRstLeaseDtl!SageAccountNumber
                           .Fields("TenantCompanyName").Value = adoRstLeaseDtl!CompanyName
                           .Fields("UnitNumber").Value = adoRstLeaseDtl!UnitNumber
                           .Fields("Source").Value = 1
                           .Fields("TransactionType").Value = 1            'Invoice (I assume that in automatic demand all are invoice
                           .Fields("IssueDate").Value = Format(frmDemandTypesSel.txtInitialIssueDate.text, "dd/mm/yyyy")
                           'Modified by anol 20160916
                           .Fields("SageText").Value = "S/L " & adoRstLeaseDtl!SageAccountNumber '"S/L " &
                           .Fields("IsPrinted").Value = False
                           .Fields("Spare1").Value = laBankID(4, 0)
                           .Fields.Item("LeaseRef").Value = adoRstLeaseDtl!LeaseID
                           .Fields.Item("DmdSlNo").Value = SlNumber("SI", "DemandRecords", adoConn)
                           .Fields.Item("SuppText1").Value = adoRstLeaseDtl.Fields.Item("SuppText1").Value
                           .Fields.Item("SentByEmail").Value = IIf(adoRstLeaseDtl.Fields.Item("EmailDmd").Value, Null, 2)
                           .Fields.Item("PostingDate").Value = Format(frmDemandTypesSel.txtPostingDate.text, "dd mmmm yyyy")
                           'aded by anol 16 08 2016
                            .Fields.Item("SO").Value = True
                            .Fields.Item("LastModifiedBy").Value = User
                            .Fields.Item("LastModifiedDate").Value = Now
                           .Update
                        End With
                     End If
                  End If
               End If
            End If
         End If

'*********************************************************************************************************

         If adoRstLeaseDtl.Fields("InterestChargeable").Value = "Y" Or bRC Or bSC Or bINS Or bUTL Or _
                                                                       bPRRC Or bPRSC Or bPRINS Then
            iChildId = 0
'************************************************************************************
'*********************        Interest Charge            ****************************
'************************************************************************************
'*** Insert the split records in the DemandSplitRecords table
            If adoRstLeaseDtl.Fields("InterestChargeable").Value = "Y" And Val(szPoACrNt) <> 6 Then
               Dim cTotalOSAmt As Currency, sIntCalDays As Single

               iChildId = iChildId + 1
'  ***  Add new demand IN demand table.
               adoRstSplitDemand.AddNew
               adoRstSplitDemand!DSR = UniqueID()
               adoRstSplitDemand!splitID = iChildId
               adoRstSplitDemand!DEMANDID = CLng(laBankID(0, 1))
               If adoRstLeaseDtl!ServiceChargeDept = "AUTO" Then
                  adoRstSplitDemand!A_M = "A"
               Else
                  adoRstSplitDemand!A_M = "M"
               End If
               adoRstSplitDemand!NominalCodeforAmount = PartString(szaNCode(adoRstLeaseDtl!IntDemandType), 0, " # ")
               adoRstSplitDemand!NominalNameforAmount = PartString(szaNCName(adoRstLeaseDtl!IntDemandType), 0, " # ")
               adoRstSplitDemand!NominalCodeForTotal = PartString(szaNCode(adoRstLeaseDtl!IntDemandType), 2, " # ")
               adoRstSplitDemand!NominalNameforTotal = PartString(szaNCName(adoRstLeaseDtl!IntDemandType), 2, " # ")

               If adoRstLeaseDtl!ServiceChargeDept = "AUTO" Then
                  adoRstSplitDemand!amount = CalAutoInterest(CSng(adoRstLeaseDtl!AdditionalInterest), CInt(adoRstLeaseDtl!DaysAfterInterestPayable), adoRstLeaseDtl!UnitNumber, adoRstLeaseDtl!SageAccountNumber, adoConn, cTotalOSAmt, sIntCalDays)
               Else
                  adoRstSplitDemand!amount = adoRstLeaseDtl!InterestAmount
                  UpdateIntCharge adoRstLeaseDtl!LeaseID, adoConn          ' updating the InterestChargable 'Y' to 'N' in UpdateIntCharge method
               End If

               If adoRstLeaseDtl!Text1 = "" Then
                  szDes = "Interest Charges For " & adoRstLeaseDtl!DaysAfterInterestPayable & _
                          " Days on " & cTotalOSAmt
               Else
                  szDes = adoRstLeaseDtl!Text1
               End If

               adoRstSplitDemand!VATAMOUNT = 0
               adoRstSplitDemand!TotalAmount = RoundingNumber(adoRstSplitDemand!amount, 2) + _
                                               RoundingNumber(adoRstSplitDemand!VATAMOUNT, 2)
                                               'from date and to date not found -anol
               adoRstSplitDemand!SageRef = szaPrefix(adoRstLeaseDtl!IntDemandType) & Format(SlNumber("SI", "DemandRecords", adoConn), "00000")
               adoRstSplitDemand!DueDate = Format(Date, "dd/mm/yyyy")
               adoRstSplitDemand!VATMonth = Month(Date)
               adoRstSplitDemand!TypeOfDemand = adoRstLeaseDtl!IntDemandType
               adoRstSplitDemand!description = szDes
               adoRstSplitDemand!DemandStatement = True
               adoRstSplitDemand!FrequencyID = 0
               adoRstSplitDemand.Update

               IPcount = IPcount + 1
               iSerial = iSerial + 1
            End If
'*********************************************************************************************************
'         Rent Charge Demands
'*********************************************************************************************************
'        HERE WE NEED TO IMPLIMENT THE STOP FLAG
'#########################################################################################################
            While Not adoRstRC.EOF
               If IsNull(adoRstRC!StopRC) Or adoRstRC!StopRC = "" Then
                  bProceed = True
               Else
                  bProceed = IIf(DateDiff("d", adoRstRC!BRNextDueDate, CDate(adoRstRC!StopRC)) > 0, True, False)
               End If

               If adoRstLeaseDtl!BRPayable = "Y" And _
                  DateDiff("d", Date, IIf(adoRstRC!BRNextDueDate = "", _
                     DateAdd("d", -1, Date), adoRstRC!BRNextDueDate)) <= DaysB4Due And bProceed And _
                     IsDmdTypeSel(adoRstRC.Fields("BRDemandType").Value) Then
                  iChildId = iChildId + 1
'      **** Insert the Header info in the DemandSplitRecords table

                  szDes = IIf(IIf(IsNull(adoRstRC!RentDesc), "", adoRstRC!RentDesc) = "", DemandTypeName(adoRstRC!BRDemandType, adoConn), adoRstRC!RentDesc)

                  dtNtDueDate = FindNextDueDate(adoRstRC!BRNextDueDate, _
                                    adoRstRC!BRfrequency, adoRstRC!BRDemandType, adoRstRC!propertyID, adoConn)
                  dtFDD = FindNextDueDate(dtNtDueDate, _
                                                adoRstRC!BRfrequency, _
                                                adoRstRC!BRDemandType, _
                                                adoRstRC!propertyID, adoConn)

''******* if the override lease end date is false then the lease is open, lease is not expairing.
''******* if the lease end date is open then we dont need to compare the NextDueDate with the lease expaire date.
'                  If Not adoRstLeaseDtl.Fields.Item("OLED").Value Then
'                     dtEndDate = Format(DateAdd("d", 1, adoRstLeaseDtl!EndDate), "dd/mm/yyyy")
'                     If DateDiff("d", dtEndDate, dtNtDueDate) > 0 Then dtNtDueDate = dtEndDate
'                  End If

                  With adoRstSplitDemand
                     .AddNew
                     !DSR = UniqueID()
                     !splitID = iChildId
                     !DEMANDID = CLng(laBankID(1, 1))
                     !A_M = "A"
                     !NominalCodeforAmount = PartString(szaNCode(adoRstRC!BRDemandType), 0, " # ")
                     !NominalNameforAmount = PartString(szaNCName(adoRstRC!BRDemandType), 0, " # ")
                     !NominalCodeForVAT = PartString(szaNCode(adoRstRC!BRDemandType), 1, " # ")
                     !NominalNameforVAT = PartString(szaNCName(adoRstRC!BRDemandType), 1, " # ")
                     !NominalCodeForTotal = PartString(szaNCode(adoRstRC!BRDemandType), 2, " # ")
                     !NominalNameforTotal = PartString(szaNCName(adoRstRC!BRDemandType), 2, " # ")
                     !amount = RoundingNumber(adoRstRC!BRAmount, 2)
                     !VATAMOUNT = RoundingNumber(adoRstRC!BRAmount * GetVAT_Tenant(adoRstLeaseDtl!SageAccountNumber, adoConn) / 100, 2)
                     !TotalAmount = !amount + !VATAMOUNT
                    'new requirement from WD they want  Startdate and end date as 2nd ref 2019-11-18
                    ' !SageRef = szaPrefix(adoRstRC!BRDemandType) & Format(SlNumber("SI", "DemandRecords", adoConn), "00000")
                     !DueDate = Format(adoRstRC!BRNextDueDate, "dd/mm/yyyy")
                     !VATMonth = Month(adoRstRC!BRNextDueDate)
                     !TypeOfDemand = adoRstRC!BRDemandType
                     !description = szDes
                     !DemandStatement = True
                     !VAT_CODE = GetVATCode_Tenant(adoRstLeaseDtl!SageAccountNumber, adoConn)
                     If !VAT_CODE = -1 Then
                        !VAT_CODE = Null
                     End If
                     If Left(adoRstRC!CalDays, 1) <> "-" Then
                     '           ADVANCE
                        !dateFrom = CDate(adoRstRC!BRNextDueDate)
                        !DateTO = DateAdd("d", -1, dtNtDueDate)
                     Else
                     '           ARREARS
'                        !DateFrom = DateAdd(Right(adoRstRC!CalDays, 1), Left(adoRstRC!CalDays, Len(adoRstRC!CalDays) - 1), adoRstRC!BRNextDueDate) 'CDate(adoRstRC!BRNextDueDate)
                        !dateFrom = ArrFromDate(adoRstRC.Fields.Item("BRNextDueDate"), _
                                                adoRstRC.Fields.Item("BRfrequency"), _
                                                adoRstRC.Fields.Item("BRDemandType"), _
                                                adoRstRC.Fields.Item("PropertyID"), _
                                                adoRstRC.Fields.Item("CalDays"), adoConn)
                        !DateTO = DateAdd("d", -1, adoRstRC!BRNextDueDate)
                     End If
                     !SageRef = Format(!dateFrom, "dd/mm/yy") & "-" & Format(!DateTO, "dd/mm/yy")
                     !SageDepartment = adoRstRC!RentChargeDept ' DepartmentID(adoRstLeaseDtl!SageAccountNumber, adoRstLeaseDtl!UnitNumber, "Rent Charges", adoConn)
                     !FrequencyID = adoRstRC!BRfrequency
                     !ChargingFigure = adoRstRC!spare2
                     !ChargingMethod = CByte(IIf(IsNull(adoRstRC!ChargingMethod), "", adoRstRC!ChargingMethod))
                     .Update
                  End With

                  UpdateNextDueDate "LRentCharges", "BRNextDueDate", dtNtDueDate, "RentCharges", adoRstRC!RentCharges, adoConn
                  SetFDD "LRentCharges", "FDD", dtFDD, "RentCharges", adoRstRC!RentCharges, adoConn

                  BRcount = BRcount + 1
                  iSerial = iSerial + 1
               End If
               adoRstRC.MoveNext
            Wend
            adoRstRC.Close
            Set adoRstRC = Nothing
'*********************************************************************************************************
'         Rent Charge Demands       PRO-RATA DEMAND
'*********************************************************************************************************
            While Not adoPRRstRC.EOF
               If IsNull(adoPRRstRC!StopRC) Or adoPRRstRC!StopRC = "" Then
                  bProceed = True
               Else
                  bProceed = IIf(DateDiff("d", adoPRRstRC!BRNextDueDate, CDate(adoPRRstRC!StopRC)) > 0, True, False)
               End If

               If adoRstLeaseDtl!BRPayable = "Y" And _
                  DateDiff("d", Date, IIf(adoPRRstRC!BRNextDueDate = "", _
                     DateAdd("d", -1, Date), adoPRRstRC!BRNextDueDate)) <= DaysB4Due And bProceed And _
                     IsDmdTypeSel(adoPRRstRC.Fields("BRDemandType").Value) Then
                  iChildId = iChildId + 1
'      **** Insert the Header info in the DemandSplitRecords table

                  szDes = IIf(IIf(IsNull(adoPRRstRC!RentDesc), "", adoPRRstRC!RentDesc) = "", DemandTypeName(adoPRRstRC!BRDemandType, adoConn), adoPRRstRC!RentDesc)

                  dtNtDueDate = FindNextDueDate(adoPRRstRC!BRNextDueDate, _
                                    adoPRRstRC!BRfrequency, adoPRRstRC!BRDemandType, adoPRRstRC!propertyID, adoConn)
'                  dtFDD = FindNextDueDate(dtNtDueDate, _
                                                adoPRRstRC!BRfrequency, _
                                                adoPRRstRC!BRDemandType, _
                                                adoPRRstRC!PropertyID, adoConn)

''******* if the override lease end date is false then the lease is open, lease is not expairing.
''******* if the lease end date is open then we dont need to compare the NextDueDate with the lease expaire date.
'                  If Not adoRstLeaseDtl.Fields.Item("OLED").Value Then
'                     dtEndDate = Format(DateAdd("d", 1, adoRstLeaseDtl!EndDate), "dd/mm/yyyy")
'                     If DateDiff("d", dtEndDate, dtNtDueDate) > 0 Then dtNtDueDate = dtEndDate
'                  End If

                  With adoRstSplitDemand
                     .AddNew
                     !DSR = UniqueID()
                     !splitID = iChildId
                     !DEMANDID = CLng(laBankID(1, 1))
                     !A_M = "A"
                     !NominalCodeforAmount = PartString(szaNCode(adoPRRstRC!BRDemandType), 0, " # ")
                     !NominalNameforAmount = PartString(szaNCName(adoPRRstRC!BRDemandType), 0, " # ")
                     !NominalCodeForVAT = PartString(szaNCode(adoPRRstRC!BRDemandType), 1, " # ")
                     !NominalNameforVAT = PartString(szaNCName(adoPRRstRC!BRDemandType), 1, " # ")
                     !NominalCodeForTotal = PartString(szaNCode(adoPRRstRC!BRDemandType), 2, " # ")
                     !NominalNameforTotal = PartString(szaNCName(adoPRRstRC!BRDemandType), 2, " # ")
                   '  !SageRef = szaPrefix(adoPRRstRC!BRDemandType) & Format(SlNumber("SI", "DemandRecords", adoConn), "00000")
                     !DueDate = Format(adoPRRstRC!BRNextDueDate, "dd/mm/yyyy")
                     !VATMonth = Month(adoPRRstRC!BRNextDueDate)
                     !TypeOfDemand = adoPRRstRC!BRDemandType
                     !description = szDes
                     !DemandStatement = True
                     !VAT_CODE = GetVATCode_Tenant(adoRstLeaseDtl!SageAccountNumber, adoConn)
                     If !VAT_CODE = -1 Then
                        !VAT_CODE = Null
                     End If
                     If Left(adoPRRstRC!CalDays, 1) <> "-" Then                     '           ADVANCE
                        !dateFrom = CDate(adoPRRstRC!BRNextDueDate)
                     Else                                                           '           ARREARS
'                        !DateFrom = DateAdd(Right(adoPRRstRC!CalDays, 1), Left(adoPRRstRC!CalDays, Len(adoPRRstRC!CalDays) - 1), adoPRRstRC!BRNextDueDate) 'CDate(adoprRstRC!BRNextDueDate)
                        !dateFrom = ArrFromDate(adoPRRstRC.Fields.Item("BRNextDueDate"), _
                                                adoPRRstRC.Fields.Item("BRfrequency"), _
                                                adoPRRstRC.Fields.Item("BRDemandType"), _
                                                adoPRRstRC.Fields.Item("PropertyID"), _
                                                adoPRRstRC.Fields.Item("CalDays"), adoConn)
                     End If
                     !DateTO = adoRstLeaseDtl!EndDate
                     'new requirement from WD they want  Startdate and end date as 2nd ref 2019-11-18
                     !SageRef = Format(!dateFrom, "dd/mm/yy") & "-" & Format(!DateTO, "dd/mm/yy")
                     'anol check here this line not executing when you say non pro-rata demand this is coming only when prorata
                     'Here one issue we need to resolve calculation should not be based on from date and todate rather its should be based on frequency table anol 2020-06-09 issue 853
                      '!amount = RoundingNumber(Val(adoPRRstRC!BRTotal / szaPartofYear(adoPRRstRC("ID").Value)), 2)
                     
                     If DateDiff("d", adoRstLeaseDtl!EndDate, adoPRRstRC.Fields.Item("FDD")) = 1 Then
                            'do not calculatate prorata ,calculate full
                            !amount = RoundingNumber(Val(adoPRRstRC.Fields.Item("BRTotal") / szaPartofYear(adoPRRstRC("ID").Value)), 2)
                     Else
                            'calculate prorata and also add 1 day with datediff
                            !amount = RoundingNumber((Val(adoPRRstRC.Fields.Item("BRTotal")) / 365) * (DateDiff("D", !dateFrom, !DateTO) + 1), 2)
                     End If
                     '!amount = RoundingNumber((Val(adoPRRstRC!BRTotal) / 365) * (DateDiff("D", !DateFrom, !DateTo) + 1), 2)
                     !VATAMOUNT = RoundingNumber(!amount * GetVAT_Tenant(adoRstLeaseDtl!SageAccountNumber, adoConn) / 100, 2)
                     !TotalAmount = !amount + !VATAMOUNT

                     !SageDepartment = adoPRRstRC!RentChargeDept ' DepartmentID(adoRstLeaseDtl!SageAccountNumber, adoRstLeaseDtl!UnitNumber, "Rent Charges", adoConn)
                     !FrequencyID = adoPRRstRC!BRfrequency
                     !ChargingFigure = adoPRRstRC!spare2
                     !ChargingMethod = CByte(IIf(IsNull(adoPRRstRC!ChargingMethod), "", adoPRRstRC!ChargingMethod))
                     .Update
                  End With

                  UpdateNextDueDate "LRentCharges", "BRNextDueDate", dtNtDueDate, "RentCharges", adoPRRstRC!RentCharges, adoConn
                  MarkGPD "LRentCharges", True, "RentCharges", adoPRRstRC!RentCharges, adoConn

                  BRcount = BRcount + 1
                  iSerial = iSerial + 1
               End If
               adoPRRstRC.MoveNext
            Wend
'            adoPRRstRC.Close
'            Set adoPRRstRC = Nothing
'*********************************************************************************************************
'   Service Charge demands
'*********************************************************************************************************
            ReDim szSCYR(RecordCount(adoRstSC), 2) As String
            'Exit Sub
            SCYRCount = 0
            While Not adoRstSC.EOF
               If IsNull(adoRstSC!StopSC) Or adoRstSC!StopSC = "" Then
                  bProceed = True
               Else
                  bProceed = IIf(DateDiff("d", adoRstSC!SCNextDueDate, CDate(adoRstSC!StopSC)) > 0, True, False)
               End If

               If adoRstLeaseDtl!SCPayable = "Y" And _
                  DateDiff("d", Date, IIf(adoRstSC!SCNextDueDate = "", _
                     DateAdd("d", -1, Date), adoRstSC!SCNextDueDate)) <= DaysB4Due And bProceed And _
                     IsDmdTypeSel(adoRstSC.Fields("SCDemandType").Value) Then
                  iChildId = iChildId + 1

                  szDes = IIf(IIf(IsNull(adoRstSC!SCDesc), "", adoRstSC!SCDesc) = "", DemandTypeName(adoRstSC!SCDemandType, adoConn), adoRstSC!SCDesc)

                  dtNtDueDate = FindNextDueDate(adoRstSC!SCNextDueDate, _
                                    adoRstSC!SCFrequency, adoRstSC!SCDemandType, adoRstSC!propertyID, adoConn)
                  dtFDD = FindNextDueDate(dtNtDueDate, _
                                          adoRstSC!SCFrequency, _
                                          adoRstSC!SCDemandType, _
                                          adoRstSC!propertyID, adoConn)

                  With adoRstSplitDemand
                     .AddNew
                     !DSR = UniqueID()
                     !splitID = iChildId
                     !DEMANDID = CLng(laBankID(2, 1))
                     !A_M = "A"
                     !NominalCodeforAmount = PartString(szaNCode(adoRstSC!SCDemandType), 0, " # ")
                     !NominalNameforAmount = PartString(szaNCName(adoRstSC!SCDemandType), 0, " # ")
                     !NominalCodeForVAT = PartString(szaNCode(adoRstSC!SCDemandType), 1, " # ")
                     !NominalNameforVAT = PartString(szaNCName(adoRstSC!SCDemandType), 1, " # ")
                     !NominalCodeForTotal = PartString(szaNCode(adoRstSC!SCDemandType), 2, " # ")
                     !NominalNameforTotal = PartString(szaNCName(adoRstSC!SCDemandType), 2, " # ")
                     'if I say prorate Service charge this is coming here I dont know Why there is no separate procedure for this anol Mark 1
                     !amount = RoundingNumber(adoRstSC!SCAmount, 2)
                     !VATAMOUNT = RoundingNumber(adoRstSC!SCAmount * GetVAT_Tenant(adoRstLeaseDtl!SageAccountNumber, adoConn) / 100, 2)
                     !TotalAmount = !amount + !VATAMOUNT
                     '!SageRef = szaPrefix(adoRstSC!SCDemandType) & Format(SlNumber("SI", "DemandRecords", adoConn), "00000")
                     !DueDate = Format(adoRstSC!SCNextDueDate, "dd/mm/yyyy")
                     !VATMonth = Month(adoRstSC!SCNextDueDate)
                     !TypeOfDemand = adoRstSC!SCDemandType
                     !description = szDes
                     !DemandStatement = True
                     !VAT_CODE = GetVATCode_Tenant(adoRstLeaseDtl!SageAccountNumber, adoConn)
                     If !VAT_CODE = -1 Then
                        !VAT_CODE = Null
                     End If
                     If Left(adoRstSC!CalDays, 1) <> "-" Then
'                                ADVANCE
                        !dateFrom = CDate(adoRstSC!SCNextDueDate)
                        !DateTO = DateAdd("d", -1, dtNtDueDate)
                     Else
'                                ARREARS
'                        !DateFrom = DateAdd(Right(adoRstSC!CalDays, 1), Left(adoRstSC!CalDays, Len(adoRstSC!CalDays) - 1), adoRstSC!SCNextDueDate) 'CDate(adoRstSC!SCNextDueDate)
                        !dateFrom = ArrFromDate(adoRstSC!SCNextDueDate, _
                                                adoRstSC!SCFrequency, _
                                                adoRstSC!SCDemandType, _
                                                adoRstSC!propertyID, _
                                                adoRstSC!CalDays, adoConn)
                        !DateTO = DateAdd("d", -1, adoRstSC!SCNextDueDate)
                     End If
                     szSCYR(SCYRCount, 0) = adoRstSC!ServiceCharge
                     szSCYR(SCYRCount, 1) = adoRstSC!SCDemandType
                     szSCYR(SCYRCount, 2) = !DateTO
                     'new requirement from WD they want  Startdate and end date as 2nd ref 2019-11-18
                     !SageRef = Format(!dateFrom, "dd/mm/yy") & "-" & Format(!DateTO, "dd/mm/yy")
                     !SageDepartment = adoRstSC!ServiceChargeDept 'DepartmentID(adoRstLeaseDtl!SageAccountNumber, adoRstLeaseDtl!UnitNumber, "Service Charges", adoConn)
                     !FrequencyID = adoRstSC!SCFrequency
                     !ChargingFigure = adoRstSC!CMFigure
                     !ChargingMethod = IIf(IsNull(adoRstSC!ChargingMethod), 0, adoRstSC!ChargingMethod)
                     .Update
                  End With

                  UpdateNextDueDate "LServiceCharges", "SCNextDueDate", dtNtDueDate, "ServiceCharge", adoRstSC!ServiceCharge, adoConn
                  SetFDD "LServiceCharges", "FDD", dtFDD, "ServiceCharge", adoRstSC!ServiceCharge, adoConn
                  SCYRCount = SCYRCount + 1
                  SCcount = SCcount + 1
                  iSerial = iSerial + 1
               End If
               adoRstSC.MoveNext
            Wend
            adoRstSC.Close
            Set adoRstSC = Nothing
            For SCYRCount = 0 To UBound(szSCYR, 1) - 1
                    If szSCYR(SCYRCount, 0) <> "" Then
                        'here we set SCTotal=0,SCAmount=0 when sc year end type is completed setting the amount to zero
                        adoConn.Execute "Update LServiceCharges L,DemandTypes D  Set SCTotal=0,SCAmount=0,SCYEDate=#" & szSCYR(SCYRCount, 2) & "# where L.SCDemandType =D.ID AND D.CategoryCode=5 AND ServiceCharge='" & szSCYR(SCYRCount, 0) & "'"
                        'Here I am going to update the sc year end flag at globalSC table 2022-06-21
                        'adoconn.Execute "Update LServiceCharges L,GlobalSC AS GSC,DemandTypes D  Set GSC.SCYearEndGenerated=true  where L.SCDemandType =D.ID AND D.CategoryCode=5 AND ServiceCharge='" & szSCYR(SCYRCount, 0) & "'"
                        adoConn.Execute "UPDATE LServiceCharges, GlobalSC AS GSC, LeaseDetails AS L,Units AS U, Frequencies AS F,  Property AS P, DemandTypes D " & _
                        "SET GSC.SCYearEndGenerated=true  Where cstr(GSC.Fund) = LServiceCharges.ServiceChargeDept AND L.UnitNumber = U.UnitNumber AND " & _
                        "L.LeaseID = LServiceCharges.LeaseID AND LServiceCharges.SCFrequency = F.ID AND U.PropertyID = GSC.PropertyID AND " & _
                        "P.CBY = GSC.FinancialYear AND U.PropertyID = P.PropertyID AND " & _
                        "GSC.SCYearEndGenerated=false AND LServiceCharges.SCDemandType =D.ID AND LServiceCharges.ServiceCharge='" & szSCYR(SCYRCount, 0) & "'"
                    End If
            Next
'*********************************************************************************************************
'           Service Charge demands       ---->    PRO-RATA
'*********************************************************************************************************
            ReDim szSCYR(RecordCount(adoPRRstSC), 2) As String
            SCYRCount = 0
            While Not adoPRRstSC.EOF
               If IsNull(adoPRRstSC!StopSC) Or adoPRRstSC!StopSC = "" Then
                  bProceed = True
               Else
                  bProceed = IIf(DateDiff("d", adoPRRstSC!SCNextDueDate, CDate(adoPRRstSC!StopSC)) > 0, True, False)
               End If

               If adoRstLeaseDtl!SCPayable = "Y" And _
                  DateDiff("d", Date, IIf(adoPRRstSC!SCNextDueDate = "", _
                     DateAdd("d", -1, Date), adoPRRstSC!SCNextDueDate)) <= DaysB4Due And bProceed And _
                     IsDmdTypeSel(adoPRRstSC.Fields("SCDemandType").Value) Then
                  iChildId = iChildId + 1
'      **** Insert the Header info in the DemandSplitRecords table

                  szDes = IIf(IIf(IsNull(adoPRRstSC!SCDesc), "", adoPRRstSC!SCDesc) = "", DemandTypeName(adoPRRstSC!SCDemandType, adoConn), adoPRRstSC!SCDesc)

                  dtNtDueDate = FindNextDueDate(adoPRRstSC!SCNextDueDate, _
                                    adoPRRstSC!SCFrequency, adoPRRstSC!SCDemandType, adoPRRstSC!propertyID, adoConn)

                  With adoRstSplitDemand
                     .AddNew
                     !DSR = UniqueID()
                     !splitID = iChildId
                     !DEMANDID = CLng(laBankID(2, 1))
                     !A_M = "A"
                     !NominalCodeforAmount = PartString(szaNCode(adoPRRstSC!SCDemandType), 0, " # ")
                     !NominalNameforAmount = PartString(szaNCName(adoPRRstSC!SCDemandType), 0, " # ")
                     !NominalCodeForVAT = PartString(szaNCode(adoPRRstSC!SCDemandType), 1, " # ")
                     !NominalNameforVAT = PartString(szaNCName(adoPRRstSC!SCDemandType), 1, " # ")
                     !NominalCodeForTotal = PartString(szaNCode(adoPRRstSC!SCDemandType), 2, " # ")
                     !NominalNameforTotal = PartString(szaNCName(adoPRRstSC!SCDemandType), 2, " # ")
'                     !SageRef = szaPrefix(adoPRRstSC!SCDemandType) & Format(SlNumber("SI", "DemandRecords", adoConn), "00000")
                     !DueDate = Format(adoPRRstSC!SCNextDueDate, "dd/mm/yyyy")
                     !VATMonth = Month(adoPRRstSC!SCNextDueDate)
                     !TypeOfDemand = adoPRRstSC!SCDemandType
                     !description = szDes
                     !DemandStatement = True
                     !VAT_CODE = GetVATCode_Tenant(adoRstLeaseDtl!SageAccountNumber, adoConn)
                     If !VAT_CODE = -1 Then
                        !VAT_CODE = Null
                     End If
                     If Left(adoPRRstSC!CalDays, 1) <> "-" Then                           '  ADVANCE
                        !dateFrom = CDate(adoPRRstSC!SCNextDueDate)
                     Else                                                                 '  ARREARS
'                        !DateFrom = DateAdd(Right(adoPRRstSC!CalDays, 1), Left(adoPRRstSC!CalDays, Len(adoPRRstSC!CalDays) - 1), adoPRRstSC!SCNextDueDate) 'CDate(adoPRRstSC!SCNextDueDate)
                        !dateFrom = ArrFromDate(adoPRRstSC!SCNextDueDate, _
                                                adoPRRstSC!SCFrequency, _
                                                adoPRRstSC!SCDemandType, _
                                                adoPRRstSC!propertyID, _
                                                adoPRRstSC!CalDays, adoConn)
                     End If
                     !DateTO = adoRstLeaseDtl!EndDate
                     'new requirement from WD they want  Startdate and end date as 2nd ref 2019-11-18 anol Mark 2
                     !SageRef = Format(!dateFrom, "dd/mm/yy") & "-" & Format(!DateTO, "dd/mm/yy")
                     If DateDiff("d", adoRstLeaseDtl!EndDate, adoPRRstSC.Fields.Item("FDD")) = 1 Then
                           'do not calculatate prorata ,calculate full
                           !amount = RoundingNumber(Val(adoPRRstSC.Fields.Item("SCTotal") / szaPartofYear(adoPRRstSC("ID").Value)), 2)
                     Else
                           'calculate prorata and also add 1 day with datediff
                            !amount = RoundingNumber((Val(adoPRRstSC.Fields.Item("SCTotal")) / 365) * (DateDiff("D", !dateFrom, !DateTO) + 1), 2)
                     End If
                     szSCYR(SCYRCount, 0) = adoPRRstSC!ServiceCharge
                     szSCYR(SCYRCount, 1) = adoPRRstSC!SCDemandType
                     szSCYR(SCYRCount, 2) = !DateTO
                  
                     '!amount = RoundingNumber((Val(adoPRRstSC!SCTotal) / 365) * DateDiff("D", !DateFrom, !DateTo), 2)
                     !VATAMOUNT = RoundingNumber(!amount * GetVAT_Tenant(adoRstLeaseDtl!SageAccountNumber, adoConn) / 100, 2)
                     !TotalAmount = !amount + !VATAMOUNT

                     !SageDepartment = adoPRRstSC!ServiceChargeDept 'DepartmentID(adoRstLeaseDtl!SageAccountNumber, adoRstLeaseDtl!UnitNumber, "Service Charges", adoConn)
                     !FrequencyID = adoPRRstSC!SCFrequency
                     !ChargingFigure = adoPRRstSC!CMFigure
                     !ChargingMethod = IIf(IsNull(adoPRRstSC!ChargingMethod), 0, adoPRRstSC!ChargingMethod)
                     .Update
                  End With

                  UpdateNextDueDate "LServiceCharges", "SCNextDueDate", dtNtDueDate, "ServiceCharge", adoPRRstSC!ServiceCharge, adoConn
                  MarkGPD "LServiceCharges", True, "ServiceCharge", adoPRRstSC!ServiceCharge, adoConn
                  SCYRCount = SCYRCount + 1
                  SCcount = SCcount + 1
                  iSerial = iSerial + 1
               End If
               adoPRRstSC.MoveNext
            Wend
            adoPRRstSC.Close
            Set adoPRRstSC = Nothing
            For SCYRCount = 0 To UBound(szSCYR, 1) - 1
                    If szSCYR(SCYRCount, 0) <> "" Then
                        adoConn.Execute "Update LServiceCharges L,DemandTypes D  Set SCTotal=0,SCAmount=0,SCYEDate=#" & szSCYR(SCYRCount, 2) & "# where L.SCDemandType =D.ID " & _
                                         "AND D.CategoryCode=5 AND ServiceCharge='" & szSCYR(SCYRCount, 0) & "'"
                    End If
            Next
'*********************************************************************************************************
'   Insurance Charge demands
'*********************************************************************************************************
            While Not adoRstIns.EOF
               If IsNull(adoRstIns!StopIC) Or adoRstIns!StopIC = "" Then
                  bProceed = True
               Else
                  bProceed = IIf(DateDiff("d", adoRstIns!InsuranceNextDueDate, CDate(adoRstIns!StopIC)) > 0, True, False)
               End If

               If adoRstLeaseDtl!InsurancePayable = "Y" And _
                  DateDiff("d", Date, IIf(adoRstIns!InsuranceNextDueDate = "", _
                     DateAdd("d", -1, Date), adoRstIns!InsuranceNextDueDate)) <= DaysB4Due And bProceed And _
                     IsDmdTypeSel(adoRstIns.Fields("InsuranceDemandType").Value) Then
                  iChildId = iChildId + 1
'      **** Insert the Header info in the DemandSplitRecords table

                  szDes = IIf(IIf(IsNull(adoRstIns!InsDesc), "", adoRstIns!InsDesc) = "", DemandTypeName(adoRstIns!InsuranceDemandType, adoConn), adoRstIns!InsDesc)

                  dtNtDueDate = FindNextDueDate(adoRstIns!InsuranceNextDueDate, _
                                 adoRstIns!InsuranceFrequency, _
                                 adoRstIns!InsuranceDemandType, adoRstLeaseDtl!propertyID, adoConn)
                  dtFDD = FindNextDueDate(dtNtDueDate, _
                                                adoRstIns!InsuranceFrequency, _
                                                adoRstIns!InsuranceDemandType, _
                                                adoRstIns!propertyID, adoConn)

'                  If Not adoRstLeaseDtl.Fields("OLED").Value Then
'                     dtEndDate = Format(DateAdd("d", 1, adoRstLeaseDtl!EndDate), "dd/mm/yyyy")
'                     If DateDiff("d", dtEndDate, dtNtDueDate) > 0 Then dtNtDueDate = dtEndDate
'                  End If

                  With adoRstSplitDemand
                     .AddNew
                     !DSR = UniqueID()
                     !splitID = iChildId
                     !DEMANDID = CLng(laBankID(3, 1))
                     !A_M = "A"
                     !NominalCodeforAmount = PartString(szaNCode(adoRstIns!InsuranceDemandType), 0, " # ")
                     !NominalNameforAmount = PartString(szaNCName(adoRstIns!InsuranceDemandType), 0, " # ")
                     !NominalCodeForVAT = PartString(szaNCode(adoRstIns!InsuranceDemandType), 1, " # ")
                     !NominalNameforVAT = PartString(szaNCName(adoRstIns!InsuranceDemandType), 1, " # ")
                     !NominalCodeForTotal = PartString(szaNCode(adoRstIns!InsuranceDemandType), 2, " # ")
                     !NominalNameforTotal = PartString(szaNCName(adoRstIns!InsuranceDemandType), 2, " # ")
                     !amount = RoundingNumber(adoRstIns!InsuranceEachPeriod, 2)
                     !VATAMOUNT = RoundingNumber(adoRstIns!InsuranceEachPeriod * GetVAT_Tenant(adoRstLeaseDtl!SageAccountNumber, adoConn) / 100, 2)
                     !TotalAmount = !amount + !VATAMOUNT
'                     !SageRef = szaPrefix(adoRstIns!InsuranceDemandType) & Format(SlNumber("SI", "DemandRecords", adoConn), "00000")
                     !DueDate = Format(adoRstIns!InsuranceNextDueDate, "dd/mm/yyyy")
                     !VATMonth = Month(adoRstIns!InsuranceNextDueDate)
                     !TypeOfDemand = adoRstIns!InsuranceDemandType
                     !description = szDes
                     !DemandStatement = True
                     !VAT_CODE = GetVATCode_Tenant(adoRstLeaseDtl!SageAccountNumber, adoConn)
                     If !VAT_CODE = -1 Then
                        !VAT_CODE = Null
                     End If
                     If Left(adoRstIns!CalDays, 1) <> "-" Then
                     '           ADVANCE
                        !dateFrom = CDate(adoRstIns!InsuranceNextDueDate)
                        !DateTO = DateAdd("d", -1, dtNtDueDate)
                     Else
                     '           ARREARS
'                        !DateFrom = DateAdd(Right(adoRstIns!CalDays, 1), Left(adoRstIns!CalDays, Len(adoRstIns!CalDays) - 1), adoRstIns!InsuranceNextDueDate) 'CDate(adoRstIns!InsuranceNextDueDate)
                        !dateFrom = ArrFromDate(adoRstIns!InsuranceNextDueDate, _
                                                adoRstIns!InsuranceFrequency, _
                                                adoRstIns!InsuranceDemandType, _
                                                adoRstIns!propertyID, _
                                                adoRstIns!CalDays, adoConn)
                        !DateTO = DateAdd("d", -1, adoRstIns!InsuranceNextDueDate)
                     End If
                     'new requirement from WD they want  Startdate and end date as 2nd ref 2019-11-18
                     !SageRef = Format(!dateFrom, "dd/mm/yy") & "-" & Format(!DateTO, "dd/mm/yy")
                     !SageDepartment = adoRstIns!InsuranceDept 'DepartmentID(adoRstLeaseDtl!SageAccountNumber, adoRstLeaseDtl!UnitNumber, "Insurance Charge", adoConn)
                     !FrequencyID = adoRstIns!InsuranceFrequency
                     !ChargingFigure = adoRstIns!ChargingFigure
                     !ChargingMethod = IIf(IsNull(adoRstIns!ChargingType), 0, adoRstIns!ChargingType)
                     .Update
                  End With

                  UpdateNextDueDate "LInsuranceCharges", "InsuranceNextDueDate", dtNtDueDate, "InsCharges", adoRstIns!InsCharges, adoConn
                  SetFDD "LInsuranceCharges", "FDD", dtFDD, "InsCharges", adoRstIns!InsCharges, adoConn

                  ICcount = ICcount + 1
                  iSerial = iSerial + 1
               End If
               adoRstIns.MoveNext
            Wend
            adoRstIns.Close
            Set adoRstIns = Nothing
'*********************************************************************************************************
'   Insurance Charge demands                 -           PRO-RATA
'*********************************************************************************************************
            While Not adoPRRstIns.EOF
               If IsNull(adoPRRstIns!StopIC) Or adoPRRstIns!StopIC = "" Then
                  bProceed = True
               Else
                  bProceed = IIf(DateDiff("d", adoPRRstIns!InsuranceNextDueDate, CDate(adoPRRstIns!StopIC)) > 0, True, False)
               End If

               If adoRstLeaseDtl!InsurancePayable = "Y" And _
                  DateDiff("d", Date, IIf(adoPRRstIns!InsuranceNextDueDate = "", _
                     DateAdd("d", -1, Date), adoPRRstIns!InsuranceNextDueDate)) <= DaysB4Due And bProceed And _
                     IsDmdTypeSel(adoPRRstIns.Fields("InsuranceDemandType").Value) Then
                  iChildId = iChildId + 1
'      **** Insert the Header info in the DemandSplitRecords table

                  szDes = IIf(IIf(IsNull(adoPRRstIns!InsDesc), "", adoPRRstIns!InsDesc) = "", DemandTypeName(adoPRRstIns!InsuranceDemandType, adoConn), adoPRRstIns!InsDesc)

                  dtNtDueDate = FindNextDueDate(adoPRRstIns!InsuranceNextDueDate, _
                                 adoPRRstIns!InsuranceFrequency, _
                                 adoPRRstIns!InsuranceDemandType, adoRstLeaseDtl!propertyID, adoConn)
'                  dtFDD = FindNextDueDate(dtNtDueDate, _
                                                adoPRRstIns!InsuranceFrequency, _
                                                adoPRRstIns!InsuranceDemandType, _
                                                adoPRRstIns!PropertyID, adoConn)

'                  If Not adoRstLeaseDtl.Fields("OLED").Value Then
'                     dtEndDate = Format(DateAdd("d", 1, adoRstLeaseDtl!EndDate), "dd/mm/yyyy")
'                     If DateDiff("d", dtEndDate, dtNtDueDate) > 0 Then dtNtDueDate = dtEndDate
'                  End If

                  With adoRstSplitDemand
                     .AddNew
                     !DSR = UniqueID()
                     !splitID = iChildId
                     !DEMANDID = CLng(laBankID(3, 1))
                     !A_M = "A"
                     !NominalCodeforAmount = PartString(szaNCode(adoPRRstIns!InsuranceDemandType), 0, " # ")
                     !NominalNameforAmount = PartString(szaNCName(adoPRRstIns!InsuranceDemandType), 0, " # ")
                     !NominalCodeForVAT = PartString(szaNCode(adoPRRstIns!InsuranceDemandType), 1, " # ")
                     !NominalNameforVAT = PartString(szaNCName(adoPRRstIns!InsuranceDemandType), 1, " # ")
                     !NominalCodeForTotal = PartString(szaNCode(adoPRRstIns!InsuranceDemandType), 2, " # ")
                     !NominalNameforTotal = PartString(szaNCName(adoPRRstIns!InsuranceDemandType), 2, " # ")
'                     !SageRef = szaPrefix(adoPRRstIns!InsuranceDemandType) & Format(SlNumber("SI", "DemandRecords", adoConn), "00000")
                     !DueDate = Format(adoPRRstIns!InsuranceNextDueDate, "dd/mm/yyyy")
                     !VATMonth = Month(adoPRRstIns!InsuranceNextDueDate)
                     !TypeOfDemand = adoPRRstIns!InsuranceDemandType
                     !description = szDes
                     !DemandStatement = True
                     !VAT_CODE = GetVATCode_Tenant(adoRstLeaseDtl!SageAccountNumber, adoConn)
                     If !VAT_CODE = -1 Then
                        !VAT_CODE = Null
                     End If
                     If Left(adoPRRstIns!CalDays, 1) <> "-" Then                     '           ADVANCE
                        !dateFrom = CDate(adoPRRstIns!InsuranceNextDueDate)
                     Else                                                            '           ARREARS
'                        !DateFrom = DateAdd(Right(adoPRRstIns!CalDays, 1), Left(adoPRRstIns!CalDays, Len(adoPRRstIns!CalDays) - 1), adoPRRstIns!InsuranceNextDueDate) 'CDate(adoPRRstIns!InsuranceNextDueDate)
                        !dateFrom = ArrFromDate(adoPRRstIns!InsuranceNextDueDate, _
                                                adoPRRstIns!InsuranceFrequency, _
                                                adoPRRstIns!InsuranceDemandType, _
                                                adoPRRstIns!propertyID, _
                                                adoPRRstIns!CalDays, adoConn)
                     End If
                     !DateTO = adoRstLeaseDtl!EndDate
                     'new requirement from WD they want  Startdate and end date as 2nd ref 2019-11-18
                      !SageRef = Format(!dateFrom, "dd/mm/yy") & "-" & Format(!DateTO, "dd/mm/yy")
                    ' anol 2020-06-11
                    If DateDiff("d", adoRstLeaseDtl!EndDate, adoPRRstIns.Fields.Item("FDD")) = 1 Then
                       'do not calculatate prorata ,calculate full
                       !amount = RoundingNumber(Val(adoPRRstIns.Fields.Item("TotalYearlyInsurance") / szaPartofYear(adoPRRstIns("ID").Value)), 2)
                    Else
                       'calculate prorata and also add 1 day with datediff
                        !amount = RoundingNumber((Val(adoPRRstIns.Fields.Item("TotalYearlyInsurance")) / 365) * (DateDiff("D", !dateFrom, !DateTO) + 1), 2)
                    End If
                    ' !amount = RoundingNumber((Val(adoPRRstIns!TotalYearlyInsurance) / 365) * DateDiff("D", !DateFrom, !DateTo), 2)
                     !VATAMOUNT = RoundingNumber(!amount * GetVAT_Tenant(adoRstLeaseDtl!SageAccountNumber, adoConn) / 100, 2)
                     !TotalAmount = !amount + !VATAMOUNT

                     !SageDepartment = adoPRRstIns!InsuranceDept 'DepartmentID(adoRstLeaseDtl!SageAccountNumber, adoRstLeaseDtl!UnitNumber, "Insurance Charge", adoConn)
                     !FrequencyID = adoPRRstIns!InsuranceFrequency
                     !ChargingFigure = adoPRRstIns!ChargingFigure
                     !ChargingMethod = IIf(IsNull(adoPRRstIns!ChargingType), 0, adoPRRstIns!ChargingType)
                     .Update
                  End With

                  UpdateNextDueDate "LInsuranceCharges", "InsuranceNextDueDate", dtNtDueDate, "InsCharges", adoPRRstIns!InsCharges, adoConn
                  MarkGPD "LInsuranceCharges", True, "InsCharges", adoPRRstIns!InsCharges, adoConn

                  ICcount = ICcount + 1
                  iSerial = iSerial + 1
               End If
               adoPRRstIns.MoveNext
            Wend

'*********************************************************************************************************
'   Utility Charge demands
'*********************************************************************************************************
            While Not adoRstUC.EOF
               If adoRstLeaseDtl!UtilityUsage = "Y" Then
                  iChildId = iChildId + 1

                  adoRstSplitDemand.AddNew
                  adoRstSplitDemand!DSR = UniqueID()
                  adoRstSplitDemand!splitID = iChildId
                  adoRstSplitDemand!DEMANDID = CLng(laBankID(4, 1))
                  adoRstSplitDemand!A_M = "A"
                  adoRstSplitDemand!NominalCodeforAmount = PartString(szaNCode(adoRstUC!DemandType), 0, " # ")
                  adoRstSplitDemand!NominalNameforAmount = PartString(szaNCName(adoRstUC!DemandType), 0, " # ")
                  adoRstSplitDemand!NominalCodeForVAT = PartString(szaNCode(adoRstUC!DemandType), 1, " # ")
                  adoRstSplitDemand!NominalNameforVAT = PartString(szaNCName(adoRstUC!DemandType), 1, " # ")
                  adoRstSplitDemand!NominalCodeForTotal = PartString(szaNCode(adoRstUC!DemandType), 2, " # ")
                  adoRstSplitDemand!NominalNameforTotal = PartString(szaNCName(adoRstUC!DemandType), 2, " # ")
                  adoRstSplitDemand!amount = RoundingNumber(adoRstUC!Balance, 2)
                  adoRstSplitDemand!VATAMOUNT = 0
                  adoRstSplitDemand!TotalAmount = adoRstSplitDemand!amount + adoRstSplitDemand!VATAMOUNT
'                  adoRstSplitDemand!SageRef = szaPrefix(adoRstUC!DemandType) & Format(SlNumber("SI", "DemandRecords", adoConn), "00000")
                  adoRstSplitDemand!DueDate = Format(adoRstUC!DueDate, "dd/mm/yyyy")
                  adoRstSplitDemand!VATMonth = Month(adoRstUC!DueDate)
                  adoRstSplitDemand!TypeOfDemand = adoRstUC!DemandType
                  adoRstSplitDemand!description = adoRstUC!description
                  adoRstSplitDemand!DemandStatement = True
                  adoRstSplitDemand!VAT_CODE = GetVATCode_Tenant(adoRstLeaseDtl!SageAccountNumber, adoConn)
                  If adoRstSplitDemand!VAT_CODE = -1 Then
                        adoRstSplitDemand!VAT_CODE = Null
                  End If
                  adoRstSplitDemand!dateFrom = CDate(adoRstUC!ReadingDate)
                  adoRstSplitDemand!DateTO = CDate(adoRstUC!DueDate)
                  'new requirement from WD they want  Startdate and end date as 2nd ref 2019-11-18
                  adoRstSplitDemand!SageRef = Format(adoRstSplitDemand!dateFrom, "dd/mm/yy") & "-" & Format(adoRstSplitDemand!DateTO, "dd/mm/yy")
                  adoRstSplitDemand!FrequencyID = 0
                  adoRstSplitDemand.Update

                  UpdateUtility adoRstUC!UtilityUsage, adoConn

                  SCcount = SCcount + 1
                  iSerial = iSerial + 1
               End If
               adoRstUC.MoveNext
            Wend
            adoRstUC.Close
            Set adoRstUC = Nothing
         End If
         adoRstLeaseDtl.MoveNext
      Wend

'      adoRstRC.Close
      Set adoRstRC = Nothing
'      adoRstSC.Close
      Set adoRstSC = Nothing
'      adoPRRstSC.Close
      Set adoPRRstSC = Nothing
'      adoRstIns.Close
      Set adoRstIns = Nothing
'      adoRstUC.Close
      Set adoRstUC = Nothing
'      adoPRRstRC.Close
      Set adoPRRstRC = Nothing
'      adoPRRstIns.Close
      Set adoPRRstIns = Nothing
      adoRstLeaseDtl.Close
      Set adoRstLeaseDtl = Nothing
      adoRstDemandRec.Close
      Set adoRstDemandRec = Nothing
      adoRstSplitDemand.Close
      Set adoRstSplitDemand = Nothing
   End If

'   MousePointer = vbDefault

   Dim Msg As String

   Msg = Msg & BRcount & " Demands for Rent were generated." & Chr(13)
   Msg = Msg & SCcount & " Demands for Service Charge were generated." & Chr(13)
   Msg = Msg & IPcount & " Demands for Interest Payment were generated." & Chr(13)
   Msg = Msg & ICcount & " Demands for Insurance Charge were generated." & Chr(13)
   Msg = Msg & "A total of " & BRcount + SCcount + IPcount + ICcount & " demands were generated."
   If BRcount + SCcount + IPcount + ICcount > 0 Then
        frmMMain.Leasee1_LesseList_isUptoDate = False
        frmMMain.Leasee4_LesseList_isUptoDate = False
        frmMMain.frmDemand3_LesseList_isUptoDate = False
     End If
' added by anol 20170112
' an error was occuring on the next procedure ......"no transaction to save"
   If adoConn.State = 1 Then
        adoConn.Close
   End If
   adoConn.Open getConnectionString
'  Export Transactions to Nominal Ledger (NLPosting table)
   Export_SInSC_2_NL adoConn
'--------------------------------------------------------------------------------------

   MsgBox Msg, vbOKOnly + vbInformation, "Demands Generated"
   Exit Sub

ErrH:
       'This can only pick up error 13 (type mis-match) and it is at the users discretion to not enter a date.
       MsgBox Err.Number & "-(Auto Con Demand) " & Err.description, vbOKOnly, "Error"
End Sub
Private Sub WriteServiceChargeCons(adoConn As ADODB.Connection, adoRstLeaseDtl As ADODB.Recordset, adoRstDemandRec As ADODB.Recordset, _
        adoRstSplitDemand As ADODB.Recordset, DaysB4Due As Integer, laBankID() As String, szaNCode() As String, _
        szaNCName() As String, szaPartofYear() As Integer, SCcount As Integer, SCYRCount As Integer)
    Dim bSC As Boolean
    Dim bProceed As Boolean
    Dim bPRSC As Boolean
    Dim bSCNeg As Boolean
    Dim bPRSCNeg As Boolean
    Dim szSQLStr As String
    Dim lDemand As Long
    Dim lBatch As Long

    Dim iChildId As Long
    Dim iSerial As Long
    Dim szDes As String
    Dim dtNtDueDate As Date
    Dim dtFDD As Date
    Dim adoRstSC As New ADODB.Recordset
    Dim adoRstSCNeg As New ADODB.Recordset
    Dim adoPRRstSC As New ADODB.Recordset
    Dim adoPRRstSCNeg As New ADODB.Recordset
    
   
         
'*********************************************************************************************************
         bSCNeg = False                'SERVICE CHARGE Negative Charge amount-> Credit note
'*********************************************************************************************************
'************************************************************************************************
'   Service Charge demands   For negative charge amount -> Credit note
'************************************************************************************************
         szSQLStr = "SELECT S.ServiceCharge, S.LeaseID, " & _
                        "S.SCFrequency, S.SCPayableFrom, " & _
                        "S.SCNextDueDate, S.ChargingMethod, " & _
                        "S.CMFigure, S.SCTotal, S.SCAmount, " & _
                        "S.SCTOLimit, S.SCDemandType, StopSC, " & _
                        "S.ServiceChargeDept, S.SCDesc, " & _
                        "Units.PropertyID, " & _
                        "DemandTypes.Spare1 as ClientBankID, Frequencies.CalDays " & _
                    "FROM LServiceCharges AS S, LeaseDetails, Units, DemandTypes, Frequencies "

         If frmDemandTypesSel.cboGDPFreq.Column(0) = 0 Then

            szSQLStr = szSQLStr & _
                    "WHERE S.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                        "S.LeaseID = LeaseDetails.LeaseID AND (S.StopAutoDmd = FALSE OR LeaseDetails.GPrataDmd =FALSE OR " & _
                        "(S.StopAutoDmd = TRUE AND LeaseDetails.EndDate >= CDATE(S.FDD))) AND " & _
                        "S.SCAmount < 0 AND LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
                        "(ISNULL(S.spare3) OR S.spare3 <> 'DELETED') AND " & _
                        "S.SCDemandType = DemandTypes.ID AND " & _
                        "S.SCFrequency = Frequencies.ID AND LeaseDetails.Status;"
         Else

            szSQLStr = szSQLStr & _
                    "WHERE S.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                        "S.LeaseID = LeaseDetails.LeaseID AND (S.StopAutoDmd = FALSE OR  LeaseDetails.GPrataDmd =FALSE OR " & _
                        "(S.StopAutoDmd = TRUE AND LeaseDetails.EndDate >= CDATE(S.FDD))) AND " & _
                        "S.SCAmount < 0 AND LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
                        " (ISNULL(S.spare3) OR S.spare3 <> 'DELETED') AND " & _
                        "S.SCDemandType = DemandTypes.ID AND " & _
                        "S.SCFrequency = Frequencies.ID AND " & _
                        "Frequencies.ID = " & frmDemandTypesSel.cboGDPFreq.Column(0) & " AND LeaseDetails.Status;"
         End If
        'Remming S.SCAmount > 0 AND  2020-12-02 issue 898
         Set adoRstSC = New ADODB.Recordset

         adoRstSC.Open szSQLStr, adoConn, adOpenStatic, adLockReadOnly
         
        
         ReDim szSCYR(adoRstSC.RecordCount, 2) As String
         SCYRCount = 0
         While Not adoRstSC.EOF
            If IsNull(adoRstSC!StopSC) Or adoRstSC!StopSC = "" Then
               bProceed = True
            Else
               bProceed = IIf(DateDiff("d", adoRstSC!SCNextDueDate, CDate(adoRstSC!StopSC)) > 0, True, False)
            End If
            If adoRstLeaseDtl!SCPayable = "Y" And _
               DateDiff("d", Date, IIf(adoRstSC!SCNextDueDate = "", _
                  DateAdd("d", -1, Date), adoRstSC!SCNextDueDate)) <= DaysB4Due And bProceed And _
                     IsDmdTypeSel(adoRstSC.Fields("SCDemandType").Value) And _
               IIf(adoRstLeaseDtl!OLED, True, adoRstLeaseDtl!EndDate > adoRstSC!SCNextDueDate) Then
'**** Insert the Header info in the DemandRecords table
               lDemand = NextRef(adoConn, "DEMAND_REF")        'GET THE NEXT DEMAND ID
               With adoRstDemandRec
                  .AddNew
                  .Fields("DemandID").Value = lDemand
                  .Fields("CreatedBy").Value = User
                  .Fields("CreatedDate").Value = Now

                  lArrDemand(UBound(lArrDemand)) = lDemand
                  ReDim Preserve lArrDemand(UBound(lArrDemand) + 1) As Long

                  .Fields("BatchID").Value = lBatch
                  .Fields("SageAccountNumber").Value = adoRstLeaseDtl!SageAccountNumber
                  .Fields("TenantCompanyName").Value = adoRstLeaseDtl!CompanyName
                  .Fields("UnitNumber").Value = adoRstLeaseDtl!UnitNumber
                  .Fields("Source").Value = 1
                  .Fields("TransactionType").Value = 2
'   ***Here my thinking is, all type of demands due date is on the same day
'   ***If its not correct then i have to change the manual demands grid and the demand table & split table
                  .Fields("IssueDate").Value = Format(frmDemandTypesSel.txtInitialIssueDate.text, "dd/mm/yyyy")
                  .Fields("SageText").Value = "S/L " & adoRstLeaseDtl!SageAccountNumber
                  .Fields("IsPrinted").Value = False
                  .Fields("Spare1").Value = adoRstSC!ClientBankID
                  .Fields.Item("LeaseRef").Value = adoRstLeaseDtl!LeaseID
                  .Fields.Item("DmdSlNo").Value = SlNumber("SC", "DemandRecords", adoConn)
                  .Fields.Item("SuppText1").Value = adoRstLeaseDtl.Fields.Item("SuppText1").Value
                  .Fields.Item("SentByEmail").Value = IIf(adoRstLeaseDtl.Fields.Item("EmailDmd").Value, Null, 2)
                  .Fields.Item("PostingDate").Value = Format(frmDemandTypesSel.txtPostingDate.text, "dd mmmm yyyy")
                  'aded by anol 16 08 2016
                  .Fields.Item("SO").Value = True
                  .Fields.Item("LastModifiedBy").Value = User
                  .Fields.Item("LastModifiedDate").Value = Now
                  .Update
               End With

'               iChildId = 1
               szDes = IIf(IIf(IsNull(adoRstSC!SCDesc), "", adoRstSC!SCDesc) = "", DemandTypeName(adoRstSC!SCDemandType, adoConn), adoRstSC!SCDesc)

               dtNtDueDate = FindNextDueDate(adoRstSC!SCNextDueDate, _
                                 adoRstSC!SCFrequency, adoRstSC!SCDemandType, adoRstSC!propertyID, adoConn)
               dtFDD = FindNextDueDate(dtNtDueDate, _
                                             adoRstSC!SCFrequency, _
                                             adoRstSC!SCDemandType, _
                                             adoRstSC!propertyID, adoConn)

'               If Not adoRstLeaseDtl.Fields("OLED").Value Then
'                  dtEndDate = Format(DateAdd("d", 1, adoRstLeaseDtl!EndDate), "dd/mm/yyyy")
'                  If DateDiff("d", dtEndDate, dtNtDueDate) > 0 Then dtNtDueDate = dtEndDate
'               End If

               With adoRstSplitDemand
                  .AddNew
                  !DSR = UniqueID()
                  !splitID = 1
                  !DEMANDID = lDemand
                  !A_M = "A"
                  !NominalCodeforAmount = PartString(szaNCode(adoRstSC!SCDemandType), 0, " # ")
                  !NominalNameforAmount = PartString(szaNCName(adoRstSC!SCDemandType), 0, " # ")
                  !NominalCodeForVAT = PartString(szaNCode(adoRstSC!SCDemandType), 1, " # ")
                  !NominalNameforVAT = PartString(szaNCName(adoRstSC!SCDemandType), 1, " # ")
                  !NominalCodeForTotal = PartString(szaNCode(adoRstSC!SCDemandType), 2, " # ")
                  !NominalNameforTotal = PartString(szaNCName(adoRstSC!SCDemandType), 2, " # ")
                  !amount = Abs(CCur(adoRstSC!SCAmount))
                  !VATAMOUNT = Abs(RoundingNumber(adoRstSC!SCAmount * GetVAT_Tenant(adoRstLeaseDtl!SageAccountNumber, adoConn) / 100, 2))
                  !TotalAmount = Abs(!amount + !VATAMOUNT)
'                  !SageRef = szaPrefix(adoRstSC!SCDemandType) & Format(SlNumber("SI", "DemandRecords", adoConn), "00000")
                  !DueDate = Format(adoRstSC!SCNextDueDate.Value, "dd/mm/yyyy")
                  !VATMonth = Month(adoRstSC!SCNextDueDate)
                  !TypeOfDemand = adoRstSC!SCDemandType
                  
                  !description = szDes
                  !DemandStatement = True
                  !VAT_CODE = GetVATCode_Tenant(adoRstLeaseDtl!SageAccountNumber, adoConn)
                  If !VAT_CODE = -1 Then
                        !VAT_CODE = Null
                  End If
                  If Left(adoRstSC!CalDays, 1) <> "-" Then
   '                          ADVANCE
                     !dateFrom = CDate(adoRstSC!SCNextDueDate)
                     !DateTO = DateAdd("d", -1, dtNtDueDate)
                  Else
   '                          ARREARS
'                     !DateFrom = DateAdd(Right(adoRstSC!CalDays, 1), Left(adoRstSC!CalDays, Len(adoRstSC!CalDays) - 1), adoRstSC!SCNextDueDate) 'CDate(adoRstSC!SCNextDueDate)
                     !dateFrom = ArrFromDate(adoRstSC!SCNextDueDate, _
                                             adoRstSC!SCFrequency, _
                                             adoRstSC!SCDemandType, _
                                             adoRstSC!propertyID, _
                                             adoRstSC!CalDays, adoConn)
                     !DateTO = DateAdd("d", -1, adoRstSC!SCNextDueDate)
                  End If
                  'save to an array adoRstSC!ServiceCharge, adoRstSC!SCDemandType to zerorize YearEnd amount and set a SCYE Date( !DateTo) where category is year end
                  'SCYRCount = 0
                  szSCYR(SCYRCount, 0) = adoRstSC!ServiceCharge
                  szSCYR(SCYRCount, 1) = adoRstSC!SCDemandType
                  szSCYR(SCYRCount, 2) = !DateTO
                  
                  'new requirement from WD they want  Startdate and end date as 2nd ref 2019-11-18
                  !SageRef = Format(!dateFrom, "dd/mm/yy") & "-" & Format(!DateTO, "dd/mm/yy")
                  
                  !SageDepartment = adoRstSC!ServiceChargeDept ' DepartmentID(adoRstLeaseDtl!SageAccountNumber, adoRstLeaseDtl!UnitNumber, "Service Charge", adoConn)
                  !FrequencyID = adoRstSC!SCFrequency
                  !ChargingFigure = adoRstSC!CMFigure
                  !ChargingMethod = IIf(IsNull(adoRstSC!ChargingMethod), 0, adoRstSC!ChargingMethod)
                  .Update
               End With

               UpdateNextDueDate "LServiceCharges", "SCNextDueDate", dtNtDueDate, "ServiceCharge", adoRstSC!ServiceCharge, adoConn
               SetFDD "LServiceCharges", "FDD", dtFDD, "ServiceCharge", adoRstSC!ServiceCharge, adoConn
               SCYRCount = SCYRCount + 1
               SCcount = SCcount + 1
               iSerial = iSerial + 1
            End If
            adoRstSC.MoveNext
         Wend
         adoRstSC.Close
         'MsgBox "Total number of record that is going to be zerorized is: " & UBound(szSCYR, 1)
         For SCYRCount = 0 To UBound(szSCYR, 1) - 1
                If szSCYR(SCYRCount, 0) <> "" Then
                    adoConn.Execute "Update LServiceCharges L,DemandTypes D  Set SCTotal=0,SCAmount=0,SCYEDate=#" & szSCYR(SCYRCount, 2) & "# where L.SCDemandType =D.ID AND D.CategoryCode=5 AND ServiceCharge='" & szSCYR(SCYRCount, 0) & "'"
                End If
         Next
            

 '************************************************************************************************
         bPRSCNeg = False                '   Service Charge demands       ---->    PRO-RATA --Negative charge amount-> Credit Note
'************************************************************************************************
        '************************************************************************************************
'   Service Charge demands       ---->    PRO-RATA -Negative charge amount-> credit note
'************************************************************************************************
         szSQLStr = "SELECT S.ServiceCharge, S.LeaseID, S.SCFrequency, S.SCPayableFrom, " & _
                        "S.SCNextDueDate, S.ChargingMethod, S.CMFigure, " & _
                        "S.SCTotal, S.SCAmount, S.SCTOLimit, " & _
                        "S.SCDemandType, StopSC, S.ServiceChargeDept,S.FDD, " & _
                        "S.SCDesc, Units.PropertyID, " & _
                        "DemandTypes.Spare1 as ClientBankID, Frequencies.CalDays,Frequencies.ID " & _
                    "FROM LServiceCharges AS S, LeaseDetails, Units, DemandTypes, Frequencies "

         If frmDemandTypesSel.cboGDPFreq.Column(0) = 0 Then

 szSQLStr = szSQLStr & _
                    "WHERE S.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                        "LeaseDetails.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                        "LeaseDetails.GPrataDmd = TRUE AND " & _
                        "S.StopAutoDmd = TRUE AND " & _
                        "S.SCAmount < 0 AND LeaseDetails.EndDate < CDATE(S.FDD) AND " & _
                        "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
                        " (ISNULL(S.spare3) OR S.spare3 <> 'DELETED') AND " & _
                        "S.SCDemandType = DemandTypes.ID AND " & _
                        "S.SCFrequency = Frequencies.ID AND LeaseDetails.Status;"
         Else

szSQLStr = szSQLStr & _
                    "WHERE S.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                        "LeaseDetails.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                        "LeaseDetails.GPrataDmd = TRUE AND " & _
                        "S.StopAutoDmd = TRUE AND " & _
                        "S.SCAmount < 0 AND LeaseDetails.EndDate < CDATE(S.FDD) AND " & _
                        "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
                        "(ISNULL(S.spare3) OR S.spare3 <> 'DELETED') AND " & _
                        "S.SCDemandType = DemandTypes.ID AND " & _
                        "S.SCFrequency = Frequencies.ID AND " & _
                        "Frequencies.ID = " & frmDemandTypesSel.cboGDPFreq.Column(0) & " AND LeaseDetails.Status;"
         End If
  'Remming S.SCAmount > 0 AND  2020-12-02 issue 898
         adoRstSC.Open szSQLStr, adoConn, adOpenStatic, adLockReadOnly
         ReDim szSCYR(adoRstSC.RecordCount, 2) As String
         SCYRCount = 0
         While Not adoRstSC.EOF
            If IsNull(adoRstSC!StopSC) Or adoRstSC!StopSC = "" Then
               bProceed = True
            Else
               bProceed = IIf(DateDiff("d", adoRstSC!SCNextDueDate, CDate(adoRstSC!StopSC)) > 0, True, False)
            End If
            If adoRstLeaseDtl!SCPayable = "Y" And _
               DateDiff("d", Date, IIf(adoRstSC!SCNextDueDate = "", _
                  DateAdd("d", -1, Date), adoRstSC!SCNextDueDate)) <= DaysB4Due And bProceed And _
                     IsDmdTypeSel(adoRstSC.Fields("SCDemandType").Value) Then
'**** Insert the Header info in the DemandRecords table
               lDemand = NextRef(adoConn, "DEMAND_REF")        'GET THE NEXT DEMAND ID
               With adoRstDemandRec
                  .AddNew
                  .Fields("DemandID").Value = lDemand
                  .Fields.Item("CreatedBy").Value = User
                  .Fields.Item("CreatedDate").Value = Now

                  lArrDemand(UBound(lArrDemand)) = lDemand
                  ReDim Preserve lArrDemand(UBound(lArrDemand) + 1) As Long

                  .Fields.Item("BatchID").Value = lBatch
                  .Fields.Item("SageAccountNumber").Value = adoRstLeaseDtl!SageAccountNumber
                  .Fields.Item("TenantCompanyName").Value = adoRstLeaseDtl!CompanyName
                  .Fields.Item("UnitNumber").Value = adoRstLeaseDtl!UnitNumber
                  .Fields.Item("Source").Value = 1
                  .Fields.Item("TransactionType").Value = 2
'   ***Here my thinking is, all type of demands due date is on the same day
'   ***If its not correct then i have to change the manual demands grid and the demand table & split table
                  .Fields.Item("IssueDate").Value = Format(frmDemandTypesSel.txtInitialIssueDate.text, "dd/mm/yyyy")
                  .Fields.Item("SageText").Value = adoRstLeaseDtl!SageAccountNumber
                  .Fields.Item("IsPrinted").Value = False
                  .Fields.Item("Spare1").Value = adoRstSC!ClientBankID
                  .Fields.Item("LeaseRef").Value = adoRstLeaseDtl!LeaseID
                  .Fields.Item("DmdSlNo").Value = SlNumber("SC", "DemandRecords", adoConn)
                  .Fields.Item("SuppText1").Value = adoRstLeaseDtl.Fields.Item("SuppText1").Value
                  .Fields.Item("SentByEmail").Value = IIf(adoRstLeaseDtl.Fields.Item("EmailDmd").Value, Null, 2)
                  .Fields.Item("PostingDate").Value = Format(frmDemandTypesSel.txtPostingDate.text, "dd mmmm yyyy")
                  'aded by anol 16 08 2016
                  .Fields.Item("SO").Value = True
                  .Fields.Item("LastModifiedBy").Value = User
                  .Fields.Item("LastModifiedDate").Value = Now
                  .Update
               End With

'               iChildId = 1
               szDes = IIf(IIf(IsNull(adoRstSC!SCDesc), "", adoRstSC!SCDesc) = "", DemandTypeName(adoRstSC!SCDemandType, adoConn), adoRstSC!SCDesc)

               dtNtDueDate = FindNextDueDate(adoRstSC!SCNextDueDate, _
                                 adoRstSC!SCFrequency, adoRstSC!SCDemandType, adoRstSC!propertyID, adoConn)
'               dtFDD = FindNextDueDate(dtNtDueDate, _
                                             adoRstSC!SCFrequency, _
                                             adoRstSC!SCDemandType, _
                                             adoRstSC!PropertyID, adoConn)

''******* if the override lease end date is false then the lease is open, lease is not expairing.
''******* if the lease end date is open then we dont need to compare the NextDueDate with the lease expaire date.
'               If Not adoRstLeaseDtl.Fields("OLED").Value Then
'                  dtEndDate = Format(DateAdd("d", 1, adoRstLeaseDtl!EndDate), "dd/mm/yyyy")
'                  If DateDiff("d", dtEndDate, dtNtDueDate) > 0 Then dtNtDueDate = dtEndDate
'               End If

               With adoRstSplitDemand
                  .AddNew
                  !DSR = UniqueID()
                  !splitID = 1
                  !DEMANDID = lDemand
                  !A_M = "A"
                  !NominalCodeforAmount = PartString(szaNCode(adoRstSC!SCDemandType), 0, " # ")
                  !NominalNameforAmount = PartString(szaNCName(adoRstSC!SCDemandType), 0, " # ")
                  !NominalCodeForVAT = PartString(szaNCode(adoRstSC!SCDemandType), 1, " # ")
                  !NominalNameforVAT = PartString(szaNCName(adoRstSC!SCDemandType), 1, " # ")
                  !NominalCodeForTotal = PartString(szaNCode(adoRstSC!SCDemandType), 2, " # ")
                  !NominalNameforTotal = PartString(szaNCName(adoRstSC!SCDemandType), 2, " # ")
'                  !SageRef = "EL" 'szaPrefix(adoRstSC!SCDemandType) & Format(SlNumber("SI", "DemandRecords", adoConn), "00000")
                  !DueDate = Format(adoRstSC!SCNextDueDate, "dd/mm/yyyy")
                  !VATMonth = Month(adoRstSC!SCNextDueDate)
                  !TypeOfDemand = adoRstSC!SCDemandType
                  !description = szDes
                  !DemandStatement = True
                  !VAT_CODE = GetVATCode_Tenant(adoRstLeaseDtl!SageAccountNumber, adoConn)
                  If !VAT_CODE = -1 Then
                        !VAT_CODE = Null
                  End If
                  If Left(adoRstSC!CalDays, 1) <> "-" Then   '                          ADVANCE
                     !dateFrom = CDate(adoRstSC!SCNextDueDate)
                  Else                                       '                          ARREARS
'                     !DateFrom = DateAdd(Right(adoRstSC!CalDays, 1), Left(adoRstSC!CalDays, Len(adoRstSC!CalDays) - 1), adoRstSC!SCNextDueDate) 'CDate(adoRstSC!SCNextDueDate)
                     !dateFrom = ArrFromDate(adoRstSC!SCNextDueDate, _
                                             adoRstSC!SCFrequency, _
                                             adoRstSC!SCDemandType, _
                                             adoRstSC!propertyID, _
                                             adoRstSC!CalDays, adoConn)
                  End If
                  !DateTO = adoRstLeaseDtl!EndDate
                  
                  szSCYR(SCYRCount, 0) = adoRstSC!ServiceCharge
                  szSCYR(SCYRCount, 1) = adoRstSC!SCDemandType
                  szSCYR(SCYRCount, 2) = !DateTO
                  'new requirement from WD they want  Startdate and end date as 2nd ref 2019-11-18
                  !SageRef = Format(!dateFrom, "dd/mm/yy") & "-" & Format(!DateTO, "dd/mm/yy")
                  
                  
                  If DateDiff("d", adoRstLeaseDtl!EndDate, adoRstSC.Fields.Item("FDD")) = 1 Then
                          'do not calculatate prorata ,calculate full
                          !amount = Abs(RoundingNumber(Val(adoRstSC.Fields.Item("SCTotal") / szaPartofYear(adoRstSC("ID").Value)), 2))
                  Else
                          'calculate prorata and also add 1 day with datediff
                           !amount = Abs(RoundingNumber((Val(adoRstSC.Fields.Item("SCTotal")) / 365) * (DateDiff("D", !dateFrom, !DateTO) + 1), 2))
                  End If
                  '!amount = RoundingNumber((Val(adoRstSC!SCTotal) / 365) * DateDiff("D", !DateFrom, !DateTo), 2)
                  !VATAMOUNT = Abs(RoundingNumber(!amount * GetVAT_Tenant(adoRstLeaseDtl!SageAccountNumber, adoConn) / 100, 2))
                  !TotalAmount = Abs(!amount + !VATAMOUNT)

                  !SageDepartment = adoRstSC!ServiceChargeDept ' DepartmentID(adoRstLeaseDtl!SageAccountNumber, adoRstLeaseDtl!UnitNumber, "Service Charge", adoConn)
                  !FrequencyID = adoRstSC!SCFrequency
                  !ChargingFigure = adoRstSC!CMFigure
                  !ChargingMethod = IIf(IsNull(adoRstSC!ChargingMethod), 0, adoRstSC!ChargingMethod)
                  .Update
               End With

               UpdateNextDueDate "LServiceCharges", "SCNextDueDate", dtNtDueDate, "ServiceCharge", adoRstSC!ServiceCharge, adoConn
               MarkGPD "LServiceCharges", True, "ServiceCharge", adoRstSC!ServiceCharge, adoConn
               SCYRCount = SCYRCount + 1
               SCcount = SCcount + 1
               iSerial = iSerial + 1
            End If
            adoRstSC.MoveNext
         Wend
         adoRstSC.Close
         Set adoRstSC = Nothing
         For SCYRCount = 0 To UBound(szSCYR, 1) - 1
                If szSCYR(SCYRCount, 0) <> "" Then
                    adoConn.Execute "Update LServiceCharges L,DemandTypes D  Set SCTotal=0,SCAmount=0,SCYEDate=#" & szSCYR(SCYRCount, 2) & "# where L.SCDemandType =D.ID AND D.CategoryCode=5 AND ServiceCharge='" & szSCYR(SCYRCount, 0) & "'"
                End If
         Next
        
End Sub
'Private Sub writeDUtilityChargeDetails(ByRef adoRstUC As ADODB.Recordset, ByRef adoRstLeaseDtl As ADODB.Recordset, iChildId As Long, ByRef adoRstSplitDemand As ADODB.Recordset, _
'                ByRef laBankID As Variant, ByRef SCcount As Long, ByRef iSerial As Long)
'
'End Sub
'Private Sub writeDUtilityChargeDetails(ByRef adoRstUC As ADODB.Recordset, ByRef adoRstLeaseDtl As ADODB.Recordset, ByRef iChildId As Integer, ByRef adoRstSplitDemand As ADODB.Recordset, _
'                ByRef laBankID As Variant, ByRef SCcount As Integer, ByRef iSerial As Integer)
'    While Not adoRstUC.EOF
'               If adoRstLeaseDtl!UtilityUsage = "Y" Then
'                  iChildId = iChildId + 1
'
'                  adoRstSplitDemand.AddNew
'                  adoRstSplitDemand!DSR = UniqueID()
'                  adoRstSplitDemand!splitID = iChildId
'                  adoRstSplitDemand!DEMANDID = CLng(laBankID(4, 1))
'                  adoRstSplitDemand!A_M = "A"
'                  adoRstSplitDemand!NominalCodeforAmount = PartString(szaNCode(adoRstUC!DemandType), 0, " # ")
'                  adoRstSplitDemand!NominalNameforAmount = PartString(szaNCName(adoRstUC!DemandType), 0, " # ")
'                  adoRstSplitDemand!NominalCodeForVAT = PartString(szaNCode(adoRstUC!DemandType), 1, " # ")
'                  adoRstSplitDemand!NominalNameforVAT = PartString(szaNCName(adoRstUC!DemandType), 1, " # ")
'                  adoRstSplitDemand!NominalCodeForTotal = PartString(szaNCode(adoRstUC!DemandType), 2, " # ")
'                  adoRstSplitDemand!NominalNameforTotal = PartString(szaNCName(adoRstUC!DemandType), 2, " # ")
'                  adoRstSplitDemand!amount = RoundingNumber(adoRstUC!balance, 2)
'                  adoRstSplitDemand!VATAMOUNT = 0
'                  adoRstSplitDemand!TotalAmount = adoRstSplitDemand!amount + adoRstSplitDemand!VATAMOUNT
''                  adoRstSplitDemand!SageRef = szaPrefix(adoRstUC!DemandType) & Format(SlNumber("SI", "DemandRecords", adoConn), "00000")
'                  adoRstSplitDemand!DueDate = Format(adoRstUC!DueDate, "dd/mm/yyyy")
'                  adoRstSplitDemand!VATMonth = Month(adoRstUC!DueDate)
'                  adoRstSplitDemand!TypeOfDemand = adoRstUC!DemandType
'                  adoRstSplitDemand!description = adoRstUC!description
'                  adoRstSplitDemand!DemandStatement = True
'                  adoRstSplitDemand!VAT_CODE = GetVATCode_Tenant(adoRstLeaseDtl!SageAccountNumber, adoConn)
'                  If adoRstSplitDemand!VAT_CODE = -1 Then
'                        adoRstSplitDemand!VAT_CODE = Null
'                  End If
'                  adoRstSplitDemand!dateFrom = CDate(adoRstUC!ReadingDate)
'                  adoRstSplitDemand!DateTO = CDate(adoRstUC!DueDate)
'                  'new requirement from WD they want  Startdate and end date as 2nd ref 2019-11-18
'                  adoRstSplitDemand!SageRef = Format(adoRstSplitDemand!dateFrom, "dd/mm/yy") & "-" & Format(adoRstSplitDemand!DateTO, "dd/mm/yy")
'                  adoRstSplitDemand!FrequencyID = 0
'                  adoRstSplitDemand.Update
'
'                  UpdateUtility adoRstUC!UtilityUsage, adoConn
'
'                  SCcount = SCcount + 1
'                  iSerial = iSerial + 1
'               End If
'               adoRstUC.MoveNext
'            Wend
'            adoRstUC.Close
'            Set adoRstUC = Nothing
'         End If
'
'End Sub
Private Sub UpdateUtility(szUtilityUsage As String, adoConn As ADODB.Connection)
   adoConn.Execute "UPDATE LUtilityUsage " & _
                   "SET IsGenerated = TRUE, BF = FALSE " & _
                   "WHERE UtilityUsage = '" & szUtilityUsage & "';"
End Sub


Public Sub GenAutoSngDemands(adoConn As ADODB.Connection)
   Dim szaNCode()    As String
   Dim szaNCName()   As String
   Dim szaPrefix()   As String
   Dim szDes         As String
   Dim CutOffDate    As String
   Dim szSQLStr      As String
   Dim szaTemp()     As String
   
   Dim szaPartofYear() As Integer ' This variable shall hold part of the year from recordset so that you need to go to the database for  once
   Dim SQLStr1 As String
   Dim adoRST As New ADODB.Recordset
   Dim i As Integer
   
   Dim BRcount       As Integer
   Dim SCcount       As Integer
   Dim SCYRCount     As Integer
   Dim IPcount       As Integer
   Dim iProp         As Integer
   Dim iSerial       As Integer
   Dim lBatch        As Long
   Dim lDemand       As Long
   Dim iDT        As Integer

   Dim UUcount       As Integer
   Dim DaysB4Due     As Integer
   Dim bProceed      As Boolean
   Dim ICcount       As Integer
   Dim dtFDD         As Date
   Dim dtNtDueDate   As Date
  

   Dim adoRstDemandRec  As New ADODB.Recordset
   Dim adoRstDT         As New ADODB.Recordset
   Dim adoRstDmdTyp     As New ADODB.Recordset
   Dim adoRstLeaseDtl As ADODB.Recordset, adoRstSplitDemand As New ADODB.Recordset
   Dim adoRstRC As New ADODB.Recordset, adoRstSC As New ADODB.Recordset, adoRstUC As ADODB.Recordset
   Dim adoRstIns As New ADODB.Recordset
   Dim szSCYR() As String

   If MsgBox("  Are you sure you wish to generate automatic demands?" & (Chr(13) + Chr(10)) & _
             "Please ensure your global data has been correctly inputted.", vbYesNo + vbQuestion, _
             "Generate Automatic Demands") = vbNo Then Exit Sub

   ReDim lArrDemand(0) As Long

   Call RentReview(adoConn)
   
'   MousePointer = vbHourglass    'change the mouse cursor to show program is busy/working
    
'   Connect to Demands table to add new demands.
   szSQLStr = "SELECT * FROM DemandRecords"
   adoRstDemandRec.Open szSQLStr, adoConn, adOpenDynamic, adLockPessimistic

   szSQLStr = "SELECT * FROM DemandSplitRecords"
   adoRstSplitDemand.Open szSQLStr, adoConn, adOpenDynamic, adLockPessimistic

'   get nominal codes and prefix for base rent from demand types.
   
   'Resolved By BOSL. Modified by Asif
   'Issue 0000476. The Control Account settings must be loaded from Configuration instead of the Demand Types.
   
   'szSQLStr = "SELECT * FROM DemandTypes;"
   
   Dim ClientID As String
   
   ClientID = frmDemandTypesSel.flxClients.TextMatrix(frmDemandTypesSel.flxClients.row, 1)
   
   If ClientID = "" Then
      MsgBox "No Client selected in the Automatic Demand Generation form", vbCritical, "DATA Input"

      adoRstSplitDemand.Close
      adoRstDemandRec.Close

      Set adoRstSplitDemand = Nothing
      Set adoRstDemandRec = Nothing
      Exit Sub
   End If
   
   SQLStr1 = "SELECT ID,PARTOFYEAR  FROM FREQUENCIES  Order By ID "
   adoRST.Open SQLStr1, adoConn, adOpenStatic, adLockReadOnly
   ReDim szaPartofYear(RecordCount(adoRST)) As Integer
   While Not adoRST.EOF
        i = i + 1
        szaPartofYear(i) = adoRST("PARTOFYEAR").Value
        adoRST.MoveNext
   Wend
   adoRST.Close
   
   szSQLStr = "SELECT DemandTypes.ID, DemandTypes.Type, DemandTypes.InvCrd, DemandTypes.Prefix, " & _
   "DemandTypes.NominalCodeforAmount, DemandTypes.NominalNameforAmount, " & _
   "(SELECT Code FROM NominalLedger WHERE ClientID = '" & ClientID & "' AND CAType = 'O') as NominalCodeforVAT, " & _
   "(SELECT Name FROM NominalLedger WHERE ClientID = '" & ClientID & "' AND CAType = 'O') as NominalNameforVAT, " & _
   "(SELECT Code FROM NominalLedger WHERE ClientID = '" & ClientID & "' AND CAType = 'S') as NominalCodeforTotal, " & _
   "(SELECT Name FROM NominalLedger WHERE ClientID = '" & ClientID & "' AND CAType = 'S') as NominalNameforTotal, " & _
   "DemandTypes.TransactionType, DemandTypes.CategoryCode, DemandTypes.PaymentDates, " & _
   "DemandTypes.spare1, DemandTypes.spare2, DemandTypes.spare3, DemandTypes.spare4, DemandTypes.spare5, " & _
   "DemandTypes.DTGroup, DemandTypes.DemandReportName, DemandTypes.PropertyID, " & _
   "DemandTypes.EmailInvoiceTemplate , DemandTypes.ULC, DemandTypes.StatementTemplate " & _
   "FROM DemandTypes;"
   'End of Modification
   
   adoRstDmdTyp.Open szSQLStr, adoConn, adOpenStatic, adLockReadOnly

   If adoRstDmdTyp.EOF Then
      MsgBox "There are no Demand Type in the database", vbCritical, "DATA Input Error"

      adoRstSplitDemand.Close
      adoRstDemandRec.Close
      adoRstDmdTyp.Close

      Set adoRstSplitDemand = Nothing
      Set adoRstDemandRec = Nothing
      Set adoRstDmdTyp = Nothing

      Exit Sub
   End If

   szSQLStr = "SELECT MAX(ID) FROM DemandTypes;"
   adoRstDT.Open szSQLStr, adoConn, adOpenStatic, adLockReadOnly
   iDT = adoRstDT.Fields.Item(0).Value
   adoRstDT.Close
   Set adoRstDT = Nothing

   ReDim szaPrefix(iDT) As String
   ReDim szaNCName(iDT) As String
   ReDim szaNCode(iDT) As String

'**Saving all Nominal Codes and Prefixes in the array
   While Not adoRstDmdTyp.EOF
      szaPrefix(adoRstDmdTyp!Id) = adoRstDmdTyp!prefix
      szaNCName(adoRstDmdTyp!Id) = adoRstDmdTyp!NominalNameforAmount & " # " & adoRstDmdTyp!NominalNameforVAT & " # " & adoRstDmdTyp!NominalNameforTotal
      szaNCode(adoRstDmdTyp!Id) = adoRstDmdTyp!NominalCodeforAmount & " # " & adoRstDmdTyp!NominalCodeForVAT & " # " & adoRstDmdTyp!NominalCodeForTotal
      adoRstDmdTyp.MoveNext
   Wend
   adoRstDmdTyp.Close
   Set adoRstDmdTyp = Nothing

   Set adoRstLeaseDtl = New ADODB.Recordset

   iSerial = 0

   For iProp = 1 To frmDemandTypesSel.flxProperties.Rows - 1
      If frmDemandTypesSel.flxProperties.TextMatrix(iProp, 0) = "X" Then ' lstProperties.Selected(iProp) Then
         iSerial = iSerial + 1
         szDes = szDes & "Units.PropertyID = '" & frmDemandTypesSel.flxProperties.TextMatrix(iProp, 1) & "'"
         If iSerial < frmDemandTypesSel.iSelProperties Then szDes = szDes & " OR "
      End If
   Next iProp
    'Fixed by anol 20160920
    If Right(szDes, 4) = " OR " Then
        szDes = Mid(szDes, 0, Len(szDes) - 4)
    End If
    
   szSQLStr = "SELECT LeaseDetails.*, Units.PropertyID, Tenants.EmailDmd, NoOfDaysToSendDemandsB4Due " & _
              "FROM LeaseDetails, Units, Tenants, GlobalData " & _
              "WHERE LeaseDetails.Status = TRUE AND " & _
                  "Units.PropertyID = GlobalData.PropertyID AND " & _
                  "LeaseDetails.SageAccountNumber = Tenants.SageAccountNumber AND " & _
                  "LeaseDetails.UnitNumber = Units.UnitNumber And "
   szSQLStr = szSQLStr & "(" & szDes & ")"
   szDes = ""
'   End If
   adoRstLeaseDtl.Open szSQLStr, adoConn, adOpenDynamic, adLockPessimistic

   iSerial = 1
   lBatch = NextRef(adoConn, "BATCH_REF")
   If adoRstLeaseDtl.EOF Then
      adoRstLeaseDtl.Close
      Set adoRstLeaseDtl = Nothing
   Else
      While Not adoRstLeaseDtl.EOF

'*********************** SAMRAT 25/11/2005***************************************
'*** Determin the date boundray in future, in this boundary
'*** we have to find those demands' due date to calcuate
'*** demands from lease table and we have to calculate &
'*** collect all those demands in DemandRecords table.
'*********************************************************************************
         DaysB4Due = adoRstLeaseDtl!NoOfDaysToSendDemandsB4Due ' GlbDaysBeforeDue(adoRstLeaseDtl.Fields("LeaseID").Value, adoConn)
         CutOffDate = DateAdd("d", DaysB4Due, Date) 'Date boundary

'************************************************************************************
'*********************        Interest Charge            ****************************
'************************************************************************************
         If adoRstLeaseDtl.Fields("InterestChargeable").Value = "Y" Then
            Dim cTotalOSAmt As Currency, sIntCalDays As Single
'**** Insert the Header info in the DemandRecords table
            lDemand = NextRef(adoConn, "DEMAND_REF")        'GET THE NEXT DEMAND ID

            With adoRstDemandRec
               .AddNew
               .Fields("DemandID").Value = lDemand
               .Fields("CreatedBy").Value = User
               .Fields("CreatedDate").Value = Now

               lArrDemand(UBound(lArrDemand)) = lDemand
               ReDim Preserve lArrDemand(UBound(lArrDemand) + 1) As Long

               .Fields("BatchID").Value = lBatch
               .Fields("SageAccountNumber").Value = adoRstLeaseDtl!SageAccountNumber
               .Fields("TenantCompanyName").Value = adoRstLeaseDtl!CompanyName
               .Fields("UnitNumber").Value = adoRstLeaseDtl!UnitNumber
               .Fields("Source").Value = 1
               .Fields("TransactionType").Value = 1
'*** Here my thinking is, all type of demands due date is on the same day
'*** If its not correct then i have to change the manual demands grid and the demand table & split table
               .Fields("IssueDate").Value = Format(frmDemandTypesSel.txtInitialIssueDate.text, "dd/mm/yyyy")
               .Fields("SageText").Value = "S/L " & adoRstLeaseDtl!SageAccountNumber
               .Fields("IsPrinted").Value = False
               .Fields("Spare1").Value = ClientDefaultBankDts(adoRstLeaseDtl!propertyID, adoConn)
               .Fields.Item("LeaseRef").Value = adoRstLeaseDtl!LeaseID
               .Fields.Item("DmdSlNo").Value = SlNumber("SI", "DemandRecords", adoConn)
               .Fields.Item("SuppText1").Value = adoRstLeaseDtl.Fields.Item("SuppText1").Value
               .Fields.Item("SentByEmail").Value = IIf(adoRstLeaseDtl.Fields.Item("EmailDmd").Value, Null, 2)
               .Fields.Item("PostingDate").Value = Format(frmDemandTypesSel.txtPostingDate.text, "dd mmmm yyyy")
               'aded by anol 16 08 2016
               .Fields.Item("SO").Value = True
               .Fields.Item("LastModifiedBy").Value = User
               .Fields.Item("LastModifiedDate").Value = Now
               .Update
            End With

'*** Insert the split records in the DemandSplitRecords table
'            iChildId = 1

'*** Add new demand IN demand table.
            adoRstSplitDemand.AddNew
            adoRstSplitDemand!DSR = UniqueID()
            adoRstSplitDemand!splitID = 1
            adoRstSplitDemand!DEMANDID = lDemand
            If adoRstLeaseDtl!ServiceChargeDept = "AUTO" Then
               adoRstSplitDemand!A_M = "A"
            Else
               adoRstSplitDemand!A_M = "M"
            End If
            adoRstSplitDemand!NominalCodeforAmount = PartString(szaNCode(adoRstLeaseDtl!IntDemandType), 0, " # ")
            adoRstSplitDemand!NominalNameforAmount = PartString(szaNCName(adoRstLeaseDtl!IntDemandType), 0, " # ")
            adoRstSplitDemand!NominalCodeForTotal = PartString(szaNCode(adoRstLeaseDtl!IntDemandType), 2, " # ")
            adoRstSplitDemand!NominalNameforTotal = PartString(szaNCName(adoRstLeaseDtl!IntDemandType), 2, " # ")
            If adoRstLeaseDtl!ServiceChargeDept = "AUTO" Then
               adoRstSplitDemand!amount = CalAutoInterest(CSng(adoRstLeaseDtl!AdditionalInterest), CInt(adoRstLeaseDtl!DaysAfterInterestPayable), adoRstLeaseDtl!UnitNumber, adoRstLeaseDtl!SageAccountNumber, adoConn, cTotalOSAmt, sIntCalDays)
            Else
               adoRstSplitDemand!amount = RoundingNumber(adoRstLeaseDtl!InterestAmount, 2)
               UpdateIntCharge adoRstLeaseDtl!LeaseID, adoConn          ' updating the InterestChargable 'Y' to 'N' in UpdateIntCharge method
            End If
            adoRstSplitDemand!VATAMOUNT = 0
            adoRstSplitDemand!TotalAmount = CCur(adoRstSplitDemand!amount) + _
                                            CCur(adoRstSplitDemand!VATAMOUNT)
            If adoRstLeaseDtl!Text1 = "" Then
               szDes = "Interest Charges For " & adoRstLeaseDtl!DaysAfterInterestPayable & _
                       " Days on " & cTotalOSAmt
            Else
               szDes = adoRstLeaseDtl!Text1
            End If
            'anol-from Date and  todate not found
            adoRstSplitDemand!SageRef = szaPrefix(adoRstLeaseDtl!IntDemandType) & Format(SlNumber("SI", "DemandRecords", adoConn), "00000")
            
            adoRstSplitDemand!DueDate = Format(Date, "dd/mm/yyyy")
            adoRstSplitDemand!VATMonth = Month(Date)
            adoRstSplitDemand!TypeOfDemand = adoRstLeaseDtl!IntDemandType
            adoRstSplitDemand!description = szDes
            adoRstSplitDemand!DemandStatement = True
            adoRstSplitDemand!FrequencyID = 0
            adoRstSplitDemand.Update

            IPcount = IPcount + 1
            iSerial = iSerial + 1
         End If
'*********************************************************************************************************
'         Utility Charges Demands
'*********************************************************************************************************
         If adoRstLeaseDtl.Fields("UtilityUsage").Value = "Y" Then
            szSQLStr = "SELECT * FROM LUtilityUsage " & _
                       "WHERE LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                           "IsGenerated = FALSE AND " & _
                           "LatestReading = TRUE;"

'Debug.Print szSQLStr
            Set adoRstUC = New ADODB.Recordset
            adoRstUC.Open szSQLStr, adoConn, adOpenDynamic, adLockPessimistic

            While Not adoRstUC.EOF
      '**** Insert the Header info in the DemandRecords table
               lDemand = NextRef(adoConn, "DEMAND_REF")        'GET THE NEXT DEMAND ID
               With adoRstDemandRec
                  .AddNew
                  .Fields("DemandID").Value = lDemand
                  .Fields("CreatedBy").Value = User
                  .Fields("CreatedDate").Value = Now

                  lArrDemand(UBound(lArrDemand)) = lDemand
                  ReDim Preserve lArrDemand(UBound(lArrDemand) + 1) As Long

                  .Fields("BatchID").Value = lBatch
                  .Fields("SageAccountNumber").Value = adoRstLeaseDtl!SageAccountNumber
                  .Fields("TenantCompanyName").Value = adoRstLeaseDtl!CompanyName
                  .Fields("UnitNumber").Value = adoRstLeaseDtl!UnitNumber
                  .Fields("Source").Value = 1
                  .Fields("TransactionType").Value = 1
   '***Here my thinking is, all type of demands due date is on the same day
   '***If its not correct then i have to change the manual demands grid and the demand table & split table
                  .Fields("IssueDate").Value = Format(frmDemandTypesSel.txtInitialIssueDate.text, "dd/mm/yyyy")
                  .Fields("SageText").Value = "S/L " & adoRstLeaseDtl!SageAccountNumber
                  .Fields("IsPrinted").Value = False
                  .Fields("Spare1").Value = ClientDefaultBankDts(adoRstLeaseDtl!propertyID, adoConn)
                  .Fields.Item("LeaseRef").Value = adoRstLeaseDtl!LeaseID
                  .Fields.Item("DmdSlNo").Value = SlNumber("SI", "DemandRecords", adoConn)
                  .Fields.Item("SuppText1").Value = adoRstLeaseDtl.Fields.Item("SuppText1").Value
                  .Fields.Item("SentByEmail").Value = IIf(adoRstLeaseDtl.Fields.Item("EmailDmd").Value, Null, 2)
                  .Fields.Item("PostingDate").Value = Format(frmDemandTypesSel.txtPostingDate.text, "dd mmmm yyyy")
                  'aded by anol 16 08 2016
                  .Fields.Item("SO").Value = True
                  .Fields.Item("LastModifiedBy").Value = User
                  .Fields.Item("LastModifiedDate").Value = Now
                  .Update
               End With

'               iChildId = 1

               adoRstSplitDemand.AddNew
               adoRstSplitDemand!DSR = UniqueID()
               adoRstSplitDemand!splitID = 1
               adoRstSplitDemand!DEMANDID = lDemand
               adoRstSplitDemand!A_M = "A"
               adoRstSplitDemand!NominalCodeforAmount = PartString(szaNCode(adoRstUC!DemandType), 0, " # ")
               adoRstSplitDemand!NominalNameforAmount = PartString(szaNCName(adoRstUC!DemandType), 0, " # ")
               adoRstSplitDemand!NominalCodeForVAT = PartString(szaNCode(adoRstUC!DemandType), 1, " # ")
               adoRstSplitDemand!NominalNameforVAT = PartString(szaNCName(adoRstUC!DemandType), 1, " # ")
               adoRstSplitDemand!NominalCodeForTotal = PartString(szaNCode(adoRstUC!DemandType), 2, " # ")
               adoRstSplitDemand!NominalNameforTotal = PartString(szaNCName(adoRstUC!DemandType), 2, " # ")
               adoRstSplitDemand!amount = adoRstUC!Balance
               adoRstSplitDemand!VATAMOUNT = 0
               adoRstSplitDemand!TotalAmount = adoRstSplitDemand!amount + adoRstSplitDemand!VATAMOUNT
'               adoRstSplitDemand!SageRef = szaPrefix(adoRstUC!DemandType) & Format(SlNumber("SI", "DemandRecords", adoConn), "00000")
               adoRstSplitDemand!DueDate = Format(adoRstUC!DueDate, "dd/mm/yyyy")
               adoRstSplitDemand!VATMonth = Month(adoRstUC!DueDate)
               adoRstSplitDemand!TypeOfDemand = adoRstUC!DemandType
               adoRstSplitDemand!description = adoRstUC!description
               adoRstSplitDemand!DemandStatement = True
               adoRstSplitDemand!VAT_CODE = GetVATCode_Tenant(adoRstLeaseDtl!SageAccountNumber, adoConn)
               If adoRstSplitDemand!VAT_CODE = -1 Then
                        adoRstSplitDemand!VAT_CODE = Null
               End If
               adoRstSplitDemand!dateFrom = CDate(adoRstUC!ReadingDate)
               adoRstSplitDemand!DateTO = CDate(adoRstUC!DueDate)
               'new requirement from WD they want  Startdate and end date as 2nd ref 2019-11-18
               adoRstSplitDemand!SageRef = Format(adoRstSplitDemand!dateFrom, "dd/mm/yy") & "-" & Format(adoRstSplitDemand!DateTO, "dd/mm/yy")
               adoRstSplitDemand!FrequencyID = 0
               adoRstSplitDemand.Update

               adoRstUC.Fields.Item("IsGenerated").Value = True
               adoRstUC.Fields.Item("BF").Value = False
               adoRstUC.Update

               UUcount = UUcount + 1
               iSerial = iSerial + 1
               adoRstUC.MoveNext
            Wend
            adoRstUC.Close
            Set adoRstUC = Nothing
         End If
'*********************************************************************************************************
'         Rent Charges Demands                                                                           '
'*********************************************************************************************************
         szSQLStr = "SELECT R.RentCharges, R.LeaseID, R.RentChargeDept, R.BRFrequency, " & _
                        "R.BRStartDate, R.BRNextDueDate, R.BRTotal, " & _
                        "R.BRAmount, R.spare1 AS ChargingMethod, R.BRDemandType, " & _
                        "R.RentDesc, R.spare2, Units.PropertyID, " & _
                        "DemandTypes.Spare1 as ClientBankID, Frequencies.CalDays, R.StopRC " & _
                    "FROM LRentCharges AS R, LeaseDetails AS L, Units, DemandTypes, Frequencies "

         If frmDemandTypesSel.cboGDPFreq.Column(0) = 0 Then

            szSQLStr = szSQLStr & _
                        "WHERE R.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                            "R.LeaseID = L.LeaseID AND (R.StopAutoDmd = FALSE OR L.GPrataDmd =FALSE OR " & _
                            "(R.StopAutoDmd = TRUE AND L.EndDate >= CDATE(R.FDD))) AND " & _
                            "L.UnitNumber = Units.UnitNumber AND " & _
                            "R.BRTotal > 0 AND (ISNULL(R.spare3) OR R.spare3 <> 'DELETED') AND " & _
                            "R.BRDemandType = DemandTypes.ID AND " & _
                            "R.BRFrequency = Frequencies.ID AND L.Status;"
         Else

            szSQLStr = szSQLStr & _
                        "WHERE R.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                            "R.LeaseID = L.LeaseID AND (R.StopAutoDmd = FALSE OR L.GPrataDmd =FALSE OR " & _
                            "(R.StopAutoDmd = TRUE AND L.EndDate >= CDATE(R.FDD))) AND " & _
                            "L.UnitNumber = Units.UnitNumber AND " & _
                            "R.BRTotal > 0 AND (ISNULL(R.spare3) OR R.spare3 <> 'DELETED') AND " & _
                            "R.BRDemandType = DemandTypes.ID AND " & _
                            "R.BRFrequency = Frequencies.ID AND " & _
                            "Frequencies.ID = " & frmDemandTypesSel.cboGDPFreq.Column(0) & " AND L.Status;"
         End If
'Debug.Print szSQLStr
         Set adoRstRC = New ADODB.Recordset
         adoRstRC.Open szSQLStr, adoConn, adOpenDynamic, adLockPessimistic

         While Not adoRstRC.EOF
            If IsNull(adoRstRC!StopRC) Or adoRstRC!StopRC = "" Then
               bProceed = True
            Else
               bProceed = IIf(DateDiff("d", adoRstRC!BRNextDueDate, CDate(adoRstRC!StopRC)) > 0, True, False)
            End If

            If adoRstLeaseDtl!BRPayable = "Y" And _
                  DateDiff("d", Date, IIf(adoRstRC!BRNextDueDate = "", _
                  DateAdd("d", -1, Date), adoRstRC!BRNextDueDate)) <= DaysB4Due And bProceed And _
                  IsDmdTypeSel(adoRstRC.Fields("BRDemandType").Value) And _
                  IIf(adoRstLeaseDtl!OLED, True, adoRstLeaseDtl!EndDate > adoRstRC!BRNextDueDate) Then

'   **** Insert the Header info in the DemandRecords table
               lDemand = NextRef(adoConn, "DEMAND_REF")        'GET THE NEXT DEMAND ID
               With adoRstDemandRec
                  .AddNew
                  .Fields.Item("DemandID").Value = lDemand
                  .Fields.Item("CreatedBy").Value = User
                  .Fields.Item("CreatedDate").Value = Now
                  lArrDemand(UBound(lArrDemand)) = lDemand
                  ReDim Preserve lArrDemand(UBound(lArrDemand) + 1) As Long

                  .Fields.Item("BatchID").Value = lBatch
                  .Fields.Item("SageAccountNumber").Value = adoRstLeaseDtl!SageAccountNumber
                  .Fields.Item("TenantCompanyName").Value = adoRstLeaseDtl!CompanyName
                  .Fields.Item("UnitNumber").Value = adoRstLeaseDtl!UnitNumber
                  .Fields.Item("Source").Value = 1
                  .Fields.Item("TransactionType").Value = 1
'*** Here my thinking is, all type of demands due date is on the same day
'*** If its not correct then i have to change the manual demands grid and the demand table & split table.
                  .Fields.Item("IssueDate").Value = Format(frmDemandTypesSel.txtInitialIssueDate.text, "dd/mm/yyyy")
                  .Fields.Item("SageText").Value = adoRstLeaseDtl!SageAccountNumber
                  .Fields.Item("IsPrinted").Value = False
                  .Fields.Item("Spare1").Value = adoRstRC!ClientBankID
                  .Fields.Item("LeaseRef").Value = adoRstLeaseDtl!LeaseID
                  .Fields.Item("DmdSlNo").Value = SlNumber("SI", "DemandRecords", adoConn)
                  .Fields.Item("SuppText1").Value = adoRstLeaseDtl.Fields.Item("SuppText1").Value
                  .Fields.Item("SentByEmail").Value = IIf(adoRstLeaseDtl.Fields.Item("EmailDmd").Value, Null, 2)
                  .Fields.Item("PostingDate").Value = Format(frmDemandTypesSel.txtPostingDate.text, "dd mmmm yyyy")
                  'aded by anol 16 08 2016
                  .Fields.Item("SO").Value = True
                  .Fields.Item("LastModifiedBy").Value = User
                  .Fields.Item("LastModifiedDate").Value = Now
                  .Update
               End With

'               iChildId = 1

               szDes = IIf(IIf(IsNull(adoRstRC!RentDesc), "", adoRstRC!RentDesc) = "", DemandTypeName(adoRstRC!BRDemandType, adoConn), adoRstRC!RentDesc)

               dtNtDueDate = FindNextDueDate(adoRstRC!BRNextDueDate, _
                                 adoRstRC!BRfrequency, adoRstRC!BRDemandType, adoRstRC!propertyID, adoConn)
               dtFDD = FindNextDueDate(dtNtDueDate, _
                                             adoRstRC!BRfrequency, _
                                             adoRstRC!BRDemandType, _
                                             adoRstRC!propertyID, adoConn)

''******* if the override lease end date is false then the lease is open, lease is not expiring.
''******* if the lease end date is open then we dont need to compare the NextDueDate with the lease expaire date.
'               If Not adoRstLeaseDtl.Fields("OLED").Value Then
'                  dtEndDate = Format(DateAdd("d", 1, adoRstLeaseDtl!EndDate), "dd/mm/yyyy")
'                  If DateDiff("d", dtEndDate, dtNtDueDate) > 0 Then dtNtDueDate = dtEndDate
'               End If

               With adoRstSplitDemand
                  .AddNew
                  !DSR = UniqueID()
                  !splitID = 1
                  !DEMANDID = lDemand
                  !A_M = "A"
                  !NominalCodeforAmount = PartString(szaNCode(adoRstRC!BRDemandType), 0, " # ")
                  !NominalNameforAmount = PartString(szaNCName(adoRstRC!BRDemandType), 0, " # ")
                  !NominalCodeForVAT = PartString(szaNCode(adoRstRC!BRDemandType), 1, " # ")
                  !NominalNameforVAT = PartString(szaNCName(adoRstRC!BRDemandType), 1, " # ")
                  !NominalCodeForTotal = PartString(szaNCode(adoRstRC!BRDemandType), 2, " # ")
                  !NominalNameforTotal = PartString(szaNCName(adoRstRC!BRDemandType), 2, " # ")
                  !amount = adoRstRC!BRAmount
                  !VATAMOUNT = RoundingNumber(adoRstRC!BRAmount * GetVAT_Tenant(adoRstLeaseDtl!SageAccountNumber, adoConn) / 100, 2)
                  !TotalAmount = !amount + !VATAMOUNT
'                  !SageRef = szaPrefix(adoRstRC!BRDemandType) & Format(SlNumber("SI", "DemandRecords", adoConn), "00000")
                  !DueDate = Format(adoRstRC!BRNextDueDate, "dd/mm/yyyy")
                  !VATMonth = Month(adoRstRC!BRNextDueDate)
                  !TypeOfDemand = adoRstRC!BRDemandType
                  !description = szDes
                  !DemandStatement = True
                  !VAT_CODE = GetVATCode_Tenant(adoRstLeaseDtl!SageAccountNumber, adoConn)
                  If !VAT_CODE = -1 Then
                        !VAT_CODE = Null
                  End If
                  If Left(adoRstRC!CalDays, 1) <> "-" Then
'                             ADVANCE
                     !dateFrom = CDate(adoRstRC!BRNextDueDate)
                     !DateTO = DateAdd("d", -1, dtNtDueDate)
                  Else
'                             ARREARS
'                     !DateFrom = DateAdd(Right(adoRstRC!CalDays, 1), Left(adoRstRC!CalDays, Len(adoRstRC!CalDays) - 1), adoRstRC!BRNextDueDate) 'CDate(adoRstRC!BRNextDueDate)
                     !dateFrom = ArrFromDate(adoRstRC.Fields.Item("BRNextDueDate"), _
                                    adoRstRC.Fields.Item("BRfrequency"), _
                                    adoRstRC.Fields.Item("BRDemandType"), _
                                    adoRstRC.Fields.Item("PropertyID"), _
                                    adoRstRC.Fields.Item("CalDays"), adoConn)
                     !DateTO = DateAdd("d", -1, adoRstRC!BRNextDueDate)
                  End If
                   'new requirement from WD they want  Startdate and end date as 2nd ref 2019-11-18
                  !SageRef = Format(!dateFrom, "dd/mm/yy") & "-" & Format(!DateTO, "dd/mm/yy")

                  !SageDepartment = adoRstRC!RentChargeDept ' DepartmentID(adoRstLeaseDtl!SageAccountNumber, adoRstLeaseDtl!UnitNumber, "Rent Charges", adoConn)
                  !FrequencyID = adoRstRC!BRfrequency
                  !ChargingFigure = adoRstRC!spare2
                  !ChargingMethod = CByte(IIf(IsNull(adoRstRC!ChargingMethod), "", adoRstRC!ChargingMethod))
                  .Update
               End With

               UpdateNextDueDate "LRentCharges", "BRNextDueDate", dtNtDueDate, "RentCharges", adoRstRC!RentCharges, adoConn
               SetFDD "LRentCharges", "FDD", dtFDD, "RentCharges", adoRstRC!RentCharges, adoConn

               BRcount = BRcount + 1
               iSerial = iSerial + 1
            End If
            adoRstRC.MoveNext
         Wend
         adoRstRC.Close
'*********************************************************************************************************
'         Rent Charges Demands        ---->  PRO-RATA                                                    '
'*********************************************************************************************************
         szSQLStr = "SELECT R.RentCharges, R.LeaseID, R.RentChargeDept, R.BRFrequency, " & _
                        "R.BRStartDate, R.BRNextDueDate, R.BRTotal, R.BRAmount, " & _
                        "R.spare1 AS ChargingMethod, R.BRDemandType, R.RentDesc,R.FDD, " & _
                        "R.spare2, Units.PropertyID, DemandTypes.Spare1 as ClientBankID, " & _
                        "Frequencies.CalDays, R.StopRC,Frequencies.ID " & _
                    "FROM LRentCharges AS R, LeaseDetails AS L, Units, DemandTypes, Frequencies "

         If frmDemandTypesSel.cboGDPFreq.Column(0) = 0 Then 'all frequency

                szSQLStr = szSQLStr & _
                        "WHERE R.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                            "L.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                            "L.GPrataDmd = TRUE AND " & _
                            "R.StopAutoDmd = TRUE AND " & _
                            "L.EndDate <= CDATE(R.FDD) AND " & _
                            "L.UnitNumber = Units.UnitNumber AND " & _
                            "R.BRTotal > 0 AND (ISNULL(R.spare3) OR R.spare3 <> 'DELETED') AND " & _
                            "R.BRDemandType = DemandTypes.ID AND " & _
                            "R.BRFrequency = Frequencies.ID AND L.Status;"
         Else


            szSQLStr = szSQLStr & _
                        "WHERE R.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                            "L.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                            "L.GPrataDmd = TRUE AND " & _
                            "R.StopAutoDmd = TRUE AND " & _
                            "L.EndDate <= CDATE(R.FDD) AND " & _
                            "L.UnitNumber = Units.UnitNumber AND " & _
                            "R.BRTotal > 0 AND (ISNULL(R.spare3) OR R.spare3 <> 'DELETED') AND " & _
                            "R.BRDemandType = DemandTypes.ID AND " & _
                            "R.BRFrequency = Frequencies.ID AND " & _
                            "Frequencies.ID = " & frmDemandTypesSel.cboGDPFreq.Column(0) & " AND L.Status;"
                            
         End If
'Debug.Print szSQLStr
         adoRstRC.Open szSQLStr, adoConn, adOpenStatic, adLockReadOnly

         While Not adoRstRC.EOF
            If IsNull(adoRstRC!StopRC) Or adoRstRC!StopRC = "" Then
               bProceed = True
            Else
               bProceed = IIf(DateDiff("d", adoRstRC!BRNextDueDate, CDate(adoRstRC!StopRC)) > 0, True, False)
            End If

            If adoRstLeaseDtl!BRPayable = "Y" And _
               DateDiff("d", Date, IIf(adoRstRC!BRNextDueDate = "", _
                  DateAdd("d", -1, Date), adoRstRC!BRNextDueDate)) <= DaysB4Due And bProceed And _
                  IsDmdTypeSel(adoRstRC.Fields("BRDemandType").Value) Then

'   **** Insert the Header info in the DemandRecords table
               lDemand = NextRef(adoConn, "DEMAND_REF")        'GET THE NEXT DEMAND ID
               With adoRstDemandRec
                  .AddNew
                  .Fields.Item("DemandID").Value = lDemand
                  .Fields.Item("CreatedBy").Value = User
                  .Fields.Item("CreatedDate").Value = Now

                  lArrDemand(UBound(lArrDemand)) = lDemand
                  ReDim Preserve lArrDemand(UBound(lArrDemand) + 1) As Long

                  .Fields.Item("BatchID").Value = lBatch
                  .Fields.Item("SageAccountNumber").Value = adoRstLeaseDtl!SageAccountNumber
                  .Fields.Item("TenantCompanyName").Value = adoRstLeaseDtl!CompanyName
                  .Fields.Item("UnitNumber").Value = adoRstLeaseDtl!UnitNumber
                  .Fields.Item("Source").Value = 1
                  .Fields.Item("TransactionType").Value = 1
'*** Here my thinking is, all type of demands due date is on the same day
'*** If its not correct then i have to change the manual demands grid and the demand table & split table.
                  .Fields.Item("IssueDate").Value = Format(frmDemandTypesSel.txtInitialIssueDate.text, "dd/mm/yyyy")
                  .Fields.Item("SageText").Value = adoRstLeaseDtl!SageAccountNumber
                  .Fields.Item("IsPrinted").Value = False
                  .Fields.Item("Spare1").Value = adoRstRC!ClientBankID
                  .Fields.Item("LeaseRef").Value = adoRstLeaseDtl!LeaseID
                  .Fields.Item("DmdSlNo").Value = SlNumber("SI", "DemandRecords", adoConn)
                  .Fields.Item("SuppText1").Value = adoRstLeaseDtl.Fields.Item("SuppText1").Value
                  .Fields.Item("SentByEmail").Value = IIf(adoRstLeaseDtl.Fields.Item("EmailDmd").Value, Null, 2)
                  .Fields.Item("PostingDate").Value = Format(frmDemandTypesSel.txtPostingDate.text, "dd mmmm yyyy")
                  'aded by anol 16 08 2016
                  .Fields.Item("SO").Value = True
                  .Fields.Item("LastModifiedBy").Value = User
                  .Fields.Item("LastModifiedDate").Value = Now
                  .Update
               End With

'               iChildId = 1
               szDes = IIf(IIf(IsNull(adoRstRC!RentDesc), "", adoRstRC!RentDesc) = "", DemandTypeName(adoRstRC!BRDemandType, adoConn), adoRstRC!RentDesc)

               dtNtDueDate = FindNextDueDate(adoRstRC!BRNextDueDate, _
                                 adoRstRC!BRfrequency, adoRstRC!BRDemandType, adoRstRC!propertyID, adoConn)

''******* if the override lease end date is false then the lease is open, lease is not expairing.
''******* if the lease end date is open then we dont need to compare the NextDueDate with the lease expaire date.
'               If Not adoRstLeaseDtl.Fields("OLED").Value Then
'                  dtEndDate = Format(DateAdd("d", 1, adoRstLeaseDtl!EndDate), "dd/mm/yyyy")
'                  If DateDiff("d", dtEndDate, dtNtDueDate) > 0 Then dtNtDueDate = dtEndDate
'               End If

               With adoRstSplitDemand
                  .AddNew
                  !DSR = UniqueID()
                  !splitID = 1
                  !DEMANDID = lDemand
                  !A_M = "A"
                  !NominalCodeforAmount = PartString(szaNCode(adoRstRC!BRDemandType), 0, " # ")
                  !NominalNameforAmount = PartString(szaNCName(adoRstRC!BRDemandType), 0, " # ")
                  !NominalCodeForVAT = PartString(szaNCode(adoRstRC!BRDemandType), 1, " # ")
                  !NominalNameforVAT = PartString(szaNCName(adoRstRC!BRDemandType), 1, " # ")
                  !NominalCodeForTotal = PartString(szaNCode(adoRstRC!BRDemandType), 2, " # ")
                  !NominalNameforTotal = PartString(szaNCName(adoRstRC!BRDemandType), 2, " # ")
'                  !SageRef = "EL" 'szaPrefix(adoRstRC!BRDemandType) & Format(SlNumber("SI", "DemandRecords", adoConn), "00000")
                  !DueDate = Format(adoRstRC!BRNextDueDate, "dd/mm/yyyy")
                  !VATMonth = Month(adoRstRC!BRNextDueDate)
                  !TypeOfDemand = adoRstRC!BRDemandType
                  !description = szDes
                  !DemandStatement = True
                  !VAT_CODE = GetVATCode_Tenant(adoRstLeaseDtl!SageAccountNumber, adoConn)
                  If !VAT_CODE = -1 Then
                        !VAT_CODE = Null
                  End If
                  If Left(adoRstRC!CalDays, 1) <> "-" Then  '                          ADVANCE
                     !dateFrom = CDate(adoRstRC!BRNextDueDate)
                  Else                                      '                          ARREARS
'                     !DateFrom = DateAdd(Right(adoRstRC!CalDays, 1), Left(adoRstRC!CalDays, Len(adoRstRC!CalDays) - 1), adoRstRC!BRNextDueDate) 'CDate(adoRstRC!BRNextDueDate)
                     !dateFrom = ArrFromDate(adoRstRC.Fields.Item("BRNextDueDate"), _
                                    adoRstRC.Fields.Item("BRfrequency"), _
                                    adoRstRC.Fields.Item("BRDemandType"), _
                                    adoRstRC.Fields.Item("PropertyID"), _
                                    adoRstRC.Fields.Item("CalDays"), adoConn)
                  End If
                  !DateTO = adoRstLeaseDtl!EndDate
                   'new requirement from WD they want  Startdate and end date as 2nd ref 2019-11-18
                  !SageRef = Format(!dateFrom, "dd/mm/yy") & "-" & Format(!DateTO, "dd/mm/yy")
                  'Here one issue we need to resolve calculation should not be based on from date and todate rather its should be based on frequency table anol 2020-06-09 issue 853
                 ' !amount = RoundingNumber(Val(adoRstRC!BRTotal / szaPartofYear(adoRstRC("ID").Value)), 2)
                 If DateDiff("d", adoRstLeaseDtl!EndDate, adoRstRC.Fields.Item("FDD")) = 1 Then
                    'do not calculatate prorata ,calculate full
                    !amount = RoundingNumber(Val(adoRstRC.Fields.Item("BRTotal") / szaPartofYear(adoRstRC("ID").Value)), 2)
                  Else
                    'calculate prorata and also add 1 day with datediff
                     !amount = RoundingNumber((Val(adoRstRC.Fields.Item("BRTotal")) / 365) * (DateDiff("D", !dateFrom, !DateTO) + 1), 2)
                  End If
                  '!amount = RoundingNumber((Val(adoRstRC!BRTotal) / 365) * (DateDiff("D", !DateFrom, !DateTo) + 1), 2)
                  !VATAMOUNT = RoundingNumber(!amount * GetVAT_Tenant(adoRstLeaseDtl!SageAccountNumber, adoConn) / 100, 2)
                  !TotalAmount = !amount + !VATAMOUNT

                  !SageDepartment = adoRstRC!RentChargeDept ' DepartmentID(adoRstLeaseDtl!SageAccountNumber, adoRstLeaseDtl!UnitNumber, "Rent Charges", adoConn)
                  !FrequencyID = adoRstRC!BRfrequency
                  !ChargingFigure = adoRstRC!spare2
                  !ChargingMethod = CByte(IIf(IsNull(adoRstRC!ChargingMethod), "", adoRstRC!ChargingMethod))
                  .Update
               End With

               UpdateNextDueDate "LRentCharges", "BRNextDueDate", dtNtDueDate, "RentCharges", adoRstRC!RentCharges, adoConn
               MarkGPD "LRentCharges", True, "RentCharges", adoRstRC!RentCharges, adoConn

               BRcount = BRcount + 1
               iSerial = iSerial + 1
            End If
            adoRstRC.MoveNext
         Wend
         adoRstRC.Close
         Set adoRstRC = Nothing


        Call WriteServiceChargesSng(adoConn, adoRstLeaseDtl, adoRstDemandRec, adoRstSplitDemand, DaysB4Due, szaNCode, szaNCName, szaPartofYear, SCcount, SCYRCount)

'************************************************************************************************
'   Insurance Charge demands
'************************************************************************************************
         szSQLStr = "SELECT I.InsCharges, I.LeaseID, " & _
                        "I.InsuranceStartDate, I.InsuranceFrequency, " & _
                        "I.InsuranceEndDate, I.InsuranceDemandType, " & _
                        "I.InsuranceEachPeriod, I.InsuranceNextDueDate, " & _
                        "I.ChargingType, " & _
                        "I.ChargingFigure, I.TotalYearlyInsurance, " & _
                        "I.InsuranceDept, I.InsDesc, " & _
                        "Units.PropertyID, DemandTypes.Spare1 as ClientBankID, " & _
                        "Frequencies.CalDays, StopIC " & _
                    "FROM LInsuranceCharges AS I, LeaseDetails, Units, DemandTypes, Frequencies "

         If frmDemandTypesSel.cboGDPFreq.Column(0) = 0 Then

            szSQLStr = szSQLStr & _
                    "WHERE I.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                        "I.LeaseID = LeaseDetails.LeaseID AND (I.StopAutoDmd = FALSE OR LeaseDetails.GPrataDmd =FALSE OR " & _
                        "(I.StopAutoDmd = TRUE AND LeaseDetails.EndDate >= CDATE(I.FDD))) AND " & _
                        "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
                        "I.InsuranceEachPeriod > 0 AND (ISNULL(I.spare3) OR I.spare3 <> 'DELETED') AND " & _
                        "I.InsuranceDemandType = DemandTypes.ID AND " & _
                        "I.InsuranceFrequency = Frequencies.ID AND LeaseDetails.Status;"
         Else

        szSQLStr = szSQLStr & _
                    "WHERE I.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                        "I.LeaseID = LeaseDetails.LeaseID AND (I.StopAutoDmd = FALSE OR LeaseDetails.GPrataDmd =FALSE OR " & _
                        "(I.StopAutoDmd = TRUE AND LeaseDetails.EndDate >= CDATE(I.FDD))) AND " & _
                        "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
                        "I.InsuranceEachPeriod > 0 AND (ISNULL(I.spare3) OR I.spare3 <> 'DELETED') AND " & _
                        "I.InsuranceDemandType = DemandTypes.ID AND " & _
                        "I.InsuranceFrequency = Frequencies.ID AND " & _
                        "Frequencies.ID = " & frmDemandTypesSel.cboGDPFreq.Column(0) & " AND LeaseDetails.Status;"
         End If

         Set adoRstIns = New ADODB.Recordset
         adoRstIns.Open szSQLStr, adoConn, adOpenDynamic, adLockPessimistic

         While Not adoRstIns.EOF
            If IsNull(adoRstIns!StopIC) Or adoRstIns!StopIC = "" Then
               bProceed = True
            Else
               bProceed = IIf(DateDiff("d", adoRstIns!InsuranceNextDueDate, CDate(adoRstIns!StopIC)) > 0, True, False)
            End If
            If adoRstLeaseDtl!InsurancePayable = "Y" And _
                  DateDiff("d", Date, IIf(adoRstIns!InsuranceNextDueDate = "", _
                  DateAdd("d", -1, Date), adoRstIns!InsuranceNextDueDate)) <= DaysB4Due And bProceed And _
                  IsDmdTypeSel(adoRstIns.Fields("InsuranceDemandType").Value) And _
                  IIf(adoRstLeaseDtl!OLED, True, adoRstLeaseDtl!EndDate > adoRstIns!InsuranceNextDueDate) Then

   '**** Insert the Header info in the DemandRecords table
               lDemand = NextRef(adoConn, "DEMAND_REF")        'GET THE NEXT DEMAND ID
               With adoRstDemandRec
                  .AddNew
                  .Fields("DemandID").Value = lDemand
                  .Fields("CreatedBy").Value = User
                  lArrDemand(UBound(lArrDemand)) = lDemand
                  ReDim Preserve lArrDemand(UBound(lArrDemand) + 1) As Long

                  .Fields("BatchID").Value = lBatch
                  .Fields("SageAccountNumber").Value = adoRstLeaseDtl!SageAccountNumber
                  .Fields("TenantCompanyName").Value = adoRstLeaseDtl!CompanyName
                  .Fields("UnitNumber").Value = adoRstLeaseDtl!UnitNumber
                  .Fields("Source").Value = 1
                  .Fields("TransactionType").Value = 1
   '***Here my thinking is, all type of demands due date is on the same day
   '***If its not correct then i have to change the manual demands grid and the demand table & split table
                  .Fields("IssueDate").Value = Format(frmDemandTypesSel.txtInitialIssueDate.text, "dd/mm/yyyy")
                  .Fields("SageText").Value = "S/L " & adoRstLeaseDtl!SageAccountNumber
                  .Fields("IsPrinted").Value = False
                  .Fields("Spare1").Value = adoRstIns!ClientBankID
                  .Fields.Item("LeaseRef").Value = adoRstLeaseDtl!LeaseID
                  .Fields.Item("DmdSlNo").Value = SlNumber("SI", "DemandRecords", adoConn)
                  .Fields.Item("SuppText1").Value = adoRstLeaseDtl.Fields.Item("SuppText1").Value
                  .Fields.Item("SentByEmail").Value = IIf(adoRstLeaseDtl.Fields.Item("EmailDmd").Value, Null, 2)
                  .Fields.Item("PostingDate").Value = Format(frmDemandTypesSel.txtPostingDate.text, "dd mmmm yyyy")
                  'aded by anol 16 08 2016
                  .Fields.Item("SO").Value = True
                  .Fields.Item("LastModifiedBy").Value = User
                  .Fields.Item("LastModifiedDate").Value = Now
                  .Update
               End With

'               iChildId = 1
               szDes = IIf(IIf(IsNull(adoRstIns!InsDesc), "", adoRstIns!InsDesc) = "", DemandTypeName(adoRstIns!InsuranceDemandType, adoConn), adoRstIns!InsDesc)

               dtNtDueDate = FindNextDueDate(adoRstIns!InsuranceNextDueDate, _
                              adoRstIns!InsuranceFrequency, _
                              adoRstIns!InsuranceDemandType, adoRstIns!propertyID, adoConn)
               dtFDD = FindNextDueDate(dtNtDueDate, _
                                             adoRstIns!InsuranceFrequency, _
                                             adoRstIns!InsuranceDemandType, _
                                             adoRstIns!propertyID, adoConn)


               With adoRstSplitDemand
                  .AddNew
                  !DSR = UniqueID()
                  !splitID = 1
                  !DEMANDID = lDemand
                  !A_M = "A"
                  !NominalCodeforAmount = PartString(szaNCode(adoRstIns!InsuranceDemandType), 0, " # ")
                  !NominalNameforAmount = PartString(szaNCName(adoRstIns!InsuranceDemandType), 0, " # ")
                  !NominalCodeForVAT = PartString(szaNCode(adoRstIns!InsuranceDemandType), 1, " # ")
                  !NominalNameforVAT = PartString(szaNCName(adoRstIns!InsuranceDemandType), 1, " # ")
                  !NominalCodeForTotal = PartString(szaNCode(adoRstIns!InsuranceDemandType), 2, " # ")
                  !NominalNameforTotal = PartString(szaNCName(adoRstIns!InsuranceDemandType), 2, " # ")
                  !amount = adoRstIns!InsuranceEachPeriod
                  !VATAMOUNT = RoundingNumber(adoRstIns!InsuranceEachPeriod * GetVAT_Tenant(adoRstLeaseDtl!SageAccountNumber, adoConn) / 100, 2)
                  !TotalAmount = !amount + !VATAMOUNT
'                  !SageRef = szaPrefix(adoRstIns!InsuranceDemandType) & Format(SlNumber("SI", "DemandRecords", adoConn), "00000")
                  !DueDate = Format(adoRstIns!InsuranceNextDueDate, "dd/mm/yyyy")
                  !VATMonth = Month(adoRstIns!InsuranceNextDueDate)
                  !TypeOfDemand = adoRstIns!InsuranceDemandType
                  !description = szDes
                  !DemandStatement = True
                  !VAT_CODE = GetVATCode_Tenant(adoRstLeaseDtl!SageAccountNumber, adoConn)
                  If !VAT_CODE = -1 Then
                        !VAT_CODE = Null
                  End If
                  If Left(adoRstIns!CalDays, 1) <> "-" Then
                  '           ADVANCE
                     !dateFrom = CDate(adoRstIns!InsuranceNextDueDate)
                     !DateTO = DateAdd("d", -1, dtNtDueDate)
                  Else
                  '           ARREARS
'                     !DateFrom = DateAdd(Right(adoRstIns!CalDays, 1), Left(adoRstIns!CalDays, Len(adoRstIns!CalDays) - 1), adoRstIns!InsuranceNextDueDate) 'CDate(adoRstIns!InsuranceNextDueDate)
                     !dateFrom = ArrFromDate(adoRstIns!InsuranceNextDueDate, _
                                             adoRstIns!InsuranceFrequency, _
                                             adoRstIns!InsuranceDemandType, _
                                             adoRstIns!propertyID, _
                                             adoRstIns!CalDays, adoConn)
                     !DateTO = DateAdd("d", -1, adoRstIns!InsuranceNextDueDate)
                  End If
                  'new requirement from WD they want  Startdate and end date as 2nd ref 2019-11-18
                  !SageRef = Format(!dateFrom, "dd/mm/yy") & "-" & Format(!DateTO, "dd/mm/yy")
                  
                  !SageDepartment = adoRstIns!InsuranceDept ' DepartmentID(adoRstLeaseDtl!SageAccountNumber, adoRstLeaseDtl!UnitNumber, "Insurance Charge", adoConn)
                  !FrequencyID = adoRstIns!InsuranceFrequency
                  !ChargingFigure = adoRstIns!ChargingFigure
                  !ChargingMethod = IIf(IsNull(adoRstIns!ChargingType), 0, adoRstIns!ChargingType)
                  .Update
               End With

               UpdateNextDueDate "LInsuranceCharges", "InsuranceNextDueDate", dtNtDueDate, "InsCharges", adoRstIns!InsCharges, adoConn
               SetFDD "LInsuranceCharges", "FDD", dtFDD, "InsCharges", adoRstIns!InsCharges, adoConn

               ICcount = ICcount + 1
               iSerial = iSerial + 1
            End If
            adoRstIns.MoveNext
         Wend
         adoRstIns.Close
'************************************************************************************************
'   Insurance Charge demands        --->     PRO-RATA
'************************************************************************************************
         szSQLStr = "SELECT I.InsCharges, I.LeaseID, " & _
                        "I.InsuranceStartDate, I.InsuranceFrequency, " & _
                        "I.InsuranceEndDate, I.InsuranceDemandType, " & _
                        "I.InsuranceEachPeriod, I.InsuranceNextDueDate,I.FDD, " & _
                        "I.ChargingType, " & _
                        "I.ChargingFigure, I.TotalYearlyInsurance, " & _
                        "I.InsuranceDept, I.InsDesc, " & _
                        "Units.PropertyID, DemandTypes.Spare1 as ClientBankID, " & _
                        "Frequencies.CalDays, StopIC,Frequencies.ID " & _
                    "FROM LInsuranceCharges AS I, LeaseDetails, Units, DemandTypes, Frequencies "

         If frmDemandTypesSel.cboGDPFreq.Column(0) = 0 Then
          'issue 331 Modified by anol 20170314

szSQLStr = szSQLStr & _
                    "WHERE I.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                        "LeaseDetails.GPrataDmd = TRUE AND " & _
                        "I.LeaseID = LeaseDetails.LeaseID AND I.StopAutoDmd = TRUE AND " & _
                        "LeaseDetails.EndDate < CDATE(I.FDD) AND " & _
                        "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
                        "I.InsuranceEachPeriod > 0 AND (ISNULL(I.spare3) OR I.spare3 <> 'DELETED') AND " & _
                        "I.InsuranceDemandType = DemandTypes.ID AND " & _
                        "I.InsuranceFrequency = Frequencies.ID AND LeaseDetails.Status;"
         Else

 szSQLStr = szSQLStr & _
                    "WHERE I.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                        "LeaseDetails.GPrataDmd = TRUE AND " & _
                        "I.LeaseID = LeaseDetails.LeaseID AND I.StopAutoDmd = TRUE AND " & _
                        "LeaseDetails.EndDate < CDATE(I.FDD) AND " & _
                        "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
                        "I.InsuranceEachPeriod > 0 AND (ISNULL(I.spare3) OR I.spare3 <> 'DELETED') AND " & _
                        "I.InsuranceDemandType = DemandTypes.ID AND " & _
                        "I.InsuranceFrequency = Frequencies.ID AND " & _
                        "Frequencies.ID = " & frmDemandTypesSel.cboGDPFreq.Column(0) & " AND LeaseDetails.Status;"
         End If

         adoRstIns.Open szSQLStr, adoConn, adOpenDynamic, adLockPessimistic

         While Not adoRstIns.EOF
            If IsNull(adoRstIns!StopIC) Or adoRstIns!StopIC = "" Then
               bProceed = True
            Else
               bProceed = IIf(DateDiff("d", adoRstIns!InsuranceNextDueDate, CDate(adoRstIns!StopIC)) > 0, True, False)
            End If
            If adoRstLeaseDtl!InsurancePayable = "Y" And _
                  DateDiff("d", Date, IIf(adoRstIns!InsuranceNextDueDate = "", _
                     DateAdd("d", -1, Date), adoRstIns!InsuranceNextDueDate)) <= DaysB4Due And bProceed And _
                     IsDmdTypeSel(adoRstIns.Fields("InsuranceDemandType").Value) Then

   '**** Insert the Header info in the DemandRecords table
               lDemand = NextRef(adoConn, "DEMAND_REF")        'GET THE NEXT DEMAND ID
               With adoRstDemandRec
                  .AddNew
                  .Fields("DemandID").Value = lDemand
                  .Fields.Item("CreatedBy").Value = User
                  .Fields.Item("CreatedDate").Value = Now

                  lArrDemand(UBound(lArrDemand)) = lDemand
                  ReDim Preserve lArrDemand(UBound(lArrDemand) + 1) As Long

                  .Fields.Item("BatchID").Value = lBatch
                  .Fields.Item("SageAccountNumber").Value = adoRstLeaseDtl!SageAccountNumber
                  .Fields.Item("TenantCompanyName").Value = adoRstLeaseDtl!CompanyName
                  .Fields.Item("UnitNumber").Value = adoRstLeaseDtl!UnitNumber
                  .Fields.Item("Source").Value = 1
                  .Fields.Item("TransactionType").Value = 1
   '***Here my thinking is, all type of demands due date is on the same day
   '***If its not correct then i have to change the manual demands grid and the demand table & split table
                  .Fields.Item("IssueDate").Value = Format(frmDemandTypesSel.txtInitialIssueDate.text, "dd/mm/yyyy")
                  .Fields.Item("SageText").Value = adoRstLeaseDtl!SageAccountNumber
                  .Fields.Item("IsPrinted").Value = False
                  .Fields.Item("Spare1").Value = adoRstIns!ClientBankID
                  .Fields.Item("LeaseRef").Value = adoRstLeaseDtl!LeaseID
                  .Fields.Item("DmdSlNo").Value = SlNumber("SI", "DemandRecords", adoConn)
                  .Fields.Item("SuppText1").Value = adoRstLeaseDtl.Fields.Item("SuppText1").Value
                  .Fields.Item("SentByEmail").Value = IIf(adoRstLeaseDtl.Fields.Item("EmailDmd").Value, Null, 2)
                  .Fields.Item("PostingDate").Value = Format(frmDemandTypesSel.txtPostingDate.text, "dd mmmm yyyy")
                   'aded by anol 16 08 2016
                  .Fields.Item("SO").Value = True
                  .Fields.Item("LastModifiedBy").Value = User
                  .Fields.Item("LastModifiedDate").Value = Now
                  .Update
               End With

'               iChildId = 1
               szDes = IIf(IIf(IsNull(adoRstIns!InsDesc), "", adoRstIns!InsDesc) = "", DemandTypeName(adoRstIns!InsuranceDemandType, adoConn), adoRstIns!InsDesc)



               With adoRstSplitDemand
                  .AddNew
                  !DSR = UniqueID()
                  !splitID = 1
                  !DEMANDID = lDemand
                  !A_M = "A"
                  !NominalCodeforAmount = PartString(szaNCode(adoRstIns!InsuranceDemandType), 0, " # ")
                  !NominalNameforAmount = PartString(szaNCName(adoRstIns!InsuranceDemandType), 0, " # ")
                  !NominalCodeForVAT = PartString(szaNCode(adoRstIns!InsuranceDemandType), 1, " # ")
                  !NominalNameforVAT = PartString(szaNCName(adoRstIns!InsuranceDemandType), 1, " # ")
                  !NominalCodeForTotal = PartString(szaNCode(adoRstIns!InsuranceDemandType), 2, " # ")
                  !NominalNameforTotal = PartString(szaNCName(adoRstIns!InsuranceDemandType), 2, " # ")
'                  !SageRef = "EL" 'szaPrefix(adoRstIns!InsuranceDemandType) & Format(SlNumber("SI", "DemandRecords", adoConn), "00000")
                  !DueDate = Format(adoRstIns!InsuranceNextDueDate, "dd/mm/yyyy")
                  !VATMonth = Month(adoRstIns!InsuranceNextDueDate)
                  !TypeOfDemand = adoRstIns!InsuranceDemandType
                  !description = szDes
                  !DemandStatement = True
                  !VAT_CODE = GetVATCode_Tenant(adoRstLeaseDtl!SageAccountNumber, adoConn)
                  If !VAT_CODE = -1 Then
                     !VAT_CODE = Null
                  End If

                  If Left(adoRstIns!CalDays, 1) <> "-" Then                  '           ADVANCE
                     !dateFrom = CDate(adoRstIns!InsuranceNextDueDate)
                  Else                                                       '           ARREARS
'                     !DateFrom = DateAdd(Right(adoRstIns!CalDays, 1), Left(adoRstIns!CalDays, Len(adoRstIns!CalDays) - 1), adoRstIns!InsuranceNextDueDate) 'CDate(adoRstIns!InsuranceNextDueDate)
                     !dateFrom = ArrFromDate(adoRstIns!InsuranceNextDueDate, _
                                             adoRstIns!InsuranceFrequency, _
                                             adoRstIns!InsuranceDemandType, _
                                             adoRstIns!propertyID, _
                                             adoRstIns!CalDays, adoConn)
                  End If
                  !DateTO = adoRstLeaseDtl!EndDate
                   'new requirement from WD they want  Startdate and end date as 2nd ref 2019-11-18
                  !SageRef = Format(!dateFrom, "dd/mm/yy") & "-" & Format(!DateTO, "dd/mm/yy")
                  ' anol 2020-06-11
                  If DateDiff("d", adoRstLeaseDtl!EndDate, adoRstIns.Fields.Item("FDD")) = 1 Then
                       'do not calculatate prorata ,calculate full
                       !amount = RoundingNumber(Val(adoRstIns.Fields.Item("TotalYearlyInsurance") / szaPartofYear(adoRstIns("ID").Value)), 2)
                   Else
                       'calculate prorata and also add 1 day with datediff
                       !amount = RoundingNumber((Val(adoRstIns.Fields.Item("TotalYearlyInsurance")) / 365) * (DateDiff("D", !dateFrom, !DateTO) + 1), 2)
                   End If
                  '!amount = RoundingNumber((Val(adoRstIns!TotalYearlyInsurance) / 365) * DateDiff("D", !DateFrom, !DateTo), 2)
                  !VATAMOUNT = RoundingNumber(!amount * GetVAT_Tenant(adoRstLeaseDtl!SageAccountNumber, adoConn) / 100, 2)
                  !TotalAmount = !amount + !VATAMOUNT

                  !SageDepartment = adoRstIns!InsuranceDept ' DepartmentID(adoRstLeaseDtl!SageAccountNumber, adoRstLeaseDtl!UnitNumber, "Insurance Charge", adoConn)
                  !FrequencyID = adoRstIns!InsuranceFrequency
                  !ChargingFigure = adoRstIns!ChargingFigure
                  !ChargingMethod = IIf(IsNull(adoRstIns!ChargingType), 0, adoRstIns!ChargingType)
                  .Update
               End With

               UpdateNextDueDate "LInsuranceCharges", "InsuranceNextDueDate", dtNtDueDate, "InsCharges", adoRstIns!InsCharges, adoConn
               MarkGPD "LInsuranceCharges", True, "InsCharges", adoRstIns!InsCharges, adoConn

               ICcount = ICcount + 1
               iSerial = iSerial + 1
            End If
            adoRstIns.MoveNext
         Wend
         adoRstIns.Close
         Set adoRstIns = Nothing
'MsgBox adoRstLeaseDtl.RecordCount
         adoRstLeaseDtl.MoveNext
      Wend

      adoRstLeaseDtl.Close
      adoRstDemandRec.Close
      adoRstSplitDemand.Close

      Set adoRstLeaseDtl = Nothing
      Set adoRstDemandRec = Nothing
      Set adoRstSplitDemand = Nothing
     If iSerial > 0 Then
        frmMMain.Leasee1_LesseList_isUptoDate = False
        frmMMain.Leasee4_LesseList_isUptoDate = False
        frmMMain.frmDemand3_LesseList_isUptoDate = False
     End If
      
   End If

'   MousePointer = vbDefault

   Dim Msg As String

   Msg = Msg & BRcount & " Demands for Rent were generated." & Chr(13)
   Msg = Msg & SCcount & " Demands for Service Charge were generated." & Chr(13)
   Msg = Msg & IPcount & " Demands for Interest Payment were generated." & Chr(13)
   Msg = Msg & ICcount & " Demands for Insurance Payment were generated." & Chr(13)
   Msg = Msg & UUcount & " Demands for Utility Payment were generated." & Chr(13)
   Msg = Msg & "A total of " & BRcount + SCcount + IPcount + ICcount + UUcount & " demands were generated."

'  Export Transactions to Nominal Ledger (NLPosting table)
' added by anol 20170112
' an error was occuring on the next procedure ......"no transaction to save"
   If adoConn.State = 1 Then
        adoConn.Close
   End If
   adoConn.Open getConnectionString
   Export_SInSC_2_NL adoConn
'--------------------------------------------------------------------------------------

   MsgBox Msg, vbOKOnly + vbInformation, "Demands Generated"
   Exit Sub
ErrH:
       'This can only pick up error 13 (type mis-match) and it is at the users discretion to not enter a date.
       MsgBox Err.Number & " - (pcm_001)" & Err.description, vbOKOnly, "Error"
End Sub
Private Sub WriteServiceChargesSng(adoConn As ADODB.Connection, adoRstLeaseDtl As ADODB.Recordset, adoRstDemandRec As ADODB.Recordset, _
        adoRstSplitDemand As ADODB.Recordset, DaysB4Due As Integer, szaNCode() As String, _
        szaNCName() As String, szaPartofYear() As Integer, SCcount As Integer, SCYRCount As Integer)
    Dim bSC As Boolean
    Dim bProceed As Boolean
    Dim bPRSC As Boolean
    Dim bSCNeg As Boolean
    Dim bPRSCNeg As Boolean
    Dim szSQLStr As String
    Dim lDemand As Long
    Dim lBatch As Long

    Dim iChildId As Long
    Dim iSerial As Long
    Dim szDes As String
    Dim dtNtDueDate As Date
    Dim dtFDD As Date
    Dim adoRstSC As New ADODB.Recordset
    Dim adoRstSCNeg As New ADODB.Recordset
    Dim adoPRRstSC As New ADODB.Recordset
    Dim adoPRRstSCNeg As New ADODB.Recordset
'************************************************************************************************
'   Service Charge demands
'************************************************************************************************
         szSQLStr = "SELECT S.ServiceCharge, S.LeaseID, " & _
                        "S.SCFrequency, S.SCPayableFrom, " & _
                        "S.SCNextDueDate, S.ChargingMethod, " & _
                        "S.CMFigure, S.SCTotal, S.SCAmount, " & _
                        "S.SCTOLimit, S.SCDemandType, StopSC, " & _
                        "S.ServiceChargeDept, S.SCDesc, " & _
                        "Units.PropertyID, " & _
                        "DemandTypes.Spare1 as ClientBankID, Frequencies.CalDays " & _
                    "FROM LServiceCharges AS S, LeaseDetails, Units, DemandTypes, Frequencies "

         If frmDemandTypesSel.cboGDPFreq.Column(0) = 0 Then

            szSQLStr = szSQLStr & _
                    "WHERE S.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                        "S.LeaseID = LeaseDetails.LeaseID AND (S.StopAutoDmd = FALSE OR LeaseDetails.GPrataDmd =FALSE OR " & _
                        "(S.StopAutoDmd = TRUE AND LeaseDetails.EndDate >= CDATE(S.FDD))) AND " & _
                        "S.SCAmount > 0 AND LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
                        "(ISNULL(S.spare3) OR S.spare3 <> 'DELETED') AND " & _
                        "S.SCDemandType = DemandTypes.ID AND " & _
                        "S.SCFrequency = Frequencies.ID AND LeaseDetails.Status;"
         Else

            szSQLStr = szSQLStr & _
                    "WHERE S.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                        "S.LeaseID = LeaseDetails.LeaseID AND (S.StopAutoDmd = FALSE OR  LeaseDetails.GPrataDmd =FALSE OR " & _
                        "(S.StopAutoDmd = TRUE AND LeaseDetails.EndDate >= CDATE(S.FDD))) AND " & _
                        "S.SCAmount > 0 AND LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
                        " (ISNULL(S.spare3) OR S.spare3 <> 'DELETED') AND " & _
                        "S.SCDemandType = DemandTypes.ID AND " & _
                        "S.SCFrequency = Frequencies.ID AND " & _
                        "Frequencies.ID = " & frmDemandTypesSel.cboGDPFreq.Column(0) & " AND LeaseDetails.Status;"
         End If
        'Remming S.SCAmount > 0 AND  2020-12-02 issue 898
         Set adoRstSC = New ADODB.Recordset

         adoRstSC.Open szSQLStr, adoConn, adOpenStatic, adLockReadOnly
         
        
         ReDim szSCYR(adoRstSC.RecordCount, 2) As String
         SCYRCount = 0
         While Not adoRstSC.EOF
            If IsNull(adoRstSC!StopSC) Or adoRstSC!StopSC = "" Then
               bProceed = True
            Else
               bProceed = IIf(DateDiff("d", adoRstSC!SCNextDueDate, CDate(adoRstSC!StopSC)) > 0, True, False)
            End If
            If adoRstLeaseDtl!SCPayable = "Y" And _
               DateDiff("d", Date, IIf(adoRstSC!SCNextDueDate = "", _
                  DateAdd("d", -1, Date), adoRstSC!SCNextDueDate)) <= DaysB4Due And bProceed And _
                     IsDmdTypeSel(adoRstSC.Fields("SCDemandType").Value) And _
               IIf(adoRstLeaseDtl!OLED, True, adoRstLeaseDtl!EndDate > adoRstSC!SCNextDueDate) Then
'**** Insert the Header info in the DemandRecords table
               lDemand = NextRef(adoConn, "DEMAND_REF")        'GET THE NEXT DEMAND ID
               With adoRstDemandRec
                  .AddNew
                  .Fields("DemandID").Value = lDemand
                  .Fields("CreatedBy").Value = User
                  .Fields("CreatedDate").Value = Now

                  lArrDemand(UBound(lArrDemand)) = lDemand
                  ReDim Preserve lArrDemand(UBound(lArrDemand) + 1) As Long

                  .Fields("BatchID").Value = lBatch
                  .Fields("SageAccountNumber").Value = adoRstLeaseDtl!SageAccountNumber
                  .Fields("TenantCompanyName").Value = adoRstLeaseDtl!CompanyName
                  .Fields("UnitNumber").Value = adoRstLeaseDtl!UnitNumber
                  .Fields("Source").Value = 1
                  .Fields("TransactionType").Value = 1
'   ***Here my thinking is, all type of demands due date is on the same day
'   ***If its not correct then i have to change the manual demands grid and the demand table & split table
                  .Fields("IssueDate").Value = Format(frmDemandTypesSel.txtInitialIssueDate.text, "dd/mm/yyyy")
                  .Fields("SageText").Value = "S/L " & adoRstLeaseDtl!SageAccountNumber
                  .Fields("IsPrinted").Value = False
                  .Fields("Spare1").Value = adoRstSC!ClientBankID
                  .Fields.Item("LeaseRef").Value = adoRstLeaseDtl!LeaseID
                  .Fields.Item("DmdSlNo").Value = SlNumber("SI", "DemandRecords", adoConn)
                  .Fields.Item("SuppText1").Value = adoRstLeaseDtl.Fields.Item("SuppText1").Value
                  .Fields.Item("SentByEmail").Value = IIf(adoRstLeaseDtl.Fields.Item("EmailDmd").Value, Null, 2)
                  .Fields.Item("PostingDate").Value = Format(frmDemandTypesSel.txtPostingDate.text, "dd mmmm yyyy")
                  'aded by anol 16 08 2016
                  .Fields.Item("SO").Value = True
                   .Fields.Item("LastModifiedBy").Value = User
                  .Fields.Item("LastModifiedDate").Value = Now
                  .Update
               End With

'               iChildId = 1
               szDes = IIf(IIf(IsNull(adoRstSC!SCDesc), "", adoRstSC!SCDesc) = "", DemandTypeName(adoRstSC!SCDemandType, adoConn), adoRstSC!SCDesc)

               dtNtDueDate = FindNextDueDate(adoRstSC!SCNextDueDate, _
                                 adoRstSC!SCFrequency, adoRstSC!SCDemandType, adoRstSC!propertyID, adoConn)
               dtFDD = FindNextDueDate(dtNtDueDate, _
                                             adoRstSC!SCFrequency, _
                                             adoRstSC!SCDemandType, _
                                             adoRstSC!propertyID, adoConn)

'               If Not adoRstLeaseDtl.Fields("OLED").Value Then
'                  dtEndDate = Format(DateAdd("d", 1, adoRstLeaseDtl!EndDate), "dd/mm/yyyy")
'                  If DateDiff("d", dtEndDate, dtNtDueDate) > 0 Then dtNtDueDate = dtEndDate
'               End If

               With adoRstSplitDemand
                  .AddNew
                  !DSR = UniqueID()
                  !splitID = 1
                  !DEMANDID = lDemand
                  !A_M = "A"
                  !NominalCodeforAmount = PartString(szaNCode(adoRstSC!SCDemandType), 0, " # ")
                  !NominalNameforAmount = PartString(szaNCName(adoRstSC!SCDemandType), 0, " # ")
                  !NominalCodeForVAT = PartString(szaNCode(adoRstSC!SCDemandType), 1, " # ")
                  !NominalNameforVAT = PartString(szaNCName(adoRstSC!SCDemandType), 1, " # ")
                  !NominalCodeForTotal = PartString(szaNCode(adoRstSC!SCDemandType), 2, " # ")
                  !NominalNameforTotal = PartString(szaNCName(adoRstSC!SCDemandType), 2, " # ")
                  !amount = CCur(adoRstSC!SCAmount)
                  !VATAMOUNT = RoundingNumber(adoRstSC!SCAmount * GetVAT_Tenant(adoRstLeaseDtl!SageAccountNumber, adoConn) / 100, 2)
                  !TotalAmount = !amount + !VATAMOUNT
'                  !SageRef = szaPrefix(adoRstSC!SCDemandType) & Format(SlNumber("SI", "DemandRecords", adoConn), "00000")
                  !DueDate = Format(adoRstSC!SCNextDueDate.Value, "dd/mm/yyyy")
                  !VATMonth = Month(adoRstSC!SCNextDueDate)
                  !TypeOfDemand = adoRstSC!SCDemandType
                  
                  !description = szDes
                  !DemandStatement = True
                  !VAT_CODE = GetVATCode_Tenant(adoRstLeaseDtl!SageAccountNumber, adoConn)
                  If !VAT_CODE = -1 Then
                        !VAT_CODE = Null
                  End If
                  If Left(adoRstSC!CalDays, 1) <> "-" Then
   '                          ADVANCE
                     !dateFrom = CDate(adoRstSC!SCNextDueDate)
                     !DateTO = DateAdd("d", -1, dtNtDueDate)
                  Else
   '                          ARREARS
'                     !DateFrom = DateAdd(Right(adoRstSC!CalDays, 1), Left(adoRstSC!CalDays, Len(adoRstSC!CalDays) - 1), adoRstSC!SCNextDueDate) 'CDate(adoRstSC!SCNextDueDate)
                     !dateFrom = ArrFromDate(adoRstSC!SCNextDueDate, _
                                             adoRstSC!SCFrequency, _
                                             adoRstSC!SCDemandType, _
                                             adoRstSC!propertyID, _
                                             adoRstSC!CalDays, adoConn)
                     !DateTO = DateAdd("d", -1, adoRstSC!SCNextDueDate)
                  End If
                  'save to an array adoRstSC!ServiceCharge, adoRstSC!SCDemandType to zerorize YearEnd amount and set a SCYE Date( !DateTo) where category is year end
                  'SCYRCount = 0
                  szSCYR(SCYRCount, 0) = adoRstSC!ServiceCharge
                  szSCYR(SCYRCount, 1) = adoRstSC!SCDemandType
                  szSCYR(SCYRCount, 2) = !DateTO
                  
                  'new requirement from WD they want  Startdate and end date as 2nd ref 2019-11-18
                  !SageRef = Format(!dateFrom, "dd/mm/yy") & "-" & Format(!DateTO, "dd/mm/yy")
                  
                  !SageDepartment = adoRstSC!ServiceChargeDept ' DepartmentID(adoRstLeaseDtl!SageAccountNumber, adoRstLeaseDtl!UnitNumber, "Service Charge", adoConn)
                  !FrequencyID = adoRstSC!SCFrequency
                  !ChargingFigure = adoRstSC!CMFigure
                  !ChargingMethod = IIf(IsNull(adoRstSC!ChargingMethod), 0, adoRstSC!ChargingMethod)
                  .Update
               End With

               UpdateNextDueDate "LServiceCharges", "SCNextDueDate", dtNtDueDate, "ServiceCharge", adoRstSC!ServiceCharge, adoConn
               SetFDD "LServiceCharges", "FDD", dtFDD, "ServiceCharge", adoRstSC!ServiceCharge, adoConn
               SCYRCount = SCYRCount + 1
               SCcount = SCcount + 1
               iSerial = iSerial + 1
            End If
            adoRstSC.MoveNext
         Wend
         adoRstSC.Close
         'MsgBox "Total number of record that is going to be zerorized is: " & UBound(szSCYR, 1)
         For SCYRCount = 0 To UBound(szSCYR, 1) - 1
                If szSCYR(SCYRCount, 0) <> "" Then
                    adoConn.Execute "Update LServiceCharges L,DemandTypes D  Set SCTotal=0,SCAmount=0,SCYEDate=#" & szSCYR(SCYRCount, 2) & "# where L.SCDemandType =D.ID AND D.CategoryCode=5 AND ServiceCharge='" & szSCYR(SCYRCount, 0) & "'"
                End If
         Next
'************************************************************************************************
'   Service Charge demands   For negative charge amount -> Credit note
'************************************************************************************************
         szSQLStr = "SELECT S.ServiceCharge, S.LeaseID, " & _
                        "S.SCFrequency, S.SCPayableFrom, " & _
                        "S.SCNextDueDate, S.ChargingMethod, " & _
                        "S.CMFigure, S.SCTotal, S.SCAmount, " & _
                        "S.SCTOLimit, S.SCDemandType, StopSC, " & _
                        "S.ServiceChargeDept, S.SCDesc, " & _
                        "Units.PropertyID, " & _
                        "DemandTypes.Spare1 as ClientBankID, Frequencies.CalDays " & _
                    "FROM LServiceCharges AS S, LeaseDetails, Units, DemandTypes, Frequencies "

         If frmDemandTypesSel.cboGDPFreq.Column(0) = 0 Then

            szSQLStr = szSQLStr & _
                    "WHERE S.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                        "S.LeaseID = LeaseDetails.LeaseID AND (S.StopAutoDmd = FALSE OR LeaseDetails.GPrataDmd =FALSE OR " & _
                        "(S.StopAutoDmd = TRUE AND LeaseDetails.EndDate >= CDATE(S.FDD))) AND " & _
                        "S.SCAmount < 0 AND LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
                        "(ISNULL(S.spare3) OR S.spare3 <> 'DELETED') AND " & _
                        "S.SCDemandType = DemandTypes.ID AND " & _
                        "S.SCFrequency = Frequencies.ID AND LeaseDetails.Status;"
         Else

            szSQLStr = szSQLStr & _
                    "WHERE S.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                        "S.LeaseID = LeaseDetails.LeaseID AND (S.StopAutoDmd = FALSE OR  LeaseDetails.GPrataDmd =FALSE OR " & _
                        "(S.StopAutoDmd = TRUE AND LeaseDetails.EndDate >= CDATE(S.FDD))) AND " & _
                        "S.SCAmount < 0 AND LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
                        " (ISNULL(S.spare3) OR S.spare3 <> 'DELETED') AND " & _
                        "S.SCDemandType = DemandTypes.ID AND " & _
                        "S.SCFrequency = Frequencies.ID AND " & _
                        "Frequencies.ID = " & frmDemandTypesSel.cboGDPFreq.Column(0) & " AND LeaseDetails.Status;"
         End If
        'Remming S.SCAmount > 0 AND  2020-12-02 issue 898
         Set adoRstSC = New ADODB.Recordset

         adoRstSC.Open szSQLStr, adoConn, adOpenStatic, adLockReadOnly
         
        
         ReDim szSCYR(adoRstSC.RecordCount, 2) As String
         SCYRCount = 0
         While Not adoRstSC.EOF
            If IsNull(adoRstSC!StopSC) Or adoRstSC!StopSC = "" Then
               bProceed = True
            Else
               bProceed = IIf(DateDiff("d", adoRstSC!SCNextDueDate, CDate(adoRstSC!StopSC)) > 0, True, False)
            End If
            If adoRstLeaseDtl!SCPayable = "Y" And _
               DateDiff("d", Date, IIf(adoRstSC!SCNextDueDate = "", _
                  DateAdd("d", -1, Date), adoRstSC!SCNextDueDate)) <= DaysB4Due And bProceed And _
                     IsDmdTypeSel(adoRstSC.Fields("SCDemandType").Value) And _
               IIf(adoRstLeaseDtl!OLED, True, adoRstLeaseDtl!EndDate > adoRstSC!SCNextDueDate) Then
'**** Insert the Header info in the DemandRecords table
               lDemand = NextRef(adoConn, "DEMAND_REF")        'GET THE NEXT DEMAND ID
               With adoRstDemandRec
                  .AddNew
                  .Fields("DemandID").Value = lDemand
                  .Fields("CreatedBy").Value = User
                  .Fields("CreatedDate").Value = Now
                  lArrDemand(UBound(lArrDemand)) = lDemand
                  ReDim Preserve lArrDemand(UBound(lArrDemand) + 1) As Long

                  .Fields("BatchID").Value = lBatch
                  .Fields("SageAccountNumber").Value = adoRstLeaseDtl!SageAccountNumber
                  .Fields("TenantCompanyName").Value = adoRstLeaseDtl!CompanyName
                  .Fields("UnitNumber").Value = adoRstLeaseDtl!UnitNumber
                  .Fields("Source").Value = 1
                  .Fields("TransactionType").Value = 2
'   ***Here my thinking is, all type of demands due date is on the same day
'   ***If its not correct then i have to change the manual demands grid and the demand table & split table
                  .Fields("IssueDate").Value = Format(frmDemandTypesSel.txtInitialIssueDate.text, "dd/mm/yyyy")
                  .Fields("SageText").Value = "S/L " & adoRstLeaseDtl!SageAccountNumber
                  .Fields("IsPrinted").Value = False
                  .Fields("Spare1").Value = adoRstSC!ClientBankID
                  .Fields.Item("LeaseRef").Value = adoRstLeaseDtl!LeaseID
                  .Fields.Item("DmdSlNo").Value = SlNumber("SC", "DemandRecords", adoConn)
                  .Fields.Item("SuppText1").Value = adoRstLeaseDtl.Fields.Item("SuppText1").Value
                  .Fields.Item("SentByEmail").Value = IIf(adoRstLeaseDtl.Fields.Item("EmailDmd").Value, Null, 2)
                  .Fields.Item("PostingDate").Value = Format(frmDemandTypesSel.txtPostingDate.text, "dd mmmm yyyy")
                  'aded by anol 16 08 2016
                  .Fields.Item("SO").Value = True
                  .Fields.Item("LastModifiedBy").Value = User
                  .Fields.Item("LastModifiedDate").Value = Now
                  .Update
               End With

'               iChildId = 1
               szDes = IIf(IIf(IsNull(adoRstSC!SCDesc), "", adoRstSC!SCDesc) = "", DemandTypeName(adoRstSC!SCDemandType, adoConn), adoRstSC!SCDesc)

               dtNtDueDate = FindNextDueDate(adoRstSC!SCNextDueDate, _
                                 adoRstSC!SCFrequency, adoRstSC!SCDemandType, adoRstSC!propertyID, adoConn)
               dtFDD = FindNextDueDate(dtNtDueDate, _
                                             adoRstSC!SCFrequency, _
                                             adoRstSC!SCDemandType, _
                                             adoRstSC!propertyID, adoConn)

'               If Not adoRstLeaseDtl.Fields("OLED").Value Then
'                  dtEndDate = Format(DateAdd("d", 1, adoRstLeaseDtl!EndDate), "dd/mm/yyyy")
'                  If DateDiff("d", dtEndDate, dtNtDueDate) > 0 Then dtNtDueDate = dtEndDate
'               End If

               With adoRstSplitDemand
                  .AddNew
                  !DSR = UniqueID()
                  !splitID = 1
                  !DEMANDID = lDemand
                  !A_M = "A"
                  !NominalCodeforAmount = PartString(szaNCode(adoRstSC!SCDemandType), 0, " # ")
                  !NominalNameforAmount = PartString(szaNCName(adoRstSC!SCDemandType), 0, " # ")
                  !NominalCodeForVAT = PartString(szaNCode(adoRstSC!SCDemandType), 1, " # ")
                  !NominalNameforVAT = PartString(szaNCName(adoRstSC!SCDemandType), 1, " # ")
                  !NominalCodeForTotal = PartString(szaNCode(adoRstSC!SCDemandType), 2, " # ")
                  !NominalNameforTotal = PartString(szaNCName(adoRstSC!SCDemandType), 2, " # ")
                  !amount = Abs(CCur(adoRstSC!SCAmount))
                  !VATAMOUNT = Abs(RoundingNumber(adoRstSC!SCAmount * GetVAT_Tenant(adoRstLeaseDtl!SageAccountNumber, adoConn) / 100, 2))
                  !TotalAmount = Abs(!amount + !VATAMOUNT)
'                  !SageRef = szaPrefix(adoRstSC!SCDemandType) & Format(SlNumber("SI", "DemandRecords", adoConn), "00000")
                  !DueDate = Format(adoRstSC!SCNextDueDate.Value, "dd/mm/yyyy")
                  !VATMonth = Month(adoRstSC!SCNextDueDate)
                  !TypeOfDemand = adoRstSC!SCDemandType
                  
                  !description = szDes
                  !DemandStatement = True
                  !VAT_CODE = GetVATCode_Tenant(adoRstLeaseDtl!SageAccountNumber, adoConn)
                  If !VAT_CODE = -1 Then
                        !VAT_CODE = Null
                  End If
                  If Left(adoRstSC!CalDays, 1) <> "-" Then
   '                          ADVANCE
                     !dateFrom = CDate(adoRstSC!SCNextDueDate)
                     !DateTO = DateAdd("d", -1, dtNtDueDate)
                  Else
   '                          ARREARS
'                     !DateFrom = DateAdd(Right(adoRstSC!CalDays, 1), Left(adoRstSC!CalDays, Len(adoRstSC!CalDays) - 1), adoRstSC!SCNextDueDate) 'CDate(adoRstSC!SCNextDueDate)
                     !dateFrom = ArrFromDate(adoRstSC!SCNextDueDate, _
                                             adoRstSC!SCFrequency, _
                                             adoRstSC!SCDemandType, _
                                             adoRstSC!propertyID, _
                                             adoRstSC!CalDays, adoConn)
                     !DateTO = DateAdd("d", -1, adoRstSC!SCNextDueDate)
                  End If
                  'save to an array adoRstSC!ServiceCharge, adoRstSC!SCDemandType to zerorize YearEnd amount and set a SCYE Date( !DateTo) where category is year end
                  'SCYRCount = 0
                  szSCYR(SCYRCount, 0) = adoRstSC!ServiceCharge
                  szSCYR(SCYRCount, 1) = adoRstSC!SCDemandType
                  szSCYR(SCYRCount, 2) = !DateTO
                  
                  'new requirement from WD they want  Startdate and end date as 2nd ref 2019-11-18
                  !SageRef = Format(!dateFrom, "dd/mm/yy") & "-" & Format(!DateTO, "dd/mm/yy")
                  
                  !SageDepartment = adoRstSC!ServiceChargeDept ' DepartmentID(adoRstLeaseDtl!SageAccountNumber, adoRstLeaseDtl!UnitNumber, "Service Charge", adoConn)
                  !FrequencyID = adoRstSC!SCFrequency
                  !ChargingFigure = adoRstSC!CMFigure
                  !ChargingMethod = IIf(IsNull(adoRstSC!ChargingMethod), 0, adoRstSC!ChargingMethod)
                  .Update
               End With

               UpdateNextDueDate "LServiceCharges", "SCNextDueDate", dtNtDueDate, "ServiceCharge", adoRstSC!ServiceCharge, adoConn
               SetFDD "LServiceCharges", "FDD", dtFDD, "ServiceCharge", adoRstSC!ServiceCharge, adoConn
               SCYRCount = SCYRCount + 1
               SCcount = SCcount + 1
               iSerial = iSerial + 1
            End If
            adoRstSC.MoveNext
         Wend
         adoRstSC.Close
         'MsgBox "Total number of record that is going to be zerorized is: " & UBound(szSCYR, 1)
         For SCYRCount = 0 To UBound(szSCYR, 1) - 1
                If szSCYR(SCYRCount, 0) <> "" Then
                    adoConn.Execute "Update LServiceCharges L,DemandTypes D  Set SCTotal=0,SCAmount=0,SCYEDate=#" & szSCYR(SCYRCount, 2) & "# where L.SCDemandType =D.ID AND D.CategoryCode=5 AND ServiceCharge='" & szSCYR(SCYRCount, 0) & "'"
                End If
         Next
'************************************************************************************************
'   Service Charge demands       ---->    PRO-RATA
'************************************************************************************************
         szSQLStr = "SELECT S.ServiceCharge, S.LeaseID, S.SCFrequency, S.SCPayableFrom, " & _
                        "S.SCNextDueDate, S.ChargingMethod, S.CMFigure, " & _
                        "S.SCTotal, S.SCAmount, S.SCTOLimit, " & _
                        "S.SCDemandType, StopSC, S.ServiceChargeDept,S.FDD, " & _
                        "S.SCDesc, Units.PropertyID, " & _
                        "DemandTypes.Spare1 as ClientBankID, Frequencies.CalDays,Frequencies.ID " & _
                    "FROM LServiceCharges AS S, LeaseDetails, Units, DemandTypes, Frequencies "

         If frmDemandTypesSel.cboGDPFreq.Column(0) = 0 Then

 szSQLStr = szSQLStr & _
                    "WHERE S.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                        "LeaseDetails.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                        "LeaseDetails.GPrataDmd = TRUE AND " & _
                        "S.StopAutoDmd = TRUE AND " & _
                        "S.SCAmount <> 0 AND LeaseDetails.EndDate < CDATE(S.FDD) AND " & _
                        "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
                        " (ISNULL(S.spare3) OR S.spare3 <> 'DELETED') AND " & _
                        "S.SCDemandType = DemandTypes.ID AND " & _
                        "S.SCFrequency = Frequencies.ID AND LeaseDetails.Status;"
         Else

szSQLStr = szSQLStr & _
                    "WHERE S.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                        "LeaseDetails.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                        "LeaseDetails.GPrataDmd = TRUE AND " & _
                        "S.StopAutoDmd = TRUE AND " & _
                        "S.SCAmount <> 0 AND LeaseDetails.EndDate < CDATE(S.FDD) AND " & _
                        "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
                        "(ISNULL(S.spare3) OR S.spare3 <> 'DELETED') AND " & _
                        "S.SCDemandType = DemandTypes.ID AND " & _
                        "S.SCFrequency = Frequencies.ID AND " & _
                        "Frequencies.ID = " & frmDemandTypesSel.cboGDPFreq.Column(0) & " AND LeaseDetails.Status;"
         End If
  'Remming S.SCAmount > 0 AND  2020-12-02 issue 898
         adoRstSC.Open szSQLStr, adoConn, adOpenStatic, adLockReadOnly
         ReDim szSCYR(adoRstSC.RecordCount, 2) As String
         SCYRCount = 0
         While Not adoRstSC.EOF
            If IsNull(adoRstSC!StopSC) Or adoRstSC!StopSC = "" Then
               bProceed = True
            Else
               bProceed = IIf(DateDiff("d", adoRstSC!SCNextDueDate, CDate(adoRstSC!StopSC)) > 0, True, False)
            End If
            If adoRstLeaseDtl!SCPayable = "Y" And _
               DateDiff("d", Date, IIf(adoRstSC!SCNextDueDate = "", _
                  DateAdd("d", -1, Date), adoRstSC!SCNextDueDate)) <= DaysB4Due And bProceed And _
                     IsDmdTypeSel(adoRstSC.Fields("SCDemandType").Value) Then
'**** Insert the Header info in the DemandRecords table
               lDemand = NextRef(adoConn, "DEMAND_REF")        'GET THE NEXT DEMAND ID
               With adoRstDemandRec
                  .AddNew
                  .Fields("DemandID").Value = lDemand
                  .Fields.Item("CreatedBy").Value = User
                  .Fields.Item("CreatedDate").Value = Now

                  lArrDemand(UBound(lArrDemand)) = lDemand
                  ReDim Preserve lArrDemand(UBound(lArrDemand) + 1) As Long

                  .Fields.Item("BatchID").Value = lBatch
                  .Fields.Item("SageAccountNumber").Value = adoRstLeaseDtl!SageAccountNumber
                  .Fields.Item("TenantCompanyName").Value = adoRstLeaseDtl!CompanyName
                  .Fields.Item("UnitNumber").Value = adoRstLeaseDtl!UnitNumber
                  .Fields.Item("Source").Value = 1
                  .Fields.Item("TransactionType").Value = 1
'   ***Here my thinking is, all type of demands due date is on the same day
'   ***If its not correct then i have to change the manual demands grid and the demand table & split table
                  .Fields.Item("IssueDate").Value = Format(frmDemandTypesSel.txtInitialIssueDate.text, "dd/mm/yyyy")
                  .Fields.Item("SageText").Value = adoRstLeaseDtl!SageAccountNumber
                  .Fields.Item("IsPrinted").Value = False
                  .Fields.Item("Spare1").Value = adoRstSC!ClientBankID
                  .Fields.Item("LeaseRef").Value = adoRstLeaseDtl!LeaseID
                  .Fields.Item("DmdSlNo").Value = SlNumber("SI", "DemandRecords", adoConn)
                  .Fields.Item("SuppText1").Value = adoRstLeaseDtl.Fields.Item("SuppText1").Value
                  .Fields.Item("SentByEmail").Value = IIf(adoRstLeaseDtl.Fields.Item("EmailDmd").Value, Null, 2)
                  .Fields.Item("PostingDate").Value = Format(frmDemandTypesSel.txtPostingDate.text, "dd mmmm yyyy")
                  'aded by anol 16 08 2016
                  .Fields.Item("SO").Value = True
                  .Fields.Item("LastModifiedBy").Value = User
                  .Fields.Item("LastModifiedDate").Value = Now
                  .Update
               End With

'               iChildId = 1
               szDes = IIf(IIf(IsNull(adoRstSC!SCDesc), "", adoRstSC!SCDesc) = "", DemandTypeName(adoRstSC!SCDemandType, adoConn), adoRstSC!SCDesc)

               dtNtDueDate = FindNextDueDate(adoRstSC!SCNextDueDate, _
                                 adoRstSC!SCFrequency, adoRstSC!SCDemandType, adoRstSC!propertyID, adoConn)
'               dtFDD = FindNextDueDate(dtNtDueDate, _
                                             adoRstSC!SCFrequency, _
                                             adoRstSC!SCDemandType, _
                                             adoRstSC!PropertyID, adoConn)

''******* if the override lease end date is false then the lease is open, lease is not expairing.
''******* if the lease end date is open then we dont need to compare the NextDueDate with the lease expaire date.
'               If Not adoRstLeaseDtl.Fields("OLED").Value Then
'                  dtEndDate = Format(DateAdd("d", 1, adoRstLeaseDtl!EndDate), "dd/mm/yyyy")
'                  If DateDiff("d", dtEndDate, dtNtDueDate) > 0 Then dtNtDueDate = dtEndDate
'               End If

               With adoRstSplitDemand
                  .AddNew
                  !DSR = UniqueID()
                  !splitID = 1
                  !DEMANDID = lDemand
                  !A_M = "A"
                  !NominalCodeforAmount = PartString(szaNCode(adoRstSC!SCDemandType), 0, " # ")
                  !NominalNameforAmount = PartString(szaNCName(adoRstSC!SCDemandType), 0, " # ")
                  !NominalCodeForVAT = PartString(szaNCode(adoRstSC!SCDemandType), 1, " # ")
                  !NominalNameforVAT = PartString(szaNCName(adoRstSC!SCDemandType), 1, " # ")
                  !NominalCodeForTotal = PartString(szaNCode(adoRstSC!SCDemandType), 2, " # ")
                  !NominalNameforTotal = PartString(szaNCName(adoRstSC!SCDemandType), 2, " # ")
'                  !SageRef = "EL" 'szaPrefix(adoRstSC!SCDemandType) & Format(SlNumber("SI", "DemandRecords", adoConn), "00000")
                  !DueDate = Format(adoRstSC!SCNextDueDate, "dd/mm/yyyy")
                  !VATMonth = Month(adoRstSC!SCNextDueDate)
                  !TypeOfDemand = adoRstSC!SCDemandType
                  !description = szDes
                  !DemandStatement = True
                  !VAT_CODE = GetVATCode_Tenant(adoRstLeaseDtl!SageAccountNumber, adoConn)
                  If !VAT_CODE = -1 Then
                        !VAT_CODE = Null
                  End If
                  If Left(adoRstSC!CalDays, 1) <> "-" Then   '                          ADVANCE
                     !dateFrom = CDate(adoRstSC!SCNextDueDate)
                  Else                                       '                          ARREARS
'                     !DateFrom = DateAdd(Right(adoRstSC!CalDays, 1), Left(adoRstSC!CalDays, Len(adoRstSC!CalDays) - 1), adoRstSC!SCNextDueDate) 'CDate(adoRstSC!SCNextDueDate)
                     !dateFrom = ArrFromDate(adoRstSC!SCNextDueDate, _
                                             adoRstSC!SCFrequency, _
                                             adoRstSC!SCDemandType, _
                                             adoRstSC!propertyID, _
                                             adoRstSC!CalDays, adoConn)
                  End If
                  !DateTO = adoRstLeaseDtl!EndDate
                  
                  szSCYR(SCYRCount, 0) = adoRstSC!ServiceCharge
                  szSCYR(SCYRCount, 1) = adoRstSC!SCDemandType
                  szSCYR(SCYRCount, 2) = !DateTO
                  'new requirement from WD they want  Startdate and end date as 2nd ref 2019-11-18
                  !SageRef = Format(!dateFrom, "dd/mm/yy") & "-" & Format(!DateTO, "dd/mm/yy")
                  
                  
                  If DateDiff("d", adoRstLeaseDtl!EndDate, adoRstSC.Fields.Item("FDD")) = 1 Then
                          'do not calculatate prorata ,calculate full
                          !amount = RoundingNumber(Val(adoRstSC.Fields.Item("SCTotal") / szaPartofYear(adoRstSC("ID").Value)), 2)
                  Else
                          'calculate prorata and also add 1 day with datediff
                           !amount = RoundingNumber((Val(adoRstSC.Fields.Item("SCTotal")) / 365) * (DateDiff("D", !dateFrom, !DateTO) + 1), 2)
                  End If
                  '!amount = RoundingNumber((Val(adoRstSC!SCTotal) / 365) * DateDiff("D", !DateFrom, !DateTo), 2)
                  !VATAMOUNT = RoundingNumber(!amount * GetVAT_Tenant(adoRstLeaseDtl!SageAccountNumber, adoConn) / 100, 2)
                  !TotalAmount = !amount + !VATAMOUNT

                  !SageDepartment = adoRstSC!ServiceChargeDept ' DepartmentID(adoRstLeaseDtl!SageAccountNumber, adoRstLeaseDtl!UnitNumber, "Service Charge", adoConn)
                  !FrequencyID = adoRstSC!SCFrequency
                  !ChargingFigure = adoRstSC!CMFigure
                  !ChargingMethod = IIf(IsNull(adoRstSC!ChargingMethod), 0, adoRstSC!ChargingMethod)
                  .Update
               End With

               UpdateNextDueDate "LServiceCharges", "SCNextDueDate", dtNtDueDate, "ServiceCharge", adoRstSC!ServiceCharge, adoConn
               MarkGPD "LServiceCharges", True, "ServiceCharge", adoRstSC!ServiceCharge, adoConn
               SCYRCount = SCYRCount + 1
               SCcount = SCcount + 1
               iSerial = iSerial + 1
            End If
            adoRstSC.MoveNext
         Wend
         adoRstSC.Close
         Set adoRstSC = Nothing
         For SCYRCount = 0 To UBound(szSCYR, 1) - 1
                If szSCYR(SCYRCount, 0) <> "" Then
                    adoConn.Execute "Update LServiceCharges L,DemandTypes D  Set SCTotal=0,SCAmount=0,SCYEDate=#" & szSCYR(SCYRCount, 2) & "# where L.SCDemandType =D.ID AND D.CategoryCode=5 AND ServiceCharge='" & szSCYR(SCYRCount, 0) & "'"
                End If
         Next
'************************************************************************************************
'   Service Charge demands       ---->    PRO-RATA -Negative charge amount-> credit note
'************************************************************************************************
         szSQLStr = "SELECT S.ServiceCharge, S.LeaseID, S.SCFrequency, S.SCPayableFrom, " & _
                        "S.SCNextDueDate, S.ChargingMethod, S.CMFigure, " & _
                        "S.SCTotal, S.SCAmount, S.SCTOLimit, " & _
                        "S.SCDemandType, StopSC, S.ServiceChargeDept,S.FDD, " & _
                        "S.SCDesc, Units.PropertyID, " & _
                        "DemandTypes.Spare1 as ClientBankID, Frequencies.CalDays,Frequencies.ID " & _
                    "FROM LServiceCharges AS S, LeaseDetails, Units, DemandTypes, Frequencies "

         If frmDemandTypesSel.cboGDPFreq.Column(0) = 0 Then

 szSQLStr = szSQLStr & _
                    "WHERE S.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                        "LeaseDetails.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                        "LeaseDetails.GPrataDmd = TRUE AND " & _
                        "S.StopAutoDmd = TRUE AND " & _
                        "S.SCAmount < 0 AND LeaseDetails.EndDate < CDATE(S.FDD) AND " & _
                        "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
                        " (ISNULL(S.spare3) OR S.spare3 <> 'DELETED') AND " & _
                        "S.SCDemandType = DemandTypes.ID AND " & _
                        "S.SCFrequency = Frequencies.ID AND LeaseDetails.Status;"
         Else

szSQLStr = szSQLStr & _
                    "WHERE S.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                        "LeaseDetails.LeaseID = '" & adoRstLeaseDtl!LeaseID & "' AND " & _
                        "LeaseDetails.GPrataDmd = TRUE AND " & _
                        "S.StopAutoDmd = TRUE AND " & _
                        "S.SCAmount < 0 AND LeaseDetails.EndDate < CDATE(S.FDD) AND " & _
                        "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
                        "(ISNULL(S.spare3) OR S.spare3 <> 'DELETED') AND " & _
                        "S.SCDemandType = DemandTypes.ID AND " & _
                        "S.SCFrequency = Frequencies.ID AND " & _
                        "Frequencies.ID = " & frmDemandTypesSel.cboGDPFreq.Column(0) & " AND LeaseDetails.Status;"
         End If
  'Remming S.SCAmount > 0 AND  2020-12-02 issue 898
         adoRstSC.Open szSQLStr, adoConn, adOpenStatic, adLockReadOnly
         ReDim szSCYR(adoRstSC.RecordCount, 2) As String
         SCYRCount = 0
         While Not adoRstSC.EOF
            If IsNull(adoRstSC!StopSC) Or adoRstSC!StopSC = "" Then
               bProceed = True
            Else
               bProceed = IIf(DateDiff("d", adoRstSC!SCNextDueDate, CDate(adoRstSC!StopSC)) > 0, True, False)
            End If
            If adoRstLeaseDtl!SCPayable = "Y" And _
               DateDiff("d", Date, IIf(adoRstSC!SCNextDueDate = "", _
                  DateAdd("d", -1, Date), adoRstSC!SCNextDueDate)) <= DaysB4Due And bProceed And _
                     IsDmdTypeSel(adoRstSC.Fields("SCDemandType").Value) Then
'**** Insert the Header info in the DemandRecords table
               lDemand = NextRef(adoConn, "DEMAND_REF")        'GET THE NEXT DEMAND ID
               With adoRstDemandRec
                  .AddNew
                  .Fields("DemandID").Value = lDemand
                  .Fields.Item("CreatedBy").Value = User
                  .Fields.Item("CreatedDate").Value = Now

                  lArrDemand(UBound(lArrDemand)) = lDemand
                  ReDim Preserve lArrDemand(UBound(lArrDemand) + 1) As Long

                  .Fields.Item("BatchID").Value = lBatch
                  .Fields.Item("SageAccountNumber").Value = adoRstLeaseDtl!SageAccountNumber
                  .Fields.Item("TenantCompanyName").Value = adoRstLeaseDtl!CompanyName
                  .Fields.Item("UnitNumber").Value = adoRstLeaseDtl!UnitNumber
                  .Fields.Item("Source").Value = 1
                  .Fields.Item("TransactionType").Value = 2
'   ***Here my thinking is, all type of demands due date is on the same day
'   ***If its not correct then i have to change the manual demands grid and the demand table & split table
                  .Fields.Item("IssueDate").Value = Format(frmDemandTypesSel.txtInitialIssueDate.text, "dd/mm/yyyy")
                  .Fields.Item("SageText").Value = adoRstLeaseDtl!SageAccountNumber
                  .Fields.Item("IsPrinted").Value = False
                  .Fields.Item("Spare1").Value = adoRstSC!ClientBankID
                  .Fields.Item("LeaseRef").Value = adoRstLeaseDtl!LeaseID
                  .Fields.Item("DmdSlNo").Value = SlNumber("SC", "DemandRecords", adoConn)
                  .Fields.Item("SuppText1").Value = adoRstLeaseDtl.Fields.Item("SuppText1").Value
                  .Fields.Item("SentByEmail").Value = IIf(adoRstLeaseDtl.Fields.Item("EmailDmd").Value, Null, 2)
                  .Fields.Item("PostingDate").Value = Format(frmDemandTypesSel.txtPostingDate.text, "dd mmmm yyyy")
                  'aded by anol 16 08 2016
                  .Fields.Item("SO").Value = True
                  .Fields.Item("LastModifiedBy").Value = User
                  .Fields.Item("LastModifiedDate").Value = Now
                  .Update
               End With

'               iChildId = 1
               szDes = IIf(IIf(IsNull(adoRstSC!SCDesc), "", adoRstSC!SCDesc) = "", DemandTypeName(adoRstSC!SCDemandType, adoConn), adoRstSC!SCDesc)

               dtNtDueDate = FindNextDueDate(adoRstSC!SCNextDueDate, _
                                 adoRstSC!SCFrequency, adoRstSC!SCDemandType, adoRstSC!propertyID, adoConn)
'               dtFDD = FindNextDueDate(dtNtDueDate, _
                                             adoRstSC!SCFrequency, _
                                             adoRstSC!SCDemandType, _
                                             adoRstSC!PropertyID, adoConn)

''******* if the override lease end date is false then the lease is open, lease is not expairing.
''******* if the lease end date is open then we dont need to compare the NextDueDate with the lease expaire date.
'               If Not adoRstLeaseDtl.Fields("OLED").Value Then
'                  dtEndDate = Format(DateAdd("d", 1, adoRstLeaseDtl!EndDate), "dd/mm/yyyy")
'                  If DateDiff("d", dtEndDate, dtNtDueDate) > 0 Then dtNtDueDate = dtEndDate
'               End If

               With adoRstSplitDemand
                  .AddNew
                  !DSR = UniqueID()
                  !splitID = 1
                  !DEMANDID = lDemand
                  !A_M = "A"
                  !NominalCodeforAmount = PartString(szaNCode(adoRstSC!SCDemandType), 0, " # ")
                  !NominalNameforAmount = PartString(szaNCName(adoRstSC!SCDemandType), 0, " # ")
                  !NominalCodeForVAT = PartString(szaNCode(adoRstSC!SCDemandType), 1, " # ")
                  !NominalNameforVAT = PartString(szaNCName(adoRstSC!SCDemandType), 1, " # ")
                  !NominalCodeForTotal = PartString(szaNCode(adoRstSC!SCDemandType), 2, " # ")
                  !NominalNameforTotal = PartString(szaNCName(adoRstSC!SCDemandType), 2, " # ")
'                  !SageRef = "EL" 'szaPrefix(adoRstSC!SCDemandType) & Format(SlNumber("SI", "DemandRecords", adoConn), "00000")
                  !DueDate = Format(adoRstSC!SCNextDueDate, "dd/mm/yyyy")
                  !VATMonth = Month(adoRstSC!SCNextDueDate)
                  !TypeOfDemand = adoRstSC!SCDemandType
                  !description = szDes
                  !DemandStatement = True
                  !VAT_CODE = GetVATCode_Tenant(adoRstLeaseDtl!SageAccountNumber, adoConn)
                  If !VAT_CODE = -1 Then
                        !VAT_CODE = Null
                  End If
                  If Left(adoRstSC!CalDays, 1) <> "-" Then   '                          ADVANCE
                     !dateFrom = CDate(adoRstSC!SCNextDueDate)
                  Else                                       '                          ARREARS
'                     !DateFrom = DateAdd(Right(adoRstSC!CalDays, 1), Left(adoRstSC!CalDays, Len(adoRstSC!CalDays) - 1), adoRstSC!SCNextDueDate) 'CDate(adoRstSC!SCNextDueDate)
                     !dateFrom = ArrFromDate(adoRstSC!SCNextDueDate, _
                                             adoRstSC!SCFrequency, _
                                             adoRstSC!SCDemandType, _
                                             adoRstSC!propertyID, _
                                             adoRstSC!CalDays, adoConn)
                  End If
                  !DateTO = adoRstLeaseDtl!EndDate
                  
                  szSCYR(SCYRCount, 0) = adoRstSC!ServiceCharge
                  szSCYR(SCYRCount, 1) = adoRstSC!SCDemandType
                  szSCYR(SCYRCount, 2) = !DateTO
                  'new requirement from WD they want  Startdate and end date as 2nd ref 2019-11-18
                  !SageRef = Format(!dateFrom, "dd/mm/yy") & "-" & Format(!DateTO, "dd/mm/yy")
                  
                  
                  If DateDiff("d", adoRstLeaseDtl!EndDate, adoRstSC.Fields.Item("FDD")) = 1 Then
                          'do not calculatate prorata ,calculate full
                          !amount = Abs(RoundingNumber(Val(adoRstSC.Fields.Item("SCTotal") / szaPartofYear(adoRstSC("ID").Value)), 2))
                  Else
                          'calculate prorata and also add 1 day with datediff
                           !amount = Abs(RoundingNumber((Val(adoRstSC.Fields.Item("SCTotal")) / 365) * (DateDiff("D", !dateFrom, !DateTO) + 1), 2))
                  End If
                  '!amount = RoundingNumber((Val(adoRstSC!SCTotal) / 365) * DateDiff("D", !DateFrom, !DateTo), 2)
                  !VATAMOUNT = Abs(RoundingNumber(!amount * GetVAT_Tenant(adoRstLeaseDtl!SageAccountNumber, adoConn) / 100, 2))
                  !TotalAmount = Abs(!amount + !VATAMOUNT)

                  !SageDepartment = adoRstSC!ServiceChargeDept ' DepartmentID(adoRstLeaseDtl!SageAccountNumber, adoRstLeaseDtl!UnitNumber, "Service Charge", adoConn)
                  !FrequencyID = adoRstSC!SCFrequency
                  !ChargingFigure = adoRstSC!CMFigure
                  !ChargingMethod = IIf(IsNull(adoRstSC!ChargingMethod), 0, adoRstSC!ChargingMethod)
                  .Update
               End With

               UpdateNextDueDate "LServiceCharges", "SCNextDueDate", dtNtDueDate, "ServiceCharge", adoRstSC!ServiceCharge, adoConn
               MarkGPD "LServiceCharges", True, "ServiceCharge", adoRstSC!ServiceCharge, adoConn
               SCYRCount = SCYRCount + 1
               SCcount = SCcount + 1
               iSerial = iSerial + 1
            End If
            adoRstSC.MoveNext
         Wend
         adoRstSC.Close
         Set adoRstSC = Nothing
         For SCYRCount = 0 To UBound(szSCYR, 1) - 1
                If szSCYR(SCYRCount, 0) <> "" Then
                    adoConn.Execute "Update LServiceCharges L,DemandTypes D  Set SCTotal=0,SCAmount=0,SCYEDate=#" & szSCYR(SCYRCount, 2) & "# where L.SCDemandType =D.ID AND D.CategoryCode=5 AND ServiceCharge='" & szSCYR(SCYRCount, 0) & "'"
                End If
         Next
End Sub
'Private Function GeneratableBaseRent(ByVal adoConn As ADODB.Connection, ByVal szLeaseID As String, DaysB4Due As Integer) As Boolean
'   Dim szSQLStr As String
'   Dim adoRstRC As ADODB.Recordset
'
'   GeneratableBaseRent = False
'
'   szSQLStr = "SELECT * " & _
'              "FROM LRentCharges " & _
'              "WHERE LeaseID = '" & szLeaseID & "';"
'
'   Set adoRstRC = New ADODB.Recordset
'   adoRstRC.Open szSQLStr, adoConn, adOpenDynamic, adLockPessimistic
'   While Not adoRstRC.EOF
'      If DateDiff("d", Date, IIf(adoRstRC!BRNextDueDate = "", _
'            DateAdd("d", -1, Date), adoRstRC!BRNextDueDate)) >= 0 And _
'         DateDiff("d", Date, IIf(adoRstRC!BRNextDueDate = "", _
'            DateAdd("d", -1, Date), adoRstRC!BRNextDueDate)) <= DaysB4Due And _
'            Val(IIf(IsNull(adoRstRC!BRAmount), 0, adoRstRC!BRAmount)) > 0 Then
'         GeneratableBaseRent = True
'      End If
'      adoRstRC.MoveNext
'   Wend
'   adoRstRC.Close
'   Set adoRstRC = Nothing
'End Function

Private Function ArrFromDate(dtNtDueDate As Date, iFreq As Integer, szDemandType As String, szPropertyID As String, szCalDay As String, adoConn As ADODB.Connection) As Date
   Dim dtDate1 As Date

   Call GetGlobalDataPropertyWise(szPropertyID, adoConn, szDemandType)

   If szGDYearly = "AUTOMATIC" Then
      ArrFromDate = DateAdd(Right(szCalDay, 1), Left(szCalDay, Len(szCalDay) - 1), dtNtDueDate)
   Else
      Select Case iFreq
         Case 2:                                                   'Weekly in arrears
            ArrFromDate = DateAdd("d", -7, dtNtDueDate)
         Case 4:                                                   'Fortnightly in arrears
            ArrFromDate = DateAdd("d", -14, dtNtDueDate)
         Case 6:                                                   'Monthly in arrears
            ArrFromDate = szaMonthlyGD(Month(DateAdd("m", -1, dtNtDueDate)) - 1)

         Case 8:                                                   'Quarterly in arrears
            dtDate1 = DateAdd("d", -1, dtNtDueDate)
            If DateDiff("d", CDate(szGDQuarterly1 & " " & Year(dtNtDueDate)), dtDate1) > 0 And _
               DateDiff("d", dtDate1, CDate(szGDQuarterly2 & " " & Year(dtNtDueDate))) > 0 Then _
                  ArrFromDate = CDate(szGDQuarterly1 & " " & Year(dtNtDueDate))

            If DateDiff("d", CDate(szGDQuarterly2 & " " & Year(dtNtDueDate)), dtDate1) > 0 And _
               DateDiff("d", dtDate1, CDate(szGDQuarterly3 & " " & Year(dtNtDueDate))) > 0 Then _
                  ArrFromDate = CDate(szGDQuarterly2 & " " & Year(dtNtDueDate))

            If DateDiff("d", CDate(szGDQuarterly3 & " " & Year(dtNtDueDate)), dtDate1) > 0 And _
               DateDiff("d", dtDate1, CDate(szGDQuarterly4 & " " & Year(dtNtDueDate))) > 0 Then _
                  ArrFromDate = CDate(szGDQuarterly3 & " " & Year(dtNtDueDate))

            If DateDiff("d", CDate(szGDQuarterly4 & " " & (Year(dtNtDueDate) - 1)), dtDate1) > 0 And _
               DateDiff("d", dtDate1, CDate(szGDQuarterly1 & " " & Year(dtNtDueDate))) > 0 Then _
                  ArrFromDate = CDate(szGDQuarterly4 & " " & (Year(dtNtDueDate) - 1))

         Case 10:                                                  'Half yearly in arrears
            ArrFromDate = NextPayingDate(DateAdd("d", 1, dtNtDueDate), InArr, Pay_Half_Yearly)
         Case 12:                                                  'yearly in arrears
            ArrFromDate = NextPayingDate(DateAdd("d", 1, dtNtDueDate), InArr, Pay_Yearly)
         Case 13:                                                  'Daily
            ArrFromDate = DateAdd("d", 1, dtNtDueDate)
         Case 15:                                                  '4 Weekly in Arrears
            ArrFromDate = DateAdd("d", -28, dtNtDueDate)
         Case 17:                                                  '4 Monthly in Arrears
            ArrFromDate = DateAdd("m", -4, dtNtDueDate)
      End Select
   End If
End Function

Private Function FindNextDueDate(dtNtDueDate As Date, iFreq As Integer, szDemandType As String, szPropertyID As String, adoConn As ADODB.Connection) As Date
   Call GetGlobalDataPropertyWise(szPropertyID, adoConn, szDemandType)

   If szGDYearly = "AUTOMATIC" Then
      Select Case iFreq
         Case 1:                                                   'Weekly in advance
           ' FindNextDueDate = dtNtDueDate
              FindNextDueDate = DateAdd("d", 7, dtNtDueDate)
         Case 2:                                                   'Weekly in arrears
            FindNextDueDate = DateAdd("d", 7, dtNtDueDate)
         Case 3:                                                   'Fortnightly in advance
            FindNextDueDate = DateAdd("d", 14, dtNtDueDate)
         Case 4:                                                   'Fortnightly in arrears
            FindNextDueDate = DateAdd("d", 14, dtNtDueDate)
         Case 5:                                                   'Monthly in advance
            FindNextDueDate = DateAdd("m", 1, dtNtDueDate)
         Case 6:                                                   'Monthly in arrears
            FindNextDueDate = DateAdd("m", 1, dtNtDueDate)
         Case 7:                                                   'Quarterly in advance
            FindNextDueDate = DateAdd("m", 3, dtNtDueDate)
         Case 8:                                                   'Quarterly in arrears
            FindNextDueDate = DateAdd("m", 3, dtNtDueDate)
         Case 9:                                                   'Half yearly in advance
            FindNextDueDate = DateAdd("m", 6, dtNtDueDate)
         Case 10:                                                  'Half yearly in arrears
            FindNextDueDate = DateAdd("m", 6, dtNtDueDate)
         Case 11:                                                  'yearly in advance
            FindNextDueDate = DateAdd("m", 12, dtNtDueDate)
         Case 12:                                                  'yearly in arrears
            FindNextDueDate = DateAdd("m", 12, dtNtDueDate)
         Case 13:                                                  'Daily
            FindNextDueDate = DateAdd("d", 1, dtNtDueDate)
         Case 14:                                                  '4 Weekly in Advance
            FindNextDueDate = DateAdd("d", 28, dtNtDueDate)
         Case 15:                                                  '4 Weekly in Arrears
            FindNextDueDate = DateAdd("d", -28, dtNtDueDate)
         Case 16:                                                  '4 Monthly in Advance
            FindNextDueDate = DateAdd("m", 4, dtNtDueDate)
         Case 17:                                                  '4 Monthly in Arrears
            FindNextDueDate = DateAdd("m", -4, dtNtDueDate)
      End Select

      Exit Function
   End If

   Select Case iFreq
      Case 1:                                                   'Weekly in advance
         FindNextDueDate = dtNtDueDate
      Case 2:                                                   'Weekly in arrears
         FindNextDueDate = DateAdd("d", 7, dtNtDueDate)
      Case 3:                                                   'Fortnightly in advance
         FindNextDueDate = dtNtDueDate
      Case 4:                                                   'Fortnightly in arrears
         FindNextDueDate = DateAdd("d", 14, dtNtDueDate)
      Case 5:                                                   'Monthly in advance
         FindNextDueDate = NextPayingDate(DateAdd("d", 1, dtNtDueDate), InAdv, Pay_Monthly)
      Case 6:                                                   'Monthly in arrears
         FindNextDueDate = NextPayingDate(DateAdd("d", 1, dtNtDueDate), InArr, Pay_Monthly)
      Case 7:                                                   'Quarterly in advance
         FindNextDueDate = NextPayingDate(DateAdd("d", 1, dtNtDueDate), InAdv, Pay_Quarterly)
      Case 8:                                                   'Quarterly in arrears
         FindNextDueDate = NextPayingDate(DateAdd("d", 1, dtNtDueDate), InArr, Pay_Quarterly)
      Case 9:                                                   'Half yearly in advance
         FindNextDueDate = NextPayingDate(DateAdd("d", 1, dtNtDueDate), InAdv, Pay_Half_Yearly)
      Case 10:                                                  'Half yearly in arrears
         FindNextDueDate = NextPayingDate(DateAdd("d", 1, dtNtDueDate), InArr, Pay_Half_Yearly)
      Case 11:                                                  'yearly in advance
         FindNextDueDate = NextPayingDate(DateAdd("d", 1, dtNtDueDate), InAdv, Pay_Yearly)
      Case 12:                                                  'yearly in arrears
         FindNextDueDate = NextPayingDate(DateAdd("d", 1, dtNtDueDate), InArr, Pay_Yearly)
      Case 13:                                                  'Daily
         FindNextDueDate = DateAdd("d", 1, dtNtDueDate)
      Case 14:                                                  '4 Weekly in Advance
         FindNextDueDate = DateAdd("d", 28, dtNtDueDate)
      Case 15:                                                  '4 Weekly in Arrears
         FindNextDueDate = DateAdd("d", -28, dtNtDueDate)
      Case 16:                                                  '4 Monthly in Advance
         FindNextDueDate = DateAdd("m", 4, dtNtDueDate)
      Case 17:                                                  '4 Monthly in Arrears
         FindNextDueDate = DateAdd("m", -4, dtNtDueDate)
   End Select
End Function

Public Sub ClearTable(szTable As String)
   Dim adoConn As New ADODB.Connection
   Dim adoRST As New ADODB.Recordset
   Dim SQLStr1 As String

   adoConn.Open getConnectionString

   SQLStr1 = "DELETE * FROM " & szTable & ";"
   adoRST.Open SQLStr1, adoConn, adOpenDynamic, adLockPessimistic

   adoRST.Close
   adoConn.Close
   Set adoRST = Nothing
   Set adoConn = Nothing
End Sub

Private Sub tabDmdRcpt_Click(PreviousTab As Integer)
   Dim adoConn As New ADODB.Connection
   Dim iRow As Integer
   Dim i As Integer
   Dim Rst1 As New ADODB.Recordset
   tabPayment.Tab = 0
   If tabDmdRcpt.Tab <> 2 Then 'clearing the  lock when moving between the TABS
         adoConn.Open getConnectionString
         adoConn.Execute "Update tlbReceipt Set  DateTimeStamp='',Module='',UserSessionID='',WindowsUserName='',MachineName=''," & _
                   "PrestigeUserName='',ServerIPaddress='' where UserSessionID='" & UserSessionID & "' AND Module='Demand Receipt'"
         adoConn.Close
         Set adoConn = Nothing
   End If
   
   If tabDmdRcpt.Tab = 1 Then       'Receipt
      If flxDemandHistory.TextMatrix(1, 1) <> "" Then Exit Sub
      adoConn.Open getConnectionString
      Rst1.Open "Select MaxDemandHist From shoppingCentre", adoConn, adOpenKeyset, adLockReadOnly
      If Not Rst1.EOF Then
                txtArray(9).text = Rst1!MaxDemandHist
      End If
      Rst1.Close
      Label6(3).Caption = "Lessee"
      LoadFlxGrid flxDemandHistory, True, adoConn, ""  'True - uploading history records'this function name alias is loadflxDemandHistory
      ConfigFlxGrid flxChildDemandHistory

      adoConn.Close
      Set adoConn = Nothing
   End If

   If tabDmdRcpt.Tab = 2 Then       'Receipt
      adoConn.Open getConnectionString
      Rst1.Open "Select MaxReceiptHist From shoppingCentre", adoConn, adOpenKeyset, adLockReadOnly
      If Not Rst1.EOF Then
                txtArray(2).text = Rst1!MaxReceiptHist
      End If
      Rst1.Close
      Label6(3).Caption = "Ref"
      If IsLoadedAndVisible("frmCashbook") Then
         For iRow = 1 To frmCashbook.flxStatementReconcile.Rows - 1
            If frmCashbook.flxStatementReconcile.TextMatrix(iRow, 8) <> "" And _
                  frmCashbook.flxStatementReconcile.TextMatrix(iRow, 9) = "" Then
               frmCashbook.SavedPreBankRecTrans adoConn
               UpdatingCB adoConn
               Exit For
            End If
         Next iRow
      End If

      'If cmbRptAmtType.ListCount < 1 Then LoadRptAmtType "RECEIPT AMOUNT TYPE", adoconn
      'Rem by anol 06 Jan 2016
'      If cboRptClientList.ListCount < 1 Then
'         PrepareList adoConn, cboRptClientList, cboRptPropertyList
'      End If
   ' Call LoadClientName(adoconn)
    txtRptClientList.text = "ALL"
    
    'cmbBankAc.Clear 'issue 560 (4)
    txtBankAc.text = ""
    txtBankCode.text = ""
    
    txtRptPropertyList.text = "ALL"
    'load bank
'    Call txtRptClientList_Change_Made
    Call LoadDefaultBankAC(adoConn) 'when you select a client it is loading a deafult Bank AC
    txtReceiptReference.text = ""
    txtRcptAmtType.text = ""
    txtRcptAmtType.Tag = ""
    txtSPaymentTotal.text = "0.00"

      txtSPDate.text = Format(Now, "dd/mm/yyyy")
      txtAllocationDAte.text = txtSPDate.text

'  Bring all Invoices or Demands into tlbReceipt table *********************************************
'      MigrateInvIntoReceipt adoConn

      adoConn.Execute "UPDATE demandrecords AS dr, demandsplitrecords AS ds " & _
                      "SET    dr.details = ds.Description " & _
                      "WHERE  dr.demandid=ds.demandid And isnull(dr.details) And ds.splitid=1;"
      adoConn.Execute "UPDATE demandrecords AS dr, demandsplitrecords AS ds " & _
                      "SET    dr.details = ds.Description " & _
                      "WHERE  dr.demandid=ds.demandid And isnull(dr.details) And ds.splitid=2;"

      adoConn.Execute "UPDATE demandrecords AS dr, tlbReceipt AS r " & _
                      "SET    r.details = dr.Details " & _
                      "WHERE  r.demandref=dr.demandid And isnull(r.details);"

      If txtTenantID.text = "" Then
         ConfigFlxSPayment
         ConfigFlxCrPoA
      Else
         For i = 1 To flxSPayment.Rows - 1
            flxSPayment.RowHeight(i) = 240
         Next i
          'Unlock previous locked item
         adoConn.Execute "Update tlbReceipt Set  DateTimeStamp='',Module='',UserSessionID='',WindowsUserName='',MachineName=''," & _
                   "PrestigeUserName='',ServerIPaddress='' where UserSessionID='" & UserSessionID & "'"
         flxSPayment.Clear
         flxSPayment.Rows = 2
         LoadFlxSPayment adoConn
         ReDim baChangesMade(flxSPayment.Rows) As Boolean

         flxCrPoA.Clear
         flxCrPoA.Rows = 2
         LoadFlxCrPoA adoConn
      End If

      adoConn.Close
      Set adoConn = Nothing
   End If
   If tabDmdRcpt.Tab = 2 Then
        FocusControl cmdRptClientList
   End If
End Sub

'Private Sub LoadClientName(adoConn As ADODB.Connection)
'    Dim adoRst As New ADODB.Recordset
'   Dim szSQL As String
'
'
''*************************************** CLIENT COMBO ******************************************
'   szSQL = "SELECT CLIENTID, CLIENTNAME, CLIENTPOSTCODE,  " & _
'               "LandLordSageCustAC, LandLordSageSuppAC " & _
'           "FROM CLIENT " & _
'           "ORDER BY CLIENTID;"
'   adoRst.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
'
'   If Not adoRst.EOF Then
'          txtRptClientList.text = IIf(IsNull(adoRst.Fields("CLIENTID").Value), "", adoRst.Fields("CLIENTID").Value)
'   End If
'End Sub
Public Sub Refresh_Receipt_Rev_Aloc()
   Dim adoConn As New ADODB.Connection

   adoConn.Open getConnectionString

   flxSPayment.Clear
   flxSPayment.Rows = 2
    'Unlock previous locked item
      adoConn.Execute "Update tlbReceipt Set  DateTimeStamp='',Module='',UserSessionID='',WindowsUserName='',MachineName=''," & _
                   "PrestigeUserName='',ServerIPaddress='' where UserSessionID='" & UserSessionID & "'"
   LoadFlxSPayment adoConn
   ReDim baChangesMade(flxSPayment.Rows) As Boolean

   flxCrPoA.Clear
   flxCrPoA.Rows = 2
   LoadFlxCrPoA adoConn

   adoConn.Close
   Set adoConn = Nothing
End Sub

Public Sub LoadFlxCrPoA(adoConn As ADODB.Connection)
    Dim adoRST As New ADODB.Recordset
    Dim colTransactionID As String
    Dim rsUserSessionID As String
    Dim SQLStr1 As String, szaTenant() As String
    Dim iRow As Integer, szDataPath As String
    Dim dblOSAmount As Double
    If txtTenantID.text = "" Then Exit Sub
    szaTenant = Split(txtTenantID.text, " \ ")
'SQLStr1 = ""
'"AND RPT.Amount > 0 " has been removed by anol 31 Aug 2015
'issue 571
'   Get the details for the demand type selected
'SQLStr1 = ""
   SQLStr1 = "SELECT RPT.TransactionID, RPT.SageAccountNumber, " & _
                  "RPT.UnitID, RPT.RDate AS Dt, RPT.ExtRef AS Ref, RPT.Details, " & _
                  "RPT.Amount, RPT.OSAmount as OS, RPT.DemandRef as DR, " & _
                  "RPT.AdjTag, T.DESCRIPTION, T.TYPE_ID, RPT.Type as TT, RPT.SlNumber, " & _
                  "RPT.BankCode, RPT.FundID, RPT.RptAmtType, " & _
                  "MID(T.CONSTANT, 4, LEN(T.CONSTANT)-3) AS PF, ReconNow,P.clientID as ClientID,RPT.Postingdate," & _
                  "RPT.UserSessionID,RPT.WindowsUserName,RPT.MachineName,RPT.Module "
   SQLStr1 = SQLStr1 + _
             "FROM tlbReceipt AS RPT, tlbTransactionTypes AS T,Units as U, property as P " & _
             "WHERE RPT.UnitID=U.UNITNumber AND U.propertyID=P.propertyID AND RPT.SageAccountNumber = '" & szaTenant(0) & "' And " & _
                   "RPT.ReceiptView = True And RPT.Type = T.TYPE_ID AND RPT.Amount > 0 And " & _
                   "(T.TYPE_ID > 1 AND T.TYPE_ID < 5)  " & _
             "Order By TransactionID;"
'Debug.Print SQLStr1

   adoRST.Open SQLStr1, adoConn, adOpenStatic, adLockReadOnly

   ReDim baBankRecon(adoRST.RecordCount) As Boolean

   iRow = 1
   While Not adoRST.EOF
      flxCrPoA.TextMatrix(iRow, 0) = adoRST!PF & adoRST!SlNumber  'SlNumber of tlbReceipt
      If InStr(adoRST!description, "Credit") > 0 Then
         flxCrPoA.TextMatrix(iRow, 1) = IIf(adoRST!AdjTag = "Y", "ADJC", adoRST!description)
      Else
         flxCrPoA.TextMatrix(iRow, 1) = adoRST!description
      End If
      flxCrPoA.TextMatrix(iRow, 2) = adoRST!SageAccountNumber
      flxCrPoA.TextMatrix(iRow, 3) = IIf(IsNull(adoRST!unitid), "", adoRST!unitid)
      flxCrPoA.TextMatrix(iRow, 4) = Format(adoRST!dt, "dd/mm/yyyy")
      flxCrPoA.TextMatrix(iRow, 5) = IIf(IsNull(adoRST!ref), "", adoRST!ref)
      flxCrPoA.TextMatrix(iRow, 6) = IIf(IsNull(adoRST!Details), "", adoRST!Details)
      flxCrPoA.TextMatrix(iRow, 7) = Format(adoRST!amount, "0.00")
      flxCrPoA.TextMatrix(iRow, 8) = Format(adoRST!OS, "0.00")
      dblOSAmount = dblOSAmount + adoRST!OS
      flxCrPoA.TextMatrix(iRow, 9) = "0.00"
      flxCrPoA.TextMatrix(iRow, 10) = adoRST!TransactionID 'TransactionID of tlbReceipt
      flxCrPoA.TextMatrix(iRow, 11) = IIf(IsNull(adoRST!DR), "", adoRST!DR)
      flxCrPoA.TextMatrix(iRow, 12) = IIf(Val(flxCrPoA.TextMatrix(iRow, 12)) = -1, "P/ADJ/CR", Format(flxCrPoA.TextMatrix(iRow, 12), "0.00"))
      flxCrPoA.TextMatrix(iRow, 13) = adoRST!TYPE_ID
      flxCrPoA.TextMatrix(iRow, 14) = IIf(IsNull(adoRST!BankCode), "", adoRST!BankCode)
      flxCrPoA.TextMatrix(iRow, 15) = IIf(IsNull(adoRST!fundID), "", adoRST!fundID)
      flxCrPoA.TextMatrix(iRow, 16) = IIf(IsNull(adoRST!RptAmtType), "", adoRST!RptAmtType)
      flxCrPoA.TextMatrix(iRow, 17) = IIf(IsNull(adoRST!ClientID), "", adoRST!ClientID)
      flxCrPoA.TextMatrix(iRow, 18) = IIf(IsNull(adoRST!postingDate), "", adoRST!postingDate)
      
      rsUserSessionID = IIf(IsNull(adoRST!UserSessionID), "", adoRST!UserSessionID)
       If Len(rsUserSessionID) > 0 And rsUserSessionID <> UserSessionID Then 'this means it is locked by other screen and now mark it red
            flxCrPoA.col = 0
            flxCrPoA.row = iRow
            flxCrPoA.CellBackColor = RGB(255, 0, 0) ' 'Mark that as red so that user cannot process
            colTransactionIDOtherPayGrid = colTransactionIDOtherPayGrid & IIf(IsNull(adoRST!TransactionID), "", adoRST!TransactionID) & ","
        Else 'collect the transaction ID which needs to be locked
            colTransactionID = colTransactionID & IIf(IsNull(adoRST!TransactionID), "", adoRST!TransactionID) & ","
        End If
        
      
      baBankRecon(iRow) = IsNull(adoRST.Fields.Item("ReconNow").Value)

      adoRST.MoveNext
      If Not adoRST.EOF Then flxCrPoA.AddItem ""
      iRow = iRow + 1
   Wend
   txtArray(3).text = Format(dblOSAmount, "0.00")
   If Len(colTransactionIDOtherPayGrid) > 0 Then 'UserSessionID<>'" & UserSessionID & "' and
        colTransactionIDOtherPayGrid = Left(colTransactionIDOtherPayGrid, Len(colTransactionIDOtherPayGrid) - 1)
   End If
   If Len(colTransactionID) > 0 Then 'UserSessionID<>'" & UserSessionID & "' and
        colTransactionID = Left(colTransactionID, Len(colTransactionID) - 1)
        adoConn.Execute "Update tlbReceipt Set  DateTimeStamp='" & Now & "',Module='Demand Receipt',UserSessionID='" & UserSessionID & "',WindowsUserName='" & SystemUser & "',MachineName='" & WS_Name & "'," & _
                   "PrestigeUserName='" & User & "',ServerIPaddress='" & GetIPaddress & "' where TransactionID in (" & colTransactionID & ")"
    End If
    
   adoRST.Close
   Set adoRST = Nothing
End Sub

Public Sub LoadFlxSPayment(adoConn As ADODB.Connection)
   Dim adoRST As New ADODB.Recordset, adoSplits As New ADODB.Recordset
   Dim szSQL As String, szaTenant() As String, iRow As Integer, szSpID As String, iSpRow As Integer
   Dim iFundID As Integer
   Dim rsUserSessionID As String
   Dim colTransactionID As String
   Dim dicPayHeader As New Dictionary
   Dim key
   Dim dblOSAmount As Double
   If txtTenantID.text = "" Then Exit Sub
   szaTenant = Split(txtTenantID.text, " \ ")
  '********************************bringing only sales invoice*****************
   szSQL = "SELECT R.TransactionID, R.SlNumber AS DEMAND_ID, R.AdjTag, R.FundID, " & _
                  "R.SageAccountNumber, R.UnitID, R.DDate, R.ExtRef, " & _
                  "R.Details, R.Amount, R.OSAmount, R.DemandRef, " & _
                  "R.Type,TT.DESCRIPTION, Count([DSR].[DSR]) AS TOTAL_SPLIT, sum(DSR.AMOUNT) AS NET_AMOUNT,sum(DSR.VATAMOUNT) AS VAT_AMOUNT, " & _
                  "MID(TT.CONSTANT, 4, LEN(TT.CONSTANT)-3) AS PF, R.ReconNow, R.BankCode, R.RptAmtType,R.PostingDate,R.UserSessionID,R.WindowsUserName,R.MachineName,R.Module,R.ClientID,U.PropertyID " & _
           "FROM ((tlbReceipt AS R INNER JOIN tlbTransactionTypes AS TT ON R.Type = TT.TYPE_ID) INNER JOIN " & _
                  "DemandSplitRecords AS DSR ON R.DemandRef = DSR.DemandID) INNER JOIN  UNITS U ON U.UnitNumber=R.UnitID " & _
           "WHERE R.SageAccountNumber = '" & szaTenant(0) & "' And R.ReceiptView = True AND TT.TYPE_ID = 1 AND R.Amount > 0 " & _
           "GROUP BY R.TransactionID, R.SlNumber, R.AdjTag, R.FundID, R.SageAccountNumber, " & _
                  "R.UnitID, R.DDate, R.ExtRef, R.Details, R.Amount, " & _
                  "R.OSAmount, R.DemandRef, R.Type, TT.DESCRIPTION, MID(TT.CONSTANT, 4, LEN(TT.CONSTANT)-3), " & _
                  "R.ReconNow, R.BankCode, R.RptAmtType,R.PostingDate,R.PostingDate,R.UserSessionID,R.WindowsUserName,R.MachineName,R.Module,R.ClientID,U.PropertyID "
                  
                  'Q1.when you have two line in DemandSplitRecords. How many line it is actually pushing to the grid? A.It is creating  only one line at header level
                  'SO if you want to load demandtype you need to load that in the details table
                  '***************bringing Sales Receipt Refund*****************
   szSQL = szSQL + _
           "UNION " & _
           "SELECT R.TransactionID, R.SlNumber AS DEMAND_ID, R.AdjTag, R.FundID, " & _
                  "R.SageAccountNumber, R.UnitID, R.DDate, R.ExtRef, " & _
                  "R.Details, R.Amount, R.OSAmount, R.DemandRef, " & _
                  "R.Type,TT.DESCRIPTION, '1' AS TOTAL_SPLIT, '0' AS NET_AMOUNT,'0' AS VAT_AMOUNT, " & _
                  "MID(TT.CONSTANT, 4, LEN(TT.CONSTANT)-3) AS PF, R.ReconNow, R.BankCode, R.RptAmtType,R.PostingDate,R.UserSessionID,R.WindowsUserName,R.MachineName,R.Module,R.ClientID,U.PropertyID " & _
           "FROM   (tlbReceipt AS R INNER JOIN tlbTransactionTypes AS TT ON R.Type = TT.TYPE_ID) INNER JOIN  UNITS U ON U.UnitNumber=R.UnitID " & _
           "WHERE  R.SageAccountNumber = '" & szaTenant(0) & "' And R.ReceiptView = True AND R.Amount>0 AND " & _
                  "TT.TYPE_ID = 23 " & _
           "GROUP BY R.TransactionID, R.SlNumber, R.AdjTag, R.FundID, R.SageAccountNumber, R.UnitID, " & _
                  "R.DDate, R.ExtRef, R.Details, R.Amount, R.OSAmount, " & _
                  "R.DemandRef, R.Type, TT.DESCRIPTION, MID(TT.CONSTANT, 4, LEN(TT.CONSTANT)-3), " & _
                  "R.ReconNow, R.BankCode, R.RptAmtType ,R.PostingDate,R.PostingDate,R.UserSessionID,R.WindowsUserName,R.MachineName,R.Module,R.ClientID,U.PropertyID " & _
           "ORDER BY TransactionID;"
           'Here you have a group by because you have used count for records
           'Debug.Print szSQL
           ' sum(DSR.AMOUNT) AS NET_AMOUNT,sum(DSR.VATAMOUNT) AS VAT_AMOUNT,
           ''0' AS NET_AMOUNT,'0' AS VAT_AMOUNT,
           
   adoRST.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
   colTransactionIDOtherPayGrid = ""
  'insert the code for locking by anol 20190408 issue 749
   'ReDim szIntitalOSAmount(RecordCount(adoRst) + 10) As Currency
   iRow = 1
   While Not adoRST.EOF
      'If adoRst!TOTAL_SPLIT > 1 Then
         flxSPayment.TextMatrix(iRow, 0) = "+"
'  Add all splits below the header data
         szSQL = "SELECT S.* " & _
                 "FROM tlbReceiptSplit AS S, tlbReceipt AS R " & _
                 "WHERE S.RptHeader = " & adoRST!TransactionID & " AND " & _
                     "S.RptHeader = R.TransactionID AND " & _
                     "(R.Type = 1 OR  R.Type = 23)  " & _
                 "ORDER BY S.SplitID;"
'Debug.Print szSQL  Type = 23 Means sales Reciept Refund
'adoSplits.Close
         adoSplits.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
         For iSpRow = 1 To adoRST!TOTAL_SPLIT
            flxSPayment.AddItem ""
            flxSPayment.TextMatrix(iRow + iSpRow, 0) = "-"
            flxSPayment.TextMatrix(iRow + iSpRow, 1) = adoSplits!splitID
            flxSPayment.TextMatrix(iRow + iSpRow, 3) = adoSplits!RptHeader
            flxSPayment.TextMatrix(iRow + iSpRow, 4) = adoRST!unitid
            flxSPayment.TextMatrix(iRow + iSpRow, 5) = adoSplits!DueDate
            flxSPayment.TextMatrix(iRow + iSpRow, 7) = adoSplits!description
            flxSPayment.TextMatrix(iRow + iSpRow, 8) = Format(adoSplits!amount, "0.00")
'            If adoSplits!amount < 0 Then
'                If dicPayHeader.Exists(adoSplits("RptHeader").Value) Then
'                Else
'                    dicPayHeader.Add adoSplits("RptHeader").Value, -1
'                End If
'            End If
            flxSPayment.TextMatrix(iRow + iSpRow, 9) = Format(adoSplits!OSAmount, "0.00")
            dblOSAmount = dblOSAmount + adoSplits!OSAmount
'            szIntitalOSAmount(iRow + iSpRow) = Format(adoSplits!OSAmount, "0.00")
            flxSPayment.TextMatrix(iRow + iSpRow, 10) = "0.00"
            flxSPayment.TextMatrix(iRow + iSpRow, 11) = 0                     'Discount
            flxSPayment.TextMatrix(iRow + iSpRow, 14) = adoSplits!fundID
            flxSPayment.TextMatrix(iRow + iSpRow, 19) = adoSplits!TransactionID
            flxSPayment.TextMatrix(iRow + iSpRow, 29) = IIf(IsNull(adoRST!DemandRef), "", adoRST!DemandRef)
'            flxSPayment.TextMatrix(iRow + iSpRow, 30) = adoRst!VAT_AMOUNT
            flxSPayment.TextMatrix(iRow + iSpRow, 30) = adoRST!propertyID
'            flxSPayment.TextMatrix(iRow + iSpRow, 32) = adoSplits("RptHeader").Value 'if there is negative line in the invoice put 1 as a mark other wise put 0
'             flxSPayment.TextMatrix(iRow + iSpRow, 34) = adoRst!TOTAL_SPLIT 'Number of total split
            flxSPayment.RowHeight(iRow + iSpRow) = 0
            adoSplits.MoveNext
            If adoSplits.EOF Then
               iSpRow = iSpRow + 1
               Exit For
            End If
         Next iSpRow

         adoSplits.Close
         Set adoSplits = Nothing
     ' End If
      If adoRST!TOTAL_SPLIT = 1 Then
         szSQL = "SELECT S.FundID, S.TransactionID,S.RptHeader " & _
                 "FROM tlbReceiptSplit AS S, tlbReceipt AS R " & _
                 "WHERE S.RptHeader = " & adoRST!TransactionID & " AND " & _
                     "S.RptHeader = R.TransactionID " & _
                 "ORDER BY S.SplitID;"

'Debug.Print szSQL
         adoSplits.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
         iFundID = IIf(IsNull(adoSplits!fundID), 0, adoSplits!fundID)
         szSpID = IIf(IsNull(adoSplits!TransactionID), "", adoSplits!TransactionID)
         adoSplits.Close
         Set adoSplits = Nothing
      End If
      flxSPayment.TextMatrix(iRow, 23) = IIf(IsNull(adoRST!postingDate), "", adoRST!postingDate)
      flxSPayment.TextMatrix(iRow, 22) = IIf(IsNull(adoRST!RptAmtType), "", adoRST!RptAmtType)
      flxSPayment.TextMatrix(iRow, 21) = IIf(IsNull(adoRST!BankCode), "", adoRST!BankCode)
      flxSPayment.TextMatrix(iRow, 20) = IIf(IsNull(adoRST!ReconNow), "", adoRST!ReconNow)
      flxSPayment.TextMatrix(iRow, 19) = adoRST!TransactionID 'transaction ID tlbReceipt
      flxSPayment.TextMatrix(iRow, 1) = adoRST!PF & adoRST!DEMAND_ID 'PF is transaction type

      If InStr(adoRST!description, "Invoice") > 0 Then
         flxSPayment.TextMatrix(iRow, 2) = IIf(adoRST!AdjTag = "Y", "ADJI", adoRST!description)
      Else
         flxSPayment.TextMatrix(iRow, 2) = adoRST!description
      End If

      flxSPayment.TextMatrix(iRow, 3) = szSpID
      flxSPayment.TextMatrix(iRow, 4) = IIf(IsNull(adoRST!unitid), "", adoRST!unitid)
      flxSPayment.TextMatrix(iRow, 5) = IIf(Not IsNull(adoRST!dDate), Format(adoRST!dDate, "dd/mm/yyyy"), "")
      flxSPayment.TextMatrix(iRow, 6) = IIf(IsNull(adoRST!ExtRef), "", adoRST!ExtRef)
      flxSPayment.TextMatrix(iRow, 7) = IIf(IsNull(adoRST!Details), "", adoRST!Details)
      flxSPayment.TextMatrix(iRow, 8) = Format(adoRST!amount, "0.00")
'            If adoRst!amount < 0 Then
'                If dicPayHeader.Exists(adoRst("TransactionID").Value) Then
'                Else
'                    dicPayHeader.Add adoRst("TransactionID").Value, -1
'                End If
'            End If
            
      flxSPayment.TextMatrix(iRow, 9) = Format(adoRST!OSAmount, "0.00")
      'szIntitalOSAmount(iRow) = Format(adoRst!OSAmount, "0.00")
      flxSPayment.TextMatrix(iRow, 10) = "0.00"
      flxSPayment.TextMatrix(iRow, 12) = IIf(IsNull(adoRST!DemandRef), "", adoRST!DemandRef)
      flxSPayment.TextMatrix(iRow, 14) = iFundID
      'below part for loading the locking information in the screen by anol 20190425
         rsUserSessionID = IIf(IsNull(adoRST!UserSessionID), "", adoRST!UserSessionID)
         If Len(rsUserSessionID) > 0 And rsUserSessionID <> UserSessionID Then 'this means it is locked by other screen and now mark it red
               flxSPayment.col = 0
               flxSPayment.row = iRow
               flxSPayment.CellBackColor = RGB(255, 0, 0) ' 'Mark that as red so that user cannot process
               colTransactionIDOtherPayGrid = colTransactionIDOtherPayGrid & IIf(IsNull(adoRST!TransactionID), "", adoRST!TransactionID) & ","
         Else 'collect the transaction ID which needs to be locked
               colTransactionID = colTransactionID & IIf(IsNull(adoRST!TransactionID), "", adoRST!TransactionID) & ","
         End If
         
         flxSPayment.TextMatrix(iRow, 24) = IIf(IsNull(adoRST!UserSessionID), "", adoRST!UserSessionID)
         flxSPayment.TextMatrix(iRow, 25) = IIf(IsNull(adoRST!WindowsUserName), "", adoRST!WindowsUserName)
         flxSPayment.TextMatrix(iRow, 26) = IIf(IsNull(adoRST!MachineName), "", adoRST!MachineName)
         flxSPayment.TextMatrix(iRow, 27) = IIf(IsNull(adoRST!Module), "", adoRST!Module)
         flxSPayment.TextMatrix(iRow, 28) = IIf(IsNull(adoRST!ClientID), "", adoRST!ClientID)
         flxSPayment.TextMatrix(iRow, 29) = IIf(IsNull(adoRST!DemandRef), "", adoRST!DemandRef) 'adoRst!DemandRef
         flxSPayment.TextMatrix(iRow, 30) = adoRST!propertyID
'         flxSPayment.TextMatrix(iRow, 32) = adoRst("TransactionID").Value ''if there is negative line in the invoice put 1 as a mark other wise put 0
'         flxSPayment.TextMatrix(iRow, 34) = "1" 'number of split
         
       'End of locking
        
    
      adoRST.MoveNext
      If Not adoRST.EOF Then flxSPayment.AddItem ""
      If flxSPayment.TextMatrix(iRow, 0) = "+" Then iRow = iRow + iSpRow - 1
      iRow = iRow + 1
   Wend
'   For Each key In dicPayHeader.Keys
'        'column 32 for marking as -1
'        'column 33 for calc os amount
'        Debug.Print key
'        For iRow = 1 To flxSPayment.Rows - 1
'                 If flxSPayment.TextMatrix(iRow, 32) = key Then
'                     flxSPayment.TextMatrix(iRow, 32) = "-1" ' if invoice has at least 1 line negative I am marking full invoice with -1 at the rightest column and if not then 0
'                 Else
'                     'flxSPayment.TextMatrix(iRow, 32) = "0"
'                 End If
'        Next iRow
'   Next key
'        For iRow = 1 To flxSPayment.Rows - 1
'                 If flxSPayment.TextMatrix(iRow, 32) <> "-1" Then
'                     flxSPayment.TextMatrix(iRow, 32) = "0" ' if invoice has at least 1 line negative I am marking full invoice with -1 at the rightest column and if not then 0
'                 End If
'        Next iRow
   txtArray(5).text = Format(dblOSAmount, "0.00")
   ReDim baChangesMade(flxSPayment.Rows) As Boolean
   If Len(colTransactionIDOtherPayGrid) > 0 Then
        colTransactionIDOtherPayGrid = Left(colTransactionIDOtherPayGrid, Len(colTransactionIDOtherPayGrid) - 1)
   End If
   If Len(colTransactionID) > 0 Then 'UserSessionID<>'" & UserSessionID & "' and
        colTransactionID = Left(colTransactionID, Len(colTransactionID) - 1)
        adoConn.Execute "Update tlbReceipt Set  DateTimeStamp='" & Now & "',Module='Demand Receipt',UserSessionID='" & UserSessionID & "',WindowsUserName='" & SystemUser & "',MachineName='" & WS_Name & "'," & _
                   "PrestigeUserName='" & User & "',ServerIPaddress='" & GetIPaddress & "' where TransactionID in (" & colTransactionID & ")"
   End If
   adoRST.Close
   Set adoRST = Nothing
End Sub

Private Sub tabPayment_MouseMove(Button As Integer, Shift As Integer, X As Single, Y As Single)
   tabPayment.MousePointer = vbArrow
End Sub

Private Sub txtAddNewDescription_GotFocus()
   SelTxtInCtrl txtAddNewDescription
End Sub

Private Sub txtAdiComment_DblClick()
   If strAddNewAmountMode = "Edit" Then
      frmAdiComment.txtAdiComment.text = szAdiComment(CInt(GridRowNo))
      frmAdiComment.szAdiComm = szAdiComment(CInt(GridRowNo))
   Else
      frmAdiComment.txtAdiComment.text = szAdiComment(flxAddNewDemands.Rows - 1)
   End If
   Me.Enabled = False

   frmAdiComment.Show
   frmAdiComment.Top = tabDmdRcpt.Top + fraCreateManualDemand.Top + txtAdiComment.Top + txtAdiComment.Height + 140
   frmAdiComment.Left = Me.Left + tabDmdRcpt.Left + fraCreateManualDemand.Left + txtAdiComment.Left + 10
End Sub

Private Sub txtAdiComment_KeyPress(KeyAscii As Integer)
   
    If KeyAscii = 13 Then
        If txtChargingAmt.Visible = True Then
            txtChargingAmt.SetFocus
        Else
            cmdJob.SetFocus
        End If
        'txtAdiComment_DblClick
        'SendKeys vbTab
   End If
End Sub

Private Sub txtAmount_GotFocus()
   SelTxtInCtrl txtAmount
End Sub

Private Sub txtAmount_KeyPress(KeyAscii As Integer)
   If KeyAscii = 13 Then
        If cmdUpdate.Enabled = True Then
            cmdUpdate.SetFocus
        End If
   End If
'   If KeyAscii = 45 Then '45 is the acii code for minus
'        KeyAscii = 0
'   End If
   DigitTextKeyPress txtAmount, KeyAscii
End Sub

Private Sub txtAmount_LostFocus()
        'issue 463:Manually Typing in the VAT Value
'    'Modified by Anol 27 Aug 2014
'rewritten 2 Feb 2016
   If Label1(24).Tag <> "" And vatOptionEnabled = True Then
      'txtVAT.text = Format(Val(txtAmount.text) * (Val(Label1(24).Tag) / 100), "0.00")
      txtVAT.text = Format(Val(txtAmount.text) * (Val(nTaxCode) / 100), "0.00")
      
     ' nTaxCode
   Else
        txtVAT.text = "0.00"
   End If

   txtAmount.text = Format(Val(txtAmount.text), "0.00")
   txtTotal.text = Format(Val(txtAmount.text) + Val(txtVAT.text), "0.00")
End Sub
'    Dim szTemp() As String
'    'Resolved by BOSL
'    'issue 463:Manually Typing in the VAT Value
'    'Modified by Anol 27 Aug 2014
'
'   If cboVatCode.text <> "" Then
'      szTemp = Split(cboVatCode.text, " / ")
'      txtVAT.text = Format(Val(txtAmount.text) * (Val(szTemp(2)) / 100), "0.00")
'   End If
'
'   txtAmount.text = Format(Val(txtAmount.text), "0.00")
'   txtTotal.text = Format(Val(txtAmount.text) + Val(txtVAT.text), "0.00")
'End Sub

Private Sub txtCrPayment_GotFocus()
   SelTxtInCtrl txtCrPayment
   If Not lblAllocating.Visible Then
      iCurRow = flxCrPoA.row
      HighLightRowFlxGrid flxCrPoA, iCurRow
   Else
      iCurRow = flxSPayment.row
   End If
End Sub

Private Sub txtCrPayment_KeyDown(KeyCode As Integer, Shift As Integer)
   If KeyCode = 13 Then
        FocusControl txtArray(4)
   End If
End Sub

Private Sub txtCrPayment_KeyPress(KeyAscii As Integer)
   DigitTextKeyPress txtCrPayment, KeyAscii
End Sub

Private Sub txtCrPayment_LostFocus()
   txtCrPayment.text = Format(IIf(txtCrPayment.text = "", 0, txtCrPayment.text), "0.00")

   If Not lblAllocating.Visible Then
      If Val(flxCrPoA.TextMatrix(iCurRow, 8)) < Val(txtCrPayment.text) Then
         MsgBox "Receipt amount exceeds amount outstanding.", vbExclamation + vbOKOnly, "Warning"
         txtCrPayment.text = "0.00"
         flxCrPoA.RowSel = iCurRow
         flxCrPoA.row = iCurRow
         txtCrPayment.SetFocus
         Exit Sub
      End If

      If Val(txtCrPayment.text) > 0 Then
         flxCrPoA.TextMatrix(iCurRow, 9) = txtCrPayment.text
         txtArray(4).text = txtCrPayment.text
         lblSelectedTranID.Caption = flxCrPoA.TextMatrix(iCurRow, 10)
         flxCrPoA.Enabled = False

         lblAllocating.Caption = "Allocating...                      " & flxCrPoA.TextMatrix(iCrPoARowSel, 1)
         lblAllocating.Visible = True
         Frame5(0).Enabled = False                     'Receipt - Saving
         Frame5(4).Enabled = True                      'Allocation - Saving
      End If
   Else
'     Allocating in the invoice grid, $ txtCrPayment $ text box is in the Upper grid
      If Val(txtArray(4).text) < Val(txtCrPayment.text) Then
         MsgBox "Allocated amount cannot exceed allocation difference amount.", vbExclamation + vbOKOnly, "Warning"
         txtCrPayment.text = "0.00"
         txtCrPayment.SetFocus
         flxSPayment.row = Label10(3).Caption
         Exit Sub
      End If
      If Val(flxSPayment.TextMatrix(iCurRow, 9)) < Val(txtCrPayment.text) Then
         MsgBox "Allocated amount exceeds amount outstanding.", vbExclamation + vbOKOnly, "Warning"
         txtCrPayment.text = "0.00"
         txtCrPayment.SetFocus
         flxSPayment.row = Label10(3).Caption
         Exit Sub
      End If

      If Val(txtCrPayment.text) > 0 Then
         flxSPayment.TextMatrix(iCurRow, 10) = txtCrPayment.text
'         txtAllocatedDiff.text = Format(Val(txtAllocatedDiff.text) - Val(txtCrPayment.text), "0.00")


         

         Call SumUpHeaderBySplits
         Call SpreadHeaderInSplits
'          added by anol 20170216 diffwas not calculating correclty
         txtArray(4).text = Format(CalculateDiff, "0.00")
         If Val(txtArray(4).text) = 0 Then
            cmdAllocateSave.Enabled = True
            cmdAllocateSave.SetFocus
         Else
            cmdAllocateSave.Enabled = False
         End If
         If flxSPayment.TextMatrix(iCurRow, 0) <> "-" Then
            flxSPayment.TextMatrix(iCurRow, 15) = "A"
            flxSPayment.TextMatrix(iCurRow, 16) = lblSelectedTranID.Caption
         Else
            Dim iHeader As Integer

            iHeader = iCurRow
            Do
               iHeader = iHeader - 1
            Loop While (flxSPayment.TextMatrix(iHeader, 0) = "-")

            flxSPayment.TextMatrix(iHeader, 15) = "A"
            flxSPayment.TextMatrix(iHeader, 16) = lblSelectedTranID.Caption
         End If
      End If
      flxSPayment.Enabled = True
   End If

   txtCrPayment.Visible = False
End Sub
Private Function CalculateDiff() As Double
  'written by anol 20170215 to find the rest amount to be allocated
   Dim iRow As Integer, dDr As Double, dCr As Double

   CalculateDiff = 0
   
   For iRow = 1 To flxSPayment.Rows - 1
      If flxSPayment.TextMatrix(iRow, 0) <> "-" Then
      'the receipt which has been already distributed needs to be minus from the credit
         dDr = dDr + CDbl(flxSPayment.TextMatrix(iRow, 10))
      End If
   Next iRow
   For iRow = 1 To flxCrPoA.Rows - 1
      If flxCrPoA.TextMatrix(iRow, 0) <> "-" Then
         dCr = dCr + CDbl(flxCrPoA.TextMatrix(iRow, 9))
      End If
   Next iRow
   CalculateDiff = dCr - dDr
   
End Function
Private Sub txtDateDue_Change()
    If txtDateDue.text <> "" Then
        TextBoxChangeDate txtDateDue
   End If
End Sub

Private Sub txtDateDue_GotFocus()
   SelTxtInCtrl txtDateDue
   Label1(17).Caption = txtDateDue.text
End Sub

Private Sub txtDateDue_KeyPress(KeyAscii As Integer)
'    If KeyAscii = 13 Then
'       If cmdAddNewLine.Enabled = True Then
'            cmdAddNewLine.SetFocus
'       End If
'   End If
   If KeyAscii = 13 Then
        txtAdiComment.SetFocus
        'txtAdiComment_DblClick
        'SendKeys vbTab
   End If
   
   TextBoxKeyPrsDate txtDateDue, KeyAscii
   
End Sub

Private Sub txtDateDue_LostFocus()
   Dim i As Integer
'    If txtDateDue.text = "" Then
'      MsgBox "Please enter a valid 'Due Date' to proceed.", vbCritical + vbOKOnly, "Due Date"
'      txtDateDue.SetFocus
'      Exit Sub
'   End If
   TextBoxFormatDate txtDateDue
'   If Label1(17).Caption <> txtDateDue.text Then
''   If cmdEditLine.Enabled = False Then
'''      If MsgBox("Do you want to update due date?", vbQuestion + vbYesNo, "Due Date") = vbNo Then
'''         txtDateDue.text = "  " 'Label1(17).Caption
'''      Else
'''         For i = 1 To flxAddNewDemands.Rows - 1
''            flxAddNewDemands.TextMatrix(flxAddNewDemands.row, 6) = txtDateDue.text
'''         Next i
''         bAddNew = True
''      'End If
''   End If
End Sub

Private Sub txtDateFrom_Change()
   TextBoxChangeDate txtDateFrom
End Sub

Private Sub txtDateFrom_GotFocus()
   SelTxtInCtrl txtDateFrom
End Sub

Private Sub txtDateFrom_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
        txtDateTo.SetFocus
   End If
   TextBoxKeyPrsDate txtDateFrom, KeyAscii
End Sub

Private Sub txtDateFrom_LostFocus()
   Dim X As Boolean

   X = TextBoxFormatDate(txtDateFrom)

   If X And txtDateTo.text = "" Then txtDateTo.text = txtDateFrom.text
   If X And txtDateDue.text = "" Then txtDateDue.text = txtDateFrom.text
End Sub

'Private Sub txtDateFrom1_Change()
'    TextBoxChangeDate txtDateFrom1
'End Sub

'Private Sub txtDateFrom1_GotFocus()
'   SelTxtInCtrl txtDateFrom1
'End Sub

'Private Sub txtDateFrom1_KeyPress(KeyAscii As Integer)
'   TextBoxKeyPrsDate txtDateFrom1, KeyAscii
'End Sub
'
'Private Sub txtDateFrom1_LostFocus()
'   If txtDateFrom1.text = "" Then txtDateFrom1.text = "01/01/1980"
'End Sub

Private Sub txtDateTo_Change()
   TextBoxChangeDate txtDateTo
End Sub

Private Sub txtDateTo_GotFocus()
   SelTxtInCtrl txtDateTo
End Sub

Private Sub txtDateTo_KeyPress(KeyAscii As Integer)
   If KeyAscii = 13 Then
        txtDateDue.SetFocus
   End If
   TextBoxKeyPrsDate txtDateTo, KeyAscii
End Sub

Private Sub txtDateTo_LostFocus()
   TextBoxFormatDate txtDateTo

   On Error GoTo ErrHanlder

   If txtDateTo.text = "" Then Exit Sub

   If DateDiff("D", CDate(txtDateFrom.text), CDate(txtDateTo.text)) < 0 Then
      MsgBox "The 'To Date' cannot be before the 'From Date'.", vbCritical + vbOKOnly, "Date Warning"
      txtDateTo.SetFocus
      SelTxtInCtrl txtDateTo
   End If

   If txtLeaseEndDate.text <> "OVERRIDE" Then
      If DateDiff("d", txtDateTo.text, txtLeaseEndDate.text) < 0 Then
         MsgBox "The 'To Date' cannot be a date after the lease expiry date," & Chr(13) & "which is " & txtLeaseEndDate.text & ".", vbCritical + vbOKOnly, "Date Warning"
         txtDateTo.SetFocus
         SelTxtInCtrl txtDateTo
      End If
   End If
   Exit Sub

ErrHanlder:
End Sub

'Private Sub txtDateTo1_Change()
'    TextBoxChangeDate txtDateTo1
'End Sub
'
'Private Sub txtDateTo1_GotFocus()
'   SelTxtInCtrl txtDateTo1
'End Sub
'
'Private Sub txtDateTo1_KeyPress(KeyAscii As Integer)
'    TextBoxKeyPrsDate txtDateTo1, KeyAscii
'End Sub
'
'Private Sub txtDateTo1_LostFocus()
'   If txtDateTo1.text = "" Then txtDateTo1.text = Format(Date, "dd/mm/yyyy")
'End Sub

Private Sub txtDLFrom_Change()
   TextBoxChangeDate txtDLFrom
End Sub

Private Sub txtDLFrom_GotFocus()
   SelTxtInCtrl txtDLFrom
End Sub

Private Sub txtDLFrom_KeyPress(KeyAscii As Integer)
   TextBoxKeyPrsDate txtDLFrom, KeyAscii
End Sub

Private Sub txtDLFrom_LostFocus()
   TextBoxFormatDate txtDLFrom
End Sub

Private Sub txtDLTo_Change()
   TextBoxChangeDate txtDLTo
End Sub

Private Sub txtDLTo_GotFocus()
   SelTxtInCtrl txtDLTo
End Sub

Private Sub txtDLTo_KeyPress(KeyAscii As Integer)
   TextBoxKeyPrsDate txtDLTo, KeyAscii
End Sub

Private Sub txtDLTo_LostFocus()
   TextBoxFormatDate txtDLTo
End Sub



Private Sub txtIssueDate_Click()
   If txtTenantName.text = "" Then
      MsgBox "Please choose tenant name.", vbInformation + vbOKOnly, "Tenant Name"
      Exit Sub
   End If
End Sub

Private Sub txtIssueDate_GotFocus()
   If txtTenantName.text = "" Then
      MsgBox "Please select a tenant", vbInformation + vbOKOnly, "Tenant"
      cmdDmdTenantLookup.SetFocus
      Exit Sub
   End If
   SelTxtInCtrl txtIssueDate
End Sub

Private Sub txtIssueDate_KeyPress(KeyAscii As Integer)
   If KeyAscii = 13 Then
'        If txtDateDue.Enabled = True Then
'             txtDateDue.SetFocus
'        End If
        FocusControl cmdaddnewline
   End If
   TextBoxKeyPrsDate txtIssueDate, KeyAscii
   
End Sub

Private Sub txtIssueDate_LostFocus()
    If Trim(txtIssueDate.text) = "" Then
      MsgBox "Please type a valid Issue date.", vbCritical + vbOKOnly, "Issue Date"
      txtIssueDate.Enabled = True
      txtIssueDate.SetFocus
      If txtDateDue.text = "" Then
            txtDateDue.text = " "
      End If
      Exit Sub
   End If
   If txtIssueDate.text <> "" Then
      If TextBoxFormatDate(txtIssueDate) Then
            'Modified by BOSL
            'issue 468
            'Modified by anol 01 Sep 2014
            '02 Dec 2014
           lblPostingDate.ToolTipText = txtIssueDate.text
'           txtDateDue.text = txtIssueDate.text
           If frmMMain.IsRibbonVersion And IsDate(lblPostingDate.ToolTipText) = True Then
              Dim adoConn As New ADODB.Connection
              Dim szSQL As String
              If txtDmdClientList.text = "" Then
                  ShowMsgInTaskBar "Please select a client", "Y", "N"
                  FocusControl cmdDmdClientList
                  Exit Sub
              End If
              adoConn.Open getConnectionString
              If IsPeriodStatus(lblPostingDate.ToolTipText, txtDmdClientList.text, adoConn) = 0 Then
                  ShowMsgInTaskBar "The posting date cannot fall within a closed financial period", "Y", "N"
                  adoConn.Close
                  Exit Sub
              ElseIf IsPeriodStatus(lblPostingDate.ToolTipText, txtDmdClientList.text, adoConn) = 9 Then
                  ShowMsgInTaskBar "The Posting date does not fall in any existing financial period", "Y", "N"
                  adoConn.Close
                  Exit Sub
              End If
           End If
          'End of modification
           
      End If
   End If
End Sub

Private Sub txtReceiptEntered_Change()
   txtDifference.text = Format(Val(txtReceiptTotal.text) - Val(txtReceiptEntered.text), "0.00")
End Sub

Private Sub txtReceiptReference_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
        cmdAmountType.SetFocus
    End If
End Sub

Private Sub txtReceiptTotal_Change()
   txtDifference.text = Format(Val(txtReceiptTotal.text) - Val(txtReceiptEntered.text), "0.00")
End Sub

Private Sub txtRptClientList1_KeyPress(KeyAscii As MSForms.ReturnInteger)
    If KeyAscii = 13 Then
        cmdRptClientList1.SetFocus
    End If
End Sub

'Private Sub txtRptIDFrom_Change()
'   SelTxtInCtrl txtRptIDFrom
'End Sub

'Private Sub txtRptIDFrom_LostFocus()
''   If txtRptIDFrom.text = "" Then txtRptIDFrom.text = "1"
'   If Val(txtRptIDFrom.text) <= 0 Then
'      MsgBox "The value should be more than 0", vbCritical + vbOKOnly, "Receipt History"
'      txtRptIDFrom.SetFocus
'   End If
'   If Val(txtRptIDTo.text) < Val(txtRptIDFrom.text) Then
'      MsgBox "The value should be equal or less than " & txtRptIDTo.text, vbCritical + vbOKOnly, "Receipt History"
'      txtRptIDTo.SetFocus
'   End If
'End Sub

'Private Sub txtRptIDTo_LostFocus()
'   If txtRptIDTo.text = "" Then txtRptIDTo.text = "99999999"
'   If Val(txtRptIDTo.text) <= 0 Then
'      MsgBox "The value should be more than 0", vbCritical + vbOKOnly, "Receipt History"
'      txtRptIDTo.text = ""
'      txtRptIDTo.SetFocus
'   End If
'   If Val(txtRptIDTo.text) < Val(txtRptIDFrom.text) Then
'      MsgBox "The value should be equal or more than " & txtRptIDFrom.text, vbCritical + vbOKOnly, "Receipt History"
'      txtRptIDTo.SetFocus
'   End If
'End Sub

Private Sub txtRptPropertyList_KeyPress(KeyAscii As MSForms.ReturnInteger)
    If KeyAscii = 13 Then
        FocusControl cmdRptPropertyList
     End If
End Sub

Private Sub txtRptPropertyList1_KeyPress(KeyAscii As MSForms.ReturnInteger)
    If KeyAscii = 13 Then
        cmdRptPropertyList1.SetFocus
    End If
End Sub

Private Sub txtSPayment_Click()
   SelTxtInCtrl txtSPayment
End Sub

Private Sub txtSPayment_GotFocus()
   If txtSPayment.text = "" Then txtSPayment.text = "0.00"
   If Not bTotalRptTyped Then _
      txtSPaymentTotal.text = Format(CCur(txtSPaymentTotal.text) - CCur(txtSPayment.text), "0.00")

   SelTxtInCtrl txtSPayment
   iCurRow = flxSPayment.row
   cGridRptTotal = cGridRptTotal - CCur(txtSPayment.text)
End Sub

Private Sub txtSPayment_KeyDown(KeyCode As Integer, Shift As Integer)
   If KeyCode = 13 Then flxSPayment.SetFocus
End Sub

Private Sub txtSPayment_KeyPress(KeyAscii As Integer)
   DigitTextKeyPress txtSPayment, KeyAscii
   'added by anol issue 571
   If Val(txtSPayment.text) > 0 Then
        cmdRptClientList.Enabled = False
        cmdRptPropertyList.Enabled = False
   End If
End Sub

Private Sub txtSPayment_LostFocus()
On Error GoTo Err
   If txtSPayment.text = "" Then
        txtSPayment.text = "0.00"
   End If
   txtSPayment.text = Format((txtSPayment.text), "0.00")
   flxSPayment.TextMatrix(flxSPayment.row, 15) = "A"
   If flxSPayment.TextMatrix(iCurRow, 9) > 0 Then
        If (flxSPayment.TextMatrix(iCurRow, 9)) < CDbl(txtSPayment.text) Then
           MsgBox "Payment amount exceeds amount outstanding.", vbExclamation + vbOKOnly, "Warning"
           txtSPayment.text = "0.00"
           FocusControl txtSPayment
           txtSPayment_GotFocus
           Exit Sub
        End If
   End If

   flxSPayment.TextMatrix(iCurRow, 10) = Format(CCur(txtSPayment.text), "0.00")

   cGridRptTotal = TotalReceiptEntered
'   If Val(txtSPaymentTotal.text) = 0 And cGridRptTotal > 0 Then
'        txtSPaymentTotal.text = cGridRptTotal
'   End If
   If bTotalRptTyped Then
      If Val(txtSPaymentTotal.text) - Val(cGridRptTotal + CCur(txtSPayment.text)) < 0 Then
         txtSPayment.text = "0.00"
         flxSPayment.TextMatrix(iCurRow, 10) = Format(CCur(txtSPayment.text), "0.00")
         MsgBox "Receipt amount entered would exceed total receipt amount.", vbExclamation + vbOKOnly, "Sales Receipt"
         If txtSPayment.Visible And txtSPayment.Enabled Then
            txtSPayment.SetFocus
         End If
         SelTxtInCtrl txtSPayment
         Exit Sub
      End If
   Else
      If Not cmdAutoAllocSel.Visible Then
         txtSPaymentTotal.text = Format(CCur(txtSPaymentTotal.text) + CCur(txtSPayment.text), "0.00")
      End If
      If Val(txtSPayment.text) > 0 Then flxCrPoA.Enabled = False
   End If
   cGridRptTotal = cGridRptTotal + CCur(txtSPayment.text)

   baChangesMade(iCurRow) = IIf(CCur(flxSPayment.TextMatrix(iCurRow, 10)) > 0, True, False)
   txtSPayment.text = "0.00"

   txtSPayment.Visible = False
   flxSPayment.Enabled = True
   
   Call SumUpHeaderBySplits
   Call SpreadHeaderInSplits

   If Not cmdAutoAllocSel.Visible Then
      txtReceiptEntered.text = Format(TotalReceiptEntered, "0.00")
   End If
   cmdSPSave.Refresh
   Exit Sub
Err:
End Sub

Private Sub SumUpHeaderBySplits()
   Dim i As Integer, cSumSplits As Currency, j As Integer

   If flxSPayment.TextMatrix(iCurRow, 0) = "-" Then
      i = iCurRow
      Do
         i = i - 1
         If flxSPayment.TextMatrix(i, 0) = ">" Then Exit Do
      Loop While i > 0
      baChangesMade(i) = True
      j = i + 1
      cSumSplits = 0

      Do
         cSumSplits = cSumSplits + Val(flxSPayment.TextMatrix(j, 10))
         j = j + 1
         If j = flxSPayment.Rows Then Exit Do
      Loop While flxSPayment.TextMatrix(j, 0) = "-"

      flxSPayment.TextMatrix(i, 10) = Format(cSumSplits, "0.00")
      flxSPayment.TextMatrix(i, 15) = "A"
   End If
End Sub

Private Function SpreadHeaderInSplits() As Integer       'Return the number of splits
On Error GoTo Err:
   Dim i As Integer, cSumSplits As Currency, j As Integer

   If flxSPayment.TextMatrix(iCurRow, 0) = "+" Or flxSPayment.TextMatrix(iCurRow, 0) = ">" Then
      j = iCurRow + 1

      If Val(flxSPayment.TextMatrix(iCurRow, 10)) = Val(flxSPayment.TextMatrix(iCurRow, 9)) Then
         Do
            flxSPayment.TextMatrix(j, 10) = Format(flxSPayment.TextMatrix(j, 9), "0.00")
            ' Mark 1 here you need to calculate net amount and vat
            baChangesMade(j) = True

            j = j + 1
            If j = flxSPayment.Rows Then Exit Do
         Loop While flxSPayment.TextMatrix(j, 0) = "-"
      Else
         cSumSplits = flxSPayment.TextMatrix(iCurRow, 10)

         Do
            flxSPayment.TextMatrix(j, 10) = IIf(cSumSplits > flxSPayment.TextMatrix(j, 9), flxSPayment.TextMatrix(j, 9), cSumSplits)
            flxSPayment.TextMatrix(j, 10) = Format(flxSPayment.TextMatrix(j, 10), "0.00")
            cSumSplits = cSumSplits - flxSPayment.TextMatrix(j, 10)

            baChangesMade(j) = True

            j = j + 1
            If j = flxSPayment.Rows Then Exit Do
         Loop While flxSPayment.TextMatrix(j, 0) = "-"
         'removed "And cSumSplits <> 0" because when we input zero intthe grid input text box it was not iterarating upto the last line
         'issue 557 solved by anol 20180324
      End If
   End If
   SpreadHeaderInSplits = j - iCurRow
   Exit Function
Err:
   MsgBox Err.description
'''   On Error GoTo Err:
''   Dim i As Integer, cSumSplits As Currency, j As Integer
''   Dim isNagativeLineExist As Boolean
''   Dim cSumNegantive As Currency
''   Dim cSumPostiveEntered As Currency
''   Dim cTotalEnteredAmount As Currency
''   Dim aSupplier() As Currency, aSup(4) As Currency
''   Dim iRow As Integer
''   Dim numberofNegLines As Integer
''   Dim numberofLines As Integer
''   numberofNegLines = 0
''   numberofLines = 0
''   cSumNegantive = 0
''   'aSupplier()  is for storing all positive values
''   'when you try to allocate zero clear all the split lines
''   If flxSPayment.TextMatrix(iCurRow, 0) = "-" Then
''        If flxSPayment.TextMatrix(iCurRow, 33) = "" Then
''            Exit Function
''        End If
''        If flxSPayment.TextMatrix(iCurRow, 32) = "-1" And flxSPayment.TextMatrix(iCurRow, 33) - flxSPayment.TextMatrix(iCurRow, 10) >= 0 Then
''           ' flxSPayment.TextMatrix(iCurRow, 9) = flxSPayment.TextMatrix(iCurRow, 33) - flxSPayment.TextMatrix(iCurRow, 10)
''        End If
''        Exit Function
''   End If
''   'now set intial os amount from database to the grid. Because if you change textbox input for maoumt multiplae time for negative os amoutn changes
''   ' so you need to refress it szIntitalOSAmount
''   If (flxSPayment.TextMatrix(iCurRow, 0) = "+" Or flxSPayment.TextMatrix(iCurRow, 0) = ">") Then
''           j = iCurRow + 1
''                Do
''                    flxSPayment.TextMatrix(j, 9) = szIntitalOSAmount(j) 'intitila os amount
''                    flxSPayment.TextMatrix(j, 33) = 0 'substitute os maount
''                    j = j + 1
''                    If j = flxSPayment.Rows Then Exit Do
''                 Loop While flxSPayment.TextMatrix(j, 0) = "-"
''   End If
''
''   If (flxSPayment.TextMatrix(iCurRow, 0) = "+" Or flxSPayment.TextMatrix(iCurRow, 0) = ">") And Val(flxSPayment.TextMatrix(iCurRow, 10)) = 0 Then
''           j = iCurRow + 1
''                Do
''                    flxSPayment.TextMatrix(j, 9) = szIntitalOSAmount(j) 'intitial os amount
''                    flxSPayment.TextMatrix(j, 10) = 0 'entered amount
''                    flxSPayment.TextMatrix(j, 33) = 0   'substitute os maount
''                    j = j + 1
''                    If j = flxSPayment.Rows Then Exit Do
''                 Loop While flxSPayment.TextMatrix(j, 0) = "-"
''   End If
''
''   If (flxSPayment.TextMatrix(iCurRow, 0) = "+" Or flxSPayment.TextMatrix(iCurRow, 0) = ">") And Val(flxSPayment.TextMatrix(iCurRow, 10)) > 0 Then
''           j = iCurRow + 1
''                Do
''                    If flxSPayment.TextMatrix(j, 9) < 0 Then 'we want to put zero when there is negative amount
''                        isNagativeLineExist = True
''                        Exit Do
''                    End If
''                    j = j + 1
''                    If j = flxSPayment.Rows Then Exit Do
''
''                 Loop While flxSPayment.TextMatrix(j, 0) = "-"
''   End If
''   If (flxSPayment.TextMatrix(iCurRow, 0) = "+" Or flxSPayment.TextMatrix(iCurRow, 0) = ">") And Val(flxSPayment.TextMatrix(iCurRow, 10)) > 0 Then
''           j = iCurRow + 1
''                Do
''                    If flxSPayment.TextMatrix(j, 9) < 0 Then 'we want to put zero when there is negative amount
''                        cSumNegantive = cSumNegantive + Val(flxSPayment.TextMatrix(j, 9))
''                        numberofNegLines = numberofNegLines + 1
''                    End If
''                    j = j + 1
''
''                    If j = flxSPayment.Rows Then Exit Do
''
''                 Loop While flxSPayment.TextMatrix(j, 0) = "-"
''   End If
''   If (flxSPayment.TextMatrix(iCurRow, 0) = "+" Or flxSPayment.TextMatrix(iCurRow, 0) = ">") Then
''        'And Val(flxSPayment.TextMatrix(iCurRow, 10)) > 0
''           j = iCurRow + 1
''                Do
''                    numberofLines = numberofLines + 1
''                    j = j + 1
''                    If j = flxSPayment.Rows Then Exit Do
''                Loop While flxSPayment.TextMatrix(j, 0) = "-"
''   End If
''
'''Description of the array
'''index 0. This is the primary invoice amount line
'''index 1 .after allocating sum negative amount how current invoice line will look that I am saving here (Substitute invoice line) . index is 1.
'''index 2' after allocating first negative number save invoice line
'''index 2' after allocating second positive input number save OS line
'''index 3' after allocating second positive input number save payment line
'''index 4 .Saving the position of of the line so that after sorting we can update accordingly.
'''Remember we need to save initial OS amount in an array . Because I am destorying OS amount column
'''Algorthm
'''0. Feed the line into array index 0 with invoice line amount (including negative)
'''1.Sort Invoice line negative, max to low amount
'''2.allocate negative amount and save in index 1
'''3. do the allocation for postive line and allocate based on index 1 with inputted amount then save them in index 3 as os amount . construct index 4 with actual paid amount
''            ReDim aSupplier(numberofLines, 4) As Currency
'''            aSupplier(0, 0) = "50"
'''            aSupplier(0, 1) = "1"
'''
'''            aSupplier(1, 0) = "3200"
'''            aSupplier(1, 1) = "2"
'''
'''            aSupplier(2, 0) = "32"
'''            aSupplier(2, 1) = "3"
''           i = 0
''              '  saving all all entries in an array because I want to deduct from it
''            If (flxSPayment.TextMatrix(iCurRow, 0) = "+" Or flxSPayment.TextMatrix(iCurRow, 0) = ">") And Val(flxSPayment.TextMatrix(iCurRow, 10)) > 0 Then
''                       j = iCurRow + 1
''                            Do
''                                aSupplier(i, 0) = flxSPayment.TextMatrix(j, 9)
''                                aSupplier(i, 1) = flxSPayment.TextMatrix(j, 9)
''                                aSupplier(i, 4) = j
''                                i = i + 1
''                                j = j + 1
''
''                                If j = flxSPayment.Rows Then Exit Do
''                            Loop While flxSPayment.TextMatrix(j, 0) = "-"
''             End If
'''        Debug.Print "Printing main"
'''       For j = 0 To numberofLines - 1
'''            Debug.Print aSupplier(j, 0)
'''       Next j
''       'Exit Function
'''      Sort the array by biggest to lowest amount  bubble sort                                                        .
''      For i = 0 To numberofLines - 1
''         For j = 0 To numberofLines - 2
''            If Val(aSupplier(j, 0)) < Val(aSupplier(j + 1, 0)) Then
''               aSup(0) = aSupplier(j, 0)
''               aSup(1) = aSupplier(j, 0)
''               aSup(2) = aSupplier(j, 2)
''               aSup(4) = aSupplier(j, 4)
''
''               aSupplier(j, 0) = aSupplier(j + 1, 0)
''               aSupplier(j, 1) = aSupplier(j + 1, 0)
''               aSupplier(j, 2) = aSupplier(j + 1, 2)
''               aSupplier(j, 4) = aSupplier(j + 1, 4)
''
''               aSupplier(j + 1, 0) = aSup(0)
''               aSupplier(j + 1, 1) = aSup(1)
''               aSupplier(j + 1, 2) = aSup(2)
''               aSupplier(j + 1, 4) = aSup(4)
''            End If
''         Next j
''      Next i
''      'Exit Function
'''      Debug.Print "Printing 0"
'''       For j = 0 To numberofLines - 1
'''            Debug.Print aSupplier(j, 0)
'''       Next j
''       'Exit Function
'''       Debug.Print "Printing 1"
'''       For j = 0 To numberofLines - 1
'''            Debug.Print aSupplier(j, 1)
'''       Next
'''       'Exit Function
'''       Debug.Print "Printing 2"
'''       For j = 0 To numberofLines - 1
'''            Debug.Print aSupplier(j, 2)
'''       Next j
'''      Debug.Print ""
'''' 'remming main code
''''' I do not want to spread in split from header when header row is zero. because zero is a defualt value in the text box.
''''   If (flxSPayment.TextMatrix(iCurRow, 0) = "+" Or flxSPayment.TextMatrix(iCurRow, 0) = ">") Then
''''      j = iCurRow + 1
''''
''''        If Val(flxSPayment.TextMatrix(iCurRow, 10)) = Val(flxSPayment.TextMatrix(iCurRow, 9)) Then
''''                Do
''''                   If flxSPayment.TextMatrix(j, 9) > 0 Then 'we want to put zero when there is negative amount
''''                       flxSPayment.TextMatrix(j, 10) = Format(flxSPayment.TextMatrix(j, 9), "0.00")
''''                       ' Mark 1 here you need to calculate net amount and vat
''''                       baChangesMade(j) = True
''''                   End If
''''                   j = j + 1
''''                   If j = flxSPayment.Rows Then Exit Do
''''
''''                Loop While flxSPayment.TextMatrix(j, 0) = "-"
''''        Else
''''
''''          cSumSplits = flxSPayment.TextMatrix(iCurRow, 10)
''''
'''''    If cSumSplits - Abs(cSumNegantive) < 0 Then
'''''        MsgBox "Total entered receipt amount is less than total negative lines", vbOKOnly, "Warning"
'''''     End If
''''         If cSumSplits = 0 Then
''''                Do
''''                    flxSPayment.TextMatrix(j, 10) = "0.00"
''''                    baChangesMade(j) = True
''''                    j = j + 1
''''                    If j = flxSPayment.Rows Then Exit Do
''''                 Loop While flxSPayment.TextMatrix(j, 0) = "-"
''''         Else
''''                 Do
''''                    If flxSPayment.TextMatrix(j, 9) > 0 Then ''we want to put zero when there is negative amount
''''                        flxSPayment.TextMatrix(j, 10) = IIf(cSumSplits > flxSPayment.TextMatrix(j, 9), flxSPayment.TextMatrix(j, 9), cSumSplits)
''''                        flxSPayment.TextMatrix(j, 10) = Format(flxSPayment.TextMatrix(j, 10), "0.00")
''''                    End If
''''                    cSumSplits = cSumSplits - flxSPayment.TextMatrix(j, 10)
''''
''''                    baChangesMade(j) = True
''''
''''                    j = j + 1
''''                    If j = flxSPayment.Rows Then Exit Do
''''                 Loop While flxSPayment.TextMatrix(j, 0) = "-"
''''         End If
''''         'removed "And cSumSplits <> 0" because when we input zero intthe grid input text box it was not iterarating upto the last line
''''         'issue 557 solved by anol 20180324
''''      End If
''''   End If
''   'allocating negative amount to column 1
''     ' For j = numberofLines To 1
''          ' Exit Function
'''           Debug.Print "Printing 1 before neg allocation"
''       For j = 0 To numberofLines - 1
''            Debug.Print aSupplier(j, 1)
''       Next
''
''            j = 0 'starting from first element
''            cSumNegantive = Abs(cSumNegantive)
''            Do
''                If aSupplier(j, 1) > 0 Then
''                    If cSumNegantive >= aSupplier(j, 1) Then
''                       cSumNegantive = cSumNegantive - aSupplier(j, 1)
''                       baChangesMade(aSupplier(j, 4)) = True
''                       aSupplier(j, 1) = 0
''                    Else
''                        aSupplier(j, 1) = aSupplier(j, 1) - cSumNegantive
''                         baChangesMade(aSupplier(j, 4)) = True
''                        cSumNegantive = 0
''                    End If
''                 Else
''                    aSupplier(j, 1) = 0
''                 End If
''                j = j + 1
''            Loop While cSumNegantive > 0 And j < numberofLines
''     ' Next j
''     'Debug.Print "Printing 1 after neg allocation"
''       For j = 0 To numberofLines - 1
''            'aSupplier(j, 2) = IIf(aSupplier(j, 1) > 0, aSupplier(j, 1), 0)
''            If aSupplier(j, 1) > 0 Then
''                     aSupplier(j, 2) = aSupplier(j, 1)
''            Else
''                    baChangesMade(aSupplier(j, 4)) = True
''                    aSupplier(j, 2) = 0
''            End If
''
''            aSupplier(j, 3) = 0
''       Next
''       'Exit Function
''       Debug.Print "Printing 2"
''       For j = 0 To numberofLines - 1
''            Debug.Print aSupplier(j, 2)
''       Next j
'''      Debug.Print ""
''
''     'allocating entered amount
''      cSumSplits = flxSPayment.TextMatrix(iCurRow, 10)
''       j = 0 'starting from first element
''            Do
''                If aSupplier(j, 2) > 0 Then
''                    If cSumSplits >= aSupplier(j, 2) Then
''                       aSupplier(j, 3) = aSupplier(j, 2)
''                       cSumSplits = cSumSplits - aSupplier(j, 2)
''                       baChangesMade(aSupplier(j, 4)) = True
''                       aSupplier(j, 2) = 0
'''                       aSupplier(j, 3) = cSumSplits
''                    Else
''                        aSupplier(j, 2) = aSupplier(j, 2) - cSumSplits
''                        aSupplier(j, 3) = cSumSplits 'actual paid amount = aSupplier(j, 3) , os amount =aSupplier(j, 2)
''                        baChangesMade(aSupplier(j, 4)) = True
''                        cSumSplits = 0
''                    End If
''                End If
''                j = j + 1
''            Loop While cSumSplits > 0
'''       Debug.Print "Printing 1"
'''       For j = 0 To numberofLines - 1
'''            Debug.Print aSupplier(j, 1)
'''       Next j
'''       Debug.Print "Printing 2"
'''       For j = 0 To numberofLines - 1
'''            Debug.Print aSupplier(j, 2)
'''       Next j
''       Debug.Print "Printing 3 payment amount"
''       For j = 0 To numberofLines - 1
''            Debug.Print aSupplier(j, 3)
''       Next j
''       Debug.Print "Printing 4 lineposition"
''       For j = 0 To numberofLines - 1
''            Debug.Print aSupplier(j, 4)
''       Next j
''       Debug.Print "end Printing 4"
''       'Exit Function
'''      If (flxSPayment.TextMatrix(iCurRow, 0) = "+" Or flxSPayment.TextMatrix(iCurRow, 0) = ">") And Val(flxSPayment.TextMatrix(iCurRow, 10)) > 0 Then
'''           j = iCurRow + 1
'''                Do
'''                    If flxSPayment.TextMatrix(j, 10) > 0 Then 'we want to put zero when there is negative amount
'''                        cSumPostiveEntered = cSumPostiveEntered + Val(flxSPayment.TextMatrix(j, 10))
'''                    End If
'''                    j = j + 1
'''                    If j = flxSPayment.Rows Then Exit Do
'''                 Loop While flxSPayment.TextMatrix(j, 0) = "-"
'''   End If
'''
'''
'''
'''      cSumNegantive = Abs(cSumNegantive)
''      'cTotalEnteredAmount = Val(flxSPayment.TextMatrix(iCurRow, 10)) + cSumNegantive
'''     If cSumPostiveEntered - cSumNegantive < 0 Then
'''        MsgBox "Total entered receipt amount is less than total negative lines", vbOKOnly, "Warning"
'''     End If
''    'First complete the negatives then second section from high to low postive
'''    'for negative lines
'''      If (flxSPayment.TextMatrix(iCurRow, 0) = "+" Or flxSPayment.TextMatrix(iCurRow, 0) = ">") And Val(flxSPayment.TextMatrix(iCurRow, 10)) > 0 Then
'''           j = iCurRow + 1
'''                Do
'''                    If Val(flxSPayment.TextMatrix(j, 9)) < 0 Then 'we want to put zero when there is negative amount
'''                       ' cTotalEnteredAmount = cTotalEnteredAmount + Val(flxSPayment.TextMatrix(j, 9))
'''                        flxSPayment.TextMatrix(j, 10) = 0
'''                    End If
'''                    j = j + 1
'''                    If j = flxSPayment.Rows Then Exit Do
'''                 Loop While flxSPayment.TextMatrix(j, 0) = "-"
'''      End If
'''
''        'for positive lines
''        'aSupplier(j, 0) shall be used for entered amount
'''''       j = 0
'''''        Do
'''''                If aSupplier(j, 0) > 0 Then
'''''                    If cSumNegantive >= aSupplier(j, 0) Then
'''''                       cSumNegantive = cSumNegantive - aSupplier(j, 0)
'''''                       'aSupplier(j, 0) = aSupplier(j, 0)
'''''                    Else
'''''                        aSupplier(j, 0) = cSumNegantive
'''''                        cSumNegantive = 0
'''''                    End If
'''''                Else
'''''                    'cTotalEnteredAmount = cTotalEnteredAmount + aSupplier(j, 0)
'''''                    aSupplier(j, 0) = 0
'''''                End If
'''''                j = j + 1
'''''            Loop While j <= numberofLines
''     ' Next
''   'If isNagativeLineExist = True Then
''   'adjust the grid accordingly
''        For j = 0 To numberofLines
''            'We do not change os amount in visible screen. But what we do with it?
''            flxSPayment.TextMatrix(aSupplier(j, 4), 33) = Format(aSupplier(j, 2), "0.00")
''            If flxSPayment.TextMatrix(aSupplier(j, 4), 32) = "-1" Then
''                flxSPayment.TextMatrix(aSupplier(j, 4), 9) = Format(aSupplier(j, 2), "0.00")
''            End If
''            flxSPayment.TextMatrix(aSupplier(j, 4), 10) = Format(aSupplier(j, 3), "0.00")
''        Next j
'''        For j = 1 To numberofLines
'''            flxSPayment.TextMatrix(aSupplier(j, 1), 9) = Format(aSupplier(j, 2), "0.00")
'''        Next j
''   'End If
''   SpreadHeaderInSplits = j - iCurRow
''   Exit Function
''Err:
''   MsgBox Err.description
End Function

Private Function TotalReceiptEntered() As Currency ' ReceiptEntered based on header. as split updated Header
   Dim i As Integer

   For i = 1 To flxSPayment.Rows - 1
      TotalReceiptEntered = TotalReceiptEntered + IIf(Val(flxSPayment.TextMatrix(i, 10)) > 0 And flxSPayment.TextMatrix(i, 0) <> "-", _
                                                  Val(flxSPayment.TextMatrix(i, 10)), 0)
   Next i
End Function

Private Sub txtSPaymentTotal_Change()
   txtReceiptTotal.text = txtSPaymentTotal.text
   If Val(txtSPaymentTotal.text) = 0 And Val(txtReceiptEntered.text) = 0 Then
        cmdBankAc.Enabled = True
   End If
   If Val(txtSPaymentTotal.text) = 0 Then
      bChangesMade = False     'there are no change has made in the form
      cmdSPSave.Enabled = False
      Exit Sub
   Else
      bChangesMade = True     'there are some changes have made in the form
      cmdSPSave.Enabled = True
   End If
   cmdBankAc.Enabled = IIf(Frame5(4).Visible, True, False)
   If Val(txtSPaymentTotal.text) = 0 And Val(txtReceiptEntered.text) = 0 Then
        cmdBankAc.Enabled = True
   End If
End Sub

Private Sub txtSPaymentTotal_GotFocus()
    On Error GoTo Err
    If Trim(txtTenantID.text) = "" Then
       MsgBox "Please select a lessee.", vbExclamation + vbOKOnly, "Please select a lessee"
       FocusControl cmdTenantLookup
       Exit Sub
    End If

   If txtBankAc.text = "" And chkApplyFund.Value = False Then
      MsgBox "Please select a bank account.", vbCritical + vbOKOnly, "Please select a bank account."
      cmdBankAc.Enabled = True
      FocusControl cmdBankAc
      Exit Sub
   End If
    
   cTempReceiptAmt = CCur(txtSPaymentTotal.text)
   SelTxtInCtrl txtSPaymentTotal
   Exit Sub
Err:
End Sub

Private Sub txtSPaymentTotal_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
        txtSPDate.SetFocus
    End If
   If KeyAscii <> 45 Then
      DigitTextKeyPress txtSPaymentTotal, KeyAscii
   Else
'      txtSPaymentTotal.text = Format(Val(txtSPaymentTotal.text) * (-1), "0.00")
'      If Val(txtSPaymentTotal.text) < 0 Then KeyAscii = 0
       'txtSPaymentTotal.text = ""
   End If
End Sub

Private Sub txtSPaymentTotal_KeyUp(KeyCode As Integer, Shift As Integer)
   bTotalRptTyped = IIf(Val(txtSPaymentTotal.text) > 0, True, False)
End Sub

Private Sub txtSPaymentTotal_LostFocus()
   Dim iRow As Integer

   On Error GoTo GotYou

   If Trim(txtSPaymentTotal.text) = "" Then txtSPaymentTotal.text = "0.00"

   If Val(txtSPaymentTotal.text) >= 0 Then
'      If (cGridRptTotal - CCur(txtSPaymentTotal.text) <> 0) And (cGridRptTotal + CCur(txtSPaymentTotal.text) <> 0) Then
'         If CCur(txtSPaymentTotal.text) < cGridRptTotal Then
'            MsgBox "Total receipt amount cannot be less than the sum of receipt lines", vbCritical + vbOKOnly, "Wrong amount entry"
'            txtSPaymentTotal.text = CStr(Format(cGridRptTotal, "0.00"))
'            Exit Sub
'         End If
'      End If
'      txtSPaymentTotal.text = Format(txtSPaymentTotal.text, "0.00")
'      If cTempReceiptAmt - CCur(txtSPaymentTotal.text) <> 0 Then flxCrPoA.Enabled = False
   Else                       '############ REFUND AMOUNT WHICH IS -ve #################
      If bChangesMade Then
         For iRow = 1 To flxSPayment.Rows - 1
            If Val(flxSPayment.TextMatrix(iRow, 10)) > 0 Then
               flxSPayment.TextMatrix(iRow, 10) = "0.00"
            End If
         Next iRow
         txtReceiptEntered.text = "0.00"
         txtSPaymentTotal.text = Format(txtSPaymentTotal.text, "0.00")
         cGridRptTotal = 0
         bTotalRptTyped = False
      End If
   End If
   txtSPaymentTotal.text = Format(txtSPaymentTotal.text, "0.00")
   Exit Sub

GotYou:
   txtSPaymentTotal.text = "0.00"
   
   bTotalRptTyped = False
End Sub

Private Sub txtSPDate_Change()
   TextBoxChangeDate txtSPDate
   If IsDate(txtSPDate.text) Then
       
        lblRptPostingDate.ToolTipText = txtSPDate.text
   Else
        lblRptPostingDate.ToolTipText = ""
   End If
End Sub

Private Sub txtSPDate_GotFocus()
   SelTxtInCtrl txtSPDate
End Sub

Private Sub txtSPDate_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
        If txtAllocationDAte.Visible Then
            FocusControl txtAllocationDAte
        Else
            FocusControl flxSPayment
        End If

    End If
   TextBoxKeyPrsDate txtSPDate, KeyAscii
End Sub

Private Sub txtSPDate_LostFocus()
   If txtSPDate.text <> "" Then
      If TextBoxFormatDate(txtSPDate) Then
         If lblRptPostingDate.ToolTipText = "" And lblRptPostingDate.ToolTipText <> txtSPDate.text Then
            lblRptPostingDate.ToolTipText = txtSPDate.text
          End If
         'Modified by BOSL
         'issue 468
         'Modified by anol 01 Sep 2014
        If frmMMain.IsRibbonVersion And IsDate(lblRptPostingDate.ToolTipText) = True Then
                Dim adoConn As New ADODB.Connection
                Dim szSQL As String
                If IsNull(txtRptClientList.text) Then Exit Sub
                adoConn.Open getConnectionString
                
                If IsPeriodStatus(lblRptPostingDate.ToolTipText, txtRptClientList.text, adoConn) = 0 Then
                   ShowMsgInTaskBar "The posting date cannot fall within a closed financial period", "Y", "N"
                   adoConn.Close
                   Set adoConn = Nothing
                   Exit Sub
                ElseIf IsPeriodStatus(lblRptPostingDate.ToolTipText, txtRptClientList.text, adoConn) = 9 Then
                   ShowMsgInTaskBar "The posting date does not fall in any existing financial period", "Y", "N"
                   adoConn.Close
                   Set adoConn = Nothing
                   Exit Sub
                End If
                adoConn.Close
                Set adoConn = Nothing
                End If
                'End of modification
      End If
   End If
End Sub

'Private Sub txtStValue_Change()
'   If iSelSplitCol >= 4 And iSelSplitCol < 7 Then _
'      TextBoxChangeDate txtStValue
'End Sub

'Private Sub txtStValue_KeyPress(KeyAscii As Integer)
'   If KeyAscii = 27 And txtStValue.text <> "" Then
'      txtStValue.text = ""
'      Exit Sub
'   End If
'   If KeyAscii = 27 And txtStValue.text = "" Then txtStValue_LostFocus
'   If KeyAscii = 13 Then
'      txtStValue_LostFocus
'      Exit Sub
'   End If
'
'   If iSelSplitCol >= 4 And iSelSplitCol < 7 Then _
'      TextBoxKeyPrsDate txtStValue, KeyAscii
'End Sub

'Private Sub txtStValue_LostFocus()
'   If iSelSplitCol >= 4 And iSelSplitCol < 7 Then _
'      If Not TextBoxFormatDate(txtStValue) Then _
'         Exit Sub
'
'   Dim cVAT       As Currency
'   Dim cTotal     As Currency
'   Dim cDiff      As Currency
'
'   txtStValue.Visible = False
'
'   If txtStValue.text = "" Then Exit Sub
'   If txtStValue.text = flxChildDemands.TextMatrix(flxChildDemands.row, iSelSplitCol) Then Exit Sub
'
'   If iSelSplitCol = 7 Then
''     Get the original vat rate
'      cVAT = CalculateVatRate(flxChildDemands.TextMatrix(flxChildDemands.row, iSelSplitCol), _
'                              flxChildDemands.TextMatrix(flxChildDemands.row, iSelSplitCol + 1))
''     Get the new total
'      cTotal = Val(txtStValue.text) * ((cVAT / 100) + 1)
'      cDiff = cTotal - Val(flxChildDemands.TextMatrix(flxChildDemands.row, iSelSplitCol + 2))
'
'      flxDemands.TextMatrix(iDemandRow, 7) = Format(Val(flxDemands.TextMatrix(iDemandRow, 7)) + cDiff, "0.00")
'      flxDemands.TextMatrix(iDemandRow, 8) = Format(Val(flxDemands.TextMatrix(iDemandRow, 8)) + cDiff, "0.00")
'   End If
'   flxChildDemands.TextMatrix(flxChildDemands.row, iSelSplitCol) = txtStValue.text
'
'   Dim adoconn    As New ADODB.Connection
'   Dim adoRst     As New ADODB.Recordset
'   Dim szStr      As String
'   Dim szSplitID  As String
'   Dim szRptID    As Long
'
''   connect to database
'   adoconn.Open getConnectionString
''***get sendtoprint field for all demands that were set to be sent to print***
'   szStr = "SELECT S.*  " & _
'           "FROM DEMANDSPLITRECORDS AS S " & _
'           "WHERE S.DSR = '" & flxChildDemands.TextMatrix(flxChildDemands.row, 18) & "';"
'
'   With adoRst
'      .Open szStr, adoconn, adOpenDynamic, adLockPessimistic
'
'      If iSelSplitCol = 3 Then _
'         .Fields.Item("DESCRIPTION").Value = flxChildDemands.TextMatrix(flxChildDemands.row, 3)
'      If iSelSplitCol = 4 Then _
'         .Fields.Item("DATEFROM").Value = flxChildDemands.TextMatrix(flxChildDemands.row, 4)
'      If iSelSplitCol = 5 Then _
'         .Fields.Item("DATETO").Value = flxChildDemands.TextMatrix(flxChildDemands.row, 5)
'      If iSelSplitCol = 6 Then _
'         .Fields.Item("DUEDATE").Value = flxChildDemands.TextMatrix(flxChildDemands.row, 6)
'      If iSelSplitCol = 7 Then
''         cVAT = CalculateVatRate(.Fields.Item("AMOUNT").Value, .Fields.Item("VATAMOUNT").Value)
'         .Fields.Item("AMOUNT").Value = Val(flxChildDemands.TextMatrix(flxChildDemands.row, 7))
'         .Fields.Item("VATAmount").Value = Val(txtStValue.text) * (cVAT / 100)
'         .Fields.Item("TOTALAMOUNT").Value = Val(txtStValue.text) * ((cVAT / 100) + 1)
'         flxChildDemands.TextMatrix(flxChildDemands.row, iSelSplitCol) = Format(flxChildDemands.TextMatrix(flxChildDemands.row, iSelSplitCol), "0.00")
'         flxChildDemands.TextMatrix(flxChildDemands.row, iSelSplitCol + 1) = Format(.Fields.Item("VATAmount").Value, "0.00")
'         flxChildDemands.TextMatrix(flxChildDemands.row, iSelSplitCol + 2) = Format(.Fields.Item("TOTALAMOUNT").Value, "0.00")
'         cTotal = Val(.Fields.Item("TOTALAMOUNT").Value)
'      End If
'
'      .Update
'      .Close
'   End With
'
'   szStr = "SELECT RS.TransactionID, RS.RptHeader " & _
'           "FROM ((DEMANDSPLITRECORDS AS S INNER JOIN DemandRecords AS D ON S.DemandID = D.DemandID) " & _
'                  "INNER JOIN tlbReceipt AS R ON D.DemandID = R.DemandRef) " & _
'                  "INNER JOIN tlbReceiptSplit AS RS ON RS.RptHeader = R.TransactionID " & _
'           "WHERE S.DSR = '" & flxChildDemands.TextMatrix(flxChildDemands.row, 18) & "' AND " & _
'                "(R.Type = 1 OR R.Type = 2) AND RS.SplitID = S.SplitID;"
''Debug.Print szStr
'   adoRst.Open szStr, adoconn, adOpenDynamic, adLockOptimistic
'   szSplitID = adoRst.Fields.Item(0).Value
'   szRptID = adoRst.Fields.Item(1).Value
'   adoRst.Close
'
'   szStr = "UPDATE tlbReceiptSplit SET "
'   If iSelSplitCol = 3 Then _
'      szStr = szStr + "DESCRIPTION = '" & flxChildDemands.TextMatrix(flxChildDemands.row, 3) & "' "
'   If iSelSplitCol = 6 Then _
'      szStr = szStr + "DUEDATE = #" & Format(flxChildDemands.TextMatrix(flxChildDemands.row, 6), "DD MMMM YYYY") & "# "
'   If iSelSplitCol = 7 Then
'      szStr = szStr + "AMOUNT = " & cTotal & ", "
'      szStr = szStr + "OSAMOUNT = " & cTotal & " "
'   End If
'   szStr = szStr + "WHERE TransactionID = '" & szSplitID & "'"
''Debug.Print szStr
'   If iSelSplitCol = 3 Or iSelSplitCol = 6 Or iSelSplitCol = 7 Then _
'      adoconn.Execute szStr
'
'   szStr = "SELECT Sum(Amount) AS Expr1 " & _
'           "From tlbReceiptSplit " & _
'           "Where RptHeader = " & szRptID & " " & _
'           "GROUP BY RptHeader "
''Debug.Print szStr
'   adoRst.Open szStr, adoconn, adOpenDynamic, adLockOptimistic
'   cTotal = adoRst.Fields.Item(0).Value
'   adoRst.Close
'
''     Update Receipt header table
'   adoconn.Execute "UPDATE tlbReceipt AS R " & _
'                   "SET R.Amount = " & cTotal & ", R.OSAmount = " & cTotal & " " & _
'                   "WHERE R.TransactionID = " & szRptID & ";"
'
'   adoconn.Close
'   Set adoRst = Nothing
'   Set adoconn = Nothing
'End Sub

Private Sub txtTenantName_GotFocus()
   If Not cmdDmdTenantLookup.Enabled Then
      frmMMain.stbStatusBar.Panels(1).text = "You will not able to change the lessee, because this an automatic demand."
   End If
End Sub

Private Sub txtTenantName_KeyDown(KeyCode As MSForms.ReturnInteger, Shift As Integer)
    If KeyCode = 13 Then
        cmdDmdTenantLookup.SetFocus
    End If
End Sub

Private Sub txtTenantSearchID_Change()
'old legacy code rem buy anol 20180305 issue 543
''   Dim i As Integer
''
''   If Len(txtTenantSearchID.text) > 0 Then
''      txtTenantSearchName.text = ""
''      txtTenantSearchUnitName.text = ""
''   End If
'''Modified by Anol  10 Jun 2015
''
''    For i = flxLeaseList.Rows - 1 To 1 Step -1
''          flxLeaseList.RowHeight(i) = 240
''          If InStr(1, UCase(flxLeaseList.TextMatrix(i, 1)), UCase(txtTenantSearchID.text), vbTextCompare) = 0 Then
''             flxLeaseList.RowHeight(i) = 0
''          End If
''          If flxLeaseList.RowHeight(i) = 240 Then
''            flxLeaseList.row = i
''          End If
''       Next i
    
       If Len(txtTenantSearchID.text) > 0 Then
          txtTenantSearchName.text = ""
          txtTenantSearchUnitName.text = ""
       End If
       
    FilterTenantList
End Sub
Private Sub FilterTenantList()
        Dim adoConn As New ADODB.Connection
        Dim Filter As String
        Dim tempstr As String
        Dim adoRST As New ADODB.Recordset
        'set original query
        If txtRptClientList.text = "ALL" And txtRptPropertyList.text = "ALL" And Not chkLl.Value Then
      If chkExlessee.Value Then
         szTenantsSQL = "SELECT Tenants.SageAccountNumber, Name, LeaseDetails.UnitNumber,Property.ClientID,Property.PropertyID " & _
                 "From Tenants, LeaseDetails, Units, Property  " & _
                 "WHERE ((Tenants.Comments) IS NULL OR Tenants.Comments='') AND " & _
                 "Units.PropertyID = Property.PropertyID AND " & _
                 "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
                 "Tenants.SageAccountNumber = LeaseDetails.SageAccountNumber " & _
                 "ORDER BY Tenants.SageAccountNumber;"
      Else
         szTenantsSQL = "SELECT Tenants.SageAccountNumber, Name, LeaseDetails.UnitNumber,Property.ClientID,Property.PropertyID  " & _
                 "From Tenants, LeaseDetails, Units, Property  " & _
                 "WHERE ((Tenants.Comments) IS NULL OR Tenants.Comments='') AND " & _
                 "Tenants.SageAccountNumber = LeaseDetails.SageAccountNumber AND " & _
                 "Units.PropertyID = Property.PropertyID AND " & _
                 "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
                 "LeaseDetails.Status = True " & _
                 "ORDER BY Tenants.SageAccountNumber;"
      End If
   End If

   If txtRptClientList.text <> "ALL" And txtRptPropertyList.text = "ALL" And Not chkLl.Value Then
      If chkExlessee.Value Then
         szTenantsSQL = "SELECT Tenants.SageAccountNumber, Name, LeaseDetails.UnitNumber,Property.ClientID,Property.PropertyID " & _
                 "From Tenants, LeaseDetails, Units, Property " & _
                 "WHERE ((Tenants.Comments) IS NULL OR Tenants.Comments='') AND " & _
                  "Tenants.SageAccountNumber = LeaseDetails.SageAccountNumber AND " & _
                  "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
                  "Units.PropertyID = Property.PropertyID AND " & _
                  "Property.ClientID = '" & txtRptClientList.text & "' " & _
                "ORDER BY Tenants.SageAccountNumber;"
      Else
         szTenantsSQL = "SELECT Tenants.SageAccountNumber, Name, LeaseDetails.UnitNumber,Property.ClientID,Property.PropertyID " & _
                 "From Tenants, LeaseDetails, Units, Property " & _
                 "WHERE ((Tenants.Comments) IS NULL OR Tenants.Comments='') AND " & _
                  "Tenants.SageAccountNumber = LeaseDetails.SageAccountNumber AND " & _
                  "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
                  "LeaseDetails.Status = True AND " & _
                  "Units.PropertyID = Property.PropertyID AND " & _
                  "Property.ClientID = '" & txtRptClientList.text & "' " & _
                "ORDER BY Tenants.SageAccountNumber;"
      End If
   End If

   If txtRptClientList.text = "ALL" And txtRptPropertyList.text <> "ALL" And Not chkLl.Value Then
      If chkExlessee.Value Then
         szTenantsSQL = "SELECT Tenants.SageAccountNumber, Name, LeaseDetails.UnitNumber,Property.ClientID,Property.PropertyID " & _
                 "From Tenants, LeaseDetails, Units , Property " & _
                 "WHERE ((Tenants.Comments) IS NULL OR Tenants.Comments='') AND " & _
                 "Tenants.SageAccountNumber = LeaseDetails.SageAccountNumber AND " & _
                 "Units.PropertyID = Property.PropertyID AND " & _
                 "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
                 "Units.PropertyID = '" & txtRptPropertyList.text & "' " & _
                 "ORDER BY Tenants.SageAccountNumber;"
      Else
         szTenantsSQL = "SELECT Tenants.SageAccountNumber, Name, LeaseDetails.UnitNumber,Property.ClientID,Property.PropertyID  " & _
                 "From Tenants, LeaseDetails, Units , Property " & _
                 "WHERE ((Tenants.Comments) IS NULL OR Tenants.Comments='') AND " & _
                 "Tenants.SageAccountNumber = LeaseDetails.SageAccountNumber AND " & _
                 "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
                 "Units.PropertyID = Property.PropertyID AND " & _
                 "LeaseDetails.Status = True AND " & _
                 "Units.PropertyID = '" & txtRptPropertyList.text & "' " & _
                 "ORDER BY Tenants.SageAccountNumber;"
      End If
   End If

   If txtRptClientList.text <> "ALL" And txtRptPropertyList.text <> "ALL" And Not chkLl.Value Then
      If chkExlessee.Value Then
         szTenantsSQL = "SELECT Tenants.SageAccountNumber, Name, LeaseDetails.UnitNumber,Property.ClientID,Property.PropertyID " & _
                 "From Tenants, LeaseDetails, Units, Property " & _
                 "WHERE ((Tenants.Comments) IS NULL OR Tenants.Comments='') AND " & _
                  "Tenants.SageAccountNumber = LeaseDetails.SageAccountNumber AND " & _
                  "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
                  "Units.PropertyID = Property.PropertyID AND " & _
                  "Property.ClientID = '" & txtRptClientList.text & "' AND " & _
                  "Units.PropertyID = '" & txtRptPropertyList.text & "' " & _
                "ORDER BY Tenants.SageAccountNumber;"
      Else
         szTenantsSQL = "SELECT Tenants.SageAccountNumber, Name, LeaseDetails.UnitNumber,Property.ClientID,Property.PropertyID " & _
                 "From Tenants, LeaseDetails, Units, Property " & _
                 "WHERE ((Tenants.Comments) IS NULL OR Tenants.Comments='') AND " & _
                  "Tenants.SageAccountNumber = LeaseDetails.SageAccountNumber AND " & _
                  "LeaseDetails.UnitNumber = Units.UnitNumber AND " & _
                  "LeaseDetails.Status = True AND " & _
                  "Units.PropertyID = Property.PropertyID AND " & _
                  "Property.ClientID = '" & txtRptClientList.text & "' AND " & _
                  "Units.PropertyID = '" & txtRptPropertyList.text & "' " & _
                "ORDER BY Tenants.SageAccountNumber;"
      End If
   End If
        
       If Len(txtTenantSearchID.text) > 0 Then
          tempstr = Replace(UCase(txtTenantSearchID.text), "'", "''")
          Filter = " SageAccountNumber LIKE '%" + tempstr + "*'"
       End If
       
       If Len(txtTenantSearchName.text) > 0 Then
          tempstr = Replace(UCase(txtTenantSearchName.text), "'", "''")
          Filter = " Name LIKE '%" + tempstr + "*'"
       End If
    
       If Len(txtTenantSearchUnitName.text) > 0 Then
          tempstr = Replace(UCase(txtTenantSearchUnitName.text), "'", "''")
          Filter = " UnitNumber LIKE '%" + tempstr + "*'"
       End If
      adoConn.Open getConnectionString
      adoRST.Open szTenantsSQL, adoConn, adOpenStatic, adLockReadOnly
      adoRST.Filter = Filter
      Dim iRow As Integer
      
      ConfigFlxLeaseList
      flxLeaseList.Rows = 2
      iRow = 1
      If tabDmdRcpt.Tab <> 2 Or tabPayment.Tab <> 0 Then
            flxLeaseList.TextMatrix(iRow, 1) = "All Lessees" 'adoRst.Fields.Item(0).Value
            flxLeaseList.TextMatrix(iRow, 2) = "All Lessees" 'adoRst.Fields.Item(1).Value
            flxLeaseList.TextMatrix(iRow, 3) = "" ' adoRst.Fields.Item(2).Value
            iRow = 2
            flxLeaseList.AddItem ""
       End If
      flxLeaseList.Rows = iRow + adoRST.RecordCount
   While Not adoRST.EOF
      flxLeaseList.TextMatrix(iRow, 1) = adoRST.Fields.Item(0).Value
      flxLeaseList.TextMatrix(iRow, 2) = adoRST.Fields.Item(1).Value
      flxLeaseList.TextMatrix(iRow, 3) = adoRST.Fields.Item(2).Value
      If tabDmdRcpt.Tab = 2 And tabPayment.Tab = 0 Then
            flxLeaseList.TextMatrix(iRow, 5) = adoRST.Fields.Item(3).Value
            flxLeaseList.TextMatrix(iRow, 6) = adoRST.Fields.Item(4).Value
      End If
      iRow = iRow + 1
      adoRST.MoveNext

      'If Not adoRst.EOF Then flxLeaseList.AddItem ""
   Wend
   adoRST.Close
   Set adoRST = Nothing
   adoConn.Close
   Set adoConn = Nothing
   UpdateBalance
End Sub
Private Sub txtTenantSearchID_KeyDown(KeyCode As Integer, Shift As Integer)
    If KeyCode = 27 Then
         picLeaseList.Visible = False
         txtTenantSearchID.text = ""
         chkExlessee.Enabled = True
         tabDmdRcpt.Enabled = True
    End If
    If KeyCode = vbKeyDown Then
        flxLeaseList.SetFocus
    End If
End Sub

Private Sub txtTenantSearchID_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
        If Len(txtTenantSearchID.text) > 0 Then
            flxLeaseList.SetFocus
        Else
            txtTenantSearchName.SetFocus
        End If
    End If
End Sub

Private Sub txtTenantSearchName_Change()
''    Dim i As Integer
''
''   If Len(txtTenantSearchName.text) > 0 Then
''      txtTenantSearchID.text = ""
''      txtTenantSearchUnitName.text = ""
''   End If
'''Modified by Anol  10 Jun 2015
''
''        For i = flxLeaseList.Rows - 1 To 1 Step -1
''          flxLeaseList.RowHeight(i) = 240
''          If InStr(1, UCase(flxLeaseList.TextMatrix(i, 2)), UCase(txtTenantSearchName.text), vbTextCompare) = 0 Then
''             flxLeaseList.RowHeight(i) = 0
''          End If
''          If flxLeaseList.RowHeight(i) = 240 Then
''            flxLeaseList.row = i
''          End If
''       Next i
      
       
       If Len(txtTenantSearchName.text) > 0 Then
          txtTenantSearchID.text = ""
          txtTenantSearchUnitName.text = ""
       End If
       
    FilterTenantList
End Sub

Private Sub txtTenantSearchName_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
        txtTenantSearchUnitName.SetFocus
    End If
End Sub

Private Sub txtTenantSearchUnitName_Change()
'   Dim i As Integer
'
'   If Len(txtTenantSearchUnitName.text) > 0 Then
'      txtTenantSearchID.text = ""
'      txtTenantSearchName.text = ""
'   End If
''Modified by Anol 10 Jun 2015
'   For i = 1 To flxLeaseList.Rows - 1
'      flxLeaseList.RowHeight(i) = 0
'      If InStr(UCase(flxLeaseList.TextMatrix(i, 3)), UCase(txtTenantSearchUnitName.text)) > 0 Then
'         flxLeaseList.RowHeight(i) = 240
'      End If
'   Next i
    
       If Len(txtTenantSearchUnitName.text) > 0 Then
          txtTenantSearchID.text = ""
          txtTenantSearchName.text = ""
       End If
    FilterTenantList
End Sub

Private Sub txtDmdTenantSearchID_Change()
   Dim i As Integer

   If Len(txtDmdTenantSearchID.text) > 0 Then
      txtDmdTenantSearchName.text = ""
      txtDmdTenantSearchUnitName.text = ""
   End If

'   For i = 1 To flxDmdLeaseList.Rows - 1
'      flxDmdLeaseList.RowHeight(i) = 240
'      If UCase(Left(flxDmdLeaseList.TextMatrix(i, 1), Len(txtDmdTenantSearchID.text))) <> UCase(txtDmdTenantSearchID.text) Then
'         flxDmdLeaseList.RowHeight(i) = 0
'      End If
'   Next i
    For i = flxDmdLeaseList.Rows - 1 To 1 Step -1
      flxDmdLeaseList.RowHeight(i) = 240
      If InStr(1, UCase(flxDmdLeaseList.TextMatrix(i, 1)), UCase(txtDmdTenantSearchID.text), vbTextCompare) = 0 Then
         flxDmdLeaseList.RowHeight(i) = 0
      End If
      If flxDmdLeaseList.RowHeight(i) = 240 Then
        flxDmdLeaseList.row = i
      End If
   Next i
End Sub

Private Sub txtDmdTenantSearchName_Change()
   Dim i As Integer

   If Len(txtDmdTenantSearchName.text) > 0 Then
      txtDmdTenantSearchID.text = ""
      txtDmdTenantSearchUnitName.text = ""
   End If

'   For i = 1 To flxDmdLeaseList.Rows - 1
'      flxDmdLeaseList.RowHeight(i) = 240
'      If UCase(Left(flxDmdLeaseList.TextMatrix(i, 2), Len(txtDmdTenantSearchName.text))) <> UCase(txtDmdTenantSearchName.text) Then
'         flxDmdLeaseList.RowHeight(i) = 0
'      End If
'   Next i
   For i = flxDmdLeaseList.Rows - 1 To 1 Step -1
      flxDmdLeaseList.RowHeight(i) = 240
      If InStr(1, UCase(flxDmdLeaseList.TextMatrix(i, 2)), UCase(txtDmdTenantSearchName.text)) = 0 Then
         flxDmdLeaseList.RowHeight(i) = 0
      End If
      If flxDmdLeaseList.RowHeight(i) = 240 Then
        flxDmdLeaseList.row = i
      End If
   Next i
End Sub

Private Sub txtDmdTenantSearchUnitName_Change()
   Dim i As Integer

   If Len(txtDmdTenantSearchUnitName.text) > 0 Then
      txtDmdTenantSearchID.text = ""
      txtDmdTenantSearchName.text = ""
   End If

'   For i = 1 To flxDmdLeaseList.Rows - 1
'      flxDmdLeaseList.RowHeight(i) = 240
'      If UCase(Left(flxDmdLeaseList.TextMatrix(i, 3), Len(txtDmdTenantSearchUnitName.text))) <> UCase(txtDmdTenantSearchUnitName.text) Then
'         flxDmdLeaseList.RowHeight(i) = 0
'      End If
'   Next i
   'written by anol 21 July 2015
   For i = flxDmdLeaseList.Rows - 1 To 1 Step -1
      flxDmdLeaseList.RowHeight(i) = 240
      If InStr(1, UCase(flxDmdLeaseList.TextMatrix(i, 3)), UCase(txtDmdTenantSearchUnitName.text)) = 0 Then
         flxDmdLeaseList.RowHeight(i) = 0
      End If
      If flxDmdLeaseList.RowHeight(i) = 240 Then
        flxDmdLeaseList.row = i
      End If
   Next i
   
End Sub

Private Sub txtTotal_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
        If cmdUpdate.Enabled = True Then
            cmdUpdate.SetFocus
        End If
   End If
End Sub

Private Sub txtTotal_LostFocus()
   If Not cmdUpdate.Enabled Then Exit Sub

   cmdUpdate.SetFocus
End Sub

'Private Sub LoadJob(adoConn As ADODB.Connection)
'   Dim rRow As Integer, szSQL As String, Data() As String
'   Dim adoRst As New ADODB.Recordset
'
'   szSQL = "SELECT ID, Job_DiaryName " & _
'           "FROM PropertyMaintHistory " & _
'           "WHERE PropertyID = '" & txtDmdPropertyList.text & "' " & _
'           "ORDER BY ID;"
''Debug.Print szSQL
'
'   adoRst.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
'
'   If Not adoRst.EOF Then
'      ReDim Data(2, adoRst.RecordCount) As String
'      rRow = 0
'      While Not adoRst.EOF
'         Data(0, rRow) = adoRst.Fields.Item("ID").Value
'         Data(1, rRow) = adoRst.Fields.Item("Job_DiaryName").Value
'         rRow = rRow + 1
'         adoRst.MoveNext
'      Wend
'      cboJob.Clear
'      cboJob.Column() = Data()
'   End If
'
'   adoRst.Close
'   Set adoRst = Nothing
'End Sub

'Private Sub LoadDept(adoConn As ADODB.Connection)
'   Dim rRow As Integer, iRec As Integer, Data() As String
'   Dim adoRst As New ADODB.Recordset
'   Dim szSQL As String
'
'   szSQL = "SELECT FundID, FundCode, FundName FROM Fund;"
'
'   adoRst.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
'
'   If adoRst.EOF Then
'      MsgBox "Fund has not been setup for this company.", vbExclamation, "Load Fund in Global"
'   Else
'      ReDim Data(2, adoRst.RecordCount) As String
'
'      rRow = 0
'      While Not adoRst.EOF
'         Data(0, rRow) = adoRst.Fields.Item("FundID").Value
'         Data(1, rRow) = adoRst.Fields.Item("FundCode").Value
'         Data(2, rRow) = adoRst.Fields.Item("FundName").Value
'         rRow = rRow + 1
'         adoRst.MoveNext
'      Wend
'      cboFund.Clear
'      cboFund.Column() = Data()
'   End If
'
'   ' Destroy Objects
'   Set adoRst = Nothing
'   Exit Sub
'
'   ' Error Handling Code
'Error_Handler:
'
'   ' Destroy Objects
'   Set adoRst = Nothing
'End Sub

'Private Sub LoadflxReceiptHistory(adoConn As ADODB.Connection)
'   Dim szSQL As String, i As Integer
'   Dim adoRst As New ADODB.Recordset
'  'Note from Anol 20180221
'  'this is showing only receipts from current lessee
'  '1st clause is showing that are allocated
'  '2nd clause is showing RA and Receipt Refund
'  '3rd caluse is showing receipts that are not allocated
'  '3rd one has a tardy SQL
'
'   szSQL = "SELECT R.SlNumber, R.SageAccountNumber, R.RDate, SUM(RT.ReceiptAmount) AS RAmt, " & _
'               "R.ExtRef as Details, MID(T.CONSTANT, 4, LEN(T.CONSTANT)-3) AS TYPE, N.Name, " & _
'               "Property.PropertyID, R.UnitID, R.BankCode " & _
'           "FROM tlbReceipt AS R, tlbTransactionTypes AS T, Tenants AS N, LeaseDetails AS L, " & _
'               "Units, Property, RptTransactions AS RT " & _
'           "WHERE R.Type = 3 AND R.Type = T.TYPE_ID  AND R.SageAccountNumber = N.SageAccountNumber AND " & _
'               "N.SageAccountNumber  = L.SageAccountNumber AND L.UnitNumber = Units.UnitNumber AND " & _
'               "L.Status = True AND Units.PropertyID = Property.PropertyID  AND RT.FromTran = R.TransactionID " & _
'           "GROUP BY R.SlNumber, R.SageAccountNumber, R.RDate, R.ExtRef, " & _
'               "MID(T.CONSTANT, 4, LEN(T.CONSTANT)-3), N.Name, Property.PropertyID, R.UnitID, R.BankCode"
'   szSQL = szSQL & " UNION "
''   szSQL = ""
'   szSQL = szSQL & _
'           "SELECT R.SlNumber, R.SageAccountNumber, R.RDate, SUM(R.Amount) AS RAmt, " & _
'               "R.ExtRef as Details, MID(T.CONSTANT, 4, LEN(T.CONSTANT)-3) AS TYPE, N.Name, " & _
'               "Property.PropertyID, R.UnitID, R.BankCode " & _
'           "From tlbReceipt AS R, tlbTransactionTypes AS T, Tenants AS N, LeaseDetails AS L, Units, Property " & _
'           "WHERE (R.Type = 4 OR R.Type = 23) AND " & _
'               "R.Type = T.TYPE_ID  AND R.SageAccountNumber = N.SageAccountNumber AND " & _
'               "N.SageAccountNumber  = L.SageAccountNumber AND L.UnitNumber = Units.UnitNumber AND " & _
'               "L.Status = True AND Units.PropertyID = Property.PropertyID " & _
'           "GROUP BY R.SlNumber, R.SageAccountNumber, R.RDate, " & _
'               "R.ExtRef, MID(T.CONSTANT, 4, LEN(T.CONSTANT)-3), N.Name, " & _
'               "Property.PropertyID, R.UnitID, R.BankCode"
'   szSQL = szSQL & " UNION "
'   szSQL = szSQL & _
'           "SELECT R.SlNumber, R.SageAccountNumber, R.RDate, SUM(R.Amount) AS RAmt, " & _
'               "R.ExtRef as Details, MID(T.CONSTANT, 4, LEN(T.CONSTANT)-3) AS TYPE, N.Name, " & _
'               "Property.PropertyID, R.UnitID, R.BankCode " & _
'           "From tlbReceipt AS R, tlbTransactionTypes AS T, Tenants AS N, LeaseDetails AS L, Units, Property " & _
'           "WHERE R.Type = 3 AND " & _
'               "R.Type = T.TYPE_ID  AND R.SageAccountNumber = N.SageAccountNumber AND " & _
'               "N.SageAccountNumber  = L.SageAccountNumber AND L.UnitNumber = Units.UnitNumber AND " & _
'               "L.Status = True AND Units.PropertyID = Property.PropertyID AND R.TransactionID NOT IN (" & _
'                  "SELECT FromTran FROM RptTransactions) " & _
'           "GROUP BY R.SlNumber, R.SageAccountNumber, R.RDate, " & _
'               "R.ExtRef, MID(T.CONSTANT, 4, LEN(T.CONSTANT)-3), N.Name, " & _
'               "Property.PropertyID, R.UnitID, R.BankCode " & _
'           "ORDER BY TYPE, R.SlNumber;"
'
''Debug.Print szSQL
'   adoRst.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
'
'   i = 1
'   While Not adoRst.EOF
'      flxReceiptHistory.TextMatrix(i, 0) = adoRst!Type & adoRst!SlNumber
'      flxReceiptHistory.TextMatrix(i, 1) = adoRst!Type
'      flxReceiptHistory.TextMatrix(i, 2) = adoRst!RDate
'      flxReceiptHistory.TextMatrix(i, 3) = adoRst!BankCode
'      flxReceiptHistory.TextMatrix(i, 4) = adoRst!SageAccountNumber
'      flxReceiptHistory.TextMatrix(i, 5) = adoRst!propertyID
'      flxReceiptHistory.TextMatrix(i, 6) = IIf(IsNull(adoRst!unitid), "", adoRst!unitid)
'      flxReceiptHistory.TextMatrix(i, 7) = adoRst!Details
'      flxReceiptHistory.TextMatrix(i, 8) = Format(adoRst!RAmt, "0.00")
'
'      If Not adoRst.EOF Then flxReceiptHistory.AddItem ""
'      adoRst.MoveNext
'      i = i + 1
'   Wend
'
'   adoRst.Close
'   Set adoRst = Nothing
' End Sub

' Private Sub RptHistoryRefresh()
'   If flxReceiptHistory.Rows = 2 And flxReceiptHistory.TextMatrix(1, 0) = "" Then Exit Sub
'
'   Dim i As Integer, szTemp() As String, szTenantName As String
'
'   If txtTenantID1.text = "All Lessees" Then
'      szTenantName = txtTenantID1.text
'   Else
'      szTemp = Split(txtTenantID1.text, " \ ")
'      szTenantName = szTemp(1)
'   End If
'
''MsgBox flxReceiptHistory.RowHeight(1)
'   For i = 1 To flxReceiptHistory.Rows - 1
'      flxReceiptHistory.RowHeight(i) = 240
'   Next i
'
'   For i = 1 To flxReceiptHistory.Rows - 2
'   'modified by anol 08 Jan 2016
''      If Val(flxReceiptHistory.TextMatrix(i, 0)) < Val(txtRptIDFrom.text) Or _
''         Val(flxReceiptHistory.TextMatrix(i, 0)) > Val(txtRptIDTo.text) Or _
''         (IIf(szTenantName = "All Lessees", False, True) And flxReceiptHistory.TextMatrix(i, 3) <> szTenantName) Or _
''         CDate(flxReceiptHistory.TextMatrix(i, 5)) < CDate(txtDateFrom1.text) Or _
''         CDate(flxReceiptHistory.TextMatrix(i, 5)) > CDate(txtDateTo1.text) Or _
''         (IIf(cboRptClientList1.text = "All Clients", False, True) And flxReceiptHistory.TextMatrix(i, 10) <> txtRptClientList1.text) Or _
''         (IIf(cboRptPropertyList1.text = "All Properties", False, True) And flxReceiptHistory.TextMatrix(i, 11) <> txtRptPropertyList1.text) Then
' If Val(flxReceiptHistory.TextMatrix(i, 0)) < Val(txtRptIDFrom.text) Or _
'         Val(flxReceiptHistory.TextMatrix(i, 0)) > Val(txtRptIDTo.text) Or _
'         (IIf(szTenantName = "All Lessees", False, True) And flxReceiptHistory.TextMatrix(i, 3) <> szTenantName) Or _
'         CDate(flxReceiptHistory.TextMatrix(i, 5)) < CDate(txtDateFrom1.text) Or _
'         CDate(flxReceiptHistory.TextMatrix(i, 5)) > CDate(txtDateTo1.text) Or _
'         (IIf(txtRptClientList1.text = "ALL", False, True) And flxReceiptHistory.TextMatrix(i, 10) <> txtRptClientList1.text) Or _
'         (IIf(txtRptPropertyList1.text = "ALL", False, True) And flxReceiptHistory.TextMatrix(i, 11) <> txtRptPropertyList1.text) Then
'         flxReceiptHistory.RowHeight(i) = 0
'      End If
'   Next i
'End Sub
'
'Private Sub cmdGADSelDemandTypes_Click()
'   Me.Enabled = False
'
'   Load frmDemandTypesSel
'   frmDemandTypesSel.szCallingFrom = "Automatic Demand"
'   frmDemandTypesSel.Show
'End Sub

Public Sub ConfigFlxReceiptHistory()
   'Resolved by BOSL
   'Issue 440
   'modified by by Anol 11 Aug 2014
   Dim szHeader As String, i As Integer

   flxReceiptHistory.Clear
   flxReceiptHistory.Cols = 19 ' was 8 prevously O have added 7
   flxReceiptHistory.Rows = 2

   szHeader$ = "<Demand No|<Date|<Bank Code|<Lessee A/C|<PropID|<UnitID|<Ref|>Amount "
   flxReceiptHistory.FormatString = szHeader$
   flxReceiptHistory.ColWidth(0) = 0
   flxReceiptHistory.ColWidth(1) = 250
   flxReceiptHistory.ColWidth(2) = 1000
   For i = 1 To 7
      flxReceiptHistory.ColWidth(i + 1) = Label1(27 + i).Left - Label1(26 + i).Left
   Next i
   flxReceiptHistory.ColAlignment(7) = vbLeftJustify
   flxReceiptHistory.ColAlignment(8) = vbLeftJustify
   flxReceiptHistory.ColAlignment(9) = vbLeftJustify
   flxReceiptHistory.ColWidth(10) = 0
   flxReceiptHistory.ColWidth(11) = 0
   flxReceiptHistory.ColWidth(12) = 0
   flxReceiptHistory.ColWidth(13) = 0
   flxReceiptHistory.ColWidth(14) = 0 'transaction ID
   flxReceiptHistory.ColWidth(15) = 0 ' reconnow
   flxReceiptHistory.ColWidth(16) = 0
   flxReceiptHistory.ColWidth(17) = 0 '
   flxReceiptHistory.ColWidth(18) = 1200 ' OS Amount
    'Resolved by BOSL
    '0000452: Lessee receipts history
     'note 940 The amount field in the grid is not displaying the amount. It is in fact blank. The amount of the receipt should be shown in the amount column.
    'Modified by Anol 20 apr 2015
    'flxReceiptHistory.ColWidth(i - 1) = flxReceiptHistory.Left + flxReceiptHistory.Width - Label1(25 + i).Left - 300
   flxReceiptHistory.RowHeight(0) = 0
End Sub

Public Sub TestingCommand()
   cmdBatchDemands_Click
   frmBatchDemands.TestingCommand
End Sub

' Here you can add scrolling support to controls that don't normally respond.
' This Sub could always be moved to a module to make scrollwheel behaviour
' generic across forms.
' ===========================================================================
Public Sub MouseWheel(ByVal MouseKeys As Long, ByVal Rotation As Long, ByVal Xpos As Long, ByVal Ypos As Long)
  Dim ctl As Control
  Dim bHandled As Boolean
  Dim bOver As Boolean

  For Each ctl In Controls
    ' Is the mouse over the control
    On Error Resume Next
    bOver = (ctl.Visible And IsOver(ctl.hWnd, Xpos, Ypos))
    On Error GoTo 0

    If bOver Then
      ' If so, respond accordingly
      bHandled = True
      Select Case True

        Case TypeOf ctl Is MSHFlexGrid
          FlexGridScroll ctl, MouseKeys, Rotation, Xpos, Ypos

        '        Case TypeOf ctl Is PictureBox
'          PictureBoxZoom ctl, MouseKeys, Rotation, Xpos, Ypos
            'Mouse wheel was not responding on picturebox
            'this problem fixed by anol 23 Mar 2016
            Case TypeOf ctl Is PictureBox
'                        If Not ctl Is picClient Then
'                            PictureBoxZoom ctl, MouseKeys, Rotation, Xpos, Ypos
'                        Else
                            bHandled = False
'                        End If

        Case TypeOf ctl Is ListBox, TypeOf ctl Is TextBox, TypeOf ctl Is ComboBox
          ' These controls already handle the mousewheel themselves, so allow them to:
          If ctl.Enabled Then ctl.SetFocus

        Case Else
          bHandled = False

      End Select
      If bHandled Then Exit Sub
    End If
    bOver = False
  Next ctl
'
'  ' Scroll was not handled by any controls, so treat as a general message send to the form
'  Me.Caption = "Form Scroll " & IIf(Rotation < 0, "Down", "Up")
End Sub


Private Sub txtVAT_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
        If cmdUpdate.Enabled = True Then
            cmdUpdate.SetFocus
        End If
   End If
End Sub

Private Sub txtVAT_LostFocus()
    'Resolved by BOSL
    'Issue 463 : Manually Typing in the VAT Value
    'newly create this event by anol 20 Aug 2014
    txtVAT.text = Format(Val(txtVAT.text), "0.00")
    txtTotal.text = Val(txtVAT.text) + Val(txtAmount.text)
    txtTotal.text = Format(txtTotal.text, "0.00")
End Sub
Private Sub txtSearchClientID_Change()
    'Updated by anol 22 Dec 2015
   Dim i As Integer
   Dim rRow As Integer
   Dim adoConn As New ADODB.Connection
   Dim rstRec As New ADODB.Recordset
   Dim tempstr As String
   If Len(txtSearchClientID.text) > 0 Then
        txtSearchClientName.text = ""
   End If
    If strCommandSource = "15" Then
        filterUnitList
        Exit Sub
   End If
   If strCommandSource = "16" Then
          adoConn.Open getConnectionString
          ' command was not set errot coming here' I have added the following clause to resolve that. anol 20230806
          If szTenantsSQL2 = "" Then
            LoadLesseeList
          End If
          rstRec.Open szTenantsSQL2, adoConn, adOpenKeyset, adLockReadOnly
          If txtSearchClientID.text <> "" Then
                tempstr = Replace(UCase(txtSearchClientID.text), "'", "''")
                rstRec.Filter = " SageAccountNumber LIKE '%" + tempstr + "*'"
          End If
          If txtSearchClientName.text <> "" Then
                tempstr = Replace(UCase(txtSearchClientName.text), "'", "''")
                rstRec.Filter = " CompanyName LIKE '%" + tempstr + "*'"
          End If
          
           flxClient.TextMatrix(1, 0) = "ALL"
           flxClient.TextMatrix(1, 1) = "All Lessee"
           flxClient.AddItem ""
           rRow = 2
           flxClient.Rows = rstRec.RecordCount + 2
        While Not rstRec.EOF
           flxClient.row = 1
           flxClient.RowSel = 1
           flxClient.ColSel = 1
           flxClient.TextMatrix(rRow, 0) = rstRec.Fields("SageAccountNumber").Value
           flxClient.TextMatrix(rRow, 1) = rstRec.Fields.Item("CompanyName").Value
           flxClient.RowHeight(rRow) = 280
           rstRec.MoveNext
           'If Not rstRec.EOF Then flxClient.AddItem ""
           rRow = rRow + 1
        Wend
        rstRec.Close
        adoConn.Close
        
        Exit Sub
   End If
   If strCommandSource = "17" Then
        filterUnitListHist
        Exit Sub
   End If
   If strCommandSource = "18" Then
          adoConn.Open getConnectionString
          rstRec.Open szTenantsSQL2, adoConn, adOpenKeyset, adLockReadOnly
          If txtSearchClientID.text <> "" Then
                tempstr = Replace(UCase(txtSearchClientID.text), "'", "''")
                rstRec.Filter = " SageAccountNumber LIKE '%" + tempstr + "*'"
          End If
          If txtSearchClientName.text <> "" Then
                tempstr = Replace(UCase(txtSearchClientName.text), "'", "''")
                rstRec.Filter = " CompanyName LIKE '%" + tempstr + "*'"
          End If
          
           flxClient.TextMatrix(1, 0) = "ALL"
           flxClient.TextMatrix(1, 1) = "All Lessee"
           flxClient.AddItem ""
           rRow = 2
           flxClient.Rows = rstRec.RecordCount + 2
        While Not rstRec.EOF
           flxClient.row = 1
           flxClient.RowSel = 1
           flxClient.ColSel = 1
           flxClient.TextMatrix(rRow, 0) = rstRec.Fields("SageAccountNumber").Value
           flxClient.TextMatrix(rRow, 1) = rstRec.Fields.Item("CompanyName").Value
           flxClient.RowHeight(rRow) = 280
           rstRec.MoveNext
           'If Not rstRec.EOF Then flxClient.AddItem ""
           rRow = rRow + 1
        Wend
        rstRec.Close
        adoConn.Close
        
        Exit Sub
   End If
   For i = flxClient.Rows - 1 To 1 Step -1
      flxClient.RowHeight(i) = 240
      If strCommandSource = "11" Then
           If InStr(1, UCase(flxClient.TextMatrix(i, 2)), UCase(txtSearchClientID.text), vbTextCompare) = 0 Then
                  flxClient.RowHeight(i) = 0
            End If

       ElseIf strCommandSource = "12" Or strCommandSource = "13" Or strCommandSource = "14" Or strCommandSource = "19" Or strCommandSource = "20" Then
            If InStr(1, UCase(flxClient.TextMatrix(i, 1)), UCase(txtSearchClientID.text), vbTextCompare) = 0 Then
                  flxClient.RowHeight(i) = 0
            End If
       Else
            If InStr(1, UCase(flxClient.TextMatrix(i, 0)), UCase(txtSearchClientID.text), vbTextCompare) = 0 Then
                flxClient.RowHeight(i) = 0
            End If
       End If
      If flxClient.RowHeight(i) = 240 Then
            flxClient.row = i
      End If
   Next i
End Sub

Private Sub txtSearchClientID_KeyDown(KeyCode As MSForms.ReturnInteger, Shift As Integer)
     If KeyCode = vbKeyDown Then
        flxClient.SetFocus
     End If
    If KeyCode = 13 Then
            If strCommandSource = "11" Or strCommandSource = "14" Then
                flxClient.SetFocus
'                flxClient.row = 1
'                flxClient.RowSel = 1
'                flxClient.ColSel = 1
'                flxClient.CellBackColor = RGB(174, 179, 233)
                
'                Dim iRow As Integer
'                flxClient.row = 1
'                For iRow = 1 To flxClient.Cols - 1
'                   flxClient.col = iRow
'                   flxClient.CellBackColor = RGB(174, 179, 233)
'                Next iRow
               ' SelectOnly1RowFlxGrid flxClient, 1 'flxClient.row
            ElseIf Len(txtSearchClientID) > 0 Then
                flxClient.SetFocus
            Else
                txtSearchClientName.SetFocus
            End If
    End If
End Sub

Private Sub txtSearchClientID_KeyPress(KeyAscii As MSForms.ReturnInteger)
'    If KeyAscii = 13 Then
'         txtSearchClientName.SetFocus
'    End If
'    If KeyAscii = 27 Then
'          flxClient.Clear
'          flxClient.Cols = 2
'          flxClient.Rows = 2
'          picClient.Visible = False
'          tabDmdRcpt.Enabled = True
'          If strCommandSource = "1" Then
'                cmdDmdClientList.SetFocus
'          ElseIf strCommandSource = "2" Then
'                cmdDmdPropertyList.SetFocus
'          End If
'    End If
    If KeyAscii = 27 Then
         picClient.Visible = False
         tabDmdRcpt.Enabled = True
         If strCommandSource = "1" Then
             cmdDmdClientList.SetFocus
         ElseIf strCommandSource = "2" Then
            cmdDmdPropertyList.SetFocus
         ElseIf strCommandSource = "3" Then
            cmdDmdTenantLookup.SetFocus
         ElseIf strCommandSource = "4" Then
            cmdClientFilterMainList(1).SetFocus
         ElseIf strCommandSource = "5" Then
            cmdClientHistory.SetFocus
         ElseIf strCommandSource = "6" Then
            cmdPropertyHistory.SetFocus
         ElseIf strCommandSource = "7" Then
            cmdRptClientList.SetFocus
         ElseIf strCommandSource = "8" Then
            cmdPropertyHistory.SetFocus
         ElseIf strCommandSource = "9" Then
             cmdRptClientList1.SetFocus
         ElseIf strCommandSource = "10" Then
            cmdRptPropertyList1.SetFocus
         ElseIf strCommandSource = "11" Then
            cmdType.SetFocus
         ElseIf strCommandSource = "12" Then
                cmdFund.SetFocus
         ElseIf strCommandSource = "13" Then
               cmdJob.SetFocus
          ElseIf strCommandSource = "14" Then
               cmdVATCode.SetFocus
         End If
    End If
End Sub

Private Sub txtSearchClientName_Change()
   'Updated by anol 10 Dec 2015
   Dim i As Integer
   Dim rRow As Integer
   Dim adoConn As New ADODB.Connection
   Dim rstRec As New ADODB.Recordset
   Dim tempstr As String
   If Len(txtSearchClientName.text) > 0 Then
        txtSearchClientID.text = ""
   End If
   If strCommandSource = "15" Then
        filterUnitList
        Exit Sub
   End If
   If strCommandSource = "16" Or strCommandSource = "18" Then
          adoConn.Open getConnectionString
          If szTenantsSQL2 = "" Then
            LoadLesseeList
          End If
          rstRec.Open szTenantsSQL2, adoConn, adOpenKeyset, adLockReadOnly
          If txtSearchClientID.text <> "" Then
                tempstr = Replace(UCase(txtSearchClientID.text), "'", "''")
                rstRec.Filter = " SageAccountNumber LIKE '%" + tempstr + "*'"
          End If
          If txtSearchClientName.text <> "" Then
                tempstr = Replace(UCase(txtSearchClientName.text), "'", "''")
                rstRec.Filter = " CompanyName LIKE '%" + tempstr + "*'"
          End If
          
           flxClient.TextMatrix(1, 0) = "ALL"
           flxClient.TextMatrix(1, 1) = "All Lessee"
           flxClient.AddItem ""
           rRow = 2
           flxClient.Rows = rstRec.RecordCount + 2
        While Not rstRec.EOF
           flxClient.row = 1
           flxClient.RowSel = 1
           flxClient.ColSel = 1
           flxClient.TextMatrix(rRow, 0) = rstRec.Fields("SageAccountNumber").Value
           flxClient.TextMatrix(rRow, 1) = rstRec.Fields.Item("CompanyName").Value
           flxClient.RowHeight(rRow) = 280
           rstRec.MoveNext
           'If Not rstRec.EOF Then flxClient.AddItem ""
           rRow = rRow + 1
        Wend
        rstRec.Close
        adoConn.Close
        Exit Sub
   End If
   For i = flxClient.Rows - 1 To 1 Step -1
      flxClient.RowHeight(i) = 240
       If strCommandSource = "13" Or strCommandSource = "12" Or strCommandSource = "19" Or strCommandSource = "20" Then
             If InStr(1, UCase(flxClient.TextMatrix(i, 2)), UCase(txtSearchClientName.text), vbTextCompare) = 0 Then
                    flxClient.RowHeight(i) = 0
             End If
       
       Else
            If InStr(1, UCase(flxClient.TextMatrix(i, 1)), UCase(txtSearchClientName.text), vbTextCompare) = 0 Then
                  flxClient.RowHeight(i) = 0
            End If
      End If
      If flxClient.RowHeight(i) = 240 Then
            flxClient.row = i
      End If
   Next i
End Sub

Private Sub txtSearchClientName_KeyDown(KeyCode As MSForms.ReturnInteger, Shift As Integer)
     If KeyCode = 13 Then
         flxClient.SetFocus
    End If
    If KeyCode = vbKeyDown Then
        If flxClient.Visible Then
            flxClient.SetFocus
        End If
    End If
End Sub

Private Sub txtSearchClientName_KeyPress(KeyAscii As MSForms.ReturnInteger)
'    If KeyAscii = 13 Then
'         flxClient.SetFocus
'    End If
    If KeyAscii = 27 Then
         picClient.Visible = False
         tabDmdRcpt.Enabled = True
         If strCommandSource = "1" Then
             cmdDmdClientList.SetFocus
         ElseIf strCommandSource = "2" Then
            cmdDmdPropertyList.SetFocus
         ElseIf strCommandSource = "3" Then
            cmdDmdTenantLookup.SetFocus
         ElseIf strCommandSource = "4" Then
            cmdClientFilterMainList(1).SetFocus
         ElseIf strCommandSource = "5" Then
            cmdClientHistory.SetFocus
         ElseIf strCommandSource = "6" Then
            cmdPropertyHistory.SetFocus
         ElseIf strCommandSource = "7" Then
            cmdRptClientList.SetFocus
         ElseIf strCommandSource = "8" Then
            cmdPropertyHistory.SetFocus
         ElseIf strCommandSource = "9" Then
             cmdRptClientList1.SetFocus
         ElseIf strCommandSource = "10" Then
            cmdRptPropertyList1.SetFocus
         ElseIf strCommandSource = "11" Then
            cmdType.SetFocus
         ElseIf strCommandSource = "12" Then
                cmdFund.SetFocus
         ElseIf strCommandSource = "13" Then
               cmdJob.SetFocus
          ElseIf strCommandSource = "14" Then
               cmdVATCode.SetFocus
         End If
    End If
End Sub
Private Sub cmdPicCLose_Click()
    picClient.Visible = False
    tabDmdRcpt.Enabled = True
    If strCommandSource = "1" Then
        cmdDmdClientList.SetFocus
    ElseIf strCommandSource = "2" Then
         cmdDmdPropertyList.SetFocus
    ElseIf strCommandSource = "3" Then
        cmdClientFilterMainList(0).SetFocus
    ElseIf strCommandSource = "4" Then
        cmdClientFilterMainList(1).SetFocus
    End If
End Sub
Private Sub flxClient_Click()
        tabDmdRcpt.Enabled = True
       'variable for case 3Dim adoConn As New ADODB.Connection
        Dim adoRST As New ADODB.Recordset
        Dim rstRec As New ADODB.Recordset
        Dim szSQL As String
        Dim TotalRow As Integer, TotalCol As Integer, i As Integer, j As Integer
        Dim adoConn As New ADODB.Connection
        '**********************************
    
    If strCommandSource = "1" Then
        txtDmdClientList.text = flxClient.TextMatrix(flxClient.row, 0)
        txtDmdClientList.Tag = flxClient.TextMatrix(flxClient.row, 0)
        'displayPropertyAgainstClient
        cmdDmdPropertyList.SetFocus
        txtDmdClientList.ForeColor = vbBlack
        Dim strTemp As String
        strTemp = isControlAccountSet(txtDmdClientList.Tag)
        If Len(strTemp) > 0 Then
            MsgBox "No Nominal Account Codes have been setup in the Control Accounts for the Client: " & strTemp & vbNewLine & "Please setup the Control Accounts in Tools > Configuration > Control Accounts"
            strTemp = ""
            picClient.Visible = False
            txtDmdClientList.ForeColor = vbRed
            Exit Sub
        End If
        
    ElseIf strCommandSource = "2" Then
        txtDmdPropertyList.text = flxClient.TextMatrix(flxClient.row, 0)
        adoConn.Open getConnectionString
        vatOptionEnabled = LoadVatOption(adoConn)
        
        szSQL = "SELECT P.PropertyID, P.PropertyName,G.VATRate,V.VAT_Rate as RateValue,V.VAT_CODE as VAT_CODE1,G.VATRate  as  Rate,G.vatOptionEnabled " & _
                            " from ((Property P INNER JOIN globalData G ON P.PropertyID=G.PropertyID) LEFT JOIN tlbVatCode V ON G.VATRate=V.VAT_ID) " & _
                            "WHERE P.PropertyID = '" & txtDmdPropertyList.text & "' " & _
                            "ORDER BY P.PropertyID;"
       rstRec.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
           
        If vatOptionEnabled = True Then
            Label1(24).Caption = IIf(IsNull(rstRec.Fields("VAT_CODE1").Value), "", rstRec.Fields("VAT_CODE1").Value) 'Vat_Code
            Label1(24).Tag = IIf(IsNull(rstRec.Fields("Rate").Value), "", rstRec.Fields("Rate").Value) 'VAT_ID
            nTaxCode = Val(IIf(IsNull(rstRec.Fields("RateValue").Value), "0", rstRec.Fields("RateValue").Value))
            txtVAT.text = Format(Val(txtAmount.text) * (Val(IIf(IsNull(rstRec.Fields("RateValue").Value), "0", rstRec.Fields("RateValue").Value)) / 100), "0.00")
            cmdVATCode.Enabled = True
            txtVAT.Enabled = True
        Else
            txtVAT.text = "0.00"
            Label1(24).Tag = ""
            Label1(24).Caption = ""
            cmdVATCode.Enabled = False
            txtVAT.Enabled = False
        End If
        txtTotal.text = Format(Val(txtAmount.text) + Val(txtVAT.text), "0.00")
        rstRec.Close
        Set rstRec = Nothing
        adoConn.Close
        Set adoConn = Nothing
        If txtAmount.text = "" Then 'you need not clear the tag of tax code
            txtVAT.text = ""
            txtTotal.text = ""
        End If
        
'        If vatOptionEnabled = True Then
'            Label1(24).Caption = flxClient.TextMatrix(flxClient.row, 1)
'            Label1(24).Tag = flxClient.TextMatrix(flxClient.row, 0)
'            txtVAT.text = Format(Val(txtAmount.text) * (Val(flxClient.TextMatrix(flxClient.row, 2)) / 100), "0.00")
'        Else
'            txtVAT.text = "0.00"
'        End If
'        txtTotal.text = Format(Val(txtAmount.text) + Val(txtVAT.text), "0.00")
        
        cmdDmdTenantLookup.SetFocus
    ElseIf strCommandSource = "3" Then 'when you are clicking a client
        txtClientList.text = flxClient.TextMatrix(flxClient.row, 0)
        txtPropertyList.text = "ALL"
        txtPropertyList.Tag = "ALL"
        txtUnitlist.text = "ALL"
        txtUnitlist.Tag = "ALL"
        txtlesselist.text = "ALL"
        txtlesselist.Tag = "ALL"
        adoConn.Open getConnectionString
        'LoadFlxGrid flxDemands, False, adoConn, ""
        LoadFlxDemands adoConn, ""
        If chkSelectAllDemands.Value Then chkSelectAllDemands.Value = 0
        flxDemands.row = 0
        flxDemands.col = 0
        adoConn.Close
        Set adoConn = Nothing
        flxDemands.SetFocus
    ElseIf strCommandSource = "4" Then  'when you are clicking a property
        txtPropertyList.text = flxClient.TextMatrix(flxClient.row, 0)
        txtUnitlist.text = "ALL"
        txtUnitlist.Tag = "ALL"
        txtlesselist.text = "ALL"
        txtlesselist.Tag = "ALL"
        cmdClientFilterMainList(1).SetFocus
        adoConn.Open getConnectionString
        'LoadFlxGrid flxDemands, False, adoConn, ""
        LoadFlxDemands adoConn, ""
        If chkSelectAllDemands.Value Then chkSelectAllDemands.Value = 0
        flxDemands.row = 0
        flxDemands.col = 0
        adoConn.Close
        Set adoConn = Nothing
           
           
    ElseIf strCommandSource = "5" Then ''Client History click
        txtClientHistory.text = flxClient.TextMatrix(flxClient.row, 0)
        txtPropertyHistory.text = "ALL"
        txtUnitListHist.Tag = "ALL"
        txtUnitListHist.text = "ALL"
        txtLesseeListHist.text = "ALL"
        txtLesseeListHist.Tag = "ALL"
        adoConn.Open getConnectionString
        LoadFlxGrid flxDemandHistory, True, adoConn, ""
        flxDemandHistory.row = 0
        flxDemandHistory.col = 0
        ConfigFlxGrid flxChildDemandHistory
        adoConn.Close
        Set adoConn = Nothing
        cmdClientHistory.SetFocus
        
    ElseIf strCommandSource = "6" Then 'property History click
        txtPropertyHistory.text = flxClient.TextMatrix(flxClient.row, 0)
        txtUnitListHist.Tag = "ALL"
        txtUnitListHist.text = "ALL"
        txtLesseeListHist.text = "ALL"
        txtLesseeListHist.Tag = "ALL"
        adoConn.Open getConnectionString
        LoadFlxGrid flxDemandHistory, True, adoConn, ""
        flxDemandHistory.row = 0
        flxDemandHistory.col = 0
        adoConn.Close
        Set adoConn = Nothing
        ConfigFlxGrid flxChildDemandHistory
        cmdPropertyHistory.SetFocus
    ElseIf strCommandSource = "7" Then
       txtBankAc.text = ""
       txtBankCode.text = ""
        txtRptClientList.text = flxClient.TextMatrix(flxClient.row, 0)
        txtRptClientList.ForeColor = vbBlack
        
        strTemp = isControlAccountSet(txtRptClientList.text)
        If Len(strTemp) > 0 And txtRptClientList.text <> "ALL" Then
            MsgBox "No Nominal Account Codes have been setup in the Control Accounts for the Client: " & strTemp & vbNewLine & "Please setup the Control Accounts in Tools > Configuration > Control Accounts"
            strTemp = ""
            picClient.Visible = False
            txtRptClientList.ForeColor = vbRed
            Exit Sub
        End If
        adoConn.Open getConnectionString
        Call LoadDefaultBankAC(adoConn) 'when you select a client it is loading a deafult Bank AC
        adoConn.Close
        Set adoConn = Nothing
        txtReceiptReference.text = ""
        txtRcptAmtType.text = ""
        txtRcptAmtType.Tag = ""
        txtSPaymentTotal.text = "0.00"
       ' Call txtRptClientList_Change_Made
        txtRptPropertyList.text = "ALL"
        flxSPayment.Clear
        flxSPayment.Rows = 2
        flxCrPoA.Clear
        flxCrPoA.Rows = 2
        FocusControl cmdRptPropertyList
'        cmbBankAc.Clear
    ElseIf strCommandSource = "8" Then
        txtRptPropertyList.text = flxClient.TextMatrix(flxClient.row, 0)
        'cmbBankAc.SetFocus
        cmdTenantLookup.SetFocus
    ElseIf strCommandSource = "9" Then
        txtRptClientList1.text = flxClient.TextMatrix(flxClient.row, 0)
        'Call txtRptClientList1_Change_made
        txtRptPropertyList1.text = "ALL"
        adoConn.Open getConnectionString
        loadflxReceiptHistory adoConn, ""
        
        cmdRptPropertyList1.SetFocus
   
    ElseIf strCommandSource = "10" Then
        txtRptPropertyList1.text = flxClient.TextMatrix(flxClient.row, 0)
        adoConn.Open getConnectionString
        loadflxReceiptHistory adoConn, ""
        cmdReceiptTenantLookup.SetFocus
    ElseIf strCommandSource = "11" Then
        If isdemandSameBank(flxClient.TextMatrix(flxClient.row, 1)) = True Then
             txtType.text = flxClient.TextMatrix(flxClient.row, 2)
             txtType.Tag = flxClient.TextMatrix(flxClient.row, 1)
        End If
        cmdFund.SetFocus
    ElseIf strCommandSource = "12" Then 'Fund
        txtFund.text = flxClient.TextMatrix(flxClient.row, 2) 'Fund Name
        txtFund.Tag = Val(flxClient.TextMatrix(flxClient.row, 0)) 'FundID
        strSelectedFundCode = flxClient.TextMatrix(flxClient.row, 1) 'FundCode
        
        
        
        If txtAddNewDescription.Enabled Then
            txtAddNewDescription.SetFocus
        End If
    ElseIf strCommandSource = "13" Then
        txtJob.text = flxClient.TextMatrix(flxClient.row, 1)
        txtJob.Tag = flxClient.TextMatrix(flxClient.row, 0)
        txtAmount.SetFocus
    ElseIf strCommandSource = "14" Then
'        adoconn.Open getConnectionString
'        vatOptionEnabled = LoadVatOption(adoconn)
'
'        szSQL = "SELECT P.PropertyID, P.PropertyName,G.VATRate,V.VAT_Rate as RateValue,V.VAT_CODE as VAT_CODE1,G.VATRate  as  Rate,G.vatOptionEnabled " & _
'                            " from ((Property P INNER JOIN globalData G ON P.PropertyID=G.PropertyID) LEFT JOIN tlbVatCode V ON G.VATRate=V.VAT_ID) " & _
'                            "WHERE P.PropertyID = '" & txtDmdPropertyList.text & "' " & _
'                            "ORDER BY P.PropertyID;"
'       rstRec.Open szSQL, adoconn, adOpenStatic, adLockReadOnly
'
'        If vatOptionEnabled = True Then
'            Label1(24).Caption = IIf(IsNull(rstRec.Fields("VAT_CODE1").Value), "", rstRec.Fields("VAT_CODE1").Value)
'            Label1(24).Tag = IIf(IsNull(rstRec.Fields("Rate").Value), "", rstRec.Fields("Rate").Value) 'VAT_ID
'            txtVAT.text = Format(Val(txtAmount.text) * (Val(IIf(IsNull(rstRec.Fields("RateValue").Value), "0", rstRec.Fields("RateValue").Value)) / 100), "0.00")
'            cmdVATCode.Enabled = True
'            txtVAT.Enabled = True
'        Else
'            txtVAT.text = "0.00"
'            cmdVATCode.Enabled = False
'            txtVAT.Enabled = False
'        End If
'        txtTotal.text = Format(Val(txtAmount.text) + Val(txtVAT.text), "0.00")
'        rstRec.Close
'        Set rstRec = Nothing
'         adoconn.Close
'        Set adoconn = Nothing
        Label1(24).Caption = flxClient.TextMatrix(flxClient.row, 1)
        Label1(24).Tag = Replace(flxClient.TextMatrix(flxClient.row, 1), "T", "")
        txtVAT.text = Format(Val(txtAmount.text) * (Val(flxClient.TextMatrix(flxClient.row, 2)) / 100), "0.00")
        txtTotal.text = Format(Val(txtAmount.text) + Val(txtVAT.text), "0.00")
        txtVAT.Enabled = True
        FocusControl cmdUpdate
    ElseIf strCommandSource = "15" Then 'searching by Unit on demand
        txtUnitlist.Tag = flxClient.TextMatrix(flxClient.row, 0)
        txtUnitlist.text = flxClient.TextMatrix(flxClient.row, 0)
        txtlesselist.text = "ALL"
        txtlesselist.Tag = "ALL"
        adoConn.Open getConnectionString
        'LoadFlxGrid flxDemands, False, adoConn, ""
        LoadFlxDemands adoConn, ""
        If chkSelectAllDemands.Value Then chkSelectAllDemands.Value = 0
        flxDemands.row = 0
        flxDemands.col = 0
        adoConn.Close
        Set adoConn = Nothing
        flxDemands.SetFocus
    ElseIf strCommandSource = "16" Then 'searching by Lessee on demand
        txtlesselist.Tag = flxClient.TextMatrix(flxClient.row, 0)
        txtlesselist.text = flxClient.TextMatrix(flxClient.row, 0)
        adoConn.Open getConnectionString
        'LoadFlxGrid flxDemands, False, adoConn, ""
        LoadFlxDemands adoConn, ""
        If chkSelectAllDemands.Value Then chkSelectAllDemands.Value = 0
        flxDemands.row = 0
        flxDemands.col = 0
        adoConn.Close
        Set adoConn = Nothing
        flxDemands.SetFocus
    ElseIf strCommandSource = "17" Then 'searching by Unit on demand history
        txtUnitListHist.Tag = flxClient.TextMatrix(flxClient.row, 0)
        txtUnitListHist.text = flxClient.TextMatrix(flxClient.row, 0)
        txtLesseeListHist.text = "ALL"
        txtLesseeListHist.Tag = "ALL"
        adoConn.Open getConnectionString
        LoadFlxGrid flxDemandHistory, True, adoConn, ""
        If chkSelectAllDemands.Value Then chkSelectAllDemands.Value = 0
        flxDemands.row = 0
        flxDemands.col = 0
        adoConn.Close
        Set adoConn = Nothing
        flxDemandHistory.SetFocus
    ElseIf strCommandSource = "18" Then 'searching by lessee on demand history
        txtLesseeListHist.Tag = flxClient.TextMatrix(flxClient.row, 0)
        txtLesseeListHist.text = flxClient.TextMatrix(flxClient.row, 0)
        adoConn.Open getConnectionString
        LoadFlxGrid flxDemandHistory, True, adoConn, ""
        If chkSelectAllDemands.Value Then chkSelectAllDemands.Value = 0
        flxDemands.row = 0
        flxDemands.col = 0
        adoConn.Close
        Set adoConn = Nothing
        flxDemandHistory.SetFocus
    ElseIf strCommandSource = "19" Then 'searching by lessee on demand history
        txtFreq.Tag = Val(Trim(flxClient.TextMatrix(flxClient.row, 0)))
        txtFreq.text = flxClient.TextMatrix(flxClient.row, 1)
        flxDemandHistory.SetFocus
    ElseIf strCommandSource = "20" Then
        txtBankCode.text = flxClient.TextMatrix(flxClient.row, 1)
        txtBankAc.text = flxClient.TextMatrix(flxClient.row, 2)
        Call updateBankBalance
        FocusControl txtReceiptReference
    End If
    picClient.Visible = False
End Sub
Public Sub updateBankBalance()
        Dim adoConn As New ADODB.Connection
        Dim adoRST As New ADODB.Recordset
        adoConn.Open getConnectionString
        Dim Balance As Double
        Dim szSQL As String
   ' find current Balance for the selected bank account and selected client ID by anol 2023-05-24
   szSQL = " SELECT sum(SWITCH(T ='3',AMT,T ='4',AMT,T ='8',-AMT,T ='9',-AMT,T ='BP',-AMT,T ='BR',AMT,T ='23',-AMT,T ='24',AMT)) as AMTT from (" & _
            "SELECT SUM(R.Amount) AS AMT, Type AS T " & _
           "FROM tlbReceipt AS R, tlbTransactionTypes AS TT, Units AS U, Property AS P, tlbClientBanks AS B " & _
           "WHERE (R.Type = 3 OR R.Type = 4 OR R.Type = 23) AND " & _
                  "TT.TYPE_ID = R.Type AND R.BankCode = '" & txtBankCode & "' AND U.UnitNumber = R.UnitID AND " & _
                  "U.PropertyID = P.PropertyID AND P.ClientID = '" & txtRptClientList.text & "' AND B.NominalCode = R.BankCode AND " & _
                  "B.CLIENT_ID = P.ClientID group by Type UNION "
                  
        szSQL = szSQL & _
                "SELECT SUM(BP.NET_AMOUNT + BP.VAT) AS AMT, TRANS AS T " & _
                "FROM tlbBankPayment AS BP, tlbTransactionTypes AS TT, tlbClientBanks AS B " & _
                "WHERE (BP.TransactionType = 11 OR BP.TransactionType = 12) AND " & _
                       "BP.BANK_AC = '" & txtBankCode & "' AND BP.TransactionType = TT.TYPE_ID AND " & _
                       "BP.ClientID = '" & txtRptClientList & "' AND B.NominalCode = BP.BANK_AC AND B.CLIENT_ID = BP.ClientID  group by TRANS UNION "
        szSQL = szSQL & _
                "SELECT SUM(P.Amount) AS AMT, Type AS T " & _
                "FROM tlbPayment AS P, tlbTransactionTypes AS TT " & _
                "WHERE (P.Type = 8 OR P.Type = 9 OR P.Type = 24) AND P.BankCode = '" & txtBankCode & "' AND P.Type = TT.TYPE_ID AND " & _
                       "P.ClientID = '" & txtRptClientList & "'   group by Type )"
                       
    adoRST.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
   If Not adoRST.EOF Then
      txtArray(10).text = IIf(IsNull(adoRST.Fields.Item("AMTT").Value), 0, adoRST.Fields.Item("AMTT").Value)
      txtArray(10).text = Format(txtArray(10).text, "0.00")
   End If
   adoRST.Close
    szSQL = "Select sum(amount) as DAmt from RetentionDetails where isDeleted=false and BankCode='" & txtBankCode & "' and ClientID='" & txtRptClientList & "'"
    adoRST.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
    If Not adoRST.EOF Then
        txtArray(11).text = IIf(IsNull(adoRST.Fields.Item("DAmt").Value), 0, adoRST.Fields.Item("DAmt").Value)   'adoRst.Fields.Item("DAmt").Value
        txtArray(11).text = Format(txtArray(11).text, "0.00")
    End If
    adoRST.Close
    
    
'   szSQL = "SELECT * from tlbClientBanks where NominalCode and client_ID='" & txtClientList & "'"
'   adoRst.Open szSQL, adoconn, adOpenStatic, adLockReadOnly
'   If Not adoRst.EOF Then
'   End If
   txtArray(12).text = Val(txtArray(10).text) - Val(txtArray(11).text)
   txtArray(12).text = Format(txtArray(12).text, "0.00")
'   txtAvailableBankBal1
'   txtRetentions1
   adoConn.Close
End Sub
Private Sub displayPropertyAgainstClient()
        'Written by anol 07 Jan 2015
        Dim adoConn As New ADODB.Connection
        Dim adoRST As New ADODB.Recordset
        Dim szSQL As String
        If strCommandSource = "1" Then
            szSQL = "SELECT PropertyID, PropertyName, " & _
              "ProAddressLine1, ProPostCode " & _
             "FROM Property " & _
            "WHERE ClientID = '" & txtDmdClientList.text & "' " & _
            "ORDER BY PropertyID;"
            adoConn.Open getConnectionString
            adoRST.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
            If Not adoRST.EOF Then
                txtDmdPropertyList.text = IIf(IsNull(adoRST.Fields("PropertyID").Value), "", adoRST.Fields("PropertyID").Value)
            Else
                txtDmdPropertyList.text = ""
            End If
            adoRST.Close
            adoConn.Close
         End If
        
End Sub
Private Sub flxClient_KeyPress(KeyAscii As Integer)
    If KeyAscii = 27 Then
         picClient.Visible = False
         tabDmdRcpt.Enabled = True
         If strCommandSource = "1" Then
             cmdDmdClientList.SetFocus
         ElseIf strCommandSource = "2" Then
            cmdDmdPropertyList.SetFocus
         ElseIf strCommandSource = "3" Then
            cmdDmdTenantLookup.SetFocus
         ElseIf strCommandSource = "4" Then
            cmdClientFilterMainList(1).SetFocus
         ElseIf strCommandSource = "5" Then
            cmdClientHistory.SetFocus
         ElseIf strCommandSource = "6" Then
            cmdPropertyHistory.SetFocus
         ElseIf strCommandSource = "7" Then
            cmdRptClientList.SetFocus
         ElseIf strCommandSource = "8" Then
            cmdPropertyHistory.SetFocus
         ElseIf strCommandSource = "9" Then
             cmdRptClientList1.SetFocus
         ElseIf strCommandSource = "10" Then
            cmdRptPropertyList1.SetFocus
         ElseIf strCommandSource = "11" Then
            cmdType.SetFocus
         ElseIf strCommandSource = "12" Then
                cmdFund.SetFocus
         ElseIf strCommandSource = "13" Then
               cmdJob.SetFocus
         ElseIf strCommandSource = "14" Then
               cmdVATCode.SetFocus
         ElseIf strCommandSource = "15" Then
               cmdClientFilterMainList(3).SetFocus
         End If
    End If

    If KeyAscii = 13 Then
            flxClient_Click
    End If
End Sub

Private Sub cmdClientSerc_Click()
    strCommandSource = "1"
    picClient.Left = 1980
    picClient.Top = 675
    picClient.Visible = True
    LoadflxClient
    tabDmdRcpt.Enabled = False
    txtSearchClientID.SetFocus
End Sub
Private Sub LoadflxClient()
   Dim rRow As Integer
   Dim szSQL As String

   Dim adoConn As New ADODB.Connection
   Dim rstRec As New ADODB.Recordset

   flxClient.RowHeight(0) = 0
   flxClient.Cols = 3
   flxClient.ColWidth(0) = 1500
   flxClient.ColWidth(1) = 3600
   flxClient.ColWidth(2) = 0
   
   
   txtSearchClientID.Width = 1530
   txtSearchClientName.Visible = True
   picClient.Width = 5295
   cmdPicCLose.Left = 5010
   
   flxClient.Clear
   flxClient.Rows = 2
   flxClient.ColAlignment(0) = vbLeftJustify
   flxClient.ColAlignment(1) = vbLeftJustify
   flxClient.ColAlignment(2) = vbLeftJustify

   '~~~ Added by Anol Configuring width and position of labels and search boxes.
   Label20(12).Caption = "Client ID"
   Label20(13).Caption = "Client Name"
   Label20(12).Width = 1400
   Label20(12).Left = 50
   Label20(13).Width = 2600
   Label20(13).Left = Label20(12).Left + flxClient.ColWidth(0)
   txtSearchClientName.Left = 1620
   txtSearchClientName.text = ""
   txtSearchClientID.text = ""
   txtSearchClientName.Width = 3240
   txtSearchClientID.Left = 45
   picClient.Height = 4095
   flxClient.Height = 3345
   flxClient.Width = 5175
   Label20(14).Visible = False
   adoConn.Open getConnectionString
   szSQL = "SELECT CLIENTID, CLIENTNAME, CT FROM   CLIENT ORDER BY CLIENTID;"

   rstRec.Open szSQL, adoConn, adOpenStatic, adLockReadOnly

      If strCommandSource = "1" Then
            rRow = 1
            While Not rstRec.EOF
               flxClient.row = 1
               flxClient.RowSel = 1
               flxClient.ColSel = 1
'               flxClient.col = 1
'               flxClient.BackColorSel = &HC0FFFF
               flxClient.TextMatrix(rRow, 0) = rstRec.Fields.Item(0).Value
               flxClient.TextMatrix(rRow, 1) = rstRec.Fields.Item(1).Value
               flxClient.TextMatrix(rRow, 2) = IIf(IsNull(rstRec.Fields.Item(2).Value), "", rstRec.Fields.Item(2).Value)
               flxClient.RowHeight(rRow) = 280
               rstRec.MoveNext
               If Not rstRec.EOF Then flxClient.AddItem ""
               rRow = rRow + 1
            Wend
      End If
      If strCommandSource = "3" Or strCommandSource = "5" Or strCommandSource = "7" Or strCommandSource = "9" Then
           flxClient.TextMatrix(1, 0) = "ALL"
           flxClient.TextMatrix(1, 1) = "All Client"
           flxClient.TextMatrix(1, 2) = ""
           flxClient.RowHeight(1) = 280
           flxClient.AddItem ""
           rRow = 2
           While Not rstRec.EOF
               flxClient.row = 1
               flxClient.RowSel = 1
               flxClient.ColSel = 1
               flxClient.TextMatrix(rRow, 0) = rstRec.Fields.Item(0).Value
               flxClient.TextMatrix(rRow, 1) = rstRec.Fields.Item(1).Value
               flxClient.TextMatrix(rRow, 2) = IIf(IsNull(rstRec.Fields.Item(2).Value), "", rstRec.Fields.Item(2).Value)
               flxClient.RowHeight(rRow) = 280
               rstRec.MoveNext
               If Not rstRec.EOF Then flxClient.AddItem ""
               rRow = rRow + 1
            Wend
      End If
   rstRec.Close
   adoConn.Close
   Set rstRec = Nothing
   Set adoConn = Nothing

End Sub
Private Sub LoadLesseeList()
   Dim rRow As Integer
   'Dim szTenantsSQL2 As String

   Dim adoConn As New ADODB.Connection
   Dim rstRec As New ADODB.Recordset
   txtSearchClientID.text = ""
   txtSearchClientName.text = ""
   flxClient.RowHeight(0) = 0
   flxClient.Cols = 3
   flxClient.ColWidth(0) = 1500
   flxClient.ColWidth(1) = 3600
   flxClient.ColWidth(2) = 0
   flxClient.Clear
   flxClient.Rows = 2
   flxClient.ColAlignment(0) = vbLeftJustify
   flxClient.ColAlignment(1) = vbLeftJustify
   flxClient.ColAlignment(2) = vbLeftJustify
   
   txtSearchClientID.Width = 1530
   txtSearchClientName.Visible = True
   picClient.Width = 5295
   cmdPicCLose.Left = 5010
   txtSearchClientID.Left = 45
   '~~~ Added by Anol Configuring width and position of labels and search boxes.
   Label20(12).Caption = "Lessee ID"
   Label20(13).Caption = "Lessee Name"
   Label20(12).Width = 1400
   Label20(12).Left = 50
   Label20(13).Width = 2600
   Label20(13).Left = Label20(12).Left + flxClient.ColWidth(0)
   
   txtSearchClientName.Left = 1620
   txtSearchClientName.text = ""
   txtSearchClientID.text = ""
   txtSearchClientName.Width = 3240
   txtSearchClientID.Left = 45
   picClient.Height = 4095
   flxClient.Height = 3345
   flxClient.Width = 5175
   Label20(14).Visible = False
   
   adoConn.Open getConnectionString
           
         
           If strCommandSource = "16" Then
                If txtUnitlist.text = "ALL" Then
                    If txtPropertyList.text = "ALL" Then
                         szTenantsSQL2 = "SELECT T.SageAccountNumber, T.CompanyName, IQ.UnitName, " & _
                                   "'' AS Balance, " & _
                                   "IIF(ISNULL(T.Comments),'CURRENT','DELETED') AS Notes, " & _
                                   "IQ.PropertyID, IQ.ClientID, IQ.UnitNumber " & _
                              "FROM Tenants AS T LEFT JOIN " & _
                                   "[" & _
                                   "SELECT U.UnitName, L.SageAccountNumber, " & _
                                          "P.PropertyID, P.ClientID, U.UnitNumber " & _
                                   "FROM Units AS U, LeaseDetails AS L, " & _
                                        "Property AS P " & _
                                   "WHERE U.UnitNumber = L.UnitNumber AND " & _
                                      "L.Status = TRUE AND U.PropertyID = P.PropertyID "
                
                        szTenantsSQL2 = szTenantsSQL2 + "]. AS IQ ON T.SageAccountNumber = IQ.SageAccountNumber " & _
                                 "WHERE OCCUPIDE_ = FALSE AND T.Comments is null ORDER BY T.SageAccountNumber;"
                     Else
                        szTenantsSQL2 = "SELECT T.SageAccountNumber, T.CompanyName, IQ.UnitName, " & _
                                   "'' AS Balance, " & _
                                   "IIF(ISNULL(T.Comments),'CURRENT','DELETED') AS Notes, " & _
                                   "IQ.PropertyID, IQ.ClientID, IQ.UnitNumber " & _
                              "FROM Tenants AS T LEFT JOIN " & _
                                   "[" & _
                                   "SELECT U.UnitName, L.SageAccountNumber, " & _
                                          "P.PropertyID, P.ClientID, U.UnitNumber " & _
                                   "FROM Units AS U, LeaseDetails AS L, " & _
                                        "Property AS P " & _
                                   "WHERE U.UnitNumber = L.UnitNumber AND " & _
                                      "L.Status = TRUE AND U.PropertyID = P.PropertyID "
                
                        szTenantsSQL2 = szTenantsSQL2 + "]. AS IQ ON T.SageAccountNumber = IQ.SageAccountNumber " & _
                                 "WHERE OCCUPIDE_ = FALSE AND IQ.PropertyID='" & txtPropertyList.text & "' AND T.Comments is null ORDER BY T.SageAccountNumber;"
                     End If
                Else
                        szTenantsSQL2 = "SELECT T.SageAccountNumber, T.CompanyName, IQ.UnitName, " & _
                                       "'' AS Balance, " & _
                                       "IIF(ISNULL(T.Comments),'CURRENT','DELETED') AS Notes, " & _
                                       "IQ.PropertyID, IQ.ClientID, IQ.UnitNumber " & _
                                  "FROM Tenants AS T LEFT JOIN " & _
                                       "[" & _
                                       "SELECT U.UnitName, L.SageAccountNumber, " & _
                                              "P.PropertyID, P.ClientID, U.UnitNumber " & _
                                       "FROM Units AS U, LeaseDetails AS L, " & _
                                            "Property AS P " & _
                                       "WHERE U.UnitNumber = L.UnitNumber  AND " & _
                                          "L.Status = TRUE AND U.PropertyID = P.PropertyID "
                    
                          szTenantsSQL2 = szTenantsSQL2 + "]. AS IQ ON T.SageAccountNumber = IQ.SageAccountNumber " & _
                                     "WHERE OCCUPIDE_ = FALSE AND IQ.UnitNumber='" & txtUnitlist.text & "' AND T.Comments is null ORDER BY T.SageAccountNumber;"
                End If
           End If
   
'Debug.Print szTenantsSQL2
   rstRec.Open szTenantsSQL2, adoConn, adOpenStatic, adLockReadOnly
   
   If strCommandSource = "16" Then
           flxClient.TextMatrix(1, 0) = "ALL"
           flxClient.TextMatrix(1, 1) = "All Lessee"
           flxClient.AddItem ""
           rRow = 2
        While Not rstRec.EOF
           flxClient.row = 1
           flxClient.RowSel = 1
           flxClient.ColSel = 1
           flxClient.TextMatrix(rRow, 0) = rstRec.Fields("SageAccountNumber").Value
           flxClient.TextMatrix(rRow, 1) = rstRec.Fields.Item("CompanyName").Value
           flxClient.RowHeight(rRow) = 280
           rstRec.MoveNext
           If Not rstRec.EOF Then flxClient.AddItem ""
           rRow = rRow + 1
        Wend
   End If
   rstRec.Close
   adoConn.Close
   Set rstRec = Nothing
   Set adoConn = Nothing
                 
End Sub

Private Sub LoadLesseeListHist()
   Dim rRow As Integer
   

   Dim adoConn As New ADODB.Connection
   Dim rstRec As New ADODB.Recordset
   
   flxClient.RowHeight(0) = 0
   flxClient.Cols = 3
   flxClient.ColWidth(0) = 1500
   flxClient.ColWidth(1) = 3600
   flxClient.ColWidth(2) = 0
   flxClient.Clear
   flxClient.Rows = 2
   flxClient.ColAlignment(0) = vbLeftJustify
   flxClient.ColAlignment(1) = vbLeftJustify
   flxClient.ColAlignment(2) = vbLeftJustify
   
   txtSearchClientID.Width = 1530
   txtSearchClientName.Visible = True
   picClient.Width = 5295
   cmdPicCLose.Left = 5010
   txtSearchClientID.Left = 45
   '~~~ Added by Anol Configuring width and position of labels and search boxes.
   Label20(12).Caption = "Lessee ID"
   Label20(13).Caption = "Lessee Name"
   Label20(12).Width = 1400
   Label20(12).Left = 50
   Label20(13).Width = 2600
   Label20(13).Left = Label20(12).Left + flxClient.ColWidth(0)
   
   txtSearchClientName.Left = 1620
   txtSearchClientName.Width = 3240
   txtSearchClientID.Left = 45
   picClient.Height = 4095
   flxClient.Height = 3345
   flxClient.Width = 5175
   Label20(14).Visible = False
   adoConn.Open getConnectionString
           If strCommandSource = "18" Then
                If txtUnitListHist.text = "ALL" Then
                    If txtPropertyHistory.text = "ALL" Then
                         szTenantsSQL2 = "SELECT T.SageAccountNumber, T.CompanyName, IQ.UnitName, " & _
                                   "'' AS Balance, " & _
                                   "IIF(ISNULL(T.Comments),'CURRENT','DELETED') AS Notes, " & _
                                   "IQ.PropertyID, IQ.ClientID, IQ.UnitNumber " & _
                              "FROM Tenants AS T LEFT JOIN " & _
                                   "[" & _
                                   "SELECT U.UnitName, L.SageAccountNumber, " & _
                                          "P.PropertyID, P.ClientID, U.UnitNumber " & _
                                   "FROM Units AS U, LeaseDetails AS L, " & _
                                        "Property AS P " & _
                                   "WHERE U.UnitNumber = L.UnitNumber AND " & _
                                      "L.Status = TRUE AND U.PropertyID = P.PropertyID "
                
                        szTenantsSQL2 = szTenantsSQL2 + "]. AS IQ ON T.SageAccountNumber = IQ.SageAccountNumber " & _
                                 "WHERE OCCUPIDE_ = FALSE AND T.Comments is null ORDER BY T.SageAccountNumber;"
                     Else
                         szTenantsSQL2 = "SELECT T.SageAccountNumber, T.CompanyName, IQ.UnitName, " & _
                                   "'' AS Balance, " & _
                                   "IIF(ISNULL(T.Comments),'CURRENT','DELETED') AS Notes, " & _
                                   "IQ.PropertyID, IQ.ClientID, IQ.UnitNumber " & _
                              "FROM Tenants AS T LEFT JOIN " & _
                                   "[" & _
                                   "SELECT U.UnitName, L.SageAccountNumber, " & _
                                          "P.PropertyID, P.ClientID, U.UnitNumber " & _
                                   "FROM Units AS U, LeaseDetails AS L, " & _
                                        "Property AS P " & _
                                   "WHERE U.UnitNumber = L.UnitNumber AND " & _
                                      "L.Status = TRUE AND U.PropertyID = P.PropertyID "
                
                        szTenantsSQL2 = szTenantsSQL2 + "]. AS IQ ON T.SageAccountNumber = IQ.SageAccountNumber " & _
                                 "WHERE OCCUPIDE_ = FALSE AND IQ.PropertyID='" & txtPropertyHistory.text & "' AND T.Comments is null ORDER BY T.SageAccountNumber;"
                     End If
                Else
                    
                        szTenantsSQL2 = "SELECT T.SageAccountNumber, T.CompanyName, IQ.UnitName, " & _
                                       "'' AS Balance, " & _
                                       "IIF(ISNULL(T.Comments),'CURRENT','DELETED') AS Notes, " & _
                                       "IQ.PropertyID, IQ.ClientID, IQ.UnitNumber " & _
                                  "FROM Tenants AS T LEFT JOIN " & _
                                       "[" & _
                                       "SELECT U.UnitName, L.SageAccountNumber, " & _
                                              "P.PropertyID, P.ClientID, U.UnitNumber " & _
                                       "FROM Units AS U, LeaseDetails AS L, " & _
                                            "Property AS P " & _
                                       "WHERE U.UnitNumber = L.UnitNumber  AND " & _
                                          "L.Status = TRUE AND U.PropertyID = P.PropertyID "
                    
                          szTenantsSQL2 = szTenantsSQL2 + "]. AS IQ ON T.SageAccountNumber = IQ.SageAccountNumber " & _
                                     "WHERE OCCUPIDE_ = FALSE  AND IQ.UnitNumber='" & txtUnitListHist.text & "' AND T.Comments is null ORDER BY T.SageAccountNumber;"
                   
                End If
           End If
 
   rstRec.Open szTenantsSQL2, adoConn, adOpenStatic, adLockReadOnly
   
   If strCommandSource = "18" Then
           flxClient.TextMatrix(1, 0) = "ALL"
           flxClient.TextMatrix(1, 1) = "All Lessee"
           flxClient.AddItem ""
           rRow = 2
        While Not rstRec.EOF
           flxClient.row = 1
           flxClient.RowSel = 1
           flxClient.ColSel = 1
           flxClient.TextMatrix(rRow, 0) = rstRec.Fields("SageAccountNumber").Value
           flxClient.TextMatrix(rRow, 1) = rstRec.Fields.Item("CompanyName").Value
           flxClient.RowHeight(rRow) = 280
           rstRec.MoveNext
           If Not rstRec.EOF Then flxClient.AddItem ""
           rRow = rRow + 1
        Wend
   End If
   rstRec.Close
   adoConn.Close
   Set rstRec = Nothing
   Set adoConn = Nothing
                 
End Sub
Private Sub Filterlesseelist()
   
   Dim rRow As Integer
   Dim szSQL As String
   Dim tempstr As String

   Dim adoConn As New ADODB.Connection
   Dim rstRec As New ADODB.Recordset
'   txtSearchClientID.text = ""
'   txtSearchClientName.text = ""
   flxClient.RowHeight(0) = 0
   flxClient.Cols = 3
   flxClient.ColWidth(0) = 1500
   flxClient.ColWidth(1) = 3600
   flxClient.ColWidth(2) = 0
   flxClient.Clear
   flxClient.Rows = 2
   flxClient.ColAlignment(0) = vbLeftJustify
   flxClient.ColAlignment(1) = vbLeftJustify
   flxClient.ColAlignment(2) = vbLeftJustify
   
   txtSearchClientID.Width = 1530
   txtSearchClientName.Visible = True
   picClient.Width = 5295
   cmdPicCLose.Left = 5010
   txtSearchClientID.Left = 45
   '~~~ Added by Anol Configuring width and position of labels and search boxes.
   Label20(12).Caption = "Lessee ID"
   Label20(13).Caption = "Lessee Name"
   Label20(12).Width = 1400
   Label20(12).Left = 50
   Label20(13).Width = 2600
   Label20(13).Left = Label20(12).Left + flxClient.ColWidth(0)
   
   txtSearchClientName.Left = 1620
'   txtSearchClientName.text = ""
'   txtSearchClientID.text = ""
   txtSearchClientName.Width = 3240
   txtSearchClientID.Left = 45
   picClient.Height = 4095
   flxClient.Height = 3345
   flxClient.Width = 5175
   Label20(14).Visible = False
    Dim Filter As String
    If Len(txtSearchClientID.text) > 0 Then
      txtSearchClientName.text = ""
      tempstr = Replace(UCase(txtSearchClientID.text), "'", "''")
      Filter = " SageAccountNumber LIKE '%" + tempstr + "*'"
   End If
   If Len(txtSearchClientName.text) > 0 Then
      txtSearchClientID.text = ""
      tempstr = Replace(UCase(txtSearchClientName.text), "'", "''")
      Filter = " CompanyName LIKE '%" + tempstr + "*'"
   End If
   
   adoConn.Open getConnectionString
           
         
           If strCommandSource = "16" Then
                If txtUnitlist.text = "ALL" Then
                         szSQL = "SELECT T.SageAccountNumber, T.CompanyName, IQ.UnitName, " & _
                                   "'' AS Balance, " & _
                                   "IIF(ISNULL(T.Comments),'CURRENT','DELETED') AS Notes, " & _
                                   "IQ.PropertyID, IQ.ClientID, IQ.UnitNumber " & _
                              "FROM Tenants AS T LEFT JOIN " & _
                                   "[" & _
                                   "SELECT U.UnitName, L.SageAccountNumber, " & _
                                          "P.PropertyID, P.ClientID, U.UnitNumber " & _
                                   "FROM Units AS U, LeaseDetails AS L, " & _
                                        "Property AS P " & _
                                   "WHERE U.UnitNumber = L.UnitNumber AND " & _
                                      "L.Status = TRUE AND U.PropertyID = P.PropertyID "
                
                        szSQL = szSQL + "]. AS IQ ON T.SageAccountNumber = IQ.SageAccountNumber " & _
                                 "WHERE OCCUPIDE_ = FALSE ORDER BY T.SageAccountNumber;"
                Else
                        szSQL = "SELECT T.SageAccountNumber, T.CompanyName, IQ.UnitName, " & _
                                       "'' AS Balance, " & _
                                       "IIF(ISNULL(T.Comments),'CURRENT','DELETED') AS Notes, " & _
                                       "IQ.PropertyID, IQ.ClientID, IQ.UnitNumber " & _
                                  "FROM Tenants AS T LEFT JOIN " & _
                                       "[" & _
                                       "SELECT U.UnitName, L.SageAccountNumber, " & _
                                              "P.PropertyID, P.ClientID, U.UnitNumber " & _
                                       "FROM Units AS U, LeaseDetails AS L, " & _
                                            "Property AS P " & _
                                       "WHERE U.UnitNumber = L.UnitNumber AND L.UnitNumber='" & txtUnitlist.text & "' AND " & _
                                          "L.Status = TRUE AND U.PropertyID = P.PropertyID "
                    
                          szSQL = szSQL + "]. AS IQ ON T.SageAccountNumber = IQ.SageAccountNumber " & _
                                     "WHERE OCCUPIDE_ = FALSE ORDER BY T.SageAccountNumber;"
                End If
           End If
   
'Debug.Print szSQL
   rstRec.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
   rstRec.Filter = Filter
   flxClient.Rows = 2
   flxClient.RowHeight(0) = 0
   If strCommandSource = "16" Then
           flxClient.TextMatrix(1, 0) = "ALL"
           flxClient.TextMatrix(1, 1) = "All Lessee"
           flxClient.AddItem ""
           rRow = 2
        While Not rstRec.EOF
           flxClient.row = 1
           flxClient.RowSel = 1
           flxClient.ColSel = 1
           flxClient.TextMatrix(rRow, 0) = rstRec.Fields("SageAccountNumber").Value
           flxClient.TextMatrix(rRow, 1) = rstRec.Fields.Item("CompanyName").Value
           flxClient.RowHeight(rRow) = 280
           rstRec.MoveNext
           If Not rstRec.EOF Then flxClient.AddItem ""
           rRow = rRow + 1
        Wend
   End If
   rstRec.Close
   adoConn.Close
   Set rstRec = Nothing
   Set adoConn = Nothing
End Sub
Private Sub FilterlesseelistHist()
   
   Dim rRow As Integer
   Dim szSQL As String
   Dim tempstr As String

   Dim adoConn As New ADODB.Connection
   Dim rstRec As New ADODB.Recordset

   flxClient.RowHeight(0) = 0
   flxClient.Cols = 3
   flxClient.ColWidth(0) = 1500
   flxClient.ColWidth(1) = 3600
   flxClient.ColWidth(2) = 0
   flxClient.Clear
   flxClient.Rows = 2
   flxClient.ColAlignment(0) = vbLeftJustify
   flxClient.ColAlignment(1) = vbLeftJustify
   flxClient.ColAlignment(2) = vbLeftJustify
   
   txtSearchClientID.Width = 1530
   txtSearchClientName.Visible = True
   picClient.Width = 5295
   cmdPicCLose.Left = 5010
   txtSearchClientID.Left = 45
   '~~~ Added by Anol Configuring width and position of labels and search boxes.
   Label20(12).Caption = "Lessee ID"
   Label20(13).Caption = "Lessee Name"
   Label20(12).Width = 1400
   Label20(12).Left = 50
   Label20(13).Width = 2600
   Label20(13).Left = Label20(12).Left + flxClient.ColWidth(0)
   
    txtSearchClientName.Left = 1620
    
    txtSearchClientName.Width = 3240
    txtSearchClientID.Left = 45
    picClient.Height = 4095
    flxClient.Height = 3345
    flxClient.Width = 5175
    Label20(14).Visible = False
    Dim Filter As String
    If Len(txtSearchClientID.text) > 0 Then
        txtSearchClientName.text = ""
        tempstr = Replace(UCase(txtSearchClientID.text), "'", "''")
        Filter = " SageAccountNumber LIKE '%" + tempstr + "*'"
    End If
    If Len(txtSearchClientName.text) > 0 Then
       txtSearchClientID.text = ""
       tempstr = Replace(UCase(txtSearchClientName.text), "'", "''")
       Filter = " CompanyName LIKE '%" + tempstr + "*'"
    End If
   
   adoConn.Open getConnectionString
           
         
           If strCommandSource = "18" Then
                If txtUnitListHist.text = "ALL" Then
                         szSQL = "SELECT T.SageAccountNumber, T.CompanyName, IQ.UnitName, " & _
                                   "'' AS Balance, " & _
                                   "IIF(ISNULL(T.Comments),'CURRENT','DELETED') AS Notes, " & _
                                   "IQ.PropertyID, IQ.ClientID, IQ.UnitNumber " & _
                              "FROM Tenants AS T LEFT JOIN " & _
                                   "[" & _
                                   "SELECT U.UnitName, L.SageAccountNumber, " & _
                                          "P.PropertyID, P.ClientID, U.UnitNumber " & _
                                   "FROM Units AS U, LeaseDetails AS L, " & _
                                        "Property AS P " & _
                                   "WHERE U.UnitNumber = L.UnitNumber AND " & _
                                      "L.Status = TRUE AND U.PropertyID = P.PropertyID "
                
                        szSQL = szSQL + "]. AS IQ ON T.SageAccountNumber = IQ.SageAccountNumber " & _
                                 "WHERE OCCUPIDE_ = FALSE ORDER BY T.SageAccountNumber;"
                Else
                        szSQL = "SELECT T.SageAccountNumber, T.CompanyName, IQ.UnitName, " & _
                                       "'' AS Balance, " & _
                                       "IIF(ISNULL(T.Comments),'CURRENT','DELETED') AS Notes, " & _
                                       "IQ.PropertyID, IQ.ClientID, IQ.UnitNumber " & _
                                  "FROM Tenants AS T LEFT JOIN " & _
                                       "[" & _
                                       "SELECT U.UnitName, L.SageAccountNumber, " & _
                                              "P.PropertyID, P.ClientID, U.UnitNumber " & _
                                       "FROM Units AS U, LeaseDetails AS L, " & _
                                            "Property AS P " & _
                                       "WHERE U.UnitNumber = L.UnitNumber  AND " & _
                                          "L.Status = TRUE AND U.PropertyID = P.PropertyID "
                    
                          szSQL = szSQL + "]. AS IQ ON T.SageAccountNumber = IQ.SageAccountNumber " & _
                                     "WHERE OCCUPIDE_ = FALSE AND IQ.UnitNumber='" & txtUnitListHist.text & "' ORDER BY T.SageAccountNumber;"
                End If
           End If
   
'Debug.Print szSQL
   rstRec.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
   rstRec.Filter = Filter
   flxClient.Rows = 2
   flxClient.RowHeight(0) = 0
   If strCommandSource = "18" Then
           flxClient.TextMatrix(1, 0) = "ALL"
           flxClient.TextMatrix(1, 1) = "All Lessee"
           flxClient.AddItem ""
           rRow = 2
        While Not rstRec.EOF
           flxClient.row = 1
           flxClient.RowSel = 1
           flxClient.ColSel = 1
           flxClient.TextMatrix(rRow, 0) = rstRec.Fields("SageAccountNumber").Value
           flxClient.TextMatrix(rRow, 1) = rstRec.Fields.Item("CompanyName").Value
           flxClient.RowHeight(rRow) = 280
           rstRec.MoveNext
           If Not rstRec.EOF Then flxClient.AddItem ""
           rRow = rRow + 1
        Wend
   End If
   rstRec.Close
   adoConn.Close
   Set rstRec = Nothing
   Set adoConn = Nothing
End Sub
Private Sub LoadUnitListHist()
   Dim rRow As Integer
   Dim szSQL As String

   Dim adoConn As New ADODB.Connection
   Dim rstRec As New ADODB.Recordset
   txtSearchClientID.text = ""
   txtSearchClientName.text = ""
   flxClient.RowHeight(0) = 0
   flxClient.Cols = 3
   flxClient.ColWidth(0) = 1500
   flxClient.ColWidth(1) = 3600
   flxClient.ColWidth(2) = 0
   flxClient.Clear
   flxClient.Rows = 2
   flxClient.ColAlignment(0) = vbLeftJustify
   flxClient.ColAlignment(1) = vbLeftJustify
   flxClient.ColAlignment(2) = vbLeftJustify
   
   txtSearchClientID.Width = 1530
   txtSearchClientName.Visible = True
   picClient.Width = 5295
   cmdPicCLose.Left = 5010
   txtSearchClientID.Left = 45
   '~~~ Added by Anol Configuring width and position of labels and search boxes.
   Label20(12).Caption = "Unit ID"
   Label20(13).Caption = "Unit Name"
   Label20(12).Width = 1400
   Label20(12).Left = 50
   Label20(13).Width = 2600
   Label20(13).Left = Label20(12).Left + flxClient.ColWidth(0)
   
   txtSearchClientName.Left = 1620
   
   txtSearchClientName.Width = 3240
   txtSearchClientID.Left = 45
   picClient.Height = 4095
   flxClient.Height = 3345
   flxClient.Width = 5175
   Label20(14).Visible = False
   
   adoConn.Open getConnectionString
           
         
           If strCommandSource = "17" Then
                If txtPropertyHistory.text = "ALL" Then
                    szSQL = "SELECT UnitNumber, UnitName " & _
                    "FROM Units " & _
                    "ORDER BY UnitNumber;"
                Else
                    szSQL = "SELECT UnitNumber, UnitName " & _
                    "FROM Units " & _
                    "WHERE PropertyID = '" & txtPropertyHistory.text & "' " & _
                    "ORDER BY UnitNumber;"
                End If
           End If
           
'Debug.Print szSQL
   rstRec.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
   
   If strCommandSource = "17" Then
           flxClient.TextMatrix(1, 0) = "ALL"
           flxClient.TextMatrix(1, 1) = "All Unit"
           flxClient.AddItem ""
           rRow = 2
        While Not rstRec.EOF
           flxClient.row = 1
           flxClient.RowSel = 1
           flxClient.ColSel = 1
           flxClient.TextMatrix(rRow, 0) = rstRec.Fields("UnitNumber").Value
           flxClient.TextMatrix(rRow, 1) = rstRec.Fields.Item("UnitName").Value
           flxClient.RowHeight(rRow) = 280
           rstRec.MoveNext
           If Not rstRec.EOF Then flxClient.AddItem ""
           rRow = rRow + 1
        Wend
   End If
   rstRec.Close
   adoConn.Close
   Set rstRec = Nothing
   Set adoConn = Nothing
End Sub
Private Sub LoadUnitList()
   Dim rRow As Integer
   Dim szSQL As String

   Dim adoConn As New ADODB.Connection
   Dim rstRec As New ADODB.Recordset
   txtSearchClientID.text = ""
   txtSearchClientName.text = ""
   flxClient.RowHeight(0) = 0
   flxClient.Cols = 3
   flxClient.ColWidth(0) = 1500
   flxClient.ColWidth(1) = 3600
   flxClient.ColWidth(2) = 0
   flxClient.Clear
   flxClient.Rows = 2
   flxClient.ColAlignment(0) = vbLeftJustify
   flxClient.ColAlignment(1) = vbLeftJustify
   flxClient.ColAlignment(2) = vbLeftJustify
   
   txtSearchClientID.Width = 1530
   txtSearchClientName.Visible = True
   picClient.Width = 5295
   cmdPicCLose.Left = 5010
   txtSearchClientID.Left = 45
   '~~~ Added by Anol Configuring width and position of labels and search boxes.
   Label20(12).Caption = "Unit ID"
   Label20(13).Caption = "Unit Name"
   Label20(12).Width = 1400
   Label20(12).Left = 50
   Label20(13).Width = 2600
   Label20(13).Left = Label20(12).Left + flxClient.ColWidth(0)
   
   txtSearchClientName.Left = 1620
   txtSearchClientName.text = ""
   txtSearchClientID.text = ""
   txtSearchClientName.Width = 3240
   txtSearchClientID.Left = 45
   picClient.Height = 4095
   flxClient.Height = 3345
   flxClient.Width = 5175
   Label20(14).Visible = False
   
   adoConn.Open getConnectionString
           
         
           If strCommandSource = "15" Then
                If txtPropertyList.text = "ALL" Then
                    szSQL = "SELECT UnitNumber, UnitName " & _
                    "FROM Units " & _
                    "ORDER BY UnitNumber;"
                Else
                    szSQL = "SELECT UnitNumber, UnitName " & _
                    "FROM Units " & _
                    "WHERE PropertyID = '" & txtPropertyList.text & "' " & _
                    "ORDER BY UnitNumber;"
                End If
           End If
           
'Debug.Print szSQL
   rstRec.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
   
   If strCommandSource = "15" Then
           flxClient.TextMatrix(1, 0) = "ALL"
           flxClient.TextMatrix(1, 1) = "All Unit"
           flxClient.AddItem ""
           rRow = 2
        While Not rstRec.EOF
           flxClient.row = 1
           flxClient.RowSel = 1
           flxClient.ColSel = 1
           flxClient.TextMatrix(rRow, 0) = rstRec.Fields("UnitNumber").Value
           flxClient.TextMatrix(rRow, 1) = rstRec.Fields.Item("UnitName").Value
           flxClient.RowHeight(rRow) = 280
           rstRec.MoveNext
           If Not rstRec.EOF Then flxClient.AddItem ""
           rRow = rRow + 1
        Wend
   End If
   rstRec.Close
   adoConn.Close
   Set rstRec = Nothing
   Set adoConn = Nothing
End Sub
Private Sub filterUnitList()
    Dim adoConn As New ADODB.Connection
    Dim rstRec As New ADODB.Recordset
    adoConn.Open getConnectionString
    Dim Filter As String
    Dim szSQL As String
    Dim rRow As Integer
    Dim tempstr As String
    If Len(txtSearchClientID.text) > 0 Then
      txtSearchClientName.text = ""
      tempstr = Replace(UCase(txtSearchClientID.text), "'", "''")
      Filter = " UnitNumber LIKE '%" + tempstr + "*'"
   End If
   If Len(txtSearchClientName.text) > 0 Then
      txtSearchClientID.text = ""
      tempstr = Replace(UCase(txtSearchClientName.text), "'", "''")
      Filter = " UnitName LIKE '%" + tempstr + "*'"
   End If

           If strCommandSource = "15" Then
                If txtPropertyList.text = "ALL" Then
                    szSQL = "SELECT UnitNumber, UnitName " & _
                    "FROM Units " & _
                    "ORDER BY UnitNumber;"
                Else
                    szSQL = "SELECT UnitNumber, UnitName " & _
                    "FROM Units " & _
                    "WHERE PropertyID = '" & txtPropertyList.text & "' " & _
                    "ORDER BY UnitNumber;"
                End If
           End If
'Debug.Print szSQL
   rstRec.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
   rstRec.Filter = Filter
   flxClient.Rows = 2
   flxClient.RowHeight(0) = 0
   If strCommandSource = "15" Then
           flxClient.TextMatrix(1, 0) = "ALL"
           flxClient.TextMatrix(1, 1) = "All Unit"
           flxClient.AddItem ""
           rRow = 2
        While Not rstRec.EOF
           flxClient.row = 1
           flxClient.RowSel = 1
           flxClient.ColSel = 1
           flxClient.TextMatrix(rRow, 0) = rstRec.Fields("UnitNumber").Value
           flxClient.TextMatrix(rRow, 1) = rstRec.Fields.Item("UnitName").Value
           flxClient.RowHeight(rRow) = 280
           rstRec.MoveNext
           If Not rstRec.EOF Then flxClient.AddItem ""
           rRow = rRow + 1
        Wend
   End If
   rstRec.Close
   adoConn.Close
   Set rstRec = Nothing
   Set adoConn = Nothing
End Sub
Private Sub filterUnitListHist()
    Dim adoConn As New ADODB.Connection
    Dim rstRec As New ADODB.Recordset
    adoConn.Open getConnectionString
    Dim Filter As String
    Dim szSQL As String
    Dim rRow As Integer
    Dim tempstr As String
    If Len(txtSearchClientID.text) > 0 Then
      txtSearchClientName.text = ""
      tempstr = Replace(UCase(txtSearchClientID.text), "'", "''")
      Filter = " UnitNumber LIKE '%" + tempstr + "*'"
   End If
   If Len(txtSearchClientName.text) > 0 Then
      txtSearchClientID.text = ""
      tempstr = Replace(UCase(txtSearchClientName.text), "'", "''")
      Filter = " UnitName LIKE '%" + tempstr + "*'"
   End If

           If strCommandSource = "17" Then
                If txtPropertyHistory.text = "ALL" Then
                    szSQL = "SELECT UnitNumber, UnitName " & _
                    "FROM Units " & _
                    "ORDER BY UnitNumber;"
                Else
                    szSQL = "SELECT UnitNumber, UnitName " & _
                    "FROM Units " & _
                    "WHERE PropertyID = '" & txtPropertyHistory.text & "' " & _
                    "ORDER BY UnitNumber;"
                End If
           End If
'Debug.Print szSQL
   rstRec.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
   rstRec.Filter = Filter
   flxClient.Rows = 2
   flxClient.RowHeight(0) = 0
   If strCommandSource = "17" Then
           flxClient.TextMatrix(1, 0) = "ALL"
           flxClient.TextMatrix(1, 1) = "All Unit"
           flxClient.AddItem ""
           rRow = 2
        While Not rstRec.EOF
           flxClient.row = 1
           flxClient.RowSel = 1
           flxClient.ColSel = 1
           flxClient.TextMatrix(rRow, 0) = rstRec.Fields("UnitNumber").Value
           flxClient.TextMatrix(rRow, 1) = rstRec.Fields.Item("UnitName").Value
           flxClient.RowHeight(rRow) = 280
           rstRec.MoveNext
           If Not rstRec.EOF Then flxClient.AddItem ""
           rRow = rRow + 1
        Wend
   End If
   rstRec.Close
   adoConn.Close
   Set rstRec = Nothing
   Set adoConn = Nothing
End Sub
Private Sub LoadPropertyList()
   Dim rRow As Integer
   Dim szSQL As String

   Dim adoConn As New ADODB.Connection
   Dim rstRec As New ADODB.Recordset
   txtSearchClientID.text = ""
   txtSearchClientName.text = ""
   flxClient.RowHeight(0) = 0
   flxClient.Cols = 6
   flxClient.ColWidth(0) = 1500
   flxClient.ColWidth(1) = 3600
    flxClient.ColWidth(2) = 0
    flxClient.ColWidth(3) = 0
    flxClient.ColWidth(4) = 0
    flxClient.ColWidth(5) = 0
       
   flxClient.Clear
   flxClient.Rows = 2
   flxClient.ColAlignment(0) = vbLeftJustify
   flxClient.ColAlignment(1) = vbLeftJustify
   flxClient.ColAlignment(2) = vbLeftJustify
   
   txtSearchClientID.Width = 1530
   txtSearchClientName.Visible = True
   picClient.Width = 5295
   cmdPicCLose.Left = 5010
   txtSearchClientID.Left = 45
   '~~~ Added by Anol Configuring width and position of labels and search boxes.
   Label20(12).Caption = "Property ID"
   Label20(13).Caption = "Property Name"
   Label20(12).Width = 1400
   Label20(12).Left = 50
   Label20(13).Width = 2600
   Label20(13).Left = Label20(12).Left + flxClient.ColWidth(0)
   
   txtSearchClientName.Left = 1620
   txtSearchClientName.text = ""
   txtSearchClientID.text = ""
   txtSearchClientName.Width = 3240
   txtSearchClientID.Left = 45
   picClient.Height = 4095
   flxClient.Height = 3345
   flxClient.Width = 5175
   Label20(14).Visible = False
   
   adoConn.Open getConnectionString
           If strCommandSource = "2" Then
                szSQL = "SELECT P.PropertyID, P.PropertyName,G.VATRate,V.VAT_Rate as RateValue,V.VAT_CODE as VAT_CODE1,G.VATRate  as  Rate,G.vatOptionEnabled " & _
                            " from ((Property P INNER JOIN globalData G ON P.PropertyID=G.PropertyID) LEFT JOIN tlbVatCode V ON G.VATRate=V.VAT_ID) " & _
                            "WHERE ClientID = '" & txtDmdClientList.text & "' " & _
                            "ORDER BY P.PropertyID;"
           End If
         
           If strCommandSource = "4" Then
                If txtClientList.text = "ALL" Then
                    szSQL = "SELECT PropertyID, PropertyName " & _
                    "FROM Property " & _
                    "ORDER BY PropertyID;"
                Else
                    szSQL = "SELECT PropertyID, PropertyName " & _
                    "FROM Property " & _
                    "WHERE ClientID = '" & txtClientList.text & "' " & _
                    "ORDER BY PropertyID;"

                End If
           End If
            If strCommandSource = "6" Then
                    If txtClientHistory.text = "ALL" Then
                        szSQL = "SELECT PropertyID, PropertyName " & _
                        "FROM Property " & _
                        "ORDER BY PropertyID;"
                    Else
                        szSQL = "SELECT PropertyID, PropertyName " & _
                        "FROM Property " & _
                        "WHERE ClientID = '" & txtClientHistory.text & "' " & _
                        "ORDER BY PropertyID;"
    
                    End If
           End If
           If strCommandSource = "8" Then
                szSQL = "SELECT PropertyID, PropertyName " & _
                            "FROM Property " & _
                            "WHERE ClientID = '" & txtRptClientList.text & "' " & _
                            "ORDER BY PropertyID;"
           End If
            If strCommandSource = "10" Then
                    If txtRptClientList1.text = "ALL" Then
                        szSQL = "SELECT PropertyID, PropertyName " & _
                        "FROM Property " & _
                        "ORDER BY PropertyID;"
                    Else
                        szSQL = "SELECT PropertyID, PropertyName " & _
                        "FROM Property " & _
                        "WHERE ClientID = '" & txtRptClientList1.text & "' " & _
                        "ORDER BY PropertyID;"
    
                    End If
           End If
'Debug.Print szSQL
   rstRec.Open szSQL, adoConn, adOpenStatic, adLockReadOnly
   If strCommandSource = "2" Then
        If rstRec.EOF Then
            MsgBox "Please check that the information entered in global data has been correctly inputted", vbInformation, "Warning!"
        End If
        rRow = 1
        While Not rstRec.EOF
           flxClient.row = 1
           flxClient.RowSel = 1
           flxClient.ColSel = 1
           flxClient.TextMatrix(rRow, 0) = rstRec.Fields.Item(0).Value
           flxClient.TextMatrix(rRow, 1) = rstRec.Fields.Item(1).Value
           flxClient.TextMatrix(rRow, 2) = IIf(IsNull(rstRec.Fields("Rate").Value), "", rstRec.Fields("Rate").Value) 'VAT_ID
           flxClient.TextMatrix(rRow, 3) = IIf(IsNull(rstRec.Fields("RateValue").Value), "0.00", rstRec.Fields("RateValue").Value)
           flxClient.TextMatrix(rRow, 4) = IIf(IsNull(rstRec.Fields("VAT_CODE1").Value), "", rstRec.Fields("VAT_CODE1").Value) 'like T9
           flxClient.TextMatrix(rRow, 5) = IIf(IsNull(rstRec.Fields("vatOptionEnabled").Value), "", rstRec.Fields("vatOptionEnabled").Value) 'like T9
           flxClient.RowHeight(rRow) = 280
           rstRec.MoveNext
           If Not rstRec.EOF Then flxClient.AddItem ""
           rRow = rRow + 1
        Wend
   End If
   If strCommandSource = "4" Or strCommandSource = "6" Or strCommandSource = "8" Or strCommandSource = "10" Then
           flxClient.TextMatrix(1, 0) = "ALL"
           flxClient.TextMatrix(1, 1) = "All Property"
           flxClient.AddItem ""
           rRow = 2
        While Not rstRec.EOF
           flxClient.row = 1
           flxClient.RowSel = 1
           flxClient.ColSel = 1
           flxClient.TextMatrix(rRow, 0) = rstRec.Fields.Item(0).Value
           flxClient.TextMatrix(rRow, 1) = rstRec.Fields.Item(1).Value
           flxClient.RowHeight(rRow) = 280
           rstRec.MoveNext
           If Not rstRec.EOF Then flxClient.AddItem ""
           rRow = rRow + 1
        Wend
   End If
   
   rstRec.Close
   adoConn.Close
   Set rstRec = Nothing
   Set adoConn = Nothing
End Sub



'Private Sub txtArrayEditDemand_LostFocus(Index As Integer)
'        If Index = 0 Then
'            flxChildDemands.TextMatrix(iCurRow, 7) = txtArrayEditDemand(0).text
'            flxChildDemands.col = 8
'        End If
'        If Index = 1 Then
'            flxChildDemands.TextMatrix(iCurRow, 8) = txtArrayEditDemand(1).text
'            flxChildDemands.col = 9
'        End If
'        If Index = 2 Then
'            flxChildDemands.TextMatrix(iCurRow, 9) = txtArrayEditDemand(2).text
'            flxChildDemands.col = 10
'        End If
'        If Index = 3 Then
'            flxChildDemands.TextMatrix(iCurRow, 10) = txtArrayEditDemand(3).text
'            flxChildDemands.col = 11
'        End If
'        txtArrayEditDemand(Index).Visible = False
'End Sub
'Private Sub txtArrayEditDemand_KeyPress(Index As Integer, KeyAscii As Integer)
'
''        If KeyAscii = 13 Then
''            flxChildDemands.col = Index + 8
''            txtArrayEditDemand(Index + 1).Top = flxChildDemands.CellTop + flxChildDemands.Top
''            txtArrayEditDemand(Index + 1).Left = flxChildDemands.CellLeft + flxChildDemands.Left
''            txtArrayEditDemand(Index + 1).Width = 1200
''            txtArrayEditDemand(Index + 1).Height = flxChildDemands.RowHeight(flxSPayment.row) - 15
''            txtArrayEditDemand(Index).text = flxChildDemands.TextMatrix(flxSPayment.row, Index + 8)
''            txtArrayEditDemand(Index + 1).Visible = True
''            If Index < 3 Then
''                'txtArrayEditDemand(Index).Visible = False
''                FocusControl txtArrayEditDemand(Index + 1)
''
''            End If
''        End If
'
'End Sub
Private Sub txtSDescription_GotFocus()
    iCurRow = flxChildDemands.row
    txtSDescription.text = flxChildDemands.TextMatrix(iCurRow, 7)
     txtSDescription.SelStart = Len(txtSDescription.text)
    SelTxtInCtrl txtSDescription
    
    txtPayDt.Visible = False
    txtPostingDate.Visible = False
    txtRef.Visible = False
End Sub
Private Function MoveDownPosition() As Boolean
   Dim iRow As Integer

   If flxChildDemands.row < flxChildDemands.Rows - 1 Then
      If flxChildDemands.RowHeight(flxChildDemands.row + 1) = 0 Then
         txtSDescription.Visible = False
         flxChildDemands.ScrollBars = flexScrollBarVertical
         MoveDownPosition = False
         Exit Function
      End If
      flxChildDemands.row = flxChildDemands.row + 1
   Else
      txtSDescription.Visible = False
      flxChildDemands.ScrollBars = flexScrollBarVertical
      MoveDownPosition = False
      Exit Function
   End If

   iTop = flxChildDemands.CellTop + flxChildDemands.Top
   MoveDownPosition = True
End Function
Private Sub txtSDescription_KeyDown(KeyCode As Integer, Shift As Integer)
    'Smoothing neviagtion
    'Wriiten by anol 21 Apr 2015
    'issue 547
     'If KeyCode = 13 Then Text1(0).SetFocus
   '  Move to the next column for enter the date
   If KeyCode = 13 Then
       If flxChildDemands.row < flxChildDemands.Rows And Not txtPayDt.Visible And flxChildDemands.col = 7 Then
          txtSDescription.Visible = False
    
          flxChildDemands.col = 8
          iFlxSPayCol = 8
          txtPayDt.Top = flxChildDemands.CellTop + flxChildDemands.Top
          txtPayDt.Left = flxChildDemands.CellLeft + flxChildDemands.Left
          txtPayDt.Width = flxChildDemands.ColWidth(8)
          txtPayDt.Height = flxChildDemands.RowHeight(iCurRow) - 15
          txtPayDt.Visible = True
          flxChildDemands.ScrollBars = flexScrollBarNone
          txtPayDt.SetFocus
         ' SumUpTotal
       End If
    '  Move to the next row to enter amount
       If flxChildDemands.row < flxChildDemands.Rows And Not txtPayDt.Visible And flxChildDemands.col = 7 Then
          If MoveDownPosition Then
             flxChildDemands.col = 7
             flxChildDemands.SetFocus
          Else
            ' cmdSavePayment.SetFocus
          End If
          'iCurRow = iCurRow - 1
       End If
   End If
End Sub
Private Sub txtSDescription_KeyPress(KeyAscii As Integer)
   If KeyAscii = 45 Then
         KeyAscii = 0
   End If
   If KeyAscii = 27 Then
      flxChildDemands.SetFocus
      txtSDescription.Visible = False
      flxChildDemands.ScrollBars = flexScrollBarVertical
   End If
   
  
End Sub
Private Sub txtSDescription_LostFocus()
        flxChildDemands.TextMatrix(iCurRow, 7) = Format(txtSDescription.text, "0.00")
        txtSDescription.Visible = False
        flxChildDemands.ScrollBars = flexScrollBarVertical
End Sub
Private Sub txtPayDt_Change()
   TextBoxChangeDate txtPayDt
End Sub
Private Sub txtPayDt_GotFocus()
   iCurRow = flxChildDemands.row

   If flxChildDemands.col = 8 Then
      If flxChildDemands.TextMatrix(iCurRow, 8) = "" Then
         txtPayDt.text = Format(Now, "dd/mm/yyyy")
      Else
         txtPayDt.text = Format(flxChildDemands.TextMatrix(iCurRow, 8), "dd/mm/yyyy")
      End If
   End If


    txtPostingDate.Visible = False
    txtPayDt.SelStart = Len(txtPayDt.text)
    txtRef.Visible = False
    txtSDescription.Visible = False
    
   SelTxtInCtrl txtPayDt
End Sub
Private Sub txtPayDt_KeyPress(KeyAscii As Integer)
      If KeyAscii = 27 Then
      flxChildDemands.SetFocus
      txtPayDt.Visible = False
      flxChildDemands.ScrollBars = flexScrollBarVertical
   End If

   If KeyAscii = 13 Then
      If txtPayDt.text <> "" Then
         If TextBoxFormatDate(txtPayDt) Then
            If iFlxSPayCol = 8 Then 'if on paydate
               flxChildDemands.TextMatrix(iCurRow, 8) = Format(txtPayDt.text, "dd/mm/yyyy")
               flxChildDemands.col = 9 'goto posting date and fit the text box
               flxChildDemands_DblClick
             End If

         End If
      Else
         flxChildDemands.TextMatrix(iCurRow, 8) = ""
      End If

      txtPayDt.Visible = False
      flxChildDemands.ScrollBars = flexScrollBarVertical
   End If

   TextBoxKeyPrsDate txtPayDt, KeyAscii
End Sub
Private Sub txtPayDt_LostFocus()
'    flxChildDemands.TextMatrix(iCurRow, 22) = txtPayDt.text
'fixed date formating by ANOL 30 Aug 2016
        If txtPayDt.text <> "" Then TextBoxFormatDate txtPayDt
        flxChildDemands.TextMatrix(iCurRow, 8) = txtPayDt.text
        
End Sub
Private Sub txtPostingDate_Change()
       TextBoxChangeDate txtPostingDate
End Sub
Private Sub txtPostingDate_GotFocus()
     txtPayDt.Visible = False
     txtRef.Visible = False
     txtSDescription.Visible = False
     txtPostingDate.text = Format(flxChildDemands.TextMatrix(iCurRow, 9), "dd/mm/yyyy")
     txtPostingDate.SelStart = Len(txtPostingDate.text)
End Sub
Private Sub txtPostingDate_LostFocus()
'fixed date formating by ANOL 30 Aug 2016
     If txtPostingDate.text <> "" Then TextBoxFormatDate txtPostingDate
     flxChildDemands.TextMatrix(iCurRow, 9) = txtPostingDate.text
     
End Sub

Private Sub txtRef_GotFocus()
    txtPayDt.Visible = False
    txtPostingDate.Visible = False
    txtSDescription.Visible = False
     txtRef.SelStart = Len(txtRef.text)
End Sub
Private Sub txtRef_KeyPress(KeyAscii As Integer)
   If KeyAscii = 27 Then
      flxChildDemands.SetFocus
      txtPostingDate.Visible = False
      flxChildDemands.ScrollBars = flexScrollBarVertical
   End If

   If KeyAscii = 13 Then
        flxChildDemands.TextMatrix(iCurRow, 10) = txtRef.text
        If MoveDownPosition Then
             flxChildDemands.col = 7
             flxChildDemands.SetFocus
        End If
        'iCurRow = iCurRow - 1
        txtRef.Visible = False
        flxChildDemands.ScrollBars = flexScrollBarVertical
   End If
End Sub
Private Sub txtRef_LostFocus()
    flxChildDemands.TextMatrix(iCurRow, 10) = txtRef.text
    txtRef.Visible = False
End Sub
Private Function StarFound()
    StarFound = flxChildDemands.row
End Function
Private Sub flxChildDemands_DblClick()
       Dim i As Integer
   Dim selcol As Integer
  
   selcol = flxChildDemands.col
   flxChildDemands.col = 0

   flxChildDemands.col = selcol
   If flxChildDemands.col <= 7 Then
      iFlxSPayCol = 7
      flxChildDemands.col = iFlxSPayCol
      flxChildDemands.row = StarFound
   
      txtSDescription.Top = flxChildDemands.CellTop + flxChildDemands.Top
      iTop = txtSDescription.Top
      txtSDescription.Left = flxChildDemands.CellLeft + flxChildDemands.Left
      iLeft = flxChildDemands.CellLeft + flxChildDemands.Left
      txtSDescription.Width = flxChildDemands.ColWidth(iFlxSPayCol)
      txtSDescription.Height = flxChildDemands.RowHeight(flxChildDemands.row) - 15
      txtSDescription.text = flxChildDemands.TextMatrix(flxChildDemands.row, iFlxSPayCol)
      txtSDescription.Visible = True
      flxChildDemands.ScrollBars = flexScrollBarNone
      txtSDescription.SetFocus
   End If
   If flxChildDemands.col = 8 Then
      iFlxSPayCol = 8
      flxChildDemands.col = iFlxSPayCol
      flxChildDemands.row = StarFound

      txtPayDt.Top = flxChildDemands.CellTop + flxChildDemands.Top
      iTop = txtPayDt.Top
      txtPayDt.Left = flxChildDemands.CellLeft + flxChildDemands.Left
      iLeft = flxChildDemands.CellLeft + flxChildDemands.Left
      txtPayDt.Width = flxChildDemands.ColWidth(iFlxSPayCol)
      txtPayDt.Height = flxChildDemands.RowHeight(flxChildDemands.row) - 15
      txtPayDt.text = flxChildDemands.TextMatrix(flxChildDemands.row, iFlxSPayCol)
      txtPayDt.Visible = True
      flxChildDemands.ScrollBars = flexScrollBarNone
      txtPayDt.SetFocus
   End If
   If flxChildDemands.col = 9 Then
      iFlxSPayCol = 9
      flxChildDemands.col = iFlxSPayCol
      flxChildDemands.row = StarFound

      txtPostingDate.Top = flxChildDemands.CellTop + flxChildDemands.Top
      iTop = txtPostingDate.Top
      txtPostingDate.Left = flxChildDemands.CellLeft + flxChildDemands.Left
      iLeft = flxChildDemands.CellLeft + flxChildDemands.Left
      txtPostingDate.Width = flxChildDemands.ColWidth(iFlxSPayCol)
      txtPostingDate.Height = flxChildDemands.RowHeight(flxChildDemands.row) - 15
      txtPostingDate.text = flxChildDemands.TextMatrix(flxChildDemands.row, iFlxSPayCol)
      txtPostingDate.Visible = True
      'line added by anol 30 Aug 2016
      SelTxtInCtrl txtPostingDate
      flxChildDemands.ScrollBars = flexScrollBarNone
      txtPostingDate.SetFocus
   End If
If flxChildDemands.col = 10 Then
      iFlxSPayCol = 10
      flxChildDemands.col = iFlxSPayCol
      flxChildDemands.row = StarFound

      txtRef.Top = flxChildDemands.CellTop + flxChildDemands.Top
      iTop = txtRef.Top
      txtRef.Left = flxChildDemands.CellLeft + flxChildDemands.Left
      iLeft = flxChildDemands.CellLeft + flxChildDemands.Left
      txtRef.Width = flxChildDemands.ColWidth(iFlxSPayCol)
      txtRef.Height = flxChildDemands.RowHeight(flxChildDemands.row) - 15
      txtRef.text = flxChildDemands.TextMatrix(flxChildDemands.row, iFlxSPayCol)
      txtRef.Visible = True
      flxChildDemands.ScrollBars = flexScrollBarNone
      txtRef.SetFocus
   End If

   'bSavedPayment = False
   iCurRow = flxChildDemands.row

   SelTxtInCtrl txtSDescription
End Sub
Private Sub flxChildDemands_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
      flxChildDemands_DblClick
   End If
End Sub
Private Sub txtPostingDate_KeyPress(KeyAscii As Integer)
    If KeyAscii = 27 Then
      flxChildDemands.SetFocus
      txtPayDt.Visible = False
      flxChildDemands.ScrollBars = flexScrollBarVertical
   End If

   If KeyAscii = 13 Then
      If txtPostingDate.text <> "" Then
         If TextBoxFormatDate(txtPostingDate) Then
            If iFlxSPayCol = 9 Then 'if on paydate
               flxChildDemands.TextMatrix(iCurRow, 9) = Format(txtPostingDate.text, "dd/mm/yyyy")
               flxChildDemands.col = 10 'goto posting date and fit the text box
               flxChildDemands_DblClick
             End If

         End If
      Else
         flxChildDemands.TextMatrix(iCurRow, 9) = ""
      End If

       txtPostingDate.Visible = False
      flxChildDemands.ScrollBars = flexScrollBarVertical
   End If

   TextBoxKeyPrsDate txtPostingDate, KeyAscii
End Sub
Private Sub txtAllocationDAte_Change()
   TextBoxChangeDate txtAllocationDAte
   
End Sub
Private Sub txtAllocationDAte_GotFocus()
   SelTxtInCtrl txtAllocationDAte
End Sub

Private Sub txtAllocationDAte_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
        flxSPayment.SetFocus
    End If
   TextBoxKeyPrsDate txtAllocationDAte, KeyAscii
End Sub

